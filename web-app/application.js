var Watcher=function(b,d,a){_.bindAll(this,"fetch","destroy");var c=this;this.model=b;this.callback=d;this.interval=a||1000;this.current=JSON.stringify(this.model);this.watcher=setInterval(this.fetch,this.interval)};Watcher.prototype.fetch=function(){var a=this;this.model.fetch({silent:true,success:function(){var b=JSON.stringify(a.model);if(a.current!==b){a.current=b;a.callback&&a.callback()}},error:function(){}})};Watcher.prototype.destroy=function(){window.clearInterval(this.watcher)};var Status=function(c,a,d,b){_.bindAll(this,"start","error","stop");this.url=c;this.errorcallback=a;this.successcallback=d;this.interval=b||1000;this.start()};Status.prototype.start=function(){var a=this;var c=function(){$.ajax({url:a.url,type:"GET",success:a.successcallback,error:a.error})};if(!this.watcher){var b=this;this.watcher=setInterval(c,this.interval)}};Status.prototype.error=function(){this.stop();this.errorcallback(this)};Status.prototype.stop=function(){if(this.watcher){window.clearInterval(this.watcher);delete this.watcher}};var ApplicationController=Backbone.Router.extend({models:{},controllers:{},view:null,status:{},routes:{"":"initialRoute",explorer:"explorer",admin:"admin"},startup:function(){var a=this;a.dataTablesBootstrap();a.view=new ApplicationView({el:$("#app")});var b=new LoadingDialogView();a.models.images=new ImageCollection({project:undefined});a.models.imagesinstance=new ImageInstanceCollection({project:undefined});a.models.slides=new SlideCollection({project:undefined});a.models.users=new UserCollection({project:undefined});a.models.terms=new TermCollection({project:undefined});a.models.ontologies=new OntologyCollection();a.models.disciplines=new DisciplineCollection();a.models.projects=new ProjectCollection({user:undefined});a.models.annotations=new AnnotationCollection({});var d=[a.models.users];if(_.size(d)==0){a.modelFetched(0,0,b)}else{b.initProgressBar();var c=0;_.each(d,function(e){e.fetch({success:function(g,f){a.modelFetched(++c,_.size(d),b)}})})}},modelFetched:function(e,c,b){var a=100/c;var d=e*a;if(e==c){this.view.render(this.start)}},start:function(){window.app.controllers.image=new ImageController();window.app.controllers.project=new ProjectController();window.app.controllers.dashboard=new DashboardController();window.app.controllers.browse=new ExplorerController();window.app.controllers.ontology=new OntologyController();window.app.controllers.upload=new UploadController();window.app.controllers.command=new CommandController();window.app.controllers.annotation=new AnnotationController();window.app.controllers.activity=new ActivityController();window.app.controllers.account=new AccountController();window.app.view.initPreferences();window.app.view.initUserMenu();Backbone.history.start()},initialize:function(){var a=this;a.controllers.auth=new AuthController();require(["text!application/templates/ServerDownDialog.tpl.html"],function(d){var c=function(f){$("#app").fadeOut("slow");var g=new ConfirmDialogView({el:"#dialogs",template:d,dialogAttr:{dialogID:"#server-down"}}).render()};var e=function(f){a.status.version=f.version;a.status.serverURL=f.serverURL;if(f.authenticated){new UserModel({id:f.user}).fetch({success:function(h,g){a.status.user={id:f.user,authenticated:f.authenticated,model:h};a.startup()}})}else{a.controllers.auth.login()}};var b="server/ping";$.ajax({url:b,type:"GET",success:e});a.status=new Status(b,c,function(){},10000)})},explorer:function(){this.view.showComponent(this.view.components.explorer)},admin:function(){this.view.showComponent(this.view.components.admin)},warehouse:function(){this.view.showComponent(this.view.components.warehouse)},initialRoute:function(){this.controllers.project.project()},convertLongToDate:function(e){var b=new Date();b.setTime(e);var g=b.getFullYear();var h=(b.getMonth()+1)<10?"0"+(b.getMonth()+1):(b.getMonth()+1);var d=(b.getDate())<10?"0"+(b.getDate()):(b.getDate());var a=(b.getHours())<10?"0"+(b.getHours()):(b.getHours());var f=(b.getMinutes())<10?"0"+(b.getMinutes()):(b.getMinutes());var c=g+"-"+h+"-"+d+" "+a+"h"+f;return c},dataTablesBootstrap:function(){$.extend($.fn.dataTableExt.oStdClasses,{sWrapper:"dataTables_wrapper form-inline"});$.fn.dataTableExt.oApi.fnPagingInfo=function(a){return{iStart:a._iDisplayStart,iEnd:a.fnDisplayEnd(),iLength:a._iDisplayLength,iTotal:a.fnRecordsTotal(),iFilteredTotal:a.fnRecordsDisplay(),iPage:Math.ceil(a._iDisplayStart/a._iDisplayLength),iTotalPages:Math.ceil(a.fnRecordsDisplay()/a._iDisplayLength)}};$.extend($.fn.dataTableExt.oPagination,{bootstrap:{fnInit:function(e,b,d){var a=e.oLanguage.oPaginate;var f=function(g){g.preventDefault();if(e.oApi._fnPageChange(e,g.data.action)){d(e)}};$(b).addClass("pagination").append('<ul><li class="prev disabled"><a href="#">&larr; '+a.sPrevious+'</a></li><li class="next disabled"><a href="#">'+a.sNext+" &rarr; </a></li></ul>");var c=$("a",b);$(c[0]).bind("click.DT",{action:"previous"},f);$(c[1]).bind("click.DT",{action:"next"},f)},fnUpdate:function(c,k){var l=5;var e=c.oInstance.fnPagingInfo();var h=c.aanFeatures.p;var g,f,d,a,m,b=Math.floor(l/2);if(e.iTotalPages<l){a=1;m=e.iTotalPages}else{if(e.iPage<=b){a=1;m=l}else{if(e.iPage>=(e.iTotalPages-b)){a=e.iTotalPages-l+1;m=e.iTotalPages}else{a=e.iPage-b+1;m=a+l-1}}}for(g=0,iLen=h.length;g<iLen;g++){$("li:gt(0)",h[g]).filter(":not(:last)").remove();for(f=a;f<=m;f++){d=(f==e.iPage+1)?'class="active"':"";$("<li "+d+'><a href="#">'+f+"</a></li>").insertBefore($("li:last",h[g])[0]).bind("click",function(i){i.preventDefault();c._iDisplayStart=(parseInt($("a",this).text(),10)-1)*e.iLength;k(c)})}if(e.iPage===0){$("li:first",h[g]).addClass("disabled")}else{$("li:first",h[g]).removeClass("disabled")}if(e.iPage===e.iTotalPages-1||e.iTotalPages===0){$("li:last",h[g]).addClass("disabled")}else{$("li:last",h[g]).removeClass("disabled")}}}}})}});var UploadController=Backbone.Router.extend({initialized:false,routes:{upload:"upload"},upload:function(){if(!this.initialized){this.initForm();this.initialized=true}window.app.view.showComponent(window.app.view.components.upload)},initForm:function(){new UploadFormView({el:$("#upload")}).render()}});var AuthController=Backbone.Router.extend({routes:{},login:function(){var a=new LoginDialogView({}).render()},logout:function(){var a=new LogoutDialogView({}).render()},doLogin:function(){var b=new ApplicationView();var a=$("#login-form").serialize();$.ajax({url:"j_spring_security_check",type:"post",dataType:"json",data:a,success:function(c){b.message("Welcome","You are logged as "+c.fullname,"","success");$("#login-confirm").modal("hide");new UserModel({id:c.id}).fetch({success:function(e,d){window.app.status.user={authenticated:true,id:c.id,model:e};window.app.startup()}})},error:function(c){var d=$.parseJSON(c.responseText);$("#submit-login").attr("disabled","disabled");$("#login-confirm").effect("shake",{times:2},100);setTimeout(function(){$("#submit-login").removeAttr("disabled")},400);b.message("Error",d.message,"error")}});return false}});var ProjectController=Backbone.Router.extend({manageView:null,routes:{project:"project","project-manage-:idProject":"manage"},initView:function(f){var a=this;var c=null;var d=null;var b=null;var e=function(){if(c==null||d==null||b==null){return}a.view=new ProjectView({model:b,ontologies:c,disciplines:d,el:$("#project"),container:window.app.view.components.project}).render();a.view.container.views.project=a.view;if(_.isFunction(f)){f.call()}};new OntologyCollection({light:true}).fetch({success:function(h,g){c=h;e()}});window.app.models.disciplines.fetch({success:function(h,g){d=h;e()}});window.app.models.projects.fetch({success:function(h,g){b=h;e()}})},project:function(){var a=this;$("#warehouse-button").attr("href","#project");$("#addimagediv").hide();$("#projectdiv").show();if(!this.view){this.initView(function(){a.view.container.show(a.view,"#project","project");window.app.view.showComponent(window.app.view.components.project)});return}a.view.container.show(a.view,"#warehouse > .sidebar","project");window.app.view.showComponent(window.app.view.components.project)},manage:function(b){var a=this;if(a.view==undefined){a.project()}$("#projectdiv").hide();$("#addimagediv").show();new ProjectModel({id:b}).fetch({success:function(d,c){a.manageView=new ProjectManageSlideDialog({model:d,projectPanel:null,el:$("#project")}).render()}})}});var DashboardController=Backbone.Router.extend({view:null,routes:{"tabs-images-:project":"images","tabs-thumbs-:project":"imagesthumbs","tabs-imagesarray-:project":"imagesarray","tabs-annotations-:project-:terms-:users":"annotations","tabs-annotations-:project":"annotations","tabs-dashboard-:project":"dashboard","tabs-config-:project":"config","tabs-algos-:project-:software-:job":"algos","tabs-algos-:project-:software":"algos","tabs-algos-:project":"algos"},init:function(a,b){if(window.app.status.currentProject!=undefined&&window.app.status.currentProject!=a){this.destroyView();window.app.controllers.browse.closeAll();window.app.status.currentProject=undefined}if(window.app.status.currentProject==undefined){window.app.status.currentProject=a;window.app.controllers.browse.initTabs();if(this.view==null){this.createView(b)}this.showView()}else{b.call();this.showView()}},images:function(c){var a=this;var b=function(){a.view.refreshImagesThumbs();var d=$("#explorer > .browser").find(".nav-tabs");d.find("a[href=#tabs-images-"+window.app.status.currentProject+"]").click()};this.init(c,b)},imagesthumbs:function(c){var a=this;var b=function(){a.view.refreshImagesTable();a.view.showImagesThumbs();var d=$("#explorer > .browser").find(".nav-tabs");d.find("a[href=#tabs-images-"+window.app.status.currentProject+"]").click()};this.init(c,b)},imagesarray:function(c){var a=this;var b=function(){a.view.refreshImagesTable();a.view.showImagesTable();var d=$("#explorer > .browser").find(".nav-tabs");d.find("a[href=#tabs-images-"+window.app.status.currentProject+"]").click()};this.init(c,b)},annotations:function(d,c,e){var a=this;var b=function(){window.app.controllers.browse.tabs.triggerRoute=false;var f=$("#explorer > .browser").find(".nav-tabs");f.find("a[href=#tabs-annotations-"+window.app.status.currentProject+"]").click();a.view.refreshAnnotations(c,e);window.app.controllers.browse.tabs.triggerRoute=true};this.init(d,b)},algos:function(e,b,d){var a=this;var c=function(){window.app.controllers.browse.tabs.triggerRoute=false;var f=$("#explorer > .browser").find(".nav-tabs");f.find("a[href^=#tabs-algos-"+window.app.status.currentProject+"]").click();a.view.refreshAlgos(b,d==""?undefined:d);window.app.controllers.browse.tabs.triggerRoute=true};this.init(e,c)},config:function(c){var a=this;var b=function(){a.view.refreshConfig();var d=$("#explorer > .browser").find(".nav-tabs");d.find("a[href=#tabs-config-"+window.app.status.currentProject+"]").click()};this.init(c,b)},dashboard:function(c,d){var a=this;var b=function(){a.view.refreshDashboard();window.app.controllers.browse.tabs.triggerRoute=false;var e=$("#explorer > .browser").find(".nav-tabs");e.find("a[href=#tabs-dashboard-"+window.app.status.currentProject+"]").click();window.app.controllers.browse.tabs.triggerRoute=true;if(d!=undefined){d.call()}};this.init(c,b)},createView:function(b){var a=this;new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(d,c){window.app.status.currentProjectModel=d;a.view=new ProjectDashboardView({model:d,el:$("#explorer-tab-content")}).render();b.call()}})},destroyView:function(){this.view=null},showView:function(){$("#explorer > .browser").show();$("#explorer > .noProject").hide();window.app.view.showComponent(window.app.view.components.explorer)}});var ImageController=Backbone.Router.extend({routes:{image:"image","image/p:page":"image"},image:function(a){if(!this.view){this.view=new ImageView({page:a,model:window.app.models.images,el:$("#warehouse > .image"),container:window.app.view.components.warehouse}).render();this.view.container.views.image=this.view}this.view.container.show(this.view,"#warehouse > .sidebar","image");window.app.view.showComponent(window.app.view.components.warehouse)}});var ExplorerController=Backbone.Router.extend({tabs:null,routes:{"tabs-image-:idProject-:idImage-:idAnnotation":"browse",close:"close"},initialize:function(){},initTabs:function(){this.tabs=new ExplorerTabs({el:$("#explorer > .browser"),container:window.app.view.components.explorer}).render()},browse:function(e,d,a){var c=this;if(this.tabs==null){this.initTabs()}var b=function(){var f={};if(a!=""){f.goToAnnotation={value:a}}c.tabs.addBrowseImageView(d,f);$("#tabs-image-"+d).tab("show");window.app.view.showComponent(c.tabs.container);c.showView()};if(window.app.status.currentProject==undefined){window.app.controllers.dashboard.dashboard(e,b);return}b()},closeAll:function(){if(this.tabs==null){return}this.tabs=null;$("#explorer > .browser").empty()},showView:function(){$("#explorer > .browser").show();$("#explorer > .noProject").hide();window.app.view.showComponent(window.app.view.components.explorer)}});var TermController=Backbone.Router.extend({routes:{term:"term","term/o:ontology":"term"},term:function(a){if(!this.view){this.view=new TermView({model:window.app.models.terms,ontology:a,el:$("#explorer > .term"),container:window.app.view.components.explorer}).render();this.view.container.views.term=this.view}this.view.container.show(this.view)}});var OntologyController=Backbone.Router.extend({routes:{ontology:"ontology","ontology/:idOntology":"ontology","ontology/:idOntology/:idTerm":"ontology"},ontology:function(){this.ontology(0,0,false)},ontology:function(a){this.ontology(a,0,false)},ontology:function(a,b){this.ontology(a,b,false)},ontology:function(b,c,d){var a=this;if(!a.view){a.view=new OntologyView({model:window.app.models.ontologies,el:$("#ontology"),container:window.app.view.components.ontology,idOntology:b,idTerm:c}).render();a.view.container.views.ontology=a.view;a.view.container.show(a.view,"#warehouse > .sidebar","ontology");$("#warehouse-button").attr("href","#ontology");window.app.view.showComponent(window.app.view.components.ontology);a.view.refresh(b,c)}else{a.view.container.show(a.view,"#warehouse > .sidebar","ontology");window.app.view.showComponent(window.app.view.components.ontology);if(d){window.app.models.ontologies.fetch({success:function(f,e){a.view.select(b)}})}else{a.view.select(b,c)}}}});var CommandController=Backbone.Router.extend({initialize:function(){this.commandInProgess=false},undo:function(){var a=this;console.log("undo");if(a.commandInProgess){window.app.view.message("Oh wait :-)","Operation already in progress","error");return}a.commandInProgess=true;console.log("post undo");$.post("command/undo.json",{},function(b){_.each(b,function(c){console.log("undoElem");console.log(c);a.dispatch(c.callback,c.message,"Undo");if(c.printMessage){window.app.view.message("Undo",c.message,"info")}a.commandInProgess=false})},"json")},redo:function(){var a=this;if(a.commandInProgess){window.app.view.message("Oh wait :-)","Operation already in progress","error");return}a.commandInProgess=true;$.post("command/redo.json",{},function(b){_.each(b,function(c){a.dispatch(c.callback,c.message,"Redo");if(c.printMessage){window.app.view.message("Redo",c.message,"info")}});a.commandInProgess=false},"json")},dispatch:function(e,c,a){console.log("callback");console.log(e);console.log("operation");console.log(a);if(!e){return}if(e.method=="be.cytomine.AddAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationAdded(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.EditAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationUpdated(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.DeleteAnnotationCommand"){console.log("delete annotation");var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationRemoved(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.AddAnnotationTermCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().termAdded(e.annotationID,e.termID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.DeleteAnnotationTermCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().termRemoved(e.annotationID,e.termID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.AddOntologyCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.DeleteOntologyCommand"){window.app.controllers.ontology.view.refresh()}else{if(e.method=="be.cytomine.EditOntologyCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.AddProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.DeleteProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.EditProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.AddTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.DeleteTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.EditTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.AddImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.DeleteImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.EditImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}}}}}}}}}}}}}}}}}}});var AnnotationController=Backbone.Router.extend({routes:{annotation:"annotation","annotation/:idAnnotation":"annotation","share-annotation/:idAnnotation":"share"},annotation:function(a){var b=this;if(!b.view){window.app.models.images.fetch({success:function(d,c){b.view=new AnnotationListView({model:d,el:$("#warehouse > .annotation"),container:window.app.view.components.warehouse,idAnnotation:a}).render();b.view.container.views.annotation=b.view;b.view.container.show(b.view,"#warehouse > .sidebar","annotation");window.app.view.showComponent(window.app.view.components.warehouse)}})}},share:function(a){new AnnotationModel({id:a}).fetch({success:function(c,b){new ShareAnnotationView({model:c,image:c.get("image"),project:c.get("project")}).render()}})}});var AdminController=Backbone.Router.extend({initialize:function(){},routes:{"admin/users":"users","admin/groups":"groups"},users:function(){var b="authorities"+(new Date()).getTime();var a=new SecRoleCollection().fetch({success:function(g,c){var d=function(l,h){var k=l.split(",");var m="";g.each(function(n){if(_.contains(k,n.get("authority"))){m+=_.template("<option value='<%=   id %>' selected><%=   authority %></option>",{id:n.get("id"),authority:n.get("authority")})}else{m+=_.template("<option value='<%=   id %>' ><%=   authority %></option>",{id:n.get("id"),authority:n.get("authority")})}});var i=_.template('<select class="<%=   selectClass %>" title="" multiple="multiple" name="example-basic" size="5" style="display:none;"><%=   authorities %></select>',{selectClass:b,authorities:m});setTimeout(function(){},200);return i};var f=function(k,i,l){if(i==="get"){var h=[];return h.join(",")}else{if(i==="set"){}}};if(window.app.view.components.admin.views.usersGrid==undefined){var e=new CrudGridView({el:"#admin > .admin-users",url:"api/user/grid",restURL:"api/user",title:"Users",colName:["id","username","firstname","email","password","authorities","color"],colModel:[{name:"id",index:"id",width:30},{name:"username",index:"username",editable:true,width:50},{name:"firstname",index:"firstname",editable:true,width:50},{name:"lastname",index:"lastname",editable:true,width:50},{name:"email",index:"email",editable:true,width:80},{name:"password",index:"password",editable:true,width:30,edittype:"password"},{name:"color",index:"color",editable:true,width:30,edittype:"custom",editoptions:{custom_element:new CrudGridView({}).customFields.color.colorPickerElement,custom_value:new CrudGridView({}).customFields.color.colorPickerValue}}]});e.render();window.app.view.components.admin.views.usersGrid=e}window.app.view.components.admin.show(window.app.view.components.admin.views.usersGrid,"#admin > .sidebar","users");$("#admin-button").attr("href","#admin/users");window.app.view.showComponent(window.app.view.components.admin)}})},groups:function(){if(window.app.view.components.admin.views.groupsGrid==undefined){var a=new CrudGridView({el:"#admin > .admin-groups",url:"api/group/grid",editurl:"api/group",title:"Groups",colName:["id","name"],colModel:[{name:"id",index:"id",width:20},{name:"name",index:"name",editable:true,width:50}]});a.render();window.app.view.components.admin.views.groupsGrid=a}window.app.view.components.admin.show(window.app.view.components.admin.views.groupsGrid,"#admin > .sidebar","groups");$("#admin-button").attr("href","#admin/groups");window.app.view.showComponent(window.app.view.components.admin)}});var ActivityController=Backbone.Router.extend({routes:{activity:"activity"},activity:function(){if(!this.view){this.view=new ActivityView({el:"#activity-content"}).render()}window.app.view.showComponent(window.app.view.components.activity)}});var AccountController=Backbone.Router.extend({initialized:false,routes:{account:"account"},account:function(){if(!this.initialized){this.render();this.initialized=true}window.app.view.showComponent(window.app.view.components.account)},render:function(){new AccountDetails({el:"#account",model:window.app.status.user.model}).render()}});var UploadedFileModel=Backbone.Model.extend({url:function(){var a="api/uploadedfile";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var UploadedFileCollection=Backbone.Collection.extend({model:UploadedFileModel,initialize:function(a){if(!a){return}this.dataTables=a.dataTables},url:function(){if(this.dataTables){return"api/uploadedfile.json?dataTables=true"}else{return"api/uploadedfile.json"}}});var AnnotationFilterModel=Backbone.Model.extend({url:function(){var a="api/annotationfilter";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationFilterCollection=Backbone.Collection.extend({model:AnnotationFilterModel,initialize:function(a){this.project=a.project},url:function(){return"api/annotationfilter.json?project="+this.project}});var ImageModel=Backbone.Model.extend({url:function(){var a="api/image";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ImagePropertyCollection=Backbone.Collection.extend({initialize:function(a){this.image=a.image},url:function(){return"api/image/"+this.image+"/property.json"},comparator:function(a){return a.get("key")}});var ImageCollection=Backbone.Collection.extend({model:ImageModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/image.json"}else{return"api/currentuser/image.json"}},initialize:function(a){this.project=a.project}});var ImageServerUrlsModel=Backbone.Model.extend({url:function(){return"api/image/"+this.id+"/imageservers.json"}});var ImageInstanceModel=Backbone.Model.extend({url:function(){if(this.project==undefined&&this.baseImage==undefined){var a="api/imageinstance";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}else{return"api/project/"+this.project+"/image/"+this.baseImage+"/imageinstance.json"}},initialize:function(a){this.project=a.project;this.baseImage=a.baseImage}});var ImageInstanceCollection=Backbone.Collection.extend({model:ImageModel,url:function(){if(this.inf!=undefined&&this.sup!=undefined){return"api/project/"+this.project+"/imageinstance.json?inf="+this.inf+"&sup="+this.sup}else{if(this.tree){return"api/project/"+this.project+"/imageinstance.json?tree=true"}else{return"api/project/"+this.project+"/imageinstance.json"}}},initialize:function(a){this.project=a.project;this.tree=a.tree!=undefined&&a.tree==true;this.inf=a.inf;this.sup=a.sup}});var UserPositionModel=Backbone.Model.extend({url:function(){if(this.user==undefined){return"api/imageinstance/"+this.image+"/position"}else{return"api/imageinstance/"+this.image+"/position/"+this.user}},initialize:function(a){this.image=a.image;this.user=a.user}});var UserOnlineModel=Backbone.Model.extend({url:function(){return"api/imageinstance/"+this.image+"/online"},initialize:function(a){this.image=a.image}});var TermModel=Backbone.Model.extend({url:function(){var a="api/term";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationTermModel=Backbone.Model.extend({url:function(){if(this.term==null){return"api/annotation/"+this.annotation+"/term.json"}else{if(this.clear!=null){return"api/annotation/"+this.annotation+"/term/"+this.term+"/clearBefore.json"}else{return"api/annotation/"+this.annotation+"/term/"+this.term+".json"}}},initialize:function(a){this.annotation=a.annotation;this.term=a.term;this.clear=a.clear}});var AnnotationTermCollection=Backbone.Collection.extend({model:TermModel,url:function(){console.log("this.idUser="+this.idUser+" this.idNotThisUser="+this.idNotThisUser);if(this.idUser==null){return"api/annotation/"+this.idAnnotation+"/term.json"}else{if(this.idUser!=undefined){return"api/annotation/"+this.idAnnotation+"/user/"+this.idUser+"/term.json"}}},initialize:function(a){this.idAnnotation=a.idAnnotation;this.idUser=a.idUser}});var RelationTermModel=Backbone.Model.extend({url:function(){if(this.term==null){return"api/annotation/"+this.annotation+"/term.json"}else{return"api/annotation/"+this.annotation+"/term/"+this.term+".json"}},initialize:function(a){this.annotation=a.annotation;this.term=a.term}});var RelationTermCollection=Backbone.Collection.extend({model:TermModel,url:function(){return"api/annotation/"+this.idAnnotation+"/term.json"},initialize:function(a){this.idAnnotation=a.idAnnotation}});var TermCollection=Backbone.Collection.extend({model:TermModel,CLASS_NAME:"be.cytomine.ontology.Term",url:function(){if(this.idProject!=undefined){return"api/project/"+this.idProject+"/term.json"}else{if(this.idOntology==undefined&&this.idAnnotation==undefined){return"api/term.json"}else{if(this.idOntology!=undefined&&this.idAnnotation==undefined){return"api/ontology/"+this.idOntology+"/term.json"}else{if(this.idOntology!=undefined&&this.idAnnotation!=undefined){return"api/annotation/"+this.idAnnotation+"/ontology/"+this.idOntology+"/term.json"}}}}},initialize:function(a){this.idOntology=a.idOntology;this.idAnnotation=a.idAnnotation;this.idProject=a.idProject},comparator:function(a){return a.get("name")}});var ImageFilterModel=Backbone.Model.extend({url:function(){var a="api/imagefilter";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ImageFilterCollection=Backbone.Collection.extend({model:ImageFilterModel,url:function(){return"api/imagefilter.json"}});var ProjectImageFilterModel=Backbone.Model.extend({url:function(){var a="api/imagefilterproject";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},initialize:function(a){this.project=a.project}});var ProjectImageFilterCollection=Backbone.Collection.extend({model:ImageFilterModel,url:function(){return"api/project/"+this.project+"/imagefilterproject.json"},initialize:function(a){this.project=a.project}});var OntologyModel=Backbone.Model.extend({url:function(){var a="api/ontology";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var OntologyCollection=Backbone.Collection.extend({model:OntologyModel,CLASS_NAME:"be.cytomine.ontology.Ontology",url:function(){if(this.light==undefined){return"api/currentuser/ontology.json"}else{return"api/currentuser/ontology/light.json"}},initialize:function(a){if(a!=undefined){this.light=a.light}},comparator:function(a){return a.get("name")}});var DisciplineModel=Backbone.Model.extend({url:function(){var a="api/discipline";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var DisciplineCollection=Backbone.Collection.extend({model:DisciplineModel,CLASS_NAME:"be.cytomine.project.Discipline",url:function(){return"api/discipline.json"},initialize:function(a){if(a!=undefined){this.light=a.light}},comparator:function(a){return a.get("name")}});var UserModel=Backbone.Model.extend({url:function(){var a="api/user";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},prettyName:function(){return this.get("firstname")+" "+this.get("lastname")}});var UserCollection=Backbone.Collection.extend({model:UserModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/user.json"}else{return"api/user.json"}},initialize:function(a){this.project=a.project},comparator:function(a){return a.get("username").toLowerCase()}});var UserSecRole=Backbone.Model.extend({url:function(){if(this.role!=undefined||this.isNew()){return"api/user/"+this.user+"/role.json"}else{return"api/user/"+this.user+"/role/"+this.role+".json"}},initialize:function(a){this.user=a.user;this.role=a.role}});var ProjectModel=Backbone.Model.extend({url:function(){var a="api/project";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ProjectUserModel=Backbone.Model.extend({url:function(){if(this.user==undefined){return"api/project/"+this.project+"/user.json"}else{return"api/project/"+this.project+"/user/"+this.user+".json"}},initialize:function(a){this.project=a.project;this.user=a.user}});var OntologyProjectModel=Backbone.Collection.extend({model:ProjectModel,url:function(){return"api/ontology/"+this.ontology+"/project.json"},initialize:function(a){this.ontology=a.ontology}});var ProjectCollection=Backbone.Collection.extend({model:ProjectModel,url:function(){if(this.user!=undefined){return"api/user/"+this.user+"/project.json"}else{if(this.ontology!=undefined){return"api/ontology/"+this.ontology+"/project.json"}else{return"api/project.json"}}},initialize:function(a){if(a!=undefined){this.user=a.user;this.ontology=a.ontology}},comparator:function(a){return a.get("name")}});var AnnotationModel=Backbone.Model.extend({url:function(){var a="api/annotation";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationModel=Backbone.Model.extend({url:function(){var a="api/annotation";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationCropModel=Backbone.Model.extend({url:null,initialize:function(a){this.url=a.url}});var AnnotationCollection=Backbone.Collection.extend({model:AnnotationModel,url:function(){if(this.user!=undefined){return"api/user/"+this.user+"/imageinstance/"+this.image+"/annotation.json"}else{if(this.term!=undefined&&this.project!=undefined){var d=this.users.join("_");var b=this.images.join("_");if(this.term<"0"){var a="";if(this.term==-1){a="noTerm=true"}else{if(this.term==-2){a="multipleTerm=true"}}var c="api/project/"+this.project+"/annotation.json?"+a;if(this.users!=undefined){c+="&users="+d}if(this.images!=undefined){c+="&images="+b}return c}if(this.suggestTerm!=undefined){return"api/term/"+this.term+"/project/"+this.project+"/annotation.json?suggestTerm="+this.suggestTerm+"&job="+this.job}if(this.term>="0"&&this.users==undefined&&this.images==undefined){return"api/term/"+this.term+"/project/"+this.project+"/annotation.json"}if(this.term>="0"&&this.users!=undefined&&this.images==undefined){return"api/term/"+this.term+"/project/"+this.project+"/annotation.json?users="+d}if(this.term>="0"&&this.users==undefined&&this.images!=undefined){return"api/term/"+this.term+"/project/"+this.project+"/annotation.json?images="+b}if(this.term>="0"&&this.users!=undefined&&this.images!=undefined){return"api/term/"+this.term+"/project/"+this.project+"/annotation.json?users="+d+"&images="+b}return"error"}else{if(this.project!=undefined){return"api/project/"+this.project+"/annotation.json"}else{if(this.image!=undefined&&this.term!=undefined){return"api/term/"+this.term+"/imageinstance/"+this.image+"/annotation.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/annotation.json"}else{if(this.image!=undefined){return"api/imageinstance/"+this.image+"/annotation.json"}else{return"api/annotation.json"}}}}}}},initialize:function(a){this.image=a.image;this.user=a.user;this.images=a.images;this.project=a.project;this.term=a.term;this.users=a.users;this.suggestTerm=a.suggestTerm;this.job=a.job}});AnnotationCollection.comparator=function(a){return a.get("created")};var AnnotationRetrievalModel=Backbone.Model.extend({url:function(){return"api/annotation/"+this.annotation+"/retrieval.json"},initialize:function(a){this.annotation=a.annotation}});var AnnotationRetrievalCollection=Backbone.Collection.extend({model:AnnotationModel,initialize:function(a){this.annotation=a.annotation},comparator:function(a){return -a.get("similarity")}});var AnnotationCommentModel=Backbone.Model.extend({initialize:function(a){this.annotation=a.annotation},url:function(){var a="api/annotation/"+this.annotation+"/comment";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationCommentCollection=Backbone.Collection.extend({model:AnnotationCommentModel,initialize:function(a){this.annotation=a.annotation},url:function(){return"api/annotation/"+this.annotation+"/comment.json"}});var SlideModel=Backbone.Model.extend({url:function(){var a="api/slide";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ProjectSlideModel=Backbone.Model.extend({url:function(){if(this.slide==null){return"api/project/"+this.project+"/slide.json"}else{return"api/project/"+this.project+"/slide/"+this.slide+".json"}},initialize:function(a){this.project=a.project;this.slide=a.slide}});var ProjectSlideCollection=Backbone.Collection.extend({model:SlideModel,url:function(){return"api/project/"+this.idProject+"/slide.json"},initialize:function(a){this.idProject=a.idProject}});var SlideCollection=Backbone.Collection.extend({model:SlideModel,CLASS_NAME:"be.cytomine.image.Slide",url:function(){if(this.page==null){return"api/currentuser/slide.json"}else{return"api/currentuser/slide.json?page="+this.page+"&limit="}},initialize:function(a){this.page=a.page;this.limit=a.limit;this.sidx=a.sidx;this.sord=a.sord}});var StatsModel=Backbone.Model.extend({url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/term.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/project/stat.json"}else{return"api/stat.json"}}},initialize:function(a){this.project=a.project;this.term=a.term}});var StatsRetrievalSuggestionAVGModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/avg.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/avg.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionMatrixModel=Backbone.Model.extend({url:function(){console.log("StatsRetrievalSuggestionMatrixModel="+this.project+"#"+this.software+"#"+this.job);if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/confusionmatrix.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/confusionmatrix.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionWorstTermModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/worstTerm.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/worstTerm.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionWorstTermWithSuggest=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/worstTermWithSuggest.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/worstTermWithSuggest.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionWorstAnnotationModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/worstAnnotation.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/worstAnnotation.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionEvolutionModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/evolution.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/evolution.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsTermCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/term.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/project/stat.json"}else{return"api/stat.json"}}},initialize:function(a){this.project=a.project;this.term=a.term}});var StatsUserCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/user.json"}},initialize:function(a){this.project=a.project}});var StatsUserAnnotationCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/userannotations.json"}},initialize:function(a){this.project=a.project}});var StatsTermSlideCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/termslide.json"}},initialize:function(a){this.project=a.project}});var StatsUserSlideCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/userslide.json"}},initialize:function(a){this.project=a.project}});var CommandModel=Backbone.Model.extend({url:function(){var a="api/command";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var CommandCollection=Backbone.Collection.extend({model:CommandModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/last/"+this.max+".json"}else{return"api/command.json"}},initialize:function(a){if(!a){return}if(a.project!=undefined){this.project=a.project}if(a.max!=undefined){this.max=a.max}}});CommandCollection.comparator=function(a){return a.get("created")};var RelationTermModel=Backbone.Model.extend({url:function(){if(this.term!=undefined){return"api/relation/term/"+this.term+".json"}else{if(this.relation!=undefined&&this.term1!=undefined&&this.term2!=undefined){return"api/relation/"+this.relation+"/term1/"+this.term1+"/term2/"+this.term2+".json"}else{if(this.relation==undefined&&this.term1==undefined&&this.term2==undefined){return"api/relation/parent/term.json"}else{if(this.term1==undefined&&this.term2==undefined){return"api/relation/"+this.relation+"/term.json"}else{return"api/relation/parent/term1/"+this.term1+"/term2/"+this.term2+".json"}}}}},initialize:function(a){this.relation=a.relation;this.term=a.term;this.term1=a.term1;this.term2=a.term2}});var RelationTermCollection=Backbone.Collection.extend({model:RelationTermModel,url:function(){if(this.term!=undefined){return"api/relation/term/"+this.term+".json"}else{return"api/relation/"+this.relation+"/term.json"}},initialize:function(a){this.relation=a.relation;this.term=a.term}});var SecRoleModel=Backbone.Model.extend({url:function(){var a="api/role";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var SecRoleCollection=Backbone.Collection.extend({model:SecRoleModel,url:function(){return"api/role.json"}});var SuggestedAnnotationTermModel=Backbone.Model.extend({url:function(){return"api/annotation/term/suggest.json"}});var SuggestedAnnotationTermCollection=Backbone.Collection.extend({model:SuggestedAnnotationTermModel,url:function(){return"api/project/"+this.project+"/annotation/term/suggest.json?max="+this.max},initialize:function(a){this.project=a.project;this.max=a.max},comparator:function(a){return -Number(a.get("rate"))}});var SuggestedTermCollection=Backbone.Collection.extend({model:SuggestedAnnotationTermModel,url:function(){return"api/project/"+this.project+"/term/suggest.json"},initialize:function(a){this.project=a.project},comparator:function(a){return -Number(a.get("rate"))}});var JobModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/project/"+this.project+"/job.json?software="+this.software}else{var a="api/job";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}},initialize:function(a){this.project=a.project;this.software=a.software;this.light=a.light;this.max=a.max},isNotLaunch:function(){return(this.get("status")==0)},isInQueue:function(){return(this.get("status")==1)},isRunning:function(){return(this.get("status")==2)},isSuccess:function(){return(this.get("status")==3)},isFailed:function(){return(this.get("status")==4)},isIndeterminate:function(){return(this.get("status")==5)},isWait:function(){return(this.get("status")==6)}});var JobCollection=Backbone.Collection.extend({model:JobModel,url:function(){if(this.project!=undefined&&this.software!=undefined){var b=this.light==undefined?"":"&light="+this.light;var a=this.max==undefined?"":"&max="+this.max;return"api/project/"+this.project+"/job.json?software="+this.software+b+a}else{if(this.project!=undefined){return"api/project/"+this.project+"/job.json"}else{return"api/job.json"}}},initialize:function(a){this.project=a.project;this.software=a.software;this.light=a.light;this.max=a.max},comparator:function(a){return -a.get("id")}});var SoftwareModel=Backbone.Model.extend({url:function(){var a="api/software";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var SoftwareCollection=Backbone.Collection.extend({model:SoftwareModel,CLASS_NAME:"be.cytomine.processing.Software",url:function(){if(this.project!=null){return"api/project/"+this.project+"/software.json"}else{return"api/software.json"}},initialize:function(a){if(!a){return}this.project=a.project},comparator:function(a){return a.get("name")}});var SoftwareProjectModel=Backbone.Model.extend({url:function(){var a="api/softwareproject";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var SoftwareProjectCollection=Backbone.Collection.extend({model:SoftwareProjectModel,url:function(){if(this.project!=null){return"api/project/"+this.project+"/softwareproject.json"}else{return"api/softwareproject.json"}},initialize:function(a){if(!a){return}this.project=a.project}});var ActivityView=Backbone.View.extend({initialize:function(a){this.el=a.el},render:function(){var a=this;require(["text!application/templates/activity/ActivityView.tpl.html"],function(b){a.doLayout(b)})},doLayout:function(c){var b=this;$(b.el).html(c);var a=$("#activity-content");a.empty();new CommandCollection().fetch({success:function(e,d){e.each(function(g){var f=_.template("<li><%= message %></li>",{message:g.get("command").action});$(b.el).append(f)})}})}});var AccountDetails=Backbone.View.extend({initialize:function(a){},events:{},render:function(){var a=this;require(["text!application/templates/account/AccountDetails.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(a){$(this.el).html(_.template(a,this.model.toJSON()))}});var LoginDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{version:window.app.status.version}),dialogAttr:{dialogID:"#login-confirm",backdrop:false}}).render();$("#j_username").click(function(){$(this).select()});$("#j_password").click(function(){$(this).select()});$("#login-form").submit(window.app.controllers.auth.doLogin);$("#login-form").keydown(function(c){if(c.keyCode==13){$("#login-form").submit();return false}});return this},render:function(){var a=this;require(["text!application/templates/auth/LoginDialog.tpl.html"],function(b){a.doLayout(b)})},close:function(){$("#login-form").close()}});var LoadingDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{})}).render()},render:function(){var a=this;require(["text!application/templates/auth/LoadingDialog.tpl.html"],function(b){a.doLayout(b)});return this},initProgressBar:function(){$("#progress").show();$("#login-progressbar").progressbar({value:0})},progress:function(a){$("#login-progressbar").progressbar({value:a})},close:function(){}});var LogoutDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{}),dialogAttr:{dialogID:"#logout-confirm"}}).render();$("#submit-logout").click(function(c){c.preventDefault();window.location="logout"});$("#cancel-logout").click(function(c){c.preventDefault();$("#logout-confirm").modal("hide");$("#logout-confirm").remove()});return this},render:function(){var a=this;require(["text!application/templates/auth/LogoutDialog.tpl.html"],function(b){a.doLayout(b)})}});var AnnotationThumbView=Backbone.View.extend({events:{},initialize:function(a){this.term=a.term;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/dashboard/AnnotationThumb.tpl.html"],function(b){var c=a.model.toJSON();$(a.el).html(_.template(b,c));$(a.el).attr("data-annotation",a.model.get("id"));if(a.term!=undefined){$(a.el).attr("data-term",a.term)}a.initDraggable()});return this},initDraggable:function(){var a=this;$(a.el).draggable({scroll:true,revert:true,delay:500,opacity:0.35,cursorAt:{top:85,left:90},start:function(c,d){var b=$(a.el).find(".thumb");b.popover("hide")},stop:function(b,c){}})}});var AnnotationView=Backbone.View.extend({tagName:"div",nb_thumb_by_page:24,pagination_window:3,initialize:function(a){this.page=a.page;this.term=a.term;this.annotations=null;if(this.page==undefined){this.page=0}},render:function(){var a=this;a.initPagination();a.appendThumbs(a.page);return this},initPagination:function(){var b=this;var a=Math.ceil(_.size(this.model)/this.nb_thumb_by_page);if(a<2){return}require(["text!application/templates/dashboard/Pagination.tpl.html"],function(e){var m=_.template(e,{term:b.term});$(b.el).append(m);var k=$(b.el).find("#pagination-term-"+b.term).find("ul");var l=(b.page==0)?"prev disabled":"";var g=_.template("<li class='<%= className %>'><a data-page='<%= page %>' href='#'>&larr; Previous</a></li>",{className:l,page:b.page-1});k.append(g);var d=(b.page-b.pagination_window<0)?Math.abs(b.page-b.pagination_window):0;var h=(b.page+b.pagination_window>=a)?Math.abs(b.pagination_window+b.page-a+1):0;for(var f=Math.max(0,b.page-b.pagination_window-h);f<Math.min(a,b.page+b.pagination_window+d+1);f++){var c="term-"+b.term+"-page-"+f;l=(f==b.page)?"active":"";g=_.template("<li class='<%= className %>'><a data-page='<%= page %>' href='#'><%= page %></a></li>",{className:l,linkID:c,page:f});k.append(g)}var l=(b.page==a-1)?"next disabled":"";g=_.template("<li class='<%= className %>'><a data-page='<%= page %>' href='#'>Next &rarr;</a></li>",{className:l,page:b.page+1});k.append(g);k.find("a").click(function(){var i=parseInt($(this).attr("data-page"));if(i>=0&&i<a){b.switchToPage(i)}return false})})},switchToPage:function(b){var a=this;a.page=b;$(a.el).empty();a.render()},appendThumbs:function(d){var b=this;var e=0;var c=Math.abs(d)*b.nb_thumb_by_page;var a=(Math.abs(d)+1)*b.nb_thumb_by_page;b.annotations=new Array();b.model.each(function(f){if((e>=c)&&(e<a)){var g=new AnnotationThumbView({model:f,className:"thumb-wrap",term:b.term}).render();$(b.el).append(g.el)}e++;b.annotations.push(f.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(b){var a=this;var c=a.annotations;b.each(function(d){if(_.indexOf(a.annotations,d.id)==-1){a.add(d);a.annotations.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){a.remove(d);a.annotations=_.without(a.annotations,d)})}});var ProjectDashboardView=Backbone.View.extend({tagName:"div",projectElem:"#projectdashboardinfo",maxCommandsView:20,maxSuggestView:30,projectDashboardAnnotations:null,projectDashboardImages:null,rendered:false,initialize:function(a){_.bindAll(this,"render")},events:{},render:function(){var a=this;require(["text!application/templates/dashboard/Dashboard.tpl.html"],function(b){a.doLayout(b);a.rendered=true});return this},doLayout:function(b){var a=this;var e=Math.round($(window).width()/2-95);var d=Math.round($(window).width()-95);a.model.set({width:e+"px"});a.model.set({width2:d+"px"});var c=_.template(b,a.model.toJSON());$(a.el).append(c);window.app.controllers.browse.tabs.addDashboard(a);a.showImagesThumbs()},refreshImagesThumbs:function(){if(this.projectDashboardImages==null){this.projectDashboardImages=new ProjectDashboardImages({model:this.model})}this.projectDashboardImages.refreshImagesThumbs()},refreshAlgos:function(a,b){console.log("refreshAlgos this.projectDashboardAlgos=="+this.projectDashboardAlgos);if(this.projectDashboardAlgos==null||this.projectDashboardAlgos==undefined){this.projectDashboardAlgos=new ProjectDashboardAlgos({model:this.model,idSoftware:a,idJob:b}).render()}else{this.projectDashboardAlgos.refresh(a,b)}},refreshConfig:function(){if(this.ProjectDashboardConfig==null){this.ProjectDashboardConfig=new ProjectDashboardConfig({model:this.model})}this.ProjectDashboardConfig.refresh()},refreshImagesTable:function(){if(this.projectDashboardImages==null){this.projectDashboardImages=new ProjectDashboardImages({model:this.model})}this.projectDashboardImages.refreshImagesTable()},refreshAnnotations:function(b,c){var a=this;if(this.projectDashboardAnnotations==null){this.projectDashboardAnnotations=new ProjectDashboardAnnotations({model:this.model,el:this.el});this.projectDashboardAnnotations.render(function(){a.projectDashboardAnnotations.checkTermsAndUsers(b,c)})}else{this.projectDashboardAnnotations.checkTermsAndUsers(b,c)}},refreshDashboard:function(){var b=this;if(!b.rendered){return}var c=function(e,d){b.fetchProjectInfo();b.model=e;b.fetchCommands();new TermCollection({idProject:b.model.id}).fetch({success:function(g,f){window.app.status.currentTermsCollection=g;new ProjectDashboardStats({model:b.model}).fetchStats(g)}})};var a=function(){b.model.fetch({success:function(e,d){c(e,d)}})};a()},fetchProjectInfo:function(){var a=this;var b=a.model.toJSON();var c=function(f,e){$(this.el).find(f).empty();$(this.el).find(f).append(e)};c("#projectInfoName",b.name);c("#projectInfoOntology",b.ontologyName);c("#projectInfoNumberOfSlides",b.numberOfSlides);c("#projectInfoNumberOfImages",b.numberOfImages);c("#projectInfoNumberOfAnnotations",b.numberOfAnnotations);c("#projectInfoCreated",b.created);c("#projectInfoUpdated",b.updated);$("#projectInfoUserList").empty();var d=[];_.each(a.model.get("users"),function(e){d.push(window.app.models.users.get(e).prettyName())});$("#projectInfoUserList").html(d.join(", "))},fetchCommands:function(){var a=this;require(["text!application/templates/dashboard/CommandAnnotation.tpl.html","text!application/templates/dashboard/CommandAnnotationTerm.tpl.html","text!application/templates/dashboard/CommandImageInstance.tpl.html"],function(f,e,b){var c=new CommandCollection({project:a.model.get("id"),max:a.maxCommandsView});var d=function(k,g){$("#lastactionitem").empty();if(k.size()==0){var i=_.template("<br /><br /><div class='alert alert-block'>No data to display</div>",{});$("#lastactionitem").append(i)}$("#lastactionitem").append("<ul></ul>");var h=$("#lastactionitem").find("ul");k.each(function(s){var r=s.get("command");var p=new Date();p.setTime(r.created);var l=p.toLocaleDateString()+" "+p.toLocaleTimeString();var o=$.parseJSON(r.data);var q="undefined";if(r.serviceName=="annotationService"&&r.CLASSNAME=="be.cytomine.command.AddCommand"){var n="block";var m=o.cropURL;q=_.template(f,{idProject:a.model.id,idAnnotation:o.id,idImage:o.image,imageFilename:o.imageFilename,icon:"add.png",text:s.get("prefixAction")+" "+r.action,datestr:l,cropURL:m,cropStyle:n})}else{if(r.serviceName=="annotationService"&&r.CLASSNAME=="be.cytomine.command.EditCommand"){var n="";var m=o.newAnnotation.cropURL;q=_.template(f,{idProject:a.model.id,idAnnotation:o.newAnnotation.id,idImage:o.newAnnotation.image,imageFilename:o.newAnnotation.imageFilename,icon:"delete.gif",text:s.get("prefixAction")+" "+r.action,datestr:l,cropURL:m,cropStyle:n})}else{if(r.serviceName=="annotationService"&&r.CLASSNAME=="be.cytomine.command.DeleteCommand"){var n="";var m=o.cropURL;q=_.template(f,{idProject:a.model.id,idAnnotation:o.id,idImage:o.image,imageFilename:o.imageFilename,icon:"delete.gif",text:s.get("prefixAction")+" "+r.action,datestr:l,cropURL:m,cropStyle:n})}else{if(r.serviceName=="annotationTermService"&&r.CLASSNAME=="be.cytomine.command.AddCommand"){q=_.template(e,{icon:"ui-icon-plus",text:s.get("prefixAction")+" "+r.action,datestr:l,image:""})}else{if(r.serviceName=="annotationTermService"&&r.CLASSNAME=="be.cytomine.command.EditCommand"){q=_.template(e,{icon:"ui-icon-pencil",text:s.get("prefixAction")+" "+r.action,datestr:l,image:""})}else{if(r.serviceName=="annotationTermService"&&r.CLASSNAME=="be.cytomine.command.DeleteCommand"){q=_.template(e,{icon:"ui-icon-trash",text:s.get("prefixAction")+" "+r.action,datestr:l,image:""})}else{if(r.serviceName=="imageInstanceService"&&r.CLASSNAME=="be.cytomine.command.AddCommand"){var n="block";var m=o.thumb;q=_.template(b,{idProject:a.model.id,idImage:o.id,imageFilename:o.filename,icon:"add.png",text:s.get("prefixAction")+" "+r.action,datestr:l,cropURL:m,cropStyle:n})}else{if(r.serviceName=="imageInstanceService"&&r.CLASSNAME=="be.cytomine.command.DeleteCommand"){var n="block";var m=o.thumb;q=_.template(b,{idProject:a.model.id,idImage:o.id,imageFilename:o.filename,icon:"delete.gif",text:s.get("prefixAction")+" "+r.action,datestr:l,cropURL:m,cropStyle:n})}}}}}}}}h.append(q)})};c.fetch({success:function(h,g){d(h,g)}})})},showImagesThumbs:function(){$("#tabs-projectImageThumb"+this.model.id).show();$("#tabs-projectImageListing"+this.model.id).hide();$("#imageThumbs"+this.model.id).attr("disabled","disabled");$("#imageArray"+this.model.id).removeAttr("disabled")},showImagesTable:function(){$("#tabs-projectImageThumb"+this.model.id).hide();$("#tabs-projectImageListing"+this.model.id).show();$("#imageThumbs"+this.model.id).removeAttr("disabled");$("#imageArray"+this.model.id).attr("disabled","disabled")}});var ProjectDashboardStats=Backbone.View.extend({initialize:function(){var a=this;this.noDataAlert=_.template("<br /><br /><div class='alert alert-block'>No data to display</div>",{});var b=a.getHalfWidth();$("#projectInfoPanel").css("width",b);$("#projectLastCommandPanel").css("width",b);$(window).bind("resizeEnd",function(d){var c=a.getHalfWidth();$("#projectInfoPanel").css("width",c);$("#projectLastCommandPanel").css("width",c)})},getFullWidth:function(){return Math.round($(window).width()-90)},getHalfWidth:function(){if($(window).width()<1300){return this.getFullWidth()}return Math.round($(window).width()/2-75)},fetchStats:function(c){var a=this;var b=new StatsTermCollection({project:a.model.get("id")});var d=function(f,e){a.drawPieChart(f,e);a.drawColumnChart(f,e)};b.fetch({success:function(f,e){d(f,e)}});new StatsUserCollection({project:a.model.get("id")}).fetch({success:function(f,e){a.drawUserNbAnnotationsChart(f,e)}});new StatsUserAnnotationCollection({project:a.model.get("id")}).fetch({success:function(g,e){var f=_.size(g);a.drawUserAnnotationsChart(g,undefined,e)}});new StatsTermSlideCollection({project:a.model.get("id")}).fetch({success:function(f,e){a.drawTermSlideChart(f,e)}});new StatsUserSlideCollection({project:a.model.get("id")}).fetch({success:function(f,e){a.drawUserSlideChart(f,e)}})},drawUserAnnotationsChart:function(k,b,c){var n=this;var f=new google.visualization.DataTable();var l=-1;var g=k.at(0);f.addColumn("string","Terms");k.each(function(i){l++;if(l!=b&&b!=undefined){return}f.addColumn("number",i.get("key"))});f.addRows(_.size(g.get("terms")));var d=0;_.each(g.get("terms"),function(i){f.setValue(d,0,i.name);d++});l=-1;var e=1;k.each(function(o){l++;if(l!=b&&b!=undefined){return}var i=0;_.each(o.get("terms"),function(p){f.setValue(i,e,p.value);i++});e++});var a=n.getFullWidth();var m=new google.visualization.ColumnChart(document.getElementById("userAnnotationsChart"));m.draw(f,{title:"Term by users",backgroundColor:"whiteSmoke",width:a,height:350,hAxis:{title:"Terms"}});var h=function(){var r=m.getSelection()[0]["row"];var p=m.getSelection()[0]["column"];var i=k.at(p-1).get("id");var q=k.at(p-1).get("terms")[r].id;var o="#tabs-annotations-"+n.model.get("id")+"-"+q+"-"+i;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(o,true);window.app.controllers.browse.tabs.triggerRoute=true};google.visualization.events.addListener(m,"select",h);$(window).bind("resizeEnd",function(o){var i=n.getFullWidth();$("#userAnnotationsChart").css("width",i);m.draw(f,{title:"Term by users",backgroundColor:"whiteSmoke",width:i,height:350,hAxis:{title:"Terms"}})})},drawUserNbAnnotationsChart:function(g,c){var i=this;$("#userNbAnnotationsChart").empty();var a=false;var e=new google.visualization.DataTable();e.addRows(_.size(g));e.addColumn("string","Number");e.addColumn("number",0);var d=0;g.each(function(k){if(k.get("value")>0){a=true}e.setValue(d,0,k.get("key"));e.setValue(d,1,k.get("value"));d++});var b=i.getHalfWidth();$("#userNbAnnotationsChartPanel").css("width",b);var h=new google.visualization.ColumnChart(document.getElementById("userNbAnnotationsChart"));h.draw(e,{title:"",legend:"none",width:b,height:350,backgroundColor:"whiteSmoke",vAxis:{title:"Number of annotations"},hAxis:{title:"Users"}});var f=function(){var m=h.getSelection()[0]["row"];var l=h.getSelection()[0]["column"];var k=e.getValue(m,0);g.each(function(p){if(p.get("key")==k){var n=p.get("id");var o="#tabs-annotations-"+i.model.get("id")+"-all-"+n;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(o,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(h,"select",f);$("#userNbAnnotationsChart").show();$(window).bind("resizeEnd",function(l){var k=i.getHalfWidth();$("#userNbAnnotationsChart").css("width",k);$("#userNbAnnotationsChartPanel").css("width",k);h.draw(e,{title:"",legend:"none",width:k,height:350,backgroundColor:"whiteSmoke",vAxis:{title:"Number of annotations"},hAxis:{title:"Users"}})})},drawPieChart:function(g,c){if(this.model.get("numberOfAnnotations")==0){$("#projectPieChart").html(this.noDataAlert);return}$("#projectPieChart").empty();var k=this;var d=new google.visualization.DataTable();d.addColumn("string","Term");d.addColumn("number","Number of annotations");d.addRows(_.size(g));var e=0;var a=[];g.each(function(i){a.push(i.get("color"));d.setValue(e,0,i.get("key"));d.setValue(e,1,i.get("value"));e++});var b=k.getHalfWidth();$("#projectPieChartPanel").css("width",b);var h=new google.visualization.PieChart(document.getElementById("projectPieChart"));h.draw(d,{width:b,height:350,title:"",backgroundColor:"whiteSmoke",colors:a});var f=function(){var m=h.getSelection()[0]["row"];var l=h.getSelection()[0]["column"];var i=d.getValue(m,0);g.each(function(p){if(p.get("key")==i){var o=p.get("id");var n="#tabs-annotations-"+k.model.get("id")+"-"+o+"-all";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(n,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(h,"select",f);$(window).bind("resizeEnd",function(l){var i=k.getHalfWidth();$("#projectPieChart").css("width",i);$("#projectPieChartPanel").css("width",i);h.draw(d,{width:i,height:350,title:"",backgroundColor:"whiteSmoke",colors:a})})},drawColumnChart:function(h,d){var k=this;$("#projectColumnChart").empty();var b=false;var f=new google.visualization.DataTable();f.addRows(_.size(h));f.addColumn("string","Number");f.addColumn("number",0);var a=[];var e=0;h.each(function(l){a.push(l.get("color"));if(l.get("value")>0){b=true}f.setValue(e,0,l.get("key"));f.setValue(e,1,l.get("value"));e++});var c=k.getHalfWidth();$("#projectcolumnChartPanel").css("width",c);var i=new google.visualization.ColumnChart(document.getElementById("projectColumnChart"));i.draw(f,{title:"",legend:"none",backgroundColor:"whiteSmoke",width:c,height:350,vAxis:{title:"Number of annotations"},hAxis:{title:"Terms"}});var g=function(){var n=i.getSelection()[0]["row"];var m=i.getSelection()[0]["column"];var l=f.getValue(n,0);h.each(function(q){if(q.get("key")==l){var p=q.get("id");var o="#tabs-annotations-"+k.model.get("id")+"-"+p+"-all";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(o,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(i,"select",g);$("#projectColumnChart").show();$(window).bind("resizeEnd",function(m){var l=k.getHalfWidth();$("#projectColumnChart").css("width",l);$("#projectcolumnChartPanel").css("width",l);i.draw(f,{title:"",legend:"none",backgroundColor:"whiteSmoke",width:l,height:350,vAxis:{title:"Number of annotations"},hAxis:{title:"Terms"}})})},drawTermSlideChart:function(h,d){var k=this;var b=false;var f=new google.visualization.DataTable();f.addRows(_.size(h));f.addColumn("string","Term");f.addColumn("number",0);var a=[];var e=0;h.each(function(l){f.setValue(e,0,l.get("key"));f.setValue(e,1,l.get("value"));e++});var c=k.getHalfWidth();var i=new google.visualization.ColumnChart(document.getElementById("termSlideAnnotationsChart"));$("#termSlideAnnotationsChartPanel").css("width",c);i.draw(f,{title:"",legend:"none",backgroundColor:"whiteSmoke",width:c,height:350,vAxis:{title:"Slides"},hAxis:{title:"Terms"}});var g=function(){var n=i.getSelection()[0]["row"];var m=i.getSelection()[0]["column"];var l=f.getValue(n,0);h.each(function(q){if(q.get("key")==l){var p=q.get("id");var o="#tabs-annotations-"+k.model.get("id")+"-"+p+"-";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(o,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(i,"select",g);$(window).bind("resizeEnd",function(m){var l=k.getHalfWidth();$("#termSlideAnnotationsChart").css("width",l);$("#termSlideAnnotationsChartPanel").css("width",l);i.draw(f,{title:"",legend:"none",backgroundColor:"whiteSmoke",width:l,height:350,vAxis:{title:"Slides"},hAxis:{title:"Terms"}})})},drawUserSlideChart:function(g,c){var i=this;var e=new google.visualization.DataTable();e.addRows(_.size(g));e.addColumn("string","User");e.addColumn("number",0);var a=[];var d=0;g.each(function(k){e.setValue(d,0,k.get("key"));e.setValue(d,1,k.get("value"));d++});var b=i.getHalfWidth();var h=new google.visualization.ColumnChart(document.getElementById("userSlideAnnotationsChart"));$("#userSlideAnnotationsChartPanel").css("width",b);h.draw(e,{title:"",legend:"none",backgroundColor:"whiteSmoke",enableInteractivity:true,width:b,height:350,vAxis:{title:"Slides"},hAxis:{title:"Users"}});var f=function(){var m=h.getSelection()[0]["row"];var l=h.getSelection()[0]["column"];var k=e.getValue(m,0);g.each(function(p){if(p.get("key")==k){var n=p.get("id");var o="#tabs-annotations-"+i.model.get("id")+"-all-"+n;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(o,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(h,"select",f);$(window).bind("resizeEnd",function(l){var k=i.getHalfWidth();$("#userSlideAnnotationsChartPanel").css("width",k);h.draw(e,{title:"",legend:"none",backgroundColor:"whiteSmoke",enableInteractivity:true,width:k,height:350,vAxis:{title:"Slides"},hAxis:{title:"Users"}})})}});var ProjectDashboardImages=Backbone.View.extend({imagesView:null,imagesTabsView:null,refreshImagesThumbs:function(){if(this.imagesView==null){this.imagesView=new ImageView({page:0,model:new ImageInstanceCollection({project:this.model.get("id")}),el:$("#tabs-projectImageThumb"+this.model.get("id")),container:window.app.view.components.warehouse}).render()}else{this.imagesView.refresh()}},refreshImagesTable:function(){if(this.imagesTabsView==null){this.imagesTabsView=new ImageTabsView({model:new ImageInstanceCollection({project:this.model.get("id")}),el:$("#tabs-projectImageListing"+this.model.get("id")),container:window.app.view.components.warehouse,idProject:this.model.id}).render()}else{this.imagesTabsView.refresh()}}});var ProjectDashboardAnnotations=Backbone.View.extend({tabsAnnotation:null,annotationsViews:[],selectedTerm:[],selectedUsers:[],selectedImages:[],terms:null,ontology:null,shouldRefresh:true,render:function(b){var a=this;require(["text!application/templates/dashboard/TermTab.tpl.html","text!application/templates/dashboard/TermTabContent.tpl.html"],function(c,d){a.doLayout(c,d,b)})},doLayout:function(a,c,d){var b=this;new OntologyModel({id:b.model.get("ontology")}).fetch({success:function(f,e){b.ontology=f;$(b.el).find("input.undefinedAnnotationsCheckbox").change(function(){if($(this).attr("checked")=="checked"){b.refreshAnnotations(-1,b.selectedUsers,b.selectedImages);b.selectedTerm.push(-1);$("#tabsterm-panel-"+b.model.id+"--1").show()}else{$("#tabsterm-panel-"+b.model.id+"--1").hide();b.selectedTerm=_.without(b.selectedTerm,-1)}b.updateContentVisibility();b.updateDownloadLinks()});$(b.el).find("input.multipleAnnotationsCheckbox").change(function(){if($(this).attr("checked")=="checked"){b.refreshAnnotations(-2,b.selectedUsers,b.selectedImages);b.selectedTerm.push(-2);$("#tabsterm-panel-"+b.model.id+"--2").show()}else{$("#tabsterm-panel-"+b.model.id+"--2").hide();b.selectedTerm=_.without(b.selectedTerm,-2)}b.updateContentVisibility();b.updateDownloadLinks()});$(b.el).find("#treeAnnotationListing").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:f.toJSON(),onSelect:function(g,h){if(h.isSelected()){b.refreshAnnotations(h.data.key,b.selectedUsers,b.selectedImages);$("#tabsterm-panel-"+b.model.id+"-"+h.data.key).show();b.selectedTerm.push(h.data.key)}else{$("#tabsterm-panel-"+b.model.id+"-"+h.data.key).hide();b.selectedTerm=_.without(b.selectedTerm,h.data.key)}b.updateContentVisibility();b.updateDownloadLinks()},onDblClick:function(h,g){},initId:"treeData-annotations-"+b.model.get("ontology"),cookieId:"dynatree-Cb-annotations-"+b.model.get("ontology"),idPrefix:"dynatree-Cb-annotations-"+b.model.get("ontology")+"-"});$(b.el).find("#treeAnnotationListing").dynatree("getRoot").visit(function(g){g.expand(true);if(!g.hasChildren()){$(g.span).attr("data-term",g.data.key);$(g.span).attr("class","droppableElem")}});b.initSelectUser();b.initAnnotationsFilter();$(b.el).find("#uncheckAllTerms").click(function(){b.hideAllTerms()});$(b.el).find("#checkAllTerms").click(function(){b.showAllTerms()});$(b.el).find("#checkAllUsers").click(function(){b.showAllUsers()});$(b.el).find("#uncheckAllUsers").click(function(){b.hideAllUsers()});$(b.el).find("#checkAllImages").click(function(){b.showAllImages()});$(b.el).find("#uncheckAllImages").click(function(){b.hideAllImages()});$(b.el).find("#refreshAnnotations").click(function(){b.refreshSelectedTermsWithUserFilter()});b.terms=new TermCollection({idOntology:b.model.get("ontology")}).fetch({success:function(h,g){b.terms=h;window.app.status.currentTermsCollection=h;$("#listtabannotation").append(_.template(c,{project:b.model.id,id:-1,name:"Undefined",className:"noDropZone"}));$("#tabsterm-panel-"+b.model.id+"--1").hide();$("#listtabannotation").append(_.template(c,{project:b.model.id,id:-2,name:"Multiple",className:"noDropZone"}));$("#tabsterm-panel-"+b.model.id+"--2").hide();h.each(function(i){$("#listtabannotation").append(_.template(c,{project:b.model.id,id:i.get("id"),name:i.get("name"),className:"droppableElem"}));$("#tabsterm-panel-"+b.model.id+"-"+i.get("id")).hide()});b.initDropZone();d.call()}})}});new ImageInstanceCollection({project:window.app.status.currentProject,tree:true}).fetch({success:function(f,e){$(b.el).find("#treeImageListing").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:f.toJSON(),onSelect:function(g,h){if(h.isSelected()){b.selectedImages.push(h.data.key);$("#tabsterm-panel-"+b.model.id+"-"+h.data.key).show()}else{$("#tabsterm-panel-"+b.model.id+"-"+h.data.key).hide();b.selectedImages=_.without(b.selectedImages,h.data.key)}if(b.shouldRefresh){b.printAnnotationThumbAllTerms(b.selectedTerm,b.selectedUsers,b.selectedImages)}},onDblClick:function(h,g){},initId:"treeData-images-"+b.model.get("ontology"),cookieId:"dynatree-Cb-images-"+b.model.get("ontology"),idPrefix:"dynatree-Cb-images-"+b.model.get("ontology")+"-"});b.showAllImages()}})},initAnnotationsFilter:function(){var l=this;var i=$(this.el).find("#annotationFilterSelect");var c=undefined;var e=function(){i.empty();i.attr("disabled","disabled");new AnnotationFilterCollection({project:l.model.id}).fetch({success:function(n,m){c=n;if(_.size(n)>0){$(i).removeAttr("disabled")}n.each(function(q){var p="<option value='<%= id %>'><%= name %></option>";var o=_.template(p,q.toJSON());i.append(o)})},error:function(n,m){}})};e();var a=$(this.el).find("#selectAnnotationFilter");a.click(function(){var n=i.val();if(!n){return}var o=c.get(n);var m="#tabs-annotations-"+l.model.get("id")+"-"+o.get("terms")+"-"+o.get("users");window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(m,true);window.app.controllers.browse.tabs.triggerRoute=true});var d=$(this.el).find("#saveAnnotationFilter");var h=$(this.el).find("#confirmAnnotationFilter");var b=$(this.el).find("#cancelAnnotationFilter");var k=function(){$("#liSaveAnnotationFilter").hide();$("#liConfirmAnnotationFilter").css("display","inline");$("#inputAnnotationFilterName").focus()};var g=function(){$("#liSaveAnnotationFilter").css("display","inline");$("#liConfirmAnnotationFilter").hide()};b.click(function(){g();return});d.click(function(){k();return});h.click(function(){var m=$("#inputAnnotationFilterName").val();if(m==""||m==undefined){window.app.view.message("Error","You have to specify a identifier","error");return}new AnnotationFilterModel().save({name:m,terms:l.selectedTerm,users:l.selectedUsers,project:l.model.id},{success:function(o,n){window.app.view.message("Success",n.message,"success");g();e()},error:function(o,n){window.app.view.message("Error",n.message,"error")}})});var f=$(this.el).find("#deleteAnnotationFilter");f.click(function(){var m=i.val();if(!m){return}new AnnotationFilterModel({id:m}).destroy({success:function(o,n){window.app.view.message("Success",n.message,"success");e()},error:function(o,n){window.app.view.message("Error",n.message,"error")}})})},checkTermsAndUsers:function(c,d){var a=(c!=""&&c!=undefined);var b=(d!=""&&d!=undefined);if(!b&&!a){return}this.hideAllTerms();this.hideAllUsers();if(c=="all"){this.showAllTerms()}else{if(c!=""&&c!=undefined){this.selectTerms(c)}}if(d=="all"){this.showAllUsers()}else{if(d!=""&&d!=undefined){this.selectUsers(d)}}},showAllTerms:function(){$(this.el).find("input.undefinedAnnotationsCheckbox").attr("checked","checked");$(this.el).find("input.undefinedAnnotationsCheckbox").trigger("change");$(this.el).find("input.multipleAnnotationsCheckbox").attr("checked","checked");$(this.el).find("input.multipleAnnotationsCheckbox").trigger("change");this.selectAnnotations(true)},hideAllTerms:function(){$(this.el).find("input.undefinedAnnotationsCheckbox").removeAttr("checked");$(this.el).find("input.undefinedAnnotationsCheckbox").trigger("change");$(this.el).find("input.multipleAnnotationsCheckbox").removeAttr("checked");$(this.el).find("input.multipleAnnotationsCheckbox").trigger("change");this.selectAnnotations(false)},showAllImages:function(){var a=this;this.shouldRefresh=false;$(this.el).find("#treeImageListing").dynatree("getRoot").visit(function(b){if(!b.data.isFolder){b.select(true)}});this.shouldRefresh=true;a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedImages)},hideAllImages:function(){var a=this;this.shouldRefresh=false;$(this.el).find("#treeImageListing").dynatree("getRoot").visit(function(b){if(!b.data.isFolder){b.select(false)}});this.shouldRefresh=true;a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedImages)},showAllUsers:function(){var a=this;this.shouldRefresh=false;$(this.el).find("#treeUserListing").dynatree("getRoot").visit(function(b){if(!b.data.isFolder){b.select(true)}});this.shouldRefresh=true;a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedImages)},hideAllUsers:function(){var a=this;this.shouldRefresh=false;$(this.el).find("#treeUserListing").dynatree("getRoot").visit(function(b){if(!b.data.isFolder){b.select(false)}});this.shouldRefresh=true;a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedImages)},initDropZone:function(){var b=this;var a=function(f,g){$(this).css("background-color","");var c=$(g.draggable).attr("data-annotation");var e=$(g.draggable).attr("data-term");var d=$(this).attr("data-term");if(e==d){return}$(g.draggable).hide();new AnnotationTermModel({term:d,annotation:c,clear:true}).save({},{success:function(i,h){$("#tabsterm-"+b.model.id+"-"+d).append($(g.draggable));setTimeout(function(){$(g.draggable).fadeIn("slow")},1000);window.app.view.message(h.message,null,"success")},error:function(i,h){$(g.draggable).show();window.app.view.message(h.message,null,"error")}})};$(".noDropZone").droppable({over:function(c,d){$(this).css("background-color","red")},out:function(){$(this).css("background-color","")},drop:function(){$(this).css("background-color","")}});$(".droppableElem").droppable({over:function(c,d){$(this).css("background-color","lightgreen")},out:function(){$(this).css("background-color","")},drop:a})},initSelectUser:function(){var a=this;new UserCollection({project:a.model.id}).fetch({success:function(d,b){window.app.status.currentUsersCollection=d;var c={id:a.model.id,name:"Users",title:"Users",key:a.model.id,hideCheckbox:true,isFolder:true,children:[]};d.each(function(e){if(!_.include(a.model.get("userLayers"),e.id)){return}c.children.push({id:e.id,key:e.id,name:e.prettyName(),title:e.prettyName(),children:[]})});$(a.el).find("#treeUserListing").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:c,onSelect:function(e,f){if(f.isSelected()){a.selectedUsers.push(f.data.key)}else{a.selectedUsers=_.without(a.selectedUsers,f.data.key)}if(a.shouldRefresh){a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedImages)}},onDblClick:function(f,e){},initId:"treeData-user-"+a.model.id,cookieId:"dynatree-Cb-user-"+a.model.id,idPrefix:"dynatree-Cb-user-"+a.model.id+"-"});$(a.el).find("#treeUserListing").dynatree("getRoot").visit(function(e){e.expand(true)});$(a.el).find("#treeUserListing").dynatree("getTree").selectKey(window.app.status.user.id)}})},addTermToTab:function(a,c,b){$("#listtabannotation").append(_.template(c,b))},selectAnnotations:function(b){var a=this;this.terms.each(function(c){$(a.el).find("#treeAnnotationListing").dynatree("getTree").selectKey(c.get("id"),b)})},updateDownloadLinks:function(){var d=this.selectedUsers.join(",");var b=this.selectedTerm.join(",");var a=this.selectedImages.join(",");var c="&users="+d+"&terms="+b+"&images="+a;$("#downloadAnnotationsCSV").attr("href","/api/project/"+this.model.id+"/annotation/download?format=csv"+c);$("#downloadAnnotationsExcel").attr("href","/api/project/"+this.model.id+"/annotation/download?format=xls"+c);$("#downloadAnnotationsPDF").attr("href","/api/project/"+this.model.id+"/annotation/download?format=pdf"+c)},updateContentVisibility:function(){var b=_.size(this.selectedUsers);var a=_.size(this.selectedTerm);a+=($(this.el).find("input.undefinedAnnotationsCheckbox").attr("checked")=="checked")?1:0;a+=($(this.el).find("input.multipleAnnotationsCheckbox").attr("checked")=="checked")?1:0;if(a>0&&b>0){$("#listtabannotation").show();$("#downloadAnnotation").show()}else{$("#listtabannotation").hide();$("#downloadAnnotation").hide()}},selectTerms:function(b){b=b.split(",");var a=$(this.el).find("#treeAnnotationListing").dynatree("getTree");_.each(b,function(c){var d=a.getNodeByKey(c);d.select(true)})},selectUsers:function(b){b=b.split(",");var a=$(this.el).find("#treeUserListing").dynatree("getTree");_.each(b,function(c){var d=a.getNodeByKey(c);d.select(true)})},refreshSelectedTermsWithUserFilter:function(){var c=this;var d=c.selectedUsers;var b=c.selectedImages;var a=$(this.el).find("#treeAnnotationListing").dynatree("getRoot");if(!_.isFunction(a.visit)){return}a.visit(function(e){if(!e.isSelected()){return}c.refreshAnnotations(e.data.key,d,b)});if($(this.el).find("input.undefinedAnnotationsCheckbox").attr("checked")=="checked"){c.refreshAnnotations(-1,d,b)}if($(this.el).find("input.multipleAnnotationsCheckbox").attr("checked")=="checked"){c.refreshAnnotations(-2,d,b)}c.updateContentVisibility();c.updateDownloadLinks()},refreshAnnotations:function(b,c,a){this.printAnnotationThumb(b,"#tabsterm-"+this.model.id+"-"+b,c,a)},clearAnnotations:function(b){console.log("clearAnnotations");var a=this;$("#tabsterm-"+a.model.id+"-"+b).empty()},printAnnotationThumbAllTerms:function(d,e,a){console.log("self.selectedImages="+a);var b=this;b.updateContentVisibility();b.updateDownloadLinks();if(_.size(e)==0){return}for(var c=0;c<d.length;c++){b.printAnnotationThumb(d[c],"#tabsterm-"+b.model.id+"-"+d[c],e,a)}},printAnnotationThumb:function(d,c,e,a){var b=this;new AnnotationCollection({project:b.model.id,term:d,users:e,images:a}).fetch({success:function(g,f){if(b.annotationsViews[d]!=null&&e==undefined){b.annotationsViews[d].refresh(g,e);return}$(c).empty();b.annotationsViews[d]=new AnnotationView({page:undefined,model:g,term:d,el:$(c)}).render()}})}});var ProjectDashboardAlgos=Backbone.View.extend({rendered:false,jobCollection:null,softwares:null,disableSelect:false,software:null,jobSelectView:undefined,jobsLight:null,initialize:function(a){this.el="#tabs-algos-"+this.model.id;this.idJob=a.idJob;this.idSoftware=a.idSoftware;this.software=a.software},render:function(){console.log("render");var a=this;require(["text!application/templates/processing/SoftwareInfo.tpl.html"],function(b){a.doLayout(b)});this.rendered=true;return this},doLayout:function(b){console.log("this.idJob="+this.idJob);console.log("this.idSoftware="+this.idSoftware);var a=this;$(this.el).empty();$(this.el).append(_.template(b,{}));new SoftwareCollection({project:a.model.id}).fetch({success:function(f,c){if(f.length==0){$(a.el).empty();$(a.el).append('<br/><divstyle="text-align:left;"><h2>No software available for this project!</h2></div>');return}if(a.idSoftware==undefined){var d=f.last();a.idSoftware=d.id}a.software=f.get(a.idSoftware);a.softwares=f;a.initProjectSoftwareList();var e=f.get(a.idSoftware);console.log("1. self.idJob="+a.idJob);a.printProjectSoftwareInfo();a.printSoftwareButton();new JobCollection({project:a.model.id,software:a.idSoftware,light:true}).fetch({success:function(h,g){a.jobsLight=h;a.printComparatorLaunch();a.fillJobSelectView()}})}});return this},refresh:function(){console.log("refresh()"+this.idJob);if(!this.rendered){this.render()}if(this.softwares==null){return}this.software=this.softwares.get(this.idSoftware);this.printProjectSoftwareInfo()},refresh:function(a,b){console.log("refresh(idSoftware,idJob)"+this.idJob);if(this.softwares==null||this.softwares.length<1){return}this.idJob=b;if(a==undefined){a=this.idSoftware}this.software=this.softwares.get(a);if(a!=this.idSoftware){this.idSoftware=a;this.changeSoftware()}else{this.idSoftware=a}this.printProjectSoftwareInfo()},initProjectSoftwareList:function(){var a=this;a.softwares.each(function(b){$("#projectSoftwareListUl").append('<li id="consultSoftware-'+b.id+'"><a href="#tabs-algos-'+a.model.id+"-"+b.id+'-">'+b.get("name")+"</a></li>");$("#projectSoftwareListUl").children().removeClass("active");if(b.id==a.idSoftware){$("#consultSoftware-"+b.id).addClass("active")}})},changeSoftware:function(){var a=this;a.softwares.each(function(b){$("#consultSoftware-"+b.id).removeClass("active")});$("#consultSoftware-"+a.software.id).addClass("active");$("#selectRunParamsTable").find("tbody").empty();$("#panelJobResultsDiv").empty();console.log("changeSoftware");a.fillJobSelectView()},printProjectSoftwareInfo:function(){var a=this;a.printProjectSoftwareDetails(a.software);a.printLastNRun();a.printProjectJobInfo(a.idJob)},changeJobSelection:function(b){var a=this;console.log("refresh:idJob="+b);window.location="#tabs-algos-"+a.model.id+"-"+a.idSoftware+"-"+b;if(a.jobSelectView!=undefined){a.jobSelectView.refresh()}},printSoftwareButton:function(){var a=this;$("#softwareLaunchJobButton").click(function(){console.log("project="+a.model.id+" software.id="+a.software.id);new LaunchJobView({software:a.software,project:a.model,el:$("#jobComparatorDialogParent"),parent:a}).render()});$("#softwareCompareJobButton").click(function(){a.jobsLight.fetch({success:function(c,b){console.log("project="+a.model.id+" software.id="+a.software.id);new JobComparatorView({software:a.software,project:a.model,el:$("#jobComparatorDialogParent"),parent:a,jobs:c,job1:undefined,job2:undefined,softwares:a.softwares}).render()}})});$("#softwareInfoButton").click(function(){console.log("project="+a.model.id+" software.id="+a.software.id);new SoftwareDetailsView({software:a.software,project:a.model,el:$("#softwareInfoDialogParent")}).render()})},printComparatorLaunch:function(){var a=this;$("#launchComparator").click(function(){a.jobsLight.fetch({success:function(c,b){console.log("project="+a.model.id+" software.id="+a.software.id);new JobComparatorView({software:a.software,project:a.model,el:$("#jobComparatorDialogParent"),parent:a,jobs:c,job1:c.get(a.idJob),softwares:a.softwares}).render()}})})},printLastNRun:function(){var b=this;var c=function(){new JobCollection({project:b.model.id,software:b.software.id,max:3}).fetch({success:function(f,d){var e=f.models.length>0?f.models[0]:undefined;b.fillNLastRun(f)}})};c();var a=setInterval(c,5000);$(window).bind("hashchange",function(){clearInterval(a)})},printProjectJobInfo:function(b){var a=this;if(b==undefined){new JobCollection({project:a.model.id,software:a.idSoftware,max:1}).fetch({success:function(e,c){var d=e.models.length>0?e.models[0]:undefined;a.fillSelectedJobDetails(d)}})}else{new JobModel({id:b}).fetch({success:function(d,c){a.fillSelectedJobDetails(d)}})}},printAcitivtyDiagram:function(d){var e=new google.visualization.DataTable();e.addColumn("string","Success");e.addColumn("number","Succes rate");console.log("printAcitivtyDiagram="+d.id);e.addRows([["Not Launch",d.get("numberOfNotLaunch")],["In Queue",d.get("numberOfInQueue")],["Running",d.get("numberOfRunning")],["Success",d.get("numberOfSuccess")],["Failed",d.get("numberOfFailed")],["Indeterminate",d.get("numberOfIndeterminate")],["Wait",d.get("numberOfWait")]]);var c=$("#softwareInfoDiagram").width()-100;var a={title:"Job software status for all project",width:c,height:150,vAxis:{title:"Success rate"},hAxis:{title:"#"},backgroundColor:"whiteSmoke",strictFirstColumnType:false,is3D:true,lineWidth:1,colors:["#434141","#65d7f8","#005ccc","#52a652","#c43c35","#434343","#faaa38"]};var b=new google.visualization.PieChart(document.getElementById("softwareInfoDiagram"));b.draw(e,a)},printProjectSoftwareDetails:function(a){$("#panelSoftwareResume").find(".softwareMainInfo").empty();$("#panelSoftwareResume").find(".softwareMainInfo").append("<li><h2>"+a.get("name")+"</h2></li>");$("#panelSoftwareResume").find(".softwareMainInfo").append("<li>"+a.get("numberOfJob")+" job has been run</li>");this.printAcitivtyDiagram(a)},fillJobSelectView:function(){var a=this;console.log("fillJobSelectView:"+a.software.get("name"));$("#jobSelection").empty();new JobCollection({project:a.model.id,software:a.software.id,light:true}).fetch({success:function(c,b){a.jobsLight=c;a.jobSelectView=new JobSelectionView({software:a.software,project:a.model,el:$("#panelAlgoSoftware").find("#jobSelection"),parent:a,jobs:c,comparator:false}).render()}})},fillNLastRun:function(a){var b=this;$("#fullSoftwareDashboard").find("#panelSoftwareLastRunList").empty();var c=0;a.each(function(d){$("#fullSoftwareDashboard").find("#panelSoftwareLastRunList").append('<div style="margin: 0px auto;min-width:100px;max-width:200px" id="'+d.id+'"></div>');b.buildJobInfoElem(d,$("#fullSoftwareDashboard").find("#panelSoftwareLastRunList").find("#"+d.id));c++})},fillSelectedJobDetails:function(d){var b=this;console.log("fillSelectedJobDetails="+d);if(d==undefined){$(".selectRunDetails").empty();$("#selectRunParamsTable").find("tbody").empty();$("#panelJobResultsDiv").empty();return}b.idJob=d.id;var c=function(){var f=$("#panelJobDetails").find(".selectRunDetails");new JobModel({id:b.idJob}).fetch({success:function(h,g){f.empty();b.buildJobInfoElem(h,f)}})};c();var a=setInterval(c,5000);$(window).bind("hashchange",function(){clearInterval(a)});var e=$("#selectRunParamsTable").find("tbody").empty();e.empty();b.buildJobParamElem(d,e);b.printJobResult(d)},buildJobInfoElem:function(job,elem){var self=this;if(job==undefined){return}var width=$("#panelSoftwareLastRunList").find("#"+job.id).width()-5;elem.append('<ul  style="display:inline;" id="'+job.id+'"></ul>');var subelem=elem.find("#"+job.id);var successfulIcon=job.get("status")==JobModel.SUCCESS?"icon-star":"icon-star-empty";subelem.append('<li><i class="'+successfulIcon+'"></i><h4 style="display:inline;"><a href="#tabs-algos-'+self.model.id+"-"+self.idSoftware+"-"+job.id+'" id="'+job.id+'">Job '+job.get("number")+"<br></a></h4></li>");subelem.find("#"+job.id).click(function(){self.printProjectJobInfo(job.id)});subelem.append(self.getStatusElement(job,width));subelem.append("<li>"+window.app.convertLongToDate(job.get("created"))+"</li>");subelem.find("div#progBar").each(function(index){var progVal=eval($(this).text());$(this).text("");$(this).progressbar({value:progVal})});subelem.find("div#progresstext").append(job.get("progress")+"%")},getStatusElement:function(c,b){var a=this;if(c.isNotLaunch()){return a.getJobLabel("btn-inverse","Not Launch!",b)}else{if(c.isInQueue()){return a.getJobLabel("btn-info","In queue!",b)}else{if(c.isRunning()){return a.getJobProgress(c,"active","Progress ",b)}else{if(c.isSuccess()){return a.getJobLabel("btn-success","Success!",b)}else{if(c.isFailed()){return a.getJobLabel("btn-danger","Failed!",b)}else{if(c.isIndeterminate()){return a.getJobLabel("btn-warning","Indetereminate!",b)}else{if(c.isWait()){return a.getJobProgress(c,"progress-warning","Wait ",b)}else{return"no supported"}}}}}}}},getJobLabel:function(b,c,a){return'<li><div class="'+b+'" style="margin:0 auto;min-width:'+a+";max-width:"+a+';">'+c+"</div></li>"},getJobProgress:function(c,b,d,a){return'<li><div id="progresstext">'+d+' </div><div class="progress '+b+' progress-striped"><div class="bar" style="width: '+c.get("progress")+'%;"></div></div></li>'},buildJobParamElem:function(d,e){var b=this;if(d==undefined){return}var a=$("#selectRunParamsTable").dataTable();a.fnClearTable();var c=$("#selectRunParamsTable").find("tbody");_.each(d.get("jobParameter"),function(f){c.append("<tr><td>"+f.name+"</td><td>"+b.getJobParamValue(f)+"</td><td>"+f.type+"</td></tr>")});$("#selectRunParamsTable").dataTable({sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:5,bLengthChange:false,bDestroy:true,aoColumnDefs:[{sWidth:"40%",aTargets:[0]},{sWidth:"40%",aTargets:[1]},{sWidth:"20%",aTargets:[2]}]})},getJobParamValue:function(c){if(c.type=="List"){var a="<select>";var b=c.value.split(",");_.each(b,function(d){a=a+"<option>"+d+"</option>"});a=a+"</select>";return a}else{return c.value}},printJobResult:function(b){if(b==undefined){return}var a=this;if(window.app.status.currentTermsCollection==undefined||window.app.status.currentAnnotationsCollection==undefined){new AnnotationCollection({project:a.model.id}).fetch({success:function(d,c){window.app.status.currentAnnotationsCollection=d;new TermCollection({idProject:a.model.id}).fetch({success:function(f,e){window.app.status.currentTermsCollection=f;a.initJobResult(b)}})}})}else{a.initJobResult(b)}},initJobResult:function(c){var b=this;var a=new JobResultView({model:c,project:b.model,el:$("#panelJobResultsDiv"),jobs:b.jobsLight,software:b.software}).render()}});var ProjectDashboardConfig=Backbone.View.extend({initialize:function(a){this.el="#tabs-config-"+this.model.id;this.rendered=false},render:function(){this.imageFiltersProjectPanel=new ImageFiltersProjectPanel({el:this.el,model:this.model}).render();this.softwareProjectPanels=new SoftwareProjectPanel({el:this.el,model:this.model}).render();this.rendered=true},refresh:function(){if(!this.rendered){this.render()}}});var SoftwareProjectPanel=Backbone.View.extend({removeSoftware:function(b){var a=this;new SoftwareProjectModel({id:b}).destroy({success:function(d,c){$(a.el).find("li.software"+b).remove();window.app.view.message("",c.message,"success")},error:function(d,c){}});return false},renderSoftwares:function(){var a=this;var b=$(this.el).find(".softwares");new SoftwareProjectCollection({project:a.model.id}).fetch({success:function(d,c){d.each(function(e){a.renderSoftware(e,b)})}})},renderSoftware:function(c,b){var a=_.template("<li class='software<%= id %>' style='padding-bottom : 3px;'><a class='btn  btn-small btn-danger removeSoftware' data-id='<%= id %>' href='#'><i class='icon-trash icon-white' /> Delete</a> <%= name %></li>",c.toJSON());$(b).append(a)},render:function(){var a=this;var b=$(this.el).find(".softwares");new SoftwareCollection().fetch({success:function(d,c){d.each(function(f){var e=_.template("<option value='<%= id %>'><%= name %></option>",f.toJSON());$(a.el).find("#addSoftware").append(e)});$(a.el).find("#addSoftwareButton").click(function(){new SoftwareProjectModel({project:a.model.id,software:$(a.el).find("#addSoftware").val()}).save({},{success:function(f,e){a.renderSoftware(new SoftwareProjectModel(f.toJSON().softwareproject),b);window.app.view.message("",e.message,"success")},error:function(f,e){window.app.view.message("",$.parseJSON(e.responseText).errors,"error")}});return false})}});a.renderSoftwares();$(this.el).find("a.removeSoftware").live("click",function(){var c=$(this).attr("data-id");a.removeSoftware(c);return false});return this}});var ImageFiltersProjectPanel=Backbone.View.extend({removeImageFilter:function(b){var a=this;new ProjectImageFilterModel({id:b}).destroy({success:function(d,c){$(a.el).find("li.imageFilter"+b).remove();window.app.view.message("",c.message,"success")}});return false},renderFilters:function(){var a=this;var b=$(this.el).find(".image-filters");new ProjectImageFilterCollection({project:a.model.id}).fetch({success:function(d,c){d.each(function(e){a.renderImageFilter(e,b);window.app.view.message("",c.message,"success")})}})},renderImageFilter:function(c,b){var a=_.template("<li class='imageFilter<%= id %>' style='padding-bottom : 3px;'> <a class='btn  btn-small btn-danger removeImageFilter' data-id='<%= id %>' href='#'><i class=' icon-trash icon-white' /> Delete</a> <%= name %></li>",c.toJSON());$(b).append(a)},render:function(){var a=this;var b=$(this.el).find(".image-filters");new ImageFilterCollection().fetch({success:function(d,c){d.each(function(f){var e=_.template("<option value='<%=  id %>'><%=   name %></option>",f.toJSON());$(a.el).find("#addImageFilter").append(e)});$(a.el).find("#addImageFilterButton").click(function(){new ProjectImageFilterModel({project:a.model.id,imageFilter:$(a.el).find("#addImageFilter").val()}).save({},{success:function(f,e){a.renderImageFilter(new ImageFilterModel(f.toJSON().imagefilterproject),b);window.app.view.message("",e.message,"success")},error:function(e){window.app.view.message("",$.parseJSON(e.responseText).errors,"error")}});return false})}});a.renderFilters();$(this.el).find("a.removeImageFilter").live("click",function(){var c=$(this).attr("data-id");a.removeImageFilter(c);return false});return this}});var JobListingView=Backbone.View.extend({width:null,software:null,project:null,jobs:null,openParameterGrid:[],parent:null,initialize:function(a){this.software=a.software;this.project=a.project;this.parent=a.parent},render:function(){var a=this;require(["text!application/templates/processing/JobListing.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var b=this;var e=_.template(c,{});$(b.el).empty();$(b.el).append(e);var d=($(window).width()-200);var a=($(window).height()-200);$(b.el).dialog({width:d,height:a,modal:true});$("#panelSoftwareInfo").empty();b.printJobListingPanel(b.software,d)},printJobListingPanel:function(software){var self=this;console.log("printJobListingPanel: software="+software.id);$("#jobListDiv").append('<table id="listAlgoInfo" style="margin:0 auto;"></table><div id="pagerAlgoInfo"></div>');var width=$(self.el).width()*0.9;$("#listAlgoInfo").jqGrid({datatype:"local",height:"100%",width:width,colNames:["id","result","running","indeterminate","progress","successful","created"],colModel:[{name:"id",index:"id",width:50,align:"center"},{name:"result",index:"result",width:60,align:"center"},{name:"running",index:"running",width:30,editable:true,edittype:"checkbox",formatter:"checkbox",align:"center"},{name:"indeterminate",index:"indeterminate",width:30,editable:true,edittype:"checkbox",formatter:"checkbox",align:"center"},{name:"progress",index:"progress",width:70,align:"center"},{name:"successful",index:"successful",width:30,editable:true,edittype:"checkbox",formatter:"checkbox",align:"center"},{name:"created",index:"created",width:75,align:"center"}],caption:"Job listing from "+software.get("name")+" for project "+self.project.get("name"),subGrid:true,shrinkToFit:true,pager:$("#pagerAlgoInfo"),sortname:"id",viewrecords:true,sortorder:"desc",subGridRowExpanded:function(subgrid_id,row_id){var idJob=$("#listAlgoInfo").jqGrid("getCell",row_id,1);if(!_.include(self.openParameterGrid,idJob)){self.openParameterGrid.push(idJob)}self.printJobParameter(subgrid_id,row_id,idJob);console.log("openParameterGrid="+self.openParameterGrid)},subGridRowColapsed:function(subgrid_id,row_id){var idJob=$("#listAlgoInfo").jqGrid("getCell",row_id,2);self.openParameterGrid=_.without(self.openParameterGrid,idJob);console.log("openParameterGrid="+self.openParameterGrid)}});console.log("listAlgoInfo2");var refreshData=function(){new JobCollection({project:self.project.id,software:software.id}).fetch({success:function(jobs,response){self.jobCollection=jobs;var i=0;$("#listAlgoInfo").jqGrid("clearGridData");jobs.each(function(job){var dateStr=self.convertLongToDate(job.get("created"));var buttonStr='<button id="seeResult'+job.id+'">See algo result</button>';var data={id:job.id,result:buttonStr,running:job.get("running"),indeterminate:job.get("indeterminate"),progress:'<div class="progBar">'+job.get("progress")+"</div>",successful:job.get("successful"),software:job.get("software"),created:dateStr};$("#listAlgoInfo").jqGrid("addRowData",i+1,data);$("#seeResult"+job.id).button().click(function(){self.selectJob(job)});i++});$("div.progBar").each(function(index){var progVal=eval($(this).text());$(this).text("");$(this).progressbar({value:progVal})});self.reloadJobParameter();$("#pagerAlgoInfo").find("select").val("10")}})};refreshData();$("#listAlgoInfo").jqGrid("navGrid","#pagerAlgoInfo",{edit:false,add:false,del:false},{},{},{},{multipleSearch:true});$("#pagerAlgoInfo").find("select").val("5")},selectJob:function(b){var a=this;$(this.el).dialog("close");console.log("#tabs-algos-"+a.project.id+"-"+a.software.id+"-"+b.id);console.log(b);console.log(a.parent);a.parent.printProjectJobInfo(b.id)},reloadJobParameter:function(){var a=this;console.log("reloadJobParameter");_.each(a.openParameterGrid,function(b){var c=$("td[title='"+b+"']").prev().find("a");c.click()})},printJobParameter:function(h,e,d){var b=this;console.log("printJobParameter="+h+"|"+e);var a,c;a=h+"_t";c="p_"+a;$("#"+h).html("<table id='"+a+"' class='scroll'></table><div id='"+c+"' class='scroll'></div>");var g=Math.round($(window).width()*0.5);$("#"+a).jqGrid({datatype:"local",colNames:["name","value","type"],colModel:[{name:"name",index:"name",width:100,key:true,sortable:false},{name:"value",index:"value",width:300,sortable:false},{name:"type",index:"type",width:70,sortable:false}],rowNum:20,pager:c,sortname:"name",sortorder:"asc",height:"100%",width:g});$("#"+a).jqGrid("navGrid","#"+c,{edit:false,add:false,del:false});var f=0;$("#"+a).jqGrid("clearGridData");console.log(b.jobCollection);console.log(b.jobCollection.get(d));_.each(b.jobCollection.get(d).get("jobParameter"),function(i){var k={name:i.name,value:i.value,type:i.type};$("#"+a).jqGrid("addRowData",f+1,k);f++});$("#"+a).jqGrid("navGrid","#"+c,{edit:false,add:false,del:false});$("#"+a).trigger("reloadGrid")},convertLongToDate:function(e){var b=new Date();b.setTime(e);var g=b.getFullYear();var h=(b.getMonth()+1)<10?"0"+(b.getMonth()+1):(b.getMonth()+1);var d=(b.getDate())<10?"0"+(b.getDate()):(b.getDate());var a=(b.getHours())<10?"0"+(b.getHours()):(b.getHours());var f=(b.getMinutes())<10?"0"+(b.getMinutes()):(b.getMinutes());var c=g+"-"+h+"-"+d+" "+a+"h"+f;return c}});var JobComparatorView=Backbone.View.extend({width:null,software:null,softwares:null,project:null,software1:null,software2:null,job1:null,job2:null,jobs1:null,jobs2:null,parent:null,initialize:function(a){this.width=a.width;this.software=a.software;this.software1=a.software;this.software2=a.software;this.softwares=a.softwares;this.project=a.project;this.job1=a.job1;this.job2=a.job2;this.jobs1=a.jobs;this.jobs2=a.jobs;this.parent=a.parent},render:function(){var a=this;require(["text!application/templates/processing/JobComparator.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var b=this;var e=_.template(c,{});if(b.jobs1.length<1||b.jobs2.length<1){return}$(b.el).empty();$(b.el).append(e);var d=($(window).width()-200);var a=($(window).height()-200);$(b.el).dialog({width:d,height:a,modal:true});b.printSoftwareSelection($("#comparatorSoftwareSelection"));b.changeSelectionValue($("#comparatorSoftwareSelection").find(".job1"),b.software1.id);b.changeSelectionValue($("#comparatorSoftwareSelection").find(".job2"),b.software2.id);b.printJobSelection($("#comparatorJobSelection"));b.changeSelection();b.refreshSelectStyle($("#comparatorJobSelection").find(".job1"));b.refreshSelectStyle($("#comparatorJobSelection").find(".job2"));b.refreshCompareJob()},changeSelection:function(){var a=this;if(a.jobs1.get(a.job1)!=undefined){a.changeSelectionValue($("#comparatorJobSelection").find(".job1"),a.job1.id)}else{a.changeSelectionValue($("#comparatorJobSelection").find(".job1"),a.jobs1.at(0).id)}if(a.jobs2.get(a.job2)!=undefined){a.changeSelectionValue($("#comparatorJobSelection").find(".job2"),a.job2.id)}else{a.changeSelectionValue($("#comparatorJobSelection").find(".job2"),a.jobs2.at(0).id)}},changeSelectionValue:function(a,b){a.find("select").val(b)},retrieveSelectedJob:function(a){return $("#comparatorJobSelection").find(".job"+a).find("select").val()},retrieveSelectedSoftware:function(a){return $("#comparatorSoftwareSelection").find(".job"+a).find("select").val()},cleanCompareJob:function(){$("#comparatorJobInfo").find(".job1").empty();$("#comparatorJobInfo").find(".job2").empty();$("#comparatorJobParam").find(".job1").empty();$("#comparatorJobParam").find(".job2").empty();$("#comparatorJobResult").find(".job1").empty();$("#comparatorJobResult").find(".job2").empty()},reloadSelection:function(){var a=this;$("#comparatorJobSelection").find(".job1").empty();$("#comparatorJobSelection").find(".job2").empty();$("#comparatorSoftwareSelection").find(".job1").empty();$("#comparatorSoftwareSelection").find(".job2").empty();a.printSoftwareSelection($("#comparatorSoftwareSelection"));a.changeSelectionValue($("#comparatorSoftwareSelection").find(".job1"),a.software1.id);a.changeSelectionValue($("#comparatorSoftwareSelection").find(".job2"),a.software2.id);a.printJobSelection($("#comparatorJobSelection"));a.changeSelection();a.refreshCompareJob()},refreshCompareJob:function(){var a=this;a.cleanCompareJob();var c=a.retrieveSelectedJob("1");var b=a.retrieveSelectedJob("2");console.log("idJob1="+c+" idJob2="+b);if(c==undefined||b==undefined){return}new JobModel({id:c}).fetch({success:function(d,e){new JobModel({id:b}).fetch({success:function(g,f){a.job1=d;a.job2=g;a.printJobInfo($("#comparatorJobInfo"));a.printParamJob($("#comparatorJobParam"));a.printResultJob($("#comparatorJobResult"))}})}})},printJobSelection:function(b){var a=this;a.addSelectionView(b.find(".job1"),a.jobs1);a.addSelectionView(b.find(".job2"),a.jobs2)},printSoftwareSelection:function(b){var a=this;a.addSelectionSoftwareView(b.find(".job1"));a.addSelectionSoftwareView(b.find(".job2"))},printJobInfo:function(b){var a=this;console.log("PRINT JOB INFO");a.addJobView(b.find(".job1"),a.job1);a.addJobView(b.find(".job2"),a.job2)},printParamJob:function(b){var a=this;a.addParamView(b.find(".job1"),a.job1);a.addParamView(b.find(".job2"),a.job2)},printResultJob:function(b){var a=this;a.addResultView(b.find(".job1"),a.job1);a.addResultView(b.find(".job2"),a.job2)},addSelectionView:function(b,c){var a=this;b.append("<select></select>");c.each(function(e){var d=a.getClassName(e);b.find("select").append('<option class="'+d+'" value="'+e.id+'">Job '+e.get("number")+" ("+window.app.convertLongToDate(e.get("created"))+")</option>")});b.find("select").change(function(){a.refreshSelectStyle(b);a.refreshCompareJob()})},addSelectionSoftwareView:function(b){var a=this;b.append("<select></select>");a.softwares.each(function(c){if(c.get("resultName")==c.get("resultName")){b.find("select").append('<option value="'+c.id+'">Software '+c.get("name")+"</option>")}});b.find("select").change(function(){a.refreshJobList()})},refreshJobList:function(){var a=this;a.cleanCompareJob();var c=a.retrieveSelectedSoftware("1");a.software1=a.softwares.get(c);var b=a.retrieveSelectedSoftware("2");a.software2=a.softwares.get(b);console.log("Selected software: 1#"+a.software1.id+"- 2#"+a.software2.id);new JobCollection({project:a.project.id,software:a.software1.id,light:true}).fetch({success:function(e,d){a.jobs1=e;new JobCollection({project:a.project.id,software:a.software2.id,light:true}).fetch({success:function(g,f){a.jobs2=g;a.reloadSelection()}})}})},refreshSelectStyle:function(b){var c=b.find("select").val();b.find("select").attr("class","");var a=b.find('option[value="'+c+'"]').attr("class");b.find("select").addClass(a)},getClassName:function(a){if(a.isNotLaunch()){return"btn-inverse"}else{if(a.isInQueue()){return"btn-info"}else{if(a.isRunning()){return"btn-primary"}else{if(a.isSuccess()){return"btn-success"}else{if(a.isFailed()){return"btn-danger"}else{if(a.isIndeterminate()){return"btn-inverse"}else{if(a.isWait()){return"btn-primary"}else{return"no supported"}}}}}}}},addJobView:function(b,c){var a=this;console.log("addJobView");b.append('<div style="margin: 0px auto;min-width:100px;max-width:200px" id="'+c.id+'"></div>');a.parent.buildJobInfoElem(c,b.find("#"+c.id))},addParamView:function(c,d){var a=this;c.append('<table width="100%" style="width:100%;max-width:100%" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-condensed" id="runParamsTable" ></table>');c.find("#runParamsTable").append("<thead><tr><th>Name</th><th>Value</th><th>Type</th></tr></thead>");c.find("#runParamsTable").append("<tbody></tbody>");var b=c.find("#runParamsTable").find("tbody");_.each(d.get("jobParameter"),function(e){b.append("<tr><td>"+e.name+"</td><td>"+a.getJobParamValue(e)+"</td><td>"+e.type+"</td></tr>")});c.find("#runParamsTable").dataTable({sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:10,bLengthChange:false,bDestroy:true,aoColumnDefs:[{sWidth:"40%",aTargets:[0]},{sWidth:"40%",aTargets:[1]},{sWidth:"20%",aTargets:[2]}]})},getJobParamValue:function(c){if(c.type=="List"){var a="<select>";var b=c.value.split(",");_.each(b,function(d){a=a+"<option>"+d+"</option>"});a=a+"</select>";return a}else{return c.value}},addResultView:function(b,c){var a=this;if(window.app.status.currentTermsCollection==undefined||window.app.status.currentAnnotationsCollection==undefined){new AnnotationCollection({project:a.project.id}).fetch({success:function(e,d){window.app.status.currentAnnotationsCollection=e;new TermCollection({idProject:a.project.id}).fetch({success:function(g,f){window.app.status.currentTermsCollection=g;a.initJobResult(c,b)}})}})}else{a.initJobResult(c,b)}},initJobResult:function(d,c){var b=this;var a=new RetrievalAlgoResult({model:d,terms:window.app.status.currentTermsCollection,annotations:window.app.status.currentAnnotationsCollection,project:b.project,el:c}).render()}});var JobSelectionView=Backbone.View.extend({width:null,software:null,project:null,jobs:null,parent:null,availableDate:null,table:null,disableDateChangeEvent:false,currentDate:undefined,comparator:false,selectedJob:null,initialize:function(b){var a=this;this.software=b.software;this.project=b.project;this.parent=b.parent;this.jobs=b.jobs;this.comparator=b.comparator;this.loadDateArray()},render:function(){var a=this;require(["text!application/templates/processing/JobSelection.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var a=this;var b=_.template(c,{});console.log("loadResult");$(a.el).empty();$(a.el).append(b);a.printDatatables(a.jobs.models);a.printDataPicker(undefined);$(a.el).find("#seeAllButton").click(function(){a.currentDate=undefined;a.disableDateChangeEvent=true;$(a.el).find("#datepicker").datepicker("setDate",null);a.disableDateChangeEvent=false;a.refresh()});$(a.el).find("#refreshButton").click(function(){a.refreshWithDate(a.currentDate);$(a.el).find("#datepicker").datepicker("setDate",a.currentDate)})},refresh:function(){this.refreshWithDate(undefined)},refreshWithDate:function(b){var a=this;new JobCollection({project:a.project.id,software:a.software.id,light:true}).fetch({success:function(d,c){a.jobs=d;a.loadDateArray();a.printDatatables(a.jobs.models,b);a.printDataPicker(b);$(a.el).find("#datepicker").datepicker("setDate",b);a.refreshDatePicker()}})},loadDateArray:function(){var a=this;a.availableDate=[];a.jobs.each(function(c){var b=new Date();b.setTime(c.get("created"));b=new Date(b.getFullYear(),b.getMonth(),b.getDate());a.availableDate.push(b.getTime())})},printDataPicker:function(b){var a=this;$(a.el).find("#datepicker").datepicker({beforeShowDay:function(c){if(_.indexOf(a.availableDate,c.getTime())!=-1){return[true,"",""]}else{return[false,"","No job was run at this date!"]}},onSelect:function(c){a.refreshDatePicker()}});if(b!=undefined){a.disableDateChangeEvent=true;$(a.el).find("#datepicker").datepicker("setDate",b);a.disableDateChangeEvent=false}},refreshDatePicker:function(){var b=this;if(!b.disableDateChangeEvent){var c=$(b.el).find("#datepicker").datepicker("getDate");if(c!=null){b.currentDate=c;console.log("self.currentDate="+b.currentDate);var d=b.findJobIndiceBetweenDateTime(c.getTime(),c.getTime()+86400000);var a=b.findJobByIndice(d);console.log(a);b.printDatatables(a,c)}}},findJobIndiceBetweenDateTime:function(d,a){var b=this;var c=_.map(b.availableDate,function(e,f){if(e>=d&&e<a){return f}else{return -1}});c=_.without(c,-1);return c},findJobByIndice:function(a){var b=this;var c=[];_.each(a,function(d){c.push(b.jobs.at(d))});return c},printDatatables:function(a,e){var c=this;var f=$(c.el).find("#selectJobTable").find("tbody").empty();var b=$(c.el).find("#selectJobTable").dataTable();b.fnSetColumnVis(1,true);b.fnClearTable();var d=$(c.el).find("#selectJobTable").find("tbody");if(a!=undefined){_.each(a,function(l){var g='<i class="icon-plus"></i>';var k=l.id;var h=l.get("number");var n=window.app.convertLongToDate(l.get("created"));var i=c.getStateElement(l);var m="";if(c.comparator){m='<a id="select'+l.id+'">Compare</a>'}else{m='<a href="#tabs-algos-'+c.project.id+"-"+c.software.id+"-"+l.id+'" id="'+l.id+'">See details<br></a>'}d.append("<tr><td>"+g+'</td><td  style="text-align:left;">'+k+'</td><td  style="text-align:center;">'+h+'</td><td  style="text-align:center;">'+n+'</td><td  style="text-align:center;">'+i+"</td><td>"+m+"</td></tr>");if(c.comparator){d.find("#select"+l.id).click(function(){c.selectedJob=l.id})}})}c.table=$(c.el).find("#selectJobTable").dataTable({bFilter:false,sDom:'<"toolbar">frtip',sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:5,bLengthChange:false,bDestroy:true,aoColumnDefs:[{sWidth:"5%",aTargets:[0]},{sWidth:"10%",aTargets:[1]},{sWidth:"10%",aTargets:[2]},{sWidth:"25%",aTargets:[3]},{sWidth:"20%",aTargets:[4]},{sWidth:"30%",aTargets:[5]}]});c.initSubGridDatatables();c.table.fnSetColumnVis(1,false)},getStateElement:function(a){if(a.isNotLaunch()){return'<span class="label btn-inverse">Not Launch!</span> '}else{if(a.isInQueue()){return'<span class="label btn-info">In queue!</span> '}else{if(a.isRunning()){return'<span class="label btn-primary">Running!</span> '}else{if(a.isSuccess()){return'<span class="label btn-success">Success!</span> '}else{if(a.isFailed()){return'<span class="label btn-danger">Failed!</span> '}else{if(a.isIndeterminate()){return'<span class="label btn-inverse">Indetereminate!</span> '}else{if(a.isWait()){return'<span class="label btn-warning">Wait!</span> '}else{return"no supported"}}}}}}}},initSubGridDatatables:function(){var a=this;$(a.el).find("#selectJobTable tbody td i").live("click",function(){console.log("CLICK:"+a.table.fnIsOpen(c));var c=$(this).parents("tr")[0];if(a.table.fnIsOpen(c)){$(this).removeClass("class","icon-minus");$(this).addClass("class","icon-plus");a.table.fnClose(c)}else{$(this).removeClass("class","icon-plus");$(this).addClass("class","icon-minus");a.table.fnOpen(c,a.seeDetails(c),"details");var b=a.table.fnGetData(c);console.log("aData[1]="+b[1]);new JobModel({id:b[1]}).fetch({success:function(e,d){var f=$(a.el).find("#selectJobTable").find("table[id="+b[1]+"]");_.each(e.get("jobParameter"),function(g){f.append("<tr><td>"+g.name+"</td><td>"+g.value+"</td><td>"+g.type+"</td></tr>")})}})}})},seeDetails:function(d){var a=this;var b=a.table.fnGetData(d);var c='<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;" id="'+b[1]+'">';c+="</table>";return c}});var LaunchJobView=Backbone.View.extend({width:null,software:null,project:null,parent:null,params:[],paramsViews:[],initialize:function(a){this.width=a.width;this.software=a.software;this.project=a.project;this.parent=a.parent},render:function(){var a=this;require(["text!application/templates/processing/JobLaunch.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var b=this;var e=_.template(c,{});$(b.el).empty();$(b.el).append(e);b.params=[];b.paramsViews=[];var d=($(window).width()-200);var a=($(window).height()-200);$(b.el).dialog({modal:true,minWidth:Math.min(Math.round($(window).width()-75),800),minHeight:Math.round($(window).height()-75),maxWidth:800,buttons:[{text:"Cancel",click:function(){$(this).dialog("close")}},{text:"Create job",click:function(){b.createJobFromParam()}}],close:function(f,g){$("#userRetrievalSuggestMatrixDataTable").empty()}});$("#jobTitle").append("<h3>Run job from "+b.software.get("name")+" on project "+b.project.get("name")+" </h3>");_.each(b.software.get("parameters"),function(f){if(f.name.toLowerCase()!="privatekey"&&f.name.toLowerCase()!="publickey"){b.params.push(f);b.paramsViews.push(b.getParamView(f))}});b.printSoftwareParams()},getParamView:function(a){if(a.type=="String"){return new InputTextView({param:a})}if(a.type=="Number"){return new InputNumberView({param:a})}if(a.type=="Boolean"){return new InputBooleanView({param:a})}if(a.type=="List"){return new InputListView({param:a})}if(a.type=="ListProject"){return new InputListDomainView({param:a,multiple:true,collection:window.app.models.projects,printAttribut:"name"})}if(a.type=="Project"){return new InputListDomainView({param:a,multiple:false,collection:window.app.models.projects,printAttribut:"name"})}else{return new InputTextView({param:a})}},printSoftwareParams:function(){var b=this;if(b.software==undefined){return}$("#launchJobParamsTable").find("tbody").empty();var a=$("#launchJobParamsTable").dataTable();a.fnClearTable();var c=$("#launchJobParamsTable").find("tbody");_.each(b.paramsViews,function(d){d.addRow(c);d.checkEntryValidation()});$("#launchJobParamsTable").dataTable({sDom:"<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},bSort:false,iDisplayLength:1000,bDestroy:true,aoColumnDefs:[{sWidth:"25%",aTargets:[0]},{sWidth:"50%",aTargets:[1]},{sWidth:"25%",aTargets:[2]}]})},createJobFromParam:function(){var a=this;console.log("retrieveParams()...");var c=a.retrieveParams();console.log("createJobModel()...");var b=a.createJobModel(c);console.log("self.saveJobModel(job)...");a.saveJobModel(b)},createJobModel:function(c){var a=this;var b=new JobModel({software:a.software.id,project:a.project.id,params:c});return b},retrieveParams:function(){var a=this;var b=[];_.each(a.paramsViews,function(d){var c=d.param;var e=d.getStringValue();var f={value:'"'+e+'"',softwareParameter:c.id};b.push(f)});return b},saveJobModel:function(b){var a=this;b.save({},{success:function(d,c){window.app.view.message("Add Job",c.message,"success");console.log(d.get("job").id);a.parent.changeJobSelection(d.get("job").id);$(a.el).dialog("close")},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Add Job","error:"+e.errors,"error")}})}});var InputTextView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;">'+a.param.name+'</td><td style="text-align:center;">'+a.getHtmlElem()+'</td><td style="text-align:center;"><span class="label label-important hidden"></span></td></tr>');a.trElem=$("tr#"+a.param.id);a.trElem.find("input").keyup(function(){a.checkEntryValidation()})},getHtmlElem:function(){var a=this;var b="";if(a.param.required){b="border-style: solid; border-width: 2px;"}else{b="border-style: dotted;border-width: 2px;"}return'<div class="control-group success"><div class="controls"><input type="text" class="span3" value="'+a.getDefaultValue()+'" style="text-align:center;'+b+'"></div></div>'},getDefaultValue:function(){return InputView.getDefaultValueWithVariable(this.param.defaultParamValue)},checkEntryValidation:function(){var a=this;console.log("checkEntryValidation");if(a.param.required&&a.getValue().trim()==""){a.changeStyle(a.trElem,false,"Field require")}else{a.changeStyle(a.trElem,true,"")}},getValue:function(){return this.trElem.find("input").val()},getStringValue:function(){return this.getValue()},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputNumberView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;">'+a.param.name+'</td><td style="text-align:center;">'+a.getHtmlElem()+'</td><td style="text-align:center;"><span class="label label-important hidden"></span></td></tr>');a.trElem=$("tr#"+a.param.id);a.trElem.find("input").keyup(function(){a.checkEntryValidation()})},getHtmlElem:function(){var a=this;var b="";if(a.param.required){b="border-style: solid; border-width: 2px;"}else{b="border-style: dotted;border-width: 2px;"}return'<div class="control-group success"><div class="controls"><input type="text" class="span3" value="'+a.getDefaultValue()+'" style="text-align:center;'+b+'"></div></div>'},getDefaultValue:function(){return InputView.getDefaultValueWithVariable(this.param.defaultParamValue)},checkEntryValidation:function(){var a=this;console.log("checkEntryValidation");if(a.param.required&&a.getValue().trim()==""){a.changeStyle(a.trElem,false,"Field require")}else{if(a.getValue().trim()!=""&&isNaN(a.getValue())){a.changeStyle(a.trElem,false,"Not valid number")}else{a.changeStyle(a.trElem,true,"")}}},getValue:function(){return this.trElem.find("input").val()},getStringValue:function(){return this.getValue()},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputBooleanView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;">'+a.param.name+'</td><td style="text-align:center;">'+a.getHtmlElem()+'</td><td style="text-align:center;"><span class="label label-important hidden"></span></td></tr>');a.trElem=$("tr#"+a.param.id);a.trElem.find("input").keyup(function(){a.checkEntryValidation()})},getHtmlElem:function(){return'<input type="checkbox" class="span3" '+this.getDefaultValue()+" />"},getDefaultValue:function(){if(this.param.type=="Boolean"&&this.param.defaultParamValue!=undefined&&this.param.defaultParamValue.toLowerCase()=="true"){return'checked="checked"'}return""},checkEntryValidation:function(){var a=this;console.log("checkEntryValidation");a.changeStyle(a.trElem,true,"")},getValue:function(){return this.trElem.find("input").is(":checked")},getStringValue:function(){return this.getValue()+""},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputListView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;">'+a.param.name+'</td><td style="text-align:center;">'+a.getHtmlElem()+'</td><td style="text-align:center;"><span class="label label-important hidden"></span></td></tr>');a.trElem=$("tr#"+a.param.id);a.trElem.find(".icon-plus-sign").click(function(){console.log("Add entry");var c=$(this).parent().find("input").val();if(c.trim()!=""){$(this).parent().find("select").append('<option value="'+c+'">'+c+"</option>");$(this).parent().find("input").val("");$(this).parent().find("select").val(c);a.checkEntryValidation()}});a.trElem.find(".icon-minus-sign").click(function(){var c=$(this).parent().find("select").val();console.log("delete entry:"+c);console.log("delete entry:"+$(this).parent().find("select").find('[value="'+c+'"]').length);$(this).parent().find("select").find('[value="'+c+'"]').remove();a.checkEntryValidation()})},getHtmlElem:function(){var b=this;var c="";if(b.param.required){c="border-style: solid; border-width: 2px;"}else{c="border-style: dotted;border-width: 2px;"}var d=b.getDefaultValue();var a='<div class="control-group success"><div class="controls"><input type="text" class="span3" value="" style="text-align:center;'+c+'"><i class="icon-plus-sign"></i><select>';_.each(d,function(e){a=a+'<option value="'+e+'">'+e+"</option>"});a=a+'</select><i class="icon-minus-sign"></i></div></div>';return a},getDefaultValue:function(){var b=this;var c=b.param.defaultParamValue.split(",");var a=[];console.log(c);_.each(c,function(d){console.log(d);a.push(InputView.getDefaultValueWithVariable(d))});console.log(a);return a},checkEntryValidation:function(){var a=this;console.log("checkEntryValidation");if(a.trElem.find("select").children().length==0){a.changeStyle(a.trElem,false,"Field require")}else{a.changeStyle(a.trElem,true,"")}},getValue:function(){var a=this;var b=[];a.trElem.find("select").find("option").each(function(){b.push($(this).attr("value"))});return b.join(",")},getStringValue:function(){return this.getValue()},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputListDomainView=Backbone.View.extend({param:null,parent:null,trElem:null,multiple:true,collection:null,printAttribut:null,initialize:function(a){this.param=a.param;this.parent=a.parent;this.multiple=a.multiple;this.collection=a.collection;this.printAttribut=a.printAttribut},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;">'+a.param.name+'</td><td id="'+a.param.id+'" style="text-align:center;"></td><td style="text-align:center;"><span class="errorMessage label label-important hidden"></span></td></tr>');a.trElem=$("tr#"+a.param.id);console.log("*****************************");console.log(a.collection);console.log(a.collection.at(0));if(a.collection==undefined||(a.collection.length>0&&a.collection.at(0).id==undefined)){a.collection.fetch({success:function(d,c){console.log("*****************************");console.log(d);a.collection=d;a.addHtmlElem()}})}else{a.addHtmlElem()}},addHtmlElem:function(){var a=this;a.trElem.find("td#"+a.param.id).append(a.getHtmlElem());var b=null;if(a.multiple){b=function(e,g,c){var f=[];$(c).each(function(){f.push($(this).attr("title"))});var d=f.join(", ");d=d.substring(0,Math.min(15,d.length));return e+" selected: "+d+"..."}}else{b=function(e,g,c){if(e==0){return"0 selected"}var f=[];$(c).each(function(){f.push($(this).attr("title"))});var d=f.join(", ");d=d.substring(0,Math.min(15,d.length));return d}}a.trElem.find(".domainList").multiselect({autoOpen:false,minWidth:300,height:200,multiple:a.multiple,selectedText:b}).multiselectfilter();a.trElem.find(".ui-multiselect-menu").find("span").css("display","inline");a.trElem.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").css("display","inline");a.trElem.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").eq(0).css("float","left");a.trElem.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").eq(1).css("float","right");a.trElem.find(".ui-multiselect-menu").find("li").css("display","block");a.trElem.find("ul.ui-multiselect-checkboxes").css("overflow-y","scroll");a.trElem.find("ul.ui-multiselect-checkboxes").css("overflow-x","hidden");a.trElem.find("button.ui-multiselect").click();a.trElem.find("button.ui-multiselect").click();a.checkEntryValidation();a.trElem.find(".domainList").bind("multiselectclick",function(c,d){a.checkEntryValidationWithAllValue(d.value,d.checked)})},getDefaultValue:function(){var b=this;var c=b.param.defaultParamValue.split(",");var a=[];console.log(c);_.each(c,function(d){console.log(d);a.push(InputView.getDefaultValueWithVariable(d))});console.log(a);return a},getHtmlElem:function(){var b=this;var c="";var d=b.getDefaultValue();if(b.param.required){c="border-style: solid; border-width: 2px;"}else{c="border-style: dotted;border-width: 2px;"}var a='<select class="domainList" multiple="multiple">';b.collection.each(function(f){var e="";_.each(d,function(g){if(g==f.id){e='selected="selected"'}});a=a+"<option "+e+' value="'+f.id+'">'+f.get(b.printAttribut)+"</option>"});a=a+"</select>";return a},checkEntryValidationWithAllValue:function(e,d){var b=this;console.log("checkEntryValidation");var a=b.getValue();var c=a.length;if(d){c++}else{c--}console.log(b.param.required+"|"+a);if(b.param.required&&c==0){b.changeStyle(b.trElem,false,"Field require")}else{b.changeStyle(b.trElem,true,"")}},checkEntryValidation:function(){var b=this;console.log("checkEntryValidation");var a=b.getValue();console.log(b.param.required+"|"+a.length);if(b.param.required&&a.length==0){b.changeStyle(b.trElem,false,"Field require")}else{b.changeStyle(b.trElem,true,"")}},getValue:function(){var b=this;var a=b.trElem.find(".domainList").val();if(a==undefined){return[]}else{return a}},getStringValue:function(){var b=this;var a=b.trElem.find(".domainList").val();if(a==undefined){return""}else{return a.join(",")}},changeStyle:function(c,d,b){var a=c.find(".errorMessage");if(d){a.addClass("hidden");a.text("")}else{a.removeClass("hidden");a.text("");a.text(b)}}});var InputView={changeStyle:function(e,f,d){var c="";if(f){c="success"}else{c="error"}var a=e.children().eq(1).children().eq(0);a.removeClass("success");a.removeClass("error");a.addClass(c);var b=e.find("span");if(f){b.addClass("hidden");b.text("")}else{b.removeClass("hidden");b.text("");b.text(d)}},getDefaultValueWithVariable:function(b){var a=this;if(b=="$currentProject"){return window.app.status.currentProject}else{if(b=="$cytomineHost"){return window.location.protocol+"//"+window.location.host}else{return b}}}};var JobResultView=Backbone.View.extend({software:null,project:null,jobs:null,parent:null,initialize:function(a){this.software=a.software;this.project=a.project;this.jobs=a.jobs},render:function(){var a=this;console.log("self.software.get('resultName')="+a.software.get("resultName"));switch(a.software.get("resultName")){case"ValidateAnnotation":a.valideAnnotation();break;default:a.defaultResult();break}return this},valideAnnotation:function(){var b=this;var a=new RetrievalAlgoResult({model:b.model,project:b.project,el:b.el,jobs:b.jobs,software:b.software}).render()},defaultResult:function(){alert("Result not supported!")}});var SoftwareDetailsView=Backbone.View.extend({software:null,project:null,initialize:function(a){this.software=a.software;this.project=a.project},render:function(){var a=this;require(["text!application/templates/processing/SoftwareDetails.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var b=this;var e=_.template(c,{});$(b.el).empty();$(b.el).append(e);var d=($(window).width()-200);var a=($(window).height()-200);$(b.el).dialog({width:d,height:a,modal:true,buttons:[{text:"Close",click:function(){$(this).dialog("close")}}]});b.printSoftwareName();b.printSoftwareInfo();b.printSoftwareState();b.printSoftwareParams()},printSoftwareName:function(){var a=this;$("#softwareDetailsPanel").find("#softwareName").append("<h2>"+a.software.get("name")+"</h2>")},printSoftwareInfo:function(){var a=this;$("#softwareDetailsPanel").find("#softwareInfo").append("<h4>ID: "+a.software.id+"</h4>");$("#softwareDetailsPanel").find("#softwareInfo").append("<h4>Service Name: "+a.software.get("serviceName")+"</h4>");$("#softwareDetailsPanel").find("#softwareInfo").append("<h4>Result Type: "+a.software.get("resultName")+"</h4>")},printSoftwareState:function(){var a=this;var b=$("#softwareDetailsPanel").find("#softwareInfoList");b.append("<ul></ul>");var c=b.find("ul");c.append("<li>Total Job : "+a.software.get("numberOfJob")+"</li>");c.append('<li>Not Launch : <span class="badge badge-inverse">'+a.software.get("numberOfNotLaunch")+"</span></li>");c.append('<li>In Queue : <span class="badge badge-inverse">'+a.software.get("numberOfInQueue")+"</span></li>");c.append('<li>Running : <span class="badge badge-info">'+a.software.get("numberOfRunning")+"</span></li>");c.append('<li>Success : <span class="badge badge-success">'+a.software.get("numberOfSuccess")+"</span></li>");c.append('<li>Indeterminate : <span class="badge">'+a.software.get("numberOfIndeterminate")+"</span></li>");c.append('<li>Wait : <span class="badge badge-warning">'+a.software.get("numberOfWait")+"</span></li>");c.append('<li>Failed : <span class="badge badge-error">'+a.software.get("numberOfFailed")+"</span></li>");a.printAcitivtyDiagram()},printSoftwareParams:function(){var b=this;$("#softwareParamsTable").find("tbody").empty();var a=$("#softwareParamsTable").dataTable();a.fnClearTable();var c=$("#softwareParamsTable").find("tbody");_.each(b.software.get("parameters"),function(k){var g="<td>"+k.name+"</td>";var h='<td style="text-align:center;">'+k.type+"</td>";var l="<td>"+k.defaultParamValue+"</td>";var i="";if(k.required){i='checked="yes"'}var f='<td style="text-align:center;"><input type="checkbox" '+i+' name="sports" value="basketball" /></td>';var e='<td style="text-align:center;">'+k.index+"</td>";c.append("<tr>"+g+h+l+f+e+"</tr>")});var d=Math.min($("#softwareParams").width()-100,1000);console.log("width="+d);$("#softwareParamsTable").dataTable({sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:999999,bLengthChange:false,bDestroy:true,aoColumnDefs:[{sWidth:"30%",aTargets:[0]},{sWidth:"10%",aTargets:[1]},{sWidth:"40%",aTargets:[2]},{sWidth:"10%",aTargets:[3]},{sWidth:"10%",aTargets:[4]}]})},printAcitivtyDiagram:function(){var a=this;var e=a.software;var f=new google.visualization.DataTable();f.addColumn("string","Success");f.addColumn("number","Succes rate");console.log("printAcitivtyDiagram="+e.id);f.addRows([["Not Launch",e.get("numberOfNotLaunch")],["In Queue",e.get("numberOfInQueue")],["Running",e.get("numberOfRunning")],["Success",e.get("numberOfSuccess")],["Failed",e.get("numberOfFailed")],["Indeterminate",e.get("numberOfIndeterminate")],["Wait",e.get("numberOfWait")]]);var d=$("#softwareInfoChart").width()-100;var b={title:"Job software status for all project",legend:{position:"right"},width:d,height:150,vAxis:{title:"Success rate"},hAxis:{title:"#"},backgroundColor:"whiteSmoke",strictFirstColumnType:false,is3D:true,lineWidth:1,colors:["#434141","#65d7f8","#005ccc","#52a652","#c43c35","#434343","#faaa38"]};var c=new google.visualization.PieChart(document.getElementById("softwareInfoChart"));c.draw(f,b)}});var RetrievalAlgoResult=Backbone.View.extend({width:null,project:null,annotations:null,terms:null,jobs:null,software:null,initialize:function(a){this.annotations=window.app.status.currentAnnotationsCollection;this.terms=window.app.status.currentTermsCollection;this.project=a.project;this.jobs=a.jobs;this.software=a.software},render:function(){var a=this;require(["text!application/templates/processing/RetrievalAlgoResult.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var b=this;var d=((($(b.el).width()-125)/2))+"px";var a="400px";var e=_.template(c,{width:d,height:a});b.width=d;console.log($(b.el));$(b.el).empty();$(b.el).append(e);console.log("StatsRetrievalSuggestionWorstTermWithSuggest:"+b.model.id);new StatsRetrievalSuggestionWorstTermWithSuggest({job:b.model.id}).fetch({success:function(g,f){console.log("StatsRetrievalSuggestionWorstTermWithSuggest model:");console.log(g);b.drawWorstTermTable(g,f,b.terms)}});console.log("StatsRetrievalSuggestionWorstTermModel");new StatsRetrievalSuggestionWorstTermModel({job:b.model.id}).fetch({success:function(g,f){b.drawWorstTermPieChart(g,f,b.terms)}});console.log("StatsRetrievalSuggestionWorstAnnotationModel");new StatsRetrievalSuggestionWorstAnnotationModel({job:b.model.id}).fetch({success:function(g,f){b.drawWorstAnnotationsTable(g,f,b.terms,b.annotations)}});console.log("StatsRetrievalSuggestionEvolutionModel");new StatsRetrievalSuggestionEvolutionModel({job:b.model.id}).fetch({success:function(g,f){b.drawAVGEvolution(g,f)}})},reduceTermName:function(b){var a="";var d=b.split(" ");for(var c=0;c<d.length;c++){a=a+d[c].substring(0,Math.min(4,d[c].length))+". "}return a},drawWorstTermTable:function(c,b,d){var e=c.get("worstTerms");if(e==undefined){$(a.el).find("#worstTermListPanel").hide();return}var a=this;require(["text!application/templates/dashboard/WorstTermList.tpl.html"],function(f){$(a.el).find("#worstTermList").empty();d.each(function(l){var n=_.template(f,{term:l.get("name"),id:l.id,idProject:a.project.id});var g=3;var m=e[l.id];if(m.length>0){$(a.el).find("#worstTermList").append(n)}for(var k=0;k<m.length&&k<g;k++){for(var h in m[k]){if(h!=l.id){var o="term"+l.id+"suggest"+h;$(a.el).find("#list-suggest-"+l.id).append('<a id="'+o+'"><b>'+d.get(h).get("name")+"</b> ("+m[k][h]+"%) </a>");a.linkAnnotationMapWithBadTerm($("#"+o),l.id,h,d)}else{$(a.el).find("#success-suggest-"+l.id).html("");$(a.el).find("#success-suggest-"+l.id).append(m[k][h])}}}});$(a.el).find("#worstTermList").append('<br><button id="matrix-suggest" class="btn">See full information</button>');$(a.el).find("#matrix-suggest").button();$(a.el).find("#matrix-suggest").click(function(){a.initMatrixDialog(d)})})},linkAnnotationMapWithBadTerm:function(b,c,e,d){var a=this;b.click(function(){$(a.el).find("#annotationQuestionable").replaceWith("");$(a.el).find("#annotationQuestionableMain").empty();$(a.el).find("#annotationQuestionableMain").append('<div id="annotationQuestionable"></div>');new AnnotationCollection({project:a.project.id,term:c,suggestTerm:e,job:a.model.id}).fetch({success:function(h,g){var f=new AnnotationQuestionableView({model:h,container:a,el:"#annotationQuestionable",terms:d,term:c,suggestTerm:e}).render()}})})},initMatrixDialog:function(b){var a=this;$(a.el).find("#userRetrievalSuggestMatrixDataTable").empty();new StatsRetrievalSuggestionMatrixModel({job:a.model.id}).fetch({success:function(d,c){console.log("build matrix");a.drawRetrievalSuggestionTable(d,c,b);console.log("build dialog:"+$("#userRetrievalSuggestMatrixDataTable").length);$("#userRetrievalSuggestMatrixDataTable").dialog({modal:true,minWidth:Math.round($(window).width()-75),minHeight:Math.round($(window).height()-75),buttons:[{text:"Ok",click:function(){$(this).dialog("close")}}],close:function(e,f){$("#userRetrievalSuggestMatrixDataTable").empty()}})}})},tableElement:"userRetrievalSuggestMatrixDataTable",tableElementHtml:"userRetrievalSuggestMatrixDataTableHtml",addLine:function(a){$("#userRetrievalSuggestMatrixDataTableHtml").append('<tr onMouseOver="this.className=\'confusionMatrixBadValueHover\'" id="'+a+'" class="confusionMatrixRow"></tr>')},addCell:function(a,b,d,c){this.addCell(a,b,d,c,"")},addCell:function(a,b,f,c,e){$("#userRetrievalSuggestMatrixDataTableHtml").find("tr#"+a).append('<td id="'+b+'"title="'+e+'" class="'+c+'">'+f+"</td>");var d=$("#userRetrievalSuggestMatrixDataTableHtml").find("tr#"+a).find("td#"+b);if(e!=""&&e!=undefined){d.tooltip()}if(a>0&&b>0&&f!=""){this.linkAnnotationMapWithBadTerm(d,a,b,this.terms)}},drawRetrievalSuggestionTable:function(model,response,terms){var self=this;this.terms=terms;var matrixJSON=model.get("matrix");if(matrixJSON==undefined){return}var matrix=eval("("+matrixJSON+")");$("#userRetrievalSuggestMatrixDataTable").append('<table id="userRetrievalSuggestMatrixDataTableHtml" class="table table-condensed"></table>');self.addLine(-1);self.addCell(-1,-1,"X","confusionMatrixHeader");for(var i=1;i<matrix[0].length-1;i++){var termName="";var term=terms.get(matrix[0][i]);if(term!=undefined){termName=self.reduceTermName(term.get("name"))}self.addCell(-1,term.id,termName,"confusionMatrixHeader",term.get("name"));self.addLine(term.id);self.addCell(term.id,-1,termName,"confusionMatrixHeader",term.get("name"))}self.addCell(-1,"total","total","confusionMatrixHeader");for(i=0;i<matrix.length-1;i++){var indx=i+1;for(j=0;j<matrix[indx].length;j++){if(indx==j){self.addCell(matrix[0][j],matrix[indx][0],"<a>"+matrix[indx][j]+"</a>","confusionMatrixDiagonal","Suggest Term "+terms.get(matrix[0][j]).get("name")+" for annotation "+terms.get(matrix[indx][0]).get("name"))}else{if(j==0){var idTerm=matrix[indx][j];var term=terms.get(idTerm);self.addCell(matrix[0][j],matrix[indx][0],term.get("name"),"confusionMatrixHeader")}else{if(j==matrix[indx].length-1){}else{if(matrix[indx][j]>0&&j>0){self.addCell(matrix[indx][0],matrix[0][j],"<a>"+matrix[indx][j]+"</a>","confusionMatrixBadValue","Suggest Term "+terms.get(matrix[0][j]).get("name")+" for annotation "+terms.get(matrix[indx][0]).get("name"))}else{self.addCell(matrix[indx][0],matrix[0][j],"","confusionMatrixSimple","Suggest Term "+terms.get(matrix[0][j]).get("name")+" for annotation "+terms.get(matrix[indx][0]).get("name"))}}}}}}var indx=matrix.length-1;for(i=0;i<matrix.length;i++){var printValue="";var value=matrix[i][matrix[i].length-1];if(value!=-1){printValue=Math.round(value*100)+"%"}self.addCell(matrix[0][i],"total",printValue,"confusionMatrixSimple")}},drawWorstTermPieChart:function(c,b,e){$(this.el).find("#worstTermprojectPieChart").empty();var g=c.get("worstTerms");if(g==undefined){$(this.el).find("#worstTermPieChartPanel").hide();return}var f=new google.visualization.DataTable();f.addColumn("string","Term");f.addColumn("number","Number of questionable annotations");f.addRows(g.length);var a=[];for(var d=0;d<g.length;d++){a.push(g[d].color);f.setValue(d,0,g[d].name);f.setValue(d,1,g[d].rate)}new google.visualization.PieChart($(this.el).find("#worstTermprojectPieChart")[0]).draw(f,{width:this.width,height:350,title:"",backgroundColor:"whiteSmoke",colors:a})},drawWorstAnnotationsTable:function(c,b,e,f){var d=c.get("worstAnnotations");if(d==undefined){$(a.el).find("#worstAnnotationPanel").hide();return}var a=this;require(["text!application/templates/dashboard/SuggestedAnnotationTerm.tpl.html"],function(m){$(a.el).find("#worstannotationitem").empty();if(d.length==0){$(a.el).find("#worstannotationitem").append("You must run Retrieval Validate Algo for this project...")}for(var l=0;l<d.length;l++){var r=d[l];var o=Math.round(r.rate*100)-1+"%";var h=f.get(r.annotation);var q=e.get(r.term).get("name");var g=e.get(r.expectedTerm).get("name");var s="<b>"+q+"</b> for annotation "+h.id+" instead of <b>"+g+"</b>";var p="block";var n=h.get("cropURL");var k=_.template(m,{idProject:a.project.id,idAnnotation:h.id,idImage:h.get("image"),icon:"add.png",text:s,rate:o,cropURL:n,cropStyle:p});$(a.el).find("#worstannotationitem").append(k)}})},drawAVGEvolution:function(k,e){var n=this;var m=k.get("evolution");if(m==undefined){$(n.el).find("#avgEvolutionLineChartPanel").hide();return}var g=new google.visualization.DataTable();g.addColumn("date","Date");g.addColumn("number","Success rate (%)");var d=0;var a=new Date();a.setTime(this.model.get("created"));for(var h=0;h<m.length;h++){var c=new Date();c.setTime(m[h].date);if(a.getTime()==c.getTime()){d=h}g.addRow([c,m[h].avg])}var b=Math.round($(window).width()/2-150);var f=new google.visualization.AreaChart($(this.el).find("#avgEvolutionLineChart")[0]);f.draw(g,{title:"",width:this.width,height:350,vAxis:{title:"Success rate",minValue:0,maxValue:100},hAxis:{title:"Time"},backgroundColor:"whiteSmoke",lineWidth:1});f.setSelection([{row:d,column:1}]);var l=function(){var q=f.getSelection()[0]["row"];var i=f.getSelection()[0]["column"];var o=new Date();o.setTime(m[q].date);if(n.jobs!=null){var p=null;n.jobs.each(function(s){var r=new Date();r.setTime(s.get("created"));if(r.getTime()==o.getTime()){p=s}});window.location="#tabs-algos-"+n.project.id+"-"+n.software.id+"-"+p.id}};google.visualization.events.addListener(f,"select",l)}});OpenLayers.Format.Cytomine=OpenLayers.Class(OpenLayers.Format,{read:function(c){var a=this;var b=[];_.each(c,function(d){var e=a.createFeatureFromAnnotation(d);b.push(e)});return b},createFeatureFromAnnotation:function(b){var f=new OpenLayers.Format.WKT();var a=f.read(b.location);var d=a.geometry;var c=new OpenLayers.Feature.Vector(d);c.attributes={idAnnotation:b.id,measure:"NO",listener:"NO",importance:10};var e="#333333";c.style={strokeColor:"#000",fillColor:e,fillOpacity:0.6};var g="#000";if(_.isArray(b.term)&&_.size(b.term>1)){c.style={strokeColor:g,fillColor:g,fillOpacity:0.6}}else{_.each(b.term,function(h){var i=window.app.status.currentTermsCollection.get(h);if(i==undefined){return}c.style={strokeColor:"#000",fillColor:window.app.status.currentTermsCollection.get(h).get("color"),fillOpacity:0.6}})}return c}});var AnnotationLayer=function(e,d,c,b,f,a,h){var g=new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults({fillColor:b,fillOpacity:0.5,strokeColor:"black",strokeWidth:2},OpenLayers.Feature.Vector.style["default"]),select:OpenLayers.Util.applyDefaults({fillColor:"#25465D",fillOpacity:0.5,strokeColor:"black",strokeWidth:2},OpenLayers.Feature.Vector.style["default"])});this.ontologyTreeView=f;this.name=e;this.map=h;this.imageID=d;this.userID=c;this.vectorsLayer=new OpenLayers.Layer.Vector(this.name,{renderers:["Canvas","SVG","VML"],strategies:[new OpenLayers.Strategy.BBOX({resFactor:1})],protocol:new OpenLayers.Protocol.Script({url:new AnnotationCollection({user:this.userID,image:this.imageID,term:undefined}).url().replace("json","jsonp"),format:new OpenLayers.Format.Cytomine(),callbackKey:"callback"})});this.features=[];this.controls=null;this.dialog=null;this.rotate=false;this.resize=false;this.drag=false;this.irregular=false;this.aspectRatio=false;this.browseImageView=a;this.map=a.map;this.popup=null;this.hoverControl=null;this.triggerUpdateOnUnselect=true,this.isOwner=null;this.deleteOnSelect=false;this.measureOnSelect=false;this.magicOnClick=false;this.cpt=0};AnnotationLayer.prototype={registerEvents:function(b){var a=this;this.vectorsLayer.events.on({clickFeature:function(c){},onSelect:function(c){},featureselected:function(c){if(!a.measureOnSelect){a.ontologyTreeView.refresh(c.feature.attributes.idAnnotation);if(a.deleteOnSelect==true){a.removeSelection()}else{a.showPopup(b,c)}}else{a.showPopupMeasure(b,c)}},featureunselected:function(c){if(a.measureOnSelect){a.vectorsLayer.removeFeatures(c.feature)}if(a.dialog!=null){a.dialog.destroy()}a.ontologyTreeView.clear();a.ontologyTreeView.clearAnnotation();a.clearPopup(b,c)},featureadded:function(c){if(c.feature.geometry.getVertices().length<3){a.vectorsLayer.removeFeatures(c.feature);return}if(!a.measureOnSelect){if(c.feature.attributes.listener!="NO"){c.feature.attributes.measure="YES";a.addAnnotation(c.feature)}}else{a.controls.select.unselectAll();a.controls.select.select(c.feature)}},sketchcomplete:function(c){if(a.triggerUpdateOnUnselect){a.updateAnnotation(c.feature)}},featuremodified:function(c){if(a.triggerUpdateOnUnselect){a.updateAnnotation(c.feature)}},onDelete:function(c){}})},initControls:function(b,a){this.controls={freehand:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Polygon,{handlerOptions:{freehand:true,holeModifier:"altKey"}}),point:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Path),polygon:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Polygon,{handlerOptions:{holeModifier:"altKey"}}),regular:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:5,holeModifier:"altKey"}}),modify:new OpenLayers.Control.ModifyFeature(this.vectorsLayer),select:a};this.controls.freehand.freehand=true;b.initTools(this.controls)},loadAnnotations:function(a){var b=this;a.addVectorLayer(this,this.userID);a.layerLoadedCallback(b)},addFeature:function(a){this.features[a.attributes.idAnnotation]=a;this.vectorsLayer.addFeatures(a)},selectFeature:function(a){this.controls.select.unselectAll();this.controls.select.select(a)},removeFeature:function(a){var b=this.getFeature(a);if(b!=null&&b.popup){this.map.removePopup(b.popup);b.popup.destroy();b.popup=null;this.popup=null}this.vectorsLayer.removeFeatures(b);this.ontologyTreeView.clearAnnotation();this.ontologyTreeView.clear();this.features[a]=null},getFeature:function(a){return this.features[a]},removeSelection:function(){for(var b in this.vectorsLayer.selectedFeatures){var a=this.vectorsLayer.selectedFeatures[b];this.removeAnnotation(a)}},clearPopup:function(c,a){var b=this;feature=a.feature;if(feature.popup){b.popup.feature=null;c.removePopup(feature.popup);feature.popup.destroy();feature.popup=null;b.popup=null}},hideFeature:function(a){if(a.style==undefined){a.style={}}a.style.display="none";this.vectorsLayer.drawFeature(a)},showFeature:function(a){if(a.style==undefined){a.style={}}a.style.display=undefined;this.vectorsLayer.drawFeature(a)},showPopup:function(c,a){var b=this;require(["text!application/templates/explorer/PopupAnnotation.tpl.html"],function(d){if(a.feature.popup!=null){return}new AnnotationModel({id:a.feature.attributes.idAnnotation}).fetch({success:function(e,f){e.set({username:window.app.models.users.get(e.get("user")).prettyName()});var h=new Array();_.each(e.get("userByTerm"),function(n){var m=n.term;var l=window.app.status.currentTermsCollection.get(m).get("name");var o=n.user.length;var i=window.app.status.currentProjectModel.get("ontology");var k=_.template("<a href='#ontology/<%=   idOntology %>/<%=   idTerm %>'><%=   termName %></a> (<%=   userCount %>)",{idOntology:i,idTerm:m,termName:l,userCount:o});h.push(k)});e.set({terms:h.join(", ")});var g=_.template(d,e.toJSON());b.popup=new OpenLayers.Popup("",new OpenLayers.LonLat(a.feature.geometry.getBounds().right+25,a.feature.geometry.getBounds().bottom+25),new OpenLayers.Size(300,200),g,false);b.popup.setBackgroundColor("transparent");b.popup.setBorder(0);b.popup.padding=0;a.feature.popup=b.popup;b.popup.feature=a.feature;c.addPopup(b.popup);$("#annotationHide"+e.id).click(function(){b.controls.select.unselectAll();var k=b.getFeature(e.id);if(k==undefined||k==null){return}b.hideFeature(k);var i="tabs-image-"+window.app.status.currentProjectModel.get("id")+"-"+b.browseImageView.model.get("id")+"-";window.app.controllers.browse.navigate(i,false);return false});if(!window.app.status.currentProjectModel.get("privateLayer")){b.showSimilarAnnotation(e)}else{$("#loadSimilarAnnotation"+e.id).html("Retrieval not available")}}})})},showSimilarAnnotation:function(b){var a=this;new TermCollection({idOntology:window.app.status.currentProjectModel.get("ontology")}).fetch({success:function(d,c){new AnnotationRetrievalModel({annotation:b.id}).fetch({success:function(n,k){var e=n.get("term");var q;var l;var p=0;var m=0;_.each(e,function(i){p=p+i.rate;if(m==0){q=i}if(m==1){l=i}m++});var h;var g;var f=0;var o=0;if(q!=undefined){h=q.id;f=q.rate;if(f==0){h=undefined}}if(l!=undefined){g=l.id;o=l.rate;if(o==0){g=undefined}}f=(f/p)*100;o=(o/p)*100;a.printSuggestedTerm(b,d.get(h),d.get(g),f,o,d,n.get("annotation"))},error:function(f,e){$("#loadSimilarAnnotation"+b.id).replaceWith("Error: cannot reach retrieval")}})}})},printSuggestedTerm:function(d,c,a,b,f,e,g){var k=this;var h="";var i="";if(c!=undefined){h+='<span id="changeBySuggest'+c.id+'" style="display : inline"><u>'+c.get("name")+"</u> ("+Math.round(b)+"%)<span>"}if(a!=undefined){i+=' or <span id="changeBySuggest'+a.id+'" style="display : inline"><u>'+a.get("name")+"</u> ("+Math.round(f)+"%)<span>"}$("#suggTerm"+d.id).empty();$("#suggTerm"+d.id).append(h);$("#suggTerm"+d.id).append(i);if(c!=undefined){k.createSuggestedTermLink(c,d)}if(a!=undefined){k.createSuggestedTermLink(a,d)}$("#loadSimilarAnnotation"+d.id).replaceWith('<a href="#" id="annotationSimilar'+d.id+'"> Search similar annotations</a>');$("#annotationSimilar"+d.id).click(function(){$("#annotationRetrieval").replaceWith("");$("#annotationRetrievalMain").empty();$("#annotationRetrievalMain").append('<div id="annotationRetrieval"></div>');var l=new AnnotationRetrievalView({model:new AnnotationRetrievalCollection(g),projectsPanel:k,container:k,el:"#annotationRetrieval",baseAnnotation:d,terms:e}).render();return false})},createSuggestedTermLink:function(c,a){var b=this;$("#changeBySuggest"+c.id).click(function(){new AnnotationTermModel({term:c.id,annotation:a.id,clear:true}).save(null,{success:function(e,d){window.app.view.message("Correct Term",d.message,"");b.ontologyTreeView.refresh(a.id)},error:function(e,d){var f=$.parseJSON(d.responseText);window.app.view.message("Correct term","error:"+f.errors,"")}})})},showPopupMeasure:function(c,a){var b=this;require(["text!application/templates/explorer/PopupMeasure.tpl.html"],function(e){if(a.feature.popup!=null){return}var d=b.browseImageView.model.get("resolution");var g=a.feature.geometry.getLength();if(d!=undefined&&d!=null){g*=d;g=Math.round(g*1000)/1000;g+=" µm"}else{g+=" pixels"}var f=_.template(e,{length:g});b.popup=new OpenLayers.Popup("chicken",new OpenLayers.LonLat(a.feature.geometry.getBounds().right+50,a.feature.geometry.getBounds().bottom+50),new OpenLayers.Size(200,60),f,false);b.popup.setBackgroundColor("transparent");b.popup.setBorder(0);b.popup.padding=0;a.feature.popup=b.popup;b.popup.feature=a.feature;c.addPopup(b.popup)})},enableHightlight:function(){},disableHightlight:function(){},initHightlight:function(a){},addAnnotation:function(d){var c=this;var b=this;var g=new OpenLayers.Format.WKT();var f=g.write(d);var e=c.ontologyTreeView.getTermsChecked();var a=new AnnotationModel({name:"",location:f,image:this.imageID,term:e});a.save({},{success:function(h,i){var h=new AnnotationModel();h.set(i.annotation);var l=i.message;b.vectorsLayer.removeFeatures([d]);var o=b.createFeatureFromAnnotation(h);b.addFeature(o);b.controls.select.unselectAll();b.controls.select.select(o);var k=h.get("cropURL");var n=_.template("<img src='<%=   url %>' alt='<%=   alt %>' style='max-width: 175px;max-height: 175px;' />",{url:k,alt:k});var m=_.template("<p><%=   message %></p><div><%=   cropImage %></div>",{message:l,cropImage:n});window.app.view.message("Annotation added",m,"success")},error:function(i,h){var k=$.parseJSON(h.responseText);window.app.view.message("Add annotation","error:"+k.errors,"error")}})},createFeatureFromAnnotation:function(b){var f=new OpenLayers.Format.WKT();var a=f.read(b.get("location"));var d=a.geometry;var c=new OpenLayers.Feature.Vector(d);c.attributes={idAnnotation:b.get("id"),measure:"NO",listener:"NO",importance:10};var e="#333333";c.style={strokeColor:"#000",fillColor:e,fillOpacity:0.6};var g="#000";if(_.size(b.get("term"))>1){c.style={strokeColor:g,fillColor:g,fillOpacity:0.6}}else{_.each(b.get("term"),function(h){var i=window.app.status.currentTermsCollection.get(h);if(i==undefined){return}c.style={strokeColor:"#000",fillColor:window.app.status.currentTermsCollection.get(h).get("color"),fillOpacity:0.6}})}return c},removeAnnotation:function(c){var a=c.attributes.idAnnotation;this.removeFeature(c);this.controls.select.unselectAll();this.vectorsLayer.removeFeatures([c]);var b=this;new AnnotationModel({id:c.attributes.idAnnotation}).destroy({success:function(e,d){window.app.view.message("Annotation",d.message,"success");b.browseImageView.refreshAnnotationTabs(undefined)},error:function(e,d){var f=$.parseJSON(d.responseText);window.app.view.message("Annotation",f.errors,"error")}})},updateAnnotation:function(b){if(b.attributes.idAnnotation==undefined){return}var a=this;var d=new OpenLayers.Format.WKT();var c=d.write(b);new AnnotationModel({id:b.attributes.idAnnotation}).fetch({success:function(f,e){f.save({location:c},{success:function(g,h){var i=h.message;var k=_.template("<p><%=   message %></p>",{message:i});window.app.view.message("Annotation edited",k,"success")},error:function(h,g){var i=$.parseJSON(g.responseText);window.app.view.message("Annotation",i.errors,"")}})}})},toggleRotate:function(){this.resize=false;this.drag=false;this.rotate=true;this.updateControls();this.toggleControl("modify")},toggleResize:function(){this.resize=true;this.drag=false;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleDrag:function(){this.resize=false;this.drag=true;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleEdit:function(){this.resize=false;this.drag=false;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleIrregular:function(){this.irregular=!this.irregular;this.updateControls()},toggleAspectRatio:function(){this.aspectRatio=!this.aspectRatio;this.updateControls()},setSides:function(a){this.sides=a;this.updateControls()},updateControls:function(){this.controls.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE;if(this.rotate){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.ROTATE}if(this.resize){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.RESIZE;if(this.aspectRatio){this.controls.modify.mode&=~OpenLayers.Control.ModifyFeature.RESHAPE}}if(this.drag){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.DRAG}if(this.rotate||this.drag){this.controls.modify.mode&=~OpenLayers.Control.ModifyFeature.RESHAPE}this.controls.regular.handler.sides=this.sides;this.controls.regular.handler.irregular=this.irregular},disableMeasureOnSelect:function(){var a=this;this.measureOnSelect=false;for(var c in this.vectorsLayer.features){var b=this.vectorsLayer.features[c];if(b.attributes.measure==undefined||b.attributes.measure=="YES"){a.vectorsLayer.removeFeatures(b);if(b.popup){a.popup.feature=null;a.map.removePopup(b.popup);b.popup.destroy();b.popup=null;a.popup=null}}}},toggleControl:function(a){this.deleteOnSelect=false;this.disableMeasureOnSelect();this.magicOnClick=false;for(key in this.controls){var d=this.controls[key];if(a==key){d.activate();if(d==this.controls.modify){for(var c in this.vectorsLayer.selectedFeatures){var b=this.vectorsLayer.selectedFeatures[c];d.selectFeature(b)}}}else{d.deactivate();if(d==this.controls.modify){for(var c in this.vectorsLayer.selectedFeatures){var b=this.vectorsLayer.selectedFeatures[c];d.unselectFeature(b)}}}}},annotationAdded:function(a){var b=this;var c=b.deleteOnSelect;b.deleteOnSelect=false;new AnnotationModel({id:a}).fetch({success:function(d){var e=b.createFeatureFromAnnotation(d);b.addFeature(e);b.selectFeature(e);b.controls.select.activate();b.deleteOnSelect=c}})},annotationRemoved:function(a){this.removeFeature(a)},annotationUpdated:function(a,b){this.annotationRemoved(a);this.annotationAdded(a)},termAdded:function(a,b){this.ontologyTreeView.check(b)},termRemoved:function(a,b){this.ontologyTreeView.uncheck(b)}};var BrowseImageView=Backbone.View.extend({tagName:"div",tileSize:256,initialize:function(a){this.iPad=(navigator.userAgent.match(/iPad/i)!=null);this.initCallback=a.initCallback;this.layers=[];this.layersLoaded=0;this.baseLayers=[];this.broadcastPositionInterval=null;this.watchOnlineUsersInterval=null;this.annotationsPanel=null;this.map=null;this.currentAnnotation=null;_.bindAll(this,"initVectorLayers")},doLayout:function(b){var a=this;var c=this.model.toJSON();c.project=window.app.status.currentProject;$(this.el).append(_.template(b,c));var f=this.model.get("originalFilename");if(f.length>25){f=f.substring(0,23)+"..."}var e="<li><a style='float: left;' id='tabs-image-<%= idImage %>' rel='tooltip' title='<%= originalFilename %>' href='#tabs-image-<%= idProject %>-<%= idImage %>-' data-toggle='tab'><i class='icon-search' /> <%= shortOriginalFilename %> </a></li>";$(".nav-tabs").append(_.template(e,{idProject:window.app.status.currentProject,idImage:this.model.get("id"),originalFilename:this.model.get("originalFilename"),shortOriginalFilename:f}));var d='<li class="dropdown"><a href="#" id="tabs-image-<%= idImage %>-dropdown" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#tabs-dashboard-<%= idProject %>" data-toggle="tab" data-image="<%= idImage %>" class="closeTab"><i class="icon-remove" /> Close</a></li></ul></li>';$(".nav-tabs").append(_.template(d,{idProject:window.app.status.currentProject,idImage:this.model.get("id"),filename:this.model.get("filename")}));this.initToolbar();this.initMap();this.initAnnotationsTabs();if(this.iPad){this.initMobile()}return this},initMobile:function(){},render:function(){var a=this;require(["text!application/templates/explorer/BrowseImage.tpl.html"],function(b){a.doLayout(b)});return this},show:function(b){var a=this;if(b.goToAnnotation!=undefined){new AnnotationModel({id:b.goToAnnotation.value}).fetch({success:function(c,d){var e=_.find(a.layers,function(f){return f.userID==c.get("user")});if(e){a.setLayerVisibility(e,true);a.goToAnnotation(e,c)}}})}},refreshAnnotationTabs:function(a){this.annotationsPanel.refreshAnnotationTabs(a)},setLayerVisibility:function(b,a){console.log("setLayerVisibility");$("#layerSwitcher"+this.model.get("id")).find("ul.annotationLayers").find(":checkbox").each(function(){console.log("Layer name = "+b.name);console.log("Layer value = "+$(this).attr("value"));if(b.name!=$(this).attr("value")){return}if(a){if($(this).attr("checked")!="checked"){this.click()}}else{if($(this).attr("checked")=="checked"){this.click()}}})},switchControl:function(b){var a=$("#toolbar"+this.model.get("id"));a.find("input[id="+b+this.model.get("id")+"]").click()},goToAnnotation:function(g,d){var o=this;var k=new OpenLayers.Format.WKT();var l=k.read(d.get("location"));var i=l.geometry;var b=i.getBounds();var h=b.right-b.left;var m=b.top-b.bottom;var c=$(window).width();var a=$(window).height();var n=o.map.getNumZoomLevels()-1;var f=h;var e=m;while((f>c)||(e>a)){f/=2;e/=2;n--}n=Math.max(0,n-1);o.map.moveTo(new OpenLayers.LonLat(i.getCentroid().x,i.getCentroid().y),Math.max(0,n))},getFeature:function(a){return this.userLayer.getFeature(a)},removeFeature:function(a){return this.userLayer.removeFeature(a)},layerLoadedCallback:function(d){var b=this;this.layersLoaded++;var e=window.app.status.currentProjectModel;if(this.layersLoaded==e.get("userLayers").length){var a=_.map(this.layers,function(f){return f.vectorsLayer});var c=new OpenLayers.Control.SelectFeature(a);_.each(this.layers,function(f){f.initControls(b,c);f.registerEvents(b.map);if(f.isOwner){b.userLayer=f;f.vectorsLayer.setVisibility(true);f.toggleIrregular();var g=$("#toolbar"+b.model.get("id"));g.find("input[id=none"+b.model.get("id")+"]").click()}else{f.controls.select.activate();f.vectorsLayer.setVisibility(false)}});if(_.isFunction(b.initCallback)){b.initCallback.call()}b.initAutoAnnoteTools()}},getUserLayer:function(){return this.userLayer},initMap:function(){var a=this;var b=this.model.get("mime");if(b=="vms"||b=="mrxs"||b=="tif"||b=="tiff"||b=="svs"){a.initIIP()}},addBaseLayer:function(b){var a=this;this.map.addLayer(b);this.baseLayers.push(b);a.map.setBaseLayer(b);this.layerSwitcherPanel.addBaseLayer(b,this.model)},addVectorLayer:function(b,a){b.vectorsLayer.setVisibility(false);this.map.addLayer(b.vectorsLayer);this.layers.push(b);this.layerSwitcherPanel.addVectorLayer(b,this.model,a)},createLayerSwitcher:function(){this.layerSwitcherPanel=new LayerSwitcherPanel({browseImageView:this,model:this.model,el:this.el}).render()},createOverviewMap:function(){new OverviewMapPanel({model:this.model,el:this.el}).render()},initIIP:function(){var a=this;var f=function(p,q,l){a.createLayerSwitcher();a.initImageFiltersPanel();var u={maxExtent:new OpenLayers.Bounds(0,0,p.width,p.height),maxResolution:Math.pow(2,p.nbZoom-1),numZoomLevels:p.nbZoom,units:"pixels",tileSize:new OpenLayers.Size(a.tileSize,a.tileSize),controls:[new OpenLayers.Control.TouchNavigation({dragPanOptions:{enableKinetic:window.app.view.isMobile}}),new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:window.app.view.isMobile}}),new OpenLayers.Control.ZoomPanel(),new OpenLayers.Control.MousePosition(),new OpenLayers.Control.KeyboardDefaults()],eventListeners:{zoomend:function(x){var z=x.object;var y=a.model.get("magnification");var v=z.getNumZoomLevels()-z.getZoom()-1;var w=y;if(v!=0){w=y/(Math.pow(2,v))}w=Math.round(w*100)/100;$("#zoomInfoPanel"+a.model.id).html(w+"X");a.broadcastPosition()},moveend:function(){a.broadcastPosition()}}};var k=new OpenLayers.Layer.Image("Overview"+a.model.get("id"),a.model.get("thumb"),new OpenLayers.Bounds(0,0,p.width,p.height),new OpenLayers.Size(p.overviewWidth,p.overviewHeight));a.createOverviewMap();var i=new OpenLayers.Control.OverviewMap({size:new OpenLayers.Size(p.overviewWidth,p.overviewHeight),layers:[k],div:document.getElementById("overviewmapcontent"+a.model.get("id")),minRatio:1,maxRatio:1024,mapOptions:{maxExtent:new OpenLayers.Bounds(0,0,p.width,p.height),maximized:true}});a.map=new OpenLayers.Map("map"+a.model.get("id"),u);a.initOntology();var t=77;var s=$(window).height()-t;$("#map"+a.model.get("id")).css("height",s);$("#map"+a.model.get("id")).css("width","100%");$(window).resize(function(){var v=$(window).height()-t;$("#map"+a.model.get("id")).css("height",v)});var o=new OpenLayers.Layer.Zoomify("Original",q,new OpenLayers.Size(p.width,p.height));o.getImageSize=function(){if(arguments.length>0){bounds=this.adjustBounds(arguments[0]);var B=this.map.getResolution();var v=Math.round((bounds.left-this.tileOrigin.lon)/(B*this.tileSize.w));var E=Math.round((this.tileOrigin.lat-bounds.top)/(B*this.tileSize.h));var D=this.map.getZoom();var A=this.standardTileSize;var C=this.standardTileSize;if(v==this.tierSizeInTiles[D].w-1){A=this.tierImageSize[D].w%this.standardTileSize;if(A==0){A=this.standardTileSize}}if(E==this.tierSizeInTiles[D].h-1){C=this.tierImageSize[D].h%this.standardTileSize;if(C==0){C=this.standardTileSize}}return(new OpenLayers.Size(A,C))}else{return this.tileSize}};l.each(function(x){var v=_.map(q,function(y){return x.get("baseUrl")+y});var w=new OpenLayers.Layer.Zoomify(x.get("name"),v,new OpenLayers.Size(p.width,p.height));w.transitionEffect="resize";a.addBaseLayer(w)});a.addBaseLayer(o);a.map.zoomToMaxExtent();a.map.addControl(i);var h=$(window).width();var g=$(window).height()-t;var n=p.width;var m=p.height;var r=p.nbZoom;while(n>h||m>g){n/=2;m/=2;r--}a.map.zoomTo(r);window.app.view.applyPreferences();a.initBroadcastingInterval();a.initWatchOnlineUsersInterval()};var d=a.model.get("width");var c=a.model.get("height");var e=1;while(d>a.tileSize||c>a.tileSize){e++;d=Math.floor(d/2);c=Math.floor(c/2)}var b={width:a.model.get("width"),height:a.model.get("height"),nbZoom:e,overviewWidth:200,overviewHeight:Math.round((200/a.model.get("width")*a.model.get("height")))};new ImageServerUrlsModel({id:a.model.get("baseImage")}).fetch({success:function(h,g){new ProjectImageFilterCollection({project:a.model.get("project")}).fetch({success:function(k,i){f(b,h.get("imageServersURLs"),k)}})}})},broadcastPosition:function(){var d=this.model.get("id");var a=this.map.getExtent().getCenterLonLat();var e=a.lon;var c=a.lat;var b=this.map.zoom;if(b==null||e==null||c==null){return}new UserPositionModel({lon:e,lat:c,zoom:b,image:d}).save()},reloadAnnotation:function(a){var b=this;b.removeFeature(a);new AnnotationModel({id:a}).fetch({success:function(c,d){var e=b.userLayer.createFeatureFromAnnotation(c);b.userLayer.addFeature(e);b.userLayer.selectFeature(e)}})},initBroadcastingInterval:function(){var a=this;this.broadcastPositionInterval=setInterval(function(){a.broadcastPosition()},5000)},stopBroadcastingInterval:function(){clearInterval(this.broadcastPositionInterval)},initWatchOnlineUsersInterval:function(){var a=this;this.watchOnlineUsersInterval=setInterval(function(){new UserOnlineModel({image:a.model.get("id")}).fetch({success:function(c,b){var d=c.get("users").split(",");a.layerSwitcherPanel.updateOnlineUsers(d)}})},5000)},stopWatchOnlineUsersInterval:function(){clearInterval(this.watchOnlineUsersInterval)},initAutoAnnoteTools:function(){var a=this;var b=function b(d){if(!a.getUserLayer().magicOnClick){return}var f=a.map.getLonLatFromViewPortPx(d.xy);var g=parseInt(a.model.get("height"))-f.lat;var c=f.lon;var e="processing/detect/"+a.model.get("id")+"/"+c+"/"+g;$.getJSON(e,function(i){var l=new OpenLayers.Format.WKT();var h=l.read(i.geometry);var k=h.geometry;a.getUserLayer().addAnnotation(new OpenLayers.Feature.Vector(k))})};if(a.getUserLayer()!=undefined){a.map.events.register("click",a.getUserLayer().vectorsLayer,b)}},initToolbar:function(){var b=$("#toolbar"+this.model.get("id"));var a=this;$("a[id=none"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("none");a.getUserLayer().enableHightlight()});b.find("a[id=select"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleControl("select");a.getUserLayer().disableHightlight()});b.find("a[id=regular4"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(4);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("a[id=regular30"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(15);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("a[id=polygon"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("polygon");a.getUserLayer().disableHightlight()});b.find("a[id=freehand"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("freehand");a.getUserLayer().disableHightlight()});if(this.iPad){b.find("a[id=freehand"+this.model.get("id")+"]").hide()}b.find("a[id=magic"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("select");a.getUserLayer().magicOnClick=true;a.getUserLayer().disableHightlight()});if(this.iPad){b.find("a[id=magic"+this.model.get("id")+"]").hide()}b.find("a[id=modify"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleEdit();a.getUserLayer().toggleControl("modify");a.getUserLayer().disableHightlight()});b.find("a[id=delete"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("select");a.getUserLayer().deleteOnSelect=true;a.getUserLayer().disableHightlight()});b.find("a[id=rotate"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleRotate();a.getUserLayer().disableHightlight()});b.find("a[id=resize"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleResize();a.getUserLayer().disableHightlight()});b.find("a[id=drag"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleDrag();a.getUserLayer().disableHightlight()});b.find("a[id=ruler"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("line");a.getUserLayer().measureOnSelect=true;a.getUserLayer().disableHightlight()})},initVectorLayers:function(c){var b=this;var d=window.app.status.currentProjectModel;var a=window.app.models.users.select(function(e){return _.include(d.get("userLayers"),e.id)});_.each(a,function(e){var f=new AnnotationLayer(e.prettyName(),b.model.get("id"),e.get("id"),e.get("color"),c,b,b.map);f.isOwner=(e.get("id")==window.app.status.user.id);f.loadAnnotations(b)})},initAnnotationsTabs:function(){this.annotationsPanel=new AnnotationsPanel({el:this.el,model:this.model}).render()},initOntology:function(){var a=this;new OntologyPanel({el:this.el,model:this.model,callback:a.initVectorLayers,browseImageView:a}).render()},initImageFiltersPanel:function(){var a=this;a.imageFiltersPanel=new ImageFiltersPanel({el:this.el,model:this.model,browseImageView:a}).render()},initTools:function(a){for(var b in a){this.map.addControl(a[b])}}});var DraggablePanelView=Backbone.View.extend({tagName:"div",initialize:function(a){this.iPad=(navigator.userAgent.match(/iPad/i)!=null);this.el=a.el;this.template=a.template;this.className=a.className},render:function(){var p=this;$(this.el).html(this.template);if(this.iPad){return this}var b=null;var o=null;var c=null;var i=null;var d=$(window).width();var g=false;var m=false;var k=function(s,r){var t=$("."+p.className).find(".minimized");$("."+p.className).children().hide();t.show();c=Math.max(58,t.width());i=Math.max(18,t.height());q(s)};var f=function(s,r){var t=$("."+p.className).find(".minimized");$("."+p.className).children().show();$("."+p.className).css("padding-left","0px");t.hide();q(s)};var q=function(r){if(g){$(r).css("width",c);$(r).css("height",i)}else{$(r).css("width",b);$(r).css("height",o)}};var n=function(r){if(m){return}if(g){window.app.view.hideFloatingPanels();f(r);var s=$("."+r.className);s.show();s.css("width",b);s.css("height",b)}};var e=function(r){if(m){return}if(g){window.app.view.showFloatingPanels();k(r);var s=$("."+r.className);s.css("width",c);s.css("height",i)}};var h=function(t,r,s){};var a=function(t,r,s){m=true;$(t).css("overflow","hidden")};var l=function(v,r,t){m=false;$(v).css("overflow","auto");var u=Math.max(0,parseInt(r.left));var s=Math.max(0,parseInt(r.top));if(t.className){window.app.view.updatePosition(p.className,{left:u,top:s},false)}};$(this.el).draggable({cancel:"input olControlOverviewMapElement",handle:".dragHandle",start:function(r,s){a(this,s.helper.position(),p)},stop:function(r,s){l(this,s.helper.position(),p)},drag:function(r,s){h(this,s.helper.position(),p)}});$(this.el).on("mouseenter",function(){n(p)});$(this.el).on("mouseleave",function(){e(p)});$(this.el).draggable("option","opacity",0.35);$("."+this.className).bind("movedProgramatically",function(x){var v=$(p.el).css("left");v=(v==undefined||v=="auto")?undefined:parseInt(v.substr(0,v.length-2));var A=$(p.el).css("right");A=(A==undefined||A=="auto")?undefined:parseInt(A.substr(0,A.length-2));var z=$(p.el).css("top");z=(z==undefined||z=="auto")?undefined:parseInt(z.substr(0,z.length-2));var t=$(p.el).css("bottom");t=(t==undefined||t=="auto")?undefined:parseInt(t.substr(0,t.length-2));var s=$("."+p.className).width();var y=$("."+p.className).height();var u=$(window).width();var r=$(window).height();var w=undefined;if(v!=undefined&&z!=undefined){w={left:v,top:z}}if(v!=undefined&&t!=undefined){w={left:v,top:r-(t+y)}}else{if(A!=undefined&&z!=undefined){w={left:u-(A+s),top:z}}else{if(A!=undefined&&t!=undefined){w={left:u-(A+s),top:r-(t+y)}}}}if(w!=undefined){a($("."+p.className),w,p);h($("."+p.className),w,p);l($("."+p.className),w,p)}});return this}});var ExplorerTabs=Backbone.View.extend({tagName:"div",triggerRoute:true,initialize:function(a){this.tabs=[];this.container=a.container;this.dashboard=null},render:function(){var a=this;require(["text!application/templates/explorer/Tabs.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{}));return this},addBrowseImageView:function(c,b){var a=this;var e=this.getBrowseImageView(c);if(e!=null){e.view.show(b);return}var d=$("#explorer-tab-content");new ImageInstanceModel({id:c}).fetch({success:function(h,g){var f=new BrowseImageView({model:h,initCallback:function(){f.show(b)},el:d}).render();$(".closeTab").on("click",function(k){var i=$(this).attr("data-image");a.removeTab(i)});a.showTab(c);a.tabs.push({idImage:c,view:f})}})},getBrowseImageView:function(b){var a=_.detect(this.tabs,function(c){return c.idImage==b});return a!=null?a:null},removeTab:function(b){var a=this.getBrowseImageView(b);a.view.stopBroadcastingInterval();a.view.stopWatchOnlineUsersInterval();var d=this.tabs.indexOf(a);this.tabs.splice(d,1);var c=$(this.el).children(".nav-tab");$("#tabs-image-"+b).parent().remove();$("#tabs-image-"+b+"-dropdown").parent().remove();$("#tabs-image-"+window.app.status.currentProject+"-"+b+"-").remove()},showTab:function(a){var b=$("#explorer > .browser").find(".nav-tabs");window.app.controllers.browse.tabs.triggerRoute=false;$("#tabs-image-"+a).click();window.app.controllers.browse.tabs.triggerRoute=true},size:function(){return _.size(this.tabs)},closeAll:function(){var a=$(this.el).children(".tabs");this.tabs=[];$(this.el).hide();$(this.el).parent().find(".noProject").show()},addDashboard:function(b){var a=this;this.dashboard=b;var c=$("#explorer-tab-content");$(".nav-tabs").append(_.template("<li><a href='#tabs-dashboard-<%= idProject %>' data-toggle='tab'><i class='icon-road' /> Dashboard</a></li>",{idProject:window.app.status.currentProject}));$(".nav-tabs").append(_.template("<li><a href='#tabs-images-<%= idProject %>' data-toggle='tab'><i class='icon-picture' /> Images</a></li>",{idProject:window.app.status.currentProject}));$(".nav-tabs").append(_.template("<li><a href='#tabs-annotations-<%= idProject %>' data-toggle='tab'><i class='icon-pencil' /> Annotations</a></li>",{idProject:window.app.status.currentProject}));$(".nav-tabs").append(_.template("<li><a href='#tabs-algos-<%= idProject %>' data-toggle='tab'><i class='icon-play-circle' /> Software</a></li>",{idProject:window.app.status.currentProject}));$(".nav-tabs").append(_.template("<li><a href='#tabs-config-<%= idProject %>' data-toggle='tab'><i class='icon-cog' /> Configuration</a></li>",{idProject:window.app.status.currentProject}));$('a[data-toggle="tab"]').live("show",function(f){var d=this.href.split("#")[1];$("#"+d).attr("style","width:100%;height:500;overflow:hidden;");if(a.triggerRoute){window.app.controllers.browse.navigate("#"+d,a.triggerRoute)}});$("#explorer > .browser").show();$("#explorer > .noProject").hide()},getDashboard:function(){return this.dashboard}});var AnnotationsPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.refreshAnnotationsTabsFunc=[]},render:function(){var a=this;require(["text!application/templates/explorer/AnnotationsPanel.tpl.html"],function(b){a.doLayout(b)});return this},createTabs:function(b){var a=this;require(["text!application/templates/explorer/TermTab.tpl.html","text!application/templates/explorer/TermTabContent.tpl.html"],function(c,d){new TermCollection({idOntology:b}).fetch({success:function(g,e){window.app.status.currentTermsCollection=g;a.addTermToTab(c,d,{id:"all",image:a.model.id,name:"All"});a.refreshAnnotationsTabsFunc.push({index:0,idTerm:"all",refresh:function(){a.refreshAnnotations(undefined,$("#tabsterm-"+a.model.id+"-all"))}});var f=1;g.each(function(h){a.addTermToTab(c,d,{id:h.get("id"),image:a.model.id,name:h.get("name")});a.refreshAnnotationsTabsFunc.push({index:f,idTerm:h.get("id"),refresh:function(){a.refreshAnnotations(h.get("id"),$("#tabsterm-"+a.model.id+"-"+h.get("id")))}});f++});$("#annotationsPanel"+a.model.id).find(".tabsAnnotation").tabs({add:function(h,i){},select:function(h,i){var k=_.detect(a.refreshAnnotationsTabsFunc,function(l){return(l.index==i.index)});k.refresh.call()}});$("#annotationsPanel"+a.model.id).find(".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *").removeClass("ui-corner-all ui-corner-top").addClass("ui-corner-bottom");a.initAnnotations()}})})},refreshAnnotationTabs:function(b){var a=this;if(b!=undefined){var d=_.detect(a.refreshAnnotationsTabsFunc,function(e){return(e.idTerm==b)});d.refresh.call()}else{var c=$("#annotationsPanel"+a.model.id).find(".tabsAnnotation").tabs("option","selected");a.refreshAnnotationsTabsFunc[c].refresh.call()}},refreshAnnotations:function(a,b){new AnnotationCollection({image:this.model.id,term:a}).fetch({success:function(e,d){b.empty();var c=new AnnotationView({page:undefined,model:e,el:b}).render()}})},addTermToTab:function(a,c,b){$("#annotationsPanel"+this.model.id).find(".ultabsannotation").append(_.template(a,b));$("#annotationsPanel"+this.model.id).find(".listtabannotation").append(_.template(c,b))},initAnnotations:function(){var a=this;new AnnotationCollection({image:a.model.id}).fetch({success:function(c,b){a.refreshAnnotations(undefined,$("#tabsterm-"+a.model.id+"-all"))}})},doLayout:function(b){var a=this;var d=$("#annotationsPanel"+a.model.get("id"));var c=parseInt($(window).width());d.html(_.template(b,{id:a.model.get("id")}));new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(f,e){a.createTabs(f.get("ontology"))}});d.css("padding","0px");d.css("margin","0px");d.css("width","16px");d.css("height","16px");d.css("bottom","0px");d.find("div.panel_button").click(function(){c=parseInt($(window).width());d.find("div.panel_button").toggle();d.css("bottom","0px");d.animate({height:"302px"},"fast").animate({width:c},"fast").find("div.panel_content").fadeIn();return false});d.find("div#refresh_annotations_button").click(function(){var f=d.find(".tabsAnnotation").tabs("option","selected");var e=_.detect(a.refreshAnnotationsTabsFunc,function(g){return(g.index==f)});e.refresh.call()});d.find("div#hide_button").click(function(){d.animate({height:"16px"},"fast").animate({width:"16px"},"fast");setTimeout(function(){d.find("div.panel_content").hide();d.css("bottom","0px")},1000);return false});d.find("div.previous_button").click(function(){alert("prev"+a.currentAnnotation)});d.find("div.next_button").click(function(){alert("next"+a.currentAnnotation)});return this}});var LayerSwitcherPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.browseImageView=a.browseImageView;this.followInterval=null;this.userFollowed=null;this.vectorLayers=[]},render:function(){var a=this;require(["text!application/templates/explorer/LayerSwitcher.tpl.html"],function(b){a.doLayout(b)});return this},addBaseLayer:function(e,c){var b=this;var f="layerSwitch-"+c.get("id");var a="layerSwitch-"+c.get("id")+"-"+new Date().getTime();var d=_.template("<li><input type='radio' id='<%=   id %>' name='<%=   radioName %>' checked/><span style='color : #ffffff;'> <%=   name %></span></li>",{id:a,radioName:f,name:e.name.substr(0,15)});$("#layerSwitcher"+this.model.get("id")).find(".baseLayers").append(d);$("#layerSwitcher"+this.model.get("id")).find(".baseLayers").find("#"+a);$("#"+a).change(function(){b.browseImageView.map.setBaseLayer(e)})},addVectorLayer:function(f,e,d){var a=window.app.models.users.get(d).prettyName();this.vectorLayers.push({id:d,vectorsLayer:f.vectorsLayer});var a="layerSwitch-"+e.get("id")+"-"+d+"-"+new Date().getTime();var c=window.app.models.users.get(d).get("color");var b;if(f.isOwner){b=_.template("<li><input id='<%=   id %>' type='checkbox'  value='<%= name %>' checked />&nbsp;&nbsp;<input type='checkbox' disabled/><span style='color : #ffffff;'> <%=   name %></span></li>",{id:a,name:f.vectorsLayer.name,color:c})}else{b=_.template("<li data-id='<%= userID %>'><input id='<%= id %>' type='checkbox' value='<%= name %>' />&nbsp;&nbsp;<input type='checkbox' class='followUser' data-user-id='<%= userID %>' disabled/>&nbsp;<span style='color : #ffffff;'><%= name %></span></a> </li>",{userID:d,id:a,name:f.vectorsLayer.name,color:c})}$("#layerSwitcher"+e.get("id")).find("ul.annotationLayers").append(b);$("#"+a).click(function(){var g=$(this).attr("checked");f.vectorsLayer.setVisibility(g)})},updateOnlineUsers:function(d){var c=this;var a=$("#layerSwitcher"+this.model.get("id")).find("ul.annotationLayers");var e=window.app.status.currentProjectModel;var b=window.app.models.users.select(function(f){return _.include(e.get("users"),f.id)});b=_.pluck(b,"id");if(!_.include(d,c.userFollowed)){a.find("li[data-id="+c.userFollowed+"]").find("input.followUser").removeAttr("checked");c.stopFollowing()}_.each(b,function(f){if(!_.include(d,f)){a.find("li[data-id="+f+"]").find("span").css("color","white");a.find("li[data-id="+f+"]").find("input.followUser").attr("disabled","disabled")}});_.each(d,function(f){a.find("li[data-id="+f+"]").find("span").css("color","#46a546");a.find("li[data-id="+f+"]").find("input.followUser").removeAttr("disabled")})},startFollowing:function(){var a=this;window.app.view.message("","Start following "+window.app.models.users.get(a.userFollowed).prettyName(),"success");var b=this.model.get("id");this.followInterval=setInterval(function(){new UserPositionModel({image:b,user:a.userFollowed}).fetch({success:function(d,c){a.browseImageView.map.moveTo(new OpenLayers.LonLat(d.get("longitude"),d.get("latitude")),d.get("zoom"));var e=_.detect(a.vectorLayers,function(f){return f.id==a.userFollowed});if(e){e.vectorsLayer.refresh()}},error:function(d,c){}})},1000)},stopFollowing:function(){var a=this;if(a.followInterval!=undefined){window.app.view.message("","Stop following "+window.app.models.users.get(a.userFollowed).prettyName(),"success");clearInterval(a.followInterval);a.followInterval=null;a.userFollowed=null}},doLayout:function(b){var a=this;var c=_.template(b,{id:a.model.get("id"),isDesktop:!window.app.view.isMobile});$("#layerSwitcher"+a.model.get("id")).html(c);$("#layerSwitcher"+a.model.get("id")).find(".toggleShowBaseLayers").click(function(){$("#layerSwitcher"+a.model.get("id")).find("ul.baseLayers").toggle(150);return false});$("#layerSwitcher"+a.model.get("id")).find(".toggleShowVectorLayers").click(function(){$("#layerSwitcher"+a.model.get("id")).find("ul.annotationLayers").toggle(150);return false});$("#layerSwitcher"+a.model.get("id")).find(".followUser").live("click",function(g){var f=$(this).attr("checked")=="checked";$("#layerSwitcher"+a.model.get("id")).find(".followUser:checked").each(function(){$(this).attr("checked",false)});$(this).attr("checked",f);a.stopFollowing();if(!f){return}var d=$(this).attr("data-user-id");a.userFollowed=d;a.startFollowing()});new DraggablePanelView({el:$("#layerSwitcher"+a.model.get("id")),className:"layerSwitcherPanel"}).render()}});var ImageFiltersPanel=Backbone.View.extend({tagName:"div",filter:null,enabled:false,parameters:[],browseImageView:null,initialize:function(a){this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/ImageFiltersPanel.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=$("#imageFiltersPanel"+this.model.get("id"));this.model.set({isDesktop:!window.app.view.isMobile});new DraggablePanelView({el:c,className:"imageFiltersPanel",template:_.template(b,this.model.toJSON())}).render();c.find("#contrast"+this.model.get("id")).slider({min:0,max:256,value:128,change:function(d,e){a.redraw()}});c.find("#brightness"+this.model.get("id")).slider({min:0,max:256,value:128,change:function(d,e){a.redraw()}});c.find("input[name=invert]").change(function(){a.redraw()});c.find("input[name=filterActive]").change(function(){a.enabled=($(this).attr("checked")=="checked");a.redraw()});c.find("a[name=reset]").click(function(){c.find("#brightness"+a.model.get("id")).slider("option","value",128);c.find("#contrast"+a.model.get("id")).slider("option","value",128);c.find("input[name=invert]").removeAttr("checked");return false})},updateGetURL:function(){var a=this;var b=function(c){c=this.adjustBounds(c);var f=this.map.getResolution();var i=Math.round((c.left-this.tileOrigin.lon)/(f*this.tileSize.w));var h=Math.round((this.tileOrigin.lat-c.top)/(f*this.tileSize.h));var g=this.map.getZoom();var e=i+h*this.tierSizeInTiles[g].w+this.tileCountUpToTier[g];var l="TileGroup"+Math.floor((e)/256)+"/"+g+"-"+i+"-"+h+".jpg";var d=this.url;var k=_.map(d,function(n){var o="";_.each(a.parameters,function(p){o+=p.key;o+="=";o+=p.value;o+="&"});var m=n.indexOf("method=");if(m==-1){n="vision/process?method=none&url="+n;m=n.indexOf("method=")}return n.substring(0,m)+o+n.substring(m,n.length)});if(OpenLayers.Util.isArray(k)){d=this.selectUrl(l,k)}return d+l};a.browseImageView.map.baseLayer.getURL=b;a.browseImageView.map.baseLayer.redraw()},redraw:function(){if(!this.enabled){this.parameters=[];this.updateGetURL();return}var b=$("#imageFiltersPanel"+this.model.get("id"));var c=parseInt(b.find("#brightness"+this.model.get("id")).slider("value"));var a=parseInt(b.find("#contrast"+this.model.get("id")).slider("value"));var d=(b.find("input[name=invert]").attr("checked")=="checked");this.parameters=[];this.parameters.push({key:"brightness",value:c});this.parameters.push({key:"contrast",value:a});if(d){this.parameters.push({key:"invert",value:true})}this.updateGetURL()}});var OverviewMapPanel=Backbone.View.extend({tagName:"div",initialize:function(a){},render:function(){var a=this;require(["text!application/templates/explorer/OverviewMap.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;new DraggablePanelView({el:$("#overviewMap"+a.model.get("id")),className:"overviewPanel",template:_.template(b,{id:a.model.get("id"),isDesktop:!window.app.view.isMobile})}).render()}});var OntologyPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.ontologyTreeView=null;this.callback=a.callback;this.browseImageView=a.browseImageView},render:function(){var a=this;new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(d,c){var b=d.get("ontology");var e=new OntologyModel({id:b}).fetch({success:function(g,f){a.ontologyTreeView=new OntologyTreeView({el:$("#ontologyTree"+a.model.get("id")),browseImageView:a.browseImageView,model:g}).render();a.callback(a.ontologyTreeView)}});require(["text!application/templates/explorer/OntologyTree.tpl.html"],function(f){a.doLayout(f)})}});return this},doLayout:function(a){new DraggablePanelView({el:$("#ontologyTree"+this.model.get("id")),className:"ontologyPanel",template:_.template(a,{id:this.model.get("id")})}).render()}});var UploadFormView=Backbone.View.extend({statusLabels:{uploadedLabel:'<span class="label label-inverse">UPLOADED</span>',errorFormatLabel:'<span class="label label-important">ERROR FORMAT</span>',convertedLabel:'<span class="label label-info">CONVERTED</span>',deployedLabel:'<span class="label label-success">DEPLOYED</span>'},fileUploadErrors:{maxFileSize:"File is too big",minFileSize:"File is too small",acceptFileTypes:"Filetype not allowed",maxNumberOfFiles:"Max number of files exceeded",uploadedBytes:"Uploaded bytes exceed file size",emptyResult:"Empty file upload result"},initialize:function(a){this.uploadDataTables=null},events:{},render:function(){var a=this;require(["text!application/templates/upload/UploadForm.tpl.html"],function(b){a.doLayout(b)});return this},defineFileUpload:function(a,c){var b=this;$.widget("cytomine.fileupload",$.blueimp.fileupload,{options:{autoUpload:false,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:1,acceptFileTypes:/.+$/i,previewFileTypes:/^image\/(gif|jpeg|png)$/,previewMaxFileSize:5000000,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:true,dataType:"json",add:function(h,g){var f=$(this).data("fileupload"),d=g.files;f._adjustMaxNumberOfFiles(-d.length);g.isAdjusted=true;g.files.valid=g.isValidated=f._validate(d);g.context=f._renderUpload(d).appendTo(f._files).data("data",g);f._reflow=f._transition&&g.context[0].offsetWidth;g.context.addClass("in");if((f.options.autoUpload||g.autoUpload)&&g.isValidated){g.submit()}},send:function(g,f){if(!f.isValidated){var d=$(this).data("fileupload");if(!f.isAdjusted){d._adjustMaxNumberOfFiles(-f.files.length)}if(!d._validate(f.files)){return false}}if(f.context&&f.dataType&&f.dataType.substr(0,6)==="iframe"){f.context.find(".progressbar div").css("width",parseInt(100,10)+"%")}},done:function(i,g){var f=$(this).data("fileupload"),d,h;if(g.context){g.context.each(function(e){var k=($.isArray(g.result)&&g.result[e])||{error:"emptyResult"};if(k.error){f._adjustMaxNumberOfFiles(1)}f._transitionCallback($(this).removeClass("in"),function(l){d=f._renderDownload([k]);h=l.find(".preview img, .preview canvas");if(h.length){d.find(".preview img").prop("width",h.prop("width")).prop("height",h.prop("height"))}d.replaceAll(l);f._reflow=f._transition&&d[0].offsetWidth;d.addClass("in")})})}else{d=f._renderDownload(g.result).appendTo(f._files);f._reflow=f._transition&&d[0].offsetWidth;d.addClass("in")}},fail:function(h,g){var f=$(this).data("fileupload"),d;f._adjustMaxNumberOfFiles(g.files.length);if(g.context){g.context.each(function(e){if(g.errorThrown!=="abort"){var i=g.files[e];i.error=i.error||g.errorThrown||true;f._transitionCallback($(this).removeClass("in"),function(k){d=f._renderDownload([i]).replaceAll(k);f._reflow=f._transition&&d[0].offsetWidth;d.addClass("in")})}else{f._transitionCallback($(this).removeClass("in"),function(k){k.remove()})}})}else{if(g.errorThrown!=="abort"){f._adjustMaxNumberOfFiles(-g.files.length);g.context=f._renderUpload(g.files).appendTo(f._files).data("data",g);f._reflow=f._transition&&g.context[0].offsetWidth;g.context.addClass("in")}}},progress:function(f,d){if(d.context){d.context.find(".progressbar div").css("width",parseInt(d.loaded/d.total*100,10)+"%")}},progressall:function(f,d){$(this).find(".fileupload-progressbar div").css("width",parseInt(d.loaded/d.total*100,10)+"%")},start:function(){$(this).find(".fileupload-progressbar").addClass("in").find("div").css("width","0%")},stop:function(){$(this).find(".fileupload-progressbar").removeClass("in").find("div").css("width","0%")},destroy:function(g,f){var d=$(this).data("fileupload");if(f.url){$.ajax(f)}d._adjustMaxNumberOfFiles(1);d._transitionCallback(f.context.removeClass("in"),function(e){e.remove()})}},_enableDragToDesktop:function(){var g=$(this),e=g.prop("href"),d=decodeURIComponent(e.split("/").pop()).replace(/:/g,"-"),f="application/octet-stream";g.bind("dragstart",function(i){try{i.originalEvent.dataTransfer.setData("DownloadURL",[f,d,e].join(":"))}catch(h){}})},_adjustMaxNumberOfFiles:function(d){if(typeof this.options.maxNumberOfFiles==="number"){this.options.maxNumberOfFiles+=d;if(this.options.maxNumberOfFiles<1){this._disableFileInputButton()}else{this._enableFileInputButton()}}},_formatFileSize:function(d){if(typeof d!=="number"){return""}if(d>=1000000000){return(d/1000000000).toFixed(2)+" GB"}if(d>=1000000){return(d/1000000).toFixed(2)+" MB"}return(d/1000).toFixed(2)+" KB"},_hasError:function(d){if(d.error){return d.error}if(this.options.maxNumberOfFiles<0){return"maxNumberOfFiles"}if(!(this.options.acceptFileTypes.test(d.type)||this.options.acceptFileTypes.test(d.name))){return"acceptFileTypes"}if(this.options.maxFileSize&&d.size>this.options.maxFileSize){return"maxFileSize"}if(typeof d.size==="number"&&d.size<this.options.minFileSize){return"minFileSize"}return null},_validate:function(f){var e=this,d=!!f.length;$.each(f,function(g,h){h.error=e._hasError(h);if(h.error){d=false}});return d},_renderTemplate:function(e,f){var d=_.template(e,{o:{files:f,formatFileSize:this._formatFileSize,options:this.options,fileUploadErrors:b.fileUploadErrors}});return $(this.options.templateContainer).html(d).children()},_renderUpload:function(g){var f=this,e=this.options,d=this._renderTemplate(e.uploadTemplate,g);d.find(".preview span").each(function(h,k){var i=g[h];if(false&&e.previewFileTypes.test(i.type)&&(!e.previewMaxFileSize||i.size<e.previewMaxFileSize)){window.loadImage(g[h],function(l){$(k).append(l);f._reflow=f._transition&&k.offsetWidth;$(k).addClass("in")},{maxWidth:e.previewMaxWidth,maxHeight:e.previewMaxHeight,canvas:e.previewAsCanvas})}});return d},_renderDownload:function(e){var d=this._renderTemplate(this.options.downloadTemplate,e);d.find("a").each(this._enableDragToDesktop);return d},_startHandler:function(h){h.preventDefault();var f=$(this),d=f.closest(".template-upload"),g=d.data("data");if(g&&g.submit&&!g.jqXHR&&g.submit()){f.prop("disabled",true)}},_cancelHandler:function(g){g.preventDefault();var d=$(this).closest(".template-upload"),f=d.data("data")||{};if(!f.jqXHR){f.errorThrown="abort";g.data.fileupload._trigger("fail",g,f)}else{f.jqXHR.abort()}},_deleteHandler:function(f){f.preventDefault();var d=$(this);f.data.fileupload._trigger("destroy",f,{context:d.closest(".template-download"),url:d.attr("data-url"),type:d.attr("data-type"),dataType:f.data.fileupload.options.dataType})},_transitionCallback:function(e,f){var d=this;if(this._transition&&e.hasClass("fade")){e.bind(this._transitionEnd,function(g){if(g.target===e[0]){e.unbind(d._transitionEnd);f.call(d,e)}})}else{f.call(this,e)}},_initTransitionSupport:function(){var e=this,d=(document.body||document.documentElement).style,f="."+e.options.namespace;e._transition=d.transition!==undefined||d.WebkitTransition!==undefined||d.MozTransition!==undefined||d.MsTransition!==undefined||d.OTransition!==undefined;if(e._transition){e._transitionEnd=["MSTransitionEnd","webkitTransitionEnd","transitionend","oTransitionEnd"].join(f+" ")+f}},_initButtonBarEventHandlers:function(){var e=$(".fileupload-buttonbar"),f=this._files,d=this.options.namespace;e.find(".start").bind("click."+d,function(g){g.preventDefault();f.find(".start button").click()});e.find(".cancel").bind("click."+d,function(g){g.preventDefault();f.find(".cancel button").click()});e.find(".delete").bind("click."+d,function(g){g.preventDefault();f.find(".delete input:checked").siblings("button").click()});e.find(".toggle").bind("change."+d,function(g){f.find(".delete input").prop("checked",$(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace);this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){$.blueimp.fileupload.prototype._initEventHandlers.call(this);var d={fileupload:this};this._files.delegate(".start button","click."+this.options.namespace,d,this._startHandler).delegate(".cancel button","click."+this.options.namespace,d,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,d,this._deleteHandler);this._initButtonBarEventHandlers();this._initTransitionSupport()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers();this._files.undelegate(".start button","click."+this.options.namespace).undelegate(".cancel button","click."+this.options.namespace).undelegate(".delete button","click."+this.options.namespace);$.blueimp.fileupload.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",false).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",true).parent().addClass("disabled")},_initTemplates:function(){this.options.templateContainer=document.createElement(this._files.prop("nodeName"));this.options.uploadTemplate=a;this.options.downloadTemplate=c},_initFiles:function(){this._files=this.element.find(".files-list")},_create:function(){this._initFiles();$.blueimp.fileupload.prototype._create.call(this);this._initTemplates()},destroy:function(){$.blueimp.fileupload.prototype.destroy.call(this)},enable:function(){$.blueimp.fileupload.prototype.enable.call(this);this.element.find("input, button").prop("disabled",false);this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",true);this._disableFileInputButton();$.blueimp.fileupload.prototype.disable.call(this)}})},getStatusLabel:function(a){if(a.uploaded){return this.statusLabels.uploadedLabel}else{if(a.converted){return this.statusLabels.convertedLabel}else{if(a.deployed){return this.statusLabels.deployedLabel}else{if(a.error){return this.statusLabels.errorFormatLabel}}}}return"?"},appendUploadedFile:function(a,b){var c="<tr><td><%= originalFilename %></td><td><%= created %></td><td><%= size %></td><td><%= contentType %></td><td><%= status %></td></tr>";a.set({status:this.getStatusLabel(a)});b.append(_.template(c,a.toJSON()))},injectFnReloadAjax:function(){$.fn.dataTableExt.oApi.fnReloadAjax=function(f,d,g,c){if(typeof d!="undefined"&&d!=null){f.sAjaxSource=d}this.oApi._fnProcessingDisplay(f,true);var e=this;var a=f._iDisplayStart;var b=[];this.oApi._fnServerParams(f,b);f.fnServerData(f.sAjaxSource,b,function(l){e.oApi._fnClearTable(f);var h=(f.sAjaxDataProp!=="")?e.oApi._fnGetObjectDataFn(f.sAjaxDataProp)(l):l;for(var k=0;k<h.length;k++){e.oApi._fnAddData(f,h[k])}f.aiDisplay=f.aiDisplayMaster.slice();e.fnDraw();if(typeof c!="undefined"&&c===true){f._iDisplayStart=a;e.fnDraw(false)}e.oApi._fnProcessingDisplay(f,false);if(typeof g=="function"&&g!=null){g(f)}},f)}},renderUploadedFiles:function(){var a=this;var c=$("#uploaded_files");var d=$("#loadingUploadedFiles");var b=new UploadedFileCollection({dataTables:true}).url();c.hide();d.show();this.injectFnReloadAjax();a.uploadDataTables=c.dataTable({sDom:"<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:25,bDestroy:true,bProcessing:true,aoColumns:[{mDataProp:"filename"},{mDataProp:"created"},{mDataProp:"size"},{mDataProp:"contentType"},{mDataProp:"uploaded"}],aoColumnDefs:[{fnRender:function(f,e){return a.getStatusLabel(f.aData)},aTargets:[4]}],sAjaxSource:b});c.show();d.hide();$("#refreshUploadedFiles").live("click",function(f){f.preventDefault();a.uploadDataTables.fnReloadAjax()})},doLayout:function(c){var a=this;$(this.el).html(c);var b=$("#linkProjectSelect");var d=$("#linkWithProject");b.attr("disabled","disabled");d.removeAttr("checked");d.off("change");d.on("change",function(e){if($(this).attr("checked")=="checked"){b.removeAttr("disabled")}else{b.attr("disabled","disabled")}});new ProjectCollection().fetch({success:function(g,f){var e="<option value='<%= id %>'><%= name %></option>";g.each(function(i){var h=_.template(e,i.toJSON());b.append(h)})}});this.renderUploadedFiles();require(["text!application/templates/upload/upload.tpl.html","text!application/templates/upload/download.tpl.html"],function(f,g){a.defineFileUpload(f,g);$("#fileupload").fileupload({limitConcurrentUploads:10,maxFileSize:5000000000});var e=window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s");$("#fileupload").bind("fileuploadsubmit",function(m,k){var h=$("#linkProjectSelect");var i=$("#linkWithProject");var l=null;if(i.attr("checked")=="checked"){l=h.val()}k.formData={idProject:l};return true});$("#fileupload").bind("fileuploadsend",function(k,h){if(h.dataType.substr(0,6)==="iframe"){var i=$("<a/>").prop("href",h.url)[0];if(window.location.host!==i.host){h.formData.push({name:"redirect",value:e})}}});$("#fileupload .files").delegate("a:not([rel^=gallery])","click",function(h){h.preventDefault();$('<iframe style="display:none;"></iframe>').prop("src",this.href).appendTo(document.body)})})}});var ImageThumbView=Backbone.View.extend({className:"thumb-wrap",events:{},initialize:function(a){this.id="thumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){this.model.set({project:window.app.status.currentProject});var a=this;require(["text!application/templates/image/ImageThumb.tpl.html"],function(c){var b=a.model.toJSON();b.title=(b.filename.length<27)?b.filename:b.filename.substr(0,24)+"...";b.resolution=Math.round(1000*b.resolution)/1000;$(a.el).html(_.template(c,b));$(a.el).find("#getImageProperties-"+a.model.id).click(function(){$("#image-properties").remove();new ImagePropertiesView({model:a.model}).render();return false})});return this}});var ImageSelectView=Backbone.View.extend({events:{},initialize:function(a){this.id="thumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){var a=this;this.model.set({project:window.app.status.currentProject});var a=this;require(["text!application/templates/image/ImageChoice.tpl.html"],function(b){$(a.el).html(_.template(b,a.model.toJSON()))});return this}});var ImageView=Backbone.View.extend({tagName:"div",initialize:function(a){this.images=null;this.container=a.container;this.page=a.page;this.nb_thumb_by_page=30;this.appendingThumbs=false;if(this.page==undefined){this.page=0}},render:function(){var a=this;$(a.el).empty();a.appendThumbs(a.page);$(window).scroll(function(){var b=""+window.location;if(b.search("#tabs-images-")==-1){return}if(a.appendingThumbs){return}if(($(window).scrollTop()+50)>=$(document).height()-$(window).height()){a.appendThumbs(++a.page)}});return this},showLoading:function(){window.app.view.message("Loading...","","info")},appendThumbs:function(d){var b=this;b.appendingThumbs=true;var c=Math.abs(d)*this.nb_thumb_by_page;var a=(Math.abs(d)+1)*this.nb_thumb_by_page;if(Math.abs(d)*this.nb_thumb_by_page<b.model.size()){this.showLoading()}b.tabsContent=[];b.model=new ImageInstanceCollection({project:window.app.status.currentProject,inf:c,sup:a});b.model.fetch({success:function(i,f){var h=0;while(h<(a-c)&&h<i.size()){var g=i.at(h);var e=new ImageThumbView({model:g}).render();$(b.el).append(e.el);h++;b.tabsContent.push(g.id)}b.appendingThumbs=false}})},add:function(c){var b=this;var a=new ImageThumbView({model:c,className:"row",id:"thumb"+c.get("id")}).render();$(b.el).append(a.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(a){return;var b=this;var c=b.tabsContent;a.each(function(d){if(_.indexOf(b.tabsContent,d.id)==-1){b.add(d);b.tabsContent.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){b.remove(d);b.tabsContent=_.without(b.tabsContent,d)})}});var ImageTabsView=Backbone.View.extend({tagName:"div",images:null,idProject:null,searchPanel:null,initialize:function(a){this.idProject=a.idProject;this.container=a.container;this.listproject="listimage"+this.idProject;this.pageproject="pagerimage"+this.idProject;this.tab=2;this.timeoutHnd=null},render:function(){var a=this;a.model.fetch({success:function(c,b){a.renderImageTable()}})},refresh:function(){},renderImageTable:function(){var a=this;a.model.fetch({success:function(f,b){var c=$("#projectImageTable"+a.idProject).find("tbody");var g="<a href='#tabs-image-<%= project %>-<%= image %>-' class='btn btn-primary' style='color : #FFF'';><i class='icon-eye-open icon-white'></i> Explore</a>";var d="<img src='<%= thumb %>' alt='<%= filename %>' style='max-height: 75px;'/>";var e="<tr><td><%= thumImg %></td><td><%= filename %></td><td><%= mime %></td><td><%= width %></td><td><%= height %></td><td><%= magnification %></td><td><%= resolution %></td><td><%= numberOfAnnotations %></td><td><%= created %></td><td><%= action %></td></tr>";f.each(function(i){var k=_.template(g,{project:a.idProject,image:i.get("id")});var h=_.template(d,{thumb:i.get("thumb"),filename:i.get("filename")});i.set({action:k});i.set({thumImg:h});i.set({created:window.app.convertLongToDate(i.get("created"))});c.append(_.template(e,i.toJSON()))});$("#projectImageTable"+a.idProject).dataTable({sDom:"<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"}});$("#projectImageListing"+a.idProject).hide();$("#projectImageTable"+a.idProject).show()}})}});var ImagePropertiesView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(b){var a=this;this.dialog=new ConfirmDialogView({el:"#dialogs",template:_.template(b,this.model.toJSON()),dialogAttr:{dialogID:"#image-properties"}}).render();$("#closeImagePropertiesDialog").click(function(){a.dialog.close();return false});return this},render:function(){var a=this;require(["text!application/templates/image/ImageProperties.tpl.html"],function(b){a.doLayout(b);a.printProperties()});return this},printProperties:function(){var a=this;require(["text!application/templates/image/ImageProperty.tpl.html"],function(b){new ImagePropertyCollection({image:a.model.get("baseImage")}).fetch({success:function(e,c){var d=$("#image-properties-content");$("#image-properties-content").empty();e.each(function(f){var g=_.template(b,{key:f.get("key"),value:f.get("value")});d.append(g)});$("#image-properties").dialog("open")}})})}});var OntologyPanelView=Backbone.View.extend({$tree:null,$infoOntology:null,$infoTerm:null,$panel:null,$addTerm:null,$editTerm:null,$deleteTerm:null,ontologiesPanel:null,initialize:function(a){this.container=a.container;this.ontologiesPanel=a.ontologiesPanel},render:function(){var a=this;a.$panel=$(".ontology"+a.model.id);a.$tree=a.$panel.find("#treeontology-"+a.model.id);a.$infoOntology=a.$panel.find("#infoontology-"+a.model.id);a.$infoTerm=a.$panel.find("#infoterm-"+a.model.id);a.$addTerm=a.$panel.find("#dialog-add-ontology-term");a.$editTerm=a.$panel.find("#dialog-edit-ontology-term");a.$deleteTerm=a.$panel.find("#dialogsTerm");a.buildOntologyTree();a.buildInfoOntologyPanel();a.initEvents();return this},initEvents:function(){var a=this;$("#buttonAddTerm"+this.model.id).live("click",function(){a.addTerm()});$("#buttonEditTerm"+this.model.id).live("click",function(){a.editTerm()});$("#buttonDeleteTerm"+this.model.id).live("click",function(){a.deleteTerm()});$("#buttonEditOntology"+this.model.id).live("click",function(){a.editOntology()});$("#buttonDeleteOntology"+this.model.id).live("click",function(){a.deleteOntology()})},refresh:function(){var a=this;var b=0;var c=function(){b++;if(b<2){return}a.clear();a.render()};window.app.models.terms.fetch({success:function(e,d){c()}});a.model.fetch({success:function(e,d){c()}})},clear:function(){var a=this;a.$panel.empty();require(["text!application/templates/ontology/OntologyTabContent.tpl.html"],function(b){a.$panel.replaceWith(_.template(b,{id:a.model.get("id"),name:a.model.get("name")}));return this});return this},getCurrentTermId:function(){var a=this.$tree.dynatree("getActiveNode");if(a==null){return null}else{return a.data.id}},addTerm:function(){var a=this;a.$addTerm.remove();new OntologyAddOrEditTermView({ontologyPanel:a,el:a.el,ontology:a.model,model:null}).render()},editTerm:function(){var a=this;a.$editTerm.remove();var b=a.$tree.dynatree("getActiveNode");if(b==null){window.app.view.message("Term","You have to select a term first","error");return}new TermModel({id:b.data.id}).fetch({success:function(d,c){new OntologyAddOrEditTermView({ontologyPanel:a,el:a.el,model:d,ontology:a.model}).render()}});return false},deleteTerm:function(){var a=this;var b=a.getCurrentTermId();var c=window.app.models.terms.get(b);new AnnotationCollection({term:b}).fetch({success:function(e,d){if(e.length==0){a.buildDeleteTermConfirmDialog(c)}else{a.buildDeleteTermWithAnnotationConfirmDialog(c,e.length)}}})},editOntology:function(){var a=this;$("#editontology").remove();a.editOntologyDialog=new EditOntologyDialog({ontologyPanel:a,el:a.el,model:a.model}).render()},deleteOntology:function(){var a=this;new ProjectCollection({ontology:a.model.id}).fetch({success:function(c,b){if(c.length>0){a.refuseDeleteOntology(c.length)}else{a.acceptDeleteOntology()}}})},refuseDeleteOntology:function(b){var a=this;require(["text!application/templates/ontology/OntologyDeleteRefuseDialog.tpl.html"],function(c){var d=new ConfirmDialogView({el:"#dialogsDeleteOntologyRefuse",template:_.template(c,{name:a.model.get("name"),numberOfProject:b}),dialogAttr:{backdrop:false,dialogID:"#delete-ontology-refuse"}}).render();$("#deleteRefuseOntologyButton").click(function(){$("#delete-ontology-refuse").modal("hide");$("#delete-ontology-refuse").remove();return false})})},acceptDeleteOntology:function(){var a=this;require(["text!application/templates/ontology/OntologyDeleteConfirmDialog.tpl.html"],function(b){new ConfirmDialogView({el:"#dialogsDeleteOntologyAccept",template:_.template(b,{ontology:a.model.get("name")}),dialogAttr:{backdrop:false,dialogID:"#delete-ontology-confirm"}}).render();$("#deleteOntologyButton").click(function(){a.model.destroy({success:function(d,c){a.ontologiesPanel.refresh();$("#delete-ontology-confirm").modal("hide");$("#delete-ontology-confirm").remove()},error:function(d,c){var e=$.parseJSON(c.responseText)}});return false});$("#closeDeleteOntologyDialog").click(function(){$("#delete-ontology-confirm").modal("hide");$("#delete-ontology-confirm").modal("remove");return false})})},selectTerm:function(b){var a=this;a.$tree.dynatree("getTree").activateKey(b)},buildDeleteTermConfirmDialog:function(b){var a=this;require(["text!application/templates/ontology/OntologyDeleteTermConfirmDialog.tpl.html"],function(c){var d=new ConfirmDialogView({el:"#dialogsTerm",template:_.template(c,{term:b.get("name"),ontology:a.model.get("name")}),dialogAttr:{backdrop:false,dialogID:"#delete-term-confirm"}}).render();$("#closeDeleteTermDialog").click(function(){$("#delete-term-confirm").modal("hide");$("#delete-term-confirm").remove();return false});$("#deleteTermButton").click(function(){a.removeTerm(b,"#delete-term-confirm");return false})})},buildDeleteTermWithAnnotationConfirmDialog:function(b,c){var a=this;require(["text!application/templates/ontology/OntologyDeleteTermWithAnnotationConfirmDialog.tpl.html"],function(d){var e=new ConfirmDialogView({el:"#dialogsTerm",template:_.template(d,{term:b.get("name"),ontology:a.model.get("name"),numberOfAnnotation:c}),dialogAttr:{backdrop:false,dialogID:"#delete-term-with-annotation-confirm",close:function(f){}}}).render();$("#closeDeleteTermDialog").click(function(){$("#delete-term-with-annotation-confirm").modal("hide");$("#delete-term-with-annotation-confirm").remove();return false});$("#deleteTermButton").click(function(){a.removeTerm(b,"#delete-term-with-annotation-confirm");return false})})},removeTerm:function(b,c){var a=this;new TermModel({id:b.id}).destroy({success:function(e,d){window.app.view.message("Term",d.message,"success");a.refresh();$(c).modal("hide");$(c).remove()},error:function(e,d){var f=$.parseJSON(d.responseText);$("#delete-term-error-message").empty();$("#delete-term-error-label").show();$("#delete-term-error-message").append(f.errors)}})},buildInfoOntologyPanel:function(){var b=this;b.$infoOntology.empty();var e=b.model.get("user");var a=window.app.models.users.get(e);var f="Nobody";var h=b.model.get("users");if(_.size(h)>0){var g=[];_.each(h,function(i){if(i==e){return}g.push(window.app.models.users.get(i).prettyName())});f=g.join(", ")}var d=_.template("<div id='userontologyinfo-<%= id %>' style='padding:5px;'><ul><li><b>Ontology</b> : <%= ontologyName %></li><li><b>Owner</b> : <%= owner %></li><li><b>Shared to</b> : <%= sharedTo %></li><li class='projectsLinked'></li></ul></div>",{id:b.model.id,ontologyName:b.model.get("name"),owner:a.prettyName(),sharedTo:f});b.$infoOntology.html(d);var c=[];_.each(b.model.get("projects"),function(k){var i=_.template("<a href='#tabs-dashboard-<%=   idProject %>'><%=   projectName %></a>",{idProject:k.id,projectName:k.name});c.push(i)});var d=_.template("<b>Projects</b> : <%=   projects %>",{projects:c.join(", ")});b.$infoOntology.find(".projectsLinked").html(d)},buildOntologyTree:function(){var a=this;var b=new Date();a.$tree.empty();$("#treeontology-"+a.model.id).dynatree({children:a.model.toJSON(),onExpand:function(){},onClick:function(d,c){},onSelect:function(c,d){},onActivate:function(c){},onDblClick:function(d,c){},onRender:function(d,c){a.$tree.find("a.dynatree-title").css("color","black")},initId:"treeDataOntology-"+a.model.id+b.getTime(),cookieId:"dynatree-Ontology-"+a.model.id+b.getTime(),idPrefix:"dynatree-Ontology-"+a.model.id+b.getTime()+"-",debugLevel:0});a.colorizeOntologyTree();a.expandOntologyTree()},colorizeOntologyTree:function(){var a=this;$("#treeontology-"+a.model.id).dynatree("getRoot").visit(function(d){if(d.children!=null){return}var f=d.data.title;var c=d.data.color;var e="<a href='#ontology/<%=   idOntology %>/<%=   idTerm %>' onClick='window.location.href = this.href;'><%=   title %> <span style='background-color:<%= color %>'>&nbsp;&nbsp;&nbsp;&nbsp;</span></a>";var b=_.template(e,{idOntology:a.model.id,idTerm:d.data.id,title:f,color:c});d.setTitle(b)})},expandOntologyTree:function(){var a=this;$("#treeontology-"+a.model.id).dynatree("getRoot").visit(function(b){b.expand(true)})}});var OntologyView=Backbone.View.extend({tagName:"div",self:this,alreadyBuild:false,$tabsOntologies:null,ontologiesPanel:null,idOntology:null,addOntologyDialog:null,events:{"click .addOntology":"showAddOntologyPanel","click .refreshOntology":"refresh"},initialize:function(a){this.container=a.container;this.idOntology=a.idOntology;this.idTerm=a.idTerm},refresh:function(){var a=this;var b=0;var c=function(){b++;if(b==2){a.render()}};window.app.models.terms.fetch({success:function(e,d){c()}});window.app.models.ontologies.fetch({success:function(e,d){c()}})},refresh:function(b,c){var a=this;this.idOntology=b;this.idTerm=c;var d=0;var e=function(){d++;if(d==2){a.render()}};window.app.models.terms.fetch({success:function(g,f){e()}});window.app.models.ontologies.fetch({success:function(g,f){e()}})},select:function(b){var a=this;this.idOntology=b;a.render()},render:function(){var a=this;require(["text!application/templates/ontology/OntologyList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{}));a.$tabsOntologies=$(a.el).find("#ontology");a.initOntologyTabs();return this},showAddOntologyPanel:function(){var a=this;$("#addontology").remove();a.addOntologyDialog=new AddOntologyDialog({ontologiesPanel:a,el:a.el}).render()},select:function(c,e){var b=this;var a=0;var d=0;b.model.each(function(f){if(c==f.get("id")){a=d}d=d+1});if(e!=undefined){b.ontologiesPanel[a].selectTerm(e)}},initOntologyTabs:function(){var a=this;require(["text!application/templates/ontology/OntologyTab.tpl.html","text!application/templates/ontology/OntologyTabContent.tpl.html"],function(c,b){a.ontologiesPanel=new Array();a.model.each(function(f){var e=a.addOntologyToTab(c,b,{id:f.get("id"),name:f.get("name")});var d=new OntologyPanelView({model:f,el:e,container:a,ontologiesPanel:a});d.render();a.ontologiesPanel.push(d)});setTimeout(function(){$("#ontologyLoading").remove()},1500);if(!a.alreadyBuild){$("#ontology h3 a").click(function(){window.location=$(this).attr("href");return false})}})},addOntologyToTab:function(c,b,a){return this.$tabsOntologies.append(_.template(b,a))}});var OntologyAddOrEditTermView=Backbone.View.extend({ontologyPanel:null,ontologyDialog:null,ontology:null,$tree:null,$panel:null,$textboxName:null,$colorChooser:null,$inputOldColor:null,$inputNewColor:null,$errorMessage:null,$errorLabel:null,$addFolderButton:null,action:null,events:{"click .addFolder":"addFolder"},initialize:function(a){this.container=a.container;this.ontologyPanel=a.ontologyPanel;this.ontology=a.ontology;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyAddOrEditTermView.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;if(a.model==null){a.action="Add";a.createNewEmpty()}else{a.action="Edit"}a.$termDialog=$(a.el).find("#dialog-"+a.action+"-ontology-term");$("#dialog-Edit-ontology-term").replaceWith("");$("#dialog-Add-ontology-term").replaceWith("");var b=_.template(c,{oldColor:a.model.get("color"),action:a.action});$(a.el).append(b);a.$panel=$(a.el);a.$termDialog=$(a.el).find("#dialog-"+a.action+"-ontology-term");a.$tree=a.$panel.find("#"+a.action+"ontologytermtree");a.$from=a.$panel.find($("#form-"+a.action+"-ontology-term"));a.$textboxName=a.$panel.find("#"+a.action+"termname");a.$colorChooser=a.$panel.find("#colorpicker1AddOrEditTerm");a.$inputOldColor=a.$panel.find("#oldColorAddOrEditTerm");a.$inputNewColor=a.$panel.find("#color1AddOrEditTerm");a.$addFolderButton=a.$panel.find(".addFolder");a.$errorMessage=a.$panel.find("#"+a.action+"ontologytermerrormessage");a.$errorLabel=a.$panel.find("#"+a.action+"ontologytermerrorlabel");a.$from.submit(function(){if(a.action=="Edit"){a.updatedOntologyTerm()}else{a.createOntologyTerm()}return false});a.$from.find("input").keydown(function(d){if(d.keyCode==13){a.$from.submit();return false}});a.clearOntologyTermPanel();a.buildNameInfo();a.buildColorInfo();a.buildParentInfo();a.ontologyDialog=$(a.$termDialog).modal({keyboard:true,backdrop:false});$("#AddOrEditTermButton").click(function(){a.$from.submit();return false});$("#closeAddOrEditTermDialog").click(function(){a.$termDialog.modal("hide");a.$termDialog.remove();return false});a.open();return this},createNewEmpty:function(){var a=this;a.model=new TermModel({id:-1,name:"",color:"#ff0000"})},buildNameInfo:function(){var a=this;a.$textboxName.bind("keyup mouseup change click",function(g){var d=a.$tree.dynatree("getTree").getNodeByKey(a.model.id);var c="#119b04";var f="<span style='color:<%=   color %>'><%=   title %></span>";var b=_.template(f,{title:a.$textboxName.val(),color:c});if(d!=null){d.setTitle(b)}});a.$textboxName.val(a.model.get("name"))},buildColorInfo:function(){var c=this;var a=c.$colorChooser.farbtastic("#color1AddOrEditTerm");var b=c.model.get("color");c.$inputOldColor.val(b);c.$inputNewColor.val(b);c.$inputOldColor.css("background",b);c.$inputNewColor.css("background",b);c.$inputNewColor.css("color",c.$inputOldColor.css("color"))},addFolder:function(){},buildParentInfo:function(){var a=this;a.$addFolderButton.button({icons:{secondary:"ui-icon-folder-collapsed"}});a.$tree.empty();a.$tree.dynatree({children:a.ontology.toJSON(),onExpand:function(){},onRender:function(e,d){a.$tree.find("a.dynatree-title").css("color","black")},onClick:function(e,d){},onSelect:function(d,e){},onCustomRender:function(d){},onDblClick:function(e,d){},dnd:{onDragStart:function(d){if(d.data.key!=a.model.id){return false}return true},onDragStop:function(d){},autoExpandMS:1000,preventVoidMoves:true,onDragEnter:function(e,d){return true},onDragOver:function(f,e,d){},onDragLeave:function(e,d){},onDrop:function(g,f,e,h,d){if(e=="over"){f.move(g,e);g.data.isFolder=true;g.render()}else{f.move(g,e)}}},generateIds:true,initId:""+a.action+"treeDataOntology-"+a.model.id,cookieId:""+a.action+"dynatree-Ontology-"+a.model.id,idPrefix:""+a.action+"dynatree-Ontology-"+a.model.id+"-",debugLevel:0});if(a.action=="Add"){var c=a.$tree.dynatree("getTree").getNodeByKey(a.ontology.id);var b=c.addChild({title:"",key:-1,tooltip:"This folder and all child nodes were added programmatically.",isFolder:false})}a.$tree.dynatree("getRoot").visit(function(d){d.expand(true)});if(a.action=="Edit"){a.$textboxName.click()}},getNewName:function(){var a=this;return a.$textboxName.val()},getNewParent:function(){var a=this;var b=a.$tree.dynatree("getTree").getNodeByKey(a.model.id);return b.parent.data.id},getNewColor:function(){return this.$inputNewColor.val()},refresh:function(){},open:function(){var a=this;a.clearOntologyTermPanel()},clearOntologyTermPanel:function(){var a=this;a.$errorMessage.empty();a.$errorLabel.hide()},updatedOntologyTerm:function(){var c=this;c.$errorMessage.empty();c.$errorLabel.hide();var h=c.model.id;var e=c.getNewName();var g=c.model.get("parent");var f=c.getNewParent();var d=true;if(g!=null&&window.app.models.ontologies.get(g)==undefined){d=false}var a=true;if(window.app.models.ontologies.get(f)==undefined){a=false}var b=c.getNewColor();c.model.set({name:e,color:b});c.model.save({name:e,color:b},{success:function(k,i){if(f!=g){if(d&&a){c.close()}else{if(d){c.addRelation(h,f)}else{if(a){c.resetRelation(h,g,null)}else{c.resetRelation(h,g,f)}}}}else{c.close()}},error:function(k,i){var l=$.parseJSON(i.responseText);c.$errorLabel.show();c.$errorMessage.append(l.errors)}})},createOntologyTerm:function(){var c=this;c.$errorMessage.empty();c.$errorLabel.hide();var f=c.model.id;var d=c.getNewName();var a=true;var e=c.getNewParent();if(window.app.models.ontologies.get(e)==undefined){a=false}var b=c.getNewColor();c.model.set({name:d,color:b});c.model=new TermModel({name:d,color:b,ontology:c.ontology.id}).save({name:d,color:b,ontology:c.ontology.id},{success:function(h,g){if(a){window.app.view.message("Term",g.message,"success");c.close()}else{c.addRelation(g.term.id,e)}},error:function(h,g){var i=$.parseJSON(g.responseText);c.$errorLabel.show();c.$errorMessage.append(i.errors)}})},resetRelation:function(d,b,c){var a=this;new RelationTermModel({id:1,term1:b,term2:d}).destroy({success:function(f,e){if(c!=null){a.addRelation(d,c)}else{window.app.view.message("Term",e.message,"success");a.close()}},error:function(f,e){var g=$.parseJSON(e.responseText);a.$errorLabel.show();a.$errorMessage.append(g.errors)}})},addRelation:function(c,b){var a=this;new RelationTermModel({}).save({term1:b,term2:c},{success:function(e,d){window.app.view.message("Term",d.message,"success");a.close()},error:function(e,d){var f=$.parseJSON(d.responseText);a.$errorLabel.show();a.$errorMessage.append(f.errors)}})},close:function(){var a=this;this.ontologyPanel.refresh();a.$termDialog.modal("hide")}});var OntologyTreeView=Backbone.View.extend({tagName:"div",annotationTerm:{},initialize:function(a){this.tree=null;this.activeEvent=true;this.browseImageView=a.browseImageView;this.idAnnotation=null},showColors:function(){$(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.children!=null){return}var e=c.data.title;var b=c.data.color;var d="<%=   title %> <span style='background-color:<%=   color %>'>&nbsp;&nbsp;</span> ";if(!c.data.isFolder){d=d+"(<span id='usercount"+c.data.key+"'>0</span>)"}var a=_.template(d,{title:e,color:b});c.setTitle(a)})},render:function(){var a=this;require(["text!application/templates/explorer/OntologyTreeWrapper.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){$(this.el).html(_.template(b,{isDesktop:!window.app.view.isMobile}));this.tree=$(this.el).find(".tree");var a=this;$(this.el).find(".tree").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:this.model.toJSON(),onSelect:function(c,d){if(!a.activeEvent){return}if(a.idAnnotation==null){return}if(d.isSelected()){a.linkTerm(d.data.key)}else{if(!d.isSelected()){a.unlinkTerm(d.data.key)}}},onDblClick:function(d,c){d.toggleSelect()},onRender:function(d,c){$(c).find("span.dynatree-icon").css({"background-image":"url(css/custom-theme/images/ui-icons_ffffff_256x240.png)"})},initId:"treeData"+this.model.id,cookieId:"dynatree-Cb"+this.model.id,idPrefix:"dynatree-Cb"+this.model.id+"-"});a.showColors();$(this.el).find(".tree").dynatree("getRoot").visit(function(c){c.expand(true)});return this},clear:function(){var a=this;this.activeEvent=false;$(this.el).find(".otherUsersTerms").empty();$(this.el).find(".tree").dynatree("getRoot").visit(function(b){b.select(false);$("#usercount"+b.data.key).text("0")});this.activeEvent=true},clearAnnotation:function(){this.idAnnotation=null},check:function(b){var a=this;a.activeEvent=false;(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==b){c.select(true)}});a.activeEvent=true},uncheck:function(b){var a=this;a.activeEvent=false;(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==b){c.select(false)}});a.activeEvent=true},refresh:function(a){var b=this;console.log("refresh term for annotation "+a);this.idAnnotation=a;var c=function(g,e){console.log("collection.lenght="+g.length);b.annotationTerm=g;b.clear();b.activeEvent=false;var f=g.filter(function(h){return h.get("user")==window.app.status.user.id});_.each(f,function(i){var h=i.get("term");b.check(h)});var d=[];g.each(function(h){d.push(h.get("term"))});d=_.uniq(d);_.each(d,function(h){var i=g.filter(function(k){return k.get("term")==h});$("#usercount"+h).text(_.size(i))});b.activeEvent=true};new AnnotationTermCollection({idAnnotation:a}).fetch({success:c})},getTermsChecked:function(){var a=[];(this.el).find(".tree").dynatree("getRoot").visit(function(b){if(b.isSelected()){a.push(b.data.key)}});return a},linkTerm:function(b){var a=this;new AnnotationTermModel({annotation:this.idAnnotation,term:b}).save({annotation:this.idAnnotation,term:b},{success:function(d,c){window.app.view.message("Annotation Term",c.message,"success");a.browseImageView.reloadAnnotation(a.idAnnotation);a.browseImageView.refreshAnnotationTabs(b)},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Annotation-Term",e.errors,"error")}})},unlinkTerm:function(b){var a=this;console.log("unlinkTerm IdTerm "+b+" : "+this.idAnnotation);var c=a.annotationTerm.find(function(d){return(d.get("term")==b&&d.get("user")==window.app.status.user.id)});new AnnotationTermModel({id:c.id,annotation:this.idAnnotation,term:b}).destroy({success:function(e,d){window.app.view.message("Annotation Term",d.message,"success");a.browseImageView.reloadAnnotation(a.idAnnotation);a.browseImageView.refreshAnnotationTabs(b)},error:function(e,d){var f=$.parseJSON(d.responseText);window.app.view.message("Annotation-Term",f.errors,"error")}})}});var EditOntologyDialog=Backbone.View.extend({ontologyPanel:null,editOntologyDialog:null,initialize:function(a){this.container=a.container;this.ontologyPanel=a.ontologyPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyEditDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;$("#editontology").replaceWith("");$("#addontology").replaceWith("");var b=_.template(c,{});$(a.el).append(b);$("#login-form-edit-ontology").submit(function(){a.editOntology();return false});$("#login-form-edit-ontology").find("input").keydown(function(d){if(d.keyCode==13){$("#login-form-edit-ontology").submit();return false}});a.editOntologyDialog=$("#editontology").modal({keyboard:true,backdrop:false});$("#editOntologyButton").click(function(){$("#login-form-edit-ontology").submit();return false});$("#closeEditOntologyDialog").click(function(){$("#editontology").modal("hide");$("#editontology").remove();return false});a.open();a.fillForm();return this},fillForm:function(){var a=this;$("#ontology-edit-name").val(a.model.get("name"))},refresh:function(){},open:function(){var a=this;a.clearEditOntologyPanel()},clearEditOntologyPanel:function(){var a=this;$("#ontologyediterrormessage").empty();$("#ontologyediterrorlabel").hide();$("#ontology-edit-name").val("")},editOntology:function(){var a=this;$("#ontologyediterrormessage").empty();$("#ontologyediterrorlabel").hide();var b=$("#ontology-edit-name").val().toUpperCase();var c=a.model;c.unset("children");c.save({name:b},{success:function(e,d){window.app.view.message("Ontology",d.message,"success");$("#editontology").modal("hide");a.ontologyPanel.refresh()},error:function(e,d){var f=$.parseJSON(d.responseText);$("#ontologyediterrorlabel").show();$("#ontologyediterrormessage").append(f.errors)}})}});var AddOntologyDialog=Backbone.View.extend({ontologiesPanel:null,addOntologyDialog:null,initialize:function(a){this.container=a.container;this.ontologiesPanel=a.ontologiesPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyAddDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var b=this;var d=_.template(c,{});$("#editontology").replaceWith("");$("#addontology").replaceWith("");$(b.el).append(d);var a=window.app.models.users.get(window.app.status.user);$("#ontologyuser").append(a.get("username")+" ("+a.get("firstname")+" "+a.get("lastname")+")");$("#login-form-add-ontology").submit(function(){b.createOntology();return false});$("#login-form-add-ontology").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-add-ontology").submit();return false}});b.addOntologyDialog=$("#addontology").modal({keyboard:true,backdrop:false});$("#saveOntologyButton").click(function(){$("#login-form-add-ontology").submit();return false});$("#closeAddOntologyDialog").click(function(){$("#addontology").modal("hide");$("#addontology").remove();return false});b.open();return this},refresh:function(){},open:function(){var a=this;a.clearAddOntologyPanel()},clearAddOntologyPanel:function(){$("#errormessage").empty();$("#ontologyerrorlabel").hide();$("#ontology-name").val("")},createOntology:function(){var a=this;$("#errormessage").empty();$("#ontologyerrorlabel").hide();var b=$("#ontology-name").val().toUpperCase();var c=$("input[type=radio][name=ontologyradio]:checked").attr("value");var d=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(e,f){d.push($(f).attr("value"))});var c=new OntologyModel({name:b}).save({name:b},{success:function(f,e){window.app.view.message("Ontology",e.message,"success");var g=e.ontology.id;a.ontologiesPanel.refresh(g);window.app.models.ontologies.add(c);$("#addontology").modal("hide")},error:function(f,e){var g=$.parseJSON(e.responseText);$("#ontologyerrorlabel").show();$("#errormessage").append(g.errors)}})}});var ProjectView=Backbone.View.extend({tagName:"div",searchProjectPanelElem:"#searchProjectPanel",projectListElem:"#projectlist",projectList:null,addSlideDialog:null,ontologies:null,disciplines:null,initialize:function(a){this.container=a.container;this.model=a.model;this.ontologies=a.ontologies;this.disciplines=a.disciplines;this.el=a.el;this.searchProjectPanel=null;this.addProjectDialog=null},render:function(){var a=this;require(["text!application/templates/project/ProjectList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).find("#projectdiv").html(_.template(b,{}));$(a.projectListElem).empty();a.loadSearchProjectPanel();a.loadProjectsListing();return this},refresh:function(){var b=this;var a=undefined;if(b.addSlideDialog!=null){b.addSlideDialog.refresh()}new ProjectCollection({user:a}).fetch({success:function(d,c){b.model=d;b.render()}})},generateAddProjectPanel:function(){var a=this;require(["text!application/templates/project/AddProjectPanel.tpl.html"],function(b){$(a.projectListElem).append(_.template(b,{}))});return this},loadSearchProjectPanel:function(){var a=this;a.searchProjectPanel=new ProjectSearchPanel({model:a.model,ontologies:a.ontologies,disciplines:a.disciplines,el:$("#projectViewNorth"),container:a,projectsPanel:a}).render()},loadProjectsListing:function(){var a=this;a.projectList=new Array();a.model.each(function(c){var b=new ProjectPanelView({model:c,projectsPanel:a,container:a}).render();a.projectList.push(b);$(a.projectListElem).append(b.el)})},showProjects:function(b){var a=this;a.model.each(function(c){if(b.get(c.id)!=null){$(a.projectListElem+c.id).show()}else{$(a.projectListElem+c.id).hide()}})}});var ProjectPanelView=Backbone.View.extend({tagName:"div",loadImages:true,imageOpened:false,project:null,projectElem:"#projectlist",imageOpenElem:"#projectopenimages",imageAddElem:"#projectaddimages",projectChangeElem:"#radioprojectchange",projectChangeDialog:"div#projectchangedialog",loadImagesInAddPanel:true,projectsPanel:null,container:null,initialize:function(a){this.container=a.container;this.projectsPanel=a.projectsPanel;_.bindAll(this,"render")},events:{"click .addSlide":"showAddSlidesPanel","click .seeSlide":"showSlidesPanel","click .editProject":"editProject","click .deleteProject":"deleteProject"},render:function(){var a=this;require(["text!application/templates/project/ProjectDetail.tpl.html"],function(b){a.doLayout(b,false)});return this},refresh:function(){var a=this;a.model.fetch({success:function(c,b){a.loadImages=true;require(["text!application/templates/project/ProjectDetail.tpl.html"],function(d){a.doLayout(d,true)});a.projectsPanel.loadSearchProjectPanel()}})},clear:function(){var a=this;a.projectsPanel.refresh()},doLayout:function(h,b){var n=this;var m=n.model.toJSON();var k=m.ontology;if(window.app.models.users.get(m.creator)!=undefined){m.creator=window.app.models.users.get(m.creator).prettyName()}var o=20;var l=m.name;if(l.length>o){l=l.substr(0,o)+"..."}m.title=l;var a=[];_.each(n.model.get("users"),function(i){a.push(window.app.models.users.get(i).prettyName())});if(_.size(a)==0){m.shortUsers=a[0]}else{if(_.size(a)>=1){m.shortUsers=a[0]+", ..."}}m.users=a.join(", ");var c=[];_.each(n.model.get("admins"),function(i){c.push(window.app.models.users.get(i).prettyName())});if(_.size(a)==0){m.shortAdmins=c[0]}else{if(_.size(a)>=1){m.shortAdmins=c[0]+", ..."}}m.admins=c.join(", ");if(m.disciplineName==undefined){m.disciplineName="Undefined"}if(m.disciplineName.length>o){m.disciplineName=m.disciplineName.substr(0,o)+"..."}if(m.ontologyName.length>o){m.ontologyName=m.ontologyName.substr(0,o)+"..."}m.ontologyId=k;var e=[];for(var f=0;f<1&&f<m.numberOfImages;f++){var d=_.template("<img src='<%= url %>' style='max-width: 200px;padding: 5px;' />",{url:"api/project/"+m.id+"/preview.png?inf="+f});e.push(d)}m.images=_.template("<div style='width : 500px'><%= previewImages %></div>",{previewImages:e.join("")});var g=_.template(h,m);if(b){$("#projectlist"+m.id).replaceWith(g)}else{$(n.el).append(g)}$(n.el).find(".usersPopover").popover();$(n.el).find(".usersPopover").click(function(){return false});$(n.el).find(".adminsPopover").popover();$(n.el).find(".adminsPopover").click(function(){return false});$(n.el).find(".imagesPopover").popover();n.renderCurrentProjectButton();n.renderShowImageButton(m.numberOfImages)},editProject:function(){var a=this;$("#editproject").remove();a.editProjectDialog=new EditProjectDialog({projectPanel:a,el:a.el,model:a.model}).render()},deleteProject:function(){var a=this;if(a.model.get("numberOfImages")>0||a.model.get("numberOfAnnotations")>0||a.model.get("numberOfSlides")>0){a.refuseDeleteProject(a.model.get("numberOfImages"))}else{a.acceptDeleteProject()}},refuseDeleteProject:function(b){var a=this;require(["text!application/templates/project/ProjectDeleteRefuseDialog.tpl.html"],function(c){$("#dialogsDeleteProject").replaceWith("");var d=new ConfirmDialogView({el:"#dialogsDeleteProject",template:_.template(c,{project:a.model.get("name"),numberOfImage:b}),dialogAttr:{dialogID:"#delete-project-refuse"}}).render();$("#closeProjectDeleteRefuseDialog").click(function(){$("#delete-project-refuse").modal("hide");$("#delete-project-refuse").remove()})})},acceptDeleteProject:function(){var a=this;require(["text!application/templates/project/ProjectDeleteConfirmDialog.tpl.html"],function(b){var c=new ConfirmDialogView({el:"#dialogsDeleteProject",template:_.template(b,{project:a.model.get("name")}),dialogAttr:{dialogID:"#delete-project-confirm"}}).render();$("#closeProjectDeleteConfirmDialog").click(function(){new ProjectModel({id:a.model.id}).destroy({success:function(e,d){window.app.view.message("Project",d.message,"success");a.clear();$("#delete-project-confirm").modal("hide");$("#delete-project-confirm").remove()},error:function(e,d){var f=$.parseJSON(d.responseText);window.app.view.message("Project",f.errors[0],"error")}})})})},showAddSlidesPanel:function(){window.location="#project-manage-"+this.model.id},showSlidesPanel:function(){var a=this;a.openImagesList(a.model.get("id"));a.imageOpened=!a.imageOpened;$(a.imageOpenElem+a.model.id).button({icons:{secondary:a.imageOpened?"ui-icon-carat-1-n":"ui-icon-carat-1-s"}})},changeProject:function(){var b=this;var c=b.model.get("id");var a=false;if(c==window.app.status.currentProject){return true}window.app.controllers.browse.closeAll();window.app.status.currentProject=c;return true},renderShowImageButton:function(c){var a=this;var b=true;if(c>0){b=false}$(a.imageOpenElem+a.model.id).button({icons:{secondary:"ui-icon-carat-1-s"},disabled:b})},renderCurrentProjectButton:function(){var a=this;var b=window.app.status.currentProject==a.model.id;if(b){$(a.projectChangeElem+a.model.id).click()}},openImagesList:function(a){}});var ProjectManageSlideDialog=Backbone.View.extend({imageListing:null,imageThumb:null,projectPanel:null,addSlideDialog:null,imagesProject:null,divDialog:"div#projectaddimagedialog",render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageDialog.tpl.html"],function(b){a.doLayout(b)});return this},initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;this.imagesProject=new ImageInstanceCollection({project:this.model.get("id")})},refresh:function(){if(this.imageListing!=undefined){this.imageListing.refresh()}},doLayout:function(b){var a=this;$("#addimagediv").empty();var c=_.template(b,{id:a.model.get("id"),name:a.model.get("name")});$(a.el).append(c);$("button[class=goBackToProject]").click(function(){window.location="#project"});a.imageListing=new ProjectAddImageListingDialog({model:a.model,projectsPanel:a,imagesProject:a.imagesProject,el:"#tabsProjectaddimagedialog"+a.model.id+"-2"}).render();$("a[class=goBackToProject]").button({icons:{primary:"ui-icon-circle-triangle-w"}});$("input[class=showImageTable]").click(function(){a.imageListing.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-2").show();$("#tabsProjectaddimagedialog"+a.model.id+"-1").hide()});$("input[class=showImageTable]").click();$("input[class=showImageTable]").button({icons:{primary:"ui-icon-document"}});$("input[class=showImageThumbs]").click(function(){a.imageThumb.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-1").show();$("#tabsProjectaddimagedialog"+a.model.id+"-2").hide()});$("input[class=showImageThumbs]").button({icons:{primary:"ui-icon-image"}});a.imageListing.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-2").show();$("#tabsProjectaddimagedialog"+a.model.id+"-1").hide();$("#addimagediv").append($(a.divDialog+a.model.get("id")));$(".ui-panel-header").css("display","block");a.open();return this},open:function(){}});var AddProjectDialog=Backbone.View.extend({projectsPanel:null,addProjectDialog:null,initialize:function(a){this.container=a.container;this.projectsPanel=a.projectsPanel;this.ontologies=a.ontologies;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectAddDialog.tpl.html","text!application/templates/project/OntologiesChoicesRadio.tpl.html","text!application/templates/project/DisciplinesChoicesRadio.tpl.html","text!application/templates/project/UsersChoices.tpl.html"],function(b,e,d,c){a.doLayout(b,e,d,c)});return this},doLayout:function(a,g,f,e){var c=this;var d=_.template(a,{});$("#editproject").replaceWith("");$("#addproject").replaceWith("");$(c.el).append(d);$("#login-form-add-project").submit(function(){c.createProject();return false});$("#login-form-add-project").find("input").keydown(function(h){if(h.keyCode==13){$("#login-form-add-project").submit();return false}});$("#projectdiscipline").empty();var b=_.template(f,{id:-1,name:"*** Undefined ***"});$("#projectdiscipline").append(b);window.app.models.disciplines.each(function(i){var h=_.template(f,{id:i.id,name:i.get("name")});$("#projectdiscipline").append(h)});$("#projectontology").empty();c.ontologies.fetch({success:function(i,h){i.each(function(l){var k=_.template(g,{id:l.id,name:l.get("name")});$("#projectontology").append(k)})}});c.createUserList(e);c.addProjectDialog=$("#addproject").modal({keyboard:true,backdrop:false});$("#saveProjectButton").click(function(){$("#login-form-add-project").submit();return false});$("#closeAddProjectDialog").click(function(){$("#addproject").modal("hide");$("#addproject").remove();return false});c.open();return this},createUserList:function(f){var d="projectuser";$("#"+d).empty();var b=4;var e=Math.floor(_.size(window.app.models.users)/b);for(var a=0;a<b;a++){$("#"+d).append(_.template("<div class='span2'><ul id='<%= identifier %><%= column %>'></ul></div>",{identifier:d,column:a}))}var c=0;window.app.models.users.each(function(h){var i=Math.floor(c/e);var g=_.template(f,{id:h.id,username:h.prettyName()});$("#"+d+i).append(g);c++});$("#"+d).find("#users"+window.app.status.user.id).attr("checked","checked");$("#"+d).find("#users"+window.app.status.user.id).click(function(){$("#"+d).find("#users"+window.app.status.user.id).attr("checked","checked")});$("#"+d).find('[for="users'+window.app.status.user.id+'"]').css("font-weight","bold")},refresh:function(){},open:function(){var a=this;a.clearAddProjectPanel();$("#addproject").modal("show")},clearAddProjectPanel:function(){var a=this;$("#errormessage").empty();$("#projecterrorlabel").hide();$("#project-name").val("");$(a.addProjectCheckedOntologiesRadioElem).attr("checked",false);$(a.addProjectCheckedDisciplinesRadioElem).attr("checked",false);$(a.addProjectCheckedUsersCheckboxElem).attr("checked",false)},createProject:function(){var a=this;$("#errormessage").empty();$("#projecterrorlabel").hide();var c=$("#project-name").val().toUpperCase();var b=$("#projectdiscipline").attr("value");if(b==-1){b=null}var d=$("#projectontology").attr("value");var e=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(f,g){e.push($(g).attr("value"))});new ProjectModel({name:c,ontology:d,discipline:b}).save({name:c,ontology:d,discipline:b},{success:function(h,g){window.app.view.message("Project",g.message,"success");var k=g.project.id;var i=e.length;var f=0;if(i==0){a.addDeleteUserProjectCallback(0,0)}_.each(e,function(l){new ProjectUserModel({project:k,user:l}).save({},{success:function(n,m){a.addUserProjectCallback(i,++f)},error:function(n,m){var o=$.parseJSON(m.responseText);window.app.view.message("User",o.errors,"error")}})})},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Project",h.errors[0],"error")}})},addUserProjectCallback:function(c,a){if(a<c){return}var b=this;b.projectsPanel.refresh();$("#addproject").modal("hide");$("#addproject").remove()}});var EditProjectDialog=Backbone.View.extend({projectsPanel:null,editProjectDialog:null,initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectEditDialog.tpl.html","text!application/templates/project/UsersChoices.tpl.html"],function(b,c){a.doLayout(b,c)});return this},doLayout:function(c,d){var a=this;$("#editproject").replaceWith("");$("#addproject").replaceWith("");var b=_.template(c,{});$(a.el).append(b);$("#login-form-edit-project").submit(function(){a.editProject();return false});$("#login-form-edit-project").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-edit-project").submit();return false}});$("#editProjectButton").click(function(){$("#login-form-edit-project").submit();return false});$("#closeEditProjectDialog").click(function(){$("#editproject").modal("hide");$("#editproject").remove();return false});a.createUserList(d);a.editProjectDialog=$("#editproject").modal({keyboard:true,backdrop:false});a.open();a.fillForm();return this},createUserList:function(f){var d="projectedituser";$("#"+d).empty();var b=4;var e=Math.floor(_.size(window.app.models.users)/b);for(var a=0;a<b;a++){$("#"+d).append(_.template("<div class='span2'><ul id='<%= identifier %><%= column %>'></ul></div>",{identifier:d,column:a}))}var c=0;window.app.models.users.each(function(h){var i=Math.floor(c/e);var g=_.template(f,{id:h.id,username:h.prettyName()});$("#"+d+i).append(g);c++});$("#"+d).find("#users"+window.app.status.user.id).attr("checked","checked");$("#"+d).find("#users"+window.app.status.user.id).click(function(){$("#"+d).find("#users"+window.app.status.user.id).attr("checked","checked")});$("#"+d).find('[for="users'+window.app.status.user.id+'"]').css("font-weight","bold")},fillForm:function(){var a=this;$("#project-edit-name").val(a.model.get("name"));var b=a.model.get("users");_.each(b,function(c){$("#users"+c).attr("checked",true);if(window.app.status.user.id==c.id){}})},refresh:function(){},open:function(){var a=this;a.clearEditProjectPanel();$("#editproject").modal("show")},clearEditProjectPanel:function(){var a=this;$("#projectediterrormessage").empty();$("#projectediterrorlabel").hide();$("#project-edit-name").val("");$(a.editProjectCheckedUsersCheckboxElem).attr("checked",false)},diffArray:function(d,c){var e=[],g=[];for(var f=0;f<c.length;f++){e[c[f]]=true}for(var f=0;f<d.length;f++){if(!e[d[f]]){g.push(d[f])}}return g},editProject:function(){var a=this;$("#projectediterrormessage").empty();$("#projectediterrorlabel").hide();var b=$("#project-edit-name").val().toUpperCase();var d=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(e,f){d.push($(f).attr("value"))});var c=a.model;c.set({name:b});c.save({name:b},{success:function(l,k){window.app.view.message("Project",k.message,"success");var g=k.project.id;var m=new Array();var o=null;var h=null;var f=null;var i=a.model.get("users");_.each(i,function(p){m.push(p)});m.sort();o=d;o.sort();h=a.diffArray(o,m);f=a.diffArray(m,o);var n=h.length+f.length;var e=0;if(n==0){a.addDeleteUserProjectCallback(0,0)}_.each(h,function(p){new ProjectUserModel({project:g,user:p}).save({},{success:function(r,q){a.addDeleteUserProjectCallback(n,++e)},error:function(r,q){var s=$.parseJSON(q.responseText);window.app.view.message("User",s.errors[0],"error")}})});_.each(f,function(p){new ProjectUserModel({id:1,project:g,user:p}).destroy({success:function(r,q){a.addDeleteUserProjectCallback(n,++e)},error:function(r,q){var s=$.parseJSON(q.responseText);window.app.view.message("User",s.errors[0],"error")}})})},error:function(f,e){console.log(e);var g=$.parseJSON(e.responseText);window.app.view.message("Project",g.errors[0],"error")}})},addDeleteUserProjectCallback:function(c,a){if(a<c){return}var b=this;b.projectPanel.refresh();$("#editproject").modal("hide");$("#editproject").remove()}});var ProjectSearchPanel=Backbone.View.extend({ontologies:null,disciplines:null,idUser:null,container:null,projectsPanel:null,allProjectsButtonElem:"#projectallbutton",addProjectButtonElem:"#projectaddbutton",searchProjectOntolgiesListElem:"#ontologyChoiceList",searchProjectDisciplinesListElem:"#disciplineChoiceList",sliderNumberOfImagesElem:"#numberofimageSlider",labelNumberOfImagesElem:"#amountNumberOfImages",sliderNumberOfSlidesElem:"#numberofslideSlider",labelNumberOfSlidesElem:"#amountNumberOfSlides",sliderNumberOfAnnotationsElem:"#numberofannotationSlider",labelNumberOfAnnotationsElem:"#amountNumberOfAnnotations",searchProjectTextBoxElem:"#projectsearchtextbox",searchProjectButtonElem:"#projectsearchbutton",searchProjectCheckedOntologiesElem:"input[type=checkbox][name=ontology]:checked",addProjectCheckedOntologiesRadioElem:"input[type=radio][name=ontologyradio]:checked",addProjectCheckedDisciplinesRadioElem:"input[type=radio][name=disciplineradio]:checked",addProjectCheckedUsersCheckboxElem:"input[type=checkbox][name=usercheckbox]:checked",initialize:function(a){this.ontologies=a.ontologies;this.disciplines=a.disciplines;this.idUser=a.idUser;this.container=a.container;this.projectsPanel=a.projectsPanel},events:{"click .addProject":"showAddProjectPanel","change .searchProjectCriteria":"searchProject","click .showAllProject":"showAllProject","click .refreshAllProject":"refreshAllProject"},render:function(){var a=this;require(["text!application/templates/project/ProjectSearchPanel.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=_.template(b,{});$(this.el).empty();$(this.el).append(c);require(["text!application/templates/project/OntologiesChoices.tpl.html","text!application/templates/project/DisciplinesChoices.tpl.html"],function(d,e){a.loadPanelAndButton(d,e)});a.loadSlider();a.loadAutocomplete()},loadPanelAndButton:function(a,b){var c=this;c.ontologies.each(function(e){var d=_.template(a,{id:e.id,name:e.get("name")});$(c.searchProjectOntolgiesListElem).append(d)});c.disciplines.each(function(e){var d=_.template(b,{id:e.id,name:e.get("name")});$(c.searchProjectDisciplinesListElem).append(d)})},loadSlider:function(){var a=this;var b=Number.MAX_VALUE;var d=0;var e=Number.MAX_VALUE;var g=0;var c=Number.MAX_VALUE;var f=0;a.model.each(function(i){var h=parseInt(i.get("numberOfImages"));var l=parseInt(i.get("numberOfSlides"));var k=parseInt(i.get("numberOfAnnotations"));if(h<b){b=h}if(h>d){d=h}if(l<e){e=l}if(l>g){g=l}if(k<c){c=k}if(k>f){f=k}});a.createSliderWithoutAmountPrint(a.sliderNumberOfImagesElem,a.labelNumberOfImagesElem,b,d);a.createSliderWithoutAmountPrint(a.sliderNumberOfSlidesElem,a.labelNumberOfSlidesElem,e,g);a.createSliderWithoutAmountPrint(a.sliderNumberOfAnnotationsElem,a.labelNumberOfAnnotationsElem,c,f)},loadAutocomplete:function(){var a=this;var b=new Array();a.model.each(function(c){b.push(c.get("name"))});$(a.searchProjectTextBoxElem).autocomplete({minLength:0,source:b,select:function(c,d){$(a.searchProjectTextBoxElem).val(d.item.label);a.searchProject()},search:function(c){console.log("search="+$(a.searchProjectTextBoxElem).val());a.searchProject()}})},createSliderWithoutAmountPrint:function(e,c,d,a){var b=this;$(e).slider({range:true,min:d,max:a,values:[d,a],change:function(f,g){$(c).val(""+g.values[0]+" - "+g.values[1]);b.searchProject()}});$(c).val(""+$(e).slider("values",0)+" - "+$(e).slider("values",1))},refreshSearchPanel:function(b){var a=this;a.loadSlider();a.loadAutocomplete()},showAllProject:function(){var a=this;$(a.searchProjectTextBoxElem).val("");$("#ontologyChoiceList").val(-1);$("#disciplineChoiceList").val(-1);a.resetSlider(a.sliderNumberOfImagesElem);a.resetSlider(a.sliderNumberOfSlidesElem);a.resetSlider(a.sliderNumberOfAnnotationsElem);a.searchProject()},refreshAllProject:function(){this.container.refresh()},resetSlider:function(c){var b=$(c).slider("option","min");var a=$(c).slider("option","max");$(c).slider("values",[b,a])},searchProject:function(){var i=this;var h=$(i.searchProjectTextBoxElem).val();var d=new Array();var g=$("#ontologyChoiceList").val();if(g!=-1){d.push(g)}var c=new Array();var e=$("#disciplineChoiceList").val();if(e!=-1){c.push(e)}var f=new Array();f.push($(i.sliderNumberOfImagesElem).slider("values",0));f.push($(i.sliderNumberOfImagesElem).slider("values",1));var b=new Array();b.push($(i.sliderNumberOfSlidesElem).slider("values",0));b.push($(i.sliderNumberOfSlidesElem).slider("values",1));var a=new Array();a.push($(i.sliderNumberOfAnnotationsElem).slider("values",0));a.push($(i.sliderNumberOfAnnotationsElem).slider("values",1));i.filterProjects(h==""?undefined:h,d.length==0?undefined:d,c.length==0?undefined:c,f,b,a)},showAddProjectPanel:function(){var a=this;$("#addproject").remove();a.addProjectDialog=new AddProjectDialog({projectsPanel:a.projectsPanel,el:a.el,ontologies:a.ontologies}).render()},filterProjects:function(g,f,a,e,c,h){var b=this;var d=new ProjectCollection(b.model.models);d=b.filterByProjectsByName(g,d);d=b.filterProjectsByOntology(f,d);d=b.filterProjectsByDiscipline(a,d);d=b.filterProjectsByNumberOfImages(e,d);d=b.filterProjectsByNumberOfSlides(c,d);d=b.filterProjectsByNumberOfAnnotations(h,d);b.container.showProjects(d)},filterByProjectsByName:function(c,b){if(c==undefined){return b}var a=new ProjectCollection(b.models);b.each(function(g){var d=g.get("name").toLowerCase();var f=c.toLowerCase();var e=(d.indexOf(f)!=-1);if(!e){a.remove(g)}});return a},filterProjectsByOntology:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("ontology")+"";if(d!=undefined&&_.indexOf(d,e)==-1){b.remove(f)}});return b},filterProjectsByDiscipline:function(a,d){var b=this;var c=new ProjectCollection(d.models);d.each(function(f){var e=f.get("discipline")+"";if(a!=undefined&&_.indexOf(a,e)==-1){c.remove(f)}});return c},filterProjectsByNumberOfImages:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("numberOfImages");if(d[0]>e||d[1]<e){b.remove(f)}});return b},filterProjectsByNumberOfSlides:function(c,d){var a=this;var b=new ProjectCollection(d.models);d.each(function(f){var e=f.get("numberOfSlides");if(c[0]>e||c[1]<e){b.remove(f)}});return b},filterProjectsByNumberOfAnnotations:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("numberOfAnnotations");if(d[0]>e||d[1]<e){b.remove(f)}});return b}});var ProjectAddImageListingDialog=Backbone.View.extend({imagesProject:null,searchPanel:null,initialize:function(b){var a=this;this.container=b.container;this.projectPanel=b.projectPanel;this.imagesProject=b.imagesProject;this.abstractImageProject=new Array();this.el="#tabsProjectaddimagedialog"+a.model.id+"-2";this.listmanageproject="listmanageproject"+this.model.id;this.pagemanageproject="pagemanageproject"+this.model.id;this.listmanageall="listmanageall"+this.model.id;this.pagemanageall="pagemanageall"+this.model.id;this.addImageButton="addimageprojectbutton"+this.model.id;this.delImageButton="delimageprojectbutton"+this.model.id;this.tab=2;this.timeoutHnd=null},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageListingDialog.tpl.html"],function(b){a.doLayout(b)});return this},refresh:function(){this.refreshImageList()},doLayout:function(c){var b=this;var e=b.model.toJSON();e.tab=2;var d=_.template(c,e);$(b.el).append(d);this.renderImageList();var f=$(window).width()-80;var a=f*0.05;$("#imageTableSeparator").css({width:a+"px"});return this},renderImageList:function(){var a=this;a.renderImageListing()},renderImageListing:function(){var a=this;$("#"+a.addImageButton).button({icons:{primary:"ui-icon-circle-arrow-w"},text:false});$("#"+a.delImageButton).button({icons:{primary:"ui-icon-circle-arrow-e"},text:false});$("#infoProjectPanel"+a.model.id).panel({collapseSpeed:100});$("#"+a.addImageButton).click(function(){a.addImageProjectFromTable()});$("#"+a.delImageButton).click(function(){a.deleteImageProjectFromTable()});$("#searchImagetPanelup"+a.model.id+"-"+a.tab).panel({collapseSpeed:100});$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val("");$("#imagesallbutton"+a.model.id+"-"+a.tab).button({text:true});$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).keyup(function(){a.doSearch()}).keyup();$("#imagesallbutton"+a.model.id+"-"+a.tab).click(function(){$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val("");$("#datestartsearchup"+a.model.id+"-"+a.tab).val("");$("#dateendsearchup"+a.model.id+"-"+a.tab).val("");a.doSearch()});$("#datestartsearchup"+a.model.id+"-"+a.tab).datepicker({onSelect:function(c,b){a.doSearch()}});$("#dateendsearchup"+a.model.id+"-"+a.tab).datepicker({onSelect:function(c,b){a.doSearch()}});a.renderImageListProject();a.renderImageListAll()},doSearch:function(){var a=this;if($.data(this,"timer")!=null){clearTimeout($.data(this,"timer"))}var b=setTimeout(function(){a.searchImages()},500);$(this).data("timer",b)},searchImages:function(){var a=this;var f=$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val();var e=$("#datestartsearchup"+a.model.id+"-"+a.tab).datepicker("getDate");var c=$("#dateendsearchup"+a.model.id+"-"+a.tab).datepicker("getDate");var b="";if(e!=null){b=e.getTime()}var d="";if(c!=null){d=c.getTime()}$("#"+a.listmanageall).jqGrid("setGridParam",{url:"api/currentuser/image.json?filename="+f+"&createdstart="+b+"&createdstop="+d,page:1}).trigger("reloadGrid")},refreshImageList:function(){var a=this;$("#"+a.listmanageproject).jqGrid("clearGridData",true);a.imagesProject.fetch({success:function(c,b){a.fillAbstractImageProjectCollection(c);a.loadDataImageListProject(c);$("#"+a.listmanageall).trigger("reloadGrid")}})},fillAbstractImageProjectCollection:function(a){var b=this;b.abstractImageProject=[];b.imagesProject.each(function(c){b.abstractImageProject.push(c.get("baseImage"))})},loadDataImageListProject:function(e){var a=this;var d=new Array();var c=0;e.each(function(g){var f=new Date();f.setTime(g.get("created"));d[c]={id:g.id,base:g.get("baseImage"),thumb:"<img src='"+g.get("thumb")+"' width=50/>",filename:g.get("filename"),type:g.get("mime"),annotations:g.get("numberOfAnnotations"),added:f.getFullYear()+"-"+f.getMonth()+"-"+f.getDate(),See:""};c++});for(var b=0;b<d.length;b++){$("#"+a.listmanageproject).jqGrid("addRowData",d[b].id,d[b])}$("#"+a.listmanageproject).jqGrid("sortGrid","filename",false)},renderImageListProject:function(){var b=this;var c=$(window).width()-80;var a=c*0.45;$("#imagesProjectContainer").css({width:a+"px"});$("#"+b.listmanageproject).jqGrid({datatype:"local",width:a,height:500,colNames:["id","base","thumb","filename","type","annotations","added"],colModel:[{name:"id",index:"id",width:1,sorttype:"int"},{name:"base",index:"base",width:1,sorttype:"int"},{name:"thumb",index:"thumb",width:100},{name:"filename",index:"filename",width:250},{name:"type",index:"type",width:50},{name:"annotations",index:"annotations",width:50},{name:"added",index:"added",width:100,sorttype:"date"}],onSelectRow:function(e){var d=$("#"+b.listmanageproject).find("#"+e).find(".cbox").attr("checked");if(d){$("#"+b.listmanageproject).find("#"+e).find("td").css("background-color","CD661D")}else{$("#"+b.listmanageproject).find("#"+e).find("td").css("background-color","a0dc4f")}},loadComplete:function(){b.imagesProject.each(function(d){$("#"+b.listmanageproject).find("#"+d.id).find("td").css("background-color","a0dc4f")})},pager:"#"+b.pagemanageproject,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Images in "+b.model.get("name"),multiselect:true});$("#"+b.listmanageproject).jqGrid("navGrid","#"+b.listmanageproject,{edit:false,add:false,del:false});$("#"+b.listmanageproject).jqGrid("hideCol","id");$("#"+b.listmanageproject).jqGrid("hideCol","base")},isAbstractImageInProject:function(a){if(_.indexOf(this.abstractImageProject,a)!=-1){return true}else{return false}},renderImageListAll:function(){var b=this;var c=$(window).width()-80;var a=c*0.45;$("#allImagesContainer").css({width:a+"px"});var d="thumb";$("#"+b.listmanageall).jqGrid({datatype:"json",url:"api/currentuser/image.json",width:a,height:500,colNames:["id",d,"filename","mime","created"],colModel:[{name:"id",index:"id",width:1},{name:d,index:d,width:100},{name:"filename",index:"filename",width:250},{name:"mime",index:"mime",width:45},{name:"created",index:"created",width:100,sorttype:"date",formatter:b.dateFormatter}],onSelectRow:function(e){if(b.isAbstractImageInProject(e)){$("#"+b.listmanageall).find("#"+e).find(".cbox").removeAttr("checked")}},loadComplete:function(e){$("#"+b.listmanageall).find("tr").each(function(f){if(f!=0){var g=$(this).find('[aria-describedby$="_'+d+'"]');$(g).html('<img src="'+$(g).text()+'" width=50/>')}});b.imagesProject.each(function(f){$("#"+b.listmanageall).find("#"+f.get("baseImage")).find("td").css("background-color","a0dc4f");$("#"+b.listmanageall).find("#"+f.get("baseImage")).find(".cbox").attr("disabled",true);$("#"+b.listmanageall).find("#"+f.get("baseImage")).find(".cbox").css("visible",false)})},pager:"#"+b.pagemanageall,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Available images",multiselect:true,rowNum:10,rowList:[10,20,30],jsonReader:{repeatitems:false,id:"0"}});$("#"+b.listmanageall).jqGrid("navGrid","#"+b.pagemanageall,{edit:false,add:false,del:false},{},{},{},{multipleSearch:true});$("#"+b.listmanageall).jqGrid("sortGrid","filename",false);$("#"+b.listmanageall).jqGrid("hideCol","id")},dateFormatter:function(b,c,d){var a=new Date();a.setTime(b);return a.getFullYear()+"-"+a.getMonth()+"-"+a.getDate()},addImageProjectFromTable:function(){var b=this;var c=$("#"+b.listmanageall).jqGrid("getGridParam","selarrrow");if(c.length==0){return}var a=0;_.each(c,function(d){new ImageInstanceModel({}).save({project:b.model.id,user:null,baseImage:d},{success:function(f,e){window.app.view.message("Image",e.message,"success");b.addImageProjectCallback(c.length,++a)},error:function(f,e){var g=$.parseJSON(e.responseText);window.app.view.message("Image",g.errors.message,"error");b.addImageProjectCallback(c.length,++a)}})})},addImageProjectCallback:function(c,a){if(a<c){return}var b=this;b.refreshImageList()},deleteImageProjectFromTable:function(){var a=this;var b=$("#"+a.listmanageproject).jqGrid("getGridParam","selarrrow");if(b.length==0){return}a.deleteImageWithcheckForAnnotation(b)},deleteImageProject:function(c){var b=this;var a=0;_.each(c,function(d){var e=b.imagesProject.get(d).get("baseImage");new ImageInstanceModel({id:1,project:b.model.id,user:null,baseImage:e}).destroy({success:function(g,f){window.app.view.message("Image",f.message,"success");b.deleteImageProjectCallback(c.length,++a)},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Image",h.errors.message,"error");b.deleteImageProjectCallback(c.length,++a)}})})},deleteImageProjectCallback:function(c,a){if(a<c){return}var b=this;b.refreshImageList()},deleteImageWithcheckForAnnotation:function(c){var a=this;var b=false;_.each(c,function(d){var e=a.imagesProject.get(d).get("numberOfAnnotations");if(e>0){b=true}});if(b){require(["text!application/templates/project/ProjectAddImageDeleteImageInstanceWithAnnotation.tpl.html"],function(d){var e=new ConfirmDialogView({el:"#dialogDeleteImageWithAnnotation",template:_.template(d,{projectname:a.model.get("name")}),dialogAttr:{dialogID:"#dialogDeleteImageWithAnnotation",width:400,height:300,buttons:{"Delete all images and annotations":function(){a.deleteImageProject(c);$("#dialogDeleteImageWithAnnotation").dialog("close")},Cancel:function(){$("#dialogDeleteImageWithAnnotation").dialog("close")}},close:function(f){}}}).render()})}else{a.deleteImageProject(c)}}});var ProjectAddImageThumbDialog=Backbone.View.extend({imageListing:null,imageThumb:null,slides:null,imagesProject:null,imagesinstanceProject:null,checklistChecked:".checklist input:checked",checklistSelected:".checklist .checkbox-select",checklistDeselected:".checklist .checkbox-deselect",selectedClass:"selected",checkedAttr:"checked",liElem:"projectaddimageitemli",ulElem:"#projectaddimagedialoglist",allProjectUlElem:"ul[id^=projectaddimagedialoglist]",imageDivElem:"#projectaddimageitempict",page:0,nb_slide_by_page:20,nextPage:function(){var a=Math.round(_.size(window.app.models.slides)/this.nb_slide_by_page)-1;this.page=Math.min(this.page+1,a);this.renderImageListLayout()},previousPage:function(){this.page=Math.max(this.page-1,0);this.renderImageListLayout()},disablePrevious:function(){},enablePrevious:function(){},disableNext:function(){},enableNext:function(){},initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;this.imagesProject=a.imagesProject;this.imagesinstanceProject=a.imagesinstanceProject;this.el="#tabsProjectaddimagedialog"+this.model.id+"-1";this.slides=a.slides;_.bindAll(this,"render");_.bindAll(this,"nextPage");_.bindAll(this,"previousPage")},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageThumbDialog.tpl.html"],function(b){a.doLayout(b)});return this},refresh:function(){this.renderImageList()},doLayout:function(c){var b=this;var a=_.template(c,{id:this.model.get("id"),name:this.model.get("name")});$(b.el).append(a);$(b.el).find("a.next").bind("click",b.nextPage);$(b.el).find("a.next").button();$(b.el).find("a.previous").bind("click",b.previousPage);$(b.el).find("a.previous").button();return this},renderImageList:function(){var a=this;window.app.models.slides.fetch({success:function(c,b){a.renderImageListLayout()}})},renderImage:function(c,d,b){var a=this;require(["text!application/templates/project/ProjectAddImageChoice.tpl.html"],function(g){var f=new ImageSelectView({model:d}).render();var e=d.get("filename");if(e.length>15){e=e.substring(0,12)+"..."}var h=_.template(g,{id:d.id,name:e,namefull:d.get("filename"),slide:d.get("slide"),info:d.get("info")});$(b).append(h);$(b+" "+a.imageDivElem+d.id).append(f.el);$(f.el).css({width:30});$(b).find("label  > b").css("font-size",10);if(c.get(d.id)){$(b+" #"+a.liElem+d.id).addClass(a.selectedClass);$(b+" #"+a.liElem+d.id).find(":checkbox").attr(a.checkedAttr,a.checkedAttr)}})},selectAllImages:function(a){$(".projectImageList"+a).find("li.imageThumbChoice").each(function(){$(this).find("a.checkbox-select").click()})},unselectAllImages:function(a){$(".projectImageList"+a).find("li.imageThumbChoice").each(function(){$(this).find("a.checkbox-deselect").click()})},renderSlide:function(a){var b=this;require(["text!application/templates/project/ProjectSlideDetail.tpl.html"],function(d){var f=_.template(d,{id:a.get("id"),name:a.get("name")});var e=$(b.ulElem+b.model.get("id"));e.append("<td>"+f+"</td>");e.find(".slideItem"+a.get("id")).panel({collapsible:false});e.find("a[class=selectAll]").bind("click",function(){b.selectAllImages(a.get("id"))});e.find("a[class=unselectAll]").bind("click",function(){b.unselectAllImages(a.get("id"))});e.find("a[class=selectAll]").button({text:false,icons:{secondary:"ui-icon-circle-plus"}});e.find("a[class=unselectAll]").button({text:false,icons:{secondary:"ui-icon-circle-minus"}});var c=a.get("images");var g=".projectImageList"+a.get("id");_.each(c,function(i){var h=new ImageModel(i);b.renderImage(b.imagesProject,h,g)});$("#projectImageList"+a.get("id")).carousel();$(g).append('<div style="clear:both;"></div>')})},renderImageListLayout:function(){var b=this;var f=0;var e=Math.abs(b.page)*b.nb_slide_by_page;var a=(Math.abs(b.page)+1)*b.nb_slide_by_page;$(b.ulElem+b.model.get("id")).empty();var d=4;var c=0;$(b.ulElem+b.model.get("id")).append("<table><tr width='25%'>");window.app.models.slides.each(function(g){if((f>=e)&&(f<a)){b.renderSlide(g);c++;if(c==d){c=0;$(b.ulElem+b.model.get("id")).append("</tr><tr width='25%'>")}}$(b.ulElem+b.model.get("id")).append("</tr></table>");$(".carousel-wrap").css("height","200");f++;if(f==a){b.initEvents()}})},addImageToProject:function(a,b){new ImageInstanceModel({}).save({project:b,user:null,baseImage:a},{success:function(d,c){window.app.view.message("ImageInstance",c.message,"success")},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Image",e.errors[0],"error")}})},deleteImageToProject:function(a,b){new ImageInstanceModel({id:1,project:b,user:null,baseImage:a}).destroy({success:function(d,c){window.app.view.message("ImageInstance",c.message,"success")},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Image",e.errors[0],"error")}})},initEvents:function(){var a=this;$(a.checklistChecked).parent().addClass(a.selectedClass);$(a.checklistSelected).click(function(e){e.preventDefault();var d=$(this).parent().attr("class");$(this).parent().addClass(a.selectedClass);$(this).parent().find(":checkbox").attr(a.checkedAttr,a.checkedAttr);var b=$(this).parent().attr("id");var c=b.substring(a.liElem.length,b.length);a.addImageToProject(c,a.model.id)});$(a.checklistDeselected).click(function(d){d.preventDefault();$(this).parent().removeClass(a.selectedClass);$(this).parent().find(":checkbox").removeAttr(a.checkedAttr);var b=$(this).parent().attr("id");var c=b.substring(a.liElem.length,b.length);a.deleteImageToProject(c,a.model.id)})}});var ProjectAddImageSearchPanel=Backbone.View.extend({images:null,tab:null,initialize:function(b){var a=this;this.container=b.container;this.images=b.images;this.tab=b.tab},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageSearchDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(d){var b=this;var f=b.model.toJSON();var a=f.ontology;f.ontologyId=a;f.tab=b.tab;var e=_.template(d,f);$(b.el).append(e);b.renderImageListing();var c=new Array();$("#filenamesearchtextboxup"+b.model.id+"-"+b.tab).autocomplete({minLength:0,source:c,select:function(g,h){$("#filenamesearchtextboxup"+b.model.id+"-"+b.tab).val(h.item.label);b.container.searchImages()},search:function(g){b.container.searchImages()}});$("#datestartsearchup"+b.model.id+"-"+b.tab).change(function(){b.container.searchImages()});$("#dateendsearchup"+b.model.id+"-"+b.tab).change(function(){b.container.searchImages()});return this},search:function(a){var b=this;return b.filterImages(searchText==""?undefined:searchText,dateStart,dateEnd)},filterImages:function(e,d,c){var b=this;var a=new ImageCollection(b.images.models);a=b.filterByImagesByName(e,a);a=b.filterByDateStart(d,a);a=b.filterByDateEnd(c,a);return a},filterByImagesByName:function(c,b){var a=new ImageCollection(b.models);b.each(function(d){if(c!=undefined&&!d.get("filename").toLowerCase().contains(c.toLowerCase())){a.remove(d)}});return a},filterByDateStart:function(c,b){var a=new ImageCollection(b.models);b.each(function(e){var d=new Date();d.setTime(e.get("created"));if(c!=undefined&&d<c){a.remove(e)}});return a},filterByDateEnd:function(c,b){var a=new ImageCollection(b.models);b.each(function(e){var d=new Date();d.setTime(e.get("created"));if(c!=undefined&&d>c){a.remove(e)}});return a},renderImageListing:function(){var a=this}});var AnnotationListView=Backbone.View.extend({tagName:"div",self:this,alreadyBuild:false,initialize:function(a){this.container=a.container;this.idAnnotation=a.idAnnotation},render:function(){var a=this;require(["text!application/templates/annotation/AnnotationList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{name:"name",area:"area"}));a.model.each(function(f){var g=f.get("name");var h=f.get("area")});var d;var c=0;var e=[];a.model.each(function(f){e[c]={id:f.id,filename:f.get("filename"),created:""};c++});return this},initAnnotation:function(){var a=this}});var AnnotationRetrievalView=Backbone.View.extend({tagName:"div",baseAnnotation:null,terms:null,initialize:function(a){this.container=a.container;this.page=a.page;this.annotations=null;this.baseAnnotation=a.baseAnnotation;this.terms=a.terms;window.app.status.currentTermsCollection=a.terms;if(this.page==undefined){this.page=0}},render:function(){var a=this;console.log("AnnotationRetrievalView: main elem "+$(a.el).length);$("#retrievalMenu").replaceWith("");$("#retrievalThumb").replaceWith("");$("#retrievalPieChart").replaceWith("");$(a.el).append('<ul id="retrievalMenu"><li><a href="#retrievalThumb">Thumb view</a></li><li><a href="#retrievalPieChart">Stats view</a></li></ul>');$(a.el).append('<div id="retrievalThumb"><div>');$(a.el).append('<div id="retrievalPieChart"><div id="retrievalPieChartTerm" style="float: left; width: 50%;"></div><div id="retrievalPieChartProject" style="float: left; width: 50%;"></div></div>');$("#annotationRetrieval").tabs();$(a.el).dialog({title:a.createTitle(),width:900,height:500,autoOpen:true,modal:true,buttons:{Close:function(){$(a.el).dialog("close")}}});a.createThumbView(a.page);a.createStatsView();return this},createTitle:function(){var a=this;var d=a.baseAnnotation.get("id");var c=new Array();var b=a.baseAnnotation.get("term");_.each(b,function(e){if(a.terms.get(e)!=undefined){c.push(a.terms.get(e).get("name"))}});return"Annotation "+d+" with term "+c.join(",")},createThumbView:function(a){this.appendThumbs(a)},createStatsView:function(){var b=this;var a=new Object();b.model.each(function(d){var e=d.get("term");_.each(e,function(g){console.log(g);console.log(b.terms);var f=b.terms!=undefined&&b.terms.get(g)!=undefined;if(f){if(a[g]!=null){a[g]=a[g]+Number(d.get("similarity"))}else{a[g]=Number(d.get("similarity"))}}})});console.log("drawPieChartTerm");b.drawPieChartTerm(a);var c=new Object();b.model.each(function(d){var e=d.get("project");if(c[e]!=null){c[e]=c[e]+1}else{c[e]=1}});console.log("drawPieChartProject");window.app.models.projects.fetch({success:function(e,d){b.drawPieChartProject(c,e)}})},drawPieChartTerm:function(h){var b=this;$("#retrievalPieChartTerm").empty();var g=new google.visualization.DataTable();g.addColumn("string","Term");g.addColumn("number","Similarity weighted sum");g.addRows(_.size(h));var e=0;var a=[];for(var d in h){if(h.hasOwnProperty(d)){var f=h[d];var c=b.terms.get(d);g.setValue(e,0,c.get("name"));g.setValue(e,1,f);e++}}new google.visualization.PieChart(document.getElementById("retrievalPieChartTerm")).draw(g,{width:500,height:350,title:""})},drawPieChartProject:function(e,b){var h=this;$("#retrievalPieChartProject").empty();var c=new google.visualization.DataTable();c.addColumn("string","Project");c.addColumn("number","Similarity in project");c.addRows(_.size(e));var d=0;var a=[];console.log(e);for(var g in e){if(e.hasOwnProperty(g)){var f=e[g];var k="Project not accessible";if(b.get(g)!=undefined){k=b.get(g).get("name")}c.setValue(d,0,k);c.setValue(d,1,f);d++}}console.log("creation:"+$("#retrievalPieChartProject").length);new google.visualization.PieChart(document.getElementById("retrievalPieChartProject")).draw(c,{width:500,height:350,title:""})},appendThumbs:function(f){var d=this;var g=0;var a=2500;var e=Math.abs(f)*a;var c=(Math.abs(f)+1)*a;d.annotations=new Array();var b=new AnnotationThumbView({model:d.baseAnnotation,className:"thumb-wrap",id:"annotationthumb"+d.baseAnnotation.get("id")}).render();$(b.el).css("border","50px");$(b.el).css("color","green");$(b.el).css("background-color","green");$("#retrievalThumb").append(b.el);d.model.each(function(h){if((g>=e)&&(g<c)){h.set({name:h.get("similarity")});var k=new AnnotationModel(h);var i=new AnnotationThumbView({model:k,className:"thumb-wrap",id:"annotationthumb"+k.id}).render();$("#retrievalThumb").append(i.el)}g++;d.annotations.push(h.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(b){var a=this;var c=a.annotations;b.each(function(d){if(_.indexOf(a.annotations,d.id)==-1){a.add(d);a.annotations.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){a.remove(d);a.annotations=_.without(a.annotations,d)})}});var AnnotationQuestionableView=Backbone.View.extend({tagName:"div",terms:null,term:null,suggestTerm:null,initialize:function(a){this.container=a.container;this.page=a.page;this.annotations=null;this.terms=a.terms;this.term=a.term;this.suggestTerm=a.suggestTerm;window.app.status.currentTermsCollection=a.terms;if(this.page==undefined){this.page=0}},render:function(){var a=this;console.log("AnnotationQuestionableView: main elem "+$(a.el).length);$("#questionableThumb").replaceWith("");$(a.el).append('<div id="questionableThumb"><div>');$(a.el).dialog({title:a.createTitle(),width:900,height:500,autoOpen:true,modal:true,buttons:{Close:function(){$(a.el).dialog("close")}}});a.createThumbView(a.page);return this},createTitle:function(){var a=this;var c=a.terms.get(a.term).get("name");var b=a.terms.get(a.suggestTerm).get("name");return"Annotation with term "+c+" and algo suggest "+b},createThumbView:function(a){this.appendThumbs(a)},appendThumbs:function(e){var c=this;var f=0;var a=2500;var d=Math.abs(e)*a;var b=(Math.abs(e)+1)*a;c.annotations=new Array();c.model.each(function(g){if((f>=d)&&(f<b)){var i=new AnnotationModel(g);var h=new AnnotationThumbView({model:i,className:"thumb-wrap",id:"annotationthumb"+i.id}).render();$("#questionableThumb").append(h.el)}f++;c.annotations.push(g.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(b){var a=this;var c=a.annotations;b.each(function(d){if(_.indexOf(a.annotations,d.id)==-1){a.add(d);a.annotations.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){a.remove(d);a.annotations=_.without(a.annotations,d)})}});var ShareAnnotationView=Backbone.View.extend({tagName:"div",initialize:function(a){this.image=a.image;this.project=a.project;this.dialog=null},doLayout:function(g,e){var b=this;this.model.set({username:window.app.models.users.get(this.model.get("user")).prettyName()});this.model.set({terms:"undefined"});this.dialog=new ConfirmDialogView({el:"#dialogs",template:_.template(g,this.model.toJSON()),dialogAttr:{dialogID:"#share-confirm"}}).render();var h=$("#selectUserShare"+b.model.id);var f=$("#comments"+b.model.id);var d=$("input[name=shareWithOption]");new AnnotationCommentCollection({annotation:b.model.id}).fetch({success:function(m,l){var k="<ul><li><b>( <%= hour %> )</b> <%= sender %> : <i><%= comment %></i></li></ul>";var i=undefined;m.each(function(p){var o=new Date();o.setTime(p.get("created"));var r=o.toLocaleDateString();if(r!=i){f.append(_.template("<h4><%= date %></h4>",{date:r}));i=r}var n=(o.getHours()<10)?"0"+o.getHours():o.getHours();var q=(o.getMinutes()<10)?"0"+o.getMinutes():o.getMinutes();f.append(_.template(k,{sender:p.get("sender"),comment:p.get("comment"),hour:n+"h"+q}))})},error:function(k,i){}});var a=new UserCollection({project:this.project}).fetch({success:function(l,k){a=l;var i="<option value='<%= id %>'><%= name %></option>";l.each(function(m){h.append(_.template(i,{id:m.id,name:m.prettyName()}))})},error:function(k,i){window.app.view.message("Error",i.message,"error")}});var c=function(){var i=$("input[name=shareWithOption]:checked").val();if(i=="everyone"){var k=[];a.each(function(l){k.push(l.get("id"))});return k}else{if(i=="somebody"){return[h.val()]}}};d.change(function(){var i=$(this).val();if(i=="everyone"){h.attr("disabled","disabled")}else{if(i=="somebody"){h.removeAttr("disabled")}}});$("#shareCancelButton"+b.model.id).click(function(){b.dialog.close();window.history.back();return false});$("#shareButton"+b.model.id).click(function(){var o=$(this);o.html("Sending...");var q=c();var n=(_.size(q)==1)?a.get(q[0]).prettyName():"user";var p=$("#annotationComment"+b.model.id).val();var i=_.template("<%= serverURL %>/#share-annotation/<%= id %>",{serverURL:window.app.status.serverURL,id:b.model.id});var l=_.template("<%= serverURL %>/#tabs-image-<%= idProject %>-<%= idImage %>-<%= idAnnotation %>",{serverURL:window.app.status.serverURL,idProject:b.project,idImage:b.image,idAnnotation:b.model.id});var m=_.template(e,{from:a.get(window.app.status.user.id).prettyName(),to:n,comment:p,annotationURL:l,shareAnnotationURL:i,by:window.app.status.serverURL});var k=_.template("Cytomine : <%= from %> shared an annotation with you",{from:a.get(window.app.status.user.id).prettyName()});new AnnotationCommentModel().save({users:q,annotation:b.model.id,message:m,comment:p,subject:k,annotationURL:l},{success:function(s,r){o.html("Share");window.app.view.message("Success",r.message,"success");b.dialog.close();window.history.back()},error:function(s,r){o.html("Share");window.app.view.message("Error",r.message,"error")}});return false});return this},render:function(){var a=this;require(["text!application/templates/annotation/ShareAnnotationView.tpl.html","text!application/templates/annotation/ShareAnnotationMail.tpl.html"],function(c,b){a.doLayout(c,b)})}});var CrudGridView=Backbone.View.extend({customFields:{color:{colorPickerElement:function(c,a){var b=_.template('<input type="text" name="color" value="<%=   value %>">',{value:c});setTimeout(function(){$("#color").ColorPicker({color:c,onShow:function(d){$(d).fadeIn(500);return false},onSubmit:function(d,g,e,f){$(f).val("#"+g);$(f).ColorPickerHide()},onBeforeShow:function(){$(this).ColorPickerSetColor(this.value)},onHide:function(d){$(d).fadeOut(500);return false}})},200);return b},colorPickerValue:function(b,a,c){if(a==="get"){return $(b).val()}else{if(a==="set"){$("input",b).val(c)}}}}},initialize:function(a){this.title=a.title;this.pager="pager"+this.title;this.colNames=a.colNames;this.colModel=a.colModel;this.url=a.url;this.restURL=a.restURL;if(this.restURL!=undefined&&this.restURL.charAt(this.restURL.length-1)!="/"){this.restURL+="/"}},render:function(){var a=this;require(["text!application/templates/utils/CrudGridView.tpl.html"],function(b){a.doLayout(b)})},doLayout:function(a){var b=_.template(a,{pager:this.pager,title:this.title});$(this.el).html(b);this.initGrid();this.renderTable();this.initToolbar()},initGrid:function(){jQuery.extend(jQuery.jgrid.edit,{ajaxEditOptions:{contentType:"application/json"},recreateForm:true,serializeEditData:function(a){return JSON.stringify(a)},afterSubmit:function(a,c){var b=jQuery.parseJSON(a.responseText);return[true,"",b.d]}});jQuery.extend(jQuery.jgrid.del,{ajaxDelOptions:{contentType:"application/json"},recreateForm:true,serializeEditData:function(a){return JSON.stringify(a)},afterSubmit:function(a,c){var b=jQuery.parseJSON(a.responseText);return[true,"",b.d]}})},initToolbar:function(){var i=this;var c=600;var g=500;var b=$(window).width()/2-(c/2);var f=$(window).height()/2-(g/2);var a=$(i.el).find(".grid");var h=$(this.el).find(".crud-toolbar").find("a[name=add]");h.button({text:true,icons:{primary:"ui-icon-plus"}});h.click(function(){a.jqGrid("editGridRow","new",{top:f,left:b,width:c,height:g,mtype:"POST",reloadAfterSubmit:true,modal:true,closeOnEscape:true,closeAfterAdd:true,url:i.restURL,afterSubmit:function(k,l){var m=$.parseJSON(k.responseText);_.each(l.authorities.split(","),function(n){new UserSecRole({user:m.user.id,role:n}).save()});return[true,"",null]}})});var d=$(this.el).find(".crud-toolbar").find("a[name=edit]");d.button({text:true,icons:{primary:"ui-icon-pencil"}});d.click(function(){var k=a.jqGrid("getGridParam","selrow");var l=a.getRowData(k);if(k!=null){a.jqGrid("editGridRow",k,{top:f,left:b,width:c,height:g,mtype:"PUT",reloadAfterSubmit:true,modal:true,closeOnEscape:true,closeAfterEdit:true,url:i.restURL+l.id})}else{window.app.view.message("Error","Please select a row","error")}});var e=$(this.el).find(".crud-toolbar").find("a[name=delete]");e.button({text:true,icons:{primary:"ui-icon-trash"}});e.click(function(){var k=a.jqGrid("getGridParam","selrow");var l=a.getRowData(k);if(k!=null){a.jqGrid("delGridRow",k,{top:f,left:b,width:c,height:g,mtype:"DELETE",reloadAfterSubmit:false,beforeSubmit:function(m,n){new UserModel({id:m}).fetch({success:function(p,o){var q=p.get("authorities");_.each(q.split(","),function(r){alert(r)})}});alert(m);return[true,""]},modal:true,closeOnEscape:true,closeAfterEdit:true,url:i.restURL+l.id})}else{window.app.view.message("Error","Please select a row","error")}})},renderTable:function(){var a=this;var b=$(a.el).find(".grid");b.jqGrid({datatype:"json",url:this.url,width:900,height:500,colNames:this.colNames,colModel:this.colModel,onSelectRow:function(c){},loadComplete:function(c){b.setGridWidth(Math.max(500,$(a.el).width()-300),true);b.setGridHeight(Math.max(300,$(a.el).height()-500),true)},sortname:"id",viewrecords:true,sortorder:"asc",caption:this.title,modal:false,pager:"#"+this.pager,editurl:a.restURL,jsonReader:{repeatitems:false,id:"0"}});$(window).bind("resize",function(){b.setGridWidth(Math.max(500,$(a.el).width()-300),true);b.setGridHeight(Math.max(300,$(a.el).height()-200),true)}).trigger("resize")}});var Component=Backbone.View.extend({tagName:"div",views:{},initialize:function(a){this.divId=a.divId;this.el=a.el;this.template=a.template;this.buttonAttr=a.buttonAttr;if(a.activate!=undefined){this.activate=a.activate}if(a.deactivate!=undefined){this.deactivate=a.deactivate}if(a.show!=undefined){this.show=a.show}},render:function(){var a=this;$(this.el).append(this.template);return this},activate:function(){$("#"+this.divId).show();$("#"+this.buttonAttr.elButton).parent().addClass("active")},deactivate:function(){$("#"+this.divId).hide();$("#"+this.buttonAttr.elButton).parent().removeClass("active")},show:function(a,e,c){$(e).find(".title.active").each(function(){$(this).removeClass("active")});$(e).find("a[name="+c+"]").addClass("active");for(var d in this.views){var b=this.views[d];if(b!=a){$(b.el).hide()}}$(a.el).show()}});Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))};Storage.prototype.getObject=function(a){return JSON.parse(this.getItem(a))};var ApplicationView=Backbone.View.extend({tagName:"div",className:"layout",components:{},isMobile:(navigator.userAgent.match(/iPad/i)!=null),panelsConfiguration:[{key:"toolbar-panel",linkID:"toggle-toolbar-panel",name:"Toolbar",className:"toolbarPanel",value:{visible:true,position:{bottom:0},align:"center"}},{key:"overview-panel",linkID:"toggle-overview-panel",name:"Overview",className:"overviewPanel",value:{visible:true,position:{right:20,top:325}}},{key:"ontology-panel",linkID:"toggle-ontology-panel",name:"Ontology",className:"ontologyPanel",value:{visible:true,position:{left:20,top:280}}},{key:"layer-panel",linkID:"toggle-layer-panel",name:"Layer switcher",className:"layerSwitcherPanel",value:{visible:false,position:{right:20,top:100}}},{key:"filters-panel",linkID:"toggle-filters-panel",name:"Filters",className:"imageFiltersPanel",value:{visible:false,position:{right:20,bottom:15}}}],events:{},undo:function(){window.app.controllers.command.undo()},redo:function(){window.app.controllers.command.redo()},hideFloatingPanels:function(){_.each(this.panelsConfiguration,function(a){if(a.key=="toolbar-panel"){return}$("."+a.className).hide()})},showFloatingPanels:function(){_.each(this.panelsConfiguration,function(a){if(a.key=="toolbar-panel"){return}$("."+a.className).show()})},toggleVisibility:function(c){var a=this;var b=localStorage.getObject(c.key);b.visible=!b.visible;if(b.visible&&this.isMobile){_.each(a.panelsConfiguration,function(d){if(d.key==c.key){return}var e=false;if(d.key=="toolbar-panel"){e=true}preferencePanel=localStorage.getObject(d.key);preferencePanel.visible=e;localStorage.setObject(d.key,preferencePanel);a.updateMenuItem(d)})}localStorage.setObject(c.key,b);this.updateMenuItem(c)},updateMenuItem:function(b){var a=localStorage.getObject(b.key);if(a!=undefined&&a.visible!=undefined&&a.visible==true){$("#"+b.linkID).html("<i class='icon-eye-close' /> "+b.name);$("."+b.className).each(function(c){$(this).show("fast")})}else{$("#"+b.linkID).html("<i class='icon-eye-open' /> "+b.name);$("."+b.className).each(function(c){$(this).hide("fast")})}},initialize:function(b){var a=null;$(window).resize(function(){if(a){clearTimeout(a)}a=setTimeout(function(){$(window).trigger("resizeEnd")},500)})},doLayout:function(b,c){var a=this;$("body").prepend(_.template(b,{}));_.each(this.components,function(d){d.render()});a.initEvents();c.call();return this},initEvents:function(){$("#undo").live("click",this.undo);$("#redo").live("click",this.redo)},render:function(b){this.initComponents();var a=this;require(["text!application/templates/BaseLayout.tpl.html"],function(c){a.doLayout(c,b)});return this},initPreferences:function(){_.each(this.panelsConfiguration,function(a){if(localStorage.getObject(a.key)){return}localStorage.setObject(a.key,a.value)})},applyPreferences:function(){var a=this;_.each(a.panelsConfiguration,function(b){a.updatePanelPosition(b,true);a.updateMenuItem(b)})},updatePanelPosition:function(k,i){var e=localStorage.getObject(k.key);if(e==undefined){return}if(this.isMobile){if(k.key=="toolbar-panel"){e.position.bottom=0}else{e.position.bottom=40}if(k.key!="toolbar-panel"){e.position.right=5}else{delete e.position.right}delete e.position.left;delete e.position.top}else{if(k.key=="toolbar-panel"){delete e.position.right;delete e.position.left;delete e.position.top;e.position.bottom=0}}var b=0;var h=0;$.each($("."+k.className),function(m,o){var n=$(o).width();var l=$(o).height();if(n>0){b=n}if(l>0){h=l}});var c=$("."+k.className);var d=$(window).width();var a=$(window).height();if(b!=0&&e.align!=undefined&&e.align=="center"){var g=(d/2)-(b/2);e.position.left=g}if(b!=0&&e.position.left+b>d){e.position.left=d-b}if(h!=0&&e.position.top+h>a){e.position.top=a-h}localStorage.setObject(k.key,e);var f=e.position;if(f.top==undefined){f.top=""}$("."+k.className).css("top",f.top);if(f.left==undefined){f.left=""}$("."+k.className).css("left",f.left);if(f.right==undefined){f.right=""}$("."+k.className).css("right",f.right);if(f.bottom==undefined){f.bottom=""}$("."+k.className).css("bottom",f.bottom);if(i){$("."+k.className).trigger("movedProgramatically")}},updatePosition:function(e,a,b){var c=this;var f=_.find(c.panelsConfiguration,function(g){return g.className==e});if(!f){return}var d=localStorage.getObject(f.key);d.position=a;localStorage.setObject(f.key,d);c.updatePanelPosition(f,b)},initUserMenu:function(){var a=this;require(["text!application/templates/MenuDropDown.tpl.html"],function(b){$("#menu-right").append(b);$("#logout").click(function(){window.app.controllers.auth.logout();return false});$("#loggedUser").html(window.app.status.user.model.prettyName());_.each(a.panelsConfiguration,function(c){a.updateMenuItem(c);$("#"+c.linkID).on("click",function(){a.toggleVisibility(c);a.updatePanelPosition(c,true)})});$("#toggle-floating-panel").on("click",function(){var d="toggle-floating-panel";var c=localStorage.getObject(d);c.activated=!c.activated;localStorage.setObject(d,c)})})},initComponents:function(){var a=this;require(["text!application/templates/upload/UploadComponent.tpl.html","text!application/templates/project/ProjectComponent.tpl.html","text!application/templates/ontology/OntologyComponent.tpl.html","text!application/templates/explorer/ExplorerComponent.tpl.html","text!application/templates/AdminComponent.tpl.html","text!application/templates/activity/ActivityComponent.tpl.html","text!application/templates/account/AccountComponent.tpl.html"],function(f,d,g,e,h,c,b){a.components.activity=new Component({el:"#content",template:_.template(c,{}),buttonAttr:{elButton:"activity-button"},divId:"activity"});a.components.upload=new Component({el:"#content",template:_.template(f,{}),buttonAttr:{elButton:"upload-button"},divId:"upload"});a.components.account=new Component({el:"#content",template:_.template(b,{}),buttonAttr:{elButton:"upload-button"},divId:"account"});a.components.project=new Component({el:"#content",template:_.template(d,{}),buttonAttr:{elButton:"project-button"},divId:"project"});a.components.ontology=new Component({el:"#content",template:_.template(g,{}),buttonAttr:{elButton:"ontology-button"},divId:"ontology"});a.components.explorer=new Component({el:"#content",template:_.template(e,{}),buttonAttr:{elButton:"explorer-button"},divId:"explorer",activate:function(){if(window.app.status.currentProject==undefined){$("#explorer > .noProject").show()}else{$("#explorer > .noProject").hide()}$("#"+this.divId).show();$("#"+this.buttonAttr.elButton).parent().addClass("active")}})})},showComponent:function(a){_.each(this.components,function(b){if(b!=a){b.deactivate()}});$("#app").show();a.activate()}});ApplicationView.prototype.message=function(e,c,b){if(b==""||b==undefined){b="alert-info"}else{b="alert-"+b}if(c!=undefined){c.responseText&&(c=c.responseText)}var a='<div style="min-width: 200px" id="alert<%=   timestamp %>" class="alert <%=   type %> fade in" data-alert="alert"><a class="close" data-dismiss="alert">×</a><p><strong><%=   alert %></strong> <%=   message %></p></div>';var d=new Date().getTime();$("#alerts").append(_.template(a,{alert:e,message:c,timestamp:d,type:b}));$("#alert"+d).alert();setTimeout(function(){$("#alert"+d).remove()},1500)};var ConfirmDialogView=Backbone.View.extend({tagName:"div",templateURL:null,templateData:null,initialize:function(a){this.el=a.el;this.template=a.template;this.templateURL=a.templateURL;this.autoOpen=a.autoOpen;this.templateData=a.templateData;this.dialogAttr=a.dialogAttr;if(a.dialogAttr.autoOpen==undefined){this.dialogAttr.autoOpen=true}if(!a.dialogAttr.width){this.dialogAttr.width="auto"}if(!a.dialogAttr.height){this.dialogAttr.height="auto"}},doLayout:function(b){var a=this;$(this.el).html(b);$(this.dialogAttr.dialogID).modal({keyboard:true,show:true,backdrop:(this.dialogAttr.backdrop!=undefined)?this.dialogAttr.backdrop:true});$(this.dialogAttr.dialogID).on("hidden",function(){$(a.dialogAttr.dialogID).remove()})},render:function(){var a=this;if(this.template==null&&this.templateURL!=null&&this.templateData!=null){require([this.templateURL],function(b){a.template=_.template(b,a.templateData);a.doLayout(a.template)})}else{this.doLayout(this.template)}return this},close:function(){$(this.dialogAttr.dialogID).modal("hide");$(this.dialogAttr.dialogID).remove()}});