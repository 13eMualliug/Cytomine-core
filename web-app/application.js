var Watcher=function(b,d,a){_.bindAll(this,"fetch","destroy");var c=this;this.model=b;this.callback=d;this.interval=a||1000;this.current=JSON.stringify(this.model);this.watcher=setInterval(this.fetch,this.interval)};Watcher.prototype.fetch=function(){var a=this;this.model.fetch({silent:true,success:function(){var b=JSON.stringify(a.model);if(a.current!==b){a.current=b;a.callback&&a.callback()}},error:function(){}})};Watcher.prototype.destroy=function(){window.clearInterval(this.watcher)};var Status=function(c,a,d,b){_.bindAll(this,"start","error","stop");this.url=c;this.errorcallback=a;this.successcallback=d;this.interval=b||1000;this.start()};Status.prototype.start=function(){var a=this;var c=function(){$.ajax({url:a.url,type:"GET",success:a.successcallback,error:a.error})};if(!this.watcher){var b=this;this.watcher=setInterval(c,this.interval)}};Status.prototype.error=function(){this.stop();this.errorcallback(this)};Status.prototype.stop=function(){if(this.watcher){window.clearInterval(this.watcher);delete this.watcher}};var AnnotationsPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.refreshAnnotationsTabsFunc=[]},render:function(){var a=this;require(["text!application/templates/explorer/AnnotationsPanel.tpl.html"],function(b){a.doLayout(b)});return this},createTabs:function(b){var a=this;require(["text!application/templates/explorer/TermTab.tpl.html","text!application/templates/explorer/TermTabContent.tpl.html"],function(c,d){new TermCollection({idOntology:b}).fetch({success:function(g,e){window.app.status.currentTermsCollection=g;a.addTermToTab(c,d,{id:"all",image:a.model.id,name:"All"});a.refreshAnnotationsTabsFunc.push({index:0,idTerm:"all",refresh:function(){a.refreshAnnotations(undefined,$("#tabsterm-"+a.model.id+"-all"))}});var f=1;g.each(function(h){a.addTermToTab(c,d,{id:h.get("id"),image:a.model.id,name:h.get("name")});a.refreshAnnotationsTabsFunc.push({index:f,idTerm:h.get("id"),refresh:function(){a.refreshAnnotations(h.get("id"),$("#tabsterm-"+a.model.id+"-"+h.get("id")))}});f++});$("#annotationsPanel"+a.model.id).find(".tabsAnnotation").tabs({add:function(h,i){},select:function(h,i){var j=_.detect(a.refreshAnnotationsTabsFunc,function(k){return(k.index==i.index)});j.refresh.call()}});$("#annotationsPanel"+a.model.id).find(".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *").removeClass("ui-corner-all ui-corner-top").addClass("ui-corner-bottom");a.initAnnotations()}})})},refreshAnnotationTabs:function(b){var a=this;if(b!=undefined){var d=_.detect(a.refreshAnnotationsTabsFunc,function(e){return(e.idTerm==b)});d.refresh.call()}else{var c=$("#annotationsPanel"+a.model.id).find(".tabsAnnotation").tabs("option","selected");a.refreshAnnotationsTabsFunc[c].refresh.call()}},refreshAnnotations:function(a,b){new AnnotationCollection({image:this.model.id,term:a}).fetch({success:function(e,d){b.empty();var c=new AnnotationView({page:undefined,model:e,el:b}).render()}})},addTermToTab:function(a,c,b){$("#annotationsPanel"+this.model.id).find(".ultabsannotation").append(_.template(a,b));$("#annotationsPanel"+this.model.id).find(".listtabannotation").append(_.template(c,b))},initAnnotations:function(){var a=this;new AnnotationCollection({image:a.model.id}).fetch({success:function(c,b){a.refreshAnnotations(undefined,$("#tabsterm-"+a.model.id+"-all"))}})},doLayout:function(b){var a=this;var d=$("#annotationsPanel"+a.model.get("id"));var c=parseInt($(window).width());d.html(_.template(b,{id:a.model.get("id")}));new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(f,e){a.createTabs(f.get("ontology"))}});d.css("padding","0px");d.css("margin","0px");d.css("width","20px");d.css("height","20px");d.css("bottom","0px");d.find("div.panel_button").click(function(){d.find("div.panel_button").toggle();d.css("bottom","0px");d.animate({height:"250px"},"fast").animate({width:c});setTimeout(function(){d.find("div.panel_content").fadeIn()},1000);return false});d.find("div#refresh_annotations_button").click(function(){var f=d.find(".tabsAnnotation").tabs("option","selected");var e=_.detect(a.refreshAnnotationsTabsFunc,function(g){return(g.index==f)});e.refresh.call()});d.find("div#hide_button").click(function(){d.animate({height:"20px"},"fast").animate({width:"20px"},"fast");setTimeout(function(){d.find("div.panel_content").hide();d.css("bottom","0px")},1000);return false});d.find("div.previous_button").click(function(){alert("prev"+a.currentAnnotation)});d.find("div.next_button").click(function(){alert("next"+a.currentAnnotation)});return this}});var ApplicationController=Backbone.Router.extend({models:{},controllers:{},view:null,status:{},routes:{"":"initialRoute",explorer:"explorer",admin:"admin"},startup:function(){var a=this;a.view=new ApplicationView({el:$("#app")});var b=new LoadingDialogView();a.models.images=new ImageCollection({project:undefined});a.models.imagesinstance=new ImageInstanceCollection({project:undefined});a.models.slides=new SlideCollection({project:undefined});a.models.users=new UserCollection({project:undefined});a.models.terms=new TermCollection({project:undefined});a.models.ontologies=new OntologyCollection();a.models.projects=new ProjectCollection({user:undefined});a.models.annotations=new AnnotationCollection({});var d=[a.models.users];if(_.size(d)==0){a.modelFetched(0,0,b)}else{b.initProgressBar();var c=0;_.each(d,function(e){e.fetch({success:function(g,f){a.modelFetched(++c,_.size(d),b)}})})}},modelFetched:function(e,c,b){var a=100/c;var d=e*a;if(e==c){this.view.render(this.start)}},start:function(){window.app.controllers.image=new ImageController();window.app.controllers.project=new ProjectController();window.app.controllers.dashboard=new DashboardController();window.app.controllers.browse=new ExplorerController();window.app.controllers.ontology=new OntologyController();window.app.controllers.upload=new UploadController();window.app.controllers.command=new CommandController();window.app.controllers.annotation=new AnnotationController();window.app.view.initUserMenu();Backbone.history.start()},initialize:function(){var a=this;a.controllers.auth=new AuthController();require(["text!application/templates/ServerDownDialog.tpl.html"],function(d){var c=function(f){$("#app").fadeOut("slow");var g=new ConfirmDialogView({el:"#dialogs",template:d,dialogAttr:{dialogID:"#server-down"}}).render()};var e=function(f){a.status.version=f.version;a.status.serverURL=f.serverURL;if(f.authenticated){new UserModel({id:f.user}).fetch({success:function(h,g){a.status.user={id:f.user,authenticated:f.authenticated,model:h};a.startup()}})}else{a.controllers.auth.login()}};var b="server/ping";$.ajax({url:b,type:"GET",success:e});a.status=new Status(b,c,function(){},10000)})},explorer:function(){this.view.showComponent(this.view.components.explorer)},admin:function(){this.view.showComponent(this.view.components.admin)},warehouse:function(){this.view.showComponent(this.view.components.warehouse)},initialRoute:function(){this.controllers.project.project()}});var UploadController=Backbone.Router.extend({initialized:false,routes:{upload:"upload"},upload:function(){if(!this.initialized){this.initForm();this.initialized=true}window.app.view.showComponent(window.app.view.components.upload)},initForm:function(){new UploadFormView({el:$("#upload")}).render()}});var AuthController=Backbone.Router.extend({routes:{},login:function(){var a=new LoginDialogView({}).render()},logout:function(){var a=new LogoutDialogView({}).render()},doLogin:function(){var b=new ApplicationView();var a=$("#login-form").serialize();$.ajax({url:"j_spring_security_check",type:"post",dataType:"json",data:a,success:function(c){b.message("Welcome","You are logged as "+c.fullname,"","success");$("#login-confirm").modal("hide");new UserModel({id:c.id}).fetch({success:function(e,d){window.app.status.user={authenticated:true,id:c.id,model:e};window.app.startup()}})},error:function(c){var d=$.parseJSON(c.responseText);$("#login-confirm").effect("shake",{times:2},100);b.message("Error",d.message,"error")}});return false}});var ProjectController=Backbone.Router.extend({manageView:null,routes:{project:"project","project-manage-:idProject":"manage"},initView:function(b){var a=this;window.app.models.ontologies.fetch({success:function(d,c){window.app.models.projects.fetch({success:function(f,e){a.view=new ProjectView({model:f,ontologies:d,el:$("#warehouse > .project"),container:window.app.view.components.warehouse}).render();a.view.container.views.project=a.view;if(_.isFunction(b)){b.call()}}})}})},project:function(){var a=this;$("#warehouse-button").attr("href","#project");$("#addimagediv").hide();$("#projectdiv").show();if(!this.view){this.initView(function(){a.view.container.show(a.view,"#warehouse > .sidebar","project");window.app.view.showComponent(window.app.view.components.warehouse)});return}else{a.view.refresh()}a.view.container.show(a.view,"#warehouse > .sidebar","project");window.app.view.showComponent(window.app.view.components.warehouse)},manage:function(b){var a=this;if(a.view==undefined){a.project()}$("#projectdiv").hide();$("#addimagediv").show();new ProjectModel({id:b}).fetch({success:function(d,c){a.manageView=new ProjectManageSlideDialog({model:d,projectPanel:null,el:$("#warehouse > .project")}).render()}})}});var DashboardController=Backbone.Router.extend({view:null,routes:{"tabs-images-:project":"images","tabs-images-:project/:page":"imagespage","tabs-thumbs-:project":"imagesthumbs","tabs-imagesarray-:project":"imagesarray","tabs-annotations-:project-:terms-:users":"annotations","tabs-annotations-:project":"annotations","tabs-dashboard-:project":"dashboard","tabs-algos-:project":"algos"},init:function(a,b){if(window.app.status.currentProject!=undefined&&window.app.status.currentProject!=a){this.destroyView();window.app.controllers.browse.closeAll();window.app.status.currentProject=undefined}if(window.app.status.currentProject==undefined){window.app.status.currentProject=a;window.app.controllers.browse.initTabs();if(this.view==null){this.createView(b)}this.showView()}else{b.call();this.showView()}},images:function(c){var a=this;var b=function(){a.view.refreshImagesThumbs();var d=$("#explorer > .browser").children(".tabs");d.tabs("select","#tabs-images-"+window.app.status.currentProject)};this.init(c,b)},imagespage:function(d,c){var a=this;var b=function(){a.view.changeImagePage(c);a.view.showImagesThumbs();var e=$("#explorer > .browser").children(".tabs");e.tabs("select","#tabs-images-"+window.app.status.currentProject)};this.init(d,b)},imagesthumbs:function(c){var a=this;var b=function(){a.view.refreshImagesTable();a.view.showImagesThumbs();var d=$("#explorer > .browser").children(".tabs");d.tabs("select","#tabs-images-"+window.app.status.currentProject)};this.init(c,b)},imagesarray:function(c){var a=this;var b=function(){a.view.refreshImagesTable();a.view.showImagesTable();var d=$("#explorer > .browser").children(".tabs");d.tabs("select","#tabs-images-"+window.app.status.currentProject)};this.init(c,b)},annotations:function(d,c,e){var a=this;var b=function(){var f=$("#explorer > .browser").children(".tabs");window.app.controllers.browse.tabs.triggerRoute=false;f.tabs("select","#tabs-annotations-"+window.app.status.currentProject);window.app.controllers.browse.tabs.triggerRoute=true;a.view.refreshAnnotations(c,e)};this.init(d,b)},algos:function(c){var a=this;var b=function(){a.view.refreshAlgos();var d=$("#explorer > .browser").children(".tabs");d.tabs("select","#tabs-algos-"+window.app.status.currentProject)};this.init(c,b)},dashboard:function(c,d){var a=this;var b=function(){a.view.refreshDashboard();var e=$("#explorer > .browser").children(".tabs");e.tabs("select","#tabs-dashboard-"+window.app.status.currentProject);if(d!=undefined){d.call()}};this.init(c,b)},createView:function(c){var b=$("#explorer > .browser").children(".tabs");var a=this;new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(e,d){window.app.status.currentProjectModel=e;a.view=new ProjectDashboardView({model:e,el:b}).render();c.call()}})},destroyView:function(){this.view=null},showView:function(){$("#explorer > .browser").show();$("#explorer > .noProject").hide();window.app.view.showComponent(window.app.view.components.explorer)}});var ImageController=Backbone.Router.extend({routes:{image:"image","image/p:page":"image"},image:function(a){if(!this.view){this.view=new ImageView({page:a,model:window.app.models.images,el:$("#warehouse > .image"),container:window.app.view.components.warehouse}).render();this.view.container.views.image=this.view}this.view.container.show(this.view,"#warehouse > .sidebar","image");window.app.view.showComponent(window.app.view.components.warehouse)}});var ExplorerController=Backbone.Router.extend({tabs:null,routes:{"tabs-image-:idProject-:idImage-:idAnnotation":"browse",close:"close"},initialize:function(){},initTabs:function(){if(this.tabs==null){this.tabs=new ExplorerTabs({el:$("#explorer > .browser"),container:window.app.view.components.explorer}).render()}},browse:function(e,d,a){var c=this;this.initTabs();var b=function(){var f={};if(a!=""){f.goToAnnotation={value:a}}c.tabs.addBrowseImageView(d,f);c.tabs.triggerRoute=false;var g=$("#explorer > .browser").children(".tabs");g.tabs("select","#tabs-image-"+window.app.status.currentProject+"-"+d+"-");c.tabs.triggerRoute=true;window.app.view.showComponent(c.tabs.container);c.showView()};if(window.app.status.currentProject==undefined){window.app.controllers.dashboard.dashboard(e,b);return}b()},closeAll:function(){if(this.tabs==null){return}this.tabs=null;$("#explorer > .browser").empty()},showView:function(){$("#explorer > .browser").show();$("#explorer > .noProject").hide();window.app.view.showComponent(window.app.view.components.explorer)}});var TermController=Backbone.Router.extend({routes:{term:"term","term/o:ontology":"term"},term:function(a){if(!this.view){this.view=new TermView({model:window.app.models.terms,ontology:a,el:$("#explorer > .term"),container:window.app.view.components.explorer}).render();this.view.container.views.term=this.view}this.view.container.show(this.view)}});var OntologyController=Backbone.Router.extend({routes:{ontology:"ontology","ontology/:idOntology":"ontology","ontology/:idOntology/:idTerm":"ontology"},ontology:function(){this.ontology(0,0,false)},ontology:function(a){this.ontology(a,0,false)},ontology:function(a,b){this.ontology(a,b,false)},ontology:function(b,c,d){var a=this;if(!a.view){a.view=new OntologyView({model:window.app.models.ontologies,el:$("#warehouse > .ontology"),container:window.app.view.components.warehouse,idOntology:b,idTerm:c}).render();a.view.container.views.ontology=a.view;a.view.container.show(a.view,"#warehouse > .sidebar","ontology");$("#warehouse-button").attr("href","#ontology");window.app.view.showComponent(window.app.view.components.warehouse);a.view.refresh(b,c)}else{a.view.container.show(a.view,"#warehouse > .sidebar","ontology");window.app.view.showComponent(window.app.view.components.warehouse);if(d){window.app.models.ontologies.fetch({success:function(f,e){a.view.select(b)}})}else{a.view.select(b,c)}}}});var CommandController=Backbone.Router.extend({initialize:function(){this.commandInProgess=false},undo:function(){var a=this;if(a.commandInProgess){window.app.view.message("Oh wait :-)","Operation already in progress","error");return}a.commandInProgess=true;$.post("command/undo.json",{},function(b){_.each(b,function(c){a.dispatch(c.callback,c.message,"Undo");if(c.printMessage){window.app.view.message("Undo",c.message,"info")}a.commandInProgess=false})},"json")},redo:function(){var a=this;if(a.commandInProgess){window.app.view.message("Oh wait :-)","Operation already in progress","error");return}a.commandInProgess=true;$.post("command/redo.json",{},function(b){_.each(b,function(c){a.dispatch(c.callback,c.message,"Redo");if(c.printMessage){window.app.view.message("Redo",c.message,"info")}});a.commandInProgess=false},"json")},dispatch:function(e,c,a){if(!e){return}if(e.method=="be.cytomine.AddAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationAdded(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.EditAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationUpdated(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.DeleteAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationRemoved(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.AddAnnotationTermCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().termAdded(e.annotationID,e.termID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.DeleteAnnotationTermCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().termRemoved(e.annotationID,e.termID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(e.method=="be.cytomine.AddOntologyCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.DeleteOntologyCommand"){window.app.controllers.ontology.view.refresh()}else{if(e.method=="be.cytomine.EditOntologyCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.AddProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.DeleteProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.EditProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.AddTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.DeleteTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.EditTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.AddImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.DeleteImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.EditImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}}}}}}}}}}}}}}}}}}});var AnnotationController=Backbone.Router.extend({routes:{annotation:"annotation","annotation/:idAnnotation":"annotation"},annotation:function(a){var b=this;if(!b.view){window.app.models.images.fetch({success:function(d,c){b.view=new AnnotationListView({model:d,el:$("#warehouse > .annotation"),container:window.app.view.components.warehouse,idAnnotation:a}).render();b.view.container.views.annotation=b.view;b.view.container.show(b.view,"#warehouse > .sidebar","annotation");window.app.view.showComponent(window.app.view.components.warehouse)}})}}});var AdminController=Backbone.Router.extend({initialize:function(){},routes:{"admin/users":"users","admin/groups":"groups"},users:function(){var b="authorities"+(new Date()).getTime();var a=new SecRoleCollection().fetch({success:function(g,c){var d=function(k,h){var j=k.split(",");var l="";g.each(function(m){if(_.contains(j,m.get("authority"))){l+=_.template("<option value='<%=   id %>' selected><%=   authority %></option>",{id:m.get("id"),authority:m.get("authority")})}else{l+=_.template("<option value='<%=   id %>' ><%=   authority %></option>",{id:m.get("id"),authority:m.get("authority")})}});var i=_.template('<select class="<%=   selectClass %>" title="" multiple="multiple" name="example-basic" size="5" style="display:none;"><%=   authorities %></select>',{selectClass:b,authorities:l});setTimeout(function(){},200);return i};var f=function(j,i,k){if(i==="get"){var h=[];return h.join(",")}else{if(i==="set"){}}};if(window.app.view.components.admin.views.usersGrid==undefined){var e=new CrudGridView({el:"#admin > .admin-users",url:"api/user/grid",restURL:"api/user",title:"Users",colName:["id","username","firstname","email","password","authorities","color"],colModel:[{name:"id",index:"id",width:30},{name:"username",index:"username",editable:true,width:50},{name:"firstname",index:"firstname",editable:true,width:50},{name:"lastname",index:"lastname",editable:true,width:50},{name:"email",index:"email",editable:true,width:80},{name:"password",index:"password",editable:true,width:30,edittype:"password"},{name:"color",index:"color",editable:true,width:30,edittype:"custom",editoptions:{custom_element:new CrudGridView({}).customFields.color.colorPickerElement,custom_value:new CrudGridView({}).customFields.color.colorPickerValue}}]});e.render();window.app.view.components.admin.views.usersGrid=e}window.app.view.components.admin.show(window.app.view.components.admin.views.usersGrid,"#admin > .sidebar","users");$("#admin-button").attr("href","#admin/users");window.app.view.showComponent(window.app.view.components.admin)}})},groups:function(){if(window.app.view.components.admin.views.groupsGrid==undefined){var a=new CrudGridView({el:"#admin > .admin-groups",url:"api/group/grid",editurl:"api/group",title:"Groups",colName:["id","name"],colModel:[{name:"id",index:"id",width:20},{name:"name",index:"name",editable:true,width:50}]});a.render();window.app.view.components.admin.views.groupsGrid=a}window.app.view.components.admin.show(window.app.view.components.admin.views.groupsGrid,"#admin > .sidebar","groups");$("#admin-button").attr("href","#admin/groups");window.app.view.showComponent(window.app.view.components.admin)}});var ImageModel=Backbone.Model.extend({url:function(){var a="api/image";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ImagePropertyCollection=Backbone.Collection.extend({initialize:function(a){this.image=a.image},url:function(){return"api/image/"+this.image+"/property.json"}});var ImageCollection=Backbone.Collection.extend({model:ImageModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/image.json"}else{return"api/currentuser/image.json"}},initialize:function(a){this.project=a.project}});var ImageServerUrlsModel=Backbone.Model.extend({url:function(){return"api/image/"+this.id+"/imageservers.json"}});var ImageInstanceModel=Backbone.Model.extend({url:function(){if(this.project==undefined&&this.baseImage==undefined){var a="api/imageinstance";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}else{return"api/project/"+this.project+"/image/"+this.baseImage+"/imageinstance.json"}},initialize:function(a){this.project=a.project;this.baseImage=a.baseImage}});var ImageInstanceCollection=Backbone.Collection.extend({model:ImageModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/imageinstance.json"}else{return"api/imageinstance.json"}},initialize:function(a){this.project=a.project}});var TermModel=Backbone.Model.extend({url:function(){var a="api/term";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationTermModel=Backbone.Model.extend({url:function(){if(this.term==null){return"api/annotation/"+this.annotation+"/term.json"}else{if(this.clear!=null){return"api/annotation/"+this.annotation+"/term/"+this.term+"/clearBefore.json"}else{return"api/annotation/"+this.annotation+"/term/"+this.term+".json"}}},initialize:function(a){this.annotation=a.annotation;this.term=a.term;this.clear=a.clear}});var AnnotationTermCollection=Backbone.Collection.extend({model:TermModel,url:function(){console.log("this.idUser="+this.idUser+" this.idNotThisUser="+this.idNotThisUser);if(this.idUser==null){return"api/annotation/"+this.idAnnotation+"/term.json"}else{if(this.idUser!=undefined){return"api/annotation/"+this.idAnnotation+"/user/"+this.idUser+"/term.json"}}},initialize:function(a){this.idAnnotation=a.idAnnotation;this.idUser=a.idUser}});var RelationTermModel=Backbone.Model.extend({url:function(){if(this.term==null){return"api/annotation/"+this.annotation+"/term.json"}else{return"api/annotation/"+this.annotation+"/term/"+this.term+".json"}},initialize:function(a){this.annotation=a.annotation;this.term=a.term}});var RelationTermCollection=Backbone.Collection.extend({model:TermModel,url:function(){return"api/annotation/"+this.idAnnotation+"/term.json"},initialize:function(a){this.idAnnotation=a.idAnnotation}});var TermCollection=Backbone.Collection.extend({model:TermModel,CLASS_NAME:"be.cytomine.ontology.Term",url:function(){if(this.idOntology==undefined&&this.idAnnotation==undefined){return"api/term.json"}else{if(this.idOntology!=undefined&&this.idAnnotation==undefined){return"api/ontology/"+this.idOntology+"/term.json"}else{if(this.idOntology!=undefined&&this.idAnnotation!=undefined){return"api/annotation/"+this.idAnnotation+"/ontology/"+this.idOntology+"/term.json"}}}},initialize:function(a){this.idOntology=a.idOntology;this.idAnnotation=a.idAnnotation}});var OntologyModel=Backbone.Model.extend({url:function(){var a="api/ontology";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var OntologyCollection=Backbone.Collection.extend({model:OntologyModel,CLASS_NAME:"be.cytomine.ontology.Ontology",url:function(){if(this.light==undefined){return"api/currentuser/ontology.json"}else{return"api/currentuser/ontology/light.json"}},initialize:function(a){if(a!=undefined){this.light=a.light}},comparator:function(a){return a.get("name")}});var UserModel=Backbone.Model.extend({url:function(){var a="api/user";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},prettyName:function(){return this.get("firstname")+" "+this.get("lastname")}});var UserCollection=Backbone.Collection.extend({model:UserModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/user.json"}else{return"api/user.json"}},initialize:function(a){this.project=a.project}});var UserSecRole=Backbone.Model.extend({url:function(){if(this.role!=undefined||this.isNew()){return"api/user/"+this.user+"/role.json"}else{return"api/user/"+this.user+"/role/"+this.role+".json"}},initialize:function(a){this.user=a.user;this.role=a.role}});var ImageFilterModel=Backbone.Model.extend({url:function(){var a="api/imagefilter";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ImageFilterCollection=Backbone.Collection.extend({model:ImageFilterModel,url:function(){return"api/imagefilter.json"}});var ProjectImageFilterModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.isNew()){return"api/project/"+this.project+"/imagefilter.json"}else{if(this.project!=undefined&&this.imageFilter!=undefined){return"api/project/"+this.project+"/imagefilter/"+this.imageFilter+".json"}}},initialize:function(a){this.id=a.id;this.project=a.project;this.imageFilter=a.imageFilter}});var ProjectImageFilterCollection=Backbone.Collection.extend({model:ImageFilterModel,url:function(){return"api/project/"+this.project+"/imagefilter.json"},initialize:function(a){this.project=a.project}});var ProjectModel=Backbone.Model.extend({url:function(){var a="api/project";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ProjectUserModel=Backbone.Model.extend({url:function(){if(this.user==undefined){return"api/project/"+this.project+"/user.json"}else{return"api/project/"+this.project+"/user/"+this.user+".json"}},initialize:function(a){this.project=a.project;this.user=a.user}});var OntologyProjectModel=Backbone.Collection.extend({model:ProjectModel,url:function(){return"api/ontology/"+this.ontology+"/project.json"},initialize:function(a){this.ontology=a.ontology}});var ProjectCollection=Backbone.Collection.extend({model:ProjectModel,url:function(){if(this.user!=undefined){return"api/user/"+this.user+"/project.json"}else{if(this.ontology!=undefined){return"api/ontology/"+this.ontology+"/project.json"}else{return"api/currentuser/project.json"}}},initialize:function(a){this.user=a.user;this.ontology=a.ontology},comparator:function(a){return a.get("name")}});var AnnotationModel=Backbone.Model.extend({url:function(){var a="api/annotation";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationModel=Backbone.Model.extend({url:function(){var a="api/annotation";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationCropModel=Backbone.Model.extend({url:null,initialize:function(a){this.url=a.url}});var AnnotationCollection=Backbone.Collection.extend({model:AnnotationModel,url:function(){if(this.user!=undefined){return"api/user/"+this.user+"/imageinstance/"+this.image+"/annotation.json"}else{if(this.term!=undefined&&this.project!=undefined){if(this.term=="0"&&this.users==undefined){return"api/project/"+this.project+"/annotation.json?noTerm=true"}if(this.term=="0"&&this.users!=undefined){return"api/project/"+this.project+"/annotation.json?noTerm=true&users="+this.users.join("_")}if(this.term!="0"&&this.users==undefined){return"api/term/"+this.term+"/project/"+this.project+"/annotation.json"}if(this.term!="0"&&this.users!=undefined){console.log("good url");return"api/term/"+this.term+"/project/"+this.project+"/annotation.json?users="+this.users.join("_")}return"error"}else{if(this.project!=undefined){return"api/project/"+this.project+"/annotation.json"}else{if(this.image!=undefined&&this.term!=undefined){return"api/term/"+this.term+"/imageinstance/"+this.image+"/annotation.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/annotation.json"}else{if(this.image!=undefined){return"api/imageinstance/"+this.image+"/annotation.json"}else{return"api/annotation.json"}}}}}}},initialize:function(a){this.image=a.image;this.user=a.user;this.project=a.project;this.term=a.term;this.users=a.users},comparator:function(a){return -a.get("id")}});AnnotationCollection.comparator=function(a){return a.get("created")};var AnnotationRetrievalModel=Backbone.Model.extend({url:function(){return"api/annotation/"+this.annotation+"/retrieval.json"},initialize:function(a){this.annotation=a.annotation}});var AnnotationRetrievalCollection=Backbone.Collection.extend({model:AnnotationModel,initialize:function(a){this.annotation=a.annotation},comparator:function(a){return -a.get("similarity")}});var SlideModel=Backbone.Model.extend({url:function(){var a="api/slide";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ProjectSlideModel=Backbone.Model.extend({url:function(){if(this.slide==null){return"api/project/"+this.project+"/slide.json"}else{return"api/project/"+this.project+"/slide/"+this.slide+".json"}},initialize:function(a){this.project=a.project;this.slide=a.slide}});var ProjectSlideCollection=Backbone.Collection.extend({model:SlideModel,url:function(){return"api/project/"+this.idProject+"/slide.json"},initialize:function(a){this.idProject=a.idProject}});var SlideCollection=Backbone.Collection.extend({model:SlideModel,CLASS_NAME:"be.cytomine.image.Slide",url:function(){if(this.page==null){return"api/currentuser/slide.json"}else{return"api/currentuser/slide.json?page="+this.page+"&limit="}},initialize:function(a){this.page=a.page;this.limit=a.limit;this.sidx=a.sidx;this.sord=a.sord}});var BeginTransactionModel=Backbone.Model.extend({url:function(){var a="transaction/begin";var b=".json";return a+b}});var EndTransactionModel=Backbone.Model.extend({url:function(){var a="transaction/end";var b=".json";return a+b}});var SuggestedAnnotationTermModel=Backbone.Model.extend({url:function(){return"api/annotation/term/suggest.json"}});var SuggestedAnnotationTermCollection=Backbone.Collection.extend({model:SuggestedAnnotationTermModel,url:function(){return"api/project/"+this.project+"/annotation/term/suggest.json?max="+this.max},initialize:function(a){this.project=a.project;this.max=a.max},comparator:function(a){return -Number(a.get("rate"))}});var SuggestedTermCollection=Backbone.Collection.extend({model:SuggestedAnnotationTermModel,url:function(){return"api/project/"+this.project+"/term/suggest.json"},initialize:function(a){this.project=a.project},comparator:function(a){return -Number(a.get("rate"))}});var StatsModel=Backbone.Model.extend({url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/term.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/project/stat.json"}else{return"api/stat.json"}}},initialize:function(a){this.project=a.project;this.term=a.term}});var StatsTermCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/term.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/project/stat.json"}else{return"api/stat.json"}}},initialize:function(a){this.project=a.project;this.term=a.term}});var StatsUserCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/user.json"}},initialize:function(a){this.project=a.project}});var StatsUserAnnotationCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/userannotations.json"}},initialize:function(a){this.project=a.project}});var StatsTermSlideCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/termslide.json"}},initialize:function(a){this.project=a.project}});var StatsUserSlideCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/userslide.json"}},initialize:function(a){this.project=a.project}});var CommandModel=Backbone.Model.extend({url:function(){var a="api/command";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var CommandCollection=Backbone.Collection.extend({model:CommandModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/last/"+this.max+".json"}else{return"api/command.json"}},initialize:function(a){this.project=a.project;this.max=a.max}});CommandCollection.comparator=function(a){return a.get("created")};var RelationTermModel=Backbone.Model.extend({url:function(){if(this.term!=undefined){return"api/relation/term/"+this.term+".json"}else{if(this.relation!=undefined&&this.term1!=undefined&&this.term2!=undefined){return"api/relation/"+this.relation+"/term1/"+this.term1+"/term2/"+this.term2+".json"}else{if(this.relation==undefined&&this.term1==undefined&&this.term2==undefined){return"api/relation/parent/term.json"}else{if(this.term1==undefined&&this.term2==undefined){return"api/relation/"+this.relation+"/term.json"}else{return"api/relation/parent/term1/"+this.term1+"/term2/"+this.term2+".json"}}}}},initialize:function(a){this.relation=a.relation;this.term=a.term;this.term1=a.term1;this.term2=a.term2}});var RelationTermCollection=Backbone.Collection.extend({model:RelationTermModel,url:function(){if(this.term!=undefined){return"api/relation/term/"+this.term+".json"}else{return"api/relation/"+this.relation+"/term.json"}},initialize:function(a){this.relation=a.relation;this.term=a.term}});var SecRoleModel=Backbone.Model.extend({url:function(){var a="api/role";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var SecRoleCollection=Backbone.Collection.extend({model:SecRoleModel,url:function(){return"api/role.json"}});var LoginDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{version:window.app.status.version}),dialogAttr:{dialogID:"#login-confirm"}}).render();$("#j_username").click(function(){$(this).select()});$("#j_password").click(function(){$(this).select()});$("#login-form").submit(window.app.controllers.auth.doLogin);$("#login-form").keydown(function(c){if(c.keyCode==13){$("#login-form").submit();return false}});$("#submit-login").click(function(){$("#login-form").submit()});return this},render:function(){var a=this;require(["text!application/templates/auth/LoginDialog.tpl.html"],function(b){a.doLayout(b)})},close:function(){$("#login-form").close()}});var LoadingDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{})}).render()},render:function(){var a=this;require(["text!application/templates/auth/LoadingDialog.tpl.html"],function(b){a.doLayout(b)});return this},initProgressBar:function(){$("#progress").show();$("#login-progressbar").progressbar({value:0})},progress:function(a){$("#login-progressbar").progressbar({value:a})},close:function(){}});var LogoutDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{}),dialogAttr:{dialogID:"#logout-confirm"}}).render();$("#submit-logout").click(function(){window.location="logout";return false});return this},render:function(){var a=this;require(["text!application/templates/auth/LogoutDialog.tpl.html"],function(b){a.doLayout(b)})}});var AnnotationThumbView=Backbone.View.extend({events:{},initialize:function(a){this.id="annotationthumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){var b=this.model.toJSON();var a=this;require(["text!application/templates/dashboard/AnnotationThumb.tpl.html"],function(c){$(a.el).html(_.template(c,b))});return this}});var AnnotationView=Backbone.View.extend({tagName:"div",initialize:function(a){this.container=a.container;this.page=a.page;this.annotations=null;if(this.page==undefined){this.page=0}},render:function(){var a=this;a.appendThumbs(a.page);return this},appendThumbs:function(e){var c=this;var f=0;var a=2500;var d=Math.abs(e)*a;var b=(Math.abs(e)+1)*a;c.annotations=new Array();c.model.each(function(g){if((f>=d)&&(f<b)){var h=new AnnotationThumbView({model:g,className:"thumb-wrap",id:"annotationthumb"+g.get("id")}).render();$(c.el).append(h.el)}f++;c.annotations.push(g.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(b){var a=this;var c=a.annotations;b.each(function(d){if(_.indexOf(a.annotations,d.id)==-1){a.add(d);a.annotations.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){a.remove(d);a.annotations=_.without(a.annotations,d)})}});var ProjectDashboardView=Backbone.View.extend({tagName:"div",projectElem:"#projectdashboardinfo",maxCommandsView:20,maxSuggestView:30,projectDashboardAnnotations:null,projectDashboardImages:null,rendered:false,initialize:function(a){_.bindAll(this,"render")},events:{},render:function(){var a=this;require(["text!application/templates/dashboard/Dashboard.tpl.html"],function(b){a.doLayout(b);a.rendered=true});return this},doLayout:function(b){var a=this;var e=Math.round($(window).width()/2-75);var d=Math.round($(window).width()-75);a.model.set({width:e+"px"});a.model.set({width2:d+"px"});var c=_.template(b,a.model.toJSON());$(a.el).append(c);window.app.controllers.browse.tabs.addDashboard(a);a.showImagesThumbs()},refreshImagesThumbs:function(){if(this.projectDashboardImages==null){this.projectDashboardImages=new ProjectDashboardImages({model:this.model})}this.projectDashboardImages.refreshImagesThumbs()},refreshAlgos:function(){if(this.projectDashboardAlgos==null){this.projectDashboardAlgos=new ProjectDashboardAlgos({model:this.model})}this.projectDashboardAlgos.refresh()},refreshImagesTable:function(){if(this.projectDashboardImages==null){this.projectDashboardImages=new ProjectDashboardImages({model:this.model})}this.projectDashboardImages.refreshImagesTable()},refreshAnnotations:function(b,c){var a=this;if(this.projectDashboardAnnotations==null){this.projectDashboardAnnotations=new ProjectDashboardAnnotations({model:this.model,el:this.el});this.projectDashboardAnnotations.render(function(){a.projectDashboardAnnotations.checkTermsAndUsers(b,c)})}else{this.projectDashboardAnnotations.checkTermsAndUsers(b,c)}},refreshDashboard:function(){var a=this;if(!a.rendered){return}var b=function(d,c){a.fetchProjectInfo();a.model=d;new AnnotationCollection({project:a.model.id}).fetch({success:function(f,e){a.fetchCommands(f);console.log("AnnotationCollection ok");new TermCollection({idOntology:a.model.get("ontology")}).fetch({success:function(h,g){console.log("TermCollection ok:"+h.length);window.app.status.currentTermsCollection=h;a.fetchWorstAnnotations(f,h)}})}});new ProjectDashboardStats({model:a.model}).fetchStats()};a.model.fetch({success:function(d,c){b(d,c)}})},fetchProjectInfo:function(){var a=this;var b=a.model.toJSON();var c=function(f,e){$(this.el).find(f).empty();$(this.el).find(f).append(e)};c("#projectInfoName",b.name);c("#projectInfoOntology",b.ontologyName);c("#projectInfoNumberOfSlides",b.numberOfSlides);c("#projectInfoNumberOfImages",b.numberOfImages);c("#projectInfoNumberOfAnnotations",b.numberOfAnnotations);c("#projectInfoCreated",b.created);c("#projectInfoUpdated",b.updated);$("#projectInfoUserList").empty();var d=[];_.each(a.model.get("users"),function(e){d.push(window.app.models.users.get(e).prettyName())});$("#projectInfoUserList").html(d.join(", "))},fetchCommands:function(b){var a=this;require(["text!application/templates/dashboard/CommandAnnotation.tpl.html","text!application/templates/dashboard/CommandAnnotationTerm.tpl.html","text!application/templates/dashboard/CommandImageInstance.tpl.html"],function(g,f,c){var d=new CommandCollection({project:a.model.get("id"),max:a.maxCommandsView});var e=function(i,h){$("#lastactionitem").empty();i.each(function(q){var l=q.toJSON();var o=new Date();o.setTime(l.created);var j=o.toLocaleDateString()+" "+o.toLocaleTimeString();var n=$.parseJSON(l.command.data);if(l.command.CLASSNAME=="be.cytomine.command.annotation.AddAnnotationCommand"){var m="block";var k=n.cropURL;if(b.get(n.id)==undefined){m="none";k=""}var p=_.template(g,{idProject:a.model.id,idAnnotation:n.id,idImage:n.image,imageFilename:n.imageFilename,icon:"add.png",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}else{if(l.command.CLASSNAME=="be.cytomine.command.annotation.EditAnnotationCommand"){var m="";var k=n.newAnnotation.cropURL;if(b.get(n.newAnnotation.id)==undefined){m="display : none;";k=""}var p=_.template(g,{idProject:a.model.id,idAnnotation:n.newAnnotation.id,idImage:n.newAnnotation.image,imageFilename:n.newAnnotation.imageFilename,icon:"delete.gif",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}else{if(l.command.CLASSNAME=="be.cytomine.command.annotation.DeleteAnnotationCommand"){var m="";var k=n.cropURL;if(b.get(n.id)==undefined){m="display : none;";k=""}var p=_.template(g,{idProject:a.model.id,idAnnotation:n.id,idImage:n.image,imageFilename:n.imageFilename,icon:"delete.gif",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}else{if(l.command.CLASSNAME=="be.cytomine.command.annotationterm.AddAnnotationTermCommand"){var p=_.template(f,{icon:"ui-icon-plus",text:l.prefixAction+" "+l.command.action,datestr:j,image:""});$("#lastactionitem").append(p)}else{if(l.command.CLASSNAME=="be.cytomine.command.annotationterm.EditAnnotationTermCommand"){var p=_.template(f,{icon:"ui-icon-pencil",text:l.prefixAction+" "+l.command.action,datestr:j,image:""});$("#lastactionitem").append(p)}else{if(l.command.CLASSNAME=="be.cytomine.command.annotationterm.DeleteAnnotationTermCommand"){var p=_.template(f,{icon:"ui-icon-trash",text:l.prefixAction+" "+l.command.action,datestr:j,image:""});$("#lastactionitem").append(p)}else{if(l.command.CLASSNAME=="be.cytomine.command.imageinstance.AddImageInstanceCommand"){var m="block";var k=n.thumb;var p=_.template(c,{idProject:a.model.id,idImage:n.id,imageFilename:n.filename,icon:"add.png",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}else{if(l.command.CLASSNAME=="be.cytomine.command.imageinstance.DeleteImageInstanceCommand"){var m="block";var k=n.thumb;var p=_.template(c,{idProject:a.model.id,idImage:n.id,imageFilename:n.filename,icon:"delete.gif",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}}}}}}}}})};d.fetch({success:function(i,h){e(i,h)}})})},fetchWorstAnnotations:function(c,b){console.log("fetchWorstAnnotations");var a=this;require(["text!application/templates/dashboard/SuggestedAnnotationTerm.tpl.html"],function(e){var d=new SuggestedAnnotationTermCollection({project:a.model.get("id"),max:a.maxSuggestView});var f=function(h,g){$("#worstannotationitem").empty();if(h.length==0){$("#worstannotationitem").append("You must run Retrieval Validate Algo for this project...")}h.each(function(n){var s=n.toJSON();var o=Math.round(s.rate*100)-1+"%";var k=c.get(s.annotation);var q=b.get(s.term).get("name");var i=new Array();_.each(k.get("term"),function(t){i.push(b.get(t).get("name"))});var j=i.join();var r="<b>"+q+"</b> for annotation "+k.id+" instead of <b>"+j+"</b>";var p="block";var m=k.get("cropURL");var l=_.template(e,{idProject:a.model.id,idAnnotation:k.id,idImage:k.get("image"),icon:"add.png",text:r,rate:o,cropURL:m,cropStyle:p});$("#worstannotationitem").append(l)})};d.fetch({success:function(h,g){f(h,g)}})})},showImagesThumbs:function(){$("#tabs-projectImageThumb"+this.model.id).show();$("#tabs-projectImageListing"+this.model.id).hide();$("#imageThumbs"+this.model.id).button("disable");$("#imageArray"+this.model.id).button("enable")},showImagesTable:function(){$("#tabs-projectImageThumb"+this.model.id).hide();$("#tabs-projectImageListing"+this.model.id).show();$("#imageThumbs"+this.model.id).button("enable");$("#imageArray"+this.model.id).button("disable")}});var ProjectDashboardStats=Backbone.View.extend({fetchStats:function(){var a=this;if(a.model.get("numberOfAnnotations")==0){return}var b=new StatsTermCollection({project:a.model.get("id")});var c=function(e,d){a.drawPieChart(e,d);a.drawColumnChart(e,d)};b.fetch({success:function(e,d){c(e,d)}});new StatsUserCollection({project:a.model.get("id")}).fetch({success:function(e,d){a.drawUserNbAnnotationsChart(e,d)}});new StatsUserAnnotationCollection({project:a.model.get("id")}).fetch({success:function(f,d){var e=_.size(f);a.drawUserAnnotationsChart(f,undefined,d)}});new SuggestedTermCollection({project:a.model.get("id")}).fetch({success:function(e,d){a.drawWorstTermPieChart(e,d)}});new StatsTermSlideCollection({project:a.model.get("id")}).fetch({success:function(e,d){a.drawTermSlideChart(e,d)}});new StatsUserSlideCollection({project:a.model.get("id")}).fetch({success:function(e,d){a.drawUserSlideChart(e,d)}})},drawUserAnnotationsChart:function(k,b,c){var n=this;var f=new google.visualization.DataTable();var l=-1;var g=k.at(0);f.addColumn("string","Terms");k.each(function(i){l++;if(l!=b&&b!=undefined){return}f.addColumn("number",i.get("key"))});f.addRows(_.size(g.get("terms")));var d=0;_.each(g.get("terms"),function(i){f.setValue(d,0,i.name);d++});l=-1;var e=1;k.each(function(o){l++;if(l!=b&&b!=undefined){return}var i=0;_.each(o.get("terms"),function(j){f.setValue(i,e,j.value);i++});e++});var a=Math.round($(window).width()-75);var m=new google.visualization.ColumnChart(document.getElementById("userAnnotationsChart"));m.draw(f,{title:"Term by users",backgroundColor:"whiteSmoke",width:a,height:350,hAxis:{title:"Terms"}});var h=function(){var q=m.getSelection()[0]["row"];var o=m.getSelection()[0]["column"];var i=k.at(o-1).get("id");var p=k.at(o-1).get("terms")[q].id;var j="#tabs-annotations-"+n.model.get("id")+"-"+p+"-"+i;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(j,true);window.app.controllers.browse.tabs.triggerRoute=true};google.visualization.events.addListener(m,"select",h)},drawUserNbAnnotationsChart:function(g,c){var i=this;$("#userNbAnnotationsChart").empty();var a=false;var e=new google.visualization.DataTable();e.addRows(_.size(g));e.addColumn("string","Number");e.addColumn("number",0);var d=0;g.each(function(j){if(j.get("value")>0){a=true}e.setValue(d,0,j.get("key"));e.setValue(d,1,j.get("value"));d++});var b=Math.round($(window).width()/2-75);var h=new google.visualization.ColumnChart(document.getElementById("userNbAnnotationsChart"));h.draw(e,{title:"",legend:"none",width:b,height:350,backgroundColor:"whiteSmoke",vAxis:{title:"Number of annotations"},hAxis:{title:"Users"}});var f=function(){var l=h.getSelection()[0]["row"];var k=h.getSelection()[0]["column"];var j=e.getValue(l,0);g.each(function(o){if(o.get("key")==j){var m=o.get("id");var n="#tabs-annotations-"+i.model.get("id")+"--"+m;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(n,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(h,"select",f);$("#userNbAnnotationsChart").show()},drawPieChart:function(g,c){$("#projectPieChart").empty();var j=this;var d=new google.visualization.DataTable();d.addColumn("string","Term");d.addColumn("number","Number of annotations");d.addRows(_.size(g));var e=0;var a=[];g.each(function(i){a.push(i.get("color"));d.setValue(e,0,i.get("key"));d.setValue(e,1,i.get("value"));e++});var b=Math.round($(window).width()/2-75);var h=new google.visualization.PieChart(document.getElementById("projectPieChart"));h.draw(d,{width:b,height:350,title:"",backgroundColor:"whiteSmoke",colors:a});var f=function(){var l=h.getSelection()[0]["row"];var k=h.getSelection()[0]["column"];var i=d.getValue(l,0);g.each(function(o){if(o.get("key")==i){var n=o.get("id");var m="#tabs-annotations-"+j.model.get("id")+"-"+n+"-";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(m,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(h,"select",f)},drawColumnChart:function(h,d){var k=this;$("#projectColumnChart").empty();var b=false;var f=new google.visualization.DataTable();f.addRows(_.size(h));f.addColumn("string","Number");f.addColumn("number",0);var a=[];var e=0;h.each(function(j){a.push(j.get("color"));if(j.get("value")>0){b=true}f.setValue(e,0,j.get("key"));f.setValue(e,1,j.get("value"));e++});var c=Math.round($(window).width()/2-75);var i=new google.visualization.ColumnChart(document.getElementById("projectColumnChart"));i.draw(f,{title:"",legend:"none",backgroundColor:"whiteSmoke",width:c,height:350,vAxis:{title:"Number of annotations"},hAxis:{title:"Terms"}});var g=function(){var m=i.getSelection()[0]["row"];var l=i.getSelection()[0]["column"];var j=f.getValue(m,0);h.each(function(p){if(p.get("key")==j){var o=p.get("id");var n="#tabs-annotations-"+k.model.get("id")+"-"+o+"-";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(n,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(i,"select",g);$("#projectColumnChart").show()},drawWorstTermPieChart:function(f,b){$("#worstTermprojectPieChart").empty();console.log("drawWorstTermPieChart:"+_.size(f));var e=new google.visualization.DataTable();e.addColumn("string","Term");e.addColumn("number","Number of questionable annotations");e.addRows(_.size(f));var c=0;var a=[];f.each(function(g){a.push(g.get("color"));e.setValue(c,0,g.get("name"));e.setValue(c,1,g.get("rate"));c++});var d=Math.round($(window).width()/2-75);new google.visualization.PieChart(document.getElementById("worstTermprojectPieChart")).draw(e,{width:d,height:350,title:"",backgroundColor:"whiteSmoke",colors:a})},drawTermSlideChart:function(h,d){var k=this;var b=false;var f=new google.visualization.DataTable();f.addRows(_.size(h));f.addColumn("string","Term");f.addColumn("number",0);var a=[];var e=0;h.each(function(j){f.setValue(e,0,j.get("key"));f.setValue(e,1,j.get("value"));e++});var c=Math.round($(window).width()/2-75);var i=new google.visualization.ColumnChart(document.getElementById("termSlideAnnotationsChart"));i.draw(f,{title:"",legend:"none",backgroundColor:"whiteSmoke",width:c,height:350,vAxis:{title:"Slides"},hAxis:{title:"Terms"}});var g=function(){var m=i.getSelection()[0]["row"];var l=i.getSelection()[0]["column"];var j=f.getValue(m,0);h.each(function(p){if(p.get("key")==j){var o=p.get("id");var n="#tabs-annotations-"+k.model.get("id")+"-"+o+"-";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(n,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(i,"select",g)},drawUserSlideChart:function(g,c){var i=this;var e=new google.visualization.DataTable();e.addRows(_.size(g));e.addColumn("string","User");e.addColumn("number",0);var a=[];var d=0;g.each(function(j){e.setValue(d,0,j.get("key"));e.setValue(d,1,j.get("value"));d++});var b=Math.round($(window).width()/2-75);var h=new google.visualization.ColumnChart(document.getElementById("userSlideAnnotationsChart"));h.draw(e,{title:"",legend:"none",backgroundColor:"whiteSmoke",enableInteractivity:true,width:b,height:350,vAxis:{title:"Slides"},hAxis:{title:"Users"}});var f=function(){var l=h.getSelection()[0]["row"];var k=h.getSelection()[0]["column"];var j=e.getValue(l,0);g.each(function(o){if(o.get("key")==j){var m=o.get("id");var n="#tabs-annotations-"+i.model.get("id")+"--"+m;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(n,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(h,"select",f)}});var ProjectDashboardImages=Backbone.View.extend({imagesView:null,images:null,imagesTabsView:null,imagesThumbOrTab:null,projectImages:null,fetchImages:function(){$("#imageThumbs"+this.model.id).button({text:false,icons:{primary:"ui-icon-image"}});$("#imageArray"+this.model.id).button({text:false,icons:{primary:"ui-icon-calculator"}});var a=this;new ImageInstanceCollection({project:a.model.get("id")}).fetch({success:function(c,b){a.projectImages=c;a.imagesView=new ImageView({page:0,model:c,el:$("#tabs-projectImageThumb"+a.model.get("id")),container:window.app.view.components.warehouse}).render();a.imagesTabsView=new ImageTabsView({model:c,el:$("#tabs-projectImageListing"+a.model.get("id")),container:window.app.view.components.warehouse,idProject:a.model.id}).render()}})},changeImagePage:function(b){var a=this;a.imagesView=new ImageView({page:b,model:a.projectImages,el:$("#tabs-projectImageThumb"+a.model.get("id")),container:window.app.view.components.warehouse}).render()},refreshImagesThumbs:function(){var a=this;if(a.imagesView==null){a.fetchImages();return}new ImageInstanceCollection({project:a.model.get("id")}).fetch({success:function(c,b){a.imagesView.refresh(c)}})},refreshImagesTable:function(){var a=this;if(a.imagesTabsView==null){return}new ImageInstanceCollection({project:a.model.get("id")}).fetch({success:function(c,b){a.imagesTabsView.refresh(c)}})}});var ProjectDashboardAnnotations=Backbone.View.extend({tabsAnnotation:null,annotationsViews:[],selectedTerm:new Array(),selectUser:null,terms:null,ontology:null,doLayout:function(a,c,d){var b=this;this.selectUser="#filterAnnotationByUser"+b.model.id;new OntologyModel({id:b.model.get("ontology")}).fetch({success:function(f,e){b.ontology=f;$(b.el).find("input.undefinedAnnotationsCheckbox").change(function(){if($(this).attr("checked")=="checked"){b.updateContentVisibility();b.refreshAnnotations(0,b.getSelectedUser());b.selectedTerm.push(0);$("#tabsterm-panel-"+b.model.id+"-0").show()}else{b.updateContentVisibility();$("#tabsterm-panel-"+b.model.id+"-0").hide();b.selectedTerm=_.without(b.selectedTerm,0)}});$(b.el).find("#treeAnnotationListing").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:f.toJSON(),onSelect:function(g,h){if(h.isSelected()){b.updateContentVisibility();b.refreshAnnotations(h.data.key,b.getSelectedUser());$("#tabsterm-panel-"+b.model.id+"-"+h.data.key).show();console.log("select term "+h.data.key);b.selectedTerm.push(h.data.key);console.log("select term "+b.selectedTerm)}else{b.updateContentVisibility();$("#tabsterm-panel-"+b.model.id+"-"+h.data.key).hide();console.log("unselect term "+h.data.key);b.selectedTerm=_.without(b.selectedTerm,h.data.key)}},onDblClick:function(h,g){},initId:"treeData-annotations-"+b.model.get("ontology"),cookieId:"dynatree-Cb-annotations-"+b.model.get("ontology"),idPrefix:"dynatree-Cb-annotations-"+b.model.get("ontology")+"-"});$(b.el).find("#treeAnnotationListing").dynatree("getRoot").visit(function(g){g.expand(true)});$("#ontology-annotations-panel-"+b.model.id).panel();b.initSelectUser();$(b.el).find("#hideAllAnnotations").click(function(){b.hideAllUsers();b.hideAllTerms()});$(b.el).find("#showAllAnnotations").click(function(){b.showAllUsers();b.showAllTerms()});$(b.el).find("#refreshAnnotations").click(function(){b.refreshSelectedTermsWithUserFilter()});new TermCollection({idOntology:b.model.get("ontology")}).fetch({success:function(h,g){b.terms=h;window.app.status.currentTermsCollection=h;$("#listtabannotation").prepend(_.template(c,{project:b.model.id,id:0,name:"Undefined"}));$("#tabsterm-panel-"+b.model.id+"-0").panel();$("#tabsterm-panel-"+b.model.id+"-0").hide();h.each(function(i){$("#listtabannotation").prepend(_.template(c,{project:b.model.id,id:i.get("id"),name:i.get("name")}));$("#tabsterm-panel-"+b.model.id+"-"+i.get("id")).panel();$("#tabsterm-panel-"+b.model.id+"-"+i.get("id")).hide()});d.call()}})}})},checkTermsAndUsers:function(c,d){var a=(c!=""&&c!=undefined);var b=(d!=""&&d!=undefined);if(!b&&!a){return}this.hideAllTerms();this.hideAllUsers();if(b&&!a){this.selectUsers(d);this.showAllTerms()}else{if(b&&a){this.selectUsers(d);this.selectTerms(c)}else{if(!b&&a){this.showAllUsers();this.selectTerms(c)}}}},showAllTerms:function(){$(this.el).find("input.undefinedAnnotationsCheckbox").attr("checked","checked");$(this.el).find("input.undefinedAnnotationsCheckbox").trigger("change");this.selectAnnotations(true)},showAllUsers:function(){$(this.selectUser).multiselect("checkAll")},hideAllTerms:function(){$(this.el).find("input.undefinedAnnotationsCheckbox").removeAttr("checked");$(this.el).find("input.undefinedAnnotationsCheckbox").trigger("change");this.selectAnnotations(false)},hideAllUsers:function(){$(this.selectUser).multiselect("uncheckAll")},render:function(b){var a=this;require(["text!application/templates/dashboard/TermTab.tpl.html","text!application/templates/dashboard/TermTabContent.tpl.html"],function(c,d){a.doLayout(c,d,b)})},initSelectUser:function(){var a=this;$(a.selectUser).empty();$(a.selectUser).multiselect({selectedText:"# of # users selected",noneSelectedText:"No user are selected",checkAll:function(){console.log("click on user :"+a.selectedTerm+" users="+a.getSelectedUser());a.printAnnotationThumbAllTerms(a.selectedTerm,a.getSelectedUser())},uncheckAll:function(){console.log("click on user :"+a.selectedTerm+" users="+a.getSelectedUser());a.printAnnotationThumbAllTerms(a.selectedTerm,a.getSelectedUser())}});new UserCollection({project:a.model.id}).fetch({success:function(c,b){window.app.status.currentUsersCollection=c;c.each(function(d){console.log('<option value="'+d.id+'">'+d.get("username")+"</option>");$(a.selectUser).append('<option value="'+d.id+'">'+d.get("username")+"</option>")});$(a.selectUser).multiselect("refresh");$(a.selectUser).multiselect("checkAll");$(a.selectUser).bind("multiselectclick",function(d,e){console.log("click on "+e.value);console.log("click on user :"+a.selectedTerm+" users="+a.getSelectedUser());a.printAnnotationThumbAllTerms(a.selectedTerm,a.getSelectedUser())})}})},getSelectedUser:function(){var a=$(this.selectUser).multiselect("getChecked");var b=new Array();_.each(a,function(c){b.push($(c).attr("value"))});if(b.length==0){b.push(-1)}return b},addTermToTab:function(a,c,b){$("#listtabannotation").append(_.template(c,b))},selectAnnotations:function(b){var a=this;this.terms.each(function(c){$(a.el).find("#treeAnnotationListing").dynatree("getTree").selectKey(c.get("id"),b)})},updateContentVisibility:function(){var a=$(this.el).find("#treeAnnotationListing").dynatree("getRoot");if(!_.isFunction(a.visit)){return}var b=0;a.visit(function(c){if(!c.isSelected()){return}b++});b+=($(this.el).find("input.undefinedAnnotationsCheckbox").attr("checked")=="checked")?1:0;if(b>0){$("#listtabannotation").show()}else{$("#listtabannotation").hide()}},refreshSelectedTerms:function(){var b=this;var a=$(this.el).find("#treeAnnotationListing").dynatree("getRoot");if(!_.isFunction(a.visit)){return}a.visit(function(c){if(!c.isSelected()){return}b.refreshAnnotations(c.data.key)});if($(this.el).find("input.undefinedAnnotationsCheckbox").attr("checked")=="checked"){b.refreshAnnotations(0)}b.updateContentVisibility()},selectTerms:function(b){b=b.split(",");var a=$(this.el).find("#treeAnnotationListing").dynatree("getTree");_.each(b,function(c){var d=a.getNodeByKey(c);d.select(true)})},selectUsers:function(a){a=a.split(",");_.each(a,function(b){$(".ui-multiselect-menu").find("input[value='"+b+"']").click()})},refreshSelectedTermsWithUserFilter:function(){return;var b=this;var c=b.getSelectedUser();var a=$(this.el).find("#treeAnnotationListing").dynatree("getRoot");if(!_.isFunction(a.visit)){return}a.visit(function(d){if(!d.isSelected()){return}b.refreshAnnotations(d.data.key,c)});if($(this.el).find("input.undefinedAnnotationsCheckbox").attr("checked")=="checked"){b.refreshAnnotations(0,c)}b.updateContentVisibility()},refreshAnnotations:function(a,b){console.log("refreshAnnotations");this.printAnnotationThumb(a,"#tabsterm-"+this.model.id+"-"+a,b)},clearAnnotations:function(b){console.log("clearAnnotations");var a=this;$("#tabsterm-"+a.model.id+"-"+b).empty()},printAnnotationThumbAllTerms:function(c,d){console.log("printAnnotationThumb="+d);var a=this;for(var b=0;b<c.length;b++){console.log("printAnnotationThumb loop="+d);a.printAnnotationThumb(c[b],"#tabsterm-"+a.model.id+"-"+c[b],d)}},printAnnotationThumb:function(c,b,d){var a=this;console.log("users="+d);console.log("AnnotationCollection: project="+a.model.id+" term="+c+" users="+d);new AnnotationCollection({project:a.model.id,term:c,users:d}).fetch({success:function(f,e){console.log("success");if(a.annotationsViews[c]!=null&&d==undefined){a.annotationsViews[c].refresh(f,d);return}console.log(b);console.log($(b).children().length);$(b).empty();console.log($(b).children().length);console.log("annotation size="+f.length);a.annotationsViews[c]=new AnnotationView({page:undefined,model:f,el:$(b),container:window.app.view.components.warehouse}).render();$("#listtabannotation > div").tsort()}})}});var ProjectDashboardAlgos=Backbone.View.extend({rendered:false,initialize:function(a){this.el="#tabs-algos-"+this.model.id},render:function(){this.initImageFilters();this.initBatchProcessing();this.rendered=true},refresh:function(){if(!this.rendered){this.render()}},removeImageFilter:function(b){var a=this;new ProjectImageFilterModel({id:1,project:a.model.id,imageFilter:b.get("id")}).destroy({success:function(d,c){$(a.el).find("li.imageFilter"+b.get("id")).remove()}});return false},renderFilters:function(){var a=this;var b=$(this.el).find(".image-filters");b.empty();new ProjectImageFilterCollection({project:a.model.id}).fetch({success:function(d,c){d.each(function(e){a.renderImageFilter(e,b)})}})},renderImageFilter:function(d,c){var a=this;var b=_.template("<li class='imageFilter<%=   id %>'><%=   name %> <a class='removeImageFilter<%=   id %>' href='#'><span class='label important'>Remove</span></a></li>",d.toJSON());$(c).append(b);$(this.el).find("a.removeImageFilter"+d.get("id")).click(function(){a.removeImageFilter(d);return false})},initImageFilters:function(){var a=this;var b=$(this.el).find(".image-filters");new ImageFilterCollection().fetch({success:function(d,c){d.each(function(f){var e=_.template("<option value='<%=   id %>'><%=   name %></option>",f.toJSON());$(a.el).find("#addImageFilter").append(e)});$(a.el).find("#addImageFilterButton").click(function(){new ProjectImageFilterModel({project:a.model.id,imageFilter:$(a.el).find("#addImageFilter").val()}).save({},{success:function(f,e){a.renderImageFilter(f,b)},error:function(e){}});return false})}});a.renderFilters()},initBatchProcessing:function(){console.log("initBatchProcessing");$(this.el).find(".batch-processing").append(":-) !")}});var AnnotationLayer=function(e,d,c,b,f,a,h){var g=new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults({fillColor:b,fillOpacity:0.5,strokeColor:"black",strokeWidth:2},OpenLayers.Feature.Vector.style["default"]),select:OpenLayers.Util.applyDefaults({fillColor:"#25465D",fillOpacity:0.5,strokeColor:"black",strokeWidth:2},OpenLayers.Feature.Vector.style["default"])});this.ontologyTreeView=f;this.name=e;this.map=h,this.imageID=d;this.userID=c;this.vectorsLayer=new OpenLayers.Layer.Vector(this.name,{styleMap:g,rendererOptions:{zIndexing:true}});this.features=[];this.controls=null;this.dialog=null;this.rotate=false;this.resize=false;this.drag=false;this.irregular=false;this.aspectRatio=false;this.browseImageView=a;this.map=a.map;this.popup=null;this.hoverControl=null;this.isOwner=null;this.deleteOnSelect=false;this.measureOnSelect=false;this.magicOnClick=false};AnnotationLayer.prototype={registerEvents:function(b){var a=this;this.vectorsLayer.events.on({clickFeature:function(c){},onSelect:function(c){},featureselected:function(c){if(!a.measureOnSelect){a.ontologyTreeView.refresh(c.feature.attributes.idAnnotation);if(a.deleteOnSelect==true){a.removeSelection()}else{a.showPopup(b,c)}}else{a.showPopupMeasure(b,c)}},featureunselected:function(c){if(a.measureOnSelect){a.vectorsLayer.removeFeatures(c.feature)}if(a.dialog!=null){a.dialog.destroy()}a.ontologyTreeView.clear();a.ontologyTreeView.clearAnnotation();a.clearPopup(b,c)},featureadded:function(c){if(!a.measureOnSelect){if(c.feature.attributes.listener!="NO"){c.feature.attributes.measure="YES";a.addAnnotation(c.feature)}}else{a.controls.select.unselectAll();a.controls.select.select(c.feature)}},beforefeaturemodified:function(c){},afterfeaturemodified:function(c){a.updateAnnotation(c.feature)},onDelete:function(c){}})},initControls:function(b,a){this.controls={freehand:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Polygon,{handlerOptions:{freehand:true}}),point:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Path),polygon:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Polygon),regular:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:5}}),modify:new OpenLayers.Control.ModifyFeature(this.vectorsLayer),select:a};this.controls.freehand.freehand=true;b.initTools(this.controls)},loadAnnotations:function(a){var b=this;new AnnotationCollection({user:this.userID,image:this.imageID,term:undefined}).fetch({success:function(d,c){d.each(function(e){var f=b.createFeatureFromAnnotation(e);b.addFeature(f)});a.layerLoadedCallback(b)}});a.addVectorLayer(this,this.userID)},addFeature:function(a){this.features[a.attributes.idAnnotation]=a;this.vectorsLayer.addFeatures(a)},selectFeature:function(a){this.controls.select.unselectAll();this.controls.select.select(a)},removeFeature:function(a){var b=this.getFeature(a);if(b!=null&&b.popup){this.map.removePopup(b.popup);b.popup.destroy();b.popup=null;this.popup=null}this.vectorsLayer.removeFeatures(b);this.ontologyTreeView.clearAnnotation();this.ontologyTreeView.clear();this.features[a]=null},getFeature:function(a){return this.features[a]},removeSelection:function(){for(var b in this.vectorsLayer.selectedFeatures){var a=this.vectorsLayer.selectedFeatures[b];this.removeAnnotation(a)}},clearPopup:function(c,a){var b=this;feature=a.feature;if(feature.popup){b.popup.feature=null;c.removePopup(feature.popup);feature.popup.destroy();feature.popup=null;b.popup=null}},hideFeature:function(a){if(a.style==undefined){a.style={}}a.style.display="none";this.vectorsLayer.drawFeature(a)},showFeature:function(a){if(a.style==undefined){a.style={}}a.style.display=undefined;this.vectorsLayer.drawFeature(a)},showPopup:function(c,a){var b=this;require(["text!application/templates/explorer/PopupAnnotation.tpl.html"],function(d){if(a.feature.popup!=null){return}new AnnotationModel({id:a.feature.attributes.idAnnotation}).fetch({success:function(f,e){var g=f.toJSON();g.username=window.app.models.users.get(g.user).prettyName();var i=new Array();_.each(g.userByTerm,function(n){var m=n.term;var l=window.app.status.currentTermsCollection.get(m).get("name");var o=n.user.length;var j=window.app.status.currentProjectModel.get("ontology");var k=_.template("<a href='#ontology/<%=   idOntology %>/<%=   idTerm %>'><%=   termName %></a> (<%=   userCount %>)",{idOntology:j,idTerm:m,termName:l,userCount:o});i.push(k)});g.terms=i.join(", ");var h=_.template(d,g);b.popup=new OpenLayers.Popup("",new OpenLayers.LonLat(a.feature.geometry.getBounds().right+50,a.feature.geometry.getBounds().bottom+50),new OpenLayers.Size(300,200),h,false);b.popup.setBackgroundColor("transparent");b.popup.setBorder(0);b.popup.padding=0;a.feature.popup=b.popup;b.popup.feature=a.feature;c.addPopup(b.popup);$("#annotationHide"+f.id).click(function(){b.controls.select.unselectAll();var k=b.getFeature(f.id);if(k==undefined||k==null){return}b.hideFeature(k);var j="tabs-image-"+window.app.status.currentProjectModel.get("id")+"-"+b.browseImageView.model.get("id")+"-";window.app.controllers.browse.navigate(j,false);return false});b.showSimilarAnnotation(f)}})})},showSimilarAnnotation:function(b){var a=this;new TermCollection({idOntology:window.app.status.currentProjectModel.get("ontology")}).fetch({success:function(d,c){new AnnotationRetrievalModel({annotation:b.id}).fetch({success:function(n,j){var e=n.get("term");var k=new TermCollection(e);var q;var l;var p=0;var m=0;k.each(function(i){p=p+i.get("rate");if(m==0){q=i}if(m==1){l=i}m++});var h;var g;var f=0;var o=0;if(q!=undefined){h=q.id;f=q.get("rate");if(f==0){h=undefined}}if(l!=undefined){g=l.id;o=l.get("rate");if(o==0){g=undefined}}f=(f/p)*100;o=(o/p)*100;a.printSuggestedTerm(b,d.get(h),d.get(g),f,o,d,n.get("annotation"))},error:function(f,e){$("#loadSimilarAnnotation"+b.id).replaceWith("Error: cannot reach retrieval")}})}})},printSuggestedTerm:function(d,c,a,b,f,e,g){var j=this;var h="";var i="";if(c!=undefined){h+='<span id="changeBySuggest'+c.id+'" style="display : inline"><u>'+c.get("name")+"</u> ("+Math.round(b)+"%)<span>"}if(a!=undefined){i+=' or <span id="changeBySuggest'+a.id+'" style="display : inline"><u>'+a.get("name")+"</u> ("+Math.round(f)+"%)<span>"}$("#suggTerm"+d.id).empty();$("#suggTerm"+d.id).append(h);$("#suggTerm"+d.id).append(i);if(c!=undefined){j.createSuggestedTermLink(c,d)}if(a!=undefined){j.createSuggestedTermLink(a,d)}$("#loadSimilarAnnotation"+d.id).replaceWith('<a href="#" id="annotationSimilar'+d.id+'"> Search similar annotations</a>');$("#annotationSimilar"+d.id).click(function(){console.log("click similar");$("#annotationRetrieval").replaceWith("");$("#annotationRetrievalMain").empty();$("#annotationRetrievalMain").append('<div id="annotationRetrieval"></div>');console.log("load AnnotationRetrievalView = "+$("#annotationRetrieval").length);var k=new AnnotationRetrievalView({model:new AnnotationRetrievalCollection(g),projectsPanel:j,container:j,el:"#annotationRetrieval",baseAnnotation:d,terms:e}).render();return false})},createSuggestedTermLink:function(c,a){var b=this;$("#changeBySuggest"+c.id).click(function(){new AnnotationTermModel({term:c.id,annotation:a.id,clear:true}).save(null,{success:function(e,d){window.app.view.message("Correct Term",d.message,"");b.ontologyTreeView.refresh(a.id)},error:function(e,d){var f=$.parseJSON(d.responseText);window.app.view.message("Correct term","error:"+f.errors,"")}})})},showPopupMeasure:function(c,a){var b=this;require(["text!application/templates/explorer/PopupMeasure.tpl.html"],function(e){if(a.feature.popup!=null){return}var d=b.browseImageView.model.get("resolution");var g=a.feature.geometry.getLength();if(d!=undefined&&d!=null){g*=d;g=Math.round(g*1000)/1000;g+=" µm"}else{g+=" pixels"}var f=_.template(e,{length:g});b.popup=new OpenLayers.Popup("chicken",new OpenLayers.LonLat(a.feature.geometry.getBounds().right+50,a.feature.geometry.getBounds().bottom+50),new OpenLayers.Size(200,60),f,false);b.popup.setBackgroundColor("transparent");b.popup.setBorder(0);b.popup.padding=0;a.feature.popup=b.popup;b.popup.feature=a.feature;c.addPopup(b.popup)})},enableHightlight:function(){},disableHightlight:function(){},initHightlight:function(a){},addAnnotation:function(d){var c=this;var b=this;var g=new OpenLayers.Format.WKT();var f=g.write(d);var e=c.ontologyTreeView.getTermsChecked();var a=new AnnotationModel({name:"",location:f,image:this.imageID,term:e});console.log(a.toJSON());a.save(a.toJSON(),{success:function(h,i){var k=i.annotation.id;var j=i.message;new AnnotationModel({id:k}).fetch({success:function(l,m){b.vectorsLayer.removeFeatures([d]);var q=b.createFeatureFromAnnotation(l);b.addFeature(q);b.controls.select.unselectAll();b.controls.select.select(q);var n=l.get("cropURL");var p=_.template("<img src='<%=   url %>' alt='<%=   alt %>' style='max-width: 175px;max-height: 175px;' />",{url:n,alt:n});var o=_.template("<p><%=   message %></p><div><%=   cropImage %></div>",{message:j,cropImage:p});window.app.view.message("Annotation added",o,"success");b.browseImageView.refreshAnnotationTabs(undefined)},error:function(m,l){}})},error:function(i,h){var j=$.parseJSON(h.responseText);window.app.view.message("Add annotation","error:"+j.errors,"")}})},createFeatureFromAnnotation:function(b){var f=new OpenLayers.Format.WKT();var a=f.read(b.get("location"));var d=a.geometry;var c=new OpenLayers.Feature.Vector(d);c.attributes={idAnnotation:b.get("id"),measure:"NO",listener:"NO",importance:10};var e="#333333";c.style={strokeColor:e,fillColor:e,fillOpacity:0.6};var g="#000";if(_.size(b.get("term"))>1){c.style={strokeColor:g,fillColor:g,fillOpacity:0.6}}else{_.each(b.get("term"),function(h){var i=window.app.status.currentTermsCollection.get(h);if(i==undefined){return}c.style={strokeColor:window.app.status.currentTermsCollection.get(h).get("color"),fillColor:window.app.status.currentTermsCollection.get(h).get("color"),fillOpacity:0.6}})}return c},removeAnnotation:function(c){var d=this.ontologyTreeView.getTermsChecked();var a=c.attributes.idAnnotation;this.removeFeature(c);this.controls.select.unselectAll();this.vectorsLayer.removeFeatures([c]);var b=this;new AnnotationTermCollection({idAnnotation:a}).fetch({success:function(f,e){new AnnotationModel({id:c.attributes.idAnnotation}).destroy({success:function(h,g){window.app.view.message("Annotation",g.message,"");b.browseImageView.refreshAnnotationTabs(undefined);b.browseImageView.refreshAnnotationTabs(undefined)},error:function(h,g){var i=$.parseJSON(g.responseText);window.app.view.message("Annotation",i.errors,"")}})}})},updateAnnotation:function(a){var c=new OpenLayers.Format.WKT();var b=c.write(a);new AnnotationModel({id:a.attributes.idAnnotation}).fetch({success:function(e,d){e.set({location:b});e.save()}})},toggleRotate:function(){this.resize=false;this.drag=false;this.rotate=true;this.updateControls();this.toggleControl("modify")},toggleResize:function(){this.resize=true;this.drag=false;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleDrag:function(){this.resize=false;this.drag=true;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleEdit:function(){this.resize=false;this.drag=false;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleIrregular:function(){this.irregular=!this.irregular;this.updateControls()},toggleAspectRatio:function(){this.aspectRatio=!this.aspectRatio;this.updateControls()},setSides:function(a){this.sides=a;this.updateControls()},updateControls:function(){this.controls.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE;if(this.rotate){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.ROTATE}if(this.resize){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.RESIZE;if(this.aspectRatio){this.controls.modify.mode&=~OpenLayers.Control.ModifyFeature.RESHAPE}}if(this.drag){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.DRAG}if(this.rotate||this.drag){this.controls.modify.mode&=~OpenLayers.Control.ModifyFeature.RESHAPE}this.controls.regular.handler.sides=this.sides;this.controls.regular.handler.irregular=this.irregular},disableMeasureOnSelect:function(){var a=this;this.measureOnSelect=false;for(var c in this.vectorsLayer.features){var b=this.vectorsLayer.features[c];if(b.attributes.measure==undefined||b.attributes.measure=="YES"){a.vectorsLayer.removeFeatures(b);if(b.popup){a.popup.feature=null;a.map.removePopup(b.popup);b.popup.destroy();b.popup=null;a.popup=null}}}},toggleControl:function(a){this.deleteOnSelect=false;this.disableMeasureOnSelect();this.magicOnClick=false;for(key in this.controls){var d=this.controls[key];if(a==key){d.activate();if(d==this.controls.modify){for(var c in this.vectorsLayer.selectedFeatures){var b=this.vectorsLayer.selectedFeatures[c];d.selectFeature(b)}}}else{d.deactivate();if(d==this.controls.modify){for(var c in this.vectorsLayer.selectedFeatures){var b=this.vectorsLayer.selectedFeatures[c];d.unselectFeature(b)}}}}},annotationAdded:function(b){var c=this;var d=c.deleteOnSelect;c.deleteOnSelect=false;var a=new AnnotationModel({id:b}).fetch({success:function(e){var f=c.createFeatureFromAnnotation(e);c.addFeature(f);c.selectFeature(f);c.controls.select.activate();c.deleteOnSelect=d;c.browseImageView.refreshAnnotationTabs(undefined)}})},annotationRemoved:function(a){this.removeFeature(a);this.browseImageView.refreshAnnotationTabs(undefined)},annotationUpdated:function(a,b){this.annotationRemoved(a);this.annotationAdded(a)},termAdded:function(a,c){var b=this;this.ontologyTreeView.check(c)},termRemoved:function(a,b){this.ontologyTreeView.uncheck(b)}};var BrowseImageView=Backbone.View.extend({tagName:"div",initialize:function(a){this.iPad=(navigator.userAgent.match(/iPad/i)!=null);this.initCallback=a.initCallback;this.layers=[];this.layersLoaded=0;this.baseLayers=[];this.annotationsPanel=null;this.map=null;this.currentAnnotation=null;_.bindAll(this,"initVectorLayers")},doLayout:function(b){var a=this;var d=this.model.toJSON();d.project=window.app.status.currentProject;$(this.el).append(_.template(b,d));var c=$(this.el).children(".tabs");this.el.tabs("add","#tabs-image-"+window.app.status.currentProject+"-"+this.model.get("id")+"-",this.model.get("filename"));this.el.css("display","block");this.initToolbar();this.initMap();this.initOntology();this.initAnnotationsTabs();if(this.iPad){this.initMobile()}return this},initMobile:function(){},render:function(){var a=this;require(["lib/OpenLayers-2.11/OpenLayers.js","text!application/templates/explorer/BrowseImage.tpl.html"],function(c,b){a.doLayout(b)});return this},show:function(b){var a=this;if(b.goToAnnotation!=undefined){_.each(this.layers,function(c){a.goToAnnotation(c,b.goToAnnotation.value)})}},refreshAnnotationTabs:function(a){this.annotationsPanel.refreshAnnotationTabs(a)},setLayerVisibility:function(b,a){$("#layerSwitcher"+this.model.get("id")).find("ul.annotationLayers").find(":checkbox").each(function(){if(b.name!=$(this).attr("value")){return}if(a){if($(this).attr("checked")!="checked"){this.click()}}else{if($(this).attr("checked")=="checked"){this.click()}}})},goToAnnotation:function(f,i){var l=this;var m=f.getFeature(i);if(m!=undefined){f.showFeature(m);l.setLayerVisibility(f,true);var b=m.geometry.bounds;var g=b.right-b.left;var j=b.top-b.bottom;var c=$(window).width();var a=$(window).height();var k=this.map.getNumZoomLevels()-1;var e=g;var d=j;while((e>c)||(d>a)){e/=2;d/=2;k--}var h=$("#toolbar"+this.model.get("id"));h.find("input[id=select"+l.model.get("id")+"]").click();f.controls.select.unselectAll();f.controls.select.select(m);l.currentAnnotation=i;this.map.moveTo(new OpenLayers.LonLat(m.geometry.getCentroid().x,m.geometry.getCentroid().y),Math.max(0,k))}},getFeature:function(a){return this.userLayer.getFeature(a)},removeFeature:function(a){return this.userLayer.removeFeature(a)},layerLoadedCallback:function(d){var b=this;this.layersLoaded++;var e=window.app.status.currentProjectModel;if(this.layersLoaded==e.get("users").length){var a=_.map(this.layers,function(f){return f.vectorsLayer});var c=new OpenLayers.Control.SelectFeature(a);_.each(this.layers,function(f){f.initControls(b,c);f.registerEvents(b.map);if(f.isOwner){b.userLayer=f;f.vectorsLayer.setVisibility(true);f.toggleIrregular();var g=$("#toolbar"+b.model.get("id"));g.find("input[id=none"+b.model.get("id")+"]").click()}else{f.controls.select.activate();f.vectorsLayer.setVisibility(false)}});if(_.isFunction(b.initCallback)){b.initCallback.call()}b.initAutoAnnoteTools()}},getUserLayer:function(){return this.userLayer},initMap:function(){var a=this;var b=this.model.get("mime");if(b=="vms"||b=="mrxs"||b=="tif"||b=="tiff"||b=="svs"){a.initIIP()}},addBaseLayer:function(b){var a=this;this.map.addLayer(b);this.baseLayers.push(b);a.map.setBaseLayer(b);this.layerSwitcherPanel.addBaseLayer(b,this.model)},addVectorLayer:function(b,a){this.map.addLayer(b.vectorsLayer);this.layers.push(b);this.layerSwitcherPanel.addVectorLayer(b,this.model,a)},createLayerSwitcher:function(){this.layerSwitcherPanel=new LayerSwitcherPanel({browseImageView:this,model:this.model,el:this.el}).render()},createOverviewMap:function(){new OverviewMapPanel({model:this.model,el:this.el}).render()},initIIP:function(){var a=this;var f=function(o,p,k){a.createLayerSwitcher();a.initImageFiltersPanel();var t={maxExtent:new OpenLayers.Bounds(0,0,o.width,o.height),maxResolution:Math.pow(2,o.nbZoom),numZoomLevels:o.nbZoom+1,units:"pixels",tileSize:new OpenLayers.Size(256,256),controls:[new OpenLayers.Control.TouchNavigation({dragPanOptions:{enableKinetic:true}}),new OpenLayers.Control.Navigation(),new OpenLayers.Control.PanZoomBar(),new OpenLayers.Control.MousePosition(),new OpenLayers.Control.KeyboardDefaults()],eventListeners:{zoomend:function(w){var y=w.object;var x=a.model.get("magnification");var u=y.getNumZoomLevels()-y.getZoom()-1;var v=x;if(u!=0){v=x/(Math.pow(2,u))}v=Math.round(v*100)/100;$("#zoomInfoPanel"+a.model.id).html(v+"X")},moveend:function(){a.imageFiltersPanel.redraw()}}};var j=new OpenLayers.Layer.Image("Overview"+a.model.get("id"),a.model.get("thumb"),new OpenLayers.Bounds(0,0,o.width,o.height),new OpenLayers.Size(o.overviewWidth,o.overviewHeight));var i=new OpenLayers.Control.OverviewMap({size:new OpenLayers.Size(o.overviewWidth,o.overviewHeight),layers:[j],div:document.getElementById("overviewMap"+a.model.get("id")),minRatio:1,maxRatio:1024,mapOptions:{maxExtent:new OpenLayers.Bounds(0,0,o.width,o.height),maximized:true}});a.map=new OpenLayers.Map("map"+a.model.get("id"),t);var s=71;var r=$(window).height()-s;$("#map"+a.model.get("id")).css("height",r);$(window).resize(function(){var u=$(window).height()-s;$("#map"+a.model.get("id")).css("height",u)});var n=new OpenLayers.Layer.Zoomify("Original",p,new OpenLayers.Size(o.width,o.height));k.each(function(w){var u=_.map(p,function(x){return w.get("baseUrl")+x});var v=new OpenLayers.Layer.Zoomify(w.get("name"),u,new OpenLayers.Size(o.width,o.height));a.addBaseLayer(v)});a.addBaseLayer(n);a.createOverviewMap();a.map.zoomToMaxExtent();a.map.addControl(i);var h=$(window).width();var g=$(window).height()-s;var m=o.width;var l=o.height;var q=o.nbZoom;while(m>h||l>g){m/=2;l/=2;q--}a.map.zoomTo(q)};var d=a.model.get("width");var c=a.model.get("height");var e=0;while(d>=256||c>=256){e++;d=d/2;c=c/2}var b={width:a.model.get("width"),height:a.model.get("height"),nbZoom:e,overviewWidth:200,overviewHeight:Math.round((200/a.model.get("width")*a.model.get("height")))};new ImageServerUrlsModel({id:a.model.get("baseImage")}).fetch({success:function(h,g){new ProjectImageFilterCollection({project:a.model.get("project")}).fetch({success:function(j,i){f(b,h.get("imageServersURLs"),j)}})}})},reloadAnnotation:function(a){var b=this;b.removeFeature(a);new AnnotationModel({id:a}).fetch({success:function(c,d){var e=b.userLayer.createFeatureFromAnnotation(c);b.userLayer.addFeature(e);b.userLayer.selectFeature(e)}})},initAutoAnnoteTools:function(){var a=this;var b=function b(d){if(!a.getUserLayer().magicOnClick){return}var f=a.map.getLonLatFromViewPortPx(d.xy);var g=parseInt(a.model.get("height"))-f.lat;var c=f.lon;console.log(a.model.get("height"));var e="processing/detect/"+a.model.get("id")+"/"+c+"/"+g;$.getJSON(e,function(i){var k=new OpenLayers.Format.WKT();var h=k.read(i.geometry);var j=h.geometry;a.getUserLayer().addAnnotation(new OpenLayers.Feature.Vector(j))})};a.map.events.register("click",a.getUserLayer().vectorsLayer,b)},initToolbar:function(){var b=$("#toolbar"+this.model.get("id"));var a=this;b.find("input[name=select]").button({});b.find("button[name=delete]").button({text:false,icons:{primary:"ui-icon-trash"}});b.find("button[name=ruler]").button({text:false,icons:{secondary:"ui-icon-arrow-2-ne-sw"}});b.find("input[id^=ruler]").button({text:true,icons:{secondary:"ui-icon-arrow-2-ne-sw"}});b.find("input[name=rotate]").button();b.find("input[name=resize]").button();b.find("input[name=drag]").button();b.find("input[name=irregular]").button();b.find("span[class=nav-toolbar]").buttonset();b.find("span[class=draw-toolbar]").buttonset();b.find("span[class=edit-toolbar]").buttonset();b.find("span[class=delete-toolbar]").buttonset();b.find("span[class=ruler-toolbar]").buttonset();b.find("input[id=none"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("none");a.getUserLayer().enableHightlight()});b.find("input[id=select"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleControl("select");a.getUserLayer().disableHightlight()});b.find("input[id=regular4"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(4);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("input[id=regular30"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(15);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("input[id=polygon"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("polygon");a.getUserLayer().disableHightlight()});b.find("input[id=freehand"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("freehand");a.getUserLayer().disableHightlight()});b.find("input[id=magic"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("select");a.getUserLayer().magicOnClick=true;a.getUserLayer().disableHightlight()});b.find("input[id=modify"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleEdit();a.getUserLayer().toggleControl("modify");a.getUserLayer().disableHightlight()});b.find("input[id=delete"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("select");a.getUserLayer().deleteOnSelect=true;a.getUserLayer().disableHightlight()});b.find("input[id=rotate"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleRotate();a.getUserLayer().disableHightlight()});b.find("input[id=resize"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleResize();a.getUserLayer().disableHightlight()});b.find("input[id=drag"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleDrag();a.getUserLayer().disableHightlight()});b.find("input[id=ruler"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("line");a.getUserLayer().measureOnSelect=true;a.getUserLayer().disableHightlight()})},initVectorLayers:function(c){var b=this;var d=window.app.status.currentProjectModel;var a=window.app.models.users.select(function(e){return _.include(d.get("users"),e.id)});_.each(a,function(e){var f=new AnnotationLayer(e.prettyName(),b.model.get("id"),e.get("id"),e.get("color"),c,b,b.map);f.isOwner=(e.get("id")==window.app.status.user.id);f.loadAnnotations(b)})},initAnnotationsTabs:function(){this.annotationsPanel=new AnnotationsPanel({el:this.el,model:this.model}).render()},initOntology:function(){var a=this;new OntologyPanel({el:this.el,model:this.model,callback:a.initVectorLayers,browseImageView:a}).render()},initImageFiltersPanel:function(){var a=this;a.imageFiltersPanel=new ImageFiltersPanel({el:this.el,model:this.model,browseImageView:a}).render()},initTools:function(a){for(var b in a){this.map.addControl(a[b])}}});var DraggablePanelView=Backbone.View.extend({tagName:"div",initialize:function(a){this.iPad=(navigator.userAgent.match(/iPad/i)!=null);this.el=a.el;this.template=a.template},render:function(){var b=this;$(this.el).html(this.template);if(this.iPad){return this}var c=$(this.el).width();var a=$(this.el).height();$(this.el).draggable({cancel:"input",start:function(d,e){c=$(b.el).width();a=$(b.el).height()},drag:function(d,e){$(this).css("width",c);$(this).css("height",a)}});return this}});var ExplorerTabs=Backbone.View.extend({tagName:"div",triggerRoute:true,initialize:function(a){this.tabs=[],this.container=a.container},render:function(){var a=this;require(["text!application/templates/explorer/Tabs.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{}));var c=$(this.el).children(".tabs");c.tabs({add:function(d,e){if(e.panel.id!=("tabs-dashboard-"+window.app.status.currentProject)&&(e.panel.id!="tabs-images-"+window.app.status.currentProject)&&e.panel.id!=("tabs-annotations-"+window.app.status.currentProject)&&e.panel.id!=("tabs-algos-"+window.app.status.currentProject)){c.find("ul").find("a[href=#"+e.panel.id+"]").find("span").attr("style","display:inline;");c.find("ul").find("a[href=#"+e.panel.id+"]").parent().append("<span class='ui-icon ui-icon-close' style='display:inline;cursor:pointer;'>&nbsp;&nbsp;&nbsp;&nbsp;</span>");c.find("ul").find("a[href=#"+e.panel.id+"]").parent().find("span.ui-icon-close").click(function(){var f=$("li",c).index($(this).parent());a.removeTab(f)});a.triggerRoute=false;c.tabs("select","#"+e.panel.id);a.triggerRoute=true}else{$(e.panel).css({"background-image":"url(http://subtlepatterns.com/patterns/whitey.png)"})}},show:function(d,e){return true},select:function(d,e){window.app.controllers.browse.navigate("#"+e.panel.id,a.triggerRoute)}});$("ul.tabs a").css("height",$("ul.tabs").height());return this},addBrowseImageView:function(c,b){var a=this;var e=this.getBrowseImageView(c);if(e!=null){e.view.show(b);return}var d=$(a.el).children(".tabs");new ImageInstanceModel({id:c}).fetch({success:function(h,g){var f=new BrowseImageView({model:h,initCallback:function(){f.show(b)},el:d}).render();a.tabs.push({idImage:c,view:f})}})},getBrowseImageView:function(b){var a=_.detect(this.tabs,function(c){return c.idImage==b});return a!=null?a:null},removeTab:function(a){this.tabs.splice(a,1);var b=$(this.el).children(".tabs");b.tabs("remove",a)},showTab:function(a){var b=$("#explorer > .browser").children(".tabs");b.tabs("select","#tabs-image-"+window.app.status.currentProject+"-"+a+"-");return},size:function(){return _.size(this.tabs)},closeAll:function(){var b=$(this.el).children(".tabs");for(var a=b.tabs("length")-1;a>=0;a--){b.tabs("remove",a)}this.tabs=[];b.tabs("destroy");$(this.el).hide();$(this.el).parent().find(".noProject").show()},addDashboard:function(a){var b=$(this.el).children(".tabs");b.tabs("add","#tabs-dashboard-"+window.app.status.currentProject,"Dashboard");b.tabs("add","#tabs-images-"+window.app.status.currentProject,"Images");b.tabs("add","#tabs-annotations-"+window.app.status.currentProject,"Annotations");b.tabs("add","#tabs-algos-"+window.app.status.currentProject,"Expert");$("#explorer > .browser").show();$("#explorer > .noProject").hide();this.tabs.push({idImage:0,view:a});this.tabs.push({idImage:1,view:a});this.tabs.push({idImage:2,view:a});this.tabs.push({idImage:3,view:a})},getDashboard:function(){var a=_.detect(this.tabs,function(b){return b.idImage==0});return a}});var ImageFiltersPanel=Backbone.View.extend({tagName:"div",filter:null,enabled:false,parameters:[],browseImageView:null,initialize:function(a){this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/ImageFiltersPanel.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=$("#imageFiltersPanel"+this.model.get("id"));new DraggablePanelView({el:c,template:_.template(b,this.model.toJSON())}).render();c.find("#contrast"+this.model.get("id")).slider({min:0,max:256,value:128,change:function(d,e){a.redraw()}});c.find("#brightness"+this.model.get("id")).slider({min:0,max:256,value:128,change:function(d,e){a.redraw()}});c.find("input[name=invert]").change(function(){a.redraw()});c.find("input[name=filterActive]").change(function(){a.enabled=($(this).attr("checked")=="checked");a.redraw()});c.find("a[name=reset]").click(function(){c.find("#brightness"+a.model.get("id")).slider("option","value",128);c.find("#contrast"+a.model.get("id")).slider("option","value",128);c.find("input[name=invert]").removeAttr("checked");return false})},updateGetURL:function(){var a=this;var b=function(c){c=this.adjustBounds(c);var f=this.map.getResolution();var i=Math.round((c.left-this.tileOrigin.lon)/(f*this.tileSize.w));var h=Math.round((this.tileOrigin.lat-c.top)/(f*this.tileSize.h));var g=this.map.getZoom();var e=i+h*this.tierSizeInTiles[g].w+this.tileCountUpToTier[g];var k="TileGroup"+Math.floor((e)/256)+"/"+g+"-"+i+"-"+h+".jpg";var d=this.url;var j=_.map(d,function(m){var n="";_.each(a.parameters,function(o){n+=o.key;n+="=";n+=o.value;n+="&"});var l=m.indexOf("method=");if(l==-1){m="vision/process?method=none&url="+m;l=m.indexOf("method=")}return m.substring(0,l)+n+m.substring(l,m.length)});if(OpenLayers.Util.isArray(j)){d=this.selectUrl(k,j)}return d+k};a.browseImageView.map.baseLayer.getURL=b;a.browseImageView.map.baseLayer.redraw()},redraw:function(){if(!this.enabled){this.parameters=[];this.updateGetURL();return}var b=$("#imageFiltersPanel"+this.model.get("id"));var c=parseInt(b.find("#brightness"+this.model.get("id")).slider("value"));var a=parseInt(b.find("#contrast"+this.model.get("id")).slider("value"));var d=(b.find("input[name=invert]").attr("checked")=="checked");this.parameters=[];this.parameters.push({key:"brightness",value:c});this.parameters.push({key:"contrast",value:a});if(d){this.parameters.push({key:"invert",value:true})}this.updateGetURL()}});var LayerSwitcherPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/LayerSwitcher.tpl.html"],function(b){a.doLayout(b)});return this},addBaseLayer:function(e,c){var b=this;var f="layerSwitch-"+c.get("id");var a="layerSwitch-"+c.get("id")+"-"+new Date().getTime();var d=_.template("<li><input type='radio' id='<%=   id %>' name='<%=   radioName %>' checked/><span style='color : #ffffff;'> <%=   name %></span></li>",{id:a,radioName:f,name:e.name.substr(0,15)});$("#layerSwitcher"+this.model.get("id")).find(".baseLayers").append(d);$("#layerSwitcher"+this.model.get("id")).find(".baseLayers").find("#"+a);$("#"+a).change(function(){b.browseImageView.map.setBaseLayer(e)})},addVectorLayer:function(f,e,d){var a=window.app.models.users.get(d).prettyName();var a="layerSwitch-"+e.get("id")+"-"+d+"-"+new Date().getTime();var c=window.app.models.users.get(d).get("color");var b;if(f.isOwner){b=_.template("<li><input id='<%=   id %>' type='checkbox' value='<%=   name %>' checked /><span style='color : #ffffff;'> <%=   name %></span></li>",{id:a,name:f.vectorsLayer.name,color:c})}else{b=_.template("<li><input id='<%=   id %>' type='checkbox' value='<%=   name %>' /> <span style='color : #ffffff;'><%=   name %></span></li>",{id:a,name:f.vectorsLayer.name,color:c})}$("#layerSwitcher"+e.get("id")).find("ul.annotationLayers").append(b);$("#"+a).click(function(){var g=$(this).attr("checked");f.vectorsLayer.setVisibility(g);if(g){_.each(f.vectorsLayer.features,function(h){h.style.display="";f.vectorsLayer.drawFeature(h)})}})},doLayout:function(b){var a=this;var c=_.template(b,{id:a.model.get("id")});$("#layerSwitcher"+a.model.get("id")).html(c);$("#layerSwitcher"+a.model.get("id")).find(".toggleShowBaseLayers").click(function(){$("#layerSwitcher"+a.model.get("id")).find("ul.baseLayers").toggle(300);return false});$("#layerSwitcher"+a.model.get("id")).find(".toggleShowVectorLayers").click(function(){$("#layerSwitcher"+a.model.get("id")).find("ul.annotationLayers").toggle(300);return false});new DraggablePanelView({el:$("#layerSwitcher"+a.model.get("id"))}).render()}});var OverviewMapPanel=Backbone.View.extend({tagName:"div",initialize:function(a){},render:function(){var a=this;require(["text!application/templates/explorer/OverviewMap.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;new DraggablePanelView({el:$("#overviewMap"+a.model.get("id")),template:_.template(b,{id:a.model.get("id")})}).render()}});var OntologyPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.ontologyTreeView=null;this.callback=a.callback;this.browseImageView=a.browseImageView},render:function(){var a=this;var b=new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(e,d){var c=e.get("ontology");var f=new OntologyModel({id:c}).fetch({success:function(h,g){a.ontologyTreeView=new OntologyTreeView({el:$("#ontologyTree"+a.model.get("id")),browseImageView:a.browseImageView,model:h}).render();a.callback(a.ontologyTreeView)}});require(["text!application/templates/explorer/OntologyTree.tpl.html"],function(g){a.doLayout(g)})}});return this},doLayout:function(a){new DraggablePanelView({el:$("#ontologyTree"+this.model.get("id")),template:_.template(a,{id:this.model.get("id")})}).render()}});var UploadFormView=Backbone.View.extend({initialize:function(a){},events:{},render:function(){var a=this;require(["text!application/templates/upload/UploadForm.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(a){$(this.el).html(a);$("#file_upload").fileUploadUI({uploadTable:$("#files"),downloadTable:$("#files"),buildUploadRow:function(c,b){return $('<tr><td class="file_upload_preview"></td><td>'+c[b].name+'</td><td class="file_upload_progress"><div></div></td><td class="file_upload_start"><button class="ui-state-default ui-corner-all" title="Start Upload"><span class="ui-icon ui-icon-circle-arrow-e">Start Upload</span></button></td><td class="file_upload_cancel"><button class="ui-state-default ui-corner-all" title="Cancel"><span class="ui-icon ui-icon-cancel">Cancel</span></button></td></tr>')},buildDownloadRow:function(b){return $("<tr><td>"+b.name+"</td></tr>")},beforeSend:function(e,d,b,g,c,f){c.uploadRow.find(".file_upload_start button").click(function(){f();return false})}});$("#start_uploads").click(function(){$(".file_upload_start button").click();return false})}});var ImageThumbView=Backbone.View.extend({className:"thumb-wrap",events:{},initialize:function(a){this.id="thumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){this.model.set({project:window.app.status.currentProject});var a=this;require(["text!application/templates/image/ImageThumb.tpl.html"],function(c){var b=a.model.toJSON();b.title=(b.filename.length<27)?b.filename:b.filename.substr(0,24)+"...";b.resolution=Math.round(1000*b.resolution)/1000;$(a.el).html(_.template(c,b));$(a.el).find("a.title-thumb-"+a.model.id).twipsy();$(a.el).find("#getImageProperties-"+a.model.id).click(function(){$("#image-properties").remove();new ImagePropertiesView({model:a.model}).render();return false})});return this}});var ImageSelectView=Backbone.View.extend({events:{},initialize:function(a){this.id="thumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){var a=this;this.model.set({project:window.app.status.currentProject});var a=this;require(["text!application/templates/image/ImageChoice.tpl.html"],function(b){$(a.el).html(_.template(b,a.model.toJSON()))});return this}});var ImageView=Backbone.View.extend({tagName:"div",initialize:function(a){this.images=null;this.container=a.container;this.page=a.page;this.nb_thumb_by_page=30;this.appendingThumbs=false;if(this.page==undefined){this.page=0}},render:function(){var a=this;$(a.el).empty();a.appendThumbs(a.page);$(window).scroll(function(){var b=""+window.location;if(b.search("#tabs-images-")==-1){return}if(a.appendingThumbs){return}if(($(window).scrollTop()+50)>=$(document).height()-$(window).height()){console.log("$(window).scrollTop() : "+$(window).scrollTop());console.log("$(document).height()- $(window).height() "+($(document).height()-$(window).height()));a.appendingThumbs=true;a.appendThumbs(++a.page);a.appendingThumbs=false}});return this},showLoading:function(){window.app.view.message("Loading...","","info")},appendThumbs:function(e){var c=this;var d=Math.abs(e)*this.nb_thumb_by_page;var b=(Math.abs(e)+1)*this.nb_thumb_by_page;if(Math.abs(e)*this.nb_thumb_by_page<c.model.size()){this.showLoading()}c.tabsContent=new Array();var g=d;while(g<b&&g<this.model.size()){var f=this.model.at(g);var a=new ImageThumbView({model:f}).render();$(c.el).append(a.el);g++;c.tabsContent.push(f.id)}},add:function(c){var b=this;var a=new ImageThumbView({model:c,className:"row",id:"thumb"+c.get("id")}).render();$(b.el).append(a.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(a){return;var b=this;var c=b.tabsContent;a.each(function(d){if(_.indexOf(b.tabsContent,d.id)==-1){b.add(d);b.tabsContent.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){b.remove(d);b.tabsContent=_.without(b.tabsContent,d)})}});var ImageTabsView=Backbone.View.extend({tagName:"div",images:null,idProject:null,imagesProject:null,searchPanel:null,initialize:function(b){var a=this;this.idProject=b.idProject;this.container=b.container;this.imagesProject=b.model;this.listproject="listimage"+this.idProject;this.pageproject="pagerimage"+this.idProject;this.tab=2;this.timeoutHnd=null},render:function(){var a=this;$(a.el).empty();$(a.el).append('<table id="listimage'+a.idProject+'" align="center"></table><div id="pagerimage'+this.idProject+'"></div>');a.renderImageListProject();a.loadDataImageListProject(a.model)},refresh:function(){this.refreshImageList()},refreshImageList:function(){var a=this;$("#"+a.listproject).jqGrid("clearGridData",true);a.imagesProject.fetch({success:function(c,b){a.loadDataImageListProject(c)}})},loadDataImageListProject:function(e){var a=this;var d=new Array();var c=0;e.each(function(g){var f='<a href="#tabs-image-'+a.idProject+"-"+g.id+'-">Click here to see the image</a>';d[c]={id:g.id,base:g.get("baseImage"),thumb:g.get("thumb"),filename:g.get("filename"),slide:g.get("slide"),type:g.get("mime"),width:g.get("width"),height:g.get("height"),magnification:g.get("magnification"),resolution:g.get("resolution"),annotations:g.get("numberOfAnnotations"),added:g.get("created"),See:f};c++});for(var b=0;b<d.length;b++){$("#"+a.listproject).jqGrid("addRowData",d[b].id,d[b])}$("#"+a.listproject).jqGrid("sortGrid","filename",false)},renderImageListProject:function(){var b=this;var e="thumb";var a=$("#tabs-images-"+b.idProject);var d=a.width();var c=$(window).height()*0.7;$("#"+b.listproject).jqGrid({datatype:"local",width:d,height:c,colNames:["id","base","thumb","filename","type","sample","width","height","magnification","resolution","annotations","added","see"],colModel:[{name:"id",index:"id",width:1,sorttype:"int"},{name:"base",index:"base",width:1,sorttype:"int"},{name:e,index:e,width:50},{name:"filename",index:"filename",width:220},{name:"type",index:"type",width:50},{name:"slide",index:"slide",width:50},{name:"width",index:"width",width:50},{name:"height",index:"height",width:50},{name:"magnification",index:"magnification",width:50},{name:"resolution",index:"resolution",width:50},{name:"annotations",index:"annotations",width:75},{name:"added",index:"added",width:90,sorttype:"date",formatter:b.dateFormatter},{name:"See",index:"See",width:400,sortable:false}],onSelectRow:function(g){var f=$("#"+b.listproject).find("#"+g).find(".cbox").attr("checked");if(f){$("#"+b.listproject).find("#"+g).find("td").css("background-color","CD661D")}else{$("#"+b.listproject).find("#"+g).find("td").css("background-color","a0dc4f")}},loadComplete:function(){$("#"+b.listproject).find("tr").each(function(f){if(f!=0){var g=$(this).find('[aria-describedby$="_'+e+'"]');$(g).html('<img src="'+$(g).text()+'" width=30/>')}})},pager:"#"+b.pageproject,sortname:"id",viewrecords:true,sortorder:"asc",rowNum:30,rowList:[10,30,50,100],caption:"Images from project"});$("#"+b.listproject).jqGrid("navGrid","#"+b.listproject,{edit:false,add:false,del:false});$("#"+b.listproject).jqGrid("hideCol","id");$("#"+b.listproject).jqGrid("hideCol","base")},dateFormatter:function(b,c,d){var a=new Date();a.setTime(b);return a.getFullYear()+"-"+a.getMonth()+"-"+a.getDate()}});var ImagePropertiesView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){this.dialog=new ConfirmDialogView({el:"#dialogs",template:_.template(a,this.model.toJSON()),dialogAttr:{dialogID:"#image-properties",autoOpen:false,buttons:{Close:function(){$(this).dialog("close")}},close:function(b){$(this).dialog("destroy")}}}).render();return this},render:function(){var a=this;require(["text!application/templates/image/ImageProperties.tpl.html"],function(b){a.doLayout(b);a.printProperties()});return this},printProperties:function(){var a=this;require(["text!application/templates/image/ImageProperty.tpl.html"],function(b){new ImagePropertyCollection({image:a.model.get("baseImage")}).fetch({success:function(e,c){var d=$("#image-properties-content");$("#image-properties-content").empty();e.each(function(f){var g=_.template(b,{key:f.get("key"),value:f.get("value")});d.append(g)});$("#image-properties").dialog("open");$("ul#image-properties-content>li").tsort()}})})}});var OntologyPanelView=Backbone.View.extend({$tree:null,$infoOntology:null,$infoTerm:null,$panel:null,$addTerm:null,$editTerm:null,$deleteTerm:null,$buttonAddTerm:null,$buttonEditTerm:null,$buttonDeleteTerm:null,$buttonEditOntology:null,$buttonDeleteOntology:null,ontologiesPanel:null,expanse:false,events:{"click .addTerm":"addTerm","click .editTerm":"editTerm","click .deleteTerm":"deleteTerm","click .editOntology":"editOntology","click .deleteOntology":"deleteOntology"},initialize:function(a){this.container=a.container;this.ontologiesPanel=a.ontologiesPanel},render:function(){var a=this;a.$panel=$(a.el);a.$tree=a.$panel.find("#treeontology-"+a.model.id);a.$infoOntology=a.$panel.find("#infoontology-"+a.model.id);a.$infoTerm=a.$panel.find("#infoterm-"+a.model.id);a.$addTerm=a.$panel.find("#dialog-add-ontology-term");a.$editTerm=a.$panel.find("#dialog-edit-ontology-term");a.$deleteTerm=a.$panel.find("#dialogsTerm");a.$buttonAddTerm=a.$panel.find($("#buttonAddTerm"+a.model.id));a.$buttonEditTerm=a.$panel.find($("#buttonEditTerm"+a.model.id));a.$buttonDeleteTerm=a.$panel.find($("#buttonDeleteTerm"+a.model.id));a.$buttonEditOntology=a.$panel.find($("#buttonEditOntology"+a.model.id));a.$buttonDeleteOntology=a.$panel.find($("#buttonDeleteOntology"+a.model.id));a.buildOntologyTree();a.buildButton();a.buildInfoOntologyPanel();a.buildInfoTermPanel();return this},refresh:function(){var a=this;a.model.fetch({success:function(c,b){window.app.models.terms.fetch({success:function(e,d){$("#ontologyTitle"+a.model.id).empty();$("#ontologyTitle"+a.model.id).append(a.model.get("name"));a.clear();a.render()}})}})},clear:function(){var a=this;a.$panel.empty();require(["text!application/templates/ontology/OntologyTabContent.tpl.html"],function(b){a.$panel.html(_.template(b,{id:a.model.get("id"),name:a.model.get("name")}));return this});return this},getCurrentTermId:function(){var a=this.$tree.dynatree("getActiveNode");if(a==null){return null}else{return a.data.id}},addTerm:function(){var a=this;a.$addTerm.remove();new OntologyAddOrEditTermView({ontologyPanel:a,el:a.el,ontology:a.model,model:null}).render()},editTerm:function(){var a=this;a.$editTerm.remove();var b=a.$tree.dynatree("getActiveNode");if(b==null){window.app.view.message("Term","You must select a term!","success");return}new TermModel({id:b.data.id}).fetch({success:function(d,c){new OntologyAddOrEditTermView({ontologyPanel:a,el:a.el,model:d,ontology:a.model}).render()}});return false},deleteTerm:function(){var a=this;var b=a.getCurrentTermId();var c=window.app.models.terms.get(b);new AnnotationCollection({term:b}).fetch({success:function(e,d){if(e.length==0){a.buildDeleteTermConfirmDialog(c)}else{a.buildDeleteTermWithAnnotationConfirmDialog(c,e.length)}}})},editOntology:function(){var a=this;$("#editontology").remove();a.editOntologyDialog=new EditOntologyDialog({ontologyPanel:a,el:a.el,model:a.model}).render()},deleteOntology:function(){var a=this;new ProjectCollection({ontology:a.model.id}).fetch({success:function(c,b){if(c.length>0){a.refuseDeleteOntology(c.length)}else{a.acceptDeleteOntology()}}})},refuseDeleteOntology:function(b){var a=this;require(["text!application/templates/ontology/OntologyDeleteRefuseDialog.tpl.html"],function(c){var d=new ConfirmDialogView({el:"#dialogsDeleteOntologyRefuse",template:_.template(c,{name:a.model.get("name"),numberOfProject:b}),dialogAttr:{dialogID:"#delete-ontology-refuse"}}).render();$("#deleteRefuseOntologyButton").click(function(){$("#delete-ontology-refuse").modal("hide");$("#delete-ontology-refuse").remove();return false})})},acceptDeleteOntology:function(){var a=this;require(["text!application/templates/ontology/OntologyDeleteConfirmDialog.tpl.html"],function(b){new ConfirmDialogView({el:"#dialogsDeleteOntologyAccept",template:_.template(b,{ontology:a.model.get("name")}),dialogAttr:{dialogID:"#delete-ontology-confirm"}}).render();$("#deleteOntologyButton").click(function(){a.model.destroy({success:function(d,c){a.ontologiesPanel.refresh();$("#delete-ontology-confirm").modal("hide");$("#delete-ontology-confirm").remove()},error:function(d,c){var e=$.parseJSON(c.responseText)}});return false});$("#closeDeleteOntologyDialog").click(function(){$("#dialogsDeleteOntologyAccept").modal("hide");$("#dialogsDeleteOntologyAccept").modal("remove");return false});$("#dialogsDeleteOntologyAccept").modal("show")})},selectTerm:function(b){var a=this;a.$tree.dynatree("getTree").activateKey(b)},buildDeleteTermConfirmDialog:function(b){var a=this;require(["text!application/templates/ontology/OntologyDeleteTermConfirmDialog.tpl.html"],function(c){var d=new ConfirmDialogView({el:"#dialogsTerm",template:_.template(c,{term:b.get("name"),ontology:a.model.get("name")}),dialogAttr:{dialogID:"#delete-term-confirm"}}).render();$("#closeDeleteTermDialog").click(function(){$("#delete-term-confirm").modal("hide");$("#delete-term-confirm").remove();return false});$("#deleteTermButton").click(function(){new BeginTransactionModel({}).save({},{success:function(f,e){a.deleteTermWithoutAnnotationTerm(b)},error:function(f,e){window.app.view.message("ERROR","error transaction begin","error")}});return false})})},buildDeleteTermWithAnnotationConfirmDialog:function(b,c){var a=this;require(["text!application/templates/ontology/OntologyDeleteTermWithAnnotationConfirmDialog.tpl.html"],function(d){var e=new ConfirmDialogView({el:"#dialogsTerm",template:_.template(d,{term:b.get("name"),ontology:a.model.get("name"),numberOfAnnotation:c}),dialogAttr:{dialogID:"#dialogsTerm",width:400,height:300,buttons:{"Delete all link and delete term":function(){new BeginTransactionModel({}).save({},{success:function(g,f){a.deleteTermWithAnnotationTerm(b)},error:function(g,f){window.app.view.message("ERROR","error transaction begin","error")}})},Cancel:function(){$("#dialogsTerm").dialog("close")}},close:function(f){}}}).render()})},deleteTermWithAnnotationTerm:function(c){var b=this;var a=0;new AnnotationCollection({term:c.id}).fetch({success:function(e,d){if(e.size()==0){b.removeAnnotationTermCallback(0,0,c);return}e.each(function(f){new AnnotationTermModel({term:c.id,annotation:f.id}).destroy({success:function(h,g){b.removeAnnotationTermCallback(e.length,++a,c)}})})}})},deleteTermWithoutAnnotationTerm:function(c){var b=this;var a=0;new RelationTermCollection({term:c.id}).fetch({success:function(e,d){if(e.size()==0){b.removeRelationTermCallback(0,0,c);return}e.each(function(g){var f=g.toJSON();new RelationTermModel({relation:f.relation.id,term1:f.term1.id,term2:f.term2.id}).destroy({success:function(i,h){b.removeRelationTermCallback(e.length,++a,c)}})})}})},removeAnnotationTermCallback:function(d,a,c){var b=this;if(a<d){return}b.deleteTermWithoutAnnotationTerm(c)},removeRelationTermCallback:function(d,a,c){var b=this;if(a<d){return}new TermModel({id:c.id}).destroy({success:function(f,e){new EndTransactionModel({}).save();window.app.view.message("Term",e.message,"success");b.refresh();$("#delete-term-confirm").modal("hide");$("#delete-term-confirm").remove()},error:function(f,e){var g=$.parseJSON(e.responseText);$("#delete-term-error-message").empty();$("#delete-term-error-label").show();$("#delete-term-error-message").append(g.errors)}})},buildButton:function(){var a=this;a.$buttonAddTerm.button({icons:{secondary:"ui-icon-plus"}});a.$buttonEditTerm.button({icons:{secondary:"ui-icon-pencil"}});a.$buttonDeleteTerm.button({icons:{secondary:"ui-icon-trash"}});a.$buttonEditOntology.button({icons:{secondary:"ui-icon-pencil"}});a.$buttonDeleteOntology.button({icons:{secondary:"ui-icon-trash"}})},buildInfoOntologyPanel:function(){var b=this;b.$infoOntology.empty();var d=b.model.get("user");var a=window.app.models.users.get(d);var e="Nobody";var g=b.model.get("users");if(_.size(g)>0){var f=[];_.each(g,function(h){if(h==d){return}f.push(window.app.models.users.get(h).prettyName())});e=f.join(", ")}var c=_.template("<div id='userontologyinfo-<%=   id %>' style='padding:5px;'><ul><li><b>Ontology</b> : <%=   ontologyName %>.</li><li><b>Owner</b> : <%=   owner %>.</li><li><b>Shared to</b> : <%=   sharedTo %>.</li><li class='projectsLinked'></li></ul></div>",{id:b.model.id,ontologyName:b.model.get("name"),owner:a.prettyName(),sharedTo:e});b.$infoOntology.html(c);new OntologyProjectModel({ontology:b.model.id}).fetch({success:function(k,h){var j=[];k.each(function(m){var l=_.template("<a href='#tabs-dashboard-<%=   idProject %>'><%=   projectName %></a>",{idProject:m.get("id"),projectName:m.get("name")});j.push(l)});var i=_.template("<b>Projects</b> : <%=   projects %>",{projects:j.join(", ")});b.$infoOntology.find(".projectsLinked").html(i)}})},buildInfoTermPanel:function(){},buildOntologyTree:function(){var a=this;var b=new Date();a.$tree.empty();a.$tree.dynatree({children:a.model.toJSON(),onExpand:function(){},onClick:function(d,c){if(window.app.models.ontologies.get(d.data.id)==undefined){a.updateInfoPanel(d.data.id,d.data.title)}},onSelect:function(c,d){a.updateInfoPanel(d.data.id,d.data.title)},onActivate:function(c){a.updateInfoPanel(c.data.id,c.data.title)},onDblClick:function(d,c){},onRender:function(d,c){a.$tree.find("a.dynatree-title").css("color","black")},initId:"treeDataOntology-"+a.model.id+b.getTime(),cookieId:"dynatree-Ontology-"+a.model.id+b.getTime(),idPrefix:"dynatree-Ontology-"+a.model.id+b.getTime()+"-",debugLevel:0});a.$tree.dynatree("getRoot").visit(function(e){if(e.children!=null){return}var g=e.data.title;var d=e.data.color;var f="<a href='#ontology/<%=   idOntology %>/<%=   idTerm %>' onClick='window.location.href = this.href;'><%=   title %> <span style='background-color:<%=   color %>'>&nbsp;&nbsp;&nbsp;&nbsp;</span></a>";var c=_.template(f,{idOntology:a.model.id,idTerm:e.data.id,title:g,color:d});e.setTitle(c)});a.$tree.dynatree("getRoot").visit(function(c){c.expand(true)})},updateInfoPanel:function(e,d){var b=this;var h=new google.visualization.DataTable();h.addColumn("string","Project");h.addColumn("number","Number of annotations");var f=0;var g=new StatsTermCollection({term:e});var a=function(l,k){var i="piechart-"+b.model.id;$("#"+i).empty();var j=false;h.addRows(_.size(l));l.each(function(m){if(m.get("value")>0){j=true}h.setValue(f,0,m.get("key"));h.setValue(f,1,m.get("value"));f++});if(!j){$("#"+i).hide();return}new google.visualization.PieChart(document.getElementById(i)).draw(h,{width:400,height:270,title:"Annotations by projects"});$("#"+i).show()};var c=function(o,l){var i="columchart-"+b.model.id;$("#"+i).empty();var k=false;var n=new google.visualization.DataTable();n.addRows(_.size(o));n.addColumn("string","");n.addColumn("number",0);var m=0;o.each(function(j){if(j.get("value")>0){k=true}n.setValue(m,0,j.get("key"));n.setValue(m,1,j.get("value"));m++});if(!k){$("#"+i).hide();return}new google.visualization.ColumnChart(document.getElementById(i)).draw(n,{title:"Annotations by projects",width:400,height:270,vAxis:{title:"Number of annotations"},hAxis:{title:"Project"}});$("#"+i).show()};g.fetch({success:function(j,i){c(j,i);a(j,i)}})}});var OntologyView=Backbone.View.extend({tagName:"div",self:this,alreadyBuild:false,$tabsOntologies:null,ontologiesPanel:null,idOntology:null,addOntologyDialog:null,events:{"click .addOntology":"showAddOntologyPanel","click .refreshOntology":"refresh"},initLoading:function(){$(this.el).find("#ontologyLoading").html("Loading...")},showLoading:function(){$(this.el).find("#ontologytreepanel").hide();$(this.el).find("#ontologyLoading").show()},hideLoading:function(){$(this.el).find("#ontologyLoading").hide();$(this.el).find("#ontologytreepanel").show()},initialize:function(a){this.container=a.container;this.idOntology=a.idOntology;this.idTerm=a.idTerm},refresh:function(){var a=this;window.app.models.terms.fetch({success:function(c,b){window.app.models.ontologies.fetch({success:function(e,d){a.render()}})}})},refresh:function(b,c){var a=this;this.idOntology=b;this.idTerm=c;window.app.models.terms.fetch({success:function(e,d){window.app.models.ontologies.fetch({success:function(g,f){a.render()}})}})},select:function(b){var a=this;this.idOntology=b;a.render()},render:function(){var a=this;require(["text!application/templates/ontology/OntologyList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{}));a.initLoading();a.showLoading();a.$tabsOntologies=$(a.el).find("#tabsontology");a.initOntologyTabs();a.hideLoading();return this},showAddOntologyPanel:function(){var a=this;$("#addontology").remove();a.addOntologyDialog=new AddOntologyDialog({ontologiesPanel:a,el:a.el}).render()},select:function(c,e){var b=this;var a=0;var d=0;b.model.each(function(f){if(c==f.get("id")){a=d}d=d+1});if(e!=undefined){b.ontologiesPanel[a].selectTerm(e)}b.$tabsOntologies.accordion("activate",a)},initOntologyTabs:function(){var a=this;require(["text!application/templates/ontology/OntologyTab.tpl.html","text!application/templates/ontology/OntologyTabContent.tpl.html"],function(c,b){a.ontologiesPanel=new Array();a.model.each(function(e){a.addOntologyToTab(c,b,{id:e.get("id"),name:e.get("name")});var d=new OntologyPanelView({model:e,el:$(a.el).find("#tabsontology-"+e.id),container:a,ontologiesPanel:a});d.render();a.ontologiesPanel.push(d)});if(!a.alreadyBuild){a.$tabsOntologies.accordion({fillSpace:true});$("#tabsontology h3 a").click(function(){window.location=$(this).attr("href");return false})}a.select(a.idOntology,a.idTerm);$(".accordeonOntology").css("height","auto");$(".accordeonOntology").css("width","auto")})},addOntologyToTab:function(c,b,a){this.$tabsOntologies.append(_.template("<h3><a id='ontologyTitle<%=   ontologyID %>' href='#ontology/<%=   ontologyID %>'><%=   ontologyName %></a></h3>",{ontologyID:a.id,ontologyName:a.name}));this.$tabsOntologies.append(_.template(b,a))}});var OntologyAddOrEditTermView=Backbone.View.extend({ontologyPanel:null,ontologyDialog:null,ontology:null,$tree:null,$panel:null,$textboxName:null,$colorChooser:null,$inputOldColor:null,$inputNewColor:null,$errorMessage:null,$errorLabel:null,$addFolderButton:null,action:null,events:{"click .addFolder":"addFolder"},initialize:function(a){this.container=a.container;this.ontologyPanel=a.ontologyPanel;this.ontology=a.ontology;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyAddOrEditTermView.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;if(a.model==null){a.action="Add";a.createNewEmpty()}else{a.action="Edit"}a.$termDialog=$(a.el).find("#dialog-"+a.action+"-ontology-term");$("#dialog-Edit-ontology-term").replaceWith("");$("#dialog-Add-ontology-term").replaceWith("");var b=_.template(c,{oldColor:a.model.get("color"),action:a.action});$(a.el).append(b);a.$panel=$(a.el);a.$termDialog=$(a.el).find("#dialog-"+a.action+"-ontology-term");a.$tree=a.$panel.find("#"+a.action+"ontologytermtree");a.$from=a.$panel.find($("#form-"+a.action+"-ontology-term"));a.$textboxName=a.$panel.find("#"+a.action+"termname");a.$colorChooser=a.$panel.find("#colorpicker1AddOrEditTerm");a.$inputOldColor=a.$panel.find("#oldColorAddOrEditTerm");a.$inputNewColor=a.$panel.find("#color1AddOrEditTerm");a.$addFolderButton=a.$panel.find(".addFolder");a.$errorMessage=a.$panel.find("#"+a.action+"ontologytermerrormessage");a.$errorLabel=a.$panel.find("#"+a.action+"ontologytermerrorlabel");a.$from.submit(function(){if(a.action=="Edit"){a.updatedOntologyTerm()}else{a.createOntologyTerm()}return false});a.$from.find("input").keydown(function(d){if(d.keyCode==13){a.$from.submit();return false}});a.clearOntologyTermPanel();a.buildNameInfo();a.buildColorInfo();a.buildParentInfo();a.ontologyDialog=$(a.$termDialog).modal({keyboard:true,show:true});$("#AddOrEditTermButton").click(function(){a.$from.submit();return false});$("#closeAddOrEditTermDialog").click(function(){a.$termDialog.modal("hide");a.$termDialog.remove();return false});a.open();return this},createNewEmpty:function(){var a=this;a.model=new TermModel({id:-1,name:"",color:"#ff0000"})},buildNameInfo:function(){var a=this;a.$textboxName.bind("keyup mouseup change click",function(g){var d=a.$tree.dynatree("getTree").getNodeByKey(a.model.id);var c="#119b04";var f="<span style='color:<%=   color %>'><%=   title %></span>";var b=_.template(f,{title:a.$textboxName.val(),color:c});if(d!=null){d.setTitle(b)}});a.$textboxName.val(a.model.get("name"))},buildColorInfo:function(){var c=this;var a=c.$colorChooser.farbtastic("#color1AddOrEditTerm");var b=c.model.get("color");c.$inputOldColor.val(b);c.$inputNewColor.val(b);c.$inputOldColor.css("background",b);c.$inputNewColor.css("background",b);c.$inputNewColor.css("color",c.$inputOldColor.css("color"))},addFolder:function(){},buildParentInfo:function(){var a=this;a.$addFolderButton.button({icons:{secondary:"ui-icon-folder-collapsed"}});a.$tree.empty();a.$tree.dynatree({children:a.ontology.toJSON(),onExpand:function(){},onRender:function(e,d){a.$tree.find("a.dynatree-title").css("color","black")},onClick:function(e,d){},onSelect:function(d,e){},onCustomRender:function(d){},onDblClick:function(e,d){},dnd:{onDragStart:function(d){if(d.data.key!=a.model.id){return false}return true},onDragStop:function(d){},autoExpandMS:1000,preventVoidMoves:true,onDragEnter:function(e,d){return true},onDragOver:function(f,e,d){},onDragLeave:function(e,d){},onDrop:function(g,f,e,h,d){if(e=="over"){f.move(g,e);g.data.isFolder=true;g.render()}else{f.move(g,e)}}},generateIds:true,initId:""+a.action+"treeDataOntology-"+a.model.id,cookieId:""+a.action+"dynatree-Ontology-"+a.model.id,idPrefix:""+a.action+"dynatree-Ontology-"+a.model.id+"-",debugLevel:0});if(a.action=="Add"){var c=a.$tree.dynatree("getTree").getNodeByKey(a.ontology.id);var b=c.addChild({title:"",key:-1,tooltip:"This folder and all child nodes were added programmatically.",isFolder:false})}a.$tree.dynatree("getRoot").visit(function(d){d.expand(true)});if(a.action=="Edit"){a.$textboxName.click()}},getNewName:function(){var a=this;return a.$textboxName.val()},getNewParent:function(){var a=this;var b=a.$tree.dynatree("getTree").getNodeByKey(a.model.id);return b.parent.data.id},getNewColor:function(){return this.$inputNewColor.val()},refresh:function(){},open:function(){var a=this;a.clearOntologyTermPanel();a.ontologyDialog.modal("show")},clearOntologyTermPanel:function(){var a=this;a.$errorMessage.empty();a.$errorLabel.hide()},updatedOntologyTerm:function(){var c=this;c.$errorMessage.empty();c.$errorLabel.hide();var h=c.model.id;var e=c.getNewName();var g=c.model.get("parent");var f=c.getNewParent();var d=true;if(g!=null&&window.app.models.ontologies.get(g)==undefined){d=false}var a=true;if(window.app.models.ontologies.get(f)==undefined){a=false}var b=c.getNewColor();c.model.set({name:e,color:b});c.model.save({name:e,color:b},{success:function(j,i){if(f!=g){if(d&&a){c.close()}else{if(d){c.addRelation(h,f)}else{if(a){c.resetRelation(h,g,null)}else{c.resetRelation(h,g,f)}}}}else{c.close()}},error:function(j,i){var k=$.parseJSON(i.responseText);c.$errorLabel.show();c.$errorMessage.append(k.errors)}})},createOntologyTerm:function(){var c=this;c.$errorMessage.empty();c.$errorLabel.hide();var f=c.model.id;var d=c.getNewName();var a=true;var e=c.getNewParent();if(window.app.models.ontologies.get(e)==undefined){a=false}var b=c.getNewColor();c.model.set({name:d,color:b});c.model=new TermModel({name:d,color:b,ontology:c.ontology.id}).save({name:d,color:b,ontology:c.ontology.id},{success:function(h,g){if(a){window.app.view.message("Term",g.message,"success");c.close()}else{c.addRelation(g.term.id,e)}},error:function(h,g){var i=$.parseJSON(g.responseText);c.$errorLabel.show();c.$errorMessage.append(i.errors)}})},resetRelation:function(d,b,c){var a=this;new RelationTermModel({term1:b,term2:d}).destroy({success:function(f,e){if(c!=null){a.addRelation(d,c)}else{window.app.view.message("Term",e.message,"success");a.close()}},error:function(f,e){var g=$.parseJSON(e.responseText);a.$errorLabel.show();a.$errorMessage.append(g.errors)}})},addRelation:function(c,b){var a=this;new RelationTermModel({}).save({term1:b,term2:c},{success:function(e,d){window.app.view.message("Term",d.message,"success");a.close()},error:function(e,d){var f=$.parseJSON(d.responseText);a.$errorLabel.show();a.$errorMessage.append(f.errors)}})},close:function(){var a=this;this.ontologyPanel.refresh();a.$termDialog.modal("hide")}});var OntologyTreeView=Backbone.View.extend({tagName:"div",initialize:function(a){this.tree=null;this.activeEvent=true;this.browseImageView=a.browseImageView;this.idAnnotation=null},showColors:function(){$(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.children!=null){return}var e=c.data.title;var b=c.data.color;var d="<%=   title %> <span style='background-color:<%=   color %>'>&nbsp;&nbsp;</span> ";if(!c.data.isFolder){d=d+"(<span id='usercount"+c.data.key+"'>0</span>)"}var a=_.template(d,{title:e,color:b});c.setTitle(a)})},render:function(){var a=this;require(["text!application/templates/explorer/OntologyTreeWrapper.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){$(this.el).html(_.template(b,{}));this.tree=$(this.el).find(".tree");var a=this;$(this.el).find(".tree").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:this.model.toJSON(),onSelect:function(c,d){if(!a.activeEvent){return}if(a.idAnnotation==null){return}if(d.isSelected()){a.linkTerm(d.data.key)}else{if(!d.isSelected()){a.unlinkTerm(d.data.key)}}},onDblClick:function(d,c){d.toggleSelect()},onRender:function(d,c){$(c).find("span.dynatree-icon").css({"background-image":"url(css/custom-theme/images/ui-icons_ffffff_256x240.png)"})},initId:"treeData"+this.model.id,cookieId:"dynatree-Cb"+this.model.id,idPrefix:"dynatree-Cb"+this.model.id+"-"});a.showColors();$(this.el).find(".tree").dynatree("getRoot").visit(function(c){c.expand(true)});return this},clear:function(){var a=this;this.activeEvent=false;$(this.el).find(".otherUsersTerms").empty();$(this.el).find(".tree").dynatree("getRoot").visit(function(b){b.select(false);$("#usercount"+b.data.key).text("0")});this.activeEvent=true},clearAnnotation:function(){this.idAnnotation=null},check:function(b){var a=this;a.activeEvent=false;(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==b){c.select(true)}});a.activeEvent=true},uncheck:function(b){var a=this;a.activeEvent=false;(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==b){c.select(false)}});a.activeEvent=true},refresh:function(a){var b=this;console.log("refresh term for annotation "+a);this.idAnnotation=a;var c=function(e,d){b.clear();b.activeEvent=false;e.each(function(g){var f=g.get("term");var h=g.get("user");_.each(h,function(i){if(i==window.app.status.user.id){b.check(f)}});$("#usercount"+f).text(h.length)});b.activeEvent=true};new AnnotationTermCollection({idAnnotation:a}).fetch({success:c})},getTermsChecked:function(){var a=[];(this.el).find(".tree").dynatree("getRoot").visit(function(b){if(b.isSelected()){a.push(b.data.key)}});return a},linkTerm:function(b){var a=this;new AnnotationTermModel({annotation:this.idAnnotation,term:b}).save({annotation:this.idAnnotation,term:b},{success:function(d,c){window.app.view.message("Annotation Term",c.message,"success");a.browseImageView.reloadAnnotation(a.idAnnotation);a.browseImageView.refreshAnnotationTabs(b)},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Annotation-Term",e.errors,"error")}})},unlinkTerm:function(b){var a=this;new AnnotationTermModel({annotation:this.idAnnotation,term:b}).destroy({success:function(d,c){window.app.view.message("Annotation Term",c.message,"success");a.browseImageView.reloadAnnotation(a.idAnnotation);a.browseImageView.refreshAnnotationTabs(b)},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Annotation-Term",e.errors,"error")}})}});var EditOntologyDialog=Backbone.View.extend({ontologyPanel:null,editOntologyDialog:null,initialize:function(a){this.container=a.container;this.ontologyPanel=a.ontologyPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyEditDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;$("#editontology").replaceWith("");$("#addontology").replaceWith("");var b=_.template(c,{});$(a.el).append(b);$("#login-form-edit-ontology").submit(function(){a.editOntology();return false});$("#login-form-edit-ontology").find("input").keydown(function(d){if(d.keyCode==13){$("#login-form-edit-ontology").submit();return false}});a.editOntologyDialog=$("#editontology").modal({keyboard:true,modal:true});$("#editOntologyButton").click(function(){$("#login-form-edit-ontology").submit();return false});$("#closeEditOntologyDialog").click(function(){$("#editontology").modal("hide");$("#editontology").remove();return false});a.open();a.fillForm();return this},fillForm:function(){var a=this;$("#ontology-edit-name").val(a.model.get("name"))},refresh:function(){},open:function(){var a=this;a.clearEditOntologyPanel();$("#editontology").modal("show")},clearEditOntologyPanel:function(){var a=this;$("#ontologyediterrormessage").empty();$("#ontologyediterrorlabel").hide();$("#ontology-edit-name").val("")},editOntology:function(){var a=this;$("#ontologyediterrormessage").empty();$("#ontologyediterrorlabel").hide();var b=$("#ontology-edit-name").val().toUpperCase();var c=a.model;c.unset("children");c.save({name:b},{success:function(e,d){window.app.view.message("Ontology",d.message,"success");$("#editontology").modal("hide");a.ontologyPanel.refresh()},error:function(e,d){var f=$.parseJSON(d.responseText);$("#ontologyediterrorlabel").show();$("#ontologyediterrormessage").append(f.errors)}})}});var AddOntologyDialog=Backbone.View.extend({ontologiesPanel:null,addOntologyDialog:null,initialize:function(a){this.container=a.container;this.ontologiesPanel=a.ontologiesPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyAddDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var b=this;var d=_.template(c,{});$("#editontology").replaceWith("");$("#addontology").replaceWith("");$(b.el).append(d);var a=window.app.models.users.get(window.app.status.user);$("#ontologyuser").append(a.get("username")+" ("+a.get("firstname")+" "+a.get("lastname")+")");$("#login-form-add-ontology").submit(function(){b.createOntology();return false});$("#login-form-add-ontology").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-add-ontology").submit();return false}});b.addOntologyDialog=$("#addontology").modal({keyboard:true});$("#saveOntologyButton").click(function(){$("#login-form-add-ontology").submit();return false});$("#closeAddOntologyDialog").click(function(){$("#addontology").modal("hide");$("#addontology").remove();return false});b.open();return this},refresh:function(){},open:function(){var a=this;a.clearAddOntologyPanel();$("#addontology").modal("show")},clearAddOntologyPanel:function(){$("#errormessage").empty();$("#ontologyerrorlabel").hide();$("#ontology-name").val("")},createOntology:function(){var a=this;$("#errormessage").empty();$("#ontologyerrorlabel").hide();var b=$("#ontology-name").val().toUpperCase();var c=$("input[type=radio][name=ontologyradio]:checked").attr("value");var d=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(e,f){d.push($(f).attr("value"))});var c=new OntologyModel({name:b}).save({name:b},{success:function(f,e){window.app.view.message("Ontology",e.message,"success");var g=e.ontology.id;a.ontologiesPanel.refresh(g);window.app.models.ontologies.add(c);$("#addontology").modal("hide")},error:function(f,e){var g=$.parseJSON(e.responseText);$("#ontologyerrorlabel").show();$("#errormessage").append(g.errors)}})}});var ProjectView=Backbone.View.extend({tagName:"div",searchProjectPanelElem:"#searchProjectPanel",projectListElem:"#projectlist",projectList:null,addSlideDialog:null,ontologies:null,initialize:function(a){this.container=a.container;this.model=a.model;this.ontologies=a.ontologies;this.el=a.el;this.searchProjectPanel=null;this.addProjectDialog=null},render:function(){var a=this;require(["text!application/templates/project/ProjectList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).find("#projectdiv").html(_.template(b,{}));a.loadSearchProjectPanel();a.loadProjectsListing();return this},refresh:function(){var b=this;var a=undefined;if(b.addSlideDialog!=null){b.addSlideDialog.refresh()}new ProjectCollection({user:a}).fetch({success:function(d,c){b.model=d;b.render()}})},loadSearchProjectPanel:function(){var a=this;a.searchProjectPanel=new ProjectSearchPanel({model:a.model,ontologies:a.ontologies,el:$("#projectViewNorth"),container:a,projectsPanel:a}).render()},loadProjectsListing:function(){var a=this;$(a.projectListElem).empty();a.projectList=new Array();a.model.each(function(c){var b=new ProjectPanelView({model:c,projectsPanel:a,container:a}).render();a.projectList.push(b);$(a.projectListElem).append(b.el)})},showProjects:function(b){var a=this;a.model.each(function(c){if(b.get(c.id)!=null){$(a.projectListElem+c.id).show()}else{$(a.projectListElem+c.id).hide()}})}});var ProjectPanelView=Backbone.View.extend({tagName:"div",loadImages:true,imageOpened:false,project:null,projectElem:"#projectlist",imageOpenElem:"#projectopenimages",imageAddElem:"#projectaddimages",projectChangeElem:"#radioprojectchange",projectChangeDialog:"div#projectchangedialog",loadImagesInAddPanel:true,projectsPanel:null,container:null,initialize:function(a){this.container=a.container;this.projectsPanel=a.projectsPanel;_.bindAll(this,"render")},events:{"click .addSlide":"showAddSlidesPanel","click .seeSlide":"showSlidesPanel","click .editProject":"editProject","click .deleteProject":"deleteProject"},render:function(){var a=this;require(["text!application/templates/project/ProjectDetail.tpl.html"],function(b){a.doLayout(b,false)});return this},refresh:function(){var a=this;a.model.fetch({success:function(c,b){a.loadImages=true;require(["text!application/templates/project/ProjectDetail.tpl.html"],function(d){a.doLayout(d,true)});a.projectsPanel.loadSearchProjectPanel()}})},clear:function(){var a=this;a.projectsPanel.refresh()},doLayout:function(c,f){var b=this;var e=b.model.toJSON();var a=e.ontology;var g=[];_.each(b.model.get("users"),function(h){g.push(window.app.models.users.get(h).prettyName())});if(_.size(g)==0){e.shortUsers=g[0]}else{if(_.size(g)>=1){e.shortUsers=g[0]+", ..."}}e.users=g.join(", ");e.ontologyId=a;var d=_.template(c,e);if(f){$("#projectlist"+e.id).replaceWith(d)}else{$(b.el).append(d)}$(b.el).find(".usersPopover").popover();$(b.el).find(".usersPopover").click(function(){return false});b.renderCurrentProjectButton();b.renderShowImageButton(e.numberOfImages)},editProject:function(){var a=this;$("#editproject").remove();a.editProjectDialog=new EditProjectDialog({projectPanel:a,el:a.el,model:a.model}).render()},deleteProject:function(){var a=this;if(a.model.get("numberOfImages")>0||a.model.get("numberOfAnnotations")>0||a.model.get("numberOfSlides")>0){a.refuseDeleteProject(a.model.get("numberOfImages"))}else{a.acceptDeleteProject()}},refuseDeleteProject:function(b){var a=this;require(["text!application/templates/project/ProjectDeleteRefuseDialog.tpl.html"],function(c){$("dialogsDeleteProject").replaceWith("");var d=new ConfirmDialogView({el:"#dialogsDeleteProject",template:_.template(c,{project:a.model.get("name"),numberOfImage:b}),dialogAttr:{dialogID:"#delete-project-refuse"}}).render();$("#closeProjectDeleteRefuseDialog").click(function(){$("#delete-project-refuse").modal("hide");$("#delete-project-refuse").remove()})})},acceptDeleteProject:function(){var a=this;require(["text!application/templates/project/ProjectDeleteConfirmDialog.tpl.html"],function(b){var c=new ConfirmDialogView({el:"#dialogsDeleteProject",template:_.template(b,{project:a.model.get("name")}),dialogAttr:{dialogID:"#delete-project-confirm"}}).render();$("#closeProjectDeleteConfirmDialog").click(function(){new ProjectModel({id:a.model.id}).destroy({success:function(e,d){window.app.view.message("Project",d.message,"success");a.clear();$("#delete-project-confirm").modal("hide");$("#delete-project-confirm").remove()},error:function(e,d){var f=$.parseJSON(d.responseText);window.app.view.message("Project",f.errors,"error")}})})})},showAddSlidesPanel:function(){window.location="#project-manage-"+this.model.id},showSlidesPanel:function(){var a=this;a.openImagesList(a.model.get("id"));a.imageOpened=!a.imageOpened;$(a.imageOpenElem+a.model.id).button({icons:{secondary:a.imageOpened?"ui-icon-carat-1-n":"ui-icon-carat-1-s"}})},changeProject:function(){var b=this;var c=b.model.get("id");var a=false;if(c==window.app.status.currentProject){return true}window.app.controllers.browse.closeAll();window.app.status.currentProject=c;return true},renderShowImageButton:function(c){var a=this;var b=true;if(c>0){b=false}$(a.imageOpenElem+a.model.id).button({icons:{secondary:"ui-icon-carat-1-s"},disabled:b})},renderCurrentProjectButton:function(){var a=this;var b=window.app.status.currentProject==a.model.id;if(b){$(a.projectChangeElem+a.model.id).click()}},openImagesList:function(a){}});var ProjectManageSlideDialog=Backbone.View.extend({imageListing:null,imageThumb:null,projectPanel:null,addSlideDialog:null,imagesProject:null,divDialog:"div#projectaddimagedialog",render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageDialog.tpl.html"],function(b){a.doLayout(b)});return this},initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;this.imagesProject=new ImageInstanceCollection({project:this.model.get("id")})},refresh:function(){if(this.imageListing!=undefined){this.imageListing.refresh()}},doLayout:function(b){var a=this;$("#addimagediv").empty();var c=_.template(b,{id:a.model.get("id"),name:a.model.get("name")});$(a.el).append(c);$("button[class=goBackToProject]").click(function(){window.location="#project"});a.imageListing=new ProjectAddImageListingDialog({model:a.model,projectsPanel:a,imagesProject:a.imagesProject,el:"#tabsProjectaddimagedialog"+a.model.id+"-2"}).render();$("a[class=goBackToProject]").button({icons:{primary:"ui-icon-circle-triangle-w"}});a.imageListing.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-2").show();$("#tabsProjectaddimagedialog"+a.model.id+"-1").hide();$("#addimagediv").append($(a.divDialog+a.model.get("id")));$(".ui-panel-header").css("display","block");a.open();return this},open:function(){}});var AddProjectDialog=Backbone.View.extend({projectsPanel:null,addProjectDialog:null,initialize:function(a){this.container=a.container;this.projectsPanel=a.projectsPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectAddDialog.tpl.html","text!application/templates/project/OntologiesChoicesRadio.tpl.html","text!application/templates/project/UsersChoices.tpl.html"],function(b,d,c){a.doLayout(b,d,c)});return this},doLayout:function(a,e,d){var b=this;var c=_.template(a,{});$("#editproject").replaceWith("");$("#addproject").replaceWith("");$(b.el).append(c);$("#login-form-add-project").submit(function(){b.createProject();return false});$("#login-form-add-project").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-add-project").submit();return false}});$("#projectontology").empty();window.app.models.ontologies.each(function(g){var f=_.template(e,{id:g.id,name:g.get("name")});$("#projectontology").append(f)});$("#projectuser").empty();window.app.models.users.each(function(g){var f=_.template(d,{id:g.id,username:g.get("username")});$("#projectuser").append(f)});$("#projectuser").find("#users"+window.app.status.user.id).attr("checked","checked");$("#projectuser").find("#users"+window.app.status.user.id).click(function(){$("#projectuser").find("#users"+window.app.status.user.id).attr("checked","checked")});$("#projectuser").find('[for="users'+window.app.status.user.id+'"]').css("font-weight","bold");b.addProjectDialog=$("#addproject").modal({keyboard:true});$("#saveProjectButton").click(function(){$("#login-form-add-project").submit();return false});$("#closeAddProjectDialog").click(function(){$("#addproject").modal("hide");$("#addproject").remove();return false});b.open();return this},refresh:function(){},open:function(){var a=this;a.clearAddProjectPanel();$("#addproject").modal("show")},clearAddProjectPanel:function(){var a=this;$("#errormessage").empty();$("#projecterrorlabel").hide();$("#project-name").val("");$(a.addProjectCheckedOntologiesRadioElem).attr("checked",false);$(a.addProjectCheckedUsersCheckboxElem).attr("checked",false)},createProject:function(){var a=this;$("#errormessage").empty();$("#projecterrorlabel").hide();var b=$("#project-name").val().toUpperCase();var c=$("#projectontology").attr("value");var d=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(e,f){d.push($(f).attr("value"))});new ProjectModel({name:b,ontology:c}).save({name:b,ontology:c},{success:function(g,f){window.app.view.message("Project",f.message,"success");var i=f.project.id;var h=d.length;var e=0;if(h==0){a.addDeleteUserProjectCallback(0,0)}_.each(d,function(j){new ProjectUserModel({project:i,user:j}).save({},{success:function(l,k){a.addUserProjectCallback(h,++e)},error:function(l,k){var m=$.parseJSON(k.responseText);window.app.view.message("User",m.errors,"success")}})})},error:function(f,e){var g=$.parseJSON(e.responseText);$("#projecterrorlabel").show()}})},addUserProjectCallback:function(c,a){if(a<c){return}var b=this;b.projectsPanel.refresh();$("#addproject").modal("hide");$("#addproject").remove()}});var EditProjectDialog=Backbone.View.extend({projectsPanel:null,editProjectDialog:null,initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectEditDialog.tpl.html","text!application/templates/project/UsersChoices.tpl.html"],function(b,c){a.doLayout(b,c)});return this},doLayout:function(c,d){var a=this;$("#editproject").replaceWith("");$("#addproject").replaceWith("");var b=_.template(c,{});$(a.el).append(b);$("#login-form-edit-project").submit(function(){a.editProject();return false});$("#login-form-edit-project").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-edit-project").submit();return false}});$("#editProjectButton").click(function(){$("#login-form-edit-project").submit();return false});$("#closeEditProjectDialog").click(function(){$("#editproject").modal("hide");$("#editproject").remove();return false});$("#projectedituser").empty();window.app.models.users.each(function(f){var e=_.template(d,{id:f.id,username:f.get("username")});$("#projectedituser").append(e)});$("#projectedituser").find("#users"+window.app.status.user.id).attr("checked","checked");$("#projectedituser").find("#users"+window.app.status.user.id).click(function(){$("#projectedituser").find("#users"+window.app.status.user.id).attr("checked","checked")});$("#projectedituser").find('[for="users'+window.app.status.user.id+'"]').css("font-weight","bold");a.editProjectDialog=$("#editproject").modal({keyboard:true});a.open();a.fillForm();return this},fillForm:function(){var a=this;$("#project-edit-name").val(a.model.get("name"));var b=a.model.get("users");_.each(b,function(c){$("#users"+c).attr("checked",true);if(window.app.status.user.id==c.id){}})},refresh:function(){},open:function(){var a=this;a.clearEditProjectPanel();$("#editproject").modal("show")},clearEditProjectPanel:function(){var a=this;$("#projectediterrormessage").empty();$("#projectediterrorlabel").hide();$("#project-edit-name").val("");$(a.editProjectCheckedUsersCheckboxElem).attr("checked",false)},diffArray:function(d,c){var e=[],g=[];for(var f=0;f<c.length;f++){e[c[f]]=true}for(var f=0;f<d.length;f++){if(!e[d[f]]){g.push(d[f])}}return g},editProject:function(){var a=this;$("#projectediterrormessage").empty();$("#projectediterrorlabel").hide();var b=$("#project-edit-name").val().toUpperCase();var d=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(e,f){d.push($(f).attr("value"))});var c=a.model;c.set({name:b});c.save({name:b},{success:function(k,j){window.app.view.message("Project",j.message,"success");var g=j.project.id;var l=new Array();var n=null;var h=null;var f=null;var i=a.model.get("users");_.each(i,function(o){l.push(o)});l.sort();n=d;n.sort();h=a.diffArray(n,l);f=a.diffArray(l,n);var m=h.length+f.length;var e=0;if(m==0){a.addDeleteUserProjectCallback(0,0)}_.each(h,function(o){new ProjectUserModel({project:g,user:o}).save({},{success:function(q,p){a.addDeleteUserProjectCallback(m,++e)},error:function(q,p){var r=$.parseJSON(p.responseText);window.app.view.message("User",r.errors,"error")}})});_.each(f,function(o){new ProjectUserModel({project:g,user:o}).destroy({success:function(q,p){a.addDeleteUserProjectCallback(m,++e)},error:function(q,p){var r=$.parseJSON(p.responseText);window.app.view.message("User",r.errors,"error")}})})},error:function(f,e){var g=$.parseJSON(e.responseText);$("#projectediterrorlabel").show()}})},addDeleteUserProjectCallback:function(c,a){if(a<c){return}var b=this;b.projectPanel.refresh();$("#editproject").modal("hide");$("#editproject").remove()}});var ProjectSearchPanel=Backbone.View.extend({ontologies:null,idUser:null,container:null,projectsPanel:null,allProjectsButtonElem:"#projectallbutton",addProjectButtonElem:"#projectaddbutton",searchProjectOntolgiesListElem:"#ontologyChoiceList",sliderNumberOfImagesElem:"#numberofimageSlider",labelNumberOfImagesElem:"#amountNumberOfImages",sliderNumberOfSlidesElem:"#numberofslideSlider",labelNumberOfSlidesElem:"#amountNumberOfSlides",sliderNumberOfAnnotationsElem:"#numberofannotationSlider",labelNumberOfAnnotationsElem:"#amountNumberOfAnnotations",searchProjectTextBoxElem:"#projectsearchtextbox",searchProjectButtonElem:"#projectsearchbutton",searchProjectCheckedOntologiesElem:"input[type=checkbox][name=ontology]:checked",addProjectCheckedOntologiesRadioElem:"input[type=radio][name=ontologyradio]:checked",addProjectCheckedUsersCheckboxElem:"input[type=checkbox][name=usercheckbox]:checked",initialize:function(a){this.ontologies=a.ontologies;this.idUser=a.idUser;this.container=a.container;this.projectsPanel=a.projectsPanel},events:{"click .addProject":"showAddProjectPanel","change .searchProjectCriteria":"searchProject","click .showAllProject":"showAllProject"},render:function(){var a=this;require(["text!application/templates/project/ProjectSearchPanel.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=_.template(b,{});$(this.el).empty();$(this.el).append(c);require(["text!application/templates/project/OntologiesChoices.tpl.html"],function(d){a.loadPanelAndButton(d)});a.loadSlider();a.loadAutocomplete()},loadPanelAndButton:function(b){var a=this;a.ontologies.each(function(d){var c=_.template(b,{id:d.id,name:d.get("name")});$(a.searchProjectOntolgiesListElem).append(c)})},loadSlider:function(){var a=this;var b=Number.MAX_VALUE;var d=0;var e=Number.MAX_VALUE;var g=0;var c=Number.MAX_VALUE;var f=0;a.model.each(function(i){var h=parseInt(i.get("numberOfImages"));var k=parseInt(i.get("numberOfSlides"));var j=parseInt(i.get("numberOfAnnotations"));if(h<b){b=h}if(h>d){d=h}if(k<e){e=k}if(k>g){g=k}if(j<c){c=j}if(j>f){f=j}});a.createSliderWithoutAmountPrint(a.sliderNumberOfImagesElem,a.labelNumberOfImagesElem,b,d);a.createSliderWithoutAmountPrint(a.sliderNumberOfSlidesElem,a.labelNumberOfSlidesElem,e,g);a.createSliderWithoutAmountPrint(a.sliderNumberOfAnnotationsElem,a.labelNumberOfAnnotationsElem,c,f)},loadAutocomplete:function(){var a=this;var b=new Array();a.model.each(function(c){b.push(c.get("name"))});$(a.searchProjectTextBoxElem).autocomplete({minLength:0,source:b,select:function(c,d){$(a.searchProjectTextBoxElem).val(d.item.label);a.searchProject()},search:function(c){a.searchProject()}})},createSliderWithoutAmountPrint:function(e,c,d,a){var b=this;$(e).slider({range:true,min:d,max:a,values:[d,a],change:function(f,g){$(c).val(""+g.values[0]+" - "+g.values[1]);b.searchProject()}});$(c).val(""+$(e).slider("values",0)+" - "+$(e).slider("values",1))},refreshSearchPanel:function(b){var a=this;a.loadSlider();a.loadAutocomplete()},showAllProject:function(){var a=this;$(a.searchProjectTextBoxElem).val("");$("#ontologyChoiceList").val(-1);a.resetSlider(a.sliderNumberOfImagesElem);a.resetSlider(a.sliderNumberOfSlidesElem);a.resetSlider(a.sliderNumberOfAnnotationsElem);a.searchProject()},resetSlider:function(c){var b=$(c).slider("option","min");var a=$(c).slider("option","max");$(c).slider("values",[b,a])},searchProject:function(){var b=this;var f=$(b.searchProjectTextBoxElem).val();var e=new Array();var d=$("#ontologyChoiceList").val();if(d!=-1){e.push(d)}var a=new Array();a.push($(b.sliderNumberOfImagesElem).slider("values",0));a.push($(b.sliderNumberOfImagesElem).slider("values",1));var c=new Array();c.push($(b.sliderNumberOfSlidesElem).slider("values",0));c.push($(b.sliderNumberOfSlidesElem).slider("values",1));var g=new Array();g.push($(b.sliderNumberOfAnnotationsElem).slider("values",0));g.push($(b.sliderNumberOfAnnotationsElem).slider("values",1));b.filterProjects(f==""?undefined:f,e.length==0?undefined:e,a,c,g)},showAddProjectPanel:function(){var a=this;$("#addproject").remove();a.addProjectDialog=new AddProjectDialog({projectsPanel:a.projectsPanel,el:a.el}).render()},filterProjects:function(f,e,d,b,g){var a=this;var c=new ProjectCollection(a.model.models);c=a.filterByProjectsByName(f,c);c=a.filterProjectsByOntology(e,c);c=a.filterProjectsByNumberOfImages(d,c);c=a.filterProjectsByNumberOfSlides(b,c);c=a.filterProjectsByNumberOfAnnotations(g,c);a.container.showProjects(c)},filterByProjectsByName:function(c,b){if(c==undefined){return b}var a=new ProjectCollection(b.models);b.each(function(g){var d=g.get("name").toLowerCase();var f=c.toLowerCase();var e=(d.indexOf(f)!=-1);if(!e){a.remove(g)}});return a},filterProjectsByOntology:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("ontology")+"";if(d!=undefined&&_.indexOf(d,e)==-1){b.remove(f)}});return b},filterProjectsByNumberOfImages:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("numberOfImages");if(d[0]>e||d[1]<e){b.remove(f)}});return b},filterProjectsByNumberOfSlides:function(c,d){var a=this;var b=new ProjectCollection(d.models);d.each(function(f){var e=f.get("numberOfSlides");if(c[0]>e||c[1]<e){b.remove(f)}});return b},filterProjectsByNumberOfAnnotations:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("numberOfAnnotations");if(d[0]>e||d[1]<e){b.remove(f)}});return b}});var ProjectAddImageListingDialog=Backbone.View.extend({imagesProject:null,searchPanel:null,initialize:function(b){var a=this;this.container=b.container;this.projectPanel=b.projectPanel;this.imagesProject=b.imagesProject;this.abstractImageProject=new Array();this.el="#tabsProjectaddimagedialog"+a.model.id+"-2";this.listmanageproject="listmanageproject"+this.model.id;this.pagemanageproject="pagemanageproject"+this.model.id;this.listmanageall="listmanageall"+this.model.id;this.pagemanageall="pagemanageall"+this.model.id;this.addImageButton="addimageprojectbutton"+this.model.id;this.delImageButton="delimageprojectbutton"+this.model.id;this.tab=2;this.timeoutHnd=null},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageListingDialog.tpl.html"],function(b){a.doLayout(b)});return this},refresh:function(){this.refreshImageList()},doLayout:function(c){var b=this;var e=b.model.toJSON();e.tab=2;var d=_.template(c,e);$(b.el).append(d);this.renderImageList();var f=$(window).width()-80;var a=f*0.05;$("#imageTableSeparator").css({width:a+"px"});return this},renderImageList:function(){var a=this;a.renderImageListing()},renderImageListing:function(){var a=this;$("#"+a.addImageButton).button({icons:{primary:"ui-icon-circle-arrow-w"},text:false});$("#"+a.delImageButton).button({icons:{primary:"ui-icon-circle-arrow-e"},text:false});$("#infoProjectPanel"+a.model.id).panel({collapseSpeed:100});$("#"+a.addImageButton).click(function(){a.addImageProjectFromTable()});$("#"+a.delImageButton).click(function(){a.deleteImageProjectFromTable()});$("#searchImagetPanelup"+a.model.id+"-"+a.tab).panel({collapseSpeed:100});$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val("");$("#imagesallbutton"+a.model.id+"-"+a.tab).button({text:true});$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).keyup(function(){a.doSearch()}).keyup();$("#imagesallbutton"+a.model.id+"-"+a.tab).click(function(){$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val("");$("#datestartsearchup"+a.model.id+"-"+a.tab).val("");$("#dateendsearchup"+a.model.id+"-"+a.tab).val("");a.doSearch()});$("#datestartsearchup"+a.model.id+"-"+a.tab).datepicker({onSelect:function(c,b){a.doSearch()}});$("#dateendsearchup"+a.model.id+"-"+a.tab).datepicker({onSelect:function(c,b){a.doSearch()}});a.renderImageListProject();a.renderImageListAll()},doSearch:function(){var a=this;if($.data(this,"timer")!=null){clearTimeout($.data(this,"timer"))}var b=setTimeout(function(){a.searchImages()},500);$(this).data("timer",b)},searchImages:function(){var a=this;var f=$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val();var e=$("#datestartsearchup"+a.model.id+"-"+a.tab).datepicker("getDate");var c=$("#dateendsearchup"+a.model.id+"-"+a.tab).datepicker("getDate");var b="";if(e!=null){b=e.getTime()}var d="";if(c!=null){d=c.getTime()}$("#"+a.listmanageall).jqGrid("setGridParam",{url:"api/currentuser/image.json?filename="+f+"&createdstart="+b+"&createdstop="+d,page:1}).trigger("reloadGrid")},refreshImageList:function(){var a=this;$("#"+a.listmanageproject).jqGrid("clearGridData",true);a.imagesProject.fetch({success:function(c,b){a.fillAbstractImageProjectCollection(c);a.loadDataImageListProject(c);$("#"+a.listmanageall).trigger("reloadGrid")}})},fillAbstractImageProjectCollection:function(a){var b=this;b.abstractImageProject=[];b.imagesProject.each(function(c){b.abstractImageProject.push(c.get("baseImage"))})},loadDataImageListProject:function(e){var a=this;var d=new Array();var c=0;e.each(function(g){var f=new Date();f.setTime(g.get("created"));d[c]={id:g.id,base:g.get("baseImage"),thumb:"<img src='"+g.get("thumb")+"' width=50/>",filename:g.get("filename"),type:g.get("mime"),annotations:g.get("numberOfAnnotations"),added:f.getFullYear()+"-"+f.getMonth()+"-"+f.getDate(),See:""};c++});for(var b=0;b<d.length;b++){$("#"+a.listmanageproject).jqGrid("addRowData",d[b].id,d[b])}$("#"+a.listmanageproject).jqGrid("sortGrid","filename",false)},renderImageListProject:function(){var b=this;var c=$(window).width()-80;var a=c*0.45;$("#imagesProjectContainer").css({width:a+"px"});$("#"+b.listmanageproject).jqGrid({datatype:"local",width:a,height:500,colNames:["id","base","thumb","filename","type","annotations","added"],colModel:[{name:"id",index:"id",width:1,sorttype:"int"},{name:"base",index:"base",width:1,sorttype:"int"},{name:"thumb",index:"thumb",width:100},{name:"filename",index:"filename",width:250},{name:"type",index:"type",width:50},{name:"annotations",index:"annotations",width:50},{name:"added",index:"added",width:100,sorttype:"date"}],onSelectRow:function(e){var d=$("#"+b.listmanageproject).find("#"+e).find(".cbox").attr("checked");if(d){$("#"+b.listmanageproject).find("#"+e).find("td").css("background-color","CD661D")}else{$("#"+b.listmanageproject).find("#"+e).find("td").css("background-color","a0dc4f")}},loadComplete:function(){b.imagesProject.each(function(d){$("#"+b.listmanageproject).find("#"+d.id).find("td").css("background-color","a0dc4f")})},pager:"#"+b.pagemanageproject,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Images in "+b.model.get("name"),multiselect:true});$("#"+b.listmanageproject).jqGrid("navGrid","#"+b.listmanageproject,{edit:false,add:false,del:false});$("#"+b.listmanageproject).jqGrid("hideCol","id");$("#"+b.listmanageproject).jqGrid("hideCol","base")},isAbstractImageInProject:function(a){if(_.indexOf(this.abstractImageProject,a)!=-1){return true}else{return false}},renderImageListAll:function(){var b=this;var c=$(window).width()-80;var a=c*0.45;$("#allImagesContainer").css({width:a+"px"});var d="thumb";$("#"+b.listmanageall).jqGrid({datatype:"json",url:"api/currentuser/image.json",width:a,height:500,colNames:["id",d,"filename","mime","created"],colModel:[{name:"id",index:"id",width:1},{name:d,index:d,width:100},{name:"filename",index:"filename",width:250},{name:"mime",index:"mime",width:45},{name:"created",index:"created",width:100,sorttype:"date",formatter:b.dateFormatter}],onSelectRow:function(e){if(b.isAbstractImageInProject(e)){$("#"+b.listmanageall).find("#"+e).find(".cbox").removeAttr("checked")}},loadComplete:function(e){$("#"+b.listmanageall).find("tr").each(function(f){if(f!=0){var g=$(this).find('[aria-describedby$="_'+d+'"]');$(g).html('<img src="'+$(g).text()+'" width=50/>')}});b.imagesProject.each(function(f){$("#"+b.listmanageall).find("#"+f.get("baseImage")).find("td").css("background-color","a0dc4f");$("#"+b.listmanageall).find("#"+f.get("baseImage")).find(".cbox").attr("disabled",true);$("#"+b.listmanageall).find("#"+f.get("baseImage")).find(".cbox").css("visible",false)})},pager:"#"+b.pagemanageall,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Available images",multiselect:true,rowNum:10,rowList:[10,20,30],jsonReader:{repeatitems:false,id:"0"}});$("#"+b.listmanageall).jqGrid("navGrid","#"+b.pagemanageall,{edit:false,add:false,del:false},{},{},{},{multipleSearch:true});$("#"+b.listmanageall).jqGrid("sortGrid","filename",false);$("#"+b.listmanageall).jqGrid("hideCol","id")},dateFormatter:function(b,c,d){var a=new Date();a.setTime(b);return a.getFullYear()+"-"+a.getMonth()+"-"+a.getDate()},addImageProjectFromTable:function(){var b=this;var c=$("#"+b.listmanageall).jqGrid("getGridParam","selarrrow");if(c.length==0){return}var a=0;_.each(c,function(d){new ImageInstanceModel({}).save({project:b.model.id,user:null,baseImage:d},{success:function(f,e){window.app.view.message("Image",e.message,"success");b.addImageProjectCallback(c.length,++a)},error:function(f,e){var g=$.parseJSON(e.responseText);window.app.view.message("Image",g.errors,"error");b.addImageProjectCallback(c.length,++a)}})})},addImageProjectCallback:function(c,a){if(a<c){return}var b=this;b.refreshImageList()},deleteImageProjectFromTable:function(){var a=this;var b=$("#"+a.listmanageproject).jqGrid("getGridParam","selarrrow");if(b.length==0){return}a.deleteImageWithcheckForAnnotation(b)},deleteImageProject:function(c){var b=this;var a=0;_.each(c,function(d){var e=b.imagesProject.get(d).get("baseImage");new ImageInstanceModel({project:b.model.id,user:null,baseImage:e}).destroy({success:function(g,f){window.app.view.message("Image",f.message,"success");b.deleteImageProjectCallback(c.length,++a)},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Image",h.errors,"error");b.deleteImageProjectCallback(c.length,++a)}})})},deleteImageProjectCallback:function(c,a){if(a<c){return}var b=this;b.refreshImageList()},deleteImageWithcheckForAnnotation:function(c){var a=this;var b=false;_.each(c,function(d){var e=a.imagesProject.get(d).get("numberOfAnnotations");if(e>0){b=true}});if(b){require(["text!application/templates/project/ProjectAddImageDeleteImageInstanceWithAnnotation.tpl.html"],function(d){var e=new ConfirmDialogView({el:"#dialogDeleteImageWithAnnotation",template:_.template(d,{projectname:a.model.get("name")}),dialogAttr:{dialogID:"#dialogDeleteImageWithAnnotation",width:400,height:300,buttons:{"Delete all images and annotations":function(){a.deleteImageProject(c);$("#dialogDeleteImageWithAnnotation").dialog("close")},Cancel:function(){$("#dialogDeleteImageWithAnnotation").dialog("close")}},close:function(f){}}}).render()})}else{a.deleteImageProject(c)}}});var ProjectAddImageThumbDialog=Backbone.View.extend({imageListing:null,imageThumb:null,slides:null,imagesProject:null,imagesinstanceProject:null,checklistChecked:".checklist input:checked",checklistSelected:".checklist .checkbox-select",checklistDeselected:".checklist .checkbox-deselect",selectedClass:"selected",checkedAttr:"checked",liElem:"projectaddimageitemli",ulElem:"#projectaddimagedialoglist",allProjectUlElem:"ul[id^=projectaddimagedialoglist]",imageDivElem:"#projectaddimageitempict",page:0,nb_slide_by_page:20,nextPage:function(){var a=Math.round(_.size(window.app.models.slides)/this.nb_slide_by_page)-1;this.page=Math.min(this.page+1,a);this.renderImageListLayout()},previousPage:function(){this.page=Math.max(this.page-1,0);this.renderImageListLayout()},disablePrevious:function(){},enablePrevious:function(){},disableNext:function(){},enableNext:function(){},initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;this.imagesProject=a.imagesProject;this.imagesinstanceProject=a.imagesinstanceProject;this.el="#tabsProjectaddimagedialog"+this.model.id+"-1";this.slides=a.slides;_.bindAll(this,"render");_.bindAll(this,"nextPage");_.bindAll(this,"previousPage")},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageThumbDialog.tpl.html"],function(b){a.doLayout(b)});return this},refresh:function(){this.renderImageList()},doLayout:function(c){var b=this;var a=_.template(c,{id:this.model.get("id"),name:this.model.get("name")});$(b.el).append(a);$(b.el).find("a.next").bind("click",b.nextPage);$(b.el).find("a.next").button();$(b.el).find("a.previous").bind("click",b.previousPage);$(b.el).find("a.previous").button();return this},renderImageList:function(){var a=this;window.app.models.slides.fetch({success:function(c,b){a.renderImageListLayout()}})},renderImage:function(c,d,b){var a=this;require(["text!application/templates/project/ProjectAddImageChoice.tpl.html"],function(g){var f=new ImageSelectView({model:d}).render();var e=d.get("filename");if(e.length>15){e=e.substring(0,12)+"..."}var h=_.template(g,{id:d.id,name:e,namefull:d.get("filename"),slide:d.get("slide"),info:d.get("info")});$(b).append(h);$(b+" "+a.imageDivElem+d.id).append(f.el);$(f.el).css({width:30});$(b).find("label  > b").css("font-size",10);if(c.get(d.id)){$(b+" #"+a.liElem+d.id).addClass(a.selectedClass);$(b+" #"+a.liElem+d.id).find(":checkbox").attr(a.checkedAttr,a.checkedAttr)}})},selectAllImages:function(a){$(".projectImageList"+a).find("li.imageThumbChoice").each(function(){$(this).find("a.checkbox-select").click()})},unselectAllImages:function(a){$(".projectImageList"+a).find("li.imageThumbChoice").each(function(){$(this).find("a.checkbox-deselect").click()})},renderSlide:function(a){var b=this;require(["text!application/templates/project/ProjectSlideDetail.tpl.html"],function(d){var f=_.template(d,{id:a.get("id"),name:a.get("name")});var e=$(b.ulElem+b.model.get("id"));e.append("<td>"+f+"</td>");e.find(".slideItem"+a.get("id")).panel({collapsible:false});e.find("a[class=selectAll]").bind("click",function(){b.selectAllImages(a.get("id"))});e.find("a[class=unselectAll]").bind("click",function(){b.unselectAllImages(a.get("id"))});e.find("a[class=selectAll]").button({text:false,icons:{secondary:"ui-icon-circle-plus"}});e.find("a[class=unselectAll]").button({text:false,icons:{secondary:"ui-icon-circle-minus"}});var c=a.get("images");var g=".projectImageList"+a.get("id");_.each(c,function(i){var h=new ImageModel(i);b.renderImage(b.imagesProject,h,g)});$("#projectImageList"+a.get("id")).carousel();$(g).append('<div style="clear:both;"></div>')})},renderImageListLayout:function(){var b=this;var f=0;var e=Math.abs(b.page)*b.nb_slide_by_page;var a=(Math.abs(b.page)+1)*b.nb_slide_by_page;$(b.ulElem+b.model.get("id")).empty();var d=4;var c=0;$(b.ulElem+b.model.get("id")).append("<table><tr width='25%'>");window.app.models.slides.each(function(g){if((f>=e)&&(f<a)){b.renderSlide(g);c++;if(c==d){c=0;$(b.ulElem+b.model.get("id")).append("</tr><tr width='25%'>")}}$(b.ulElem+b.model.get("id")).append("</tr></table>");$(".carousel-wrap").css("height","200");f++;if(f==a){b.initEvents()}})},addImageToProject:function(a,b){new ImageInstanceModel({}).save({project:b,user:null,baseImage:a},{success:function(d,c){window.app.view.message("ImageInstance",c.message,"success")},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Image",e.errors[0],"error")}})},deleteImageToProject:function(a,b){new ImageInstanceModel({project:b,user:null,baseImage:a}).destroy({success:function(d,c){window.app.view.message("ImageInstance",c.message,"success")},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Image",e.errors[0],"error")}})},initEvents:function(){var a=this;$(a.checklistChecked).parent().addClass(a.selectedClass);$(a.checklistSelected).click(function(e){e.preventDefault();var d=$(this).parent().attr("class");$(this).parent().addClass(a.selectedClass);$(this).parent().find(":checkbox").attr(a.checkedAttr,a.checkedAttr);var b=$(this).parent().attr("id");var c=b.substring(a.liElem.length,b.length);a.addImageToProject(c,a.model.id)});$(a.checklistDeselected).click(function(d){d.preventDefault();$(this).parent().removeClass(a.selectedClass);$(this).parent().find(":checkbox").removeAttr(a.checkedAttr);var b=$(this).parent().attr("id");var c=b.substring(a.liElem.length,b.length);a.deleteImageToProject(c,a.model.id)})}});var ProjectAddImageSearchPanel=Backbone.View.extend({images:null,tab:null,initialize:function(b){var a=this;this.container=b.container;this.images=b.images;this.tab=b.tab},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageSearchDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(d){var b=this;var f=b.model.toJSON();var a=f.ontology;f.ontologyId=a;f.tab=b.tab;var e=_.template(d,f);$(b.el).append(e);b.renderImageListing();var c=new Array();$("#filenamesearchtextboxup"+b.model.id+"-"+b.tab).autocomplete({minLength:0,source:c,select:function(g,h){$("#filenamesearchtextboxup"+b.model.id+"-"+b.tab).val(h.item.label);b.container.searchImages()},search:function(g){b.container.searchImages()}});$("#datestartsearchup"+b.model.id+"-"+b.tab).change(function(){b.container.searchImages()});$("#dateendsearchup"+b.model.id+"-"+b.tab).change(function(){b.container.searchImages()});return this},search:function(a){var b=this;return b.filterImages(searchText==""?undefined:searchText,dateStart,dateEnd)},filterImages:function(e,d,c){var b=this;var a=new ImageCollection(b.images.models);a=b.filterByImagesByName(e,a);a=b.filterByDateStart(d,a);a=b.filterByDateEnd(c,a);return a},filterByImagesByName:function(c,b){var a=new ImageCollection(b.models);b.each(function(d){if(c!=undefined&&!d.get("filename").toLowerCase().contains(c.toLowerCase())){a.remove(d)}});return a},filterByDateStart:function(c,b){var a=new ImageCollection(b.models);b.each(function(e){var d=new Date();d.setTime(e.get("created"));if(c!=undefined&&d<c){a.remove(e)}});return a},filterByDateEnd:function(c,b){var a=new ImageCollection(b.models);b.each(function(e){var d=new Date();d.setTime(e.get("created"));if(c!=undefined&&d>c){a.remove(e)}});return a},renderImageListing:function(){var a=this}});var CrudGridView=Backbone.View.extend({customFields:{color:{colorPickerElement:function(c,a){var b=_.template('<input type="text" name="color" value="<%=   value %>">',{value:c});setTimeout(function(){$("#color").ColorPicker({color:c,onShow:function(d){$(d).fadeIn(500);return false},onSubmit:function(d,g,e,f){$(f).val("#"+g);$(f).ColorPickerHide()},onBeforeShow:function(){$(this).ColorPickerSetColor(this.value)},onHide:function(d){$(d).fadeOut(500);return false}})},200);return b},colorPickerValue:function(b,a,c){if(a==="get"){return $(b).val()}else{if(a==="set"){$("input",b).val(c)}}}}},initialize:function(a){this.title=a.title;this.pager="pager"+this.title;this.colNames=a.colNames;this.colModel=a.colModel;this.url=a.url;this.restURL=a.restURL;if(this.restURL!=undefined&&this.restURL.charAt(this.restURL.length-1)!="/"){this.restURL+="/"}},render:function(){var a=this;require(["text!application/templates/utils/CrudGridView.tpl.html"],function(b){a.doLayout(b)})},doLayout:function(a){var b=_.template(a,{pager:this.pager,title:this.title});$(this.el).html(b);this.initGrid();this.renderTable();this.initToolbar()},initGrid:function(){jQuery.extend(jQuery.jgrid.edit,{ajaxEditOptions:{contentType:"application/json"},recreateForm:true,serializeEditData:function(a){return JSON.stringify(a)},afterSubmit:function(a,c){var b=jQuery.parseJSON(a.responseText);return[true,"",b.d]}});jQuery.extend(jQuery.jgrid.del,{ajaxDelOptions:{contentType:"application/json"},recreateForm:true,serializeEditData:function(a){return JSON.stringify(a)},afterSubmit:function(a,c){var b=jQuery.parseJSON(a.responseText);return[true,"",b.d]}})},initToolbar:function(){var i=this;var c=600;var g=500;var b=$(window).width()/2-(c/2);var f=$(window).height()/2-(g/2);var a=$(i.el).find(".grid");var h=$(this.el).find(".crud-toolbar").find("a[name=add]");h.button({text:true,icons:{primary:"ui-icon-plus"}});h.click(function(){a.jqGrid("editGridRow","new",{top:f,left:b,width:c,height:g,mtype:"POST",reloadAfterSubmit:true,modal:true,closeOnEscape:true,closeAfterAdd:true,url:i.restURL,afterSubmit:function(j,k){var l=$.parseJSON(j.responseText);_.each(k.authorities.split(","),function(m){new UserSecRole({user:l.user.id,role:m}).save()});return[true,"",null]}})});var d=$(this.el).find(".crud-toolbar").find("a[name=edit]");d.button({text:true,icons:{primary:"ui-icon-pencil"}});d.click(function(){var j=a.jqGrid("getGridParam","selrow");var k=a.getRowData(j);if(j!=null){a.jqGrid("editGridRow",j,{top:f,left:b,width:c,height:g,mtype:"PUT",reloadAfterSubmit:true,modal:true,closeOnEscape:true,closeAfterEdit:true,url:i.restURL+k.id})}else{window.app.view.message("Error","Please select a row","error")}});var e=$(this.el).find(".crud-toolbar").find("a[name=delete]");e.button({text:true,icons:{primary:"ui-icon-trash"}});e.click(function(){var j=a.jqGrid("getGridParam","selrow");var k=a.getRowData(j);if(j!=null){a.jqGrid("delGridRow",j,{top:f,left:b,width:c,height:g,mtype:"DELETE",reloadAfterSubmit:false,beforeSubmit:function(l,m){new UserModel({id:l}).fetch({success:function(o,n){var p=o.get("authorities");_.each(p.split(","),function(q){alert(q)})}});alert(l);return[true,""]},modal:true,closeOnEscape:true,closeAfterEdit:true,url:i.restURL+k.id})}else{window.app.view.message("Error","Please select a row","error")}})},renderTable:function(){var a=this;var b=$(a.el).find(".grid");b.jqGrid({datatype:"json",url:this.url,width:900,height:500,colNames:this.colNames,colModel:this.colModel,onSelectRow:function(c){},loadComplete:function(c){b.setGridWidth(Math.max(500,$(a.el).width()-300),true);b.setGridHeight(Math.max(300,$(a.el).height()-500),true)},sortname:"id",viewrecords:true,sortorder:"asc",caption:this.title,modal:false,pager:"#"+this.pager,editurl:a.restURL,jsonReader:{repeatitems:false,id:"0"}});$(window).bind("resize",function(){b.setGridWidth(Math.max(500,$(a.el).width()-300),true);b.setGridHeight(Math.max(300,$(a.el).height()-200),true)}).trigger("resize")}});var AnnotationListView=Backbone.View.extend({tagName:"div",self:this,alreadyBuild:false,initialize:function(a){this.container=a.container;this.idAnnotation=a.idAnnotation},render:function(){var a=this;require(["text!application/templates/annotation/AnnotationList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{name:"name",area:"area"}));a.model.each(function(f){var g=f.get("name");var h=f.get("area")});var d;var c=0;var e=[];a.model.each(function(f){e[c]={id:f.id,filename:f.get("filename"),created:""};c++});return this},initAnnotation:function(){var a=this}});var AnnotationRetrievalView=Backbone.View.extend({tagName:"div",baseAnnotation:null,terms:null,initialize:function(a){this.container=a.container;this.page=a.page;this.annotations=null;this.baseAnnotation=a.baseAnnotation;this.terms=a.terms;window.app.status.currentTermsCollection=a.terms;if(this.page==undefined){this.page=0}},render:function(){var a=this;console.log("AnnotationRetrievalView: main elem "+$(a.el).length);$(a.el).append('<ul><li><a href="#retrievalThumb">Thumb view</a></li><li><a href="#retrievalPieChart">Stats view</a></li></ul>');$(a.el).append('<div id="retrievalThumb"><div>');$(a.el).append('<div id="retrievalPieChart"><div>');$("#annotationRetrieval").tabs();$(a.el).dialog({title:a.createTitle(),width:900,height:500,autoOpen:true,modal:true,buttons:{Close:function(){$(a.el).dialog("close")}}});a.createThumbView(a.page);a.createStatsView();return this},createTitle:function(){var a=this;var d=a.baseAnnotation.get("id");var c=new Array();var b=a.baseAnnotation.get("term");_.each(b,function(e){if(a.terms.get(e)!=undefined){c.push(a.terms.get(e).get("name"))}});return"Annotation "+d+" with term "+c.join(",")},createThumbView:function(a){this.appendThumbs(a)},createStatsView:function(){var a=this;var b=new Object();a.model.each(function(c){var d=c.get("term");_.each(d,function(f){console.log(f);console.log(a.terms);var e=a.terms!=undefined&&a.terms.get(f)!=undefined;if(e){if(b[f]!=null){b[f]=b[f]+Number(c.get("similarity"))}else{b[f]=Number(c.get("similarity"))}}})});console.log("data:");console.log(b);a.drawPieChart(b)},drawPieChart:function(h){var b=this;$("#retrievalPieChart").empty();var g=new google.visualization.DataTable();g.addColumn("string","Term");g.addColumn("number","Similarity weighted sum");g.addRows(_.size(h));var e=0;var a=[];for(var d in h){if(h.hasOwnProperty(d)){var f=h[d];var c=b.terms.get(d);g.setValue(e,0,c.get("name"));g.setValue(e,1,f);e++}}new google.visualization.PieChart(document.getElementById("retrievalPieChart")).draw(g,{width:500,height:350,title:""})},appendThumbs:function(f){var d=this;var g=0;var a=2500;var e=Math.abs(f)*a;var c=(Math.abs(f)+1)*a;d.annotations=new Array();var b=new AnnotationThumbView({model:d.baseAnnotation,className:"thumb-wrap",id:"annotationthumb"+d.baseAnnotation.get("id")}).render();$(b.el).css("border","50px");$(b.el).css("color","green");$(b.el).css("background-color","green");$("#retrievalThumb").append(b.el);d.model.each(function(h){if((g>=e)&&(g<c)){h.set({name:h.get("similarity")});var j=new AnnotationModel(h);var i=new AnnotationThumbView({model:j,className:"thumb-wrap",id:"annotationthumb"+j.id}).render();$("#retrievalThumb").append(i.el)}g++;d.annotations.push(h.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(b){var a=this;var c=a.annotations;b.each(function(d){if(_.indexOf(a.annotations,d.id)==-1){a.add(d);a.annotations.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){a.remove(d);a.annotations=_.without(a.annotations,d)})}});var Component=Backbone.View.extend({tagName:"div",views:{},initialize:function(a){this.divId=a.divId;this.el=a.el;this.template=a.template;this.buttonAttr=a.buttonAttr;if(a.activate!=undefined){this.activate=a.activate}if(a.deactivate!=undefined){this.deactivate=a.deactivate}if(a.show!=undefined){this.show=a.show}},render:function(){var a=this;$(this.el).append(this.template);$("#project-button").twipsy({placement:"below"});$("#ontology-button").twipsy({placement:"below"});$("#upload-button").twipsy({placement:"below"});$("#explorer-button").twipsy({placement:"below"});return this},addToMenu:function(){var a=this;require(["text!application/templates/MenuButton.tpl.html"],function(b){var c=_.template(b,{id:a.buttonAttr.elButton,route:a.buttonAttr.route,text:a.buttonAttr.buttonText,datacontent:a.buttonAttr.dataContent,datatitle:a.buttonAttr.dataTitle},true);$(a.buttonAttr.buttonWrapper).append(c);if(a.buttonAttr.click){$("#"+a.buttonAttr.elButton).click(a.buttonAttr.click)}$("#"+a.buttonAttr.elButton).popover({placement:"below"})})},activate:function(){$("#"+this.divId).show();$("#"+this.buttonAttr.elButton).addClass("ui-state-disabled")},deactivate:function(){$("#"+this.divId).hide();$("#"+this.buttonAttr.elButton).removeClass("ui-state-disabled")},show:function(a,e,c){$(e).find(".title.active").each(function(){$(this).removeClass("active")});$(e).find("a[name="+c+"]").addClass("active");for(var d in this.views){var b=this.views[d];if(b!=a){$(b.el).hide()}}$(a.el).show()}});var ApplicationView=Backbone.View.extend({tagName:"div",className:"layout",components:{},events:{"click #undo":"undo","click #redo":"redo"},undo:function(){window.app.controllers.command.undo()},redo:function(){window.app.controllers.command.redo()},initialize:function(a){},doLayout:function(a,b){$(this.el).html(_.template(a,{}));_.each(this.components,function(c){c.render()});b.call();return this},render:function(b){this.initComponents();var a=this;require(["text!application/templates/BaseLayout.tpl.html"],function(c){a.doLayout(c,b)});return this},initUserMenu:function(){require(["text!application/templates/MenuDropDown.tpl.html"],function(a){$("#menu-right").append(a);$("#logout").click(function(){window.app.controllers.auth.logout();return false});$("#loggedUser").html(window.app.status.user.model.prettyName())})},initComponents:function(){var a=this;require(["text!application/templates/upload/UploadComponent.tpl.html","text!application/templates/WarehouseComponent.tpl.html","text!application/templates/explorer/ExplorerComponent.tpl.html","text!application/templates/AdminComponent.tpl.html"],function(c,d,b,e){a.components.upload=new Component({el:"#content",template:_.template(c,{}),buttonAttr:{elButton:"upload-button",buttonText:"Upload",buttonWrapper:"#menu",dataContent:"Send your data !",dataTitle:"Upload",icon:"ui-icon-circle-arrow-s",route:"#upload"},divId:"upload"});a.components.warehouse=new Component({el:"#content",template:_.template(d,{}),buttonAttr:{elButton:"warehouse-button",buttonText:"Organize",buttonWrapper:"#menu",dataContent:"Organize your projects, images, etc...",dataTitle:"Organize",icon:"ui-icon-wrench",route:"#project"},divId:"warehouse"});a.components.explorer=new Component({el:"#content",template:_.template(b,{}),buttonAttr:{elButton:"explorer-button",buttonText:"Explore",buttonWrapper:"#menu",dataContent:"View your data",dataTitle:"Explore",icon:"ui-icon-image",route:"#explorer"},divId:"explorer",activate:function(){if(window.app.status.currentProject==undefined){$("#explorer > .noProject").show()}else{$("#explorer > .noProject").hide()}$("#"+this.divId).show();$("#"+this.buttonAttr.elButton).addClass("ui-state-disabled")}})})},showComponent:function(a){_.each(this.components,function(b){if(b!=a){b.deactivate()}});$("#app").show();a.activate()}});ApplicationView.prototype.message=function(e,c,b){b=b||"info";if(c!=undefined){c.responseText&&(c=c.responseText)}var a='<div style="min-width: 200px" id="alert<%=   timestamp %>" class="alert-message <%=   type %> fade in" data-alert="alert"><a class="close" href="#">×</a><p><strong><%=   alert %></strong> <%=   message %></p></div>';var d=new Date().getTime();$("#alerts").append(_.template(a,{alert:e,message:c,timestamp:d,type:b}));$("#alert"+d).alert();setTimeout(function(){$("#alert"+d).alert("close");$("#alert"+d).remove()},3000)};var ConfirmDialogView=Backbone.View.extend({tagName:"div",templateURL:null,templateData:null,initialize:function(a){this.el=a.el;this.template=a.template;this.templateURL=a.templateURL;this.autoOpen=a.autoOpen;this.templateData=a.templateData;this.dialogAttr=a.dialogAttr;this.dialogAttr.autoOpen=a.dialogAttr.autoOpen;if(a.dialogAttr.autoOpen==undefined){this.dialogAttr.autoOpen=true}if(!a.dialogAttr.width){this.dialogAttr.width="auto"}if(!a.dialogAttr.height){this.dialogAttr.height="auto"}},doLayout:function(b){var a=this;$(this.el).html(b);$(this.dialogAttr.dialogID).modal({keyboard:true,show:true});$(this.dialogAttr.dialogID).bind("hidden",function(){$(a.dialogAttr.dialogID).remove()})},render:function(){var a=this;if(this.template==null&&this.templateURL!=null&&this.templateData!=null){require([this.templateURL],function(b){a.template=_.template(b,a.templateData);a.doLayout(a.template)})}else{this.doLayout(this.template)}return this}});