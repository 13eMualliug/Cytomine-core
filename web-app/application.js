var Watcher=function(b,d,a){_.bindAll(this,"fetch","destroy");var c=this;this.model=b;this.callback=d;this.interval=a||1000;this.current=JSON.stringify(this.model);this.watcher=setInterval(this.fetch,this.interval)};Watcher.prototype.fetch=function(){var a=this;this.model.fetch({silent:true,success:function(){var b=JSON.stringify(a.model);if(a.current!==b){a.current=b;a.callback&&a.callback()}},error:function(){}})};Watcher.prototype.destroy=function(){window.clearInterval(this.watcher)};var Status=function(c,a,d,b){_.bindAll(this,"start","error","stop");this.url=c;this.errorcallback=a;this.successcallback=d;this.interval=b||1000;this.start()};Status.prototype.start=function(){var a=this;var c=function(){var d=window.app.status.currentProject;if(d==undefined){d="null"}new PingModel({project:d}).save({},{success:function(g,f){a.successcallback()},error:function(g,f){a.error()}})};if(!this.watcher){var b=this;this.watcher=setInterval(c,this.interval)}};Status.prototype.error=function(){this.stop();this.errorcallback(this)};Status.prototype.stop=function(){if(this.watcher){window.clearInterval(this.watcher);delete this.watcher}};var ApplicationController=Backbone.Router.extend({models:{},controllers:{},view:null,status:{},routes:{"":"initialRoute",explorer:"explorer",admin:"admin"},startup:function(){var a=this;a.dataTablesBootstrap();HotKeys.initHotKeys();require(["text!application/templates/explorer/SimilarAnnotationModal.tpl.html"],function(d){var f=_.template(d,{});$("#similarannotationmodal").append(f);$("#tabSimilarAnnotation a").click(function(g){g.preventDefault();$(this).tab("show")})});a.view=new ApplicationView({el:$("#content")});a.models.images=new ImageCollection({project:undefined});a.models.imagesinstance=new ImageInstanceCollection({project:undefined});a.models.slides=new SlideCollection({project:undefined});a.models.terms=new TermCollection({project:undefined});a.models.ontologies=new OntologyCollection();a.models.ontologiesLigth=new OntologyCollection({light:true});a.models.disciplines=new DisciplineCollection();a.models.projects=new ProjectCollection({user:undefined});a.models.annotations=new AnnotationCollection({});a.models.currentCollection={};var c=[];if(_.size(c)==0){a.modelFetched(0,0)}else{var b=0;_.each(c,function(d){d.fetch({success:function(g,f){a.modelFetched(++b,_.size(c))}})})}},modelFetched:function(b,a){if(b==a){this.view.render(this.start)}},setNewImage:function(a){this.newImage={};this.newImage.position=false;this.newImage.image=a},setNewImageWithPosition:function(c,a,d,b){this.setNewImage(c);this.newImage.position=true;this.newImage.x=a;this.newImage.y=d;this.newImage.zoom=b},popNewImage:function(){var a=this.newImage;this.newImage=null;return a},start:function(){window.app.controllers.image=new ImageController();window.app.controllers.project=new ProjectController();window.app.controllers.dashboard=new DashboardController();window.app.controllers.browse=new ExplorerController();window.app.controllers.ontology=new OntologyController();window.app.controllers.upload=new UploadController();window.app.controllers.command=new CommandController();window.app.controllers.annotation=new AnnotationController();window.app.controllers.activity=new ActivityController();window.app.controllers.account=new AccountController();window.app.controllers.phono=new PhonoController();window.app.view.initPreferences();window.app.view.initUserMenu();Backbone.history.start()},initialize:function(){var a=this;a.controllers.auth=new AuthController();require(["text!application/templates/ServerDownDialog.tpl.html"],function(d){var c=function(h){window.app.view.clearIntervals();$("#content").fadeOut("slow").empty();$(".navbar").remove();new ConfirmDialogView({el:"#dialogs",template:d,dialogAttr:{dialogID:"#server-down"}}).render()};var g=function(h){console.log("Launch app!");a.status.version=h.get("version");a.status.serverURL=h.get("serverURL");if(h.get("authenticated")){new UserModel({id:h.get("user")}).fetch({success:function(k,i){a.status.user={id:h.get("user"),authenticated:h.get("authenticated"),model:k,filenameVisible:true};a.startup()}})}else{a.controllers.auth.login()}};var b="server/ping";var f=window.app.status.currentProject;if(f==undefined){f="null"}new PingModel({project:f}).save({},{success:function(i,h){console.log("Ping success first!");g(i)},error:function(i,h){console.log("Ping error!")}});a.status=new Status(b,c,function(){},20000)})},explorer:function(){this.view.showComponent(this.view.components.explorer)},admin:function(){this.view.showComponent(this.view.components.admin)},warehouse:function(){this.view.showComponent(this.view.components.warehouse)},initialRoute:function(){this.navigate("#project",true)},convertLongToDate:function(d){var b=new Date();b.setTime(d);var g=b.getFullYear();var h=(b.getMonth()+1)<10?"0"+(b.getMonth()+1):(b.getMonth()+1);var c=(b.getDate())<10?"0"+(b.getDate()):(b.getDate());var a=(b.getHours())<10?"0"+(b.getHours()):(b.getHours());var f=(b.getMinutes())<10?"0"+(b.getMinutes()):(b.getMinutes());return g+"-"+h+"-"+c+" "+a+"h"+f},convertLongToDateShort:function(c){var a=new Date();a.setTime(c);var d=a.getFullYear();var f=(a.getMonth()+1)<10?"0"+(a.getMonth()+1):(a.getMonth()+1);var b=(a.getDate())<10?"0"+(a.getDate()):(a.getDate());return d+"-"+f+"-"+b},minString:function(c,a,d){if(c.length<=(a+d+5)){return c}var f=c.substr(0,a);var b=c.substr((c.length-d),d);return f+"[...]"+b},replaceVariable:function(b){if(!b){return b}var a=b;a=a.replace("$currentProjectCreationDate$",window.app.status.currentProjectModel.get("created"));a=a.replace("$currentProject$",window.app.status.currentProject);a=a.replace("$cytomineHost$",window.location.protocol+"//"+window.location.host);a=a.replace("$currentDate$",new Date().getTime());a=a.replace("$currentOntology$",window.app.status.currentProjectModel.get("ontology"));return a},retrieveTerm:function(b){var a=this;return new TermCollection(a.retrieveChildren(b.attributes))},retrieveChildren:function(c){var a=this;if(c.children.length==0){return[]}var b=[];_.each(c.children,function(d){b.push(d);b=_.union(b,a.retrieveChildren(d))});return b},isCollectionUndefinedOrEmpty:function(a){console.log(a);return(a==undefined||(a==1&&a.at(0).id==undefined))},getFromCache:function(a){return this.models.currentCollection[a]},addToCache:function(a,b){this.models.currentCollection[a]=b},clearCache:function(){this.models.currentCollection={}},addOrReplaceEvent:function(b,a,c){if(!b||!b.data("events")||!b.data("events")[a]||!c){return false}for(runner in b.data("events")[a]){if(b.data("events")[a][runner].handler==c){return true}}return false},dataTablesBootstrap:function(){$.extend($.fn.dataTableExt.oStdClasses,{sWrapper:"dataTables_wrapper form-inline"});$.fn.dataTableExt.oApi.fnPagingInfo=function(a){return{iStart:a._iDisplayStart,iEnd:a.fnDisplayEnd(),iLength:a._iDisplayLength,iTotal:a.fnRecordsTotal(),iFilteredTotal:a.fnRecordsDisplay(),iPage:Math.ceil(a._iDisplayStart/a._iDisplayLength),iTotalPages:Math.ceil(a.fnRecordsDisplay()/a._iDisplayLength)}};$.extend($.fn.dataTableExt.oPagination,{bootstrap:{fnInit:function(f,b,d){var a=f.oLanguage.oPaginate;var g=function(h){h.preventDefault();if(f.oApi._fnPageChange(f,h.data.action)){d(f)}};$(b).addClass("pagination").append('<ul><li class="prev disabled"><a href="#">&larr; '+a.sPrevious+'</a></li><li class="next disabled"><a href="#">'+a.sNext+" &rarr; </a></li></ul>");var c=$("a",b);$(c[0]).bind("click.DT",{action:"previous"},g);$(c[1]).bind("click.DT",{action:"next"},g)},fnUpdate:function(c,l){var m=5;var f=c.oInstance.fnPagingInfo();var k=c.aanFeatures.p;var h,g,d,a,n,b=Math.floor(m/2);if(f.iTotalPages<m){a=1;n=f.iTotalPages}else{if(f.iPage<=b){a=1;n=m}else{if(f.iPage>=(f.iTotalPages-b)){a=f.iTotalPages-m+1;n=f.iTotalPages}else{a=f.iPage-b+1;n=a+m-1}}}for(h=0,iLen=k.length;h<iLen;h++){$("li:gt(0)",k[h]).filter(":not(:last)").remove();for(g=a;g<=n;g++){d=(g==f.iPage+1)?'class="active"':"";$("<li "+d+'><a href="#">'+g+"</a></li>").insertBefore($("li:last",k[h])[0]).bind("click",function(i){i.preventDefault();c._iDisplayStart=(parseInt($("a",this).text(),10)-1)*f.iLength;l(c)})}if(f.iPage===0){$("li:first",k[h]).addClass("disabled")}else{$("li:first",k[h]).removeClass("disabled")}if(f.iPage===f.iTotalPages-1||f.iTotalPages===0){$("li:last",k[h]).addClass("disabled")}else{$("li:last",k[h]).removeClass("disabled")}}}}})}});var UploadController=Backbone.Router.extend({initialized:false,routes:{upload:"upload"},upload:function(){if(!this.initialized){this.initForm();this.initialized=true}window.app.view.showComponent(window.app.view.components.upload)},initForm:function(){new UploadFormView({el:$("#upload")}).render()}});var AuthController=Backbone.Router.extend({routes:{},login:function(){var a=new LoginDialogView({}).render()},logout:function(){var a=new LogoutDialogView({}).render()},doLogin:function(){var c=new ApplicationView();var b=$("#login-form").serialize();var a=window.location;$.ajax({url:"j_spring_security_check",type:"post",dataType:"json",data:b,success:function(d){c.message("Welcome","You are logged as "+d.fullname,"","success");new UserModel({id:d.id}).fetch({success:function(g,f){window.app.status.user={authenticated:true,id:d.id,model:g,filenameVisible:true};$("#login-confirm").remove();window.app.startup()}})},error:function(d){var f=$.parseJSON(d.responseText);$("#submit-login").attr("disabled","disabled");$("#login-confirm").effect("shake",{times:2},100);setTimeout(function(){$("#submit-login").removeAttr("disabled")},400);c.message("Error",f.message,"error")}});return false}});var ProjectController=Backbone.Router.extend({manageView:null,routes:{project:"project","project-manage-:idProject":"manage"},initView:function(){var a=this;var b=null;var c=function(){if(b==null){return}a.view=new ProjectView({model:b,el:$("#project"),container:window.app.view.components.project}).render();a.view.container.views.project=a.view;a.view.container.show(a.view,"#project","project");window.app.view.showComponent(window.app.view.components.project)};window.app.models.projects.fetch({success:function(f,d){b=f;c()}})},project:function(c){console.log("controller.project");var a=this;$("#warehouse-button").attr("href","#project");$("#addimagediv").hide();$("#projectdiv").show();var b=function(){a.view.container.show(a.view,"#project","project");window.app.view.showComponent(window.app.view.components.project);if(_.isFunction(c)){c.call()}};if(!this.view){this.initView()}else{b.call()}},manage:function(c){var b=this;var a=function(){$("#projectdiv").hide();$("#addimagediv").show();new ProjectModel({id:c}).fetch({success:function(f,d){b.manageView=new ProjectManageSlideDialog({model:f,projectPanel:null,el:$("#project")}).render()}})};if(b.view==undefined){b.project(a)}else{b.view.container.show(b.view,"#project","project");window.app.view.showComponent(window.app.view.components.project);a()}}});var DashboardController=Backbone.Router.extend({view:null,routes:{"tabs-images-:project":"images","tabs-thumbs-:project":"imagesthumbs","tabs-imagesarray-:project":"imagesarray","tabs-annotations-:project-:terms-:users":"annotations","tabs-annotations-:project":"annotations","tabs-properties-:project-:iddomain":"properties","tabs-properties-:project":"properties","tabs-projectproperties-:project-:iddomain":"projectProperties","tabs-annotationproperties-:project-:iddomain":"annotationProperties","tabs-imageproperties-:project-:iddomain":"imageProperties","tabs-dashboard-:project":"dashboard","tabs-config-:project":"config","tabs-algos-:project-:software-:job":"algos","tabs-algos-:project-:software-":"algos","tabs-algos-:project":"algos","tabs-reviewdash-:project-:image-:user-:term":"review"},init:function(a,b){$(window).scrollTop(0);console.log("window.app.status.currentProject="+window.app.status.currentProject+" new project="+a);if(window.app.status.currentProject!=undefined&&window.app.status.currentProject!=a){this.destroyView();window.app.controllers.browse.closeAll();window.app.status.currentProject=undefined;window.app.view.clearIntervals()}if(window.app.status.currentProject==undefined){window.app.view.clearIntervals();window.app.status.currentProject=a;window.app.controllers.browse.initTabs();if(this.view==null){this.createView(b)}this.showView()}else{b.call();this.showView()}},images:function(a){this.imagesarray(a)},imagesthumbs:function(c){console.log("imagesthumbs");var a=this;var b=function(){console.log("refreshImagesThumbs");a.view.refreshImagesThumbs();console.log("showImagesThumbs");a.view.showImagesThumbs();var d=$("#explorer > .browser").find(".nav-tabs");d.find("a[href=#tabs-images-"+window.app.status.currentProject+"]").tab("show")};this.init(c,b)},imagesarray:function(c){var a=this;var b=function(){console.log("refreshImagesTable");a.view.refreshImagesTable();console.log("showImagesTable");a.view.showImagesTable();var d=$("#explorer > .browser").find(".nav-tabs");d.find("a[href=#tabs-images-"+window.app.status.currentProject+"]").tab("show")};this.init(c,b)},annotations:function(d,c,f){console.log("controller.annotations="+f);var a=this;var b=function(){window.app.controllers.browse.tabs.triggerRoute=false;var g=$("#explorer > .browser").find(".nav-tabs");g.find("a[href=#tabs-annotations-"+window.app.status.currentProject+"]").click();a.view.refreshAnnotations(c,f);window.app.controllers.browse.tabs.triggerRoute=true};this.init(d,b)},projectProperties:function(b,a){this.properties(b,a,"Project")},imageProperties:function(b,a){this.properties(b,a,"ImageInstance")},annotationProperties:function(b,a){this.properties(b,a,"Annotation")},properties:function(f,c,d){console.log("controller.properties: "+f+"-"+c);var a=this;var b=function(){console.log("init properties with domain = "+d);window.app.controllers.browse.tabs.triggerRoute=false;var g=$("#explorer > .browser").find(".nav-tabs");g.find("a.annotationTabLink").click();a.view.refreshProperties(c,d);window.app.controllers.browse.tabs.triggerRoute=true};a.init(f,b)},algos:function(){this.algos(undefined,undefined,undefined)},algos:function(a){this.algos(a,undefined,undefined)},algos:function(b,a){this.algos(b,a,undefined)},algos:function(f,b,d){var a=this;console.log("DashBoard.algos");var c=function(){window.app.controllers.browse.tabs.triggerRoute=false;var g=$("#explorer > .browser").find(".nav-tabs");console.log(g.find("a[href^=#tabs-algos-"+window.app.status.currentProject+"-]"));g.find("a[href^=#tabs-algos-"+window.app.status.currentProject+"]").click();a.view.refreshAlgos(b,d||undefined);window.app.controllers.browse.tabs.triggerRoute=true};this.init(f,c)},review:function(g,f,b,c){var a=this;var d=function(){console.log("project="+g+" image="+f+" user="+b+" term="+c);if(b&&(b=="null")){b=null}if(c&&(c=="null")){c=null}console.log("Controller dashboard.review");a.view.refreshReview(f,b,c);var h=$("#explorer > .browser").find(".nav-tabs");h.find("a[href=#tabs-reviewdash-"+window.app.status.currentProject+"]").tab("show")};this.init(g,d)},config:function(c){var a=this;var b=function(){a.view.refreshConfig();var d=$("#explorer > .browser").find(".nav-tabs");d.find("a[href=#tabs-config-"+window.app.status.currentProject+"]").click()};this.init(c,b)},dashboard:function(c,d){var a=this;var b=function(){a.view.refreshDashboard();window.app.controllers.browse.tabs.triggerRoute=false;var f=$("#explorer > .browser").find(".nav-tabs");f.find("#dashboardLink-"+window.app.status.currentProject).click();window.app.controllers.browse.tabs.triggerRoute=true;if(d!=undefined){d.call()}};this.init(c,b)},createView:function(f){var b=this;var a=5;var d=0;var c=function(g){d++;if(d<g){return}b.view=new ProjectDashboardView({model:window.app.status.currentProjectModel,el:$("#explorer-tab-content")}).render();f.call()};new UserJobCollection({project:window.app.status.currentProject}).fetch({success:function(h,g){window.app.models.projectUserJob=h;c(a)}});new UserCollection({project:window.app.status.currentProject}).fetch({success:function(h,g){window.app.models.projectUser=h;c(a)}});new UserLayerCollection({project:window.app.status.currentProject}).fetch({success:function(h,g){window.app.models.userLayer=h;c(a)}});new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(h,g){window.app.status.currentProjectModel=h;c(a);new OntologyModel({id:window.app.status.currentProjectModel.get("ontology")}).fetch({success:function(k,i){window.app.status.currentOntologyModel=k;window.app.status.currentTermsCollection=window.app.retrieveTerm(k);c(a)}})}})},destroyView:function(){$(".projectUserDialog").modal("hide");$(".projectUserDialog").remove();this.view=null},showView:function(){$("#explorer > .browser").show();$("#explorer > .noProject").hide();window.app.view.showComponent(window.app.view.components.explorer)},printJobParameterValue:function(g,a,h){var b=this;if(g.type=="Date"){a.html(window.app.convertLongToDate(g.value))}else{if(g.type=="Boolean"){if(g.value=="true"){a.html('<input type="checkbox" name="" checked="checked" />')}else{a.html('<input type="checkbox" name="" />')}}else{if(g.type=="ListDomain"||g.type=="Domain"){var c=g.value.split(",");console.log("Domain or ListDomain:"+c);var f=window.app.getFromCache(window.app.replaceVariable(g.uri));if(f==undefined||(f.length>0&&f.at(0).id==undefined)){console.log("Collection is NOT CACHE - Reload collection");f=new SoftwareParameterModelCollection({uri:window.app.replaceVariable(g.uri),sortAttribut:g.uriSortAttribut});f.fetch({success:function(k,i){window.app.addToCache(window.app.replaceVariable(g.uri),k);a.html(b.createJobParameterDomainValue(c,k,g,h))}})}else{console.log("Collection is CACHE");a.html(b.createJobParameterDomainValue(c,f,g,h))}}else{var d=g.value;if(g.name.toLowerCase()=="privatekey"||g.name.toLowerCase()=="publickey"){d="************************************"}a.html(d)}}}},createJobParameterDomainValue:function(b,g,f,i){var h=function(k,l){if(k.get("class")=="be.cytomine.project.Project"){return _.template("<a href='#tabs-dashboard-<%= id %>'><%= name %></a>",{id:k.id,name:k.get(l)})}else{if(k.get("class")=="be.cytomine.image.ImageInstance"){return _.template("<a href='#tabs-image-<%= idProject %>-<%= idImage %>-'><%= name %></a>",{idProject:k.get("project"),idImage:k.id,name:k.get(l)})}else{if(k.get("class")=="be.cytomine.ontology.Term"){return _.template("<a href='#ontology/<%= idOntology %>/<%= idTerm %>'><%= name %></a>",{idOntology:k.get("ontology"),idTerm:k.id,name:k.get(l)})}else{return k.get(l)}}}};var c=[];_.each(b,function(l){var k=g.get(l);if(k==undefined){c.push("Unknown")}else{c.push(h(k,f.uriPrintAttribut))}});c=_.sortBy(c,function(k){return k});var d=c.join(", ");var a=d;if(d.length>i){a=d.substring(0,i)+"..."}return a}});var ImageController=Backbone.Router.extend({routes:{image:"image","image/p:page":"image"},image:function(a){if(!this.view){this.view=new ImageView({page:a,model:window.app.models.images,el:$("#warehouse > .image"),container:window.app.view.components.warehouse}).render();this.view.container.views.image=this.view}this.view.container.show(this.view,"#warehouse > .sidebar","image");window.app.view.showComponent(window.app.view.components.warehouse)}});var ExplorerController=Backbone.Router.extend({tabs:null,routes:{"tabs-annotation-:idAnnotation":"browseAnnotation","tabs-image-:idProject-:idImage-":"browse","tabs-image-:idProject-:idImage-:idAnnotation":"browse","tabs-review-:idProject-:idImage-":"review",close:"close","tabs-leaflet-:idProject-:idImage-":"leaflet"},initialize:function(){},initTabs:function(){this.tabs=new ExplorerTabs({el:$("#explorer > .browser"),container:window.app.view.components.explorer}).render()},browseAnnotation:function(a){var b=this;console.log("browseAnnotation");new AnnotationModel({id:a}).fetch({success:function(d,c){b.browse(d.get("project"),d.get("image"),a)}})},leaflet:function(c,b){var a=this;console.log("activate leaflet");require(["http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"],function(){console.log("activate leaflet plugins");require(["lib/leaflet/plugins/zoomify-layer-master/zoomify_layer.js","lib/leaflet/plugins/Leaflet.draw-master/dist/leaflet.draw.js"],function(){BrowseImageView=LeafletView;a.browse(c,b)})})},browse:function(f,d,a){$(window).scrollTop(0);var c=this;if(this.tabs==null){console.log("this.tabs==null");this.initTabs()}var b=function(){console.log("createBrowseImageViewTab");var g={};if(a!=""){g.goToAnnotation={value:a}}c.tabs.addBrowseImageView(d,g);console.log("showView");c.showView()};if(window.app.status.currentProject==undefined||window.app.status.currentProject!=f){console.log("project check");window.app.controllers.dashboard.dashboard(f,b);return}b()},review:function(d,c){$(window).scrollTop(0);var b=this;if(this.tabs==null){console.log("this.tabs==null");this.initTabs()}var a=function(){console.log("createReviewImageViewTab");var f={};b.tabs.addReviewImageView(c,f);console.log("showView");b.showView()};if(window.app.status.currentProject==undefined||window.app.status.currentProject!=d){console.log("project check");window.app.controllers.dashboard.dashboard(d,a);return}a()},closeAll:function(){if(this.tabs==null){return}this.tabs=null;$("#explorer > .browser").empty()},showView:function(){$("#explorer > .browser").show();$("#explorer > .noProject").hide();window.app.view.showComponent(window.app.view.components.explorer)}});var TermController=Backbone.Router.extend({routes:{term:"term","term/o:ontology":"term"},term:function(a){if(!this.view){this.view=new TermView({model:window.app.models.terms,ontology:a,el:$("#explorer > .term"),container:window.app.view.components.explorer}).render();this.view.container.views.term=this.view}this.view.container.show(this.view)}});var OntologyController=Backbone.Router.extend({routes:{ontology:"ontology","ontology/:idOntology":"ontology","ontology/:idOntology/:idTerm":"ontology"},ontology:function(){this.ontology(0,0,false)},ontology:function(a){this.ontology(a,0,false)},ontology:function(a,b){this.ontology(a,b,false)},ontology:function(b,c,d){console.log("ontology-"+b+"-"+c+"-"+d);var a=this;if(!a.view||d){console.log("empty view");a.view=new OntologyView({el:$("#ontology"),container:window.app.view.components.ontology,idOntology:b,idTerm:c}).render();a.view.container.views.ontology=a.view;a.view.container.show(a.view,"#warehouse > .sidebar","ontology");$("#warehouse-button").attr("href","#ontology");window.app.view.showComponent(window.app.view.components.ontology)}else{a.view.container.show(a.view,"#warehouse > .sidebar","ontology");window.app.view.showComponent(window.app.view.components.ontology);a.view.select(b,c)}}});var CommandController=Backbone.Router.extend({initialize:function(){this.commandInProgess=false},undo:function(){var a=this;if(a.commandInProgess){window.app.view.message("Oh wait :-)","Operation already in progress","error");return}a.commandInProgess=true;$.post("command/undo.json",{},function(b){_.each(b,function(c){a.dispatch(c.callback,c.message,"Undo");if(c.printMessage){window.app.view.message("Undo",c.message,"info")}a.commandInProgess=false})},"json")},redo:function(){var a=this;if(a.commandInProgess){window.app.view.message("Oh wait :-)","Operation already in progress","error");return}a.commandInProgess=true;$.post("command/redo.json",{},function(b){_.each(b,function(c){a.dispatch(c.callback,c.message,"Redo");if(c.printMessage){window.app.view.message("Redo",c.message,"info")}});a.commandInProgess=false},"json")},dispatch:function(f,c,a){if(!f){return}if(f.method=="be.cytomine.AddUserAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(g){return g.idImage==f.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationAdded(f.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(f.method=="be.cytomine.EditUserAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(g){return g.idImage==f.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationUpdated(f.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(f.method=="be.cytomine.DeleteUserAnnotationCommand"){console.log("delete annotation");var b=_.detect(window.app.controllers.browse.tabs.tabs,function(g){return g.idImage==f.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().annotationRemoved(f.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(f.method=="be.cytomine.AddAnnotationTermCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(g){return g.idImage==f.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().termAdded(f.annotationID,f.termID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(f.method=="be.cytomine.DeleteAnnotationTermCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(g){return g.idImage==f.imageID});if(b==undefined){return}var d=b.view;d.getUserLayer().termRemoved(f.annotationID,f.termID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refreshAnnotations()}}else{if(f.method=="be.cytomine.AddOntologyCommand"){window.app.controllers.ontology.view.refresh(f.ontologyID)}else{if(f.method=="be.cytomine.DeleteOntologyCommand"){window.app.controllers.ontology.view.refresh()}else{if(f.method=="be.cytomine.EditOntologyCommand"){window.app.controllers.ontology.view.refresh(f.ontologyID)}else{if(f.method=="be.cytomine.AddProjectCommand"){window.app.controllers.project.view.refresh()}else{if(f.method=="be.cytomine.DeleteProjectCommand"){window.app.controllers.project.view.refresh()}else{if(f.method=="be.cytomine.EditProjectCommand"){window.app.controllers.project.view.refresh()}else{if(f.method=="be.cytomine.AddTermCommand"){window.app.controllers.ontology.view.refresh(f.ontologyID)}else{if(f.method=="be.cytomine.DeleteTermCommand"){window.app.controllers.ontology.view.refresh(f.ontologyID)}else{if(f.method=="be.cytomine.EditTermCommand"){window.app.controllers.ontology.view.refresh(f.ontologyID)}else{if(f.method=="be.cytomine.AddImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(f.method=="be.cytomine.DeleteImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(f.method=="be.cytomine.EditImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}}}}}}}}}}}}}}}}}}});var AnnotationController=Backbone.Router.extend({routes:{annotation:"annotation","annotation/:idAnnotation":"annotation","share-annotation/:idAnnotation":"share","copy-annotation/:idAnnotation":"copy"},annotation:function(a){var b=this;if(!b.view){window.app.models.images.fetch({success:function(d,c){b.view=new AnnotationListView({model:d,el:$("#warehouse > .annotation"),container:window.app.view.components.warehouse,idAnnotation:a}).render();b.view.container.views.annotation=b.view;b.view.container.show(b.view,"#warehouse > .sidebar","annotation");window.app.view.showComponent(window.app.view.components.warehouse)}})}},share:function(a){new AnnotationModel({id:a}).fetch({success:function(c,b){var d=new ShareAnnotationView({model:c,image:c.get("image"),project:c.get("project")});if(!window.app.models.projectUser){new ProjectModel({id:c.get("project")}).fetch({success:function(g,f){window.app.status.currentProject=g.get("id");window.app.status.currentProjectModel=g;new UserCollection({project:window.app.status.currentProject}).fetch({success:function(i,h){window.app.models.projectUser=i;d.render()}})}})}else{d.render()}}})}});var AdminController=Backbone.Router.extend({initialize:function(){},routes:{"admin/users":"users","admin/groups":"groups"},users:function(){var b="authorities"+(new Date()).getTime();var a=new SecRoleCollection().fetch({success:function(h,c){var d=function(m,i){var l=m.split(",");var n="";h.each(function(o){if(_.contains(l,o.get("authority"))){n+=_.template("<option value='<%=   id %>' selected><%=   authority %></option>",{id:o.get("id"),authority:o.get("authority")})}else{n+=_.template("<option value='<%=   id %>' ><%=   authority %></option>",{id:o.get("id"),authority:o.get("authority")})}});var k=_.template('<select class="<%=   selectClass %>" title="" multiple="multiple" name="example-basic" size="5" style="display:none;"><%=   authorities %></select>',{selectClass:b,authorities:n});return k};var g=function(l,k,m){if(k==="get"){var i=[];return i.join(",")}else{if(k==="set"){}}};if(window.app.view.components.admin.views.usersGrid==undefined){var f=new CrudGridView({el:"#admin > .admin-users",url:"api/user/grid",restURL:"api/user",title:"Users",colName:["id","username","firstname","email","password","authorities","color"],colModel:[{name:"id",index:"id",width:30},{name:"username",index:"username",editable:true,width:50},{name:"firstname",index:"firstname",editable:true,width:50},{name:"lastname",index:"lastname",editable:true,width:50},{name:"email",index:"email",editable:true,width:80},{name:"password",index:"password",editable:true,width:30,edittype:"password"},{name:"color",index:"color",editable:true,width:30,edittype:"custom",editoptions:{custom_element:new CrudGridView({}).customFields.color.colorPickerElement,custom_value:new CrudGridView({}).customFields.color.colorPickerValue}}]});f.render();window.app.view.components.admin.views.usersGrid=f}window.app.view.components.admin.show(window.app.view.components.admin.views.usersGrid,"#admin > .sidebar","users");$("#admin-button").attr("href","#admin/users");window.app.view.showComponent(window.app.view.components.admin)}})},groups:function(){if(window.app.view.components.admin.views.groupsGrid==undefined){var a=new CrudGridView({el:"#admin > .admin-groups",url:"api/group/grid",editurl:"api/group",title:"Groups",colName:["id","name"],colModel:[{name:"id",index:"id",width:20},{name:"name",index:"name",editable:true,width:50}]});a.render();window.app.view.components.admin.views.groupsGrid=a}window.app.view.components.admin.show(window.app.view.components.admin.views.groupsGrid,"#admin > .sidebar","groups");$("#admin-button").attr("href","#admin/groups");window.app.view.showComponent(window.app.view.components.admin)}});var ActivityController=Backbone.Router.extend({routes:{"activity-:project-:user-":"activity","activity-:project-":"activity","activity-":"activity"},activity:function(){this.activity(null)},activity:function(a){this.activity(null,null)},activity:function(f,c){var b=this;if(f==undefined||f=="null"){f=null}console.log("activity.project="+f);var d=function(h,g){console.log("openView");console.log(h);console.log(g);if(!b.view){console.log("View is not yet created");b.view=new ActivityView({el:"#activity-content"}).render();b.view.refresh(h,g)}else{console.log("View is yet created, just refresh");b.view.refresh(h,g)}window.app.view.showComponent(window.app.view.components.activity)};var a=function(){console.log("user has project");var g=null;console.log("project="+f);if(f!=null){g=window.app.models.projects.get(f)}d(g,c)};console.log(window.app.models.projects);if(window.app.models.projects.length==0||window.app.models.projects.at(0).id==undefined){window.app.models.projects.fetch({success:function(h,g){window.app.models.projects=h;if(h.length==0){console.log("user has no project");window.app.view.message("Project","There is no project!","error");window.location="#project"}else{a()}}})}else{a()}},destroyView:function(){$(".projectUserDialog").modal("hide");$(".projectUserDialog").remove();this.view=null}});var AccountController=Backbone.Router.extend({initialized:false,routes:{account:"account"},account:function(){if(!this.initialized){this.render();this.initialized=true}window.app.view.showComponent(window.app.view.components.account)},render:function(){new AccountDetails({el:"#account",model:window.app.status.user.model}).render()}});var PhonoController=Backbone.Router.extend({routes:{phono:"createMenu"},initialize:function(a){},createMenu:function(){require(["http://s.phono.com/releases/0.3/jquery.phono.js"],function(){new PhonoMenu().render()})}});var PaginatedCollection=Backbone.Paginator.requestPager.extend({fullSize:-1,getNumberOfPages:function(){return this.totalPages},getMax:function(){return this.paginator_ui.perPage},initPaginator:function(a){this.paginator_ui.perPage=0;if(!a){return}if(a.max){this.paginator_ui.perPage=a.max;a.max=undefined}else{this.paginator_ui.perPage=0}},parse:function(b){var a=this;if(b.collection!=undefined){var c=b.collection;this.totalPages=b.totalPages;this.fullSize=b.size;return c}return b},paginator_core:{type:"GET",dataType:"json",url:function(){return this.url()}},paginator_ui:{firstPage:0,currentPage:0,perPage:Number.MAX_VALUE},server_api:{max:function(){return this.perPage!=Number.MAX_VALUE?this.perPage:0},offset:function(){return this.currentPage*this.perPage}}});var DescriptionModel=Backbone.Model.extend({url:function(){return"api/domain/"+this.domainClassName+"/"+this.domainIdent+"/description.json"},initialize:function(a){console.log("options.id="+a.id);this.domainIdent=a.domainIdent;this.domainClassName=a.domainClassName}});var DisciplineModel=Backbone.Model.extend({url:function(){var a="api/discipline";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var DisciplineCollection=PaginatedCollection.extend({model:DisciplineModel,CLASS_NAME:"be.cytomine.project.Discipline",url:function(){return"api/discipline.json"},initialize:function(a){this.initPaginator(a);if(a!=undefined){this.light=a.light}},comparator:function(a){return a.get("name")}});var UploadedFileModel=Backbone.Model.extend({url:function(){var a="api/uploadedfile";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var UploadedFileCollection=PaginatedCollection.extend({model:UploadedFileModel,initialize:function(a){this.initPaginator(a);if(!a){return}this.dataTables=a.dataTables},url:function(){if(this.dataTables){return"api/uploadedfile.json?dataTables=true"}else{return"api/uploadedfile.json"}}});var AnnotationFilterModel=Backbone.Model.extend({url:function(){var a="api/annotationfilter";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationFilterCollection=PaginatedCollection.extend({model:AnnotationFilterModel,initialize:function(a){this.initPaginator(a);this.project=a.project},url:function(){return"api/annotationfilter.json?project="+this.project}});var ImageModel=Backbone.Model.extend({url:function(){var a="api/image";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},getVisibleName:function(a){if(!a){return this.get("originalFilename")}else{return"[BLIND] id="+this.get("id").toString()}}});var ImageReviewModel=Backbone.Model.extend({url:function(){if(this.cancel!=undefined){return"/api/imageinstance/"+this.id+"/review?cancel="+this.cancel}else{return"/api/imageinstance/"+this.id+"/review"}},initialize:function(a){this.id=a.id;this.cancel=a.cancel}});var ImageMetadataModel=Backbone.Model.extend({initialize:function(a){this.image=a.image},url:function(){return"api/image/"+this.image+"/metadata.json?extract=true"}});var ImagePropertyCollection=PaginatedCollection.extend({initialize:function(a){this.initPaginator(a);this.image=a.image},url:function(){return"api/image/"+this.image+"/property.json"},comparator:function(a){return a.get("key")}});var ImageCollection=PaginatedCollection.extend({model:ImageModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/image.json"}else{return"api/image.json?datatable=true"}},initialize:function(a){this.project=a.project}});var ImageServerUrlsModel=Backbone.Model.extend({url:function(){return"api/image/"+this.id+"/imageservers.json"}});var ImageInstanceModel=Backbone.Model.extend({url:function(){var c="api/imageinstance";var d=".json";if(this.isNew()){return c+d}var b="";if(this.next){b="/next"}if(this.previous){b="/previous"}var a=c+(c.charAt(c.length-1)=="/"?"":"/")+this.id+b+d;console.log(a);return a},initialize:function(a){this.id=a.id;this.next=a.next;this.previous=a.previous},getVisibleName:function(a){if(!a){return this.get("originalFilename")}else{return"[BLIND]"+this.get("id")}}});var ImageInstanceCollection=PaginatedCollection.extend({model:ImageModel,url:function(){if(this.tree){return"api/project/"+this.project+"/imageinstance.json?tree=true"}else{return"api/project/"+this.project+"/imageinstance.json"}},initialize:function(a){this.initPaginator(a);this.project=a.project;this.tree=a.tree!=undefined&&a.tree==true}});var UserPositionModel=Backbone.Model.extend({url:function(){if(this.user==undefined){return"api/imageinstance/"+this.image+"/position"}else{return"api/imageinstance/"+this.image+"/position/"+this.user}},initialize:function(a){this.image=a.image;this.user=a.user}});var UserOnlineModel=Backbone.Model.extend({url:function(){return"api/imageinstance/"+this.image+"/online"},initialize:function(a){this.image=a.image}});var TermModel=Backbone.Model.extend({url:function(){var a="api/term";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationTermModel=Backbone.Model.extend({url:function(){if(this.term==null){return"api/annotation/"+this.userannotation+"/term.json"}else{if(this.clear!=null){return"api/annotation/"+this.userannotation+"/term/"+this.term+"/clearBefore.json"}else{if(this.clearForAll!=null){return"api/annotation/"+this.userannotation+"/term/"+this.term+"/clearBefore.json?clearForAll=true"}else{return"api/annotation/"+this.userannotation+"/term/"+this.term+".json"}}}},initialize:function(a){this.userannotation=a.userannotation;this.term=a.term;this.clear=a.clear;this.clearForAll=a.clearForAll}});var AnnotationTermCollection=PaginatedCollection.extend({model:TermModel,url:function(){console.log("this.idUser="+this.idUser+" this.idNotThisUser="+this.idNotThisUser);if(this.idUser==null){return"api/annotation/"+this.idAnnotation+"/term.json"}else{if(this.idUser!=undefined){return"api/annotation/"+this.idAnnotation+"/user/"+this.idUser+"/term.json"}}},initialize:function(a){this.initPaginator(a);this.idAnnotation=a.idAnnotation;this.idUser=a.idUser}});var RelationTermModel=Backbone.Model.extend({url:function(){if(this.term==null){return"api/annotation/"+this.annotation+"/term.json"}else{return"api/annotation/"+this.annotation+"/term/"+this.term+".json"}},initialize:function(a){this.annotation=a.annotation;this.term=a.term}});var RelationTermCollection=PaginatedCollection.extend({model:TermModel,url:function(){return"api/annotation/"+this.idAnnotation+"/term.json"},initialize:function(a){this.initPaginator(a);this.idAnnotation=a.idAnnotation}});var TermCollection=PaginatedCollection.extend({model:TermModel,CLASS_NAME:"be.cytomine.ontology.Term",url:function(){if(this.idProject!=undefined){return"api/project/"+this.idProject+"/term.json"}else{if(this.idOntology==undefined&&this.idAnnotation==undefined){return"api/term.json"}else{if(this.idOntology!=undefined&&this.idAnnotation==undefined){return"api/ontology/"+this.idOntology+"/term.json"}else{if(this.idOntology!=undefined&&this.idAnnotation!=undefined){return"api/annotation/"+this.idAnnotation+"/ontology/"+this.idOntology+"/term.json"}}}}},initialize:function(a){this.initPaginator(a);this.idOntology=a.idOntology;this.idAnnotation=a.idAnnotation;this.idProject=a.idProject},comparator:function(a){return a.get("name")}});var ImageFilterModel=Backbone.Model.extend({url:function(){var a="api/imagefilter";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ImageFilterCollection=PaginatedCollection.extend({model:ImageFilterModel,url:function(){return"api/imagefilter.json"},initialize:function(a){this.initPaginator(a)}});var ProjectImageFilterModel=Backbone.Model.extend({url:function(){var a="api/imagefilterproject";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},initialize:function(a){this.project=a.project}});var ProjectImageFilterCollection=PaginatedCollection.extend({model:ImageFilterModel,url:function(){return"api/project/"+this.project+"/imagefilterproject.json"},initialize:function(a){this.initPaginator(a);this.project=a.project}});var OntologyModel=Backbone.Model.extend({url:function(){var a="api/ontology";var b=".json";if(this.task!=null&&this.task!=undefined){b=b+"?task="+this.task}if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},initialize:function(a){this.id=a.id;this.task=a.task}});var OntologyCollection=PaginatedCollection.extend({model:OntologyModel,CLASS_NAME:"be.cytomine.ontology.Ontology",url:function(){if(this.light==undefined){return"api/ontology.json"}else{return"api/ontology/light.json"}},initialize:function(a){this.initPaginator(a);if(a!=undefined){this.light=a.light}},comparator:function(a){return a.get("name")}});var UserModel=Backbone.Model.extend({url:function(){var a="api/user";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},prettyName:function(){if(this.get("lastname")==undefined){return this.get("softwareName")+" "+window.app.convertLongToDate(this.get("created"))}else{return this.get("lastname")+" "+this.get("firstname")}},layerName:function(){if(this.get("algo")){return this.get("softwareName")+" "+window.app.convertLongToDate(this.get("created"))}else{return this.get("lastname")+" "+this.get("firstname")}}});var UserFriendCollection=PaginatedCollection.extend({model:UserModel,url:function(){return"api/user/"+this.id+"/friends.json"},initialize:function(a){this.initPaginator(a);this.id=a.id},comparator:function(a){if(a.get("lastname")!=undefined){return a.get("lastname")+" "+a.get("firstname")}else{return a.get("username").toLowerCase()}}});var UserOnlineCollection=PaginatedCollection.extend({model:UserModel,url:function(){return"api/project/"+this.project+"/online/user.json"},initialize:function(a){this.initPaginator(a);this.project=a.project}});var UserCollection=PaginatedCollection.extend({model:UserModel,url:function(){if(this.project!=undefined&&this.admin==true){return"api/project/"+this.project+"/admin.json"}else{if(this.project!=undefined&&this.creator==true){return"api/project/"+this.project+"/creator.json"}else{if(this.project!=undefined&&this.online==true){return"api/project/"+this.project+"/user.json?online=true"}else{if(this.project!=undefined){return"api/project/"+this.project+"/user.json"}else{if(this.ontology!=undefined&&this.creator==true){return"api/ontology/"+this.ontology+"/creator.json"}else{if(this.ontology!=undefined){console.log("ontologyYYY="+this.ontology);return"api/ontology/"+this.ontology+"/user.json"}else{return"api/user.json"}}}}}}},initialize:function(a){this.initPaginator(a);this.project=a.project;this.ontology=a.ontology;this.admin=a.admin;this.creator=a.creator;this.online=a.online},comparator:function(a){if(a.get("lastname")!=undefined){return a.get("lastname")+" "+a.get("firstname")}else{if(a.get("username")==undefined){return -1}else{return a.get("username").toLowerCase()}}}});var UserLayerCollection=PaginatedCollection.extend({url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/userlayer.json"}},initialize:function(a){this.initPaginator(a);this.project=a.project}});var UserSecRole=Backbone.Model.extend({url:function(){if(this.role!=undefined||this.isNew()){return"api/user/"+this.user+"/role.json"}else{return"api/user/"+this.user+"/role/"+this.role+".json"}},initialize:function(a){this.user=a.user;this.role=a.role}});var UserJobCollection=PaginatedCollection.extend({model:UserModel,url:function(){if(this.project&&!this.tree&&!this.image){return"api/project/"+this.project+"/userjob.json"}else{if(this.project&&this.image){return"api/project/"+this.project+"/userjob.json?image="+this.image}else{if(this.project&&this.tree){return"api/project/"+this.project+"/userjob.json?tree=true"}else{return"api/userjob.json"}}}},prettyName:function(){return this.get("softwareName")},initialize:function(a){this.initPaginator(a);this.project=a.project;this.image=a.image;this.tree=a.tree||false},comparator:function(a){var b="";if(!a.get("created")){return a.get("created")}for(counter=0;counter<a.get("created").toString().length;counter++){b=b+(9-a.get("created").toString()[counter])}return a.get("softwareName")+b},invertNumber:function(a){}});var ProjectModel=Backbone.Model.extend({url:function(){var a="api/project";var b=".json";if(this.task!=null&&this.task!=undefined){b=b+"?task="+this.task}if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},initialize:function(a){this.id=a.id;this.task=a.task}});var ProjectUserModel=Backbone.Model.extend({url:function(){if(this.user==undefined){return"api/project/"+this.project+"/user.json"}else{return"api/project/"+this.project+"/user/"+this.user+".json"}},initialize:function(a){this.project=a.project;this.user=a.user}});var OntologyProjectModel=PaginatedCollection.extend({model:ProjectModel,url:function(){return"api/ontology/"+this.ontology+"/project.json"},initialize:function(a){this.initPaginator(a);this.ontology=a.ontology}});var ProjectCollection=PaginatedCollection.extend({model:ProjectModel,fullSize:-1,url:function(){if(this.user!=undefined){return"api/user/"+this.user+"/project.json"}else{if(this.ontology!=undefined){return"api/ontology/"+this.ontology+"/project.json"}else{return"api/project.json"}}},initialize:function(a){this.initPaginator(a);if(a!=undefined){this.user=a.user;this.ontology=a.ontology}},comparator:function(a){return a.get("name")}});var AnnotationModel=Backbone.Model.extend({url:function(){var a="api/annotation";var b=".json";if(this.isNew()){return a+b}var c="";if(this.fill){c="?fill=true"}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b+c},initialize:function(a){this.id=a.id;this.fill=a.fill}});var AnnotationCorrectionModel=Backbone.Model.extend({url:function(){var a="api/annotationcorrection";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},initialize:function(a){this.id=a.id}});var AnnotationReviewedModel=Backbone.Model.extend({url:function(){if(this.fill){return"api/annotation/"+this.id+"/review/fill.json"}else{return"api/annotation/"+this.id+"/review.json"}},initialize:function(a){this.id=a.id;this.fill=a.fill}});var AnnotationCollection=PaginatedCollection.extend({model:AnnotationModel,initialize:function(a){this.initPaginator(a);this.filters=a},comparator:function(a){return -a.get("id")},url:function(){var b="";for(var a in this.filters){if(this.filters[a]!=undefined&&a!="max"&&a!="offset"){b=b+"&"+a+"="+this.filters[a]}}return"api/annotation.json?"+b}});var AnnotationImageReviewedModel=Backbone.Model.extend({url:function(){var a="";if(this.task){a="&task="+this.task}return"api/imageinstance/"+this.id+"/annotation/review.json?users="+this.layers.join(",")+a},initialize:function(a){this.id=a.image;this.layers=a.layers;this.task=a.task}});var AnnotationRetrievalModel=Backbone.Model.extend({url:function(){return"api/annotation/"+this.annotation+"/retrieval.json"},initialize:function(a){this.annotation=a.annotation}});var AnnotationRetrievalCollection=PaginatedCollection.extend({model:AnnotationModel,initialize:function(a){this.initPaginator(a);this.annotation=a.annotation},comparator:function(a){return -a.get("similarity")}});var AnnotationCommentModel=Backbone.Model.extend({initialize:function(a){this.annotation=a.annotation},url:function(){var a="api/annotation/"+this.annotation+"/comment";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationCommentCollection=PaginatedCollection.extend({model:AnnotationCommentModel,initialize:function(a){this.initPaginator(a);this.annotation=a.annotation},url:function(){return"api/annotation/"+this.annotation+"/comment.json"}});var SlideModel=Backbone.Model.extend({url:function(){var a="api/sample";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ProjectSlideModel=Backbone.Model.extend({url:function(){if(this.slide==null){return"api/project/"+this.project+"/sample.json"}else{return"api/project/"+this.project+"/sample/"+this.slide+".json"}},initialize:function(a){this.project=a.project;this.slide=a.slide}});var ProjectSlideCollection=PaginatedCollection.extend({model:SlideModel,url:function(){return"api/project/"+this.idProject+"/sample.json"},initialize:function(a){this.initPaginator(a);this.idProject=a.idProject}});var SlideCollection=PaginatedCollection.extend({model:SlideModel,CLASS_NAME:"be.cytomine.image.Sample",url:function(){if(this.page==null){return"api/sample.json"}else{return"api/sample.json?page="+this.page+"&limit="}},initialize:function(a){this.initPaginator(a);this.page=a.page;this.limit=a.limit;this.sidx=a.sidx;this.sord=a.sord}});var StatsModel=Backbone.Model.extend({url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/term.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/project/stat.json"}else{return"api/stat.json"}}},initialize:function(a){this.project=a.project;this.term=a.term}});var StatsProjectSoftwareModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/project/"+this.project+"/software/"+this.software+"/stats.json"}},initialize:function(a){this.project=a.project;this.software=a.software}});var StatsRetrievalSuggestionAVGModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/avg.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/avg.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionMatrixModel=Backbone.Model.extend({url:function(){console.log("StatsRetrievalSuggestionMatrixModel="+this.project+"#"+this.software+"#"+this.job);if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/confusionmatrix.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/confusionmatrix.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionWorstTermModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/worstTerm.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/worstTerm.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionWorstTermWithSuggest=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/worstTermWithSuggest.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/worstTermWithSuggest.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionWorstAnnotationModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/worstAnnotation.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/worstAnnotation.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalSuggestionEvolutionModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined){return"api/stats/retrieval/evolution.json?project="+this.project+"&software="+this.software}else{if(this.job!=undefined){return"api/stats/retrieval/evolution.json?job="+this.job}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job}});var StatsRetrievalEvolutionModel=Backbone.Model.extend({url:function(){if(this.project!=undefined&&this.software!=undefined&&this.term==undefined){return"api/stats/retrieval-evolution/evolution.json?project="+this.project+"&software="+this.software}else{if(this.project!=undefined&&this.software!=undefined&&this.term!=undefined){return"api/stats/retrieval-evolution/evolutionByTerm.json?project="+this.project+"&software="+this.software+"&term="+this.term}else{if(this.job!=undefined&&this.term==undefined){return"api/stats/retrieval-evolution/evolution.json?job="+this.job}else{if(this.job!=undefined){return"api/stats/retrieval-evolution/evolutionByTerm.json?job="+this.job+"&term="+this.term}}}}},initialize:function(a){this.project=a.project;this.software=a.software;this.job=a.job;this.term=a.term}});var StatsTermCollection=PaginatedCollection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/term.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/project/stat.json"}else{return"api/stat.json"}}},initialize:function(a){this.initPaginator(a);this.project=a.project;this.term=a.term}});var StatsUserCollection=PaginatedCollection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/user.json"}},initialize:function(a){this.initPaginator(a);this.project=a.project}});var StatsUserAnnotationCollection=PaginatedCollection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/userannotations.json"}},initialize:function(a){this.initPaginator(a);this.project=a.project}});var StatsTermSlideCollection=PaginatedCollection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/termslide.json"}},initialize:function(a){this.initPaginator(a);this.project=a.project}});var StatsUserSlideCollection=PaginatedCollection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/userslide.json"}},initialize:function(a){this.initPaginator(a);this.project=a.project}});var StatsAnnotationEvolutionCollection=PaginatedCollection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/stats/annotationevolution.json?daysRange="+this.daysRange+"&term="+this.term}},initialize:function(a){this.initPaginator(a);this.project=a.project;this.daysRange=a.daysRange;this.term=a.term}});var CommandModel=Backbone.Model.extend({url:function(){var a="api/command";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var CommandHistoryCollection=PaginatedCollection.extend({model:CommandModel,url:function(){var a="?";if(this.user){a=a+"&user="+this.user}if(this.fullData){a=a+"&fullData="+this.fullData}if(this.project!=undefined){return"api/project/"+this.project+"/commandhistory.json"+a}else{return"api/commandhistory.json"+a}},initialize:function(a){this.initPaginator(a);if(!a){return}if(a.project!=undefined){this.project=a.project}if(a.user!=undefined){this.user=a.user}if(a.fullData!=undefined){this.fullData=a.fullData}}});CommandHistoryCollection.comparator=function(a){return a.get("created")};var RelationTermModel=Backbone.Model.extend({url:function(){if(this.term!=undefined){return"api/relation/term/"+this.term+".json"}else{if(this.relation!=undefined&&this.term1!=undefined&&this.term2!=undefined){return"api/relation/"+this.relation+"/term1/"+this.term1+"/term2/"+this.term2+".json"}else{if(this.relation==undefined&&this.term1==undefined&&this.term2==undefined){return"api/relation/parent/term.json"}else{if(this.term1==undefined&&this.term2==undefined){return"api/relation/"+this.relation+"/term.json"}else{return"api/relation/parent/term1/"+this.term1+"/term2/"+this.term2+".json"}}}}},initialize:function(a){this.relation=a.relation;this.term=a.term;this.term1=a.term1;this.term2=a.term2}});var RelationTermCollection=PaginatedCollection.extend({model:RelationTermModel,url:function(){if(this.term!=undefined){return"api/relation/term/"+this.term+".json"}else{return"api/relation/"+this.relation+"/term.json"}},initialize:function(a){this.initPaginator(a);this.relation=a.relation;this.term=a.term}});var SecRoleModel=Backbone.Model.extend({url:function(){var a="api/role";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var SecRoleCollection=PaginatedCollection.extend({model:SecRoleModel,url:function(){return"api/role.json"}});var SuggestedAnnotationTermModel=Backbone.Model.extend({url:function(){return"api/annotation/term/suggest.json"}});var SuggestedAnnotationTermCollection=PaginatedCollection.extend({model:SuggestedAnnotationTermModel,url:function(){return"api/project/"+this.project+"/annotation/term/suggest.json?max="+this.max},initialize:function(a){this.initPaginator(a);this.project=a.project;this.max=a.max},comparator:function(a){return -Number(a.get("rate"))}});var SuggestedTermCollection=PaginatedCollection.extend({model:SuggestedAnnotationTermModel,url:function(){return"api/project/"+this.project+"/term/suggest.json"},initialize:function(a){this.initPaginator(a);this.project=a.project},comparator:function(a){return -Number(a.get("rate"))}});var JobModel=Backbone.Model.extend({url:function(){var a="api/job";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},initialize:function(a){this.project=a.project;this.software=a.software;this.light=a.light;this.max=a.max},executeUrl:function(){return"/api/job/"+this.id+"/execute"},previewUrl:function(){return"/api/job/"+this.id+"/preview"},previewRoiUrl:function(){return"/api/job/"+this.id+"/preview_roi"},isNotLaunch:function(){return(this.get("status")==0)},isInQueue:function(){return(this.get("status")==1)},isRunning:function(){return(this.get("status")==2)},isSuccess:function(){return(this.get("status")==3)},isFailed:function(){return(this.get("status")==4)},isIndeterminate:function(){return(this.get("status")==5)},isWait:function(){return(this.get("status")==6)},isPreviewed:function(){return(this.get("status")==7)}});var JobCollection=PaginatedCollection.extend({model:JobModel,url:function(){var a=[];if(this.project){a.push("project="+this.project)}if(this.software){a.push("software="+this.software)}if(this.light){a.push("light="+this.light)}return"api/job.json?"+a.join("&")},initialize:function(a){this.initPaginator(a);this.project=a.project;this.software=a.software;this.light=a.light},comparator:function(a){return -a.get("id")}});var JobDataModel=Backbone.Model.extend({url:function(){var a="api/jobdata";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var JobDataCollection=PaginatedCollection.extend({model:JobDataModel,url:function(){if(this.task==null||this.task==undefined){return"api/job/"+this.job+"/jobdata.json"}else{return"api/job/"+this.job+"/jobdata.json?task="+this.task}},initialize:function(a){this.initPaginator(a);this.job=a.job;this.task=a.task}});var JobDataStatsModel=Backbone.Model.extend({url:function(){console.log("task="+this.task);if(this.task==null||this.task==undefined){return"api/job/"+this.id+"/alldata.json"}else{return"api/job/"+this.id+"/alldata.json?task="+this.task}},initialize:function(a){this.id=a.id;this.task=a.task}});var JobDataClearModel=Backbone.Model.extend({url:function(){console.log("task="+this.task);if(this.task==null||this.task==undefined){return"api/project/"+this.id+"/job/purge.json"}else{return"api/project/"+this.id+"/job/purge.json?task="+this.task}},initialize:function(a){this.id=a.id;this.task=a.task}});var SoftwareModel=Backbone.Model.extend({url:function(){var a="api/software";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var SoftwareCollection=PaginatedCollection.extend({model:SoftwareModel,CLASS_NAME:"be.cytomine.processing.Software",url:function(){if(this.project!=null){return"api/project/"+this.project+"/software.json"}else{return"api/software.json"}},initialize:function(a){this.initPaginator(a);if(!a){return}this.project=a.project},comparator:function(a){return a.get("name")}});var SoftwareParameterModelCollection=PaginatedCollection.extend({model:SoftwareModel,sortAttribut:null,url:function(){if(this.uri!=null&&this.uri!=undefined){return this.uri}},initialize:function(a){this.initPaginator(a);if(!a){return}this.uri=a.uri;this.sortAttribut=a.sortAttribut;console.log(this)},comparator:function(a){if(this.sortAttribut!=null&&this.sortAttribut!=undefined){return a.get(this.sortAttribut)}else{return a.get("id")}}});var SoftwareProjectModel=Backbone.Model.extend({url:function(){var a="api/softwareproject";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var SoftwareProjectCollection=PaginatedCollection.extend({model:SoftwareProjectModel,url:function(){if(this.project!=null){return"api/project/"+this.project+"/softwareproject.json"}else{return"api/softwareproject.json"}},initialize:function(a){if(!a){return}this.initPaginator(a);this.project=a.project}});var PingModel=Backbone.Model.extend({url:function(){var a="server/ping";var b=".json";return a+b}});var TaskModel=Backbone.Model.extend({url:function(){var b="api/task";var c=".json";if(this.isNew()){a=b+c}else{var a=b+(b.charAt(b.length-1)=="/"?"":"/")+this.id+c}a=a+"?";if(this.project){a=a+"&project="+this.project}if(this.printInActivity){a=a+"&printInActivity="+this.printInActivity}return a},initialize:function(a){this.project=a.project;this.printInActivity=a.printInActivity}});var TaskCommentsCollection=PaginatedCollection.extend({model:TaskModel,url:function(){return"api/project/"+this.project+"/task/comment.json"},initialize:function(a){this.initPaginator(a);if(a!=undefined){this.project=a.project}},comparator:function(a){return -a.get("timestamp")}});var StorageModel=Backbone.Model.extend({url:function(){var a="api/storage";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var StorageCollection=PaginatedCollection.extend({model:StorageModel,url:function(){return"api/storage.json"},initialize:function(a){this.initPaginator(a)},comparator:function(a){return a.get("name")}});var AnnotationPropertyModel=Backbone.Model.extend({initialize:function(a){this.idAnnotation=a.idAnnotation},url:function(){var a="api/annotation/"+this.idAnnotation+"/property";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},parse:function(a,b){console.log("parse "+a.property);if(a.property){return a.property}else{return a}}});var AnnotationPropertyCollection=PaginatedCollection.extend({model:AnnotationPropertyModel,initialize:function(a){this.initPaginator(a);this.idAnnotation=a.idAnnotation},url:function(){if(this.idAnnotation!=undefined){return"api/annotation/"+this.idAnnotation+"/property.json"}}});var AnnotationPropertyKeysCollection=PaginatedCollection.extend({initialize:function(a){this.initPaginator(a);this.idProject=a.idProject;this.idImage=a.idImage},url:function(){if(this.idProject!=undefined){return"/api/annotation/property/key.json?idProject="+this.idProject}else{if(this.idImage!=undefined){return"/api/annotation/property/key.json?idImage="+this.idImage}}}});var AnnotationPropertyTextCollection=PaginatedCollection.extend({initialize:function(a){this.initPaginator(a);this.idUser=a.idUser;this.idImage=a.idImage;this.key=a.key},url:function(){if(this.idUser!=undefined&&this.idImage!=undefined){var a="?";if(this.key!=undefined){a=a+"key="+this.key}return"/api/user/"+this.idUser+"/imageinstance/"+this.idImage+"/annotationposition.json"+a}}});var ImageInstancePropertyModel=Backbone.Model.extend({initialize:function(a){this.idImageInstance=a.idImageInstance},url:function(){var a="api/imageinstance/"+this.idImageInstance+"/property";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},parse:function(a,b){console.log("parse "+a.property);if(a.property){return a.property}else{return a}}});var ImageInstancePropertyCollection=PaginatedCollection.extend({model:ImageInstancePropertyModel,initialize:function(a){this.initPaginator(a);this.idImageInstance=a.idImageInstance},url:function(){if(this.idImageInstance!=undefined){return"api/imageinstance/"+this.idImageInstance+"/property.json"}}});var ProjectPropertyModel=Backbone.Model.extend({initialize:function(a){this.idProject=a.idProject},url:function(){var a="api/project/"+this.idProject+"/property";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},parse:function(a,b){console.log("parse "+a.property);if(a.property){return a.property}else{return a}}});var ProjectPropertyCollection=PaginatedCollection.extend({model:ProjectPropertyModel,initialize:function(a){this.initPaginator(a);this.idProject=a.idProject},url:function(){if(this.idProject!=undefined){return"api/project/"+this.idProject+"/property.json"}}});var ActivityView=Backbone.View.extend({historyCollection:null,users:null,userJobs:null,usersOnline:null,idProject:null,idUser:null,command:null,initialize:function(a){this.el=a.el;this.page=0},render:function(){console.log("render");var a=this;require(["text!application/templates/activity/ActivityComponent.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var b=this;$(b.el).html(c);var a=$("#activity-content");a.empty();b.createProjectListView()},createProjectListView:function(){$("#projectListActivity").empty();var a=null;$("#projectListActivity").append('<li class="divider"></li>');$("#projectListActivity").append('<li id="projectChoiceActivityALL"><a href="#activity-">ALL PROJECTS</a></li>');$("#projectListActivity").append('<li class="divider"></li>');window.app.models.projects.each(function(c){var b=c.get("name").substr(0,1);if(a!=b){a=b;$("#projectListActivity").append('<li class="nav-header">'+a+"</li>")}$("#projectListActivity").append('<li id="projectChoiceActivity'+c.id+'"><a href="#activity-'+c.id+'-">'+c.get("name")+"</a></li>")})},createProjectHeaderView:function(a){$("#projectHeaderActivity").empty();if(a){$("#projectHeaderActivity").append("<h1>Activity for "+a.get("name")+" </h1>");$("#projectHeaderActivity").append('<br><p><a href="#tabs-dashboard-'+a.id+'" class="btn btn-primary btn-large">Open this project</a></p>');$("#projectHeaderActivity").append('<br><div class="row-fluid" id="onlineUserActivity"></div>')}else{$("#projectHeaderActivity").append("<h1>Activity for All projects</h1>")}},createProjectOnlineUserView:function(){var b=this;console.log("createProjectOnlineUserView");var c=function(){require(["text!application/templates/dashboard/OnlineUser.tpl.html"],function(d){console.log("UserOnlineCollection");new UserOnlineCollection({project:b.model.id}).fetch({success:function(g,f){console.log("collection:"+g.length);$("#onlineUserActivity").empty();g.each(function(i){if(b.users.get(i.id)==undefined){return}var h="";_.each(i.get("position"),function(l){var l=_.template(d,{project:b.model.id,filename:window.app.minString(l.filename,15,10),image:l.image});h+=l});var k=_.template("<div class='span4'><h3><%= user %></h3><ul><%= positions %></ul></div>",{id:i.id,user:b.users.get(i.id).prettyName(),positions:h});$("#onlineUserActivity").append(k)})}})})};c();var a=setInterval(c,5000);$(window).bind("hashchange",function(){clearInterval(a)})},createLastJobPanel:function(){var a=this;require(["text!application/templates/activity/LastJobActivity.tpl.html"],function(b){new JobCollection({project:a.idProject,max:20}).fetch({success:function(d,c){a.jobs=d;$("#jobPanelActivity").empty();a.jobs.each(function(i){var f=i.toJSON();f.created=window.app.convertLongToDate(i.get("created"));var h=new ProjectDashboardAlgos({model:{id:-1}});var g=h.getStatusElement(i,200);$("#jobPanelActivity").append(_.template(b,f));$("#jobActivityStatus"+i.id).append(g)})}})})},refresh:function(h,b){console.log("refresh: "+h+" "+b);var c=this;c.model=h;c.createProjectHeaderView(h);var a=0;var g=0;var d=function(k){g++;if(g<k){return}$("#projectListActivity").find("li").removeClass("active");if(h){$("#projectListActivity").find("li#projectChoiceActivity"+h.id).addClass("active");c.createProjectOnlineUserView()}else{$("#projectListActivity").find("li#projectChoiceActivityALL").addClass("active")}c.createUserSelect(h,b);if(b){$("select#activityUser").val(b)}c.page=0;var i=null;if(c.model){i=c.model.id}new CommandHistoryCollection({project:i,user:b,max:30}).fetch({success:function(m,l){c.historyCollection=m;c.createCommandPanel()}});c.idUser=b;c.idProject=i;c.createLastJobPanel()};a++;c.userJobs=null;if(h!=null&&c.idProject!=h.id){a++;new UserJobCollection({project:c.model.id}).fetch({success:function(k,i){c.userJobs=k;d(a)}})}var f=new UserCollection({project:c.model?c.model.id:null});f.fetch({success:function(k,i){c.users=k;d(a)}})},createUserSelect:function(){var a=this;var b=$("select#activityUser");b.empty();b.show();b.append('<option value="-1" id="-1">All users/jobs</option>');a.users.each(function(c){b.append('<option value="'+c.id+'" id="'+c.id+'">'+c.layerName()+"</option>")});if(a.userJobs){a.userJobs.each(function(c){b.append('<option value="'+c.id+'" id="'+c.id+'">'+c.layerName()+"</option>")})}b.bind("change",function(){if(b.val()==-1){window.location="#activity-"+a.idProject+"-"}else{window.location="#activity-"+a.idProject+"-"+b.val()+"-"}})},createCommandPanel:function(){var b=this;var a=$("#activity-content");a.empty();b.appendCommand(b.historyCollection);$(window).scroll(function(){var c=""+window.location;if(c.search("#activity-")==-1){return}if(b.appendingCommand){return}if(($(window).scrollTop()+50)>=$(document).height()-$(window).height()){b.page++;b.historyCollection.goTo(b.page,{success:function(f,d){b.historyCollection=f;b.appendCommand(b.historyCollection)}})}})},appendCommand:function(b){var a=this;a.appendingCommand=true;if(b.length==0){window.app.view.message("Activity","There is no other activities...","warning");$("#getMoreActivity").replaceWith("")}else{$("#getMoreActivity").replaceWith("");b.each(function(h){var g=window.app.convertLongToDate(h.get("created"));var c=g.substring(0,10);if(a.startDate!=c){a.startDate=c;$(a.el).append('<li class="nav-header">'+a.startDate+"</li>")}var f="";if(a.model==null){f="- "+window.app.models.projects.get(h.get("project")).get("name")}var d=_.template("<li><%=date%> <%=project%>: <%= prefix %> <%= message %></li>",{date:g,prefix:h.get("prefix"),message:h.get("message"),project:f});$(a.el).append(d)});$(a.el).append("<button id='getMoreActivity' class='btn btn-primary'>Get more...</button>");$("#getMoreActivity").click(function(){a.page++;a.historyCollection.goTo(a.page,{success:function(d,c){a.historyCollection=d;a.appendCommand(a.historyCollection)}})})}a.appendingCommand=false},startDate:null});var PhonoMenu=Backbone.View.extend({itemsMenuActivated:["phono-deactivate","phono-call","phono-status","phono-menu-divider"],itemsMenuDeactivated:["phono-activate"],phono:null,sip_cytomine_header:"x-cytomine-id",hangupTimeout:10000,onlineUsers:null,loadUsersInterval:null,render:function(){var a=this;require(["text!application/templates/phono/phonoMenu.tpl.html","text!application/templates/phono/phonoUser.tpl.html"],function(b){$("#menu-right").append(b);a.bindEvents();a.activate();$(document).on("click",".online-user",function(f){f.preventDefault();var c=$(this).attr("data-call-id");var d=a.onlineUsers.get(c);$("#phono-call").attr("disabled",true).val("Busy");console.log("call "+d.get("sipAccount"));a.phono.phone.dial(d.get("sipAccount"),{headers:[{name:a.sip_cytomine_header,value:window.app.status.user.id,data:window.app.status.user.id}],onRing:function(){ringBox=a.message("Info","Ringing...",undefined)},onAnswer:function(){var g="In conversation with <%= firstname %> <%= lastname %>";a.message("Info",_.template(g,d.toJSON()),undefined);if(ringBox){ringBox.remove();ringBox=null}},onHangup:function(){$("#phono-call").attr("disabled",false).val("Call");if(ringBox){ringBox.remove();ringBox=null}if(answerBox){answerBox.remove();answerBox=null}a.message("Info","Hangup",4000)}})})})},loadUsers:function(b){var a=this;new UserFriendCollection({id:window.app.status.user.model.id}).fetch({success:function(d,c){a.onlineUsers=d;$("#online-users").empty();d.each(function(f){$("#online-users").append(_.template(b,f.toJSON()))})}})},bindEvents:function(){var a=this;$("#phono-activate").on("click",function(b){b.preventDefault();a.activate()});$("#phono-deactivate").on("click",function(b){b.preventDefault();a.deactivate()})},deactivate:function(){_.each(this.itemsMenuActivated,function(a){$("#"+a).hide()});_.each(this.itemsMenuDeactivated,function(a){$("#"+a).show()});if(self.phono){self.phono.disconnect()}self.phono=null;clearInterval(self.loadUsersInterval);self.loadUsersInterval=null;this.message("Info","Live chat/call offline",3000)},activate:function(){var d=this.message("Info","Logging in progress...");var b=this;require(["text!application/templates/phono/phonoUser.tpl.html"],function(f){b.loadUsersInterval=setInterval(function(){b.loadUsers(f)},5000)});b.phono=$.phono({apiKey:"96e914764866dfaf87b26b3cc3d23d03",onReady:function(){$("#phono-call").attr("disabled",false).val("Call");window.app.status.user.model.save({sipAccount:"sip:"+this.sessionId},{success:function(g,f){window.app.status.user.model=g;d.remove();b.message("Info","Live chat/call online",2000);_.each(b.itemsMenuDeactivated,function(h){$("#"+h).hide()});_.each(b.itemsMenuActivated,function(h){$("#"+h).show()})}})},phone:{onIncomingCall:function(h){var g=h.call;var i=_.find(g.headers,function(k){return k.name==b.sip_cytomine_header});var f=i.value;new UserModel({id:f}).fetch({success:function(m,k){var l=_.template("<%= user %> is calling you.<br /><a class='btn btn-success' id='answercall-<%=id %>'>Answer</a> <a class='btn btn-warning' id='hangupcall-<%=id %>'>Hangup</a>",{user:m.prettyName(),id:g.id});var n=b.message("Incoming call",l,b.hangupTimeout);$("#answercall-"+g.id).on("click",function(){g.answer();n.remove()});$("#hangupcall-"+g.id).on("click",function(){g.hangup();n.remove()})}})},onError:function(f){b.message("Phone error: ",e.reason,3000)}}});var a=null;var c=null;$("#phono-call").click(function(){})},message:function(h,c,f){var d=new Date().getTime();var b="phono-message"+d;var a='<div style="min-width: 200px;" id="<%= idMessage %>" class="alert alert-info fade in" data-alert="alert"><a class="close" data-dismiss="alert">×</a><p><strong><%=   alert %></strong> <%=   message %></p></div>';var g=($(window).width()/2-100);$("#phono-messages").css("left",g);$("#phono-messages").append(_.template(a,{alert:h,message:c,idMessage:b}));if(f!=undefined){setTimeout(function(){$("#phono-message"+d).remove()},f)}return $("#"+b)}});var AccountDetails=Backbone.View.extend({initialize:function(a){},events:{},render:function(){var a=this;require(["text!application/templates/account/AccountDetails.tpl.html"],function(b){a.doLayout(b)});return this},editProfile:function(){var b=this;var a=new UserModel(this.model.toJSON());a.save({firstname:$("#input_firstname").val(),lastname:$("#input_lastname").val(),email:$("#input_email").val()},{success:function(d,c){b.model=new UserModel(c.user);window.app.view.message("Success",c.message,"success")},error:function(d,c){window.app.view.message("Error",c.message,"error")}})},editPassword:function(){var a=new UserModel(this.model.toJSON());a.save({password:$("#input_new_password").val(),password2:$("#input_new_password").val()},{success:function(c,b){window.app.view.message("Success",b.message,"success");$("#input_new_password").val("");$("#input_new_password_confirm").val("");$("#input_password").val("");$("#input_password").closest(".control-group").removeClass("success");$("#input_new_password").closest(".control-group").removeClass("success");$("#input_new_password_confirm").closest(".control-group").removeClass("success")},error:function(c,b){window.app.view.message("Error",b.message,"error")}})},validatePassword:function(){return $("#input_new_password").val()!=""&&$("#input_new_password_confirm").val()!=""&&($("#input_new_password").val()==$("#input_new_password_confirm").val())},doLayout:function(b){var a=this;$(this.el).html(_.template(b,this.model.toJSON()));$("#edit_profile_form").submit(function(c){a.editProfile();c.preventDefault()});$("#input_new_password_confirm").keyup(function(){$("#input_new_password_confirm").closest(".control-group").removeClass("warning");$("#input_new_password_confirm").closest(".control-group").removeClass("success");$("#input_new_password").closest(".control-group").removeClass("warning");$("#input_new_password").closest(".control-group").removeClass("success");if($(this).val()!=""){if(a.validatePassword()){$("#input_new_password_confirm").closest(".control-group").addClass("success");$("#input_new_password").closest(".control-group").addClass("success");$("#submit_edit_password").removeAttr("disabled")}else{$("#input_new_password_confirm").closest(".control-group").addClass("warning");$("#input_new_password").closest(".control-group").addClass("warning");$("#submit_edit_password").attr("disabled","disabled")}}});$("#input_new_password").keyup(function(){if($(this).val()!=""){$("#input_new_password_confirm").removeAttr("disabled")}else{$("#input_new_password_confirm").attr("disabled","disabled")}});$("#input_password").keyup(function(){console.log("change");var d=$("#input_password").val();var c={j_username:a.model.get("username"),j_password:d};$.ajax({url:"j_spring_security_check",type:"post",dataType:"json",data:c,success:function(f){$("#input_password").closest(".control-group").removeClass("warning");$("#input_password").closest(".control-group").addClass("success");$("#input_new_password").removeAttr("disabled")},error:function(f){$("#input_password").closest(".control-group").removeClass("success");if(d!=""){$("#input_password").closest(".control-group").addClass("warning")}$("#input_new_password").attr("disabled","disabled");$("#submit_edit_password").attr("disabled","disabled")}})});$("#edit_password_form").submit(function(c){if(a.validatePassword()){a.editPassword()}c.preventDefault()});$("#regenerate_keys_form").submit(function(d){var c=new UserModel(a.model.toJSON());c.save({publicKey:"",privateKey:""},{success:function(g,f){window.app.view.message("Success",f.message,"success");a.model=new UserModel(f.user);$("#input_public_key").val(a.model.get("publicKey"));$("#input_private_key").val(a.model.get("privateKey"))},error:function(g,f){window.app.view.message("Error",f.message,"error")}});d.preventDefault()});$("#edit_profile_form").keyup(function(f){var d=$(f.target);console.log("field val :"+d.val());if(d.val()==""){d.closest(".control-group").addClass("warning")}else{d.closest(".control-group").removeClass("warning")}var c=($("#input_firstname").val()!="")&&($("#input_lastname").val()!="")&&($("#input_email").val()!="");if(c){$("#edit_profile_submit").removeAttr("disabled")}else{$("#edit_profile_submit").attr("disabled","disabled")}})}});var LoginDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){new ConfirmDialogView({el:"#dialogs",template:_.template(a,{version:window.app.status.version}),dialogAttr:{dialogID:"#login-confirm",backdrop:false}}).render();$("#j_username").click(function(){$(this).select()});$("#j_password").click(function(){$(this).select()});$("#login-form").submit(window.app.controllers.auth.doLogin);return this},render:function(){var a=this;require(["text!application/templates/auth/LoginDialog.tpl.html"],function(b){a.doLayout(b)})},close:function(){$("#login-form").close()}});var LoadingDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{})}).render()},render:function(){var a=this;require(["text!application/templates/auth/LoadingDialog.tpl.html"],function(b){a.doLayout(b)});return this},initProgressBar:function(){$("#progress").show();$("#login-progressbar").progressbar({value:0})},progress:function(a){$("#login-progressbar").progressbar({value:a})},close:function(){}});var LogoutDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{}),dialogAttr:{dialogID:"#logout-confirm"}}).render();$("#submit-logout").click(function(c){c.preventDefault();window.location="logout"});$("#cancel-logout").click(function(c){c.preventDefault();$("#logout-confirm").modal("hide");$("#logout-confirm").remove()});return this},render:function(){var a=this;require(["text!application/templates/auth/LogoutDialog.tpl.html"],function(b){a.doLayout(b)})}});var MultiSelectView=Backbone.View.extend({collection:null,multiple:null,initialize:function(a){this.el=a.el;this.collection=a.collection;this.multiple=a.multiple},buildMultiSelect:function(){var a=this;a.addHtmlElem()},getHtmlElem:function(){console.log("getHtmlElem");var b=this;var c="";var d=b.getDefaultValue();if(b.param.required){c="border-style: solid; border-width: 2px;"}else{c="border-style: dotted;border-width: 2px;"}var a='<select class="domainList" multiple="multiple">';b.collection.each(function(g){var f="";_.each(d,function(h){if(h==g.id){f='selected="selected"'}});a=a+"<option "+f+' value="'+g.id+'">'+g.get(b.printAttribut)+"</option>"});a=a+"</select>";return a},addHtmlElem:function(){var a=this;console.log("addHtmlElem");a.el.append(a.getHtmlElem());var b=null;if(a.multiple){b=function(f,h,c){var g=[];$(c).each(function(){g.push($(this).attr("title"))});var d=g.join(", ");d=d.substring(0,Math.min(15,d.length));return f+" selected"}}else{b=function(f,h,c){if(f==0){return"0 selected"}var g=[];$(c).each(function(){g.push($(this).attr("title"))});var d=g.join(", ");d=d.substring(0,Math.min(10,d.length));return d}}a.el.find(".domainList").multiselect({autoOpen:false,minWidth:300,height:200,multiple:a.multiple,selectedText:b}).multiselectfilter();a.el.find("button").width("150");a.el.find(".ui-multiselect-menu").find("span").css("display","inline");a.el.find(".ui-multiselect-menu").find("input").css("display","inline");a.el.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").css("display","inline");a.el.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").eq(0).css("float","left");a.el.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").eq(1).css("float","right");a.el.find(".ui-multiselect-menu").find("li").css("display","block");a.el.find("ul.ui-multiselect-checkboxes").css("overflow-y","scroll");a.el.find("ul.ui-multiselect-checkboxes").css("overflow-x","hidden");a.el.find(".domainList").multiselect("close")},checkAll:function(){console.log("checkAll");this.el.find(".domainList").multiselect("checkAll")},uncheckAll:function(){console.log("uncheckAll");this.el.find(".domainList").multiselect("uncheckAll")},isCheckAll:function(){var c=this;var b=c.el.find(".domainList").length;var a=c.el.find(".domainList").multiselect("getChecked").length;console.log("numberOfChoice="+b);console.log("numberOfSelect="+a);return(b==a)}});var AnnotationThumbView=Backbone.View.extend({events:{},initialize:function(a){this.term=a.term;console.log(a);if(a.reviewMode!=undefined){this.reviewMode=a.reviewMode}if(a.size!=undefined){this.size=a.size}else{this.size=100}this.sizeImage=this.size-10;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/dashboard/AnnotationThumb.tpl.html","text!application/templates/dashboard/AnnotationPopOverThumb.tpl.html"],function(k,h){var d=a.model.clone();var i="";if(d.get("rate")!=undefined&&!isNaN(d.get("rate"))){i=Math.round(d.get("rate")*10000)/100+"%"}var f=undefined;console.log("*****"+a.reviewMode);if(a.reviewMode){if(d.get("reviewed")){f="#3fb618"}else{if(d.get("term").length>1){f="#000000"}else{if(d.get("term").length==1){f=window.app.status.currentTermsCollection.get(d.get("term")).get("color")}else{f="#cccccc"}}}}else{if(d.get("idTerm")==d.get("idExpectedTerm")){f="#cccccc"}else{if(d.get("idTerm")!=d.get("idExpectedTerm")){f="#F89406"}}}var c=null;var g=window.app.models.projectUserJob.get(d.get("user"));if(g){c=_.template("#tabs-algos-<%= idProject %>-<%= idSoftware%>-<%= idJob %>",{idProject:window.app.status.currentProject,idSoftware:g.get("idSoftware"),idJob:g.get("idJob")})}if(a.reviewMode){d.set("cropURL",d.get("cropURL")+"?draw=true");d.set("smallCropURL",d.get("smallCropURL")+"&draw=true")}d.set({sameUser:(window.app.status.user.id==d.get("user")),ratePourcent:i,colorStyle:f,jobLink:c,nbComments:d.get("nbComments")!=undefined?d.get("nbComments"):0,sizeImage:a.sizeImage,size:a.size});$(a.el).html(_.template(k,d.toJSON()));$(a.el).attr("data-annotation",d.get("id"));if(a.term!=undefined){$(a.el).attr("data-term",a.term)}$(a.el).attr("data-reviewed",d.get("reviewed"));var l=[];_.each(d.get("userByTerm"),function(p){var o=window.app.status.currentTermsCollection.get(p.term).get("name");var q=[];_.each(p.user,function(r){q.push(window.app.view.getUserNameById(r))});l.push({userName:q.join(" and "),termName:o})});var m=undefined;var b=undefined;if(d.get("idTerm")!=d.get("idExpectedTerm")){m=window.app.status.currentTermsCollection.get(d.get("idTerm")).get("name");b=window.app.status.currentTermsCollection.get(d.get("idExpectedTerm")).get("name")}var n=_.template(h,{created:window.app.convertLongToDate(d.get("created")),userName:window.app.view.getUserNameById(d.get("user")),userByTerm:l,termName:m,expectedTermName:b});$(a.el).popover({html:true,title:"Annotation details",content:n,placement:"right",trigger:"hover"});if(!a.reviewMode){a.initDraggable()}});return this},initDraggable:function(){var a=this;$(a.el).draggable({scroll:true,revert:true,delay:500,opacity:0.35,cursorAt:{top:85,left:90},start:function(c,d){var b=$(a.el).find(".thumb");b.popover("hide")},stop:function(b,c){}})}});var AnnotationView=Backbone.View.extend({tagName:"div",pagination_window:3,nbAnnotation:-1,initialize:function(a){this.page=a.page;this.term=a.term;this.annotations=null;if(this.page==undefined){this.page=0}},render:function(){var a=this;a.model.goTo(this.page,{success:function(c,b){$(a.el).empty();a.model=c;a.nbAnnotation=c.fullSize;a.initPagination();a.appendThumbs(a.page)}});return this},initPagination:function(){var b=this;var a=b.model.getNumberOfPages();if(a<2){return}else{require(["text!application/templates/dashboard/Pagination.tpl.html"],function(f){var n=_.template(f,{term:b.term});$(b.el).append(n);var l=$(b.el).find("#pagination-term-"+b.term).find("ul");var m=(b.page==0)?"prev disabled":"";var h=_.template("<li class='<%= className %>'><a data-page='<%= page %>' href='#'>&larr; Previous</a></li>",{className:m,page:b.page-1});l.append(h);var d=(b.page-b.pagination_window<0)?Math.abs(b.page-b.pagination_window):0;var k=(b.page+b.pagination_window>=a)?Math.abs(b.pagination_window+b.page-a+1):0;for(var g=Math.max(0,b.page-b.pagination_window-k);g<Math.min(a,b.page+b.pagination_window+d+1);g++){var c="term-"+b.term+"-page-"+g;m=(g==b.page)?"active":"";h=_.template("<li class='<%= className %>'><a data-page='<%= page %>' href='#'><%= page %></a></li>",{className:m,linkID:c,page:g});l.append(h)}var m=(b.page==a-1)?"next disabled":"";h=_.template("<li class='<%= className %>'><a data-page='<%= page %>' href='#'>Next &rarr;</a></li>",{className:m,page:b.page+1});l.append(h);l.find("a").click(function(i){i.preventDefault();var o=parseInt($(this).attr("data-page"));if(o>=0&&o<a){b.switchToPage(o)}return false})})}},switchToPage:function(b){var a=this;a.page=b;$(a.el).empty();a.render()},appendThumbs:function(b){var a=this;a.annotations=[];a.model.each(function(c){var d=new AnnotationThumbView({model:c,className:"thumb-wrap",term:a.term}).render();$(a.el).append(d.el);a.annotations.push(c.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()}});var ProjectDashboardView=Backbone.View.extend({tagName:"div",projectElem:"#projectdashboardinfo",maxCommandsView:20,maxSuggestView:30,projectDashboardAnnotations:null,projectDashboardImages:null,rendered:false,initialize:function(a){_.bindAll(this,"render")},events:{},render:function(){var a=this;require(["text!application/templates/dashboard/Dashboard.tpl.html"],function(b){a.doLayout(b);a.rendered=true});return this},doLayout:function(b){var a=this;$(a.el).append(_.template(b,a.model.toJSON()));window.app.controllers.browse.tabs.addDashboard(a);$("#activityTab a").click(function(c){c.preventDefault();$(this).tab("show")});setInterval(function(){if($("#tabs-dashboard-"+a.model.id).hasClass("active")){a.refreshDashboard()}},60000);setInterval(function(){if($("#tabs-dashboard-"+a.model.id).hasClass("active")){a.fetchTasks();a.fetchCommands()}},5000)},refreshImagesThumbs:function(){if(this.projectDashboardImages==null){this.projectDashboardImages=new ProjectDashboardImages({model:this.model})}this.projectDashboardImages.refreshImagesThumbs()},refreshAlgos:function(a,b){console.log("this.projectDashboardAlgos="+this.projectDashboardAlgos);if(this.projectDashboardAlgos==null||this.projectDashboardAlgos==undefined){this.projectDashboardAlgos=new ProjectDashboardAlgos({model:this.model,idSoftware:a,idJob:b}).render()}else{this.projectDashboardAlgos.refresh(a,b)}},refreshConfig:function(){if(this.ProjectDashboardConfig==null){this.ProjectDashboardConfig=new ProjectDashboardConfig({model:this.model})}this.ProjectDashboardConfig.refresh()},refreshReview:function(c,a,b){console.log("DashBoardView.refreshReview user"+a);console.log("New.Image="+c);if(this.projectDashboardReview==null||this.projectDashboardReview.image!=c){this.projectDashboardReview=new DashboardReviewPanel({model:this.model});this.projectDashboardReview.render(c,a,b)}else{this.projectDashboardReview.refresh(c,a,b)}},refreshImagesTable:function(){if(this.projectDashboardImages==null){this.projectDashboardImages=new ProjectDashboardImages({model:this.model})}this.projectDashboardImages.refreshImagesTable()},refreshAnnotations:function(b,c){console.log("ProjectDashboardView.refreshAnnotations="+c);var a=this;if(this.projectDashboardAnnotations==null){this.projectDashboardAnnotations=new ProjectDashboardAnnotations({model:this.model,el:this.el});this.projectDashboardAnnotations.render(function(){a.projectDashboardAnnotations.checkTermsAndUsers(b,c)})}else{this.projectDashboardAnnotations.checkTermsAndUsers(b,c)}},refreshProperties:function(a,b){if(this.projectDashboardProperties==null){this.projectDashboardProperties=new ProjectDashboardProperties({model:this.model,el:this.el,idDomain:a,nameDomain:b});this.projectDashboardProperties.render()}else{this.projectDashboardProperties.refresh(a,b)}},refreshDashboard:function(){var a=this;if(!a.rendered){return}a.model.fetch({success:function(c,b){window.app.status.currentProjectModel=c;a.model=c;a.fetchProjectInfo();a.fetchCommands();a.fetchTasks();a.fetchUsersOnline();if(a.projectStats==null){a.projectStats=new ProjectDashboardStats({model:a.model})}}})},fetchProjectInfo:function(){var a=this;console.log("a");require(["text!application/templates/dashboard/ProjectInfoContent.tpl.html"],function(b){console.log("b");$("#projectInfoPanel").html(_.template(b,a.model.toJSON()));var c=function(f){a.model.set({isClosed:f});a.model.save({},{success:function(h,g){a.model=h;a.refreshDashboard()},error:function(h,g){console.log(g);var i=$.parseJSON(g.responseText);window.app.view.message("Project",i.errors[0],"error")}})};$("#projectInfoPanel").find("#closeProject").click(function(){c(true)});$("#projectInfoPanel").find("#uncloseProject").click(function(){c(false)});a.initClearDataModal();$("#projectInfoPanel").find(".description");console.log("d");console.log("test");console.log(DescriptionModal);DescriptionModal.initDescriptionView(a.model.id,a.model.get("class"),$("#projectInfoPanel").find(".description"),150,function(){var f=$("#projectInfoPanel").find(".description").html();$("#projectInfoPanel").find(".description").empty().append(f.replace(new RegExp("<h.>","g"),"<br>").replace(new RegExp("</h.>","g"),"<br>"))},function(){a.fetchProjectInfo()});$("#projectInfoUserList").empty();var d=[];window.app.models.projectUser.each(function(f){d.push(f.prettyName())})});$("#seeUsersProjectList-"+a.model.id).on("click",function(){new ProjectUsersDialog({model:a.model,el:$("#explorer")}).render()});$("#seeDescriptionProject-"+a.model.id).on("click",function(){new ProjectDescriptionDialog({model:a.model,el:$("#explorer")}).render()})},initClearDataModal:function(){var b=this;var a=function(){new TaskModel({project:b.model.id,printInActivity:true}).save({},{success:function(f,d){console.log(d.task);$("#jobDataClear"+b.model.id).empty();$("#jobDataClear"+b.model.id).append('<div class="alert alert-info"><i class="icon-refresh"/> Loading...Cytomine is deleting all unused data... You can close this windows and check the progress in project dashboard "Last tasks" view  </div>');$("#jobDataClear"+b.model.id).append('<div id="task-'+d.task.id+'"></div>');var g=window.app.view.printTaskEvolution(d.task,$("#jobDataClear"+b.model.id).find("#task-"+d.task.id),1000);new JobDataClearModel({id:b.model.id,task:d.task.id}).fetch({success:function(i,h){console.log("data loaded:"+i.toJSON());clearInterval(g);$("#jobDataClear"+b.model.id).empty();$("#jobDataClear"+b.model.id).append("Clear is done!")},error:function(i,h){clearInterval(g);console.log("error getting job data stat")}})},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Task",g.errors,"error")}})};var c=new CustomModal({idModal:"clearjobdataModal",button:$("#clearjobdata"),header:"Clear unused data",body:'<div class="span3" id="jobDataClear'+b.model.id+'" style="min-width: 600px;">This will drop all data from job that are not reviewed. Are you sure? </div>',width:700,height:200});c.addButtons("dropAllData","Drop all data",true,false,a);c.addButtons("closeHotKeys","Close",false,true);$("#dropAllData").click(function(d){d.preventDefault()})},fetchUsersOnline:function(){var b=this;var c=function(){require(["text!application/templates/dashboard/OnlineUser.tpl.html"],function(d){new UserOnlineCollection({project:b.model.id}).fetch({success:function(g,f){$("#userOnlineItem").empty();g.each(function(i){if(window.app.models.projectUser.get(i.id)==undefined){return}var h="";_.each(i.get("position"),function(l){console.log(l);var m=new ImageModel(l);var l=_.template(d,{project:b.model.id,filename:window.app.minString(m.getVisibleName(window.app.status.currentProjectModel.get("blindMode")),15,10),image:l.image});h+=l});var k=_.template("<div id='onlineUser-<%= id %>'><%= user %><ul><%= positions %></ul></div>",{id:i.id,user:window.app.models.projectUser.get(i.id).prettyName(),positions:h});$("#userOnlineItem").append(k)})}})})};c();var a=setInterval(c,5000);$(window).bind("hashchange",function(){clearInterval(a)})},fetchCommands:function(){var a=this;require(["text!application/templates/dashboard/CommandAnnotation.tpl.html","text!application/templates/dashboard/CommandGeneric.tpl.html","text!application/templates/dashboard/CommandImageInstance.tpl.html"],function(g,b,c){var d=new CommandHistoryCollection({project:a.model.get("id"),max:a.maxCommandsView,fullData:true});var f=function(l,h){$("#lastcommandsitem").empty();if(l.size()==0){var k=_.template("<br /><br /><div class='alert alert-block'>No data to display</div>",{});$("#lastcommandsitem").append(k)}$("#lastcommandsitem").append("<ul></ul>");var i=$("#lastcommandsitem").find("ul");l.each(function(n){var m=a.decodeCommandAction(n,g,b,c);if(m!="undefined"){i.append(m)}})};d.fetch({success:function(i,h){f(i,h)}})})},fetchTasks:function(){var a=this;var b=new TaskCommentsCollection({project:a.model.get("id"),max:10});var c=function(h,d){$("#lasttasksitem").empty();if(h.size()==0){var g=_.template("<br /><br /><div class='alert alert-block'>No data to display</div>",{});$("#lasttasksitem").append(g)}$("#lasttasksitem").append("<ul></ul>");var f=$("#lasttasksitem").find("ul");h.each(function(i){var k=new Date();k.setTime(i.get("timestamp"));var l="<i>- <b>"+k.toLocaleDateString()+" "+k.toLocaleTimeString()+"</b> : "+i.get("comment")+"<br></i>";f.append(l)})};b.fetch({success:function(f,d){c(f,d)}})},decodeCommandAction:function(a,f,h,l){var m=this;var c="undefined";var g=$.parseJSON(a.get("data"));var k=new Date();k.setTime(a.get("created"));var b=k.toLocaleDateString()+" "+k.toLocaleTimeString();if(a.get("serviceName")=="userAnnotationService"&&a.get("className")=="be.cytomine.command.AddCommand"){var i="block";var d=g.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.id,idImage:g.image,imageFilename:g.imageFilename,icon:"add.png",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="userAnnotationService"&&a.get("className")=="be.cytomine.command.EditCommand"){var i="";var d=g.newUserAnnotation.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.newUserAnnotation.id,idImage:g.newUserAnnotation.image,imageFilename:g.newUserAnnotation.imageFilename,icon:"delete.gif",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="userAnnotationService"&&a.get("className")=="be.cytomine.command.DeleteCommand"){var i="";var d=g.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.id,idImage:g.image,imageFilename:g.imageFilename,icon:"delete.gif",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="reviewedAnnotationService"&&a.get("className")=="be.cytomine.command.AddCommand"){var i="block";var d=g.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.id,idImage:g.image,imageFilename:g.imageFilename,icon:"add.png",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="reviewedAnnotationService"&&a.get("className")=="be.cytomine.command.EditCommand"){var i="";var d=g.newReviewedAnnotation.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.newReviewedAnnotation.id,idImage:g.newReviewedAnnotation.image,imageFilename:g.newReviewedAnnotation.imageFilename,icon:"delete.gif",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="reviewedAnnotationService"&&a.get("className")=="be.cytomine.command.DeleteCommand"){var i="";var d=g.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.id,idImage:g.image,imageFilename:g.imageFilename,icon:"delete.gif",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="algoAnnotationService"&&a.get("className")=="be.cytomine.command.AddCommand"){var i="block";var d=g.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.id,idImage:g.image,imageFilename:g.imageFilename,icon:"add.png",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="algoAnnotationService"&&a.get("className")=="be.cytomine.command.EditCommand"){var i="";var d=g.newAnnotation.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.newAnnotation.id,idImage:g.newAnnotation.image,imageFilename:g.newAnnotation.imageFilename,icon:"delete.gif",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="algoAnnotationService"&&a.get("className")=="be.cytomine.command.DeleteCommand"){var i="";var d=g.cropURL;c=_.template(f,{idProject:m.model.id,idAnnotation:g.id,idImage:g.image,imageFilename:g.imageFilename,icon:"delete.gif",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="annotationTermService"&&a.get("className")=="be.cytomine.command.AddCommand"){c=_.template(h,{icon:"ui-icon-plus",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,image:""})}else{if(a.get("serviceName")=="annotationTermService"&&a.get("className")=="be.cytomine.command.EditCommand"){c=_.template(h,{icon:"ui-icon-pencil",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,image:""})}else{if(a.get("serviceName")=="annotationTermService"&&a.get("className")=="be.cytomine.command.DeleteCommand"){c=_.template(h,{icon:"ui-icon-trash",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,image:""})}else{if(a.get("serviceName")=="imageInstanceService"&&a.get("className")=="be.cytomine.command.AddCommand"){var i="block";var d=g.thumb;c=_.template(l,{idProject:m.model.id,idImage:g.id,imageFilename:g.filename,icon:"add.png",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="imageInstanceService"&&a.get("className")=="be.cytomine.command.DeleteCommand"){var i="block";var d=g.thumb;c=_.template(l,{idProject:m.model.id,idImage:g.id,imageFilename:g.filename,icon:"delete.gif",text:a.get("prefixAction")+" "+a.get("action"),datestr:b,cropURL:d,cropStyle:i})}else{if(a.get("serviceName")=="jobService"&&a.get("className")=="be.cytomine.command.AddCommand"){c=_.template(h,{icon:"ui-icon-plus",text:a.get("action"),datestr:b,image:""})}}}}}}}}}}}}}}}return c},showImagesThumbs:function(){console.log("#showImagesThumbs");$("#tabs-projectImageThumb"+this.model.id).show();$("#tabs-projectImageListing"+this.model.id).hide();$("#imageThumbs"+this.model.id).attr("disabled","disabled");$("#imageArray"+this.model.id).removeAttr("disabled")},showImagesTable:function(){console.log("#showImagesTable");$("#tabs-projectImageThumb"+this.model.id).hide();$("#tabs-projectImageListing"+this.model.id).show();$("#imageThumbs"+this.model.id).removeAttr("disabled");$("#imageArray"+this.model.id).attr("disabled","disabled")}});var ProjectDashboardStats=Backbone.View.extend({annotationNumberSelectedTerm:-1,initialize:function(){var c=this;this.noDataAlert=_.template("<div class='alert alert-block'>No data to display</div>",{});var a=$("#annotationNumberEvolution");a.empty();a.append('<option value="'+-1+'">All terms</option>');window.app.status.currentTermsCollection.each(function(d){a.append('<option value="'+d.id+'">'+d.get("name")+"</option>")});a.val(c.annotationNumberSelectedTerm);a.unbind();a.change(function(){c.drawAnnotationNumberEvolutionByTermAction()});var b="#tabs-dashboard-"+c.model.get("id");c.drawProjectColumnChart();$('a[href="#_projectColumnChart"]').on("shown",function(d){window.location=b;c.drawProjectColumnChart()});$('a[href="#_projectPieChartPanel"]').on("shown",function(f){window.location=b;var d=new StatsTermCollection({project:c.model.get("id")});d.fetch({success:function(h,g){c.drawPieChart(h,g)}})});$('a[href="#_userAnnotationsChart"]').on("shown",function(d){window.location=b;new StatsUserAnnotationCollection({project:c.model.get("id")}).fetch({success:function(g,f){c.drawUserAnnotationsChart(g,undefined,f)}})});$('a[href="#_userNbAnnotationsChart"]').on("shown",function(d){window.location=b;new StatsUserCollection({project:c.model.get("id")}).fetch({success:function(g,f){c.drawUserNbAnnotationsChart(g,f)}})});$('a[href="#_termSlideAnnotationsChart"]').on("shown",function(d){window.location=b;new StatsTermSlideCollection({project:c.model.get("id")}).fetch({success:function(g,f){c.drawTermSlideChart(g,f)}})});$('a[href="#_userSlideAnnotationsChart"]').on("shown",function(d){window.location=b;new StatsUserSlideCollection({project:c.model.get("id")}).fetch({success:function(g,f){c.drawUserSlideChart(g,f)}})});$('a[href="#_annotationNumberEvolution"]').on("shown",function(d){window.location=b;c.drawAnnotationNumberEvolutionByTermAction()})},getFullWidth:function(){return Math.round($(window).width()-200)},drawProjectColumnChart:function(){var a=this;var b=new StatsTermCollection({project:a.model.get("id")});b.fetch({success:function(d,c){a.drawColumnChart(d,c)}})},drawUserAnnotationsChart:function(l,b,c){var o=this;var g=new google.visualization.DataTable();var m=-1;var h=l.at(0);if(h==undefined){$("#userAnnotationsChart").html(this.noDataAlert);return}g.addColumn("string","Terms");l.each(function(i){m++;if(m!=b&&b!=undefined){return}g.addColumn("number",i.get("key"))});g.addRows(_.size(h.get("terms")));var d=0;_.each(h.get("terms"),function(i){g.setValue(d,0,i.name);d++});m=-1;var f=1;l.each(function(p){m++;if(m!=b&&b!=undefined){return}var i=0;_.each(p.get("terms"),function(q){g.setValue(i,f,q.value);i++});f++});var a=o.getFullWidth();var n=new google.visualization.ColumnChart(document.getElementById("userAnnotationsChart"));n.draw(g,{title:"Term by users",backgroundColor:"white",width:a,height:350,hAxis:{title:"Terms"}});var k=function(){var s=n.getSelection()[0]["row"];var q=n.getSelection()[0]["column"];var i=l.at(q-1).get("id");var r=l.at(q-1).get("terms")[s].id;var p="#tabs-annotations-"+o.model.get("id")+"-"+r+"-"+i;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(p,true);window.app.controllers.browse.tabs.triggerRoute=true};google.visualization.events.addListener(n,"select",k);$(window).bind("resizeEnd",function(p){var i=o.getFullWidth();n.draw(g,{title:"Term by users",backgroundColor:"white",width:i,height:350,hAxis:{title:"Terms"}})})},drawUserNbAnnotationsChart:function(h,c){var k=this;$("#userNbAnnotationsChart").empty();var a=false;var f=new google.visualization.DataTable();f.addRows(_.size(h));f.addColumn("string","Number");f.addColumn("number",0);var d=0;h.each(function(l){if(l.get("value")>0){a=true}f.setValue(d,0,l.get("key"));f.setValue(d,1,l.get("value"));d++});var b=k.getFullWidth();var i=new google.visualization.ColumnChart(document.getElementById("userNbAnnotationsChart"));i.draw(f,{title:"",legend:"none",width:b,height:350,backgroundColor:"white",vAxis:{title:"Number of annotations"},hAxis:{title:"Users"}});var g=function(){var n=i.getSelection()[0]["row"];var m=i.getSelection()[0]["column"];var l=f.getValue(n,0);h.each(function(q){if(q.get("key")==l){var o=q.get("id");var p="#tabs-annotations-"+k.model.get("id")+"-all-"+o;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(p,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(i,"select",g);$("#userNbAnnotationsChart").show();$(window).bind("resizeEnd",function(m){var l=k.getFullWidth();i.draw(f,{title:"",legend:"none",width:l,height:350,backgroundColor:"white",vAxis:{title:"Number of annotations"},hAxis:{title:"Users"}})})},drawPieChart:function(h,c){if(this.model.get("numberOfAnnotations")==0){$("#projectPieChart").html(this.noDataAlert);return}$("#projectPieChart").empty();var l=this;var d=new google.visualization.DataTable();d.addColumn("string","Term");d.addColumn("number","Number of annotations");d.addRows(_.size(h));var f=0;var a=[];h.each(function(i){a.push(i.get("color"));d.setValue(f,0,i.get("key"));d.setValue(f,1,i.get("value"));f++});var b=l.getFullWidth();var k=new google.visualization.PieChart(document.getElementById("projectPieChart"));k.draw(d,{width:b,height:350,title:"",backgroundColor:"white",colors:a});var g=function(){var n=k.getSelection()[0]["row"];var m=k.getSelection()[0]["column"];var i=d.getValue(n,0);h.each(function(q){if(q.get("key")==i){var p=q.get("id");var o="#tabs-annotations-"+l.model.get("id")+"-"+p+"-all";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(o,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(k,"select",g);$(window).bind("resizeEnd",function(m){var i=l.getFullWidth();k.draw(d,{width:i,height:350,title:"",backgroundColor:"white",colors:a})})},drawColumnChart:function(i,d){var l=this;var b=false;var g=new google.visualization.DataTable();g.addRows(_.size(i));g.addColumn("string","Number");g.addColumn("number",0);var a=[];var f=0;i.each(function(m){a.push(m.get("color"));if(m.get("value")>0){b=true}g.setValue(f,0,m.get("key"));g.setValue(f,1,m.get("value"));f++});var c=l.getFullWidth();$("#projectColumnChart").empty();var k=new google.visualization.ColumnChart(document.getElementById("projectColumnChart"));k.draw(g,{title:"",legend:"none",backgroundColor:"white",width:c,height:350,vAxis:{title:"Number of annotations"},hAxis:{title:"Terms"}});var h=function(){var o=k.getSelection()[0]["row"];var n=k.getSelection()[0]["column"];var m=g.getValue(o,0);i.each(function(r){if(r.get("key")==m){var q=r.get("id");var p="#tabs-annotations-"+l.model.get("id")+"-"+q+"-all";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(p,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(k,"select",h);$("#projectColumnChart").show();$(window).bind("resizeEnd",function(n){var m=l.getFullWidth();k.draw(g,{title:"",legend:"none",backgroundColor:"white",width:m,height:350,vAxis:{title:"Number of annotations"},hAxis:{title:"Terms"}})})},drawTermSlideChart:function(i,d){var l=this;var b=false;var g=new google.visualization.DataTable();g.addRows(_.size(i));g.addColumn("string","Term");g.addColumn("number",0);var a=[];var f=0;i.each(function(m){g.setValue(f,0,m.get("key"));g.setValue(f,1,m.get("value"));f++});var c=l.getFullWidth();var k=new google.visualization.ColumnChart(document.getElementById("termSlideAnnotationsChart"));k.draw(g,{title:"",legend:"none",backgroundColor:"white",width:c,height:350,vAxis:{title:"Slides"},hAxis:{title:"Terms"}});var h=function(){var o=k.getSelection()[0]["row"];var n=k.getSelection()[0]["column"];var m=g.getValue(o,0);i.each(function(r){if(r.get("key")==m){var q=r.get("id");var p="#tabs-annotations-"+l.model.get("id")+"-"+q+"-all";window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(p,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(k,"select",h);$(window).bind("resizeEnd",function(n){var m=l.getFullWidth();k.draw(g,{title:"",legend:"none",backgroundColor:"white",width:m,height:350,vAxis:{title:"Slides"},hAxis:{title:"Terms"}})})},drawUserSlideChart:function(h,c){var k=this;var f=new google.visualization.DataTable();f.addRows(_.size(h));f.addColumn("string","User");f.addColumn("number",0);var a=[];var d=0;h.each(function(l){f.setValue(d,0,l.get("key"));f.setValue(d,1,l.get("value"));d++});var b=k.getFullWidth();var i=new google.visualization.ColumnChart(document.getElementById("userSlideAnnotationsChart"));i.draw(f,{title:"",legend:"none",backgroundColor:"white",enableInteractivity:true,width:b,height:350,vAxis:{title:"Slides"},hAxis:{title:"Users"}});var g=function(){var n=i.getSelection()[0]["row"];var m=i.getSelection()[0]["column"];var l=f.getValue(n,0);h.each(function(q){if(q.get("key")==l){var o=q.get("id");var p="#tabs-annotations-"+k.model.get("id")+"-all-"+o;window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(p,true);window.app.controllers.browse.tabs.triggerRoute=true}})};google.visualization.events.addListener(i,"select",g);$(window).bind("resizeEnd",function(m){var l=k.getFullWidth();i.draw(f,{title:"",legend:"none",backgroundColor:"white",enableInteractivity:true,width:l,height:350,vAxis:{title:"Slides"},hAxis:{title:"Users"}})})},drawAnnotationNumberEvolutionByTermAction:function(){var b=this;var a=$("#annotationNumberEvolution").val();b.annotationNumberSelectedTerm=a;new StatsAnnotationEvolutionCollection({project:b.model.get("id"),daysRange:7,term:a}).fetch({success:function(d,c){b.drawAnnotationNumberEvolutionChart(d,c)}})},drawAnnotationNumberEvolutionChart:function(h,b){var a=this;if(h==undefined){$(a.el).find("#annotationNumberEvolutionLineChartByTerm").text("No data for this term!");return}$(a.el).find("#annotationNumberEvolutionLineChartByTerm").empty();var g=new google.visualization.DataTable();g.addColumn("date","Date");g.addColumn("number","Number of annotations");var d=new Date();d.setTime(this.model.get("created"));var c=0;h.each(function(k){var i=new Date();i.setTime(k.get("date"));g.addRow([i,k.get("size")]);c++});var f=new google.visualization.AreaChart(document.getElementById("annotationsEvolutionChart"));f.draw(g,{title:"",width:a.getFullWidth(),height:350,vAxis:{title:"Number of annotations",minValue:0,maxValue:100},hAxis:{title:"Time"},backgroundColor:"white",lineWidth:1,legend:{position:"none"}})}});var ProjectDashboardImages=Backbone.View.extend({imagesView:null,imagesTabsView:null,refreshImagesThumbs:function(){console.log("refreshImagesThumbs");if(this.imagesView==null){this.imagesView=new ImageView({page:0,model:new ImageInstanceCollection({project:this.model.get("id")}),el:$("#tabs-projectImageThumb"+this.model.get("id")),container:window.app.view.components.warehouse}).render()}else{this.imagesView.refresh()}},refreshImagesTable:function(){console.log("refreshImagesTable");if(this.imagesTabsView==null){console.log(this.imagesTabsView);this.imagesTabsView=new ImageTabsView({model:new ImageInstanceCollection({project:this.model.get("id")}),el:$("#tabs-projectImageListing"+this.model.get("id")),container:window.app.view.components.warehouse,idProject:this.model.id}).render()}else{console.log("this.imagesTabsView.refresh()");this.imagesTabsView.refresh()}}});var ProjectDashboardAnnotations=Backbone.View.extend({tabsAnnotation:null,annotationsViews:[],selectedTerm:[],selectedUsers:[],selectedImages:[],selectedJobs:[],allImages:0,allUsers:0,terms:null,ontology:null,shouldRefresh:true,render:function(b){console.log("ProjectDashboardAnnotations.selectedUsers="+this.selectedUsers);console.log("ProjectDashboardAnnotations.selectedJobs="+this.selectedJobs);var a=this;new UserJobCollection({project:window.app.status.currentProject,tree:true}).fetch({success:function(d,c){window.app.models.projectUserJobTree=d;require(["text!application/templates/dashboard/TermTab.tpl.html","text!application/templates/dashboard/TermTabContent.tpl.html"],function(f,g){a.doLayout(f,g,b)})}})},doLayout:function(a,c,d){var b=this;this.jobTreeLoaded=false;this.userTreeLoaded=false;b.ontology=window.app.status.currentOntologyModel;$(b.el).find("input.allAnnotationsCheckbox,input.onlyReviewedAnnotationsCheckbox").change(function(){b.refreshSelectedTermsWithUserFilter()});$(b.el).find("input.undefinedAnnotationsCheckbox").change(function(){if($(this).is(":checked")){b.refreshAnnotations(-1,b.selectedUsers,b.selectedJobs,b.selectedImages);b.selectedTerm.push(-1);$("#tabsterm-panel-"+b.model.id+"--1").show()}else{$("#tabsterm-panel-"+b.model.id+"--1").hide();b.selectedTerm=_.without(b.selectedTerm,-1)}b.updateContentVisibility();b.updateDownloadLinks()});$(b.el).find("input.multipleAnnotationsCheckbox").change(function(){if($(this).is(":checked")){b.refreshAnnotations(-2,b.selectedUsers,b.selectedJobs,b.selectedImages);b.selectedTerm.push(-2);$("#tabsterm-panel-"+b.model.id+"--2").show()}else{$("#tabsterm-panel-"+b.model.id+"--2").hide();b.selectedTerm=_.without(b.selectedTerm,-2)}b.updateContentVisibility();b.updateDownloadLinks()});$(b.el).find("#treeAnnotationListing").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:window.app.status.currentOntologyModel.toJSON(),onSelect:function(f,g){console.log("On select!!!!!");if(g.isSelected()){b.selectedTerm.push(g.data.key);console.log("refresh annotation for term "+g.data.key);b.refreshAnnotations(g.data.key,b.selectedUsers,b.selectedJobs,b.selectedImages);$("#tabsterm-panel-"+b.model.id+"-"+g.data.key).show()}else{$("#tabsterm-panel-"+b.model.id+"-"+g.data.key).hide();b.selectedTerm=_.without(b.selectedTerm,g.data.key)}b.updateContentVisibility();b.updateDownloadLinks()},onDblClick:function(g,f){},initId:"treeData-annotations-"+b.model.get("ontology"),cookieId:"dynatree-Cb-annotations-"+b.model.get("ontology"),idPrefix:"dynatree-Cb-annotations-"+b.model.get("ontology")+"-"});$(b.el).find("#treeAnnotationListing").dynatree("getRoot").visit(function(f){f.expand(true);if(!f.hasChildren()){$(f.span).attr("data-term",f.data.key);$(f.span).attr("class","droppableElem")}});b.initSelectUser();b.initSelectJobs();b.initAnnotationsFilter();$(b.el).find("#uncheckAllTerms").click(function(){b.hideAllTerms()});$(b.el).find("#checkAllTerms").click(function(){b.showAllTerms()});$(b.el).find("#checkAllUsers").click(function(){b.showAllUsers(true)});$(b.el).find("#uncheckAllUsers").click(function(){b.hideAllUsers(true)});$(b.el).find("#checkAllImages").click(function(){b.showAllImages(true)});$(b.el).find("#uncheckAllImages").click(function(){b.hideAllImages(true)});$(b.el).find("#refreshAnnotations").click(function(){b.refreshSelectedTermsWithUserFilter()});b.terms=new TermCollection({idOntology:b.model.get("ontology")}).fetch({success:function(g,f){b.terms=g;window.app.status.currentTermsCollection=g;$("#listtabannotation").append(_.template(c,{project:b.model.id,id:-1,name:"Undefined",className:"noDropZone"}));$("#tabsterm-panel-"+b.model.id+"--1").hide();$("#listtabannotation").append(_.template(c,{project:b.model.id,id:-2,name:"Multiple",className:"noDropZone"}));$("#tabsterm-panel-"+b.model.id+"--2").hide();g.each(function(h){$("#listtabannotation").append(_.template(c,{project:b.model.id,id:h.get("id"),name:h.get("name"),className:"droppableElem"}));$("#tabsterm-panel-"+b.model.id+"-"+h.get("id")).hide()});b.initDropZone();b.loadingCallBack(d)}});new ImageInstanceCollection({project:window.app.status.currentProject,tree:true}).fetch({success:function(g,f){$(b.el).find("#treeImageListing").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:g.toJSON(),onSelect:function(h,i){if(i.isSelected()){b.selectedImages.push(i.data.key);$("#tabsterm-panel-"+b.model.id+"-"+i.data.key).show()}else{$("#tabsterm-panel-"+b.model.id+"-"+i.data.key).hide();b.selectedImages=_.without(b.selectedImages,i.data.key)}if(b.shouldRefresh){b.printAnnotationThumbAllTerms(b.selectedTerm,b.selectedUsers,b.selectedJobs,b.selectedImages)}},onDblClick:function(i,h){},initId:"treeData-images-"+b.model.get("ontology"),cookieId:"dynatree-Cb-images-"+b.model.get("ontology"),idPrefix:"dynatree-Cb-images-"+b.model.get("ontology")+"-"});b.showAllImages();b.loadingCallBack(d)}})},loadingCallBack:function(a){if(this.callbackNbre==undefined){this.callbackNbre=0}this.callbackNbre++;if(this.callbackNbre==2){a.call()}},initAnnotationsFilter:function(){var m=this;var k=$(this.el).find("#annotationFilterSelect");var c=undefined;var f=function(){k.empty();k.attr("disabled","disabled");new AnnotationFilterCollection({project:m.model.id}).fetch({success:function(o,n){c=o;if(_.size(o)>0){$(k).removeAttr("disabled")}o.each(function(r){var q="<option value='<%= id %>'><%= name %></option>";var p=_.template(q,r.toJSON());k.append(p)})},error:function(o,n){}})};f();var a=$(this.el).find("#selectAnnotationFilter");a.click(function(){var o=k.val();if(!o){return}var p=c.get(o);var n="#tabs-annotations-"+m.model.get("id")+"-"+p.get("terms")+"-"+p.get("users");window.app.controllers.browse.tabs.triggerRoute=false;window.app.controllers.browse.navigate(n,true);window.app.controllers.browse.tabs.triggerRoute=true});var d=$(this.el).find("#saveAnnotationFilter");var i=$(this.el).find("#confirmAnnotationFilter");var b=$(this.el).find("#cancelAnnotationFilter");var l=function(){$("#liSaveAnnotationFilter").hide();$("#liConfirmAnnotationFilter").css("display","inline");$("#inputAnnotationFilterName").focus()};var h=function(){$("#liSaveAnnotationFilter").css("display","inline");$("#liConfirmAnnotationFilter").hide()};b.click(function(){h();return});d.click(function(){l();return});i.click(function(){var n=$("#inputAnnotationFilterName").val();if(n==""||n==undefined){window.app.view.message("Error","You have to specify a identifier","error");return}new AnnotationFilterModel().save({name:n,terms:m.selectedTerm,users:m.selectedUsers,project:m.model.id},{success:function(p,o){window.app.view.message("Success",o.message,"success");h();f()},error:function(p,o){window.app.view.message("Error",o.message,"error")}})});var g=$(this.el).find("#deleteAnnotationFilter");g.click(function(){var n=k.val();if(!n){return}new AnnotationFilterModel({id:n}).destroy({success:function(p,o){window.app.view.message("Success",o.message,"success");f()},error:function(p,o){window.app.view.message("Error",o.message,"error")}})})},checkTermsAndUsers:function(c,d){var a=(c!=""&&c!=undefined);var b=(d!=""&&d!=undefined);if(!b&&!a){return}this.hideAllTerms();this.hideAllUsers();if(c=="all"){this.showAllTerms()}else{if(c!=""&&c!=undefined){this.selectTerms(c)}}if(d=="all"){this.showAllUsers()}else{if(d!=""&&d!=undefined){this.selectUsers(d)}}},showAllTerms:function(){$(this.el).find("input.undefinedAnnotationsCheckbox").attr("checked","checked");$(this.el).find("input.undefinedAnnotationsCheckbox").trigger("change");$(this.el).find("input.multipleAnnotationsCheckbox").attr("checked","checked");$(this.el).find("input.multipleAnnotationsCheckbox").trigger("change");this.selectAnnotations(true)},hideAllTerms:function(){$(this.el).find("input.undefinedAnnotationsCheckbox").removeAttr("checked");$(this.el).find("input.undefinedAnnotationsCheckbox").trigger("change");$(this.el).find("input.multipleAnnotationsCheckbox").removeAttr("checked");$(this.el).find("input.multipleAnnotationsCheckbox").trigger("change");this.selectAnnotations(false)},showAllImages:function(b){var a=this;a.allImages=0;if(b){this.shouldRefresh=false}$(this.el).find("#treeImageListing").dynatree("getRoot").visit(function(c){if(!c.data.isFolder){a.allImages++;c.select(true)}});if(b){this.shouldRefresh=true}if(b){a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedJobs,a.selectedImages)}},hideAllImages:function(b){var a=this;if(b){this.shouldRefresh=false}$(this.el).find("#treeImageListing").dynatree("getRoot").visit(function(c){if(!c.data.isFolder){c.select(false)}});if(b){this.shouldRefresh=true}if(b){a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedJobs,a.selectedImages)}},showAllUsers:function(b){var a=this;a.allUsers=0;if(b){this.shouldRefresh=false}$(this.el).find("#treeUserListing").dynatree("getRoot").visit(function(c){if(!c.data.isFolder){a.allUsers++;c.select(true)}});if(b){this.shouldRefresh=true}if(b){a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedJobs,a.selectedImages)}},hideAllUsers:function(b){var a=this;if(b){this.shouldRefresh=false}if(this.userTreeLoaded){$(this.el).find("#treeUserListing").dynatree("getRoot").visit(function(c){if(!c.data.isFolder){c.select(false)}})}if(b){this.shouldRefresh=true}if(b){a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedJobs,a.selectedImages)}},showAllJobs:function(b){var a=this;a.allJobs=0;if(b){this.shouldRefresh=false}$(this.el).find("#treeUserListing").dynatree("getRoot").visit(function(c){if(!c.data.isFolder){a.allJobs++;c.select(true)}});if(b){this.shouldRefresh=true}if(b){a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedJobs,a.selectedImages)}},hideAllJobs:function(b){var a=this;if(b){this.shouldRefresh=false}if(this.jobTreeLoaded){$(this.el).find("#treeJobListing").dynatree("getRoot").visit(function(c){if(!c.data.isFolder){c.select(false)}})}if(b){this.shouldRefresh=true}if(b){a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedJobs,a.selectedImages)}},initDropZone:function(){var b=this;var a=function(g,h){$(this).css("background-color","");var c=$(h.draggable).attr("data-annotation");var f=$(h.draggable).attr("data-term");var d=$(this).attr("data-term");if(f==d){return}$(h.draggable).hide();new AnnotationTermModel({term:d,userannotation:c,clear:true}).save({},{success:function(k,i){$("#tabsterm-"+b.model.id+"-"+d).append($(h.draggable));setTimeout(function(){$(h.draggable).fadeIn("slow")},1000);window.app.view.message(i.message,null,"success")},error:function(k,i){$(h.draggable).show();window.app.view.message(i.message,null,"error")}})};$(".noDropZone").droppable({over:function(c,d){$(this).css("background-color","red")},out:function(){$(this).css("background-color","")},drop:function(){$(this).css("background-color","")}});$(".droppableElem").droppable({over:function(c,d){$(this).css("background-color","lightgreen")},out:function(){$(this).css("background-color","")},drop:a})},initSelectUser:function(){var a=this;var b={id:a.model.id,name:"Users",title:"Users",key:a.model.id,hideCheckbox:true,isFolder:true,children:[]};window.app.models.projectUser.each(function(c){if(window.app.models.userLayer.get(c.id)==undefined){return}b.children.push({id:c.id,key:c.id,name:c.prettyName(),title:c.prettyName(),children:[]})});$(a.el).find("#treeUserListing").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:b,onSelect:function(c,d){if(d.isSelected()){a.hideAllJobs(false);a.selectedUsers.push(d.data.key)}else{a.selectedUsers=_.without(a.selectedUsers,d.data.key)}if(a.shouldRefresh){a.printAnnotationThumbAllTerms(a.selectedTerm,a.selectedUsers,a.selectedJobs,a.selectedImages)}},onDblClick:function(d,c){},initId:"treeData-user-"+a.model.id,cookieId:"dynatree-Cb-user-"+a.model.id,idPrefix:"dynatree-Cb-user-"+a.model.id+"-"});a.userTreeLoaded=true;$(a.el).find("#treeUserListing").dynatree("getRoot").visit(function(c){c.expand(true)});$(a.el).find("#treeUserListing").dynatree("getTree").selectKey(window.app.status.user.id)},initSelectJobs:function(){var b=this;console.log("#########################");console.log("#########################");console.log("#########################");console.log(window.app.models.projectUserJobTree.toJSON());$(b.el).find("#treeJobListing").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:window.app.models.projectUserJobTree.toJSON(),onSelect:function(c,d){if(d.isSelected()){b.hideAllUsers(false);b.selectedJobs.push(d.data.key)}else{b.selectedJobs=_.without(b.selectedJobs,d.data.key)}if(b.shouldRefresh){b.printAnnotationThumbAllTerms(b.selectedTerm,b.selectedUsers,b.selectedJobs,b.selectedImages)}},onDblClick:function(d,c){},initId:"treeData-job-"+b.model.id,cookieId:"dynatree-Cb-job-"+b.model.id,idPrefix:"dynatree-Cbjobs-"+b.model.id+"-"});b.jobTreeLoaded=true;var a=$("#treeJobListing").dynatree("getTree").getNodeByKey(b.model.id);if(a){a.expand(true)}},addTermToTab:function(a,c,b){$("#listtabannotation").append(_.template(c,b))},selectAnnotations:function(b){var a=this;this.terms.each(function(c){$(a.el).find("#treeAnnotationListing").dynatree("getTree").selectKey(c.get("id"),b)})},updateDownloadLinks:function(){var d=this.selectedUsers.join(",");var b=this.selectedTerm.join(",");var a=this.selectedImages.join(",");var c="&users="+d+"&terms="+b+"&images="+a+"&reviewed="+($("input[name=annotationClass]:checked").val()=="inReviewed");$("#downloadAnnotationsCSV").attr("href","/api/project/"+this.model.id+"/annotation/download?format=csv"+c);$("#downloadAnnotationsExcel").attr("href","/api/project/"+this.model.id+"/annotation/download?format=xls"+c);$("#downloadAnnotationsPDF").attr("href","/api/project/"+this.model.id+"/annotation/download?format=pdf"+c)},updateContentVisibility:function(){var d=_.size(this.selectedUsers);var b=_.size(this.selectedTerm);var a=_.size(this.selectedJobs);var c=_.size(this.selectedImages);b+=($(this.el).find("input.undefinedAnnotationsCheckbox").is(":checked"))?1:0;b+=($(this.el).find("input.multipleAnnotationsCheckbox").is(":checked"))?1:0;if(b>0&&c>0&&(d>0||a>0)){$("#listtabannotation").show();$("#downloadAnnotation").show()}else{$("#listtabannotation").hide();$("#downloadAnnotation").hide()}},selectTerms:function(b){b=b.split(",");var a=$(this.el).find("#treeAnnotationListing").dynatree("getTree");_.each(b,function(c){var d=a.getNodeByKey(c);d.select(true)})},selectUsers:function(d){d=d.split(",");var a=$(this.el).find("#treeUserListing").dynatree("getTree");var b=false;_.each(d,function(f){var g=a.getNodeByKey(f);if(g!=undefined){f=true;g.select(true)}});if(!b){var c=$(this.el).find("#treeJobListing").dynatree("getTree");_.each(d,function(f){var g=c.getNodeByKey(f);if(g!=undefined){g.select(true);g.getParent().expand(true)}})}},refreshSelectedTermsWithUserFilter:function(){var d=this;var f=d.selectedUsers;var c=d.selectedImages;var b=d.selectedJobs;var a=$(this.el).find("#treeAnnotationListing").dynatree("getRoot");if(!_.isFunction(a.visit)){return}a.visit(function(g){if(!g.isSelected()){return}d.refreshAnnotations(g.data.key,f,b,c)});if($(this.el).find("input.undefinedAnnotationsCheckbox").is(":checked")){d.refreshAnnotations(-1,f,b,c)}if($(this.el).find("input.multipleAnnotationsCheckbox").is(":checked")){d.refreshAnnotations(-2,f,b,c)}d.updateContentVisibility();d.updateDownloadLinks()},refreshAnnotations:function(c,d,b,a){console.log("refreshAnnotations");this.printAnnotationThumb(c,"#tabsterm-"+this.model.id+"-"+c,d,b,a)},clearAnnotations:function(b){console.log("clearAnnotations");var a=this;$("#tabsterm-"+a.model.id+"-"+b).empty()},printAnnotationThumbAllTerms:function(f,g,b,a){var c=this;c.updateContentVisibility();c.updateDownloadLinks();if(_.size(g)==0&&_.size(b)==0){return}for(var d=0;d<f.length;d++){c.printAnnotationThumb(f[d],"#tabsterm-"+c.model.id+"-"+f[d],g,b,a)}},printAnnotationThumb:function(d,c,b,g,m){var o=this;console.log("printAnnotationThumb");var i=undefined;if(o.allImages!=o.selectedImages.length){i=m}var k=undefined;if(o.allUsers!=b.length){k=b}k=_.union(b,g);$(c).parent().find("h4").append('<div class="alert alert-info"><i class="icon-refresh" /> Loading...</div>');var a=$("input[name=annotationClass]:checked").val();var f=a=="inReviewed";var n=(d==-1?true:undefined);var h=(d==-2?true:undefined);d=(d!=-1&&d!=-2?d:undefined);var l=new AnnotationCollection({project:o.model.id,term:d,noTerm:n,multipleTerm:h,users:k,images:i,reviewed:f,max:30});$(c).empty();o.annotationsViews[d]=new AnnotationView({page:undefined,model:l,term:d,el:$(c)}).render();$(c).parent().find("h4").find(".alert").replaceWith("")}});var ProjectDashboardAlgos=Backbone.View.extend({rendered:false,jobCollection:null,softwares:null,disableSelect:false,software:null,jobSelectView:undefined,jobsLight:null,initialize:function(a){if(this.model){this.el="#tabs-algos-"+this.model.id}this.idJob=a.idJob;this.idSoftware=a.idSoftware;this.software=a.software},render:function(){var a=this;require(["text!application/templates/processing/SoftwareInfo.tpl.html"],function(b){a.doLayout(b);this.rendered=true});return this},doLayout:function(b){var a=this;$(this.el).empty();$(this.el).append(_.template(b,{}));console.log("SoftwareCollection.fetch");new SoftwareCollection({project:a.model.id}).fetch({success:function(f,c){console.log("succes!");if(f.length==0){$(a.el).empty();$(a.el).append('<div class="alert alert-info" style="width : 50%; margin:auto; margin-top : 30px;">No software available for this project</div>');return}if(a.idSoftware==undefined){var d=f.last();a.idSoftware=d.id;window.location="#tabs-algos-"+a.model.id+"-"+a.idSoftware+"-"}a.software=f.get(a.idSoftware);a.softwares=f;a.initProjectSoftwareList();a.printProjectSoftwareInfo();a.printSoftwareButton();new JobCollection({project:a.model.id,software:a.idSoftware,light:true}).fetch({success:function(h,g){a.jobsLight=h;a.printComparatorLaunch();a.fillJobSelectView()}})}});return this},refresh:function(){if(!this.rendered){this.render()}if(this.softwares==null){return}this.software=this.softwares.get(this.idSoftware);this.printProjectSoftwareInfo()},refresh:function(a,b){if(!this.softwares||this.softwares.length<1){return}this.idJob=b;if(a==undefined){a=this.idSoftware}this.software=this.softwares.get(a);if(a!=this.idSoftware){this.idSoftware=a;console.log("Change software");this.changeSoftware()}else{this.idSoftware=a}this.printProjectSoftwareInfo()},initProjectSoftwareList:function(){var a=this;a.softwares.each(function(b){$("#projectSoftwareListUl").append('<li id="consultSoftware-'+b.id+'"><a href="#tabs-algos-'+a.model.id+"-"+b.id+'-">'+b.get("name")+"</a></li>");$("#projectSoftwareListUl").children().removeClass("active");if(b.id==a.idSoftware){$("#consultSoftware-"+b.id).addClass("active")}})},changeSoftware:function(){var a=this;a.idJob=undefined;a.softwares.each(function(b){$("#consultSoftware-"+b.id).removeClass("active")});$("#consultSoftware-"+a.software.id).addClass("active");$("#selectRunParamsTable").find("tbody").empty();$("#panelJobResultsDiv").empty();a.fillJobSelectView();a.printSoftwareButton()},printProjectSoftwareInfo:function(){var a=this;console.log("printProjectSoftwareInfo1");a.printProjectSoftwareDetails();console.log("printProjectSoftwareInfo2");a.printProjectJobInfo()},changeJobSelection:function(b){var a=this;window.location="#tabs-algos-"+a.model.id+"-"+a.idSoftware+"-"+b;if(a.jobSelectView!=undefined){a.jobSelectView.refresh()}},printSoftwareButton:function(){var c=this;var b=new LaunchJobView({software:c.software,project:c.model,el:"#jobComparatorDialogParent",parent:c});var a=new CustomModal({idModal:"launchJobModal",button:$("#softwareLaunchJobButton"),header:"Launch new job",body:"<div id='jobComparatorDialogParent'></div>",width:Math.round($(window).width()-200),height:Math.round($(window).height()-150),callBack:function(){b.render()}});a.addButtons("closeNewJob","Close",false,true);a.addButtons("createNewJob","Create new job",true,true,function(){b.createJobFromParam(b.executeJob)});var d=new CustomModal({idModal:"compareJobModal",button:$("#softwareCompareJobButton"),header:"Compare jobs",body:"<div id='jobComparatorDialogParent'></div>",width:Math.round($(window).width()-200),height:Math.round($(window).height()-200),callBack:function(){c.jobsLight.fetch({success:function(h,g){var f=new JobComparatorView({software:c.software,project:c.model,el:"#jobComparatorDialogParent",parent:c,job1:undefined,job2:undefined,softwares:c.softwares,jobs:h}).render()}})}});d.addButtons("closeCompare","Close",false,true);var d=new CustomModal({idModal:"filterJobModal",button:$("#softwareFilterJobButton"),header:"Filter jobs",body:"<div id='jobFilterDialogParent'></div>",width:Math.round($(window).width()-200),height:Math.round($(window).height()-200),callBack:function(){new JobSearchView({software:c.software,project:c.model,idJob:c.idJob,parent:c,el:"#softwareSearchDialogParent"}).render()}});d.addButtons("closeCompare","Close",false,true)},printComparatorLaunch:function(){var a=this;$(document).on("click","#launchComparator",function(){a.jobsLight.fetch({success:function(c,b){new JobComparatorView({software:a.software,project:a.model,el:$("#jobComparatorDialogParent"),parent:a,jobs:c,job1:c.get(a.idJob),softwares:a.softwares}).render()}})})},printLastNRun:function(){var b=this;var c=function(){new JobCollection({project:b.model.id,software:b.software.id,max:3}).fetch({success:function(g,d){var f=g.models.length>0?g.models[0]:undefined;b.fillNLastRun(g)}})};c();var a=setInterval(c,5000);$(window).bind("hashchange",function(){clearInterval(a)})},printProjectJobInfo:function(){var a=this;if(a.idJob!=undefined){new JobModel({id:a.idJob}).fetch({success:function(c,b){a.fillSelectedJobDetails(c);$("#panelJobDetails").show();$("#panelJobResults").show();var f=$("#panelJobDetails").offset().top;var d=$("html").offset().top;if(!(Math.abs(f)>=Math.abs(d))||!(Math.abs(f)<=Math.abs(d)+$(window).height()-200)){$("html,body").animate({scrollTop:f-50},500)}}})}else{$("#panelJobDetails").hide();$("#panelJobResults").hide()}},printProjectSoftwareDetails:function(){var a=this;new StatsProjectSoftwareModel({project:a.model.id,software:a.software.id}).fetch({success:function(c,b){new SoftwareDetailsView({model:a.software,stats:c,project:a.model,el:$("#softwareDetails")}).render();console.log("printProjectSoftwareDetails OK")}})},fillJobSelectView:function(){var a=this;$("#jobSelection").empty();new JobCollection({project:a.model.id,software:a.software.id,light:true}).fetch({success:function(c,b){a.jobsLight=c;a.jobSelectView=new JobSelectionView({software:a.software,project:a.model,el:$("#jobSelection"),parent:a,jobs:c,comparator:false}).render()}})},fillNLastRun:function(a){var b=this;$("#fullSoftwareDashboard").find("#panelSoftwareLastRunList").empty();var c=0;a.each(function(d){$("#fullSoftwareDashboard").find("#panelSoftwareLastRunList").append('<div style="margin: 0px auto;min-width:100px;max-width:200px" id="'+d.id+'"></div>');b.buildJobInfoElem(d,$("#fullSoftwareDashboard").find("#panelSoftwareLastRunList").find("#"+d.id));c++})},fillSelectedJobDetails:function(d){var b=this;if(d==undefined){$(".selectRunDetails").empty();$("#selectRunParamsTable").find("tbody").empty();$("#panelJobResultsDiv").empty();return}b.idJob=d.id;var c=function(){var g=$("#panelJobDetails").find(".selectRunDetails");new JobModel({id:b.idJob}).fetch({success:function(i,h){g.empty();b.buildJobInfoElem(i,g)}})};c();var a=setInterval(c,5000);$(window).bind("hashchange",function(){clearInterval(a)});var f=$("#selectRunParamsTable").find("tbody").empty();f.empty();b.buildJobParamElem(d,f);b.printJobResult(d)},buildJobInfoElem:function(d,c){var a=this;if(d==undefined){return}var b=$("#panelSoftwareLastRunList").find("#"+d.id).width()-5;require(["text!application/templates/processing/JobInfo.tpl.html"],function(g){var f=d.isSuccess()?"icon-star":"icon-star-empty";d.set({created:window.app.convertLongToDate(d.get("created")),status:a.getStatusElement(d,b),icon:f});var h=$.extend({},{idProject:a.model.id,idSoftware:a.software.id},d.toJSON());c.append(_.template(g,h))})},getStatusElement:function(c,b){var a=this;if(c.isNotLaunch()){return a.getJobLabel("btn-inverse","not launch",b)}else{if(c.isInQueue()){return a.getJobLabel("btn-info","in queue",b)}else{if(c.isRunning()){return a.getJobProgress(c,"active","progress",b)}else{if(c.isSuccess()){return a.getJobLabel("btn-success","success",b)}else{if(c.isFailed()){return a.getJobLabel("btn-danger","failed",b)}else{if(c.isIndeterminate()){return a.getJobLabel("btn-warning","indeterminate",b)}else{if(c.isWait()){return a.getJobProgress(c,"progress-warning","wait ",b)}else{return"no supported"}}}}}}}},getJobLabel:function(b,c,a){return _.template('<span class="badge <%= className %>"><%= text %></span>',{className:b,text:c})},getJobProgress:function(d,c,f,b){var a='<div id="progresstext"> <%= text %></div><div class="progress progress-striped <%= className %>"><div class="bar" style="width : <%= progress %>%;"></div></div>';return _.template(a,{text:f,className:c,progress:d.get("progress")})},buildJobParamElem:function(d,f){var b=this;if(d==undefined){return}var a=$("#selectRunParamsTable").dataTable();console.log("buildJobParamElem="+a);console.log("buildJobParamElem="+$("#selectRunParamsTable").length);a.fnClearTable();var c=$("#selectRunParamsTable").find("tbody");_.each(d.get("jobParameters"),function(g){c.append("<tr><td>"+g.name+'</td><td id="'+g.id+'"><div class="alert alert-info" style="margin-left : 10px;margin-right: 10px;"><i class="icon-refresh" /> Loading...</div></td><td>'+g.type+"</td></tr>");window.app.controllers.dashboard.printJobParameterValue(g,$("#selectRunParamsTable").find("tbody").find("td#"+g.id),100)});$("#selectRunParamsTable").dataTable({sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:5,bLengthChange:false,bDestroy:true,aoColumnDefs:[{sWidth:"40%",aTargets:[0]},{sWidth:"40%",aTargets:[1]},{sWidth:"20%",aTargets:[2]}]})},printJobResult:function(b){if(b==undefined){return}var a=this;if(window.app.status.currentTermsCollection==undefined){new TermCollection({idProject:a.model.id}).fetch({success:function(d,c){window.app.status.currentTermsCollection=d;a.initJobResult(b)}})}else{a.initJobResult(b)}},initJobResult:function(a){$("#panelJobResultsDiv").empty();new JobResultView({model:a,project:this.model,el:$("#panelJobResultsDiv"),jobs:this.jobsLight,software:this.software}).render()}});var ProjectDashboardConfig=Backbone.View.extend({initialize:function(a){this.el="#tabs-config-"+this.model.id;this.rendered=false},render:function(){new ImageFiltersProjectPanel({el:this.el,model:this.model}).render();new SoftwareProjectPanel({el:this.el,model:this.model}).render();new MagicWandConfig({}).render();this.rendered=true},refresh:function(){if(!this.rendered){this.render()}}});var MagicWandConfig=Backbone.View.extend({thresholdKey:null,toleranceKey:null,initialize:function(){this.toleranceKey="mw_tolerance"+window.app.status.currentProject;if(localStorage.getObject(this.toleranceKey)==null){localStorage.setObject(this.toleranceKey,Processing.MagicWand.defaultTolerance)}this.thresholdKey="th_threshold"+window.app.status.currentProject;if(localStorage.getObject(this.thresholdKey)==null){localStorage.setObject(this.thresholdKey,Processing.Threshold.defaultTheshold)}return this},render:function(){this.fillForm();this.initEvents()},initEvents:function(){var a=this;var c=$("#mwToleranceForm");var b=Math.ceil(Math.sqrt(255*255+255*255+255*255));c.on("submit",function(h){h.preventDefault();var f=parseInt($("#input_tolerance").val());if(_.isNumber(f)&&f>=0&&f<b){localStorage.setObject(a.toleranceKey,Math.round(f));var g=_.template("Tolerance value for project <%= name %> is now <%= tolerance %>",{name:window.app.status.currentProjectModel.get("name"),tolerance:f});window.app.view.message("Success",g,"success")}else{window.app.view.message("Error","Tolerance must be an integer between 0 and "+b,"error")}var d=parseInt($("#input_threshold").val());if(_.isNumber(d)&&d>=0&&d<255){localStorage.setObject(a.thresholdKey,Math.round(d));g=_.template("Threshold value for project <%= name %> is now <%= threshold %>",{name:window.app.status.currentProjectModel.get("name"),threshold:d});window.app.view.message("Success",g,"success")}else{window.app.view.message("Error","Threshold must be an integer between 0 and 255","error")}})},fillForm:function(){$("#input_tolerance").val(localStorage.getObject(this.toleranceKey));$("#input_threshold").val(localStorage.getObject(this.thresholdKey))}});var SoftwareProjectPanel=Backbone.View.extend({removeSoftware:function(b){var a=this;new SoftwareProjectModel({id:b}).destroy({success:function(d,c){$(a.el).find("li.software"+b).remove();window.app.view.message("",c.message,"success")},error:function(d,c){}});return false},renderSoftwares:function(){var a=this;var b=$(this.el).find(".softwares");new SoftwareProjectCollection({project:a.model.id}).fetch({success:function(d,c){d.each(function(f){a.renderSoftware(f,b)})}})},renderSoftware:function(c,b){var a=_.template("<li class='software<%= id %>' style='padding-bottom : 3px;'><a class='btn  btn-small btn-danger removeSoftware' data-id='<%= id %>' href='#'><i class='icon-trash icon-white' /> Delete</a> <%= name %></li>",c.toJSON());$(b).append(a)},render:function(){var a=this;var b=$(this.el).find(".softwares");new SoftwareCollection().fetch({success:function(d,c){d.each(function(g){var f=_.template("<option value='<%= id %>'><%= name %></option>",g.toJSON());$(a.el).find("#addSoftware").append(f)});$(a.el).find("#addSoftwareButton").click(function(f){f.preventDefault();new SoftwareProjectModel({project:a.model.id,software:$(a.el).find("#addSoftware").val()}).save({},{success:function(h,g){a.renderSoftware(new SoftwareProjectModel(h.toJSON().softwareproject),b);window.app.view.message("",g.message,"success")},error:function(h,g){window.app.view.message("",$.parseJSON(g.responseText).errors,"error")}});return false})}});a.renderSoftwares();$(document).on("click","a.removeSoftware",function(){var c=$(this).attr("data-id");a.removeSoftware(c);return false});return this}});var ImageFiltersProjectPanel=Backbone.View.extend({removeImageFilter:function(b){var a=this;new ProjectImageFilterModel({id:b}).destroy({success:function(d,c){$(a.el).find("li.imageFilter"+b).remove();window.app.view.message("",c.message,"success")}});return false},renderFilters:function(){var a=this;var b=$(this.el).find(".image-filters");new ProjectImageFilterCollection({project:a.model.id}).fetch({success:function(d,c){d.each(function(f){a.renderImageFilter(f,b)})}})},renderImageFilter:function(c,b){var a=_.template("<li class='imageFilter<%= id %>' style='padding-bottom : 3px;'> <a class='btn  btn-small btn-danger removeImageFilter' data-id='<%= id %>' href='#'><i class=' icon-trash icon-white' /> Delete</a> <%= name %></li>",c.toJSON());$(b).append(a)},render:function(){var a=this;var b=$(this.el).find(".image-filters");new ImageFilterCollection().fetch({success:function(d,c){d.each(function(g){var f=_.template("<option value='<%=  id %>'><%=   name %></option>",g.toJSON());$(a.el).find("#addImageFilter").append(f)});$(a.el).find("#addImageFilterButton").click(function(f){f.preventDefault();new ProjectImageFilterModel({project:a.model.id,imageFilter:$(a.el).find("#addImageFilter").val()}).save({},{success:function(h,g){a.renderImageFilter(new ImageFilterModel(h.toJSON().imagefilterproject),b);window.app.view.message("",g.message,"success")},error:function(g){window.app.view.message("",$.parseJSON(g.responseText).errors,"error")}});return false})}});a.renderFilters();$(document).on("click","a.removeImageFilter",function(){var c=$(this).attr("data-id");a.removeImageFilter(c);return false});return this}});var ProjectDashboardProperties=Backbone.View.extend({annotationPropertyCollection:null,annotationCollection:null,imageInstancePropertyCollection:null,imageInstanceCollection:null,projectPropertyCollection:null,initialize:function(a){this.idDomain=a.idDomain;this.nameDomain=a.nameDomain},render:function(){var a=this;require(["text!application/templates/dashboard/Properties.tpl.html"],function(b){a.doLayout(b)})},refresh:function(b,c){var a=this;if(c!=undefined){a.nameDomain=c}console.log("NAMEDOMAIN : ");console.log(a.nameDomain);if(a.nameDomain!="Project"){a.initIdentifiantSelect(b)}else{$("#identifiantSelect").hide();$("#refreshIdentifiantSelect").hide();$("#infoDisplaySelect").empty();a.refreshProperty();a.initPropertyRowEvents();a.loadAutocomplete()}a.initRadioButton()},doLayout:function(a){var b=this;console.log("doLayout");var c=_.template(a,{id:b.model.id,name:b.model.get("name")});$("#tabs-properties-"+b.model.id).append(c);console.log(b.idDomain);if(b.idDomain!=null){console.log("ICI ????");b.refresh(b.idDomain,b.nameDomain)}$("#buttonAnnotationProperty").click(function(){window.app.controllers.dashboard.navigate("#tabs-annotationproperties-"+window.app.status.currentProject+"-undefined",false);b.refresh(b.idDomain,"Annotation")});$("#buttonImageInstanceProperty").click(function(){window.app.controllers.dashboard.navigate("#tabs-imageproperties-"+window.app.status.currentProject+"-undefined",false);b.refresh(b.idDomain,"ImageInstance")});$("#buttonProjectProperty").click(function(){window.app.controllers.dashboard.navigate("#tabs-projectproperties-"+window.app.status.currentProject+"-undefined",false);b.refresh(b.idDomain,"Project")});$("#refreshIdentifiantSelect").click(function(){console.log("click refresh");b.initIdentifiantSelect()});$("#addProperty").click(function(d){console.log("click button add");d.preventDefault();b.addPropertyTable()});$("#identifiantSelect").click(function(){console.log("click select");b.idDomain=$("#identifiantSelect").val();b.refreshProperty()});$("#deleteProperty").click(function(){console.log("click button delete");b.deleteProperty()});if(!b.nameDomain){$("#buttonAnnotationProperty").click()}},initPropertyRowEvents:function(){var a=this;$(document).on("dblclick","td.propertyKey",function(){var g=$(this).attr("data-id");var c="propertyFormKey"+g;var b;if(a.nameDomain=="Annotation"){b=a.annotationPropertyCollection.get(g)}else{if(a.nameDomain=="ImageInstance"){b=a.imageInstancePropertyCollection.get(g)}else{if(a.nameDomain=="Project"){b=a.projectPropertyCollection.get(g)}}}var d=_.template("<form id='<%= idForm %>'><input value='<%= key %>' type='text' id='input_NewKey'></form>",{key:b.get("key"),idForm:c});$(this).html(d);var f=$(this);$("#"+c).submit(function(){b.save({key:$("#input_NewKey").val()},{success:function(i,h){f.empty();f.html(i.get("key"));return false},error:function(i,h){var k=$.parseJSON(h.responseText);window.app.view.message("Property",k.errors,"error")}})})});$(document).on("dblclick","td.propertyValue",function(){var g=$(this).attr("data-id");var c="propertyFormValue"+g;var b;if(a.nameDomain=="Annotation"){b=a.annotationPropertyCollection.get(g)}else{if(a.nameDomain=="ImageInstance"){b=a.imageInstancePropertyCollection.get(g)}else{if(a.nameDomain=="Project"){b=a.projectPropertyCollection.get(g)}}}var f=$(this);var d=_.template("<form id='<%= idForm %>'><input value='<%= value %>' type='text' id='input_NewValue'></form>",{value:b.get("value"),idForm:c});$(this).html(d);$("#"+c).submit(function(h){h.preventDefault();b.save({value:$("#input_NewValue").val()},{success:function(k,i){f.empty();f.html(k.get("value"));return false},error:function(k,i){var l=$.parseJSON(i.responseText);window.app.view.message("Property",l.errors,"error")}})})})},initIdentifiantSelect:function(c){var b=this;var a=$("#identifiantSelect");a.hide();a.empty();a.attr("disabled","disabled");$("#refreshIdentifiantSelect").hide();var f=_.template("<div class='alert alert-info'><i class='icon-refresh'/> Loading...</div>",{});$("#infoDisplaySelect").empty();$("#infoDisplaySelect").append(f);if(b.nameDomain=="Annotation"){new AnnotationCollection({project:b.model.id}).fetch({success:function(h,g){b.annotationCollection=h;d(h,c)},error:function(h,g){var i=$.parseJSON(g.responseText);window.app.view.message("Annotation Property",i.errors,"error")}})}else{if(b.nameDomain=="ImageInstance"){new ImageInstanceCollection({project:b.model.id}).fetch({success:function(h,g){b.imageInstanceCollection=h;d(h,c)},error:function(h,g){var i=$.parseJSON(g.responseText);window.app.view.message("ImageInstance Property",i.errors,"error")}})}}var d=function(h,i){var g=false;if(_.size(h)>0){$(a).removeAttr("disabled");$("#loadingSelect").hide()}h.each(function(l){var k=window.app.convertLongToDate(l.get("created"));var m=_.template("<option value='<%= id %>'><%= value %> - <%= created %></option>",{id:l.get("id"),value:l.get("id"),created:k});a.append(m);if(l.get("id")==i){g=true}});if(g==true){a.val(i)}else{if(g==false){b.idDomain=undefined}}b.refreshProperty();a.show();$("#refreshIdentifiantSelect").show();$("#infoDisplaySelect").empty();b.initPropertyRowEvents();b.loadAutocomplete()}},refreshProperty:function(){var a=this;if(a.nameDomain=="Annotation"){window.app.controllers.dashboard.navigate("#tabs-annotationproperties-"+window.app.status.currentProject+"-"+a.idDomain,false)}else{if(a.nameDomain=="ImageInstance"){window.app.controllers.dashboard.navigate("#tabs-imageproperties-"+window.app.status.currentProject+"-"+a.idDomain,false)}else{if(a.nameDomain=="Project"){window.app.controllers.dashboard.navigate("#tabs-projectproperties-"+window.app.status.currentProject+"-"+a.idDomain,false)}}}a.initTableProperty()},initRadioButton:function(){var a=this;if(a.nameDomain=="Annotation"){$("#buttonImageInstanceProperty").attr("class","btn btn-primary");$("#buttonProjectProperty").attr("class","btn btn-primary");$("#buttonAnnotationProperty").attr("class","btn btn-primary active")}else{if(a.nameDomain=="ImageInstance"){$("#buttonAnnotationProperty").attr("class","btn btn-primary");$("#buttonProjectProperty").attr("class","btn btn-primary");$("#buttonImageInstanceProperty").attr("class","btn btn-primary active")}else{if(a.nameDomain=="Project"){$("#buttonAnnotationProperty").attr("class","btn btn-primary");$("#buttonImageInstanceProperty").attr("class","btn btn-primary");$("#buttonProjectProperty").attr("class","btn btn-primary active")}}}},initTableProperty:function(){var b=this;var d=$("#identifiantSelect").val();var c=$(this.el).find("#tableProperty");c.empty();var f=_.template("<div class='alert alert-info'><i class='icon-refresh'/> Loading...</div>",{});$("#infoDisplayTable").empty();$("#infoDisplayTable").append(f);if(b.nameDomain=="Annotation"){new AnnotationPropertyCollection({idAnnotation:d}).fetch({success:function(h,g){b.annotationPropertyCollection=h;a(b.annotationPropertyCollection);b.loadImage(d,b.annotationCollection)},error:function(h,g){var i=$.parseJSON(g.responseText);window.app.view.message("Annotation Property",i.errors,"error")}})}else{if(b.nameDomain=="ImageInstance"){new ImageInstancePropertyCollection({idImageInstance:d}).fetch({success:function(h,g){b.imageInstancePropertyCollection=h;a(b.imageInstancePropertyCollection);b.loadImage(d,b.imageInstanceCollection)},error:function(h,g){var i=$.parseJSON(g.responseText);window.app.view.message("ImageInstance Property",i.errors,"error")}})}else{if(b.nameDomain=="Project"){new ProjectPropertyCollection({idProject:window.app.status.currentProject}).fetch({success:function(h,g){b.projectPropertyCollection=h;a(b.projectPropertyCollection);b.loadImage(d,null)},error:function(h,g){var i=$.parseJSON(g.responseText);window.app.view.message("Project Property",i.errors,"error")}})}}}var a=function(h){if(h.size()==0){$("#infoDisplayTable").empty();var g=_.template("<div class='alert alert-block'>No data to display</div>",{});$("#infoDisplayTable").append(g)}else{h.each(function(i){b.drawOption(i)})}}},loadImage:function(c,g){var a=this;var f=$("#loadImageOrText");var d;f.empty();if(a.nameDomain!="Project"){if(a.nameDomain=="Annotation"){d="cropURL"}else{if(a.nameDomain=="ImageInstance"){d="thumb"}}g.each(function(h){if(c==h.get("id")){var i=_.template("<img align='middle' id='imageProperty-<%=id%>' src='<%=image%>?max_size=256' style='max-width :256px; max-height : 256px'>",{id:h.get("id"),image:h.get(d)});f.append(i);f.attr("href","#tabs-image-"+window.app.status.currentProject+"-"+h.get("image")+"-")}})}else{var b=_.template("<p id='textProperty-<%=id%>'><%=name%></p>",{id:window.app.status.currentProject,name:window.app.status.currentProjectModel.get("name")});f.append(b);f.attr("href","#tabs-dashboard-"+window.app.status.currentProject)}},drawOption:function(b){$("#infoDisplayTable").empty();var a=$(this.el).find("#tableProperty");var c=_.template("<tr class='trProperty<%= id %>' id='<%= id %>'><td data-id='<%= id %>' class='propertyKey'><%= key %></td><td data-id='<%= id %>' class='propertyValue'><%= value %></td><td><input type='checkbox'  id='checkbox<%= id %>'></td></tr>",{id:b.get("id"),key:b.get("key"),value:b.get("value")});a.append(c);$("#input_key").val("");$("#input_value").val("")},addPropertyTable:function(){var a=this;if($("#input_key").val()!=""&&$("#input_value").val()!=""){if(a.nameDomain=="Annotation"){new AnnotationPropertyModel({domainIdent:$("#identifiantSelect").val(),key:$("#input_key").val(),value:$("#input_value").val()}).save({domainIdent:$("#identifiantSelect").val(),key:$("#input_key").val(),value:$("#input_value").val()},{success:function(c,b){a.drawOption(c);a.annotationPropertyCollection.add(c);console.log("COLLECTION");console.log(a.annotationPropertyCollection)},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("Annotation Property",d.errors,"error")}})}else{if(a.nameDomain=="ImageInstance"){new ImageInstancePropertyModel({domainIdent:$("#identifiantSelect").val(),key:$("#input_key").val(),value:$("#input_value").val()}).save({domainIdent:$("#identifiantSelect").val(),key:$("#input_key").val(),value:$("#input_value").val()},{success:function(c,b){a.drawOption(c);a.imageInstancePropertyCollection.push(c)},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("ImageInstance Property",d.errors,"error")}})}else{if(a.nameDomain=="Project"){new ProjectPropertyModel({domainIdent:window.app.status.currentProject,key:$("#input_key").val(),value:$("#input_value").val()}).save({domainIdent:window.app.status.currentProject,key:$("#input_key").val(),value:$("#input_value").val()},{success:function(c,b){a.drawOption(c);a.projectPropertyCollection.push(c)},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("Project Property",d.errors,"error")}})}}}}},deleteProperty:function(){var a=this;var c;if(a.nameDomain=="Annotation"){c=a.annotationPropertyCollection}else{if(a.nameDomain=="ImageInstance"){c=a.imageInstancePropertyCollection}else{if(a.nameDomain=="Project"){c=a.projectPropertyCollection}}}var b=[];c.each(function(d){b.push(d.id)});_.each(b,function(d){if($("#checkbox"+d).is(":checked")){c.get(d).destroy({success:function(g,f){window.app.view.message(a.nameDomain+" Property",f.message,"success");$("tr.trProperty"+g.id).empty()},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message(a.nameDomain+" Property",h.errors,"error")}})}})},loadAutocomplete:function(){var a=this;var c=[];var b=null;if(a.nameDomain=="Annotation"){b="annotation"}else{if(a.nameDomain=="ImageInstance"){b="imageinstance"}}console.log("####################");if(b!=null){$.get("/api/"+b+"/property/key.json?idProject="+window.app.status.currentProject,function(d){console.log(d);console.log(d.collection);_.each(d.collection,function(f){console.log(f);c.push(f)});console.log("*************");console.log(c);$("#input_key").typeahead({source:c});console.log("*************")})}else{$("#input_key").typeahead({source:c})}}});var JobListingView=Backbone.View.extend({width:null,software:null,project:null,jobs:null,openParameterGrid:[],parent:null,initialize:function(a){this.software=a.software;this.project=a.project;this.parent=a.parent},render:function(){var a=this;alert("used here!");console.log("trace");require(["text!application/templates/processing/JobListing.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var b=this;var f=_.template(c,{});$(b.el).empty();$(b.el).append(f);var d=($(window).width()-200);var a=($(window).height()-200);$(b.el).dialog({width:d,height:a,modal:true});$("#panelSoftwareInfo").empty();b.printJobListingPanel(b.software,d)},printJobListingPanel:function(software){var self=this;console.log("printJobListingPanel: software="+software.id);$("#jobListDiv").append('<table id="listAlgoInfo" style="margin:0 auto;"></table><div id="pagerAlgoInfo"></div>');var width=$(self.el).width()*0.9;$("#listAlgoInfo").jqGrid({datatype:"local",height:"100%",width:width,colNames:["id","result","running","indeterminate","progress","successful","created"],colModel:[{name:"id",index:"id",width:50,align:"center"},{name:"result",index:"result",width:60,align:"center"},{name:"running",index:"running",width:30,editable:true,edittype:"checkbox",formatter:"checkbox",align:"center"},{name:"indeterminate",index:"indeterminate",width:30,editable:true,edittype:"checkbox",formatter:"checkbox",align:"center"},{name:"progress",index:"progress",width:70,align:"center"},{name:"successful",index:"successful",width:30,editable:true,edittype:"checkbox",formatter:"checkbox",align:"center"},{name:"created",index:"created",width:75,align:"center"}],caption:"Job listing from "+software.get("name")+" for project "+self.project.get("name"),subGrid:true,shrinkToFit:true,pager:$("#pagerAlgoInfo"),sortname:"id",viewrecords:true,sortorder:"desc",subGridRowExpanded:function(subgrid_id,row_id){var idJob=$("#listAlgoInfo").jqGrid("getCell",row_id,1);if(!_.include(self.openParameterGrid,idJob)){self.openParameterGrid.push(idJob)}self.printJobParameter(subgrid_id,row_id,idJob);console.log("openParameterGrid="+self.openParameterGrid)},subGridRowColapsed:function(subgrid_id,row_id){var idJob=$("#listAlgoInfo").jqGrid("getCell",row_id,2);self.openParameterGrid=_.without(self.openParameterGrid,idJob);console.log("openParameterGrid="+self.openParameterGrid)}});var refreshData=function(){new JobCollection({project:self.project.id,software:software.id}).fetch({success:function(jobs,response){self.jobCollection=jobs;var i=0;$("#listAlgoInfo").jqGrid("clearGridData");jobs.each(function(job){var dateStr=self.convertLongToDate(job.get("created"));var buttonStr='<button id="seeResult'+job.id+'">See algo result</button>';var data={id:job.id,result:buttonStr,running:job.get("running"),indeterminate:job.get("indeterminate"),progress:'<div class="progBar">'+job.get("progress")+"</div>",successful:job.get("successful"),software:job.get("software"),created:dateStr};$("#listAlgoInfo").jqGrid("addRowData",i+1,data);$("#seeResult"+job.id).button().click(function(event){event.preventDefault();self.selectJob(job)});i++});$("div.progBar").each(function(index){var progVal=eval($(this).text());$(this).text("");$(this).progressbar({value:progVal})});self.reloadJobParameter();$("#pagerAlgoInfo").find("select").val("10")}})};refreshData();$("#listAlgoInfo").jqGrid("navGrid","#pagerAlgoInfo",{edit:false,add:false,del:false},{},{},{},{multipleSearch:true});$("#pagerAlgoInfo").find("select").val("5")},selectJob:function(b){var a=this;$(this.el).dialog("close");console.log("#tabs-algos-"+a.project.id+"-"+a.software.id+"-"+b.id);console.log(b);console.log(a.parent);a.parent.printProjectJobInfo(b.id)},reloadJobParameter:function(){var a=this;console.log("reloadJobParameter");_.each(a.openParameterGrid,function(b){var c=$("td[title='"+b+"']").prev().find("a");c.click()})},printJobParameter:function(k,f,d){var b=this;console.log("printJobParameter="+k+"|"+f);var a,c;a=k+"_t";c="p_"+a;$("#"+k).html("<table id='"+a+"' class='scroll'></table><div id='"+c+"' class='scroll'></div>");var h=Math.round($(window).width()*0.5);$("#"+a).jqGrid({datatype:"local",colNames:["name","value","type"],colModel:[{name:"name",index:"name",width:100,key:true,sortable:false},{name:"value",index:"value",width:300,sortable:false},{name:"type",index:"type",width:70,sortable:false}],rowNum:20,pager:c,sortname:"name",sortorder:"asc",height:"100%",width:h});$("#"+a).jqGrid("navGrid","#"+c,{edit:false,add:false,del:false});var g=0;$("#"+a).jqGrid("clearGridData");_.each(b.jobCollection.get(d).get("jobParameters"),function(i){var l={name:i.name,value:i.value,type:i.type};$("#"+a).jqGrid("addRowData",g+1,l);g++});$("#"+a).jqGrid("navGrid","#"+c,{edit:false,add:false,del:false});$("#"+a).trigger("reloadGrid")},convertLongToDate:function(f){var b=new Date();b.setTime(f);var h=b.getFullYear();var i=(b.getMonth()+1)<10?"0"+(b.getMonth()+1):(b.getMonth()+1);var d=(b.getDate())<10?"0"+(b.getDate()):(b.getDate());var a=(b.getHours())<10?"0"+(b.getHours()):(b.getHours());var g=(b.getMinutes())<10?"0"+(b.getMinutes()):(b.getMinutes());var c=h+"-"+i+"-"+d+" "+a+"h"+g;return c}});var JobComparatorView=Backbone.View.extend({width:null,software:null,softwares:null,project:null,software1:null,software2:null,job1:null,job2:null,jobs1:null,jobs2:null,parent:null,initialize:function(a){this.width=a.width;this.software=a.software;this.software1=a.software;this.software2=a.software;this.softwares=a.softwares;this.project=a.project;this.job1=a.job1;this.job2=a.job2;this.jobs1=a.jobs;this.jobs2=a.jobs;this.parent=a.parent},render:function(){var a=this;require(["text!application/templates/processing/JobComparator.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(b){var a=this;var c=_.template(b,{});if(a.jobs1.length<1||a.jobs2.length<1){return}$(a.el).empty();$(a.el).append(c);a.printSoftwareSelection($("#comparatorSoftwareSelection"));a.changeSelectionValue($("#comparatorSoftwareSelection").find(".job1"),a.software1.id);a.changeSelectionValue($("#comparatorSoftwareSelection").find(".job2"),a.software2.id);a.printJobSelection($("#comparatorJobSelection"));a.changeSelection();a.refreshSelectStyle($("#comparatorJobSelection").find(".job1"));a.refreshSelectStyle($("#comparatorJobSelection").find(".job2"));a.refreshCompareJob()},changeSelection:function(){var a=this;if(a.jobs1.get(a.job1)!=undefined){a.changeSelectionValue($("#comparatorJobSelection").find(".job1"),a.job1.id)}else{a.changeSelectionValue($("#comparatorJobSelection").find(".job1"),a.jobs1.at(0).id)}if(a.jobs2.get(a.job2)!=undefined){a.changeSelectionValue($("#comparatorJobSelection").find(".job2"),a.job2.id)}else{a.changeSelectionValue($("#comparatorJobSelection").find(".job2"),a.jobs2.at(0).id)}},changeSelectionValue:function(a,b){a.find("select").val(b)},retrieveSelectedJob:function(a){return $("#comparatorJobSelection").find(".job"+a).find("select").val()},retrieveSelectedSoftware:function(a){return $("#comparatorSoftwareSelection").find(".job"+a).find("select").val()},cleanCompareJob:function(){$("#comparatorJobInfo").find(".job1").empty();$("#comparatorJobInfo").find(".job2").empty();$("#comparatorJobParam").find(".job1").empty();$("#comparatorJobParam").find(".job2").empty();$("#comparatorJobResult").find(".job1").empty();$("#comparatorJobResult").find(".job2").empty()},reloadSelection:function(){var a=this;$("#comparatorJobSelection").find(".job1").empty();$("#comparatorJobSelection").find(".job2").empty();$("#comparatorSoftwareSelection").find(".job1").empty();$("#comparatorSoftwareSelection").find(".job2").empty();a.printSoftwareSelection($("#comparatorSoftwareSelection"));a.changeSelectionValue($("#comparatorSoftwareSelection").find(".job1"),a.software1.id);a.changeSelectionValue($("#comparatorSoftwareSelection").find(".job2"),a.software2.id);a.printJobSelection($("#comparatorJobSelection"));a.changeSelection();a.refreshCompareJob()},refreshCompareJob:function(){var a=this;a.cleanCompareJob();var c=a.retrieveSelectedJob("1");var b=a.retrieveSelectedJob("2");console.log("idJob1="+c+" idJob2="+b);if(c==undefined||b==undefined){return}new JobModel({id:c}).fetch({success:function(d,f){new JobModel({id:b}).fetch({success:function(h,g){a.job1=d;a.job2=h;a.printJobInfo($("#comparatorJobInfo"));a.printParamJob($("#comparatorJobParam"));a.printResultJob($("#comparatorJobResult"))}})}})},printJobSelection:function(b){var a=this;a.addSelectionView(b.find(".job1"),a.jobs1);a.addSelectionView(b.find(".job2"),a.jobs2)},printSoftwareSelection:function(b){var a=this;a.addSelectionSoftwareView(b.find(".job1"));a.addSelectionSoftwareView(b.find(".job2"))},printJobInfo:function(b){var a=this;console.log("PRINT JOB INFO");a.addJobView(b.find(".job1"),a.job1);a.addJobView(b.find(".job2"),a.job2)},printParamJob:function(b){var a=this;a.addParamView(b.find(".job1"),a.job1);a.addParamView(b.find(".job2"),a.job2)},printResultJob:function(b){var a=this;a.addResultView(b.find(".job1"),a.job1);a.addResultView(b.find(".job2"),a.job2)},addSelectionView:function(b,c){var a=this;b.append("<select></select>");c.each(function(f){var d=a.getClassName(f);b.find("select").append('<option class="'+d+'" value="'+f.id+'">Job '+f.get("number")+" ("+window.app.convertLongToDate(f.get("created"))+")</option>")});b.find("select").change(function(){a.refreshSelectStyle(b);a.refreshCompareJob()})},addSelectionSoftwareView:function(b){var a=this;b.append("<select></select>");a.softwares.each(function(c){if(c.get("resultName")==c.get("resultName")){b.find("select").append('<option value="'+c.id+'">Software '+c.get("name")+"</option>")}});b.find("select").change(function(){a.refreshJobList()})},refreshJobList:function(){var a=this;a.cleanCompareJob();var c=a.retrieveSelectedSoftware("1");a.software1=a.softwares.get(c);var b=a.retrieveSelectedSoftware("2");a.software2=a.softwares.get(b);console.log("Selected software: 1#"+a.software1.id+"- 2#"+a.software2.id);new JobCollection({project:a.project.id,software:a.software1.id,light:true}).fetch({success:function(f,d){a.jobs1=f;new JobCollection({project:a.project.id,software:a.software2.id,light:true}).fetch({success:function(h,g){a.jobs2=h;a.reloadSelection()}})}})},refreshSelectStyle:function(b){var c=b.find("select").val();b.find("select").attr("class","");var a=b.find('option[value="'+c+'"]').attr("class");b.find("select").addClass(a)},getClassName:function(a){if(a.isNotLaunch()){return"btn-inverse"}else{if(a.isInQueue()){return"btn-info"}else{if(a.isRunning()){return"btn-primary"}else{if(a.isSuccess()){return"btn-success"}else{if(a.isFailed()){return"btn-danger"}else{if(a.isIndeterminate()){return"btn-inverse"}else{if(a.isWait()){return"btn-primary"}else{return"no supported"}}}}}}}},addJobView:function(b,c){var a=this;console.log("addJobView");b.append('<div style="margin: 0px auto;min-width:100px;max-width:200px" id="'+c.id+'"></div>');a.parent.buildJobInfoElem(c,b.find("#"+c.id))},addParamView:function(c,d){var a=this;c.append('<table width="100%" style="width:100%;max-width:100%" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-condensed" id="runParamsTable" ></table>');c.find("#runParamsTable").append("<thead><tr><th>Name</th><th>Value</th><th>Type</th></tr></thead>");c.find("#runParamsTable").append("<tbody></tbody>");var b=c.find("#runParamsTable").find("tbody");_.each(d.get("jobParameters"),function(f){b.append("<tr><td>"+f.name+"</td><td>"+a.getJobParamValue(f)+"</td><td>"+f.type+"</td></tr>")});c.find("#runParamsTable").dataTable({sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:10,bLengthChange:false,bDestroy:true,aoColumnDefs:[{sWidth:"40%",aTargets:[0]},{sWidth:"40%",aTargets:[1]},{sWidth:"20%",aTargets:[2]}]})},getJobParamValue:function(c){if(c.type=="List"){var a="<select>";var b=c.value.split(",");_.each(b,function(d){a=a+"<option>"+d+"</option>"});a=a+"</select>";return a}else{return c.value}},addResultView:function(b,c){var a=this;if(window.app.status.currentTermsCollection==undefined){new TermCollection({idProject:a.project.id}).fetch({success:function(f,d){window.app.status.currentTermsCollection=f;a.initJobResult(c,b)}})}else{a.initJobResult(c,b)}},initJobResult:function(d,c){var b=this;var a=new RetrievalAlgoResult({model:d,terms:window.app.status.currentTermsCollection,project:b.project,el:c}).render()}});var JobSelectionView=Backbone.View.extend({width:null,software:null,project:null,jobs:null,parent:null,availableDate:null,table:null,disableDateChangeEvent:false,currentDate:undefined,comparator:false,selectedJob:null,initialize:function(b){var a=this;this.software=b.software;this.project=b.project;this.parent=b.parent;this.jobs=b.jobs;this.comparator=b.comparator;this.loadDateArray()},render:function(){var a=this;require(["text!application/templates/processing/JobSelection.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var a=this;var b=_.template(c,{});$(a.el).empty();$(a.el).append(b);a.printDatatables(a.jobs.models);a.printDataPicker(undefined);$(a.el).find("#seeAllButton").click(function(){a.currentDate=undefined;a.disableDateChangeEvent=true;$(a.el).find("#datepicker").datepicker("setDate",null);a.disableDateChangeEvent=false;a.refresh()});$(a.el).find("#refreshButton").click(function(){a.refreshWithDate(a.currentDate);$(a.el).find("#datepicker").datepicker("setDate",a.currentDate)})},refresh:function(){this.refreshWithDate(undefined)},refreshWithDate:function(b){var a=this;new JobCollection({project:a.project.id,software:a.software.id,light:true}).fetch({success:function(d,c){a.jobs=d;a.loadDateArray();a.printDatatables(a.jobs.models,b);a.printDataPicker(b);$(a.el).find("#datepicker").datepicker("setDate",b);a.refreshJobs()}})},loadDateArray:function(){var a=this;a.availableDate=[];a.jobs.each(function(c){var b=new Date();b.setTime(c.get("created"));b=new Date(b.getFullYear(),b.getMonth(),b.getDate());a.availableDate.push(b.getTime())})},printDataPicker:function(b){var a=this;$(a.el).find("#datepicker").datepicker({beforeShowDay:function(c){if(_.indexOf(a.availableDate,c.getTime())!=-1){return[true,"",""]}else{return[false,"","No job was run at this date!"]}},onSelect:function(c){a.refreshJobs()}});if(b!=undefined){a.disableDateChangeEvent=true;$(a.el).find("#datepicker").datepicker("setDate",b);a.disableDateChangeEvent=false}$(a.el).find("#onlyDeletedJob").change(function(){a.refreshJobs()})},refreshJobs:function(){var a=this;if(!a.disableDateChangeEvent){var f=[];a.jobs.each(function(g){f.push(g)});var b=$(a.el).find("#datepicker").datepicker("getDate");if(b!=null){a.currentDate=b;var d=a.findJobIndiceBetweenDateTime(b.getTime(),b.getTime()+86400000);f=_.filter(f,function(h,g){return $.inArray(g,d)!=-1})}var c=$(a.el).find("#onlyDeletedJob").is(":checked");if(c){f=_.filter(f,function(h,g){return !h.get("dataDeleted")})}a.printDatatables(f,b)}},findJobIndiceBetweenDateTime:function(d,a){var b=this;var c=_.map(b.availableDate,function(f,g){if(f>=d&&f<a){return g}else{return -1}});c=_.without(c,-1);return c},findJobByIndice:function(a){var b=this;var c=[];_.each(a,function(d){c.push(b.jobs.at(d))});return c},printDatatables:function(a,f){var c=this;var g=$(c.el).find("#selectJobTable").find("tbody").empty();var b=$(c.el).find("#selectJobTable").dataTable();b.fnSetColumnVis(1,true);b.fnClearTable();var d=$(c.el).find("#selectJobTable").find("tbody");if(a!=undefined){_.each(a,function(m){var h='<i class="icon-plus"></i>';var l=m.id;var i=m.get("number");var p=window.app.convertLongToDate(m.get("created"));var k=c.getStateElement(m);var o="";if(c.comparator){o='<a id="select'+m.id+'">Compare</a>'}else{o='<a href="#tabs-algos-'+c.project.id+"-"+c.software.id+"-"+m.id+'" id="'+m.id+'">See details<br></a>'}var n="";if(m.get("dataDeleted")){n="All job data are deleted"}else{n='<button class="btn btn-warning" id="'+m.id+'">Delete data</button>'}d.append("<tr><td>"+h+'</td><td  style="text-align:left;">'+l+'</td><td  style="text-align:center;">'+i+'</td><td  style="text-align:center;">'+p+'</td><td  style="text-align:center;">'+k+"</td><td>"+n+"</td><td>"+o+"</td></tr>");if(c.comparator){d.find("#select"+m.id).click(function(){c.selectedJob=m.id})}})}$(c.el).find("#selectJobTable").find("tbody").find("button").click(function(h){var i=h.currentTarget.id;new JobModel({id:i}).fetch({success:function(l,k){new JobDeleteAllDataView({model:l,project:c.project,container:c}).render()}})});c.table=$(c.el).find("#selectJobTable").dataTable({bFilter:false,sDom:'<"toolbar">frtip',sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:5,bLengthChange:false,bDestroy:true,aoColumnDefs:[{sWidth:"5%",aTargets:[0]},{sWidth:"10%",aTargets:[1]},{sWidth:"10%",aTargets:[2]},{sWidth:"25%",aTargets:[3]},{sWidth:"20%",aTargets:[4]},{sWidth:"30%",aTargets:[5]}]});c.initSubGridDatatables();c.table.fnSetColumnVis(1,false)},getStateElement:function(a){if(a.isNotLaunch()){return'<span class="label btn-inverse">Not Launch</span> '}else{if(a.isInQueue()){return'<span class="label btn-info">In queue</span> '}else{if(a.isRunning()){return'<span class="label btn-primary">Running</span> '}else{if(a.isSuccess()){return'<span class="label btn-success">Success</span> '}else{if(a.isFailed()){return'<span class="label btn-danger">Failed</span> '}else{if(a.isIndeterminate()){return'<span class="label btn-inverse">Indetereminate</span> '}else{if(a.isWait()){return'<span class="label btn-warning">Wait</span> '}else{if(a.isPreviewed()){return'<span class="label btn-info">Previewed</span> '}else{return"no supported"}}}}}}}}},initSubGridDatatables:function(){var a=this;$(a.el).find("#selectJobTable tbody td i").on("click",function(){var c=$(this).parents("tr")[0];if(a.table.fnIsOpen(c)){$(this).removeClass("class","icon-minus");$(this).addClass("class","icon-plus");a.table.fnClose(c)}else{$(this).removeClass("class","icon-plus");$(this).addClass("class","icon-minus");a.table.fnOpen(c,a.seeDetails(c),"details");var b=a.table.fnGetData(c);new JobModel({id:b[1]}).fetch({success:function(f,d){var g=$(a.el).find("#selectJobTable").find("table[id="+b[1]+"]");_.each(f.get("jobParameters"),function(i){var h=i.value;if(h.length>50){h=h.substring(0,50)+"..."}g.append("<tr><td>"+i.name+"</td><td>"+h+"</td><td>"+i.type+"</td></tr>")})}})}})},seeDetails:function(d){var a=this;var b=a.table.fnGetData(d);var c='<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;" id="'+b[1]+'">';c+="</table>";return c},initDataTableSelectFiltering:function(){$.fn.dataTableExt.oApi.fnGetColumnData=function(a,f,h,m,k){if(typeof f=="undefined"){return[]}if(typeof h=="undefined"){h=true}if(typeof m=="undefined"){m=true}if(typeof k=="undefined"){k=true}var o;if(m==true){o=a.aiDisplay}else{o=a.aiDisplayMaster}var n=[];for(var d=0,g=o.length;d<g;d++){iRow=o[d];var b=this.fnGetData(iRow);var l=b[f];if(k==true&&l.length==0){continue}else{if(h==true&&jQuery.inArray(l,n)>-1){continue}else{n.push(l)}}}return n}}});var LaunchJobView=Backbone.View.extend({width:null,software:null,project:null,parent:null,params:[],paramsViews:[],initialize:function(a){this.width=a.width;this.software=a.software;this.project=a.project;this.parent=a.parent;this.el=a.el},render:function(){var a=this;require(["text!application/templates/processing/JobLaunch.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(b){var a=this;var c=_.template(b,{softwareName:a.software.get("name"),projectName:a.project.get("name")});$(a.el).empty();$(a.el).append(c);a.params=[];a.paramsViews=[];_.each(a.software.get("parameters"),function(d){a.params.push(d);a.paramsViews.push(a.getParamView(d))});a.printSoftwareParams();$("#previewJobBtn").on("click",function(d){a.createJobFromParam(a.previewJob)})},getParamView:function(a){if(a.type=="String"){return new InputTextView({param:a})}if(a.type=="Number"){return new InputNumberView({param:a})}if(a.type=="Date"){return new InputDateView({param:a})}if(a.type=="Boolean"){return new InputBooleanView({param:a})}if(a.type=="List"){return new InputListView({param:a})}if(a.type=="ListDomain"){return new InputListDomainView({param:a,multiple:true})}if(a.type=="Domain"){return new InputListDomainView({param:a,multiple:false})}else{return new InputTextView({param:a})}},printSoftwareParams:function(){var a=this;if(a.software==undefined){return}var c=$("#launchJobParamsTable");var b=c.find("tbody");b.empty();_.each(a.paramsViews,function(d){d.addRow(b);d.checkEntryValidation()})},createJobFromParam:function(b){var a=this.createJobModel(this.retrieveParams());this.saveJobModel(a,b)},executeJob:function(a){var b=new JobModel({id:a});$.post(b.executeUrl()).done(function(){console.log("job launched")}).fail(function(){console.log("error")}).always(function(){console.log("finished")})},previewJob:function(a){var b=new JobModel({id:a});$.post(b.previewUrl()).done(function(){var c=setInterval(function(){var d=$("#previewJob");d.html('<div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div>');b.fetch({success:function(g,f){if(g.isPreviewed()){$("#previewJob").empty();$("#previewJob").html(_.template("<img src='<%= previewRoiUrl %>' style='height : 200px;'/><img src='<%= previewUrl %>' style='height : 200px;'/>",{previewRoiUrl:g.previewRoiUrl(),previewUrl:g.previewUrl()}));clearInterval(c)}},error:function(g,f){clearInterval(c)}})},2000)}).fail(function(){console.log("error")}).always(function(){console.log("finished")})},createJobModel:function(b){var a=this;return new JobModel({software:a.software.id,project:a.project.id,params:b})},retrieveParams:function(){var a=this;var b=[];_.each(a.paramsViews,function(d){var c=d.param;var f=d.getStringValue();var g={value:'"'+f+'"',softwareParameter:c.id};b.push(g)});return b},saveJobModel:function(b,c){var a=this;b.save({},{success:function(f,d){window.app.view.message("Add Job",d.message,"success");a.parent.changeJobSelection(f.get("job").id);if(c){c(f.get("job").id)}},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Add Job","error:"+g.errors,"error")}})}});var InputTextView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td>'+a.param.name+"</td><td>"+a.getHtmlElem()+'</td><td ><span class="label label-important hidden"></span></td></tr>');a.trElem=b.find("tr#"+a.param.id);a.trElem.find("input").keyup(function(){a.checkEntryValidation()})},getHtmlElem:function(){var a=this;return _.template('<div class="control-group success"><div class="controls"><input type="text" class="span3" value="<%= value%>" <%= required %>></div></div>',{value:this.getDefaultValue(),required:(a.param.required)?"required":""})},getDefaultValue:function(){return window.app.replaceVariable(this.param.defaultParamValue)},checkEntryValidation:function(){var a=this;if(a.param.required&&a.getValue().trim()==""){a.changeStyle(a.trElem,false,"Field required")}else{a.changeStyle(a.trElem,true,"")}},getValue:function(){return this.trElem.find("input").val()},getStringValue:function(){return this.getValue()},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputNumberView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td>'+a.param.name+"</td><td>"+a.getHtmlElem()+'</td><td><span class="label label-important hidden"></span></td></tr>');a.trElem=b.find("tr#"+a.param.id);a.trElem.find("input").keyup(function(){a.checkEntryValidation()})},getHtmlElem:function(){return _.template('<div class="control-group success"><div class="controls"><input type="text" class="span3" value="<%= value%>" <%= required %>></div></div>',{value:this.getDefaultValue(),required:(self.param.required)?"required":""})},getDefaultValue:function(){return window.app.replaceVariable(this.param.defaultParamValue)},checkEntryValidation:function(){var a=this;if(a.param.required&&a.getValue().trim()==""){a.changeStyle(a.trElem,false,"Field required")}else{if(a.getValue().trim()!=""&&isNaN(a.getValue())){a.changeStyle(a.trElem,false,"Not valid number")}else{a.changeStyle(a.trElem,true,"")}}},getValue:function(){return this.trElem.find("input").val()},getStringValue:function(){return this.getValue()},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputDateView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(c){var b=this;c.append('<tr id="'+b.param.id+'"><td>'+b.param.name+"</td><td>"+b.getHtmlElem()+'</td><td><span class="label label-important hidden"></span></td></tr>');b.trElem=c.find("tr#"+b.param.id);var a=b.getDefaultValue();var d=null;if(a!=null){d=new Date(Number(a))}b.trElem.find("input").datepicker({dateFormat:"yy-mm-dd",onSelect:function(g,f){b.checkEntryValidation()}});if(d!=null){b.trElem.find("input").datepicker("setDate",d)}b.trElem.find("input").keyup(function(){b.checkEntryValidation()})},getHtmlElem:function(){return _.template('<div class="control-group success"><div class="controls"><input type="text" class="span3" value="" <%= required %>></div></div>',{required:(self.param.required)?"required":""})},getDefaultValue:function(){return window.app.replaceVariable(this.param.defaultParamValue)},checkEntryValidation:function(){var a=this;var b=a.trElem.find("input").datepicker("getDate");if(a.param.required&&b==null){a.changeStyle(a.trElem,false,"Field required")}else{a.changeStyle(a.trElem,true,"")}},getValue:function(){var a=this;var b=a.trElem.find("input").datepicker("getDate");if(b==null){return null}else{return b.getTime()}},getStringValue:function(){return this.getValue()},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputBooleanView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td>'+a.param.name+"</td><td>"+a.getHtmlElem()+'</td><td><span class="label label-important hidden"></span></td></tr>');a.trElem=b.find("tr#"+a.param.id);a.trElem.find("input").keyup(function(){a.checkEntryValidation()})},getHtmlElem:function(){return _.template('<div><input type="checkbox" class="span3" <%= value %> ></input></div>',{value:this.getDefaultValue()})},getDefaultValue:function(){if(this.param.type=="Boolean"&&this.param.defaultParamValue!=undefined&&this.param.defaultParamValue.toLowerCase()=="true"){return'checked="checked"'}return""},checkEntryValidation:function(){var a=this;a.changeStyle(a.trElem,true,"")},getValue:function(){return this.trElem.find("input").is(":checked")},getStringValue:function(){return this.getValue()+""},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputListView=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td>'+a.param.name+"</td><td>"+a.getHtmlElem()+'</td><td ><span class="label label-important hidden"></span></td></tr>');a.trElem=b.find("tr#"+a.param.id);a.trElem.find(".icon-plus-sign").click(function(){var c=$(this).parent().find("input").val();if(c.trim()!=""){$(this).parent().find("select").append('<option value="'+c+'">'+c+"</option>");$(this).parent().find("input").val("");$(this).parent().find("select").val(c);a.checkEntryValidation()}});a.trElem.find(".icon-minus-sign").click(function(){var c=$(this).parent().find("select").val();$(this).parent().find("select").find('[value="'+c+'"]').remove();a.checkEntryValidation()})},getHtmlElem:function(){var b=this;var c="";if(b.param.required){c="border-style: solid; border-width: 2px;"}else{c="border-style: dotted;border-width: 2px;"}var d=b.getDefaultValue();var a='<div class="control-group success"><div class="controls"><input type="text" class="span3" value="" style="'+c+'"><i class="icon-plus-sign"></i><select>';_.each(d,function(f){a=a+'<option value="'+f+'">'+f+"</option>"});a=a+'</select><i class="icon-minus-sign"></i></div></div>';return a},getDefaultValue:function(){var b=this;if(!b.param.defaultParamValue){return[]}var c=b.param.defaultParamValue.split(",");var a=[];_.each(c,function(d){a.push(window.app.replaceVariable(d))});return a},checkEntryValidation:function(){var a=this;if(a.trElem.find("select").children().length==0){a.changeStyle(a.trElem,false,"Field required")}else{a.changeStyle(a.trElem,true,"")}},getValue:function(){var a=this;var b=[];a.trElem.find("select").find("option").each(function(){b.push($(this).attr("value"))});return b.join(",")},getStringValue:function(){return this.getValue()},changeStyle:function(b,c,a){InputView.changeStyle(b,c,a)}});var InputListDomainView=Backbone.View.extend({param:null,parent:null,trElem:null,multiple:true,collection:null,printAttribut:null,elemSuggest:null,initialize:function(a){this.param=a.param;this.parent=a.parent;this.multiple=a.multiple;this.printAttribut=this.param.uriPrintAttribut},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td>'+a.param.name+'</td><td id="'+a.param.id+'"></td><td><span class="errorMessage label label-important hidden"></span></td></tr>');a.trElem=b.find("tr#"+a.param.id);a.collection=new SoftwareParameterModelCollection({uri:window.app.replaceVariable(a.param.uri),sortAttribut:a.param.uriSortAttribut});if(window.app.getFromCache(window.app.replaceVariable(a.param.uri))==undefined){if(a.collection==undefined||(a.collection.length>0&&a.collection.at(0).id==undefined)){a.trElem.find("td#"+a.param.id).append('<div class="alert alert-info" style="margin-left : 10px;margin-right: 10px;"><i class="icon-refresh" /> Loading...</div>');if(a.param.required){a.changeStyle(a.trElem,false,"Field required")}a.collection.fetch({success:function(d,c){a.collection=d;window.app.addToCache(window.app.replaceVariable(a.param.uri),d);a.collection.comparator=function(f){return f.get(a.param.uriSortAttribut)};a.collection.sort();a.addHtmlElem()}})}else{a.addHtmlElem()}}else{a.collection=window.app.getFromCache(window.app.replaceVariable(a.param.uri));a.collection.comparator=function(c){return c.get(a.param.uriSortAttribut)};a.collection.sort();a.addHtmlElem()}},addHtmlElem:function(){var b=this;var a=b.trElem.find("td#"+b.param.id);a.empty();a.append(b.getHtmlElem());if(b.multiple){a.append('<button class="btn" id="checkAll'+b.param.id+'">Check All</button>');a.append('<button class="btn" id="uncheckAll'+b.param.id+'">Uncheck All</button>')}var d=b.collection.toJSON();var c=undefined;b.elemSuggest=a.find(".suggest").magicSuggest({displayField:b.printAttribut,data:d,selectionPosition:"inner",selectionStacked:false,maxSelection:(b.multiple?null:1),value:c,width:550,renderer:function(f){var g;if(f.thumb){g=_.template('<div><div style="float:left; width : 128px;"><img src="<%= thumb %>" style="max-width : 64px; max-height : 64px;" /></div><div style="padding-left: 20px;"><%= name %></div></div><div style="clear:both;"></div>',{thumb:f.thumb,name:f[b.printAttribut]})}else{g=_.template("<%= name %>",{name:f[b.printAttribut]})}return g}});$("#checkAll"+b.param.id).click(function(){b.elemSuggest.addToSelection(d)});$("#uncheckAll"+b.param.id).click(function(){b.elemSuggest.removeFromSelection(d)});$(b.elemSuggest).on("selectionchange",function(f){b.checkEntryValidation()})},getDefaultValue:function(){var b=this;if(!b.param.defaultParamValue){return[]}var c=b.param.defaultParamValue.split(",");var a=[];_.each(c,function(d){a.push(window.app.replaceVariable(d))});return a},getHtmlElem:function(){return"<div class='suggest' />"},checkEntryValidationWithAllValue:function(f,d){var b=this;var a=b.getValue();var c=a.length;if(d){c++}else{c--}if(b.param.required&&c==0){b.changeStyle(b.trElem,false,"Field required")}else{b.changeStyle(b.trElem,true,"")}},checkEntryValidation:function(){var b=this;var a=b.getValue();if(b.param.required&&a.length==0){b.changeStyle(b.trElem,false,"Field required")}else{b.changeStyle(b.trElem,true,"")}},getValue:function(){var b=this;if(!b.elemSuggest){return[]}var a=b.elemSuggest.getValue();if(a==undefined){return[]}else{return a}},getStringValue:function(){var b=this;var a=b.getValue();if(a==undefined){return""}else{return a.join(",")}},changeStyle:function(d,f,c){var a=d.find(".errorMessage");if(f){a.addClass("hidden");a.text("")}else{a.removeClass("hidden");a.text("");a.text(c)}var b="";if(f){d.removeClass("error");d.addClass("success")}else{d.removeClass("success");d.addClass("error")}}});var InputView={changeStyle:function(f,g,d){var c="";if(g){c="success"}else{c="error"}f.removeClass("error");f.removeClass("success");f.addClass(c);var a=f.children().eq(1).children().eq(0);a.removeClass("success");a.removeClass("error");a.addClass(c);var b=f.find("span");if(g){b.addClass("hidden");b.text("")}else{b.removeClass("hidden");b.text("");b.text(d)}}};var JobResultView=Backbone.View.extend({software:null,project:null,jobs:null,parent:null,initialize:function(a){this.software=a.software;this.project=a.project;this.jobs=a.jobs},render:function(){var a=this;console.log("self.software.get('resultName')="+a.software.get("resultName"));switch(a.software.get("resultName")){case"ValidateAnnotation":a.valideAnnotation();break;case"ValidateEvolution":a.valideEvolution();break;case"DownloadFiles":a.downloadFiles();break;case"Default":a.defaultResult();break;default:a.defaultResult();break}return this},valideAnnotation:function(){var a=this;new RetrievalAlgoResult({model:a.model,project:a.project,el:a.el,jobs:a.jobs,software:a.software}).render()},valideEvolution:function(){var a=this;new EvolutionAlgoResult({model:a.model,project:a.project,el:a.el,jobs:a.jobs,software:a.software}).render()},defaultResult:function(){var a=this;new DefaultResult({model:a.model,project:a.project,el:a.el,jobs:a.jobs,software:a.software}).render()},downloadFiles:function(){var a=this;new DownloadFiles({model:a.model,project:a.project,el:a.el,jobs:a.jobs,software:a.software}).render()}});var SoftwareDetailsView=Backbone.View.extend({project:null,detailsRendered:false,initialize:function(a){this.project=a.project;this.stats=a.stats},render:function(){var a=this;require(["text!application/templates/processing/SoftwareDetails.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;a.model.set({_created:window.app.convertLongToDate(a.model.get("created"))});$(a.el).html(_.template(b,$.extend({},a.model.toJSON(),a.stats.toJSON())));$("#softwareHideDetailsButton").on("click",function(c){$("#softwareDetailsPanel").hide();$("#softwareDescription").show()});$("#softwareShowDetailsButton").on("click",function(c){$("#softwareDetailsPanel").show();$("#softwareDescription").hide();if(!a.detailsRendered){a.printJobsChart();a.printSoftwareParams();a.detailsRendered=true}})},printSoftwareParams:function(){var a=this;$("#softwareParamsTable").find("tbody").empty();var b=$("#softwareParamsTable").find("tbody");_.each(a.model.get("parameters"),function(f){var c="<tr><td><%= name %></td><td><%= type %></td><td><%= defaultParamValue %></td><td><input type='checkbox' <%= checked %> disabled /></td><td><%= index %></td></tr>";var d=_.template(c,{name:f.name,type:f.type,defaultParamValue:f.defaultParamValue,checked:(f.required?"checked":""),index:f.index});b.append(d)})},printJobsChart:function(){var a=this;var f=a.model;var g=new google.visualization.DataTable();g.addColumn("string","Success");g.addColumn("number","Number");g.addRows([["Not Launch",f.get("numberOfNotLaunch")],["In Queue",f.get("numberOfInQueue")],["Running",f.get("numberOfRunning")],["Success",f.get("numberOfSuccess")],["Failed",f.get("numberOfFailed")],["Indeterminate",f.get("numberOfIndeterminate")],["Wait",f.get("numberOfWait")]]);var d=$("#softwareInfoChart").width();var b={title:"Job status for "+a.model.get("name")+" (over all projects)",legend:{position:"right"},width:d,height:350,vAxis:{title:"Amount"},hAxis:{title:"Job status"},backgroundColor:"whiteSmoke",strictFirstColumnType:false,lineWidth:1,colors:["#434141","#65d7f8","#005ccc","#52a652","#c43c35","#434343","#faaa38"]};var c=new google.visualization.ColumnChart(document.getElementById("softwareInfoChart"));c.draw(g,b)}});var JobSearchView=Backbone.View.extend({width:null,software:null,project:null,parent:null,initialize:function(a){this.software=a.software;this.project=a.project;this.parent=a.parent;this.idJob=a.idJob},render:function(){var a=this;require(["text!application/templates/processing/JobSearch.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(b){console.log("JobSearchView.loadResult");var a=this;var c=_.template(b,{});$(a.el).empty();$(a.el).append(c);a.printJobListingPanel()},printBasicSearchPanel:function(){},printAdvancedSearchPanel:function(){},printFilterPanel:function(){},printJobListingPanel:function(){console.log("JobSearchView.printJobListingPanel");var a=this;if(window.app.models.projects==undefined||(window.app.models.projects.length>0&&window.app.models.projects.at(0).id==undefined)){window.app.models.projects=new ProjectCollection();window.app.models.projects.fetch({success:function(c,b){a.openJobListing()}})}else{a.openJobListing()}},openJobListing:function(){var a=this;new JobCollection({project:a.project.id,software:a.software.id}).fetch({success:function(c,b){var d=new JobTableView({width:a.software,project:a.project,software:a.software,el:$("#jobTablesList"),parent:a,jobs:c}).render();console.log("listing1:"+d);new JobSearchEngineView({width:a.software,project:a.project,software:a.software,idJob:a.idJob,el:$("#jobFilterList"),parent:a,listing:d,allJobs:c}).render()}})},refreshSearch:function(){}});var JobTableView=Backbone.View.extend({width:null,software:null,project:null,jobs:null,parent:null,table:null,datatable:null,paramsFromSoftwares:null,paramsFromSoftwaresFull:null,paramsFromSoftwaresVisibility:null,paramsFromSoftwaresDomainFill:null,FIRSTCOLUMNWITHJOBDATA:7,initialize:function(b){var a=this;this.software=b.software;this.project=b.project;this.parent=b.parent;this.jobs=b.jobs;this.paramsFromSoftwares=[];this.paramsFromSoftwaresFull=[];_.each(a.software.get("parameters"),function(c){a.paramsFromSoftwares.push(c.name);a.paramsFromSoftwaresFull.push(c)});this.paramsFromSoftwaresVisibility=[];this.paramsFromSoftwaresDomainFill=[];_.each(a.software.get("parameters"),function(c){a.paramsFromSoftwaresVisibility.push(false);a.paramsFromSoftwaresDomainFill.push(false)})},render:function(){var a=this;require(["text!application/templates/processing/JobListing.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(b){console.log("JobTableView.loadResult");var a=this;var c=_.template(b,{});$(a.el).empty();$(a.el).append(c);a.printDatatables()},refresh:function(a){var b=this;console.log("JobTableView.refresh");b.jobs=a;b.printDatatables()},printDatatables:function(){var b=this;console.log("JobTableView.printDatatables");$(b.el).find("#searchJobTable").find("#searchJobHeader").empty();$(b.el).find("#searchJobTable").find("tbody").empty();if(b.jobs!=undefined&&b.jobs.length>0){b.addColumns(b.jobs.models[0])}$(b.el).find("#searchJobTable").find("tbody").empty();var a=$(b.el).find("#searchJobTable").dataTable();a.fnClearTable();$(b.el).find("#searchJobTable").find("tbody").empty();b.buildShowHideAllColumn(a,true);a.fnClearTable();if(b.jobs!=undefined){b.jobs.each(function(c){b.addRow(c)})}$(b.el).find("#searchJobTable").find("tbody").find("button").click(function(){var c=$(this).attr("id");window.location="#tabs-algos-"+b.project.id+"-"+b.software.id+"-"+c+""});b.table=$(b.el).find("#searchJobTable").dataTable({bFilter:true,sDom:'<"toolbar">rtip',sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:15,bLengthChange:false,bDestroy:true});b.initSubGridDatatables()},addColumns:function(b){var a=this;$(a.el).find("#searchJobTable").find("#searchJobHeader").append("<th></th>");$(a.el).find("#searchJobTable").find("#searchJobHeader").append("<th>Id</th>");$(a.el).find("#searchJobTable").find("#searchJobHeader").append("<th>#</th>");$(a.el).find("#searchJobTable").find("#searchJobHeader").append("<th>Date</th>");$(a.el).find("#searchJobTable").find("#searchJobHeader").append("<th>State</th>");$(a.el).find("#searchJobTable").find("#searchJobHeader").append("<th>Rate</th>");$(a.el).find("#searchJobTable").find("#searchJobHeader").append("<th>See</th>");_.each(a.software.get("parameters"),function(c){$(a.el).find("#searchJobTable").find("#searchJobHeader").append("<th>"+c.name+"</th>")})},addRow:function(b){var r=this;var l=$(r.el).find("#searchJobTable").find("tbody");var p='<i class="icon-plus"></i>';var c=b.id;var a=b.get("number");var f=window.app.convertLongToDate(b.get("created"));var d=r.getStateElement(b);var o='<button id="'+b.id+'">See details</button>';var n="";if(b.get("rate")!=-1){n=(b.get("rate")*100).toFixed(2)+"%"}var q=["<tr>","<td>"+p+"</td>",'<td  style="text-align:left;">'+c+"</td>",'<td  style="text-align:center;">'+a+"</td>",'<td  style="text-align:center;">'+f+"</td>",'<td  style="text-align:center;">'+d+"</td>",'<td  style="text-align:center;">'+n+"</td>","<td>"+o+"</td>"];var h=b.get("jobParameters");if(h.length==0){_.each(r.paramsFromSoftwares,function(i){q.push("<td></td>")})}else{for(var k=0,g=0;k<r.paramsFromSoftwares.length&&g<h.length;k++){if(r.paramsFromSoftwares[k]==h[g].name){q.push(r.getValueElement(h[g]));g++}else{q.push("<td></td>")}}}q.push("</tr>");var m=q.join("");l.append(m)},getValueElement:function(b){var a=this;if(b.type=="String"||b.type=="Number"){return"<td>"+b.value+"</td>"}else{if(b.type=="Boolean"){if(b.value){return'<td><input type="checkbox" name="checkbox" value="checkbox" checked="checked"></td>'}else{return'<td><input type="checkbox" name="checkbox" value="checkbox" checked="checked"></td>'}}else{if(b.type=="List"){return"<td>"+b.value+"</td>"}else{if(b.type=="Date"){if(b.value!=null){return"<td>"+window.app.convertLongToDate(b.value)+"</td>"}else{return"<td></td>"}}else{if(b.type=="ListDomain"||b.type=="Domain"){return'<td><label style="display:inline;" data="'+b.value+'" class="'+b.softwareParameter+'" id="paramsTable'+b.id+'"><i class="icon-refresh" />Loading...</label></td>'}else{return"<td>"+b.value+"</td>"}}}}}},getStateElement:function(a){if(a.isNotLaunch()){return'<span class="label btn-inverse">Not Launch</span> '}else{if(a.isInQueue()){return'<span class="label btn-info">In queue</span> '}else{if(a.isRunning()){return'<span class="label btn-primary">Running</span> '}else{if(a.isSuccess()){return'<span class="label btn-success">Success</span> '}else{if(a.isFailed()){return'<span class="label btn-danger">Failed</span> '}else{if(a.isIndeterminate()){return'<span class="label btn-inverse">Indetereminate</span> '}else{if(a.isWait()){return'<span class="label btn-warning">Wait</span> '}else{if(a.isPreviewed()){return'<span class="label btn-info">Previewed</span> '}else{return"no supported"}}}}}}}}},initSubGridDatatables:function(){console.log("JobTableView.initSubGridDatatables");var a=this;$(a.el).find("#searchJobTable tbody td i").unbind("click");$(a.el).find("#searchJobTable tbody td i").click(function(){var c=$(this).parents("tr")[0];if(a.table.fnIsOpen(c)){console.log("close");$(this).removeClass("class","icon-minus");$(this).addClass("class","icon-plus");a.table.fnClose(c)}else{console.log("open");$(this).removeClass("class","icon-plus");$(this).addClass("class","icon-minus");a.table.fnOpen(c,a.seeDetails(c),"details");var b=a.table.fnGetData(c);console.log("aData[1]="+b[1]);new JobModel({id:b[1]}).fetch({success:function(f,d){var g=$(a.el).find("#searchJobTable").find("table[id="+b[1]+"]");_.each(f.get("jobParameters"),function(h){g.append("<tr><td>"+h.name+"</td><td>"+h.value+"</td><td>"+h.type+"</td></tr>")})}})}})},seeDetails:function(d){var a=this;var b=a.table.fnGetData(d);var c='<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;" id="'+b[1]+'">';c+="</table>";return c},buildShowHideAllColumn:function(b,a){var c=this;for(var d=0;d<b.fnSettings().aoColumns.length;d++){b.fnSetColumnVis(d,a)}},buildSHowHideColumnParamPanel:function(b){var c=this;console.log("buildHideColumnParamPanel="+b.fnSettings().aoColumns.length);for(var g=c.FIRSTCOLUMNWITHJOBDATA;g<b.fnSettings().aoColumns.length;g++){var a=c.paramsFromSoftwaresVisibility[g-c.FIRSTCOLUMNWITHJOBDATA];b.fnSetColumnVis(g,a)}$("#showParamColumnSearchJobTable").empty();var f='<select id="selectShowParamColumnSearchJobTable">';for(var g=c.FIRSTCOLUMNWITHJOBDATA;g<b.fnSettings().aoColumns.length;g++){f=f+'<option value="'+(g-c.FIRSTCOLUMNWITHJOBDATA)+'">'+b.fnSettings().aoColumns[g].sTitle+"</option>"}f=f+"</select>";$("#showParamColumnSearchJobTable").append(f);$("#selectShowParamColumnSearchJobTable").multiselect({selectedText:"Show/Hide  Parameters columns: # of # selected",noneSelectedText:"Show/Hide Parameters columns",minWidth:($("#showParamColumnSearchJobTable").width()-50),height:"auto"});var d=$("#showParamColumnSearchJobTable");d.find("button").width(($("#showParamColumnSearchJobTable").width()-50));d.find(".ui-multiselect-menu").find("span").css("display","inline");d.find(".ui-multiselect-menu").find("input").css("display","inline");d.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").css("display","inline");d.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").eq(0).css("float","left");d.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").eq(1).css("float","right");d.find(".ui-multiselect-menu").find("li").css("display","inline");d.find(".ui-multiselect-menu").find("li").css("padding-left","5px");d.find(".ui-multiselect-menu").find("label").css("display","inline");d.find("ul.ui-multiselect-checkboxes").css("overflow-y","scroll");d.find("ul.ui-multiselect-checkboxes").css("overflow-x","hidden");d.find("#selectShowParamColumnSearchJobTable").multiselect("close");d.find("#selectShowParamColumnSearchJobTable").multiselect("uncheckAll");$("#selectShowParamColumnSearchJobTable").bind("multiselectclick",function(h,i){console.log("Show/Hide:"+i.value);c.showOrHideColumnVisibility((parseInt(i.value)+c.FIRSTCOLUMNWITHJOBDATA),b,i.checked)});$("#selectShowParamColumnSearchJobTable").bind("multiselectcheckall",function(h,i){c.showOrHideAllColumnVisibility(b,true)});$("#selectShowParamColumnSearchJobTable").bind("multiselectuncheckall",function(h,i){c.showOrHideAllColumnVisibility(b,false)})},showOrHideAllColumnVisibility:function(b,a){var c=this;c.paramsFromSoftwaresVisibility=[];_.each(c.software.get("parameters"),function(f){c.paramsFromSoftwaresVisibility.push(a)});var d=0;_.each(c.software.get("parameters"),function(f){c.showOrHideColumnVisibility((parseInt(d)+c.FIRSTCOLUMNWITHJOBDATA),b,a);d++})},showOrHideColumnVisibility:function(d,b,a){console.log("Click show/hide column:"+d);var c=this;var g=d-c.FIRSTCOLUMNWITHJOBDATA;var f=parseInt(d);console.log("columnIndex="+g+" columnParamIndex="+f);c.paramsFromSoftwaresVisibility[g]=a;console.log("Change visibility to "+c.paramsFromSoftwaresVisibility[g]);b.fnSetColumnVis(f,c.paramsFromSoftwaresVisibility[g]);var h=c.paramsFromSoftwaresFull[g];c.fillDomainElement(h,g)},fillDomainElement:function(b,a){if(b.type=="Domain"||b.type=="ListDomain"){if(!this.paramsFromSoftwaresDomainFill[a]){this.retrieveAndReplaceCell(b,a)}}},retrieveAndReplaceCell:function(c,b){var a=this;new SoftwareParameterModelCollection({uri:window.app.replaceVariable(c.uri),sortAttribut:c.uriSortAttribut}).fetch({success:function(f,d){_.each($(a.el).find("label."+c.id),function(g){var i=$(g).attr("data");var h=[];_.each(i.split(","),function(l){var k=f.get(l);if(k!=undefined){h.push(k.get(c.uriPrintAttribut))}});$(g).empty();$(g).text(h.join(","))});a.paramsFromSoftwaresDomainFill[b]=true}})}});var JobSearchEngineView=Backbone.View.extend({width:null,software:null,project:null,parent:null,listing:null,allJobs:null,paramViews:null,initialize:function(b){var a=this;this.software=b.software;this.project=b.project;this.parent=b.parent;this.listing=b.listing;this.idJob=b.idJob;this.allJobs=b.allJobs;this.paramViews=[]},render:function(){var a=this;require(["text!application/templates/processing/JobSearchEngine.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(b){console.log("JobSearchEngineView.loadResult");var a=this;var c=_.template(b,{});$(a.el).empty();$(a.el).append(c);console.log("$('#myTab')="+$("#myTab").length);console.log("$('#myTab').find('a')="+$("#myTab").find("a").length);$("#myTab").find("a").click(function(d){console.log("click");d.preventDefault();$(this).tab("show");history.replaceState(null,"","#tabs-algos-"+a.project.id+"-"+a.software.id+"-"+a.idJob);return false});a.printBasicSearchPanel();a.printAdvancedSearchPanel()},printBasicSearchPanel:function(){var a=this;var b=function(){console.log(a);console.log("launchQuickSearch:"+$("#searchJobFilterAll").val());a.listing.table.fnFilter($("#searchJobFilterAll").val(),null,false,true)};$("#searchJobFilterAll").keyup(b);$("#searchJobFilterAll").click(b);$("#searchJobFilterDateAfter").datepicker({numberOfMonths:3,showButtonPanel:true});$("#searchJobFilterDateBefore").datepicker({numberOfMonths:3,showButtonPanel:true});$("#searchJobFilterStatusNotLaunch").append('<span class="label btn-inverse">Not Launch!</span>');$("#searchJobFilterStatusInQueue").append('<span class="label btn-info">In queue!</span>');$("#searchJobFilterStatusRunning").append('<span class="label btn-primary">Running!</span>');$("#searchJobFilterStatusSuccess").append('<span class="label btn-success">Success!</span>');$("#searchJobFilterStatusFailed").append('<span class="label btn-danger">Failed!</span>');$("#searchJobFilterStatusIndetereminate").append('<span class="label btn-inverse">Indetereminate!</span>');$("#searchJobFilterStatusWait").append('<span class="label btn-warning">Wait!</span>');$("#searchJobFilterButton").click(function(){a.launchSearch()});$("#resetJobFilterButton").click(function(){a.launchReset()})},printAdvancedSearchPanel:function(){var a=this;_.each(a.software.get("parameters"),function(c){var b=a.getParamView(c);a.paramViews.push(b);console.log("### addRow "+c.type);b.addRow($("#searchJobFilterParameterTable"))})},getParamView:function(a){if(a.type=="String"){return new InputTextViewSearch({param:a})}if(a.type=="Number"){return new InputNumberViewSearch({param:a})}if(a.type=="Boolean"){return new InputBooleanViewSearch({param:a})}if(a.type=="List"){return new InputListViewSearch({param:a})}if(a.type=="Date"){return new InputDateViewSearch({param:a})}if(a.type=="ListDomain"){return new InputListDomainViewSearch({param:a,multiple:true})}if(a.type=="Domain"){return new InputListDomainViewSearch({param:a,multiple:false})}else{return new InputTextViewSearch({param:a})}},launchSearch:function(){var b=this;console.log("search job");$("#searchJobFilterAll").val("");var a=b.allJobs.models;a=b.searchById(a,$("#searchJobFilterId").val());a=b.searchByNumber(a,$("#searchJobFilterNumber").val());a=b.searchByCreationDateAfter(a,$("#searchJobFilterDateAfter").datepicker("getDate"));a=b.searchByCreationDateBefore(a,$("#searchJobFilterDateBefore").datepicker("getDate"));a=b.searchByStatus(a,0,$("#searchJobFilterStatusNotLaunchCheck").is(":checked"));a=b.searchByStatus(a,1,$("#searchJobFilterStatusInQueueCheck").is(":checked"));a=b.searchByStatus(a,2,$("#searchJobFilterStatusRunningCheck").is(":checked"));a=b.searchByStatus(a,3,$("#searchJobFilterStatusSuccessCheck").is(":checked"));a=b.searchByStatus(a,4,$("#searchJobFilterStatusFailedCheck").is(":checked"));a=b.searchByStatus(a,5,$("#searchJobFilterStatusIndetereminateCheck").is(":checked"));a=b.searchByStatus(a,6,$("#searchJobFilterStatusWaitCheck").is(":checked"));_.each(b.paramViews,function(c){var d=c.param.name;var f=c.getStringValue();a=b.searchByParam(a,d,f)});b.listing.refresh(new JobCollection(a))},searchById:function(a,c){console.log("Before searchById:"+a.length+" value="+c);if(c==undefined||c==null||c.trim()==""){return a}var b=[];_.each(a,function(d){if(d.get("id")==c){b.push(d)}});console.log("After searchById:"+b.length);return b},searchByNumber:function(a,c){console.log("Before searchByNumber:"+a.length+" value="+c);if(c==undefined||c==null||c.trim()==""){return a}var b=[];_.each(a,function(d){if(d.get("number")==c){b.push(d)}});console.log("After searchByNumber:"+b.length);return b},searchByCreationDateAfter:function(a,c){console.log("Before searchByCreationDateAfter:"+a.length+" datetime="+c);if(c==undefined||c==null){return a}var b=[];_.each(a,function(d){if(d.get("created")>=c.getTime()){b.push(d)}});console.log("After searchByCreationDateAfter:"+b.length);return b},searchByCreationDateBefore:function(a,c){console.log("Before searchByCreationDateBefore:"+a.length+" datetime="+c);if(c==undefined||c==null){return a}var b=[];_.each(a,function(d){if(d.get("created")<c.getTime()){b.push(d)}});console.log("After searchByCreationDateBefore:"+b.length);return b},searchByStatus:function(a,d,c){console.log("Before searchByStatus:"+a.length+" status="+d+" check="+c);if(c){return a}var b=[];_.each(a,function(f){if(f.get("status")!=d){b.push(f)}});console.log("After searchByStatus:"+b.length);return b},searchByParam:function(a,d,f){var c=this;console.log("Before searchByParam:"+a.length+" paramName="+d+" paramValue="+f);if(f==undefined||f==null||f.trim()==""){return a}var b=[];_.each(a,function(h){var g=c.getJobParam(h,d);if(g!=undefined){console.log("jobParam.value="+g.value)}if(g!=undefined&&g!=null&&c.isJobParamCorrect(g,f)){b.push(h)}});console.log("After searchByParam:"+b.length);return b},isJobParamCorrect:function(c,d){if(c.type=="Date"){var a=d.split("-");var f=true;var b=true;console.log("isJobParamCorrect:"+window.app.convertLongToDate(c.value)+"=>"+window.app.convertLongToDate(a[0])+"-"+window.app.convertLongToDate(a[1]));if(a[0]!="null"){f=(c.value>=a[0])}if(a[1]!="null"){b=(c.value<=a[1])}return(f&&b)}else{return c.value.toLowerCase()==d.toLowerCase()}},getJobParam:function(b,a){var c=undefined;_.each(b.get("jobParameters"),function(d){if(d.name==a){c=d}});return c},launchReset:function(){var b=this;console.log("search job");var a=b.allJobs.models;$("#searchJobFilterId").val("");$("#searchJobFilterNumber").val("");$("#searchJobFilterDateAfter").datepicker("setDate",null);$("#searchJobFilterDateBefore").datepicker("setDate",null);$("#searchJobFilterStatusNotLaunchCheck").attr("checked",true);$("#searchJobFilterStatusInQueueCheck").attr("checked",true);$("#searchJobFilterStatusRunningCheck").attr("checked",true);$("#searchJobFilterStatusSuccessCheck").attr("checked",true);$("#searchJobFilterStatusFailedCheck").attr("checked",true);$("#searchJobFilterStatusIndetereminateCheck").attr("checked",true);$("#searchJobFilterStatusWaitCheck").attr("checked",true);_.each(b.paramViews,function(c){c.reset()});b.listing.refresh(b.allJobs)}});var InputTextViewSearch=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;"><b>'+a.param.name+"</b><br>"+a.getHtmlElem()+"</td></tr>");a.trElem=b.find("tr#"+a.param.id)},getHtmlElem:function(){var a=this;return'<input type="text" value="" style="text-align:center;" class="input-medium">'},getValue:function(){return this.trElem.find("input").val()},getStringValue:function(){return this.getValue()},reset:function(){this.trElem.find("input").val("")}});var InputNumberViewSearch=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;"><b>'+a.param.name+"</b><br>"+a.getHtmlElem()+"</td></tr>");a.trElem=b.find("tr#"+a.param.id)},getHtmlElem:function(){var a=this;return'<input type="text" value="" style="text-align:center;" class="input-medium">'},getValue:function(){return this.trElem.find("input").val()},getStringValue:function(){return this.getValue()},reset:function(){this.trElem.find("input").val("")}});var InputBooleanViewSearch=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;"><b>'+a.param.name+"</b><br>"+a.getHtmlElem()+"</td></tr>");a.trElem=b.find("tr#"+a.param.id)},getHtmlElem:function(){return'<select class="input-medium"><option value="">All</option><option value="true">Yes</option><option value="false">No</option></select>'},getValue:function(){return this.trElem.find("select").val()},getStringValue:function(){return this.getValue()+""},reset:function(){this.trElem.find('option[value=""]').attr("selected","selected")}});var InputListViewSearch=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;"><b>'+a.param.name+"</b><br>"+a.getHtmlElem()+"</td></tr>");a.trElem=b.find("tr#"+a.param.id);a.trElem.find(".icon-plus-sign").click(function(){console.log("Add entry");var c=$(this).parent().find("input").val();if(c.trim()!=""){$(this).parent().find("select").append('<option value="'+c+'">'+c+"</option>");$(this).parent().find("input").val("");$(this).parent().find("select").val(c)}});a.trElem.find(".icon-minus-sign").click(function(){var c=$(this).parent().find("select").val();console.log("delete entry:"+c);console.log("delete entry:"+$(this).parent().find("select").find('[value="'+c+'"]').length);$(this).parent().find("select").find('[value="'+c+'"]').remove()})},getHtmlElem:function(){var b=this;var c=b.getDefaultValue();var a='<div class="controls"><input type="text" value="" style="text-align:center;"><i class="icon-plus-sign"></i><select><option value="">All</option>';_.each(c,function(d){a=a+'<option value="'+d+'">'+d+"</option>"});a=a+'</select><i class="icon-minus-sign"></i></div></div>';return a},getDefaultValue:function(){return[]},getValue:function(){var a=this;var b=[];a.trElem.find("select").find("option").each(function(){b.push($(this).attr("value"))});return b.join(",")},getStringValue:function(){return this.getValue()},reset:function(){this.trElem.find('option[value=""]').attr("selected","selected")}});var InputDateViewSearch=Backbone.View.extend({param:null,parent:null,trElem:null,initialize:function(a){this.param=a.param;this.parent=a.parent},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td style="text-align:left;"><b>'+a.param.name+"</b><br>"+a.getHtmlElem()+"</td></tr>");a.trElem=b.find("tr#"+a.param.id);var c=a.trElem.find("#from"+a.param.id+", #to"+a.param.id).datepicker({defaultDate:"+1w",changeMonth:true,numberOfMonths:3,onSelect:function(g){var h=this.id=="from"+a.param.id?"minDate":"maxDate",d=$(this).data("datepicker"),f=$.datepicker.parseDate(d.settings.dateFormat||$.datepicker._defaults.dateFormat,g,d.settings);c.not(this).datepicker("option",h,f)}})},getHtmlElem:function(){var a=this;return'From <input type="text" id="from'+a.param.id+'" value="" style="text-align:center;" class="input-medium"> to <input type="text" id="to'+a.param.id+'" name="to"/>'},getValue:function(){var a=this;var d=this.trElem.find("#from"+a.param.id).datepicker("getDate");var b=this.trElem.find("#to"+a.param.id).datepicker("getDate");var c=d==null?"null":d.getTime();var f=b==null?"null":b.getTime();return c+"-"+f},getStringValue:function(){return this.getValue()},reset:function(){var a=this;this.trElem.find("#from"+a.param.id).datepicker("setDate",null);this.trElem.find("#to"+a.param.id).datepicker("setDate",null)}});var InputListDomainViewSearch=Backbone.View.extend({param:null,parent:null,trElem:null,multiple:true,collection:null,printAttribut:null,initialize:function(a){this.param=a.param;this.parent=a.parent;this.multiple=a.multiple;this.printAttribut=this.param.uriPrintAttribut},addRow:function(b){var a=this;b.append('<tr id="'+a.param.id+'"><td id="'+a.param.id+'" style="text-align:left;"><b>'+a.param.name+"</b><br></tr>");a.trElem=b.find("tr#"+a.param.id);console.log("### "+window.app.replaceVariable(a.param.uri)+" ###"+a.param.uriSortAttribut);a.collection=new SoftwareParameterModelCollection({uri:window.app.replaceVariable(a.param.uri),sortAttribut:a.param.uriSortAttribut});if(a.collection==undefined||(a.collection.length>0&&a.collection.at(0).id==undefined)){a.collection.fetch({success:function(d,c){console.log(d);a.collection=d;a.collection.comparator=function(f){return f.get(a.param.uriSortAttribut)};a.collection.sort();a.addHtmlElem()}})}else{a.addHtmlElem()}},addHtmlElem:function(){var a=this;a.trElem.find("td#"+a.param.id).append(a.getHtmlElem());var b=null;if(a.multiple){b=function(f,h,c){var g=[];$(c).each(function(){g.push($(this).attr("title"))});var d=g.join(", ");d=d.substring(0,Math.min(15,d.length));return f+" selected"}}else{b=function(f,h,c){if(f==0){return"0 selected"}var g=[];$(c).each(function(){g.push($(this).attr("title"))});var d=g.join(", ");d=d.substring(0,Math.min(10,d.length));return d}}a.trElem.find(".domainList").multiselect({autoOpen:false,minWidth:300,height:200,multiple:a.multiple,selectedText:b}).multiselectfilter();a.trElem.find("button").width("150");a.trElem.find(".ui-multiselect-menu").find("span").css("display","inline");a.trElem.find(".ui-multiselect-menu").find("input").css("display","inline");a.trElem.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").css("display","inline");a.trElem.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").eq(0).css("float","left");a.trElem.find(".ui-multiselect-menu").find(".ui-multiselect-header").find("li").eq(1).css("float","right");a.trElem.find(".ui-multiselect-menu").find("li").css("display","block");a.trElem.find("ul.ui-multiselect-checkboxes").css("overflow-y","scroll");a.trElem.find("ul.ui-multiselect-checkboxes").css("overflow-x","hidden");a.trElem.find(".domainList").multiselect("close")},getDefaultValue:function(){var a=this;return[]},getHtmlElem:function(){var b=this;var c="";var d=b.getDefaultValue();if(b.param.required){c="border-style: solid; border-width: 2px;"}else{c="border-style: dotted;border-width: 2px;"}var a='<select class="domainList" multiple="multiple">';b.collection.each(function(g){var f="";_.each(d,function(h){if(h==g.id){f='selected="selected"'}});a=a+"<option "+f+' value="'+g.id+'">'+g.get(b.printAttribut)+"</option>"});a=a+"</select>";return a},getValue:function(){var b=this;var a=b.trElem.find(".domainList").val();if(a==undefined){return[]}else{return a}},getStringValue:function(){var b=this;var a=b.trElem.find(".domainList").val();if(a==undefined){return""}else{return a.join(",")}},reset:function(){this.trElem.find(".domainList").multiselect("uncheckAll")}});var JobDeleteAllDataView=Backbone.View.extend({tagName:"div",initialize:function(a){this.project=a.project;this.dialog=null;this.container=a.container},doLayout:function(a){var b=this;b.dialog=new ConfirmDialogView({el:"#dialogs",template:_.template(a,this.model.toJSON()),dialogAttr:{dialogID:"#job-delete-confirm",backdrop:true}}).render();$("#jobDeleteDataButton"+b.model.id).hide();console.log("data loading...");new TaskModel({project:b.project.id}).save({},{success:function(d,c){console.log(c.task);$("#jobDataStat-"+b.model.id).append('<div id="task-'+c.task.id+'"></div>');var f=window.app.view.printTaskEvolution(c.task,$("#jobDataStat-"+b.model.id).find("#task-"+c.task.id),1000);new JobDataStatsModel({id:b.model.id,task:c.task.id}).fetch({success:function(h,g){console.log("data loaded:"+h.toJSON());clearInterval(f);$("#jobDataStat-"+b.model.id).empty();$("#jobDataStat-"+b.model.id).append("This job has all these data:<br>");$("#jobDataStat-"+b.model.id).append(h.get("reviewed")+" reviewed annotations<br>");$("#jobDataStat-"+b.model.id).append(h.get("annotations")+" annotations<br>");$("#jobDataStat-"+b.model.id).append(h.get("annotationsTerm")+" term added to annotations<br>");$("#jobDataStat-"+b.model.id).append(h.get("jobDatas")+" files<br>");if(h.get("reviewed")!=0){$("#jobDataStat-"+b.model.id).append('<br><br><div class="alert alert-warning" style="min-width: 300px;">You cannot delete job data with reviewed annotation!'+h.get("reviewed")+" reviewed annotation)")}else{$("#jobDeleteDataButton"+b.model.id).show();$("#jobDataStat-"+b.model.id).append("<br><br>The delete operation may take some time...")}},error:function(h,g){clearInterval(f);console.log("error getting job data stat")}})},error:function(d,c){var f=$.parseJSON(c.responseText);window.app.view.message("Task",f.errors,"error")}});console.log("button listener...");$("#jobDeleteDataCancelButton"+b.model.id).click(function(c){c.preventDefault();b.dialog.close();return false});$("#jobDeleteDataButton"+b.model.id).click(function(c){c.preventDefault();$("#jobDataStat-"+b.model.id).empty();$("#jobDataStat-"+b.model.id).append('<div class="alert alert-info" ><i class="icon-refresh"/> Deleting all data...this may take some time...</div>');new TaskModel({project:b.project.id}).save({},{success:function(g,f){var d=f.task;$("#jobDataStat-"+b.model.id).append('<div id="task-'+d.id+'"></div>');var h=window.app.view.printTaskEvolution(d,$("#jobDataStat-"+b.model.id).find("#task-"+d.id),1000);new JobDataStatsModel({id:b.model.id,task:d.id}).destroy({success:function(k,i){clearInterval(h);$("#jobDataStat-"+b.model.id).find("#task-"+d.id).empty();window.app.view.message("Project",i.message,"success");b.dialog.close();b.container.refresh()},error:function(k,i){clearInterval(h);var l=$.parseJSON(i.responseText);window.app.view.message("Job data",l.errors[0],"error")}})},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Task",g.errors,"error")}});return false});return this},render:function(){console.log("render");var a=this;require(["text!application/templates/processing/JobDeleteData.tpl.html"],function(b){a.doLayout(b)})}});var RetrievalAlgoResult=Backbone.View.extend({width:null,project:null,terms:null,jobs:null,software:null,initialize:function(a){this.terms=window.app.status.currentTermsCollection;this.project=a.project;this.jobs=a.jobs;this.software=a.software},render:function(){var a=this;require(["text!application/templates/processing/RetrievalAlgoResult.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(c){var b=this;var d=((($(b.el).width()-125)/2))+"px";var a="400px";var f=_.template(c,{width:d,height:a});b.width=d;console.log($(b.el));$(b.el).empty();$(b.el).append(f);console.log("StatsRetrievalSuggestionWorstTermWithSuggest:"+b.model.id);new StatsRetrievalSuggestionWorstTermWithSuggest({job:b.model.id}).fetch({success:function(h,g){console.log("StatsRetrievalSuggestionWorstTermWithSuggest model:");console.log(h);b.drawWorstTermTable(h,g,b.terms)}});console.log("StatsRetrievalSuggestionWorstTermModel");new StatsRetrievalSuggestionWorstTermModel({job:b.model.id}).fetch({success:function(h,g){b.drawWorstTermPieChart(h,g,b.terms)}});console.log("StatsRetrievalSuggestionWorstAnnotationModel");new StatsRetrievalSuggestionWorstAnnotationModel({job:b.model.id}).fetch({success:function(h,g){b.drawWorstAnnotationsTable(h,g,b.terms)}});console.log("StatsRetrievalSuggestionEvolutionModel");new StatsRetrievalSuggestionEvolutionModel({job:b.model.id}).fetch({success:function(h,g){b.drawAVGEvolution(h,g)}})},reduceTermName:function(b){var a="";var d=b.split(" ");for(var c=0;c<d.length;c++){a=a+d[c].substring(0,Math.min(4,d[c].length))+". "}return a},drawWorstTermTable:function(c,b,d){var f=c.get("worstTerms");if(f==undefined){$(a.el).find("#worstTermListPanel").hide();return}var a=this;require(["text!application/templates/dashboard/WorstTermList.tpl.html"],function(i){$(a.el).find("#worstTermList").empty();d.each(function(n){var p=_.template(i,{term:n.get("name"),id:n.id,idProject:a.project.id});var k=3;var o=f[n.id];if(o.length>0){$(a.el).find("#worstTermList").append(p)}for(var m=0;m<o.length&&m<k;m++){for(var l in o[m]){if(l!=n.id){var q="term"+n.id+"suggest"+l;$(a.el).find("#list-suggest-"+n.id).append("<a role='button'  data-toggle='modal' href='#"+q+"Modal' id=\""+q+'"><b>'+d.get(l).get("name")+"</b> ("+o[m][l]+"%) </a>");a.linkAnnotationMapWithBadTerm($("#"+q),n.id,l,d,q+"Modal")}else{$(a.el).find("#success-suggest-"+n.id).html("");$(a.el).find("#success-suggest-"+n.id).append(o[m][l])}}}});$(a.el).find("#worstTermList").append("<br><b>Average:</b> "+(c.get("avg")*100).toFixed(2)+"%<br>");$(a.el).find("#worstTermList").append("<b>Average (per class):</b> "+(c.get("avgMiddlePerClass")*100).toFixed(2)+"%<br>");$(a.el).find("#worstTermList").append('<br><a role="button" data-toggle="modal" href="#confusionMatrixModal" id="matrix-suggest" class="btn">View confusion matrix</a>');$(a.el).find("#worstTermList").append('<a href="#tabs-annotations-'+a.project.id+"-all-"+a.model.get("userJob")+'" class="btn">View predicted galleries</a>');var g=function(){$(a.el).find("#userRetrievalSuggestMatrixDataTable").empty();new StatsRetrievalSuggestionMatrixModel({job:a.model.id}).fetch({success:function(l,k){console.log("build matrix");a.drawRetrievalSuggestionTable(l,k,d);console.log("build dialog:"+$("#userRetrievalSuggestMatrixDataTable").length)}})};var h=new CustomModal({idModal:"confusionMatrixModal",button:$("#matrix-suggest"),header:"Confusion Matrix",body:"<div id='userRetrievalSuggestMatrixDataTable'></div>",width:Math.round($(window).width()-75),height:Math.round($(window).height()-75),callBack:g});h.addButtons("closeHotKeys","Close",true,true)})},linkAnnotationMapWithBadTerm:function(c,d,h,g,a){var b=this;console.log("click");console.log("modalId="+a);console.log("$item="+c.html());var f=new CustomModal({idModal:a,button:c,header:"",body:"<div id='annotationQuestionable'></div>",width:Math.round($(window).width()-200),height:Math.round($(window).height()-200),callBack:function(){console.log("callBack");new AnnotationCollection({project:b.project.id,term:d,suggestedTerm:h,jobForTermAlgo:b.model.get("userJob")}).fetch({success:function(l,k){console.log("AnnotationQuestionableView");var i=new AnnotationQuestionableView({model:l,container:b,el:"#annotationQuestionable",terms:g,term:d,suggestTerm:h}).render()}})}});f.addButtons("closeCompare","Close",false,true)},tableElement:"userRetrievalSuggestMatrixDataTable",tableElementHtml:"userRetrievalSuggestMatrixDataTableHtml",addLine:function(a){$("#userRetrievalSuggestMatrixDataTableHtml").append('<tr onMouseOver="this.className=\'confusionMatrixBadValueHover\'" id="'+a+'" class="confusionMatrixRow"></tr>')},addCell:function(a,b,d,c){this.addCell(a,b,d,c,"")},addCell:function(b,c,h,d,g){var a="confusionMatrix"+b+"-"+c+"Modal";$("#userRetrievalSuggestMatrixDataTableHtml").find("tr#"+b).append('<td id="'+c+'"title="'+g+'" class="'+d+'"><a data-Toggle="modal" href="#'+a+'">'+h+"</a></td>");var f=$("#userRetrievalSuggestMatrixDataTableHtml").find("tr#"+b).find("td#"+c);if(g!=""&&g!=undefined){f.tooltip()}if(b>0&&c>0&&h!=""){this.linkAnnotationMapWithBadTerm(f.find("a"),b,c,this.terms,a)}},drawRetrievalSuggestionTable:function(model,response,terms){var self=this;this.terms=terms;var matrixJSON=model.get("matrix");if(matrixJSON==undefined){return}var matrix=eval("("+matrixJSON+")");$("#userRetrievalSuggestMatrixDataTable").append('<table id="userRetrievalSuggestMatrixDataTableHtml" class="table table-condensed"></table>');self.addLine(-1);self.addCell(-1,-1,"X","confusionMatrixHeader");for(var i=1;i<matrix[0].length-1;i++){var termName="";var term=terms.get(matrix[0][i]);if(term!=undefined){termName=self.reduceTermName(term.get("name"))}self.addCell(-1,term.id,termName,"confusionMatrixHeader",term.get("name"));self.addLine(term.id);self.addCell(term.id,-1,termName,"confusionMatrixHeader",term.get("name"))}self.addCell(-1,"total","total","confusionMatrixHeader");for(i=0;i<matrix.length-1;i++){var indx=i+1;for(j=0;j<matrix[indx].length;j++){if(indx==j){self.addCell(matrix[0][j],matrix[indx][0],"<a>"+matrix[indx][j]+"</a>","confusionMatrixDiagonal","Suggest Term "+terms.get(matrix[0][j]).get("name")+" for annotation "+terms.get(matrix[indx][0]).get("name"))}else{if(j==0){var idTerm=matrix[indx][j];var term=terms.get(idTerm);self.addCell(matrix[0][j],matrix[indx][0],term.get("name"),"confusionMatrixHeader")}else{if(j==matrix[indx].length-1){}else{if(matrix[indx][j]>0&&j>0){self.addCell(matrix[indx][0],matrix[0][j],"<a>"+matrix[indx][j]+"</a>","confusionMatrixBadValue","Suggest Term "+terms.get(matrix[0][j]).get("name")+" for annotation "+terms.get(matrix[indx][0]).get("name"))}else{self.addCell(matrix[indx][0],matrix[0][j],"","confusionMatrixSimple","Suggest Term "+terms.get(matrix[0][j]).get("name")+" for annotation "+terms.get(matrix[indx][0]).get("name"))}}}}}}var indx=matrix.length-1;for(i=0;i<matrix.length;i++){var printValue="";var value=matrix[i][matrix[i].length-1];if(value!=-1){printValue=Math.round(value*100)+"%"}self.addCell(matrix[0][i],"total",printValue,"confusionMatrixSimple")}},drawWorstTermPieChart:function(c,b,f){$(this.el).find("#worstTermprojectPieChart").empty();var h=c.get("worstTerms");if(h==undefined){$(this.el).find("#worstTermPieChartPanel").hide();return}var g=new google.visualization.DataTable();g.addColumn("string","Term");g.addColumn("number","Number of questionable annotations");g.addRows(h.length);var a=[];for(var d=0;d<h.length;d++){a.push(h[d].color);g.setValue(d,0,h[d].name);g.setValue(d,1,h[d].rate)}new google.visualization.PieChart($(this.el).find("#worstTermprojectPieChart")[0]).draw(g,{width:this.width,height:350,title:"",backgroundColor:"white",colors:a})},drawWorstAnnotationsTable:function(c,b,f){var d=c.get("worstAnnotations");if(d==undefined){$(a.el).find("#worstAnnotationPanel").hide();return}var a=this;require(["text!application/templates/dashboard/SuggestedAnnotationTerm.tpl.html"],function(l){$(a.el).find("#worstannotationitem").empty();if(d.length==0){$(a.el).find("#worstannotationitem").append("You must run Retrieval Validate Algo for this project...")}for(var k=0;k<d.length;k++){var q=d[k];var n=Math.round(q.rate*100)-1+"%";console.log("annotationTerm.image="+q.image);var p=f.get(q.term).get("name");var g=f.get(q.expectedTerm).get("name");var r="Annotation "+q.annotation+" is predicted "+p+" instead of "+g;var o="block";var m=q.cropURL;var h=_.template(l,{idProject:a.project.id,idAnnotation:q.annotation,idImage:q.image,icon:"add.png",text:r,rate:n,cropURL:m,cropStyle:o});$(a.el).find("#worstannotationitem").append(h)}})},drawAVGEvolution:function(l,f){var p=this;var o=l.get("evolution");if(o==undefined){$(p.el).find("#avgEvolutionLineChartPanel").hide();return}var h=new google.visualization.DataTable();h.addColumn("date","Date");h.addColumn("number","Number of user annotations");h.addColumn("number","Success rate (%)");var d=0;var a=new Date();a.setTime(this.model.get("created"));for(var k=0;k<o.length;k++){var c=new Date();c.setTime(o[k].date);if(a.getTime()==c.getTime()){d=k}var n=0;if(o[k].avg!=-1){n=(o[k].avg*100)}h.addRow([c,o[k].size,n])}var b=Math.round($(window).width()/2-150);var g=new google.visualization.LineChart($(this.el).find("#avgEvolutionLineChart")[0]);g.draw(h,{colors:["#dc3912","#3366cc"],title:"",width:this.width,height:350,vAxes:{0:{label:"Y1"},1:{label:"Y2"}},vAxis:{title:"",minValue:0,maxValue:100},hAxis:{title:"Time"},backgroundColor:"white",seriesType:"line",series:{0:{targetAxisIndex:0},1:{type:"area",targetAxisIndex:1}},lineWidth:1});g.setSelection([{row:d,column:1}]);var m=function(){var s=g.getSelection()[0]["row"];var i=g.getSelection()[0]["column"];var q=new Date();q.setTime(o[s].date);if(p.jobs!=null){var r=null;p.jobs.each(function(u){var t=new Date();t.setTime(u.get("created"));if(t.getTime()==q.getTime()){r=u}});window.location="#tabs-algos-"+p.project.id+"-"+p.software.id+"-"+r.id}};google.visualization.events.addListener(g,"select",m)}});var EvolutionAlgoResult=Backbone.View.extend({width:null,project:null,annotations:null,terms:null,jobs:null,software:null,initialize:function(a){this.annotations=window.app.status.currentAnnotationsCollection;this.terms=window.app.status.currentTermsCollection;this.project=a.project;this.jobs=a.jobs;this.software=a.software},render:function(){var a=this;require(["text!application/templates/processing/EvolutionAlgoResult.tpl.html"],function(b){a.loadResult(b)});return this},loadResult:function(d){var c=this;var f=((($(c.el).width()-125)))+"px";var b="400px";var g=_.template(d,{width:f,height:b});c.width=f;console.log($(c.el));$(c.el).empty();$(c.el).append(g);console.log("StatsRetrievalSuggestionEvolutionModel");new StatsRetrievalEvolutionModel({job:c.model.id}).fetch({success:function(i,h){c.drawAVGEvolution(i,h)}});var a=$(c.el).find("#avgEvolutionLineChartByTermSelect");a.empty();this.terms.each(function(h){a.append('<option value="'+h.id+'">'+h.get("name")+"</option>")});a.change(function(){c.drawAVGEvolutionByTermAction()});c.drawAVGEvolutionByTermAction()},drawAVGEvolution:function(l,f){var p=this;var o=l.get("evolution");if(o==undefined){$(p.el).find("#avgEvolutionLineChartPanel").hide();return}var h=new google.visualization.DataTable();h.addColumn("date","Date");h.addColumn("number","Number of user annotations");h.addColumn("number","Success rate (%)");var d=0;var a=new Date();a.setTime(this.model.get("created"));for(var k=0;k<o.length;k++){var c=new Date();c.setTime(o[k].date);if(a.getTime()==c.getTime()){d=k}var n=0;if(o[k].avg!=-1){n=(o[k].avg*100)}h.addRow([c,o[k].size,n])}var b=Math.round($(window).width()/2-150);var g=new google.visualization.LineChart($(this.el).find("#avgEvolutionLineChart")[0]);g.draw(h,{colors:["#dc3912","#3366cc"],title:"",width:this.width,height:350,vAxes:{0:{label:"Y1"},1:{label:"Y2"}},vAxis:{title:"",minValue:0,maxValue:100},hAxis:{title:"Time"},backgroundColor:"white",seriesType:"line",series:{0:{targetAxisIndex:0},1:{type:"area",targetAxisIndex:1}},lineWidth:1});g.setSelection([{row:d,column:1}]);var m=function(){var s=g.getSelection()[0]["row"];var i=g.getSelection()[0]["column"];var q=new Date();q.setTime(o[s].date);if(p.jobs!=null){var r=null;p.jobs.each(function(u){var t=new Date();t.setTime(u.get("created"));if(t.getTime()==q.getTime()){r=u}});window.location="#tabs-algos-"+p.project.id+"-"+p.software.id+"-"+r.id}};google.visualization.events.addListener(g,"select",m)},drawAVGEvolutionByTermAction:function(){var b=this;var a=$(b.el).find("#avgEvolutionLineChartByTermSelect").val();new StatsRetrievalEvolutionModel({job:b.model.id,term:a}).fetch({success:function(d,c){b.drawAVGEvolutionByTerm(d,c)}})},drawAVGEvolutionByTerm:function(l,f){var p=this;var o=l.get("evolution");console.log("drawAVGEvolutionByTerm.evolution="+o);if(o==undefined){$(p.el).find("#avgEvolutionLineChartByTerm").text("No data for this term!");return}$(p.el).find("#avgEvolutionLineChartByTerm").empty();var h=new google.visualization.DataTable();h.addColumn("date","Date");h.addColumn("number","Number of user annotations");h.addColumn("number","Success rate (%)");var d=0;var a=new Date();a.setTime(this.model.get("created"));for(var k=0;k<o.length;k++){var c=new Date();c.setTime(o[k].date);if(a.getTime()==c.getTime()){d=k}var n=0;if(o[k].avg!=-1){n=(o[k].avg*100)}h.addRow([c,o[k].size,n])}var b=Math.round($(window).width()/2-150);var g=new google.visualization.LineChart($(this.el).find("#avgEvolutionLineChartByTerm")[0]);g.draw(h,{colors:["#dc3912","#3366cc"],title:"",width:this.width,height:350,vAxes:{0:{label:"Y1"},1:{label:"Y2"}},vAxis:{title:"",minValue:0,maxValue:100},hAxis:{title:"Time"},backgroundColor:"white",seriesType:"line",series:{0:{targetAxisIndex:0},1:{type:"area",targetAxisIndex:1}},lineWidth:1});g.setSelection([{row:d,column:1}]);var m=function(){var s=g.getSelection()[0]["row"];var i=g.getSelection()[0]["column"];var q=new Date();q.setTime(o[s].date);if(p.jobs!=null){var r=null;p.jobs.each(function(u){var t=new Date();t.setTime(u.get("created"));if(t.getTime()==q.getTime()){r=u}});window.location="#tabs-algos-"+p.project.id+"-"+p.software.id+"-"+r.id}};google.visualization.events.addListener(g,"select",m)}});var DefaultResult=Backbone.View.extend({project:null,terms:null,jobs:null,software:null,initialize:function(a){this.terms=window.app.status.currentTermsCollection;this.project=a.project;this.jobs=a.jobs;this.software=a.software},render:function(){var a=this;require(["text!application/templates/processing/DefaultResult.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(a){var b=_.template(a,{});$(this.el).append(b)}});var DownloadFiles=Backbone.View.extend({project:null,terms:null,jobs:null,software:null,initialize:function(a){this.terms=window.app.status.currentTermsCollection;this.project=a.project;this.jobs=a.jobs;this.software=a.software},render:function(){var a=this;require(["text!application/templates/processing/DownloadFiles.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var b=this;var f=_.template(c,{});$(this.el).append(f);var d=function(){new JobDataCollection({job:b.model.id}).fetch({success:function(h,g){$("#jobDataResult").find("tbody").empty();h.each(function(i){console.log("data="+i+" "+h.length);$("#jobDataResult").find("tbody").append('<tr id="'+i.id+'"></tr>');var k=$("#jobDataResult").find("tbody").find("tr#"+i.id);k.append("<td>"+i.get("filename")+"</td>");k.append("<td>"+i.get("key")+"</td>");k.append("<td>"+b.convertSize(i.get("size"))+"</td>");k.append('<td><a href="/api/jobdata/'+i.id+'/view" class="badge badge-info">'+i.get("filename")+"</a></td>");k.append('<td><a href="/api/jobdata/'+i.id+'/download" class="badge badge-info">'+i.get("filename")+"</a></td>")})}})};d();var a=setInterval(d,5000);$(window).bind("hashchange",function(){clearInterval(a)})},convertSize:function(a){var c=["Bytes","KB","MB","GB","TB"];if(a==0){return"n/a"}var b=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,b),2)+" "+c[b]}});var SideBarPanel=Backbone.View.extend({initToggle:function(f,d,c,g){var b=this;c.click(function(h){if(d.is(":hidden")){b.show($(this),d,g)}else{b.hide($(this),d,g)}});if(g&&localStorage.getObject(g)){var a=localStorage.getObject(g);if(a.visible){this.show(c,d,g)}else{this.hide(c,d,g)}}},show:function(b,a,c){if(c){localStorage.setObject(c,{visible:true})}b.removeClass("icon-plus");b.addClass("icon-minus");a.show()},hide:function(b,a,c){if(c){localStorage.setObject(c,{visible:false})}b.addClass("icon-plus");b.removeClass("icon-minus");a.hide()}});var AnnotationStatus={NO_TERM:"NO_TERM",MULTIPLE_TERM:"MULTIPLE_TERM",TOO_SMALL:"TOO_SMALL",REVIEW:"REVIEW"};var AnnotationLayerUtils=AnnotationLayerUtils||{};AnnotationLayerUtils.createFeatureFromAnnotation=function(b){var i=b.location||b.get("location");var d=b.count?b.count:"";var f=b.ratio?b.ratio:undefined;var c=b.term||b.get("term");var h=new OpenLayers.Format.WKT();var k=h.read(i);var g=k.geometry;var l=new OpenLayers.Feature.Vector(g,{zIndex:999});var a=AnnotationStatus.NO_TERM;if(c.length>1){a=AnnotationStatus.MULTIPLE_TERM}else{if(c.length==1){a=c[0]}}l.attributes={idAnnotation:b.id,measure:"NO",listener:"NO",importance:10,term:a,count:d,opacity:f};return l};OpenLayers.Format.Cytomine=OpenLayers.Class(OpenLayers.Format,{read:function(d){var a=this;var b=[];var c=d.collection;_.each(c,function(f){if(_.indexOf(a.annotationLayer.featuresHidden,f.id)!=-1){return}var g=AnnotationLayerUtils.createFeatureFromAnnotation(f);b.push(g)});return b}});var AnnotationLayer=function(c,i,q,f,p,g,b,m){var o=this;this.ontologyTreeView=p;this.pointRadius=window.app.view.isMobile?12:8;this.name=c;this.map=b;this.imageID=i;this.userID=q;this.reviewLayer=(c=="REVIEW")||(c=="Review layer");this.reviewMode=m;var l=[new OpenLayers.Rule({symbolizer:{strokeColor:"#00FF00",strokeWidth:2},elseFilter:true})];var a=$.extend(true,{},OpenLayers.Feature.Vector.style["default"]);a.label="${getLabel}";a.fillOpacity="${getOpacity}";a.strokeWidth=3;a.fillColor="#EEEEEE";a.strokeColor="${getStrokeColor}";a.strokeWidth=3;a.pointRadius=this.pointRadius;a.graphicZIndex=999;var n=new OpenLayers.Style(a,{context:{getLabel:function(r){if(r.geometry&&r.geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"){var s=r.attributes.count;if(s==undefined){s=""}return s}else{return""}},getOpacity:function(r){return 0.6},getStrokeColor:function(s){var r=s.attributes.opacity;if(r==undefined){return"#000000"}if(r<0.33){return"#B94A48"}if(r<0.66){return"#C09853"}return"#468847"}}});n.addRules(l);var d=null;d=new OpenLayers.Style({fillColor:"#EEEEEE",fillOpacity:0.8,strokeColor:"#00FF00",strokeWidth:3,pointRadius:this.pointRadius,graphicZIndex:14});d.addRules(l);var k=new OpenLayers.StyleMap({"default":n,select:d});console.log("reviewMode="+m+" this.reviewLayer="+this.reviewLayer);if(this.reviewLayer){k.styles["default"].addRules(l);k.addUniqueValueRules("default","term",this.getSymbolizerReview(false));k.styles.select.addRules(l);k.addUniqueValueRules("select","term",this.getSymbolizerReview(true))}else{if(!m){k.styles["default"].addRules(l);k.addUniqueValueRules("default","term",this.getSymbolizer(false));k.styles.select.addRules(l);k.addUniqueValueRules("select","term",this.getSymbolizer(true))}else{k.styles["default"].addRules(l);k.addUniqueValueRules("default","term",this.getSymbolizerReviewNotReviewLayer(false));k.styles.select.addRules(l);k.addUniqueValueRules("select","term",this.getSymbolizerReviewNotReviewLayer(true))}}var h=new AnnotationCollection({user:this.userID,image:this.imageID,notReviewedOnly:m,reviewed:this.reviewLayer,showWKT:true,showTerm:true,kmeans:true}).url().replace("json","jsonp");console.log("Get annotations for layers:"+h);this.vectorsLayer=new OpenLayers.Layer.Vector(this.name,{rendererOptions:{zIndexing:true},strategies:[new OpenLayers.Strategy.BBOX({resFactor:1,ratio:2})],protocol:new OpenLayers.Protocol.Script({url:h,format:new OpenLayers.Format.Cytomine({annotationLayer:this}),callbackKey:"callback"}),styleMap:k});this.vectorsLayer.strategies[0].activate();this.controls=null;this.dialog=null;this.rotate=false;this.fill=false;this.featuresHidden=[];this.resize=false;this.drag=false;this.irregular=false;this.aspectRatio=false;this.browseImageView=g;this.map=g.map;this.popup=null;this.hoverControl=null;this.triggerUpdateOnUnselect=true;this.isOwner=null;this.deleteOnSelect=false;this.measureOnSelect=false;this.magicOnClick=false;this.cpt=0};AnnotationLayer.prototype={defaultStrokeColor:"#000000",selectedStrokeColor:"#00FF00",getSymbolizer:function(c){var d=this.defaultStrokeColor;if(c){d=this.selectedStrokeColor}var b={};var a=this;b[AnnotationStatus.NO_TERM]={fillColor:"#EEEEEE",strokeWidth:3,pointRadius:this.pointRadius};b[AnnotationStatus.MULTIPLE_TERM]={fillColor:"#CCCCCC",strokeWidth:3,pointRadius:this.pointRadius};b[AnnotationStatus.TOO_SMALL]={fillColor:"#FF0000",strokeWidth:5,pointRadius:this.pointRadius};window.app.status.currentTermsCollection.each(function(f){b[f.id]={fillColor:f.get("color"),strokeWidth:3,pointRadius:a.pointRadius}});return b},getSymbolizerReview:function(c){var d=this.defaultStrokeColor;if(c){d=this.selectedStrokeColor}var b={};var a=this;b[AnnotationStatus.NO_TERM]={fillColor:"#5BB75B",strokeWidth:3,pointRadius:this.pointRadius};b[AnnotationStatus.MULTIPLE_TERM]={fillColor:"#5BB75B",strokeWidth:3,pointRadius:this.pointRadius};b[AnnotationStatus.TOO_SMALL]={fillColor:"#5BB75B",strokeWidth:5,pointRadius:this.pointRadius};b[AnnotationStatus.REVIEW]={fillColor:"#5BB75B",strokeWidth:5,pointRadius:this.pointRadius};window.app.status.currentTermsCollection.each(function(f){b[f.id]={fillColor:"#5BB75B",strokeWidth:3,pointRadius:a.pointRadius}});return b},getSymbolizerReviewNotReviewLayer:function(c){var d=this.defaultStrokeColor;if(c){d=this.selectedStrokeColor}var b={};var a=this;b[AnnotationStatus.NO_TERM]={fillColor:"#BD362F",strokeWidth:3,pointRadius:this.pointRadius};b[AnnotationStatus.MULTIPLE_TERM]={fillColor:"#BD362F",strokeWidth:3,pointRadius:this.pointRadius};b[AnnotationStatus.TOO_SMALL]={fillColor:"#BD362F",strokeWidth:5,pointRadius:this.pointRadius};b[AnnotationStatus.REVIEW]={fillColor:"#BD362F",strokeWidth:5,pointRadius:this.pointRadius};window.app.status.currentTermsCollection.each(function(f){b[f.id]={fillColor:"#BD362F",strokeWidth:3,pointRadius:a.pointRadius}});return b},registerEvents:function(b){var a=this;this.vectorsLayer.events.on({clickFeature:function(c){},onSelect:function(c){},featureselected:function(c){console.log("featureselected");if(!a.measureOnSelect){a.ontologyTreeView.idAnnotation=c.feature.attributes.idAnnotation;if(!a.reviewLayer){a.ontologyTreeView.refresh(c.feature.attributes.idAnnotation)}if(a.deleteOnSelect==true){a.removeSelection()}else{a.showPopup(b,c)}}else{a.showPopupMeasure(b,c)}},featureunselected:function(c){console.log("featureunselected on "+a.name);if(a.measureOnSelect){a.vectorsLayer.removeFeatures(c.feature)}if(a.dialog!=null){a.dialog.destroy()}a.ontologyTreeView.clear();a.ontologyTreeView.clearAnnotation();a.browseImageView.showAnnotationInReviewPanel(null);a.clearPopup(b,c);a.vectorsLayer.drawFeature(c.feature)},featureadded:function(c){if(!a.measureOnSelect){if(c.feature.attributes.listener!="NO"){c.feature.attributes.measure="YES";if(a.browseImageView.freeHandUpdateAdd){a.correctAnnotation(c.feature,false)}else{if(a.browseImageView.freeHandUpdateRem){a.correctAnnotation(c.feature,true)}else{a.addAnnotation(c.feature)}}}}else{a.controls.select.unselectAll();a.controls.select.select(c.feature)}},sketchcomplete:function(c){if(a.triggerUpdateOnUnselect){a.updateAnnotation(c.feature)}},featuremodified:function(c){if(a.triggerUpdateOnUnselect){a.updateAnnotation(c.feature)}},onDelete:function(c){},moveend:function(){a.clearPopup()}})},initControls:function(b,a){console.log("initControls");this.controls={freehand:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Polygon,{handlerOptions:{freehand:true,holeModifier:"altKey"}}),point:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Path),polygon:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Polygon,{handlerOptions:{holeModifier:"altKey"}}),regular:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:5,holeModifier:"altKey"}}),modify:new OpenLayers.Control.ModifyFeature(this.vectorsLayer),select:a};this.controls.freehand.freehand=true;b.initTools(this.controls)},loadAnnotations:function(a){var b=this;console.log("loadAnnotations="+this.vectorsLayer.protocol.options);a.addVectorLayer(this,this.userID);a.layerLoadedCallback(b)},addFeature:function(a){this.vectorsLayer.addFeatures(a)},selectFeature:function(a){this.controls.select.unselectAll();this.controls.select.select(a)},removeFeature:function(a){var b=this.getFeature(a);this.vectorsLayer.removeFeatures(b);this.ontologyTreeView.clearAnnotation();this.ontologyTreeView.clear()},getFeature:function(a){var b=this.vectorsLayer.getFeaturesByAttribute("idAnnotation",a);if(_.isArray(b)&&_.size(b)>0){return b[0]}return null},removeSelection:function(){for(var b in this.vectorsLayer.selectedFeatures){var a=this.vectorsLayer.selectedFeatures[b];this.removeAnnotation(a)}},clearPopup:function(d,a){var b=this;var c=$("#"+b.browseImageView.divId).find("#annotationDetailPanel"+b.browseImageView.model.id);c.empty();c.hide()},hideFeature:function(b){var a=b.attributes.idAnnotation;if(_.indexOf(this.featuresHidden,a)==-1){this.featuresHidden.push(a)}this.vectorsLayer.refresh()},showFeature:function(a){this.featuresHidden=_.without(this.featuresHidden,a);this.vectorsLayer.refresh()},showPopup:function(c,a){var b=this;new AnnotationPopupPanel({browseImageView:b.browseImageView,idAnnotation:a.feature.attributes.idAnnotation,model:b.browseImageView.model,el:b.browseImageView.el}).render()},showPopupMeasure:function(c,a){var b=this;require(["text!application/templates/explorer/PopupMeasure.tpl.html"],function(f){if(a.feature.popup!=null){return}$("div#measure").remove();var d=b.browseImageView.model.get("resolution");var h=a.feature.geometry.getLength();if(d!=undefined&&d!=null){h*=d;h=Math.round(h*1000)/1000;h+=" µm"}else{h+=" pixels"}var g=_.template(f,{length:h});b.popup=new OpenLayers.Popup("measure",new OpenLayers.LonLat(a.feature.geometry.getBounds().right+50,a.feature.geometry.getBounds().bottom+50),new OpenLayers.Size(200,60),g,false);b.popup.setBackgroundColor("transparent");b.popup.setBorder(0);b.popup.padding=0;a.feature.popup=b.popup;b.popup.feature=a.feature;c.addPopup(b.popup)})},enableHightlight:function(){},disableHightlight:function(){},correctAnnotation:function(d,a){var b=this;console.log("correctAddAnnotation");var g=new OpenLayers.Format.WKT();var f=g.write(d);console.log("geomwkt="+f);console.log("geomwkt="+f.indexOf("LINESTRING"));if(f.indexOf("LINESTRING")!=-1){b.vectorsLayer.removeFeatures([d]);return}var c=new AnnotationCorrectionModel({location:f,image:this.imageID,review:b.reviewMode,remove:a});c.save({},{success:function(h,i){window.app.view.message("Annotation updated","Annotation updated with success","success");b.vectorsLayer.refresh();if(b.reviewMode){b.browseImageView.refreshReviewLayer()}b.vectorsLayer.removeFeatures([d])},error:function(i,h){var k=$.parseJSON(h.responseText);window.app.view.message("Cannot correct annotation","error:"+k.errors,"error");b.vectorsLayer.removeFeatures([d])}})},addAnnotation:function(d){console.log("addAnnotation");var c=this;var b=this;var h=new OpenLayers.Format.WKT();var g=h.write(d);var f=c.ontologyTreeView.getTermsChecked();var a=new AnnotationModel({name:"",location:g,image:this.imageID,term:f});if(b.reviewMode&&!b.browseImageView.reviewPanel.isLayerPrinted(window.app.status.user.id)){window.app.view.message("Add annotation","You must add your layer to add new annotation!","error");b.vectorsLayer.removeFeatures([d]);return}a.save({},{success:function(i,k){new AnnotationModel({id:k.annotation.id}).fetch({success:function(l,m){var o=m.message;b.vectorsLayer.removeFeatures([d]);var r=AnnotationLayerUtils.createFeatureFromAnnotation(l);b.addFeature(r);b.controls.select.unselectAll();b.controls.select.select(r);var n=l.get("cropURL");var q=_.template("<img src='<%=   url %>' alt='<%=   alt %>' style='max-width: 175px;max-height: 175px;' />",{url:n,alt:n});var p=_.template("<p><%=   message %></p><div><%=   cropImage %></div>",{message:o,cropImage:q});window.app.view.message("Annotation added",p,"success")}})},error:function(k,i){var l=$.parseJSON(i.responseText);window.app.view.message("Add annotation","error:"+l.errors,"error")}})},removeAnnotation:function(c){c.destroyPopup();var a=c.attributes.idAnnotation;this.removeFeature(c);this.controls.select.unselectAll();this.vectorsLayer.removeFeatures([c]);var b=this;new AnnotationModel({id:c.attributes.idAnnotation}).destroy({success:function(f,d){window.app.view.message("Annotation",d.message,"success");b.browseImageView.refreshAnnotationTabs(undefined)},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Annotation",g.errors,"error")}})},updateAnnotation:function(b){if(b.attributes.idAnnotation==undefined){return}var a=this;var d=new OpenLayers.Format.WKT();var c=d.write(b);new AnnotationModel({id:b.attributes.idAnnotation}).fetch({success:function(g,f){g.save({location:c},{success:function(h,i){var k=i.message;var l=_.template("<p><%=   message %></p>",{message:k});window.app.view.message("Annotation edited",l,"success")},error:function(i,h){var k=$.parseJSON(h.responseText);window.app.view.message("Annotation",k.errors,"")}})}})},toggleRotate:function(){this.resize=false;this.drag=false;this.rotate=true;this.fill=false;this.updateControls();this.toggleControl("modify")},toggleFill:function(){this.resize=false;this.drag=false;this.rotate=false;this.fill=true;this.updateControls();this.toggleControl("modify")},toggleResize:function(){this.resize=true;this.drag=false;this.rotate=false;this.fill=false;this.updateControls();this.toggleControl("modify")},toggleDrag:function(){this.resize=false;this.drag=true;this.rotate=false;this.fill=false;this.updateControls();this.toggleControl("modify")},toggleEdit:function(){this.resize=false;this.drag=false;this.rotate=false;this.fill=false;this.updateControls();this.toggleControl("modify")},toggleIrregular:function(){this.irregular=!this.irregular;this.updateControls()},toggleAspectRatio:function(){this.aspectRatio=!this.aspectRatio;this.updateControls()},setSides:function(a){this.sides=a;this.updateControls()},updateControls:function(){this.controls.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE;if(this.rotate){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.ROTATE}if(this.resize){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.RESIZE;if(this.aspectRatio){this.controls.modify.mode&=~OpenLayers.Control.ModifyFeature.RESHAPE}}if(this.drag){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.DRAG}if(this.rotate||this.drag){this.controls.modify.mode&=~OpenLayers.Control.ModifyFeature.RESHAPE}this.controls.regular.handler.sides=this.sides;this.controls.regular.handler.irregular=this.irregular},disableMeasureOnSelect:function(){var a=this;this.measureOnSelect=false;for(var c in this.vectorsLayer.features){var b=this.vectorsLayer.features[c];if(b.attributes.measure==undefined||b.attributes.measure=="YES"){a.vectorsLayer.removeFeatures(b);if(b.popup){a.popup.feature=null;a.map.removePopup(b.popup);b.popup.destroy();b.popup=null;a.popup=null}}}},toggleControl:function(a){this.deleteOnSelect=false;this.disableMeasureOnSelect();this.magicOnClick=false;for(key in this.controls){var d=this.controls[key];if(a==key||key=="select"){d.activate();console.log("Activate "+key);if(d==this.controls.modify){for(var c in this.vectorsLayer.selectedFeatures){var b=this.vectorsLayer.selectedFeatures[c];d.selectFeature(b)}}}else{d.deactivate();console.log("Desactivate "+key);if(d==this.controls.modify){for(var c in this.vectorsLayer.selectedFeatures){var b=this.vectorsLayer.selectedFeatures[c];d.unselectFeature(b)}}}}},annotationAdded:function(a){var b=this;var c=b.deleteOnSelect;b.deleteOnSelect=false;new AnnotationModel({id:a}).fetch({success:function(d){var f=AnnotationLayerUtils.createFeatureFromAnnotation(d);b.addFeature(f);b.selectFeature(f);b.controls.select.activate();b.deleteOnSelect=c}})},annotationRemoved:function(a){this.removeFeature(a)},annotationUpdated:function(a,b){this.annotationRemoved(a);this.annotationAdded(a)},termAdded:function(a,b){this.annotationRemoved(a);this.annotationAdded(a)},termRemoved:function(a,b){this.annotationRemoved(a);this.annotationAdded(a)}};var AnnotationPropertyLayer=function(d,c,a,f){var b=this;this.idImage=d;this.idUser=c;this.browseImageView=a;this.map=a.map;this.vectorLayer=null;this.key=f;this.styleMap=new OpenLayers.StyleMap({"default":{label:"${value}",fontColor:"red",fontSize:"13px",fontWeight:"bold",}});this.vectorLayer=new OpenLayers.Layer.Vector("annotationPropertyValue",{styleMap:b.styleMap,strategies:[new OpenLayers.Strategy.BBOX({resFactor:1})],protocol:new OpenLayers.Protocol.Script({url:new AnnotationPropertyTextCollection({idUser:this.idUser,idImage:this.idImage,key:this.key}).url().replace("json","jsonp"),format:new OpenLayers.Format.AnnotationProperty({annotationPropertyLayer:this}),callbackKey:"callback"})});this.addToMap=function(){this.map.addLayer(this.vectorLayer)};this.setZIndex=function(g){this.vectorLayer.setZIndex(g)};this.removeFromMap=function(){this.map.removeLayer(this.vectorLayer)}};OpenLayers.Format.AnnotationProperty=OpenLayers.Class(OpenLayers.Format,{read:function(d){var c=d.collection;var b=[];var a=this;_.each(c,function(g){var i=new OpenLayers.Format.WKT();var f=i.read(g.centre);var h=new OpenLayers.Feature.Vector(f.geometry);h.attributes={value:g.value};b.push(h)});return b}});var BrowseImageView=Backbone.View.extend({tagName:"div",tileSize:256,review:false,divPrefixId:"",divId:"",currentAnnotation:null,userJobForImage:null,initialize:function(a){console.log("initialize");console.log(a);this.iPad=(navigator.userAgent.match(/iPad/i)!=null);this.initCallback=a.initCallback;this.layers=[];this.layersLoaded=0;this.baseLayers=[];this.broadcastPositionInterval=null;this.watchOnlineUsersInterval=null;this.annotationsPanel=null;this.ontologyPanel=null;this.reviewPanel=null;this.annotationProperties=null;this.map=null;this.nbDigitialZoom=0;this.digitalResolutions=[];for(var b=0;b<this.nbDigitialZoom;b++){this.digitalResolutions.push(1/Math.pow(2,b+1))}this.currentAnnotation=null;if(a.review!=undefined){this.review=a.review}this.divPrefixId="tabs-"+this.getMode();this.addToTab=true;if(a.addToTab!=undefined){this.addToTab=a.addToTab}_.bindAll(this,"initVectorLayers")},doLayout:function(c){var b=this;console.log("BrowseImageView:doLayout");this.divId="tabs-"+b.getMode()+"-"+window.app.status.currentProject+"-"+this.model.id+"-";var f=this.model.toJSON();f.project=window.app.status.currentProject;f.type=b.divPrefixId;$(this.el).append(_.template(c,f));console.log("************MODEL*************");console.log(this.model);var i=this.model.getVisibleName(window.app.status.currentProjectModel.get("blindMode"));if(i.length>25){i=i.substring(0,23)+"..."}var h="<li><a style='float: left;' id='"+b.divPrefixId+"-<%= idImage %>' rel='tooltip' title='<%= originalFilename %>' href='#"+b.divPrefixId+"-<%= idProject %>-<%= idImage %>-' data-toggle='tab'><i class='icon-search' /> <%= shortOriginalFilename %> </a></li>";var a="data-name=<%= idImage %>";if(this.addToTab){var d=$("#explorer-tab");d.append(_.template(h,{idProject:window.app.status.currentProject,idImage:this.model.get("id"),originalFilename:this.model.get("originalFilename"),shortOriginalFilename:i}));var g='<li class="dropdown"><a href="#" id="'+b.divPrefixId+'-<%= idImage %>-dropdown" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#tabs-dashboard-<%= idProject %>" data-toggle="tab" data-image="<%= idImage %>" class="closeTab" id="closeTab'+b.divPrefixId+'-<%= idImage %>"><i class="icon-remove" /> Close</a></li></ul></li>';d.append(_.template(g,{idProject:window.app.status.currentProject,idImage:this.model.get("id"),filename:this.model.get("filename")}))}if(this.review&&this.model.get("reviewed")){b.changeValidateColor(true)}else{if(this.review&&this.model.get("inReview")){b.changeValidateColor(false)}}this.initToolbar();if(this.review){console.log("this.review="+this.review);new UserJobCollection({project:window.app.status.currentProject,image:b.model.id}).fetch({success:function(l,k){b.userJobForImage=l;b.initMap();b.initAnnotationsTabs();if(b.iPad){b.initMobile()}}})}else{this.initMap();this.initAnnotationsTabs();if(this.iPad){this.initMobile()}}return this},changeValidateColor:function(d){var b=this;var a="";if(d){a="#5BB75B"}else{a="#BD362F"}var c=$("#explorer-tab-content");c.find("a#"+b.divPrefixId+"-"+b.model.id).css("background-color",a)},initMobile:function(){},isCurrentAnnotationUser:function(){console.log("isCurrentAnnotationUser="+window.app.models.projectUser.get(this.currentAnnotation.get("user")));return window.app.models.projectUser.get(this.currentAnnotation.get("user"))!=undefined},addTermToReviewPanel:function(a){console.log("addTermToReviewPanel="+a);if(this.review){this.reviewPanel.addTermChoice(a,this.currentAnnotation.id)}},deleteTermFromReviewPanel:function(a){if(this.review){this.reviewPanel.deleteTermChoice(a,this.currentAnnotation.id)}},getMode:function(){if(!this.review){return"image"}else{return"review"}},render:function(){var a=this;require(["text!application/templates/explorer/BrowseImage.tpl.html"],function(b){a.doLayout(b)});return this},registerEventTile:function(b){var a=this;b.events.register("loadstart",b,function(){});b.events.register("tileloaded",b,function(d){return;var c=d.tile.getCanvasContext();if(c){var f=c.getImageData(0,0,d.tile.size.w,d.tile.size.h);c.putImageData(f,0,0);d.tile.imgDiv.removeAttribute("crossorigin");d.tile.imgDiv.src=c.canvas.toDataURL()}});b.events.register("loadend",b,function(){})},show:function(b){var a=this;console.log("show!");console.log(b.goToAnnotation);console.log(this.position);if(this.position){console.log("moveTo");a.map.moveTo(new OpenLayers.LonLat(a.position.x,a.position.y),Math.max(0,a.position.zoom))}if(b.goToAnnotation!=undefined&&b.goToAnnotation.value!=undefined){console.log("GO TO ANNOTATION");new AnnotationModel({id:b.goToAnnotation.value}).fetch({success:function(c,d){var f=_.find(a.layers,function(g){return g.userID==c.get("user")});if(f){f.showFeature(c.get("id"));a.goToAnnotation(f,c);a.setLayerVisibility(f,true);setTimeout(function(){var g=f.getFeature(c.id);if(g){f.selectFeature(g)}},1000)}else{new UserModel({id:c.get("user")}).fetch({success:function(h,g){var i=new AnnotationLayer(h.get("username"),a.model.get("id"),c.get("user"),"",a.ontologyPanel.ontologyTreeView,a,a.map,this.review);i.isOwner=false;i.loadAnnotations(a);i.registerEvents(a.map);i.showFeature(c.get("id"));a.goToAnnotation(i,c);a.setLayerVisibility(i,true)}})}}})}},refreshAnnotationTabs:function(a){this.annotationsPanel.refreshAnnotationTabs(a)},setAllLayersVisibility:function(a){var b=this;_.each(this.layers,function(c){b.setLayerVisibility(c,a)})},setLayerVisibility:function(b,a){$("#"+this.divId).find("#layerSwitcher"+this.model.get("id")).find("ul.annotationLayers").find(":checkbox").each(function(){if(b.name!=$(this).attr("value")){return}if(a){if(!$(this).is(":checked")){this.click()}}else{if($(this).attr("checked")=="checked"){this.click()}}})},switchControl:function(b){var a=$("#"+this.divId).find("#toolbar"+this.model.get("id"));a.find("input[id="+b+this.model.get("id")+"]").click()},getZoomLevel:function(){return this.map.zoom},goToAnnotation:function(h,d){var p=this;var l=new OpenLayers.Format.WKT();var m=l.read(d.get("location"));var k=m.geometry;var b=k.getBounds();var i=b.right-b.left;var n=b.top-b.bottom;var c=$(window).width();var a=$(window).height();var o=p.map.getNumZoomLevels()-this.nbDigitialZoom;var g=i;var f=n;while((g>c)||(f>a)){g/=2;f/=2;o--}o=Math.max(0,o-1);p.map.moveTo(new OpenLayers.LonLat(k.getCentroid().x,k.getCentroid().y),Math.max(0,o))},getFeature:function(a){return this.userLayer.getFeature(a)},removeFeature:function(a){return this.userLayer.removeFeature(a)},layerLoadedCallback:function(d){var b=this;this.layersLoaded++;if(b.review==false&&this.layersLoaded==(window.app.models.userLayer.length+1)){var a=_.map(this.layers,function(f){return f.vectorsLayer});var c=new OpenLayers.Control.SelectFeature(a);_.each(this.layers,function(f){f.initControls(b,c);f.registerEvents(b.map);if(f.isOwner){b.userLayer=f;f.vectorsLayer.setVisibility(true);f.toggleIrregular();var g=$("#"+b.divId).find("#toolbar"+b.model.get("id"));g.find("input[id=none"+b.model.get("id")+"]").click()}else{f.controls.select.activate();f.vectorsLayer.setVisibility(false)}});if(_.isFunction(b.initCallback)){b.initCallback.call()}b.initAutoAnnoteTools()}else{}},getUserLayer:function(){return this.userLayer},getUserAndReviewLayer:function(){console.log("getUserAndReviewLayer.user="+this.userLayer.name);console.log("getUserAndReviewLayer.review="+this.reviewPanel.reviewLayer.name);return{user:this.userLayer,review:this.reviewPanel.reviewLayer}},initMap:function(){var a=this;var b=this.model.get("mime");if(b=="vms"||b=="mrxs"||b=="tif"||b=="tiff"||b=="svs"||b=="jp2"){a.initIIP()}},addBaseLayer:function(b){var a=this;this.map.addLayer(b);this.baseLayers.push(b);a.map.setBaseLayer(b);if(!this.review){this.layerSwitcherPanel.addBaseLayer(b,this.model)}},reviewLayer:null,addVectorLayer:function(b,a){console.log("addVectorLayer");b.vectorsLayer.setVisibility(false);this.map.addLayer(b.vectorsLayer);if(a==0){this.reviewLayer=b}this.layers.push(b);if(!this.review){this.layerSwitcherPanel.addVectorLayer(b,this.model,a)}else{this.reviewPanel.addVectorLayer(b,this.model,a);this.map.raiseLayer(this.reviewLayer.vectorsLayer,1000)}},showAnnotationInReviewPanel:function(a){console.log("showAnnotationInReviewPanel");if(this.review){this.reviewPanel.showCurrentAnnotation(a)}},createLayerSwitcher:function(){this.layerSwitcherPanel=new LayerSwitcherPanel({browseImageView:this,model:this.model,el:this.el}).render();this.createNumberOfAnnotationPerUser()},createReviewPanel:function(){var a=this;this.reviewPanel=new ReviewPanel({browseImageView:a,model:a.model,el:a.el,userLayers:window.app.models.projectUser,userJobLayers:a.userJobForImage}).render()},createNumberOfAnnotationPerUser:function(){console.log("createNumberOfAnnotationPerUser");var b=this;var c=function(){$.get("/api/imageinstance/"+b.model.id+"/annotationindex.json",function(g){console.log("GET REFRESH");var d=0;_.each(g.collection,function(i){var h=$("li#entry"+i.user).find("span.numberOfAnnotation");if(h.length>0){h.empty();h.append("("+i.countAnnotation+")")}d=d+i.countReviewedAnnotation});var f=$("li#entryREVIEW").find("span.numberOfAnnotation");f.empty();f.append("("+d+")")})};c();var a=setInterval(c,5000);$(window).bind("hashchange",function(){clearInterval(a)})},createAnnotationPropertiesPanel:function(){var a=this;this.annotationProperties=new AnnotationPropertyPanel({browseImageView:a,model:a.model,el:a.el}).render()},createInformationPanel:function(){var a=this;console.log("x:"+a.model.get("originalFilename"));this.informationsPanel=new InformationsPanel({browseImageView:a,model:a.model,el:a.el}).render()},createMultiDimensionPanel:function(){var a=this;console.log("createMultiDimensionPanel");this.multidimensionPanel=new MultiDimensionPanel({browseImageView:a,model:a.model,el:a.el}).render()},createOverviewMap:function(){new OverviewMapPanel({model:this.model,el:this.el,browseImageView:this}).render()},initIIP:function(){var b=this;var f=96;var a=$(window).height()-f;$("#"+b.divId).find("#map"+b.divPrefixId+b.model.get("id")).css("height",a);$("#"+b.divId).find("#map"+b.divPrefixId+b.model.get("id")).css("width","100%");$(window).resize(function(){var k=$(window).height()-f;$("#"+b.divId).find("#map"+b.divPrefixId+b.model.get("id")).css("height",k)});var i=function(u,v,p){b.createAnnotationPropertiesPanel();if(!b.review){b.createLayerSwitcher();$(".reviewPanel").hide()}else{b.createReviewPanel();$(".layerSwitcherPanel").hide();console.log("LAYER SWITECHER="+$(".layerSwitcherPanel").length)}b.createInformationPanel();b.createMultiDimensionPanel();var x=[];for(var s=u.nbZoom-1;s>=0;s--){x.push(Math.pow(2,s))}var m=_.union(x,b.digitalResolutions);var y={theme:null,maxExtent:new OpenLayers.Bounds(0,0,u.width,u.height),resolutions:m,serverResolutions:x,units:"pixels",tileSize:new OpenLayers.Size(b.tileSize,b.tileSize),controls:[new OpenLayers.Control.TouchNavigation({dragPanOptions:{enableKinetic:window.app.view.isMobile}}),new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:window.app.view.isMobile}}),new OpenLayers.Control.ZoomPanel(),new OpenLayers.Control.KeyboardDefaults()],eventListeners:{zoomend:function(B){var D=B.object;var C=b.model.get("magnification")*Math.pow(2,b.nbDigitialZoom);var z=D.getNumZoomLevels()-D.getZoom()-1;var A=C;if(z!=0){A=C/(Math.pow(2,z))}A=Math.round(A*100)/100;if(A>b.model.get("magnification")){$("#"+b.divId).find("#zoomInfoPanel"+b.model.id).css("color","red");$("#"+b.divId).find("#zoomInfoPanel"+b.model.id).html("magnitude : "+A+"X<br/>digital");$("#"+b.divId).find("#zoomInfoPanel"+b.model.id).css("height",40)}else{$("#"+b.divId).find("#zoomInfoPanel"+b.model.id).css("color","white");$("#"+b.divId).find("#zoomInfoPanel"+b.model.id).html("magnitude : "+A+"X");$("#"+b.divId).find("#zoomInfoPanel"+b.model.id).css("height",20)}b.broadcastPosition()},moveend:function(){b.broadcastPosition()},mousemove:function(z){}}};var o=new OpenLayers.Layer.Image("Overview"+b.model.get("id"),b.model.get("thumb"),new OpenLayers.Bounds(0,0,u.width,u.height),new OpenLayers.Size(u.overviewWidth,u.overviewHeight));b.createOverviewMap();var n=new OpenLayers.Control.OverviewMap({size:new OpenLayers.Size(u.overviewWidth,u.overviewHeight),layers:[o],div:$("#"+b.divId).find("#overviewmapcontent"+b.model.get("id"))[0],minRatio:1,maxRatio:1024,mapOptions:{maxExtent:new OpenLayers.Bounds(0,0,u.width,u.height),maximized:true}});b.map=new OpenLayers.Map("map"+b.divPrefixId+b.model.get("id"),y);b.map.events.register("mousemove",b.map,function(A){var z=b.map.getLonLatFromPixel(this.events.getMousePosition(A));var B=_.template(" x : <%= x %>, y : <%= y %>",{x:z.lon,y:z.lat});$("#mousePositionContent"+b.model.id).html(B)});b.initOntology();window.app.view.applyPreferences();var t=new OpenLayers.Layer.Zoomify("Original",v,new OpenLayers.Size(u.width,u.height),{tileOptions:{crossOriginKeyword:"anonymous"}});t.transitionEffect="resize";t.getImageSize=function(){if(arguments.length>0){bounds=this.adjustBounds(arguments[0]);var E=this.map.getZoom();var C=this.map.getResolution();var A=Math.round((bounds.left-this.tileOrigin.lon)/(C*this.tileSize.w));var F=Math.round((this.tileOrigin.lat-bounds.top)/(C*this.tileSize.h));if(this.tierImageSize[E]==undefined){return null}var B=this.standardTileSize;var D=this.standardTileSize;if(A==this.tierSizeInTiles[E].w-1){B=this.tierImageSize[E].w%this.standardTileSize;if(B==0){B=this.standardTileSize}}if(F==this.tierSizeInTiles[E].h-1){D=this.tierImageSize[E].h%this.standardTileSize;if(D==0){D=this.standardTileSize}}return(new OpenLayers.Size(B,D))}else{return this.tileSize}};p.each(function(B){var z=_.map(v,function(C){console.log(B.get("processingServer")+B.get("baseUrl")+C);return B.get("processingServer")+B.get("baseUrl")+C});var A=new OpenLayers.Layer.Zoomify(B.get("name"),z,new OpenLayers.Size(u.width,u.height));A.imageFilter=B;b.addBaseLayer(A);b.registerEventTile(A)});b.registerEventTile(t);b.addBaseLayer(t);b.map.zoomToMaxExtent();b.map.addControl(n);var l=$(window).width();var k=$(window).height()-f;var r=u.width;var q=u.height;var w=u.nbZoom;while(r>l||q>k){r/=2;q/=2;w--}b.map.zoomTo(w);b.initBroadcastingInterval();if(!b.review){b.initWatchOnlineUsersInterval()}};var g=b.model.get("width");var d=b.model.get("height");var h=1;while(g>b.tileSize||d>b.tileSize){h++;g=Math.floor(g/2);d=Math.floor(d/2)}var c={width:b.model.get("width"),height:b.model.get("height"),nbZoom:h,overviewWidth:200,overviewHeight:Math.round((200/b.model.get("width")*b.model.get("height")))};new ImageServerUrlsModel({id:b.model.get("baseImage")}).fetch({success:function(l,k){new ProjectImageFilterCollection({project:b.model.get("project")}).fetch({success:function(n,m){i(c,l.get("imageServersURLs"),n)}})}})},broadcastPosition:function(){var d=this.model.get("id");var a=this.map.getExtent().getCenterLonLat();var f=a.lon;var c=a.lat;var b=this.map.zoom;if(b==null||f==null||c==null){return}new UserPositionModel({lon:f,lat:c,zoom:b,image:d}).save()},reloadAnnotation:function(a){var b=this;b.removeFeature(a);new AnnotationModel({id:a}).fetch({success:function(c,d){var f=AnnotationLayerUtils.createFeatureFromAnnotation(c);b.userLayer.addFeature(f);b.userLayer.selectFeature(f)}})},initBroadcastingInterval:function(){var a=this;this.broadcastPositionInterval=setInterval(function(){a.broadcastPosition()},5000);window.app.view.intervals.push(this.broadcastPositionInterval)},stopBroadcastingInterval:function(){clearInterval(this.broadcastPositionInterval)},initWatchOnlineUsersInterval:function(){var a=this;if(this.review){return}this.watchOnlineUsersInterval=setInterval(function(){new UserOnlineModel({image:a.model.get("id")}).fetch({success:function(c,b){var d=c.get("users").split(",");a.layerSwitcherPanel.updateOnlineUsers(d)}})},5000);window.app.view.intervals.push(this.watchOnlineUsersInterval)},stopWatchOnlineUsersInterval:function(){clearInterval(this.watchOnlineUsersInterval)},initAutoAnnoteTools:function(){var b=this;var a=false;var c=function c(u){if(!b.getUserLayer().magicOnClick){return}if(a){window.app.view.message("Warning","Magic Wand in progress...","warning");return}a=true;var E=b.map.baseLayer.grid;var o=document.createElement("canvas");var k=o.getContext("2d");var d=E[0].length*E[0][0].size.w;var s=E.length*E[0][0].size.h;o.width=d;o.height=s;o.display="none";document.body.appendChild(o);var H=$("#maptabs-image"+b.model.id).children().children()[0];var r=parseInt($(H).css("left"),10);var z=parseInt($(H).css("top"),10);for(var p=0;p<E.length;p++){for(var n=0;n<E[p].length;n++){var G=E[p][n];var f=G.getCanvasContext();if(f){k.drawImage(f.canvas,r+G.position.x,z+G.position.y)}}}var C=u.xy.x;var B=u.xy.y;var D=k.getImageData(0,0,d,s);var I="mw_tolerance"+window.app.status.currentProject;var m="th_threshold"+window.app.status.currentProject;var A=localStorage.getObject(I)||Processing.MagicWand.defaultTolerance;var h=localStorage.getObject(m)||Processing.Threshold.defaultTheshold;console.log("threshold="+h);console.log("tolerance="+A);if(window.app.status.currentProjectModel.get("disciplineName")=="HISTOLOGY"){Processing.ColorChannel.process({canvas:D,channel:Processing.ColorChannel.GREEN})}else{Processing.Threshold.process({canvas:D,threshold:h})}console.log("MagicWand...");var x=Processing.MagicWand.process({canvas:D,canvasWidth:d,canvasHeight:s,startX:C,startY:B,tolerance:A});if(!x.success){a=false;document.body.removeChild(o);window.app.view.message("Warning","Can't find interesting region","error");return}console.log("done");console.log("Outline");var l=Processing.Outline.process({canvas:D,canvasWidth:d,canvasHeight:s,bbox:x.bbox});console.log("done");a=false;var v=false;if(v){k.putImageData(D,0,0);k.fillStyle="#FF0000";k.fillRect(x.bbox.xmin-5,x.bbox.ymin-5,10,10);k.fillRect(x.bbox.xmin-5,x.bbox.ymax-5,10,10);k.fillRect(x.bbox.xmax-5,x.bbox.ymin-5,10,10);k.fillRect(x.bbox.xmax-5,x.bbox.ymax-5,10,10);k.fillStyle="#00FF00";k.fillRect(l.startX-5,l.startY-5,10,10);for(var y=0;y<l.points.length;y++){k.fillStyle="#00FFFF";k.fillRect(l.points[y].x-1,l.points[y].y-1,3,3)}}if(!v){document.body.removeChild(o)}var t=[];for(var y=0;y+5<l.points.length;y=y+5){var F=b.map.getLonLatFromViewPortPx({x:l.points[y].x,y:l.points[y].y});var w=new OpenLayers.Geometry.Point(F.lon,F.lat);t.push(w)}t.push(t[0]);var g=new OpenLayers.Geometry.LinearRing(t);var q=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([g]),null,{});b.getUserLayer().addAnnotation(q)};if(b.getUserLayer()!=undefined){b.map.events.register("click",b.getUserLayer().vectorsLayer,c)}},freeHandUpdateAdd:false,freeHandUpdateRem:false,initToolbar:function(){var a=this;var b=$("#"+a.divId).find("#toolbar"+this.model.get("id"));$("#"+a.divId).find("a[id=none"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("none");a.getUserLayer().enableHightlight()});b.find("a[id=select"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleControl("select");a.getUserLayer().disableHightlight()});b.find("a[id=point"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("point");a.getUserLayer().disableHightlight()});b.find("a[id=irregular4"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;if(!a.getUserLayer().irregular){a.getUserLayer().toggleIrregular()}a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(4);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("a[id=irregular30"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;if(!a.getUserLayer().irregular){a.getUserLayer().toggleIrregular()}a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(15);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("a[id=regular30"+this.model.get("id")+"]").click(function(){console.log("toggle");a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;if(a.getUserLayer().irregular){a.getUserLayer().toggleIrregular()}a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(15);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("a[id=polygon"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("polygon");a.getUserLayer().disableHightlight()});b.find("a[id=freehand"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("freehand");a.getUserLayer().disableHightlight()});b.find("a[id=freeAdd"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=true;a.freeHandUpdateRem=false;a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("freehand");a.getUserLayer().disableHightlight()});b.find("a[id=freeRem"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=true;a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("freehand");a.getUserLayer().disableHightlight()});b.find("a[id=magic"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("select");a.getUserLayer().magicOnClick=true;a.getUserLayer().disableHightlight()});if(this.iPad){b.find("a[id=magic"+this.model.get("id")+"]").hide()}b.find("a[id=modify"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;if(!a.review){a.getUserLayer().toggleEdit();a.getUserLayer().toggleControl("modify");a.getUserLayer().disableHightlight()}else{a.getUserAndReviewLayer().user.toggleEdit();a.getUserAndReviewLayer().user.toggleControl("modify");a.getUserAndReviewLayer().user.disableHightlight();a.getUserAndReviewLayer().review.toggleEdit();a.getUserAndReviewLayer().review.toggleControl("modify");a.getUserAndReviewLayer().review.disableHightlight()}});b.find("a[id=delete"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("select");a.getUserLayer().deleteOnSelect=true;a.getUserLayer().disableHightlight()});b.find("a[id=rotate"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;if(!a.review){a.getUserLayer().toggleRotate();a.getUserLayer().disableHightlight()}else{a.getUserAndReviewLayer().user.toggleRotate();a.getUserAndReviewLayer().user.disableHightlight();a.getUserAndReviewLayer().review.toggleRotate();a.getUserAndReviewLayer().review.disableHightlight()}});b.find("a[id=fill"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;var c=a.currentAnnotation;if(c){new AnnotationModel({id:c.id,fill:true}).save({},{success:function(d,f){window.app.view.message("Annotation edited",f.message,"success");if(!a.review){a.getUserLayer().vectorsLayer.refresh()}else{a.getUserAndReviewLayer().user.vectorsLayer.refresh();a.getUserAndReviewLayer().review.vectorsLayer.refresh()}},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Annotation",g.errors,"")}})}else{window.app.view.message("Annotation","You must select an annotation!","error")}return false});b.find("a[id=resize"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;if(!a.review){a.getUserLayer().toggleResize();a.getUserLayer().disableHightlight()}else{a.getUserAndReviewLayer().user.toggleResize();a.getUserAndReviewLayer().user.disableHightlight();a.getUserAndReviewLayer().review.toggleResize();a.getUserAndReviewLayer().review.disableHightlight()}});b.find("a[id=drag"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;if(!a.review){a.getUserLayer().toggleDrag();a.getUserLayer().disableHightlight()}else{a.getUserAndReviewLayer().user.toggleDrag();a.getUserAndReviewLayer().user.disableHightlight();a.getUserAndReviewLayer().review.toggleDrag();a.getUserAndReviewLayer().review.disableHightlight()}});b.find("a[id=ruler"+this.model.get("id")+"]").click(function(){a.freeHandUpdateAdd=false;a.freeHandUpdateRem=false;a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("line");a.getUserLayer().measureOnSelect=true;a.getUserLayer().disableHightlight()});b.find("a[id=camera"+this.model.get("id")+"]").click(function(){var f=a.map.getExtent();var d=f.left;var i=a.model.get("height")-f.top;var h=f.right-f.left;var c=f.top-f.bottom;var g="api/imageinstance/"+a.model.id+"/window_url-"+d+"-"+i+"-"+h+"-"+c;$.get(g,function(l){window_url=l.url;var k=a.map.baseLayer.imageFilter;if(k){window_url=k.get("processingServer")+k.get("baseUrl")+window_url}window.open(window_url)})})},initVectorLayers:function(d){var b=this;if(!b.review){var f=window.app.status.currentProjectModel;var a=window.app.models.projectUser.select(function(g){return window.app.models.userLayer.get(g.id)!=undefined});_.each(a,function(g){var h=new AnnotationLayer(g.prettyName(),b.model.get("id"),g.get("id"),g.get("color"),d,b,b.map,b.review);h.isOwner=(g.get("id")==window.app.status.user.id);h.loadAnnotations(b)});var c=new AnnotationLayer("Review layer",b.model.get("id"),"REVIEW","",d,b,b.map,b.review);c.isOwner=false;c.loadAnnotations(b)}else{b.reviewPanel.addReviewLayerToReview();console.log("##########");console.log(this.divId+" => addLayerToReview");b.reviewPanel.addLayerToReview(window.app.status.user.id);b.reviewPanel.removeLayerFromReview(window.app.status.user.id);b.reviewPanel.addLayerToReview(window.app.status.user.id)}},refreshReviewLayer:function(){if(this.reviewPanel){this.reviewPanel.reviewLayer.vectorsLayer.refresh()}},initAnnotationsTabs:function(){this.annotationsPanel=new AnnotationsPanel({el:this.el,model:this.model,browseImageView:this}).render()},clickSelect:function(){var a=this;$("#"+a.divId).find("#toolbar"+a.model.get("id")).find("a#select"+a.model.get("id")).click()},initOntology:function(){var a=this;a.ontologyPanel=new OntologyPanel({el:this.el,model:this.model,callback:a.initVectorLayers,browseImageView:a}).render()},initImageFiltersPanel:function(){var a=this;a.imageFiltersPanel=new ImageFiltersPanel({el:this.el,model:this.model,browseImageView:a}).render()},initTools:function(a){for(var b in a){this.map.addControl(a[b])}},validatePicture:function(){var a=this;console.log("validateImage");new ImageReviewModel({id:a.model.id}).destroy({success:function(c,b){window.app.view.message("Image",b.message,"success");a.model=new ImageModel(b.imageinstance);a.changeValidateColor(true);a.reviewPanel.refresh(a.model)},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("Image",d.errors,"error")}})},unvalidatePicture:function(){var a=this;console.log("cancelReviewing");new ImageReviewModel({id:a.model.id,cancel:true}).destroy({success:function(c,b){window.app.view.message("Image",b.message,"success");a.model=new ImageModel(b.imageinstance);a.changeValidateColor(false);a.reviewPanel.refresh(a.model)},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("Image",d.errors,"error")}})}});var LeafletView=Backbone.View.extend({tagName:"div",tileSize:256,review:false,divPrefixId:"",divId:"",currentAnnotation:null,userJobForImage:null,initialize:function(a){this.initCallback=a.initCallback;this.layers=[];this.layersLoaded=0;this.baseLayers=[];this.broadcastPositionInterval=null;this.watchOnlineUsersInterval=null;this.annotationsPanel=null;this.ontologyPanel=null;this.reviewPanel=null;this.annotationProperties=null;this.map=null;this.nbDigitialZoom=0;this.digitalResolutions=[];for(var b=0;b<this.nbDigitialZoom;b++){this.digitalResolutions.push(1/Math.pow(2,b+1))}this.currentAnnotation=null;if(a.review!=undefined){this.review=a.review}if(!this.review){this.divPrefixId="tabs-image"}else{this.divPrefixId="tabs-review"}},render:function(){var a=this;require(["text!application/templates/explorer/LeafletView.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(h){var k=this;this.mapID="map"+this.divPrefixId+this.model.get("id");this.divId="tabs-image-"+window.app.status.currentProject+"-"+this.model.id+"-";var f=this.model.toJSON();f.project=window.app.status.currentProject;f.type=k.divPrefixId;$(this.el).append(_.template(h,f));var b=this.model.get("originalFilename");if(b.length>25){b=b.substring(0,23)+"..."}var c="<li><a style='float: left;' id='"+k.divPrefixId+"-<%= idImage %>' rel='tooltip' title='<%= originalFilename %>' href='#"+k.divPrefixId+"-<%= idProject %>-<%= idImage %>-' data-toggle='tab'><i class='icon-search' /> <%= shortOriginalFilename %> </a></li>";var d="data-name=<%= idImage %>";var i=$("#explorer-tab");i.append(_.template(c,{idProject:window.app.status.currentProject,idImage:this.model.get("id"),originalFilename:this.model.get("originalFilename"),shortOriginalFilename:b}));var g='<li class="dropdown"><a href="#" id="'+k.divPrefixId+'-<%= idImage %>-dropdown" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#tabs-dashboard-<%= idProject %>" data-toggle="tab" data-image="<%= idImage %>" class="closeTab" id="closeTab'+k.divPrefixId+'-<%= idImage %>"><i class="icon-remove" /> Close</a></li></ul></li>';i.append(_.template(g,{idProject:window.app.status.currentProject,idImage:this.model.get("id"),filename:this.model.get("filename")}));if(!this.review){this.divPrefixId="tabs-image"}else{this.divPrefixId="tabs-review"}this.initMapContainer();var a=this.initMap();return this},initToolbar:function(c){var b=new L.FeatureGroup();c.addLayer(b);var a=new L.Control.Draw({draw:{position:"topleft",polygon:{title:"Draw a sexy polygon!",allowIntersection:false,drawError:{color:"#b00b00",timeout:1000},shapeOptions:{color:"#bada55"}},circle:{shapeOptions:{color:"#662d91"}}},edit:{featureGroup:b}});c.addControl(a);c.on("draw:created",function(g){var f=g.layerType,d=g.layer;if(f==="marker"){d.bindPopup("A popup!")}b.addLayer(d)})},initMapContainer:function(){var b=77;var a=$(window).height()-b;var c=$("#"+this.mapID);c.css("height",a);c.css("width","100%");$(window).resize(function(){var d=$(window).height()-b;c.css("height",d)})},initMap:function(){var a=this;var c=L.map(this.mapID,{drawControl:true});L.Util.requestAnimFrame(c.invalidateSize,c,!1,c._container);c.setView(new L.LatLng(0,0),0);var b={width:a.model.get("width"),height:a.model.get("height")};new ImageServerUrlsModel({id:a.model.get("baseImage")}).fetch({success:function(f,d){var g=new ZoomifyLayer(f.get("imageServersURLs"),b);c.addLayer(g);a.initToolbar(c);L.control.layers({Original:g},{}).addTo(c)}});return c},show:function(b){var a=this;L.Util.requestAnimFrame(map.invalidateSize,map,!1,map._container)},});var ExplorerTabs=Backbone.View.extend({tagName:"div",triggerRoute:true,initialize:function(a){this.tabs=[];this.container=a.container;this.dashboard=null},render:function(){var a=this;require(["text!application/templates/explorer/Tabs.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(a){$(this.el).html(_.template(a,{}));return this},showLastTab:function(a){console.log("avoid="+a);var b=(this.tabs.length-1);while(b>=0){console.log("i="+b);console.log(this.tabs[b].idImage);if(this.tabs[b].idImage!=a){var d=this.tabs[b].view.divPrefixId+"-"+this.tabs[b].idImage;console.log("show:"+d);console.log($("#"+d).length);var c=250;setTimeout(function(){console.log("#"+d);$("#"+d).tab("show")},c);break}b--}},addBrowseImageView:function(d,c){var b=this;var h=this.getImageView(d);if(h!=null){h.view.show(c);b.showTab(d,"image");return}h=this.getImageView("review-"+d);if(h!=null){$("#closeTabtabs-review-"+d).click()}var f=$("#explorer-tab-content");console.log("TEMP:BrowseImageView");var a=new BrowseImageView({initCallback:function(){a.show(c)},el:f});b.tabs.push({idImage:d,view:a});var i=function(k){a.model=k.image;a.render();if(k.position){a.position={x:k.x,y:k.y,zoom:k.zoom}}$("#closeTabtabs-image-"+d).on("click",function(m){var l=$(this).attr("data-image");b.removeTab(l,"image");b.showLastTab(l)});b.showTab(d,"image")};var g=window.app.popNewImage();if(g&&g.image&&g.image.id==d){i(g)}else{new ImageInstanceModel({id:d}).fetch({success:function(l,k){i({image:l,position:false})}})}},addReviewImageView:function(d,c){console.log("addReviewImageView:"+d);var b=this;var h=this.getImageView("review-"+d);if(h!=null){h.view.show(c);b.showTab(d,"review");return}h=this.getImageView(d);if(h!=null){$("#closeTabtabs-image-"+d).click()}var f=$("#explorer-tab-content");var a=new BrowseImageView({initCallback:function(){a.show(c)},el:f,review:true});b.tabs.push({idImage:"review-"+d,view:a});var i=function(k){a.model=k.image;console.log(a.model);a.render();$("#closeTabtabs-review-"+d).on("click",function(m){var l=$(this).attr("data-image");b.removeTab(l,"review");b.showLastTab(l)});b.showTab(d,"review");if(k.image.get("inReview")==false&&k.image.get("reviewed")==false){b.removeTab(d,"review");window.app.view.message("Review image","You must first start reviewing picture before review it!","warning")}};var g=window.app.popNewImage();console.log("imageNew="+g);if(g&&g.image&&g.image.id==d){i(g)}else{new ImageInstanceModel({id:d}).fetch({success:function(l,k){console.log("ImageInstanceModel="+d);i({image:l,position:false})}})}},getImageView:function(b){var a=_.detect(this.tabs,function(c){return c.idImage==b});return a!=null?a:null},removeTab:function(c,g){var b=this;var a=null;if(g!="review"){a=this.getImageView(c)}else{a=this.getImageView("review-"+c)}a.view.stopBroadcastingInterval();a.view.stopWatchOnlineUsersInterval();var f=this.tabs.indexOf(a);this.tabs.splice(f,1);var d=$("#explorer-tab");$("#tabs-"+g+"-"+c).parent().remove();$("#tabs-"+g+"-"+c+"-dropdown").parent().remove();$("#tabs-"+g+"-"+window.app.status.currentProject+"-"+c+"-").remove()},showTab:function(a,c){console.log("showTab2");var b=$("#explorer-tab");window.app.controllers.browse.tabs.triggerRoute=false;$("#tabs-"+c+"-"+a).click();window.app.controllers.browse.tabs.triggerRoute=true},goToImage:function(h,a,f,b,c,g,d,k){var i=this;if(c&&g){window.app.setNewImageWithPosition(c,g,d,k)}else{if(c){window.app.setNewImage(c)}}window.app.controllers.browse.tabs.removeTab(f,b);window.location="#tabs-"+b+"-"+a+"-"+h+"-"},size:function(){return _.size(this.tabs)},closeAll:function(){var a=$(this.el).children(".tabs");this.tabs=[];$(this.el).hide();$(this.el).parent().find(".noProject").show()},addDashboard:function(b){var a=this;this.dashboard=b;var c=$("#explorer-tab");c.append(_.template("<li><a id='dashboardLink-<%= idProject %>' href='#tabs-dashboard-<%= idProject %>' data-toggle='tab'><i class='icon-road' /> Dashboard</a></li>",{idProject:window.app.status.currentProject}));c.append(_.template("<li><a href='#tabs-images-<%= idProject %>' data-toggle='tab'><i class='icon-picture' /> Images</a></li>",{idProject:window.app.status.currentProject}));c.append(_.template("<li><a href='#tabs-annotations-<%= idProject %>' data-toggle='tab'><i class='icon-pencil' /> Annotations</a></li>",{idProject:window.app.status.currentProject}));c.append(_.template("<li><a class='annotationTabLink' href='#tabs-properties-<%= idProject %>' data-toggle='tab'><i class='icon-list' /> Properties</a></li>",{idProject:window.app.status.currentProject}));c.append(_.template("<li><a href='#tabs-algos-<%= idProject %>' data-toggle='tab'><i class='icon-tasks' /> Jobs</a></li>",{idProject:window.app.status.currentProject}));c.append(_.template("<li><a href='#tabs-config-<%= idProject %>' data-toggle='tab'><i class='icon-wrench' /> Configuration</a></li>",{idProject:window.app.status.currentProject}));c.append(_.template("<li><a href='#tabs-reviewdash-<%= idProject %>' data-toggle='tab'><i class='icon-chevron-down' /> Review</a></li>",{idProject:window.app.status.currentProject}));c.find("a[href='#tabs-reviewdash-"+window.app.status.currentProject+"']").parent().hide();$(document).on("click",'a[data-toggle="tab"]',function(f){var d=this.href.split("#")[1];$("#"+d).attr("style","width:100%;min-height:500px;overflow:auto;");if(a.triggerRoute){window.app.controllers.browse.navigate("#"+d,a.triggerRoute)}});$("#explorer > .browser").show();$("#explorer > .noProject").hide()},getDashboard:function(){return this.dashboard}});var AnnotationsPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.refreshAnnotationsTabsFunc=[];this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/AnnotationsPanel.tpl.html"],function(b){a.doLayout(b)});return this},createTabs:function(b){var a=this;require(["text!application/templates/explorer/TermTab.tpl.html","text!application/templates/explorer/TermTabContent.tpl.html"],function(d,k){var f=$("#annotationsPanel"+a.model.id);var h=f.find(".ultabsannotation");var c=f.find(".listtabannotation");h.append(_.template(d,{id:"all",image:a.model.id,name:"All"}));c.append(_.template(k,{id:"all",image:a.model.id,name:"All"}));a.refreshAnnotationsTabsFunc.push({index:0,idTerm:"all",refresh:function(){a.refreshAnnotations(undefined,$("#tabsterm-"+a.model.id+"-all"))}});var g=1;window.app.status.currentTermsCollection.each(function(i){h.append(_.template(d,{id:i.get("id"),image:a.model.id,name:i.get("name")}));c.append(_.template(k,{id:i.get("id"),image:a.model.id,name:i.get("name")}));a.refreshAnnotationsTabsFunc.push({index:g,idTerm:i.get("id"),refresh:function(){a.refreshAnnotations(i.get("id"),$("#tabsterm-"+a.model.id+"-"+i.get("id")))}});g++});var f=$("#annotationsPanel"+a.model.id);f.find(".tabsAnnotation").tabs({add:function(i,l){},select:function(i,l){var m=_.detect(a.refreshAnnotationsTabsFunc,function(n){return(n.index==l.index)});m.refresh.call()}});f.find(".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *").removeClass("ui-corner-all ui-corner-top").addClass("ui-corner-bottom")})},refreshAnnotationTabs:function(b){var a=this;if(b!=undefined){var d=_.detect(a.refreshAnnotationsTabsFunc,function(f){return(f.idTerm==b)});d.refresh.call()}else{var c=$("#"+a.browseImageView.divId).find("#annotationsPanel"+a.model.id).find(".tabsAnnotation").tabs("option","selected");a.refreshAnnotationsTabsFunc[c].refresh.call()}},refreshAnnotations:function(a,b){new AnnotationCollection({image:this.model.id,term:a}).fetch({success:function(f,d){b.empty();var c=new AnnotationView({page:undefined,model:f,el:b}).render()}})},doLayout:function(b){var a=this;var d=$("#"+a.browseImageView.divId).find("#annotationsPanel"+a.model.get("id"));var c=parseInt($(window).width());d.html(_.template(b,{id:a.model.get("id")}));new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(g,f){a.createTabs(g.get("ontology"))}});d.css("padding","0px");d.css("margin","0px");d.css("width","16px");d.css("height","16px");d.css("bottom","0px");d.find("div.panel_button").click(function(f){f.preventDefault();c=parseInt($(window).width());d.find("div.panel_button").toggle();d.css("bottom","0px");d.animate({height:"302px"},"fast").animate({width:c},"fast").find("div.panel_content").fadeIn();var h=d.find(".tabsAnnotation").tabs("option","selected");var g=_.detect(a.refreshAnnotationsTabsFunc,function(i){return(i.index==h)});g.refresh.call();return false});d.find("div#hide_button").click(function(f){f.preventDefault();d.animate({height:"16px"},"fast").animate({width:"16px"},"fast");setTimeout(function(){d.find("div.panel_content").hide();d.css("bottom","0px")},1000);return false});d.find("div.previous_button").click(function(){alert("prev"+a.currentAnnotation)});d.find("div.next_button").click(function(){alert("next"+a.currentAnnotation)});return this}});var LayerSwitcherPanel=SideBarPanel.extend({tagName:"div",initialize:function(a){this.browseImageView=a.browseImageView;this.followInterval=null;this.userFollowed=null;this.vectorLayers=[]},render:function(){var a=this;require(["text!application/templates/explorer/LayerSwitcher.tpl.html"],function(b){a.doLayout(b)});return this},addBaseLayer:function(f,c){var b=this;var g="layerSwitch-"+c.get("id");var a="layerSwitch-"+c.get("id")+"-"+new Date().getTime();var d=_.template("<li><input type='radio' id='<%=   id %>' name='<%=   radioName %>' checked/><span style='color : #ffffff;'> <%=   name %></span></li>",{id:a,radioName:g,name:f.name.substr(0,15)});$("#"+this.browseImageView.divId).find("#layerSwitcher"+this.model.get("id")).find(".baseLayers").append(d);$("#"+a).change(function(){b.browseImageView.map.setBaseLayer(f)})},addVectorLayer:function(h,g,f){var d=this;this.vectorLayers.push({id:f,vectorsLayer:h.vectorsLayer});var a="layerSwitch-"+g.get("id")+"-"+f+"-"+new Date().getTime();var c="#FFF";if(f=="REVIEW"){c="#5BB75B"}var b;if(h.isOwner){b=_.template("<li id='entry<%= userID %>'><input id='<%= id %>' class='showUser' type='checkbox'  value='<%= name %>' checked />&nbsp;&nbsp;<input type='checkbox' disabled/><span style='color :<%=   color %>;'> <%=   name %> <span class='numberOfAnnotation'></span></span></li>",{id:a,name:h.vectorsLayer.name,color:c,userID:f})}else{b=_.template("<li id='entry<%= userID %>' data-id='<%= userID %>'><input id='<%= id %>' class='showUser' type='checkbox' value='<%= name %>' />&nbsp;&nbsp;<input type='checkbox' class='followUser' data-user-id='<%= userID %>' disabled/>&nbsp;<span style='color : <%=   color %>;'><%= name %> <span class='numberOfAnnotation'></span></span></a> </li>",{userID:f,id:a,name:h.vectorsLayer.name,color:c})}console.log("*** addVectorLayer "+g.get("id"));$("#"+this.browseImageView.divId).find("#layerSwitcher"+g.get("id")).find("ul.annotationLayers").append(b);$("#"+a).click(function(){console.log("click");var i=$(this).is(":checked");console.log("visible:"+i);h.vectorsLayer.setVisibility(i);d.browseImageView.annotationProperties.updateAnnotationProperyLayers()})},updateOnlineUsers:function(d){var c=this;var a=$("#"+this.browseImageView.divId).find("#layerSwitcher"+this.model.get("id")).find("ul.annotationLayers");var b=_.pluck(window.app.models.projectUser.models,"id");if(!_.include(d,c.userFollowed)){a.find("li[data-id="+c.userFollowed+"]").find("input.followUser").removeAttr("checked");c.stopFollowing()}_.each(b,function(f){if(!_.include(d,f)){a.find("li[data-id="+f+"]").find("span").css("color","white");a.find("li[data-id="+f+"]").find("input.followUser").attr("disabled","disabled")}});_.each(d,function(f){a.find("li[data-id="+f+"]").find("span").css("color","#46a546");a.find("li[data-id="+f+"]").find("input.followUser").removeAttr("disabled")})},startFollowing:function(){var a=this;window.app.view.message("","Start following "+window.app.models.projectUser.get(a.userFollowed).prettyName(),"success");var b=this.model.get("id");this.followInterval=setInterval(function(){new UserPositionModel({image:b,user:a.userFollowed}).fetch({success:function(d,c){a.browseImageView.map.moveTo(new OpenLayers.LonLat(d.get("longitude"),d.get("latitude")),d.get("zoom"));var f=_.detect(a.vectorLayers,function(g){return g.id==a.userFollowed});if(f){f.vectorsLayer.refresh()}},error:function(d,c){}})},1000)},stopFollowing:function(){var a=this;if(a.followInterval!=undefined){window.app.view.message("","Stop following "+window.app.models.projectUser.get(a.userFollowed).prettyName(),"success");clearInterval(a.followInterval);a.followInterval=null;a.userFollowed=null}},doLayout:function(g){var k=this;var h=_.template(g,{id:k.model.get("id"),isDesktop:!window.app.view.isMobile});var i=$("#"+this.browseImageView.divId);i.find("#layerSwitcher"+k.model.get("id")).html(h);i.on("change",".followUser",function(m){var l=$(this).is(":checked");$("#"+k.browseImageView.divId).find("#layerSwitcher"+k.model.get("id")).find(".followUser:checked").each(function(){$(this).attr("checked",false)});console.log(l);$(this).attr("checked",l);console.log(this);k.stopFollowing();if(!l){return}k.userFollowed=$(this).attr("data-user-id");k.startFollowing()});$("#selectLayersIcon"+k.model.get("id")).off("click");$(document).on("change","#selectLayersIcon"+k.model.get("id"),function(o){console.log("change user annotation");var l=$("#"+k.browseImageView.divId).find("#layerSwitcher"+k.model.get("id")).find("ul.annotationLayers");var m=_.pluck(window.app.models.projectUser,"id");var n=false;_.each(m,function(p){var q=l.find("li[data-id="+p+"]").find("input.showUser").is(":checked");if(!n&&q){n=true}});if(l.find("li[data-id=REVIEW]").find("input.showUser").is(":checked")){n=true}k.browseImageView.setAllLayersVisibility(!n)});var f=$("#layerSwitcher"+k.model.get("id"));var c=f.find(".layerSwitcherContent1");var d=f.find(".toggle-content1");var b=f.find(".toggle-content2");var a=f.find(".layerSwitcherContent2");this.initToggle(f,c,d,"layerSwitcherContent1");this.initToggle(f,a,b,"layerSwitcherContent2")}});var ImageFiltersPanel=Backbone.View.extend({tagName:"div",filter:null,enabled:false,parameters:[],browseImageView:null,initialize:function(a){this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/ImageFiltersPanel.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=$("#"+this.browseImageView.divId).find("#imageFiltersPanel"+this.model.get("id"));this.model.set({isDesktop:!window.app.view.isMobile});c.html(_.template(b,this.model.toJSON()));c.find("#contrast"+this.model.get("id")).slider({min:0,max:256,value:128,change:function(d,f){a.redraw()}});c.find("#brightness"+this.model.get("id")).slider({min:0,max:256,value:128,change:function(d,f){a.redraw()}});c.find("input[name=invert]").change(function(){a.redraw()});c.find("input[name=filterActive]").change(function(){a.enabled=($(this).is(":checked"));a.redraw()});c.find("a[name=reset]").click(function(d){d.preventDefault();c.find("#brightness"+a.model.get("id")).slider("option","value",128);c.find("#contrast"+a.model.get("id")).slider("option","value",128);c.find("input[name=invert]").removeAttr("checked");return false})},updateGetURL:function(){var a=this;var b=function(c){c=this.adjustBounds(c);var g=this.map.getResolution();var k=Math.round((c.left-this.tileOrigin.lon)/(g*this.tileSize.w));var i=Math.round((this.tileOrigin.lat-c.top)/(g*this.tileSize.h));var h=this.map.getZoom();var f=k+i*this.tierSizeInTiles[h].w+this.tileCountUpToTier[h];var m="TileGroup"+Math.floor((f)/256)+"/"+h+"-"+k+"-"+i+".jpg";var d=this.url;var l=_.map(d,function(o){var p="";_.each(a.parameters,function(q){p+=q.key;p+="=";p+=q.value;p+="&"});var n=o.indexOf("method=");if(n==-1){o="vision/process?method=none&url="+o;n=o.indexOf("method=")}return o.substring(0,n)+p+o.substring(n,o.length)});if(OpenLayers.Util.isArray(l)){d=this.selectUrl(m,l)}return d+m};a.browseImageView.map.baseLayer.getURL=b;a.browseImageView.map.baseLayer.redraw()},redraw:function(){if(!this.enabled){this.parameters=[];this.updateGetURL();return}var b=$("#"+this.browseImageView.divId).find("#imageFiltersPanel"+this.model.get("id"));var c=parseInt(b.find("#brightness"+this.model.get("id")).slider("value"));var a=parseInt(b.find("#contrast"+this.model.get("id")).slider("value"));var d=(b.find("input[name=invert]").is(":checked"));this.parameters=[];this.parameters.push({key:"brightness",value:c});this.parameters.push({key:"contrast",value:a});if(d){this.parameters.push({key:"invert",value:true})}this.updateGetURL()}});var OverviewMapPanel=SideBarPanel.extend({tagName:"div",initialize:function(a){this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/OverviewMap.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(d){var a=this;var g=_.template(d,{id:a.model.get("id"),isDesktop:!window.app.view.isMobile});$("#overviewMap"+a.model.get("id")).html(g);var f=$("#overviewMap"+a.model.get("id"));var c=f.find(".overview-panel");var b=f.find(".toggle-content ");this.initToggle(f,c,b,"overview-panel")}});var OntologyPanel=SideBarPanel.extend({tagName:"div",initialize:function(a){this.ontologyTreeView=null;this.callback=a.callback;this.browseImageView=a.browseImageView},render:function(){var a=this;new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(d,c){var b=d.get("ontology");require(["text!application/templates/explorer/OntologyTree.tpl.html"],function(f){a.doLayout(f);new OntologyModel({id:b}).fetch({success:function(h,g){a.ontologyTreeView=new OntologyTreeView({el:$("#ontologytreecontent"+a.model.get("id")),browseImageView:a.browseImageView,model:h}).render();a.callback(a.ontologyTreeView)}})})}});return this},doLayout:function(c){var d=$("#ontologyTree"+this.model.get("id"));d.html(_.template(c,{id:this.model.get("id")}));var b=d.find(".ontologytreecontent");var a=d.find(".toggle-content");this.initToggle(d,b,a,"ontologytreecontent")}});var ReviewPanel=SideBarPanel.extend({tagName:"div",userLayers:null,userJobLayers:null,reviewLayer:null,initialize:function(a){this.browseImageView=a.browseImageView;this.userLayers=a.userLayers;this.userJobLayers=a.userJobLayers;this.printedLayer=[];this.layerName={}},isLayerPrinted:function(b){console.log("isLayerPrinted "+b);var a=false;_.each(this.printedLayer,function(c){if(c.id==b){a=true}});console.log("isLayerPrinted="+a);return a},render:function(){var a=this;require(["text!application/templates/explorer/ReviewPanel.tpl.html"],function(b){a.doLayout(b)});return this},initControl:function(d){var a=this;console.log("initControl="+d.name);var b=new OpenLayers.Control.SelectFeature(d.vectorsLayer);var c=d;c.initControls(a.browseImageView,b);c.registerEvents(a.browseImageView.map);c.controls.select.activate();if(_.isFunction(a.browseImageView.initCallback)){a.browseImageView.initCallback.call()}a.browseImageView.initAutoAnnoteTools()},addReviewLayerToReview:function(){var a=this;var c="REVIEW";var d=new AnnotationLayer(c,a.model.get("id"),0,"#ff0000",a.browseImageView.ontologyPanel.ontologyTreeView,a.browseImageView,a.browseImageView.map,true);d.loadAnnotations(a.browseImageView);a.printedLayer.push({id:c,vectorsLayer:d.vectorsLayer,layer:d});var b=new OpenLayers.Control.SelectFeature([d.vectorsLayer]);d.isOwner=true;d.initControls(a.browseImageView,b);d.registerEvents(a.browseImageView.map);a.browseImageView.userLayer=d;d.vectorsLayer.setVisibility(true);d.toggleIrregular();var f=$("#"+a.browseImageView.divId).find("#toolbar"+a.model.get("id"));f.find("a[id=select"+a.model.get("id")+"]").click();d.controls.select.activate();a.reviewLayer=d;_.each(this.printedLayer,function(g){g.layer.controls.select.activate()})},addLayerToReview:function(g){var i=this;console.log("----------");console.log(i.browseImageView.divId+" => "+g);if(g==undefined){return}var c=null;_.each(i.printedLayer,function(l){if(l.id==g){c=l.vectorsLayer;c.setVisibility(true)}});if(c){return}var k=$("#"+this.browseImageView.divId).find("#reviewPanel"+i.model.get("id"));var d=($("#"+i.browseImageView.divId).find("#toolbar"+i.model.get("id")).find("a#modify"+i.model.get("id")+".active").length==1);$("#"+i.browseImageView.divId).find("#toolbar"+i.model.get("id")).find("a#none"+i.model.get("id")).click();i.reviewLayer.controls.select.unselectAll();i.reviewLayer.removeSelection();i.addToListLayer(g);console.log("*********** Layer");console.log(g);console.log("*********** User");console.log(f);console.log("*********** self.userLayers");console.log(i.userLayers);console.log("*********** self.userJobLayers");console.log(i.userJobLayers);console.log("*********** self.userLayers.get(layer)");console.log(i.userLayers.get(g));console.log("*********** self.userJobLayers.get(layer)");console.log(i.userJobLayers.get(g));var f=i.userLayers.get(g);if(f==undefined){f=i.userJobLayers.get(g)}var h=new AnnotationLayer(f.prettyName(),i.model.get("id"),f.get("id"),f.get("color"),i.browseImageView.ontologyPanel.ontologyTreeView,i.browseImageView,i.browseImageView.map,true);h.isOwner=(f.get("id")==window.app.status.user.id);if(h.isOwner){i.browseImageView.userLayer=h}h.loadAnnotations(i.browseImageView);i.printedLayer.push({id:g,vectorsLayer:h.vectorsLayer,layer:h});var b=k.find("#reviewChoice"+i.model.get("id")).find("select");b.find("option#"+g).attr("disabled","disabled");b.val(b.find("option[disabled!=disabled]").first().attr("value"));var a=new OpenLayers.Control.SelectFeature(i.getVisibleVectorsLayer());h.initControls(i.browseImageView,a);h.registerEvents(i.browseImageView.map);if(g.isOwner){h.vectorsLayer.setVisibility(true);h.toggleIrregular()}else{}_.each(this.printedLayer,function(l){l.layer.controls.select.activate()});$("#"+i.browseImageView.divId).find("#toolbar"+i.model.get("id")).find("a#select"+i.model.get("id")).click();if(d){$("#"+i.browseImageView.divId).find("#toolbar"+i.model.get("id")).find("a#modify"+i.model.get("id")).click()}},getVisibleVectorsLayer:function(){var a=_.map(this.printedLayer,function(b){return b.vectorsLayer});return a},removeLayerFromReview:function(d){var b=this;var a=$("#"+this.browseImageView.divId).find("#reviewPanel"+b.model.get("id"));_.each(b.printedLayer,function(f){if(f.id==d){f.vectorsLayer.setVisibility(false)}});b.printedLayer=_.filter(b.printedLayer,function(f){return f.id!=d});a.find("#reviewLayerElem"+d).replaceWith("");var c=a.find("#reviewChoice"+b.model.get("id")).find("select");c.find("option#"+d).removeAttr("disabled")},addVectorLayer:function(d,c,b){var a=this;d.vectorsLayer.setVisibility(true)},addToListLayer:function(c){var b=this;var a=$("#"+this.browseImageView.divId).find("#reviewPanel"+b.model.get("id"));console.log("#######");console.log(this.browseImageView.divId+"=>"+c);a.find("#reviewSelection"+b.model.id).append('<span style="display:block;" id="reviewLayerElem'+c+'">'+b.layerName[c]+'<i class="icon-remove icon-white" id="removeReviewLayer'+c+'"></i></span>');$("#removeReviewLayer"+c).click(function(d){b.removeLayerFromReview(c)})},doLayout:function(m){var o=this;var i=$("#reviewPanel"+o.model.get("id"));var l={id:o.model.get("id"),isDesktop:!window.app.view.isMobile};var n=_.template(m,l);i.html(n);o.showCurrentAnnotation(null);if(!o.model.get("reviewed")){var k=i.find("#reviewChoice"+o.model.get("id")).find("select");this.userLayers.each(function(p){o.layerName[p.id]=p.layerName();k.append('<option value="'+p.id+'" id="'+p.id+'">'+p.layerName()+"</option>")});console.log("userJobLayers="+this.userJobLayers.length);this.userJobLayers.each(function(p){if(!p.get("isDeleted")){o.layerName[p.id]=p.layerName();k.append('<option value="'+p.id+'" id="'+p.id+'">'+p.layerName()+"</option>")}});$("#addReviewLayers"+o.model.id).click(function(){o.addLayerToReview(i.find("#reviewChoice"+o.model.get("id")).find("select").val())});$("#reviewMultiple"+o.model.id).click(function(){o.addAllReviewAnnotation()});$("#unReviewMultiple"+o.model.id).click(function(){o.deleteAllReviewAnnotation()});$("#reviewValidate"+o.model.id).click(function(){o.validatePicture()});$("#showReviewLayer"+o.model.id).on("change",function(){o.reviewLayer.vectorsLayer.setVisibility($(this).is(":checked"))})}else{var c=$("#"+o.browseImageView.divId).find("#reviewPanel"+o.model.get("id"));c.find("#showReviewLayer"+o.model.id).attr("disabled","disabled");c.find("#addReviewLayers"+o.model.id).attr("disabled","disabled");c.find("select").attr("disabled","disabled");c.find("#reviewMultiple"+o.model.id).attr("disabled","disabled");c.find("#unReviewMultiple"+o.model.id).attr("disabled","disabled");c.find("#reviewValidate"+o.model.id).hide();c.find("#reviewUnValidate"+o.model.id).show();$("#reviewUnValidate"+o.model.id).click(function(){o.unvalidatePicture()});i.find("#currentReviewAnnotation"+o.model.get("id")).hide();i.find("#reviewChoice"+o.model.get("id")).hide();i.find(".toggleShowAnnotation").click(function(p){p.preventDefault();return false});i.find(".toggleShowLayers").click(function(p){p.preventDefault();return false});i.find(".toggleShowAction").click(function(p){p.preventDefault();return false})}var h=i.find(".reviewPanelContent1");var g=i.find(".toggle-content1");var f=i.find(".reviewPanelContent2");var d=i.find(".toggle-content2");var b=i.find(".reviewPanelContent3");var a=i.find(".toggle-content3");this.initToggle(i,h,g,"reviewPanelContent1");this.initToggle(i,f,d,"reviewPanelContent2");this.initToggle(i,b,a,"reviewPanelContent3")},addReviewAnnotation:function(){var b=this;var a=b.browseImageView.currentAnnotation;var c=b.getSelectedTerm(a);b.browseImageView.removeFeature(a.id);new AnnotationReviewedModel({id:a.id}).save({terms:c},{success:function(f,d){b.refreshAnnotation(d,a)},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Annotation",g.errors,"error")}})},deleteReviewAnnotation:function(){var b=this;var a=b.browseImageView.currentAnnotation;b.browseImageView.removeFeature(a.id);new AnnotationReviewedModel({id:a.get("parentIdent")}).destroy({success:function(d,c){window.app.view.message("Annotation",c.message,"success");_.each(b.printedLayer,function(f){f.vectorsLayer.refresh()})},error:function(d,c){var f=$.parseJSON(c.responseText);window.app.view.message("Annotation",f.errors,"error")}})},refreshAnnotation:function(c,a){var b=this;var h=AnnotationLayerUtils.createFeatureFromAnnotation(c.reviewedannotation);var d=a.get("cropURL");var g=_.template("<img src='<%=   url %>' alt='<%=   alt %>' style='max-width: 175px;max-height: 175px;' />",{url:d,alt:d});var f=_.template("<p><%=   message %></p><div><%=   cropImage %></div>",{message:c.message,cropImage:g});window.app.view.message("Reviewed annotation",f,"success");b.reviewLayer.addFeature(h);b.reviewLayer.controls.select.unselectAll();b.reviewLayer.controls.select.select(h);_.each(b.printedLayer,function(i){i.vectorsLayer.refresh()})},showCurrentAnnotation:function(a){var b=this;console.log("showCurrentAnnotation="+a);$("#currentReviewAnnotation"+b.model.id).empty();require(["text!application/templates/explorer/ReviewPanelSelectedAnnotation.tpl.html"],function(f){var h={};var c;if(a==null){h={id:b.model.get("id"),username:"",date:"",isReviewed:false,idAnnotation:""};c=""}else{var d=window.app.models.projectUser.get(a.get("user"));if(d==undefined){d=window.app.models.projectUserJob.get(a.get("user"))}h={id:b.model.get("id"),username:d.prettyName(),date:window.app.convertLongToDate(a.get("created")),isReviewed:a.get("reviewed"),idAnnotation:a.id};c=a.id}var g=_.template(f,h);$("#currentReviewAnnotation"+b.model.id).append(g);if(h.idAnnotation==""){$("#currentReviewAnnotation"+b.model.id).find("#reviewSingle"+c).attr("disabled","disabled");$("#currentReviewAnnotation"+b.model.id).find("#unreviewSingle"+c).attr("disabled","disabled")}else{if(h.isReviewed){$("#currentReviewAnnotation"+b.model.id).find("#reviewSingle"+c).attr("disabled","disabled")}else{$("#currentReviewAnnotation"+b.model.id).find("#unreviewSingle"+c).attr("disabled","disabled")}}$("#currentReviewAnnotation"+b.model.id).find("#reviewSingle"+c).click(function(){b.addReviewAnnotation()});$("#currentReviewAnnotation"+b.model.id).find("#unreviewSingle"+c).click(function(){b.deleteReviewAnnotation()});$("#currentReviewAnnotation"+b.model.id).find("#reviewValidate"+c).click(function(){b.validatePicture()});b.showAnnotationTerm(a)})},showAnnotationTerm:function(a){var b=this;if(a!=null){var c=$("#currentReviewAnnotation"+b.model.id).find("#termsChoice"+a.id);c.empty();_.each(a.get("term"),function(d){b.addTermChoice(d,a.id,a.get("reviewed"))});$("#termsChoice"+a.id+" .termchoice").sort(b.asc_sort).appendTo("#termsChoice"+a.id)}},addTermChoice:function(b,a){this.addTermChoice(b,a,false)},addTermChoice:function(d,a,f){var c=this;var g=$("#currentReviewAnnotation"+c.model.id).find("#termsChoice"+a);var b="";if(f){b='disabled="disabled"'}g.append('<div class="termchoice"><input type="checkbox" '+b+' checked="checked" name="terms" value="'+d+'" id="termInput'+d+'"> '+window.app.status.currentTermsCollection.get(d).get("name")+"&nbsp;&nbsp;</div>")},asc_sort:function(d,c){return($(c).text())<($(d).text())},deleteTermChoice:function(c,a){var b=this;var d=$("#currentReviewAnnotation"+b.model.id).find("#termsChoice"+a);d.find("input#termInput"+c).replaceWith("")},getSelectedTerm:function(a){var c=this;var d=$("#currentReviewAnnotation"+c.model.id).find("#termsChoice"+a.id);var f=d.find("input[name='terms']:checked:enabled");var b=[];_.each(f,function(g){console.log("selectedTermsId it="+g);b.push($(g).val())});console.log("selectedTermsId="+b);return b},addAllReviewAnnotation:function(){var a=this;var b=_.map(_.filter(a.printedLayer,function(c){return c.id!="REVIEW"}),function(c){return c.id});if(b.length==0){window.app.view.message("Annotation","You must add at least one layer!","error")}else{new TaskModel({project:a.model.get("project")}).save({},{success:function(c,f){var d=c.get("task");console.log("task="+d);$("#taskreview"+a.model.id).append('<div id="task-'+d.id+'"></div>');$("#reviewChoice"+a.model.id).hide();$("#taskreview"+a.model.id).show();var g=window.app.view.printTaskEvolution(d,$("#taskreview"+a.model.id).find("#task-"+d.id),2000,false);new AnnotationImageReviewedModel({image:a.model.id,layers:b,task:d.id}).save({},{success:function(i,h){clearInterval(g);$("#taskreview"+a.model.id).empty();$("#taskreview"+a.model.id).hide();$("#reviewChoice"+a.model.id).show();window.app.view.message("Annotation","Annotation are reviewed!","success");_.each(a.printedLayer,function(k){k.vectorsLayer.refresh()})},error:function(i,h){console.log("AnnotationImageReviewedModel error");var k=$.parseJSON(h.responseText);window.app.view.message("Annotation",k.errors,"error");$("#taskreview"+a.model.id).empty();$("#taskreview"+a.model.id).hide();$("#reviewChoice"+a.model.id).show();clearInterval(g)}})},error:function(d,c){var f=$.parseJSON(c.responseText);window.app.view.message("Task",f.errors,"error")}})}},deleteAllReviewAnnotation:function(){console.log("deleteAllReviewAnnotation");var a=this;var b=_.map(_.filter(a.printedLayer,function(c){return c.id!="REVIEW"}),function(c){return c.id});if(b.length==0){window.app.view.message("Annotation","You must add at least one layer!","error")}else{require(["text!application/templates/review/ConfirmUnreviewDialog.tpl.html"],function(c){var d=new ConfirmDialogView({el:"#dialogs",template:_.template(c,{}),dialogAttr:{dialogID:"#unreview-confirm",backdrop:false}}).render();$("#unreview-confirm").find(".confirm").click(function(){new TaskModel({project:a.model.get("project")}).save({},{success:function(f,h){var g=f.get("task");$("#taskreview"+a.model.id).append('<div id="task-'+g.id+'"></div>');$("#reviewChoice"+a.model.id).hide();$("#taskreview"+a.model.id).show();var i=window.app.view.printTaskEvolution(g,$("#taskreview"+a.model.id).find("#task-"+g.id),2000,false);new AnnotationImageReviewedModel({image:a.model.id,layers:b,task:g.id}).destroy({success:function(l,k){clearInterval(i);$("#taskreview"+a.model.id).empty();$("#taskreview"+a.model.id).hide();$("#reviewChoice"+a.model.id).show();window.app.view.message("Annotation","All visible annotations are rejected!","success");_.each(a.printedLayer,function(m){m.vectorsLayer.refresh()})},error:function(l,k){console.log("AnnotationImageReviewedModel error");var m=$.parseJSON(k.responseText);window.app.view.message("Annotation",m.errors,"error");$("#taskreview"+a.model.id).empty();$("#taskreview"+a.model.id).hide();$("#reviewChoice"+a.model.id).show();clearInterval(i)}});d.close()},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Task",h.errors,"error")}})});$("#unreview-confirm").find(".cancel").click(function(){d.close()})})}},validatePicture:function(){var a=this;a.browseImageView.validatePicture()},unvalidatePicture:function(){var a=this;a.browseImageView.unvalidatePicture()},refresh:function(b){var a=this;a.model=b;a.render()}});var MultiDimensionPanel=SideBarPanel.extend({tagName:"div",initialize:function(a){this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/MultiDimensionPanel.tpl.html","text!application/templates/explorer/MultiDimensionSpinnerPanel.tpl.html"],function(b,c){a.doLayout(b,c)});return this},doLayout:function(b,d){var a=this;var c=a.model.toJSON();c.originalFilename=a.model.getVisibleName(window.app.status.currentProjectModel.get("blindMode"));console.log("create spinner");$.get("/api/imageinstance/"+c.id+"/imagesequence/possibilities.json",function(l){console.log("GET data:"+l);var o="This image has no other dimension.";if(l.c!=null&&l.c!=undefined){o="Picture is in position c: "+l.c+" z: "+l.z+" s: "+l.s+" t: "+l.t}c.position=o;var m=_.template(b,c);$("#multidimensionPanel"+a.model.get("id")).html(m);var k=$("#multidimensionPanel"+a.model.get("id"));var h=k.find(".dimPanelContent1");var i=k.find(".toggle-content1");var g=k.find(".dimPanelContent2");var f=k.find(".toggle-content2");a.initToggle(k,h,i,"dimPanelContent1");a.initToggle(k,g,f,"dimPanelContent2");var n=function(t,v,u){console.log("loadSpinner:"+t);var s=0;var p=0;var r=l[t];console.log("possibilities:"+r);var q="none";if(r!=null){s=_.min(r,function(w){return w});p=_.max(r,function(w){return w});q=p}console.log("multidimensionPanel");$("#multidimensionPanel"+a.model.get("id")).find(".spinnerChoice").append(_.template(d,{dim:v,dimText:v,possibility:q}));console.log("spinner:#spinner"+v);k.find("#spinner"+v).spinner({hold:true,value:u,min:s,max:p,disabled:(s==p&&p==0)});k.find("#spinner"+v).on("changed",function(){k.find(".goToImage").text("Go to layer c:"+a.getValue("Channel")+" z:"+a.getValue("Zstack")+" s:"+a.getValue("Slice")+" t:"+a.getValue("Time"))});k.find("#spinner"+v).find("button.spinner-up").click(function(){$(".goToImage").click()});k.find("#spinner"+v).find("button.spinner-down").click(function(){$(".goToImage").click()})};n("channel","Channel",l.c);n("zStack","Zstack",l.z);n("slice","Slice",l.s);n("time","Time",l.t);k.find(".goToImage").click(function(){a.goToDimension(l.imageGroup,a.getValue("Channel"),a.getValue("Zstack"),a.getValue("Slice"),a.getValue("Time"))})})},getValue:function(a){return $("#multidimensionPanel"+this.model.get("id")).find("#spinner"+a).spinner("value")},goToDimension:function(g,d,a,h,f){var b=this;var c="/api/imagegroup/"+g+"/"+d+"/"+a+"/"+h+"/"+f+"/imagesequence.json";console.log(c);$.get(c,function(n){var m=b.browseImageView.model;var k=n.image;var o=new ImageInstanceModel(n.model);if(k==m.id){return}var l=b.browseImageView.map.zoom;var i=b.browseImageView.map.center.lon;var p=b.browseImageView.map.center.lat;if(b.browseImageView.divPrefixId=="tabs-image"||m.get("reviewUser")!=null){window.app.controllers.browse.tabs.goToImage(k,m.get("project"),m.id,b.browseImageView.getMode(),o,i,p,l)}else{new ImageReviewModel({id:k}).save({},{success:function(r,q){window.app.view.message("Image",q.message,"success");window.app.controllers.browse.tabs.goToImage(k,m.get("project"),m.id,b.browseImageView.getMode(),o,i,p,l)},error:function(r,q){var s=$.parseJSON(q.responseText);window.app.view.message("Image",s.errors,"error")}})}})}});var InformationsPanel=SideBarPanel.extend({tagName:"div",initialize:function(a){this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/InformationsPanel.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(g){var k=this;var i=k.model.toJSON();i.originalFilename=k.model.getVisibleName(window.app.status.currentProjectModel.get("blindMode"));var h=_.template(g,i);$("#informationsPanel"+k.model.get("id")).html(h);var f=$("#informationsPanel"+k.model.get("id"));var c=f.find(".infoPanelContent1");var d=f.find(".toggle-content1");var b=f.find(".infoPanelContent2");var a=f.find(".toggle-content2");this.initToggle(f,c,d,"infoPanelContent1");this.initToggle(f,b,a,"infoPanelContent2");$("#getNext"+k.model.id).click(function(){new ImageInstanceModel({next:true,id:k.model.id}).fetch({success:function(m,l){if(m.get("project")){if(k.browseImageView.getMode()=="image"||m.get("reviewUser")!=null){window.app.controllers.browse.tabs.goToImage(m.id,m.get("project"),k.model.id,k.browseImageView.getMode(),m)}else{new ImageReviewModel({id:m.id}).save({},{success:function(n,o){m.fetch({success:function(p,q){window.app.view.message("Image",o.message,"success");window.app.controllers.browse.tabs.goToImage(p.id,p.get("project"),k.model.id,k.browseImageView.getMode(),p)}})},error:function(o,n){var p=$.parseJSON(n.responseText);window.app.view.message("Image",p.errors,"error")}})}}else{window.app.view.message("Next image","This is the last image","error")}}})});$("#getNext"+k.model.id).show();$("#getPrevious"+k.model.id).click(function(){new ImageInstanceModel({previous:true,id:k.model.id}).fetch({success:function(m,l){if(m.get("project")){if(k.browseImageView.getMode()=="image"||m.get("reviewUser")!=null){window.app.controllers.browse.tabs.goToImage(m.id,m.get("project"),k.model.id,k.browseImageView.getMode(),m)}else{new ImageReviewModel({id:m.id}).save({},{success:function(n,o){m.fetch({success:function(p,q){window.app.view.message("Image",o.message,"success");window.app.controllers.browse.tabs.goToImage(p.id,p.get("project"),k.model.id,k.browseImageView.getMode(),p)}})},error:function(o,n){var p=$.parseJSON(n.responseText);window.app.view.message("Image",p.errors,"error")}})}}else{window.app.view.message("Previous image","This is the first image","error")}}})});$("#getPrevious"+k.model.id).show()}});var AnnotationPropertyPanel=SideBarPanel.extend({tagName:"div",keyAnnotationProperty:null,annotationPropertyLayers:[],initialize:function(a){this.browseImageView=a.browseImageView;this.callback=a.callback},render:function(){var a=this;require(["text!application/templates/explorer/AnnotationPropertyPanel.tpl.html"],function(b){a.doLayout(b)});return this},initSelect:function(f){var a=$(this.el).find("#selectLayersAnnotationProperty-"+f);a.empty();var d=_.template("<option value='<%= id %>'><%= value %></option>",{id:"selectedEmpty",value:"No Key Selected"});a.append(d);$.get("/api/annotation/property/key.json?idImage="+f,function(g){_.each(g.collection,function(i){var h=_.template("<option value='<%= id %>'><%= value %></option>",{id:i,value:i});a.append(h)});c()});var c=function b(){var k=new Array();var h=document.getElementById("selectLayersAnnotationProperty-"+f);for(var g=0;g<h.options.length-1;g++){k[g]=h.options[g+1].text}k=k.sort();for(var g=0;g<h.options.length-1;g++){h.options[g+1].id=k[g];h.options[g+1].value=k[g];h.options[g+1].text=k[g]}}},doLayout:function(f){var a=this;var d=this.model.get("id");var g=$("#annotationPropertyPanel"+d);g.html(_.template(f,{id:d}));var c=g.find(".annotationPropertyContent");var b=g.find(".toggle-content");this.initToggle(g,c,b,"annotationPropertyContent");a.initSelect(d);$("#selectLayersAnnotationProperty-"+d).on("change",function(){a.updateAnnotationProperyLayers()})},updateAnnotationProperyLayers:function(){var a=this;var b=this.model.get("id");_.each(a.annotationPropertyLayers,function(d){d.removeFromMap()});a.annotationPropertyLayers=[];var c=$("#selectLayersAnnotationProperty-"+b).val();if(c!="selectedEmpty"){_.each(a.browseImageView.layers,function(f){if(f.vectorsLayer.visibility){var d=new AnnotationPropertyLayer(a.model.get("id"),f.userID,a.browseImageView,c);d.addToMap();d.setZIndex(726);a.annotationPropertyLayers.push(d)}})}}});var AnnotationPopupPanel=SideBarPanel.extend({tagName:"div",initialize:function(a){this.browseImageView=a.browseImageView;this.idAnnotation=a.idAnnotation},render:function(){var a=this;require(["text!application/templates/explorer/PopupAnnotation.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;new AnnotationModel({id:a.idAnnotation}).fetch({success:function(c,d){a.createPopup(b,c);a.browseImageView.showAnnotationInReviewPanel(c);a.initTooglePanel("annotation-info-panel",".toggle-content-info");a.initTooglePanel("annotation-property-panel",".toggle-content-property");a.initTooglePanel("annotation-preview-panel",".toggle-content-preview");a.initTooglePanel("annotation-suggested-panel",".toggle-content-suggested");a.initTooglePanel("annotation-description-panel",".toggle-content-description")}})},initTooglePanel:function(g,f){var a=this;var d=$("#annotationDetailPanel"+a.model.get("id"));var c=d.find("."+g);var b=d.find(f);a.initToggle(d,c,b,g)},createPopup:function(d,a){var c=this;var b=window.app.models.projectUser.get(a.get("user"));if(b==undefined){b=window.app.models.projectUserJob.get(a.get("user"))}a.set({username:b.prettyName()});console.log("current annotation = "+a.id);c.browseImageView.currentAnnotation=a;var h=[];if(a.get("reviewed")){_.each(a.get("term"),function(m){var l=window.app.status.currentTermsCollection.get(m).get("name");var i=window.app.status.currentProjectModel.get("ontology");var k=_.template("<a href='#ontology/<%=   idOntology %>/<%=   idTerm %>'><%=   termName %></a> ",{idOntology:i,idTerm:m,termName:l});h.push(k)})}else{_.each(a.get("userByTerm"),function(n){var m=n.term;var l=window.app.status.currentTermsCollection.get(m).get("name");var o=n.user.length;var i=window.app.status.currentProjectModel.get("ontology");var k=_.template("<a href='#ontology/<%=   idOntology %>/<%=   idTerm %>'><%=   termName %></a> (<%=   userCount %>)",{idOntology:i,idTerm:m,termName:l,userCount:o});h.push(k)})}a.set({terms:h.join(", ")});if(a.get("nbComments")==undefined){a.set({nbComments:0})}var g=_.template(d,a.toJSON());var f=$("#"+c.browseImageView.divId).find("#annotationDetailPanel"+c.browseImageView.model.id);f.html(g);f.show();$("#annotationHide"+a.id).off("click");$("#annotationHide"+a.id).on("click",function(){c.controls.select.unselectAll();var k=c.getFeature(a.id);if(k==undefined||k==null){return false}c.hideFeature(k);var i="";if(!c.reviewMode){i="tabs-image-"+window.app.status.currentProjectModel.get("id")+"-"+c.browseImageView.model.get("id")+"-"}else{i="tabs-review-"+window.app.status.currentProjectModel.get("id")+"-"+c.browseImageView.model.get("id")+"-"}window.app.controllers.browse.navigate(i,false);return false});if(window.app.status.currentProjectModel.get("privateLayer")||window.app.status.currentProjectModel.get("retrievalDisable")){$("#loadSimilarAnnotation"+a.id).html("Retrieval not available")}else{c.showSimilarAnnotation(a)}c.retrieveDescription(a)},showSimilarAnnotation:function(b){var a=this;console.log("showSimilarAnnotation");if(window.app.status.currentTermsCollection==undefined||(window.app.status.currentTermsCollection.length>0&&window.app.status.currentTermsCollection.at(0).id==undefined)){new TermCollection({idOntology:window.app.status.currentProjectModel.get("ontology")}).fetch({success:function(d,c){window.app.status.currentTermsCollection=d;a.showSimilarAnnotationResult(b)}})}else{a.showSimilarAnnotationResult(b)}},showSimilarAnnotationResult:function(b){var a=this;console.log("showSimilarAnnotationResult");new AnnotationRetrievalModel({annotation:b.id}).fetch({success:function(m,h){var c=m.get("term");var p;var k;var o=0;var l=0;_.each(c,function(i){o=o+i.rate;if(l==0){p=i}if(l==1){k=i}l++});var g;var f;var d=0;var n=0;if(p!=undefined){g=p.id;d=p.rate;if(d==0){g=undefined}}if(k!=undefined){f=k.id;n=k.rate;if(n==0){f=undefined}}d=(d/o)*100;n=(n/o)*100;a.printSuggestedTerm(b,window.app.status.currentTermsCollection.get(g),window.app.status.currentTermsCollection.get(f),d,n,window.app.status.currentTermsCollection,m.get("annotation"))},error:function(d,c){$("#loadSimilarAnnotation"+b.id).replaceWith("Error: cannot reach retrieval")}})},printSuggestedTerm:function(d,c,a,b,g,f,h){var l=this;var i="";var k="";if(c!=undefined){i+='<span id="changeBySuggest'+c.id+'" style="display : inline"><u>'+c.get("name")+"</u> ("+Math.round(b)+"%)<span>"}if(a!=undefined){k+=' or <span id="changeBySuggest'+a.id+'" style="display : inline"><u>'+a.get("name")+"</u> ("+Math.round(g)+"%)<span>"}$("#suggTerm"+d.id).empty();$("#suggTerm"+d.id).append(i);$("#suggTerm"+d.id).append(k);if(c!=undefined){l.createSuggestedTermLink(c,d)}if(a!=undefined){l.createSuggestedTermLink(a,d)}$("#loadSimilarAnnotation"+d.id).replaceWith('<a id="showRetrieval'+d.id+'" href="#myModalRetrieval" role="button" class="btn" data-toggle="modal">See similar annotations</a>');$("#showRetrieval"+d.id).click(function(n){n.preventDefault();console.log("click");var p=[c,a];var o=[b,g];var m=new AnnotationRetrievalView({model:new AnnotationRetrievalCollection(h),projectsPanel:l,container:l,el:"#annotationRetrievalInfo",baseAnnotation:d,terms:f,bestTerms:p,bestTermsValue:o}).render();return true})},createSuggestedTermLink:function(c,a){var b=this;$("#changeBySuggest"+c.id).click(function(){new AnnotationTermModel({term:c.id,userannotation:a.id,clear:true}).save(null,{success:function(f,d){window.app.view.message("Correct Term",d.message,"");b.ontologyPanel.ontologyTreeView.refresh(a.id)},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Correct term","error:"+g.errors,"")}})})},retrieveDescription:function(a){var b=this;var c=$(".textcontent"+a.id);console.log("retrieveDescription");DescriptionModal.initDescriptionView(a.id,a.get("class"),c,150,function(){var d=c.html();c.empty().append(d.replace(new RegExp("<h.>","g"),"<br>").replace(new RegExp("</h.>","g"),"<br>"))},function(){b.render()})}});var UploadFormView=Backbone.View.extend({statusLabels:{uploadedLabel:'<span class="label label-inverse">UPLOADED</span>',errorFormatLabel:'<span class="label label-important">ERROR FORMAT</span>',convertedLabel:'<span class="label label-info">TO DEPLOY</span>',deployedLabel:'<span class="label label-success">DEPLOYED</span>',errorConvertLabel:'<span class="label label-important">ERROR CONVERT</span>',uncompressed:'<span class="label label-success">UNCOMPRESSED</span>',to_deploy:'<span class="label label-info">TO DEPLOY</span>'},fileUploadErrors:{maxFileSize:"File is too big",minFileSize:"File is too small",acceptFileTypes:"Filetype not allowed",maxNumberOfFiles:"Max number of files exceeded",uploadedBytes:"Uploaded bytes exceed file size",emptyResult:"Empty file upload result"},initialize:function(a){this.uploadDataTables=null},events:{},render:function(){var a=this;require(["text!application/templates/upload/UploadForm.tpl.html"],function(b){a.doLayout(b)});return this},defineFileUpload:function(a,c){var b=this;$.widget("cytomine.fileupload",$.blueimp.fileupload,{options:{autoUpload:false,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:1,acceptFileTypes:/.+$/i,previewFileTypes:/^image\/(gif|jpeg|png)$/,previewMaxFileSize:5000000,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:true,dataType:"json",add:function(h,g){var f=$(this).data("fileupload"),d=g.files;console.log(f);f._adjustMaxNumberOfFiles(-d.length);g.isAdjusted=true;g.files.valid=g.isValidated=f._validate(d);g.context=f._renderUpload(d).appendTo(f._files).data("data",g);f._reflow=f._transition&&g.context[0].offsetWidth;g.context.addClass("in");if((f.options.autoUpload||g.autoUpload)&&g.isValidated){g.submit()}},send:function(g,f){if(!f.isValidated){var d=$(this).data("fileupload");if(!f.isAdjusted){d._adjustMaxNumberOfFiles(-f.files.length)}if(!d._validate(f.files)){return false}}if(f.context&&f.dataType&&f.dataType.substr(0,6)==="iframe"){f.context.find(".progressbar div").css("width",parseInt(100,10)+"%")}},done:function(i,g){var f=$(this).data("fileupload"),d,h;if(g.context){g.context.each(function(k){var l=($.isArray(g.result)&&g.result[k])||{error:"emptyResult"};if(l.error){f._adjustMaxNumberOfFiles(1)}f._transitionCallback($(this).removeClass("in"),function(m){d=f._renderDownload([l]);h=m.find(".preview img, .preview canvas");if(h.length){d.find(".preview img").prop("width",h.prop("width")).prop("height",h.prop("height"))}d.replaceAll(m);f._reflow=f._transition&&d[0].offsetWidth;d.addClass("in")})})}else{d=f._renderDownload(g.result).appendTo(f._files);f._reflow=f._transition&&d[0].offsetWidth;d.addClass("in")}},fail:function(h,g){var f=$(this).data("fileupload"),d;f._adjustMaxNumberOfFiles(g.files.length);if(g.context){g.context.each(function(i){if(g.errorThrown!=="abort"){var k=g.files[i];k.error=k.error||g.errorThrown||true;f._transitionCallback($(this).removeClass("in"),function(l){d=f._renderDownload([k]).replaceAll(l);f._reflow=f._transition&&d[0].offsetWidth;d.addClass("in")})}else{f._transitionCallback($(this).removeClass("in"),function(l){l.remove()})}})}else{if(g.errorThrown!=="abort"){f._adjustMaxNumberOfFiles(-g.files.length);g.context=f._renderUpload(g.files).appendTo(f._files).data("data",g);f._reflow=f._transition&&g.context[0].offsetWidth;g.context.addClass("in")}}},progress:function(f,d){if(d.context){d.context.find(".progressbar div").css("width",parseInt(d.loaded/d.total*100,10)+"%")}},progressall:function(f,d){$(this).find(".fileupload-progressbar div").css("width",parseInt(d.loaded/d.total*100,10)+"%")},start:function(){$(this).find(".fileupload-progressbar").addClass("in").find("div").css("width","0%")},stop:function(){$(this).find(".fileupload-progressbar").removeClass("in").find("div").css("width","0%")},destroy:function(g,f){var d=$(this).data("fileupload");if(f.url){$.ajax(f)}d._adjustMaxNumberOfFiles(1);d._transitionCallback(f.context.removeClass("in"),function(h){h.remove()})}},_enableDragToDesktop:function(){var h=$(this),f=h.prop("href"),d=decodeURIComponent(f.split("/").pop()).replace(/:/g,"-"),g="application/octet-stream";h.bind("dragstart",function(k){try{k.originalEvent.dataTransfer.setData("DownloadURL",[g,d,f].join(":"))}catch(i){}})},_adjustMaxNumberOfFiles:function(d){if(typeof this.options.maxNumberOfFiles==="number"){this.options.maxNumberOfFiles+=d;if(this.options.maxNumberOfFiles<1){this._disableFileInputButton()}else{this._enableFileInputButton()}}},_formatFileSize:function(d){if(typeof d!=="number"){return""}if(d>=1000000000){return(d/1000000000).toFixed(2)+" GB"}if(d>=1000000){return(d/1000000).toFixed(2)+" MB"}return(d/1000).toFixed(2)+" KB"},_hasError:function(d){if(d.error){return d.error}if(this.options.maxNumberOfFiles<0){return"maxNumberOfFiles"}if(!(this.options.acceptFileTypes.test(d.type)||this.options.acceptFileTypes.test(d.name))){return"acceptFileTypes"}if(this.options.maxFileSize&&d.size>this.options.maxFileSize){return"maxFileSize"}if(typeof d.size==="number"&&d.size<this.options.minFileSize){return"minFileSize"}return null},_validate:function(g){var f=this,d=!!g.length;$.each(g,function(h,i){i.error=f._hasError(i);if(i.error){d=false}});return d},_renderTemplate:function(f,g){var d=_.template(f,{o:{files:g,formatFileSize:this._formatFileSize,options:this.options,fileUploadErrors:b.fileUploadErrors}});return $(this.options.templateContainer).html(d).children()},_renderUpload:function(h){var g=this,f=this.options,d=this._renderTemplate(f.uploadTemplate,h);d.find(".preview span").each(function(i,l){var k=h[i];if(false&&f.previewFileTypes.test(k.type)&&(!f.previewMaxFileSize||k.size<f.previewMaxFileSize)){window.loadImage(h[i],function(m){$(l).append(m);g._reflow=g._transition&&l.offsetWidth;$(l).addClass("in")},{maxWidth:f.previewMaxWidth,maxHeight:f.previewMaxHeight,canvas:f.previewAsCanvas})}});return d},_renderDownload:function(f){var d=this._renderTemplate(this.options.downloadTemplate,f);d.find("a").each(this._enableDragToDesktop);return d},_startHandler:function(h){h.preventDefault();var f=$(this),d=f.closest(".template-upload"),g=d.data("data");if(g&&g.submit&&!g.jqXHR&&g.submit()){f.prop("disabled",true)}},_cancelHandler:function(g){g.preventDefault();var d=$(this).closest(".template-upload"),f=d.data("data")||{};if(!f.jqXHR){f.errorThrown="abort";g.data.fileupload._trigger("fail",g,f)}else{f.jqXHR.abort()}},_deleteHandler:function(f){f.preventDefault();var d=$(this);f.data.fileupload._trigger("destroy",f,{context:d.closest(".template-download"),url:d.attr("data-url"),type:d.attr("data-type"),dataType:f.data.fileupload.options.dataType})},_transitionCallback:function(f,g){var d=this;if(this._transition&&f.hasClass("fade")){f.bind(this._transitionEnd,function(h){if(h.target===f[0]){f.unbind(d._transitionEnd);g.call(d,f)}})}else{g.call(this,f)}},_initTransitionSupport:function(){var f=this,d=(document.body||document.documentElement).style,g="."+f.options.namespace;f._transition=d.transition!==undefined||d.WebkitTransition!==undefined||d.MozTransition!==undefined||d.MsTransition!==undefined||d.OTransition!==undefined;if(f._transition){f._transitionEnd=["MSTransitionEnd","webkitTransitionEnd","transitionend","oTransitionEnd"].join(g+" ")+g}},_initButtonBarEventHandlers:function(){var f=$(".fileupload-buttonbar"),g=this._files,d=this.options.namespace;f.find(".start").bind("click."+d,function(h){h.preventDefault();g.find(".start button").click()});f.find(".cancel").bind("click."+d,function(h){h.preventDefault();g.find(".cancel button").click()});f.find(".delete").bind("click."+d,function(h){h.preventDefault();g.find(".delete input:checked").siblings("button").click()});f.find(".toggle").bind("change."+d,function(h){g.find(".delete input").prop("checked",$(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace);this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){$.blueimp.fileupload.prototype._initEventHandlers.call(this);var d={fileupload:this};this._files.delegate(".start button","click."+this.options.namespace,d,this._startHandler).delegate(".cancel button","click."+this.options.namespace,d,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,d,this._deleteHandler);this._initButtonBarEventHandlers();this._initTransitionSupport()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers();this._files.undelegate(".start button","click."+this.options.namespace).undelegate(".cancel button","click."+this.options.namespace).undelegate(".delete button","click."+this.options.namespace);$.blueimp.fileupload.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",false).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",true).parent().addClass("disabled")},_initTemplates:function(){this.options.templateContainer=document.createElement(this._files.prop("nodeName"));this.options.uploadTemplate=a;this.options.downloadTemplate=c},_initFiles:function(){this._files=this.element.find(".files-list")},_create:function(){this._initFiles();$.blueimp.fileupload.prototype._create.call(this);this._initTemplates()},destroy:function(){$.blueimp.fileupload.prototype.destroy.call(this)},enable:function(){$.blueimp.fileupload.prototype.enable.call(this);this.element.find("input, button").prop("disabled",false);this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",true);this._disableFileInputButton();$.blueimp.fileupload.prototype.disable.call(this)}})},getStatusLabel:function(a){if(a.uploaded){return this.statusLabels.uploadedLabel}else{if(a.converted){return this.statusLabels.convertedLabel}else{if(a.deployed){return this.statusLabels.deployedLabel}else{if(a.error_format){return this.statusLabels.errorFormatLabel}else{if(a.error_convert){return this.statusLabels.errorConvertLabel}else{if(a.uncompressed){return this.statusLabels.uncompressed}else{if(a.to_deploy){return this.statusLabels.to_deploy}}}}}}}return"?"},appendUploadedFile:function(a,b){var c="<tr><td><%= originalFilename %></td><td><%= created %></td><td><%= size %></td><td><%= contentType %></td><td><%= status %></td></tr>";a.set({status:this.getStatusLabel(a)});b.append(_.template(c,a.toJSON()))},injectFnReloadAjax:function(){$.fn.dataTableExt.oApi.fnReloadAjax=function(g,d,h,c){if(typeof d!="undefined"&&d!=null){g.sAjaxSource=d}this.oApi._fnProcessingDisplay(g,true);var f=this;var a=g._iDisplayStart;var b=[];this.oApi._fnServerParams(g,b);g.fnServerData(g.sAjaxSource,b,function(m){f.oApi._fnClearTable(g);var k=(g.sAjaxDataProp!=="")?f.oApi._fnGetObjectDataFn(g.sAjaxDataProp)(m):m;for(var l=0;l<k.length;l++){f.oApi._fnAddData(g,k[l])}g.aiDisplay=g.aiDisplayMaster.slice();f.fnDraw();if(typeof c!="undefined"&&c===true){g._iDisplayStart=a;f.fnDraw(false)}f.oApi._fnProcessingDisplay(g,false);if(typeof h=="function"&&h!=null){h(g)}},g)}},renderUploadedFiles:function(){var a=this;var c=$("#uploaded_files");var d=$("#loadingUploadedFiles");var b=new UploadedFileCollection({dataTables:true}).url();c.hide();d.show();this.injectFnReloadAjax();a.uploadDataTables=c.dataTable({sDom:"<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",sPaginationType:"bootstrap",oLanguage:{sLengthMenu:"_MENU_ records per page"},iDisplayLength:25,bDestroy:true,bProcessing:true,aoColumns:[{mDataProp:"filename"},{mDataProp:"created"},{mDataProp:"size"},{mDataProp:"contentType"},{mDataProp:"uploaded"}],aoColumnDefs:[{fnRender:function(g,f){return a.getStatusLabel(g.aData)},aTargets:[4]}],sAjaxSource:b});c.show();d.hide();$(document).on("click","#refreshUploadedFiles",function(f){f.preventDefault();a.uploadDataTables.fnReloadAjax()})},doLayout:function(c){var a=this;$(this.el).html(c);var b=$("#linkProjectSelect");var d=$("#linkWithProject");var f=$("#linkStorageSelect");b.attr("disabled","disabled");d.removeAttr("checked");d.off("change");d.on("change",function(g){if($(this).is(":checked")){b.removeAttr("disabled")}else{b.attr("disabled","disabled")}});new ProjectCollection().fetch({success:function(i,h){var g="<option value='<%= id %>'><%= name %></option>";i.each(function(l){var k=_.template(g,l.toJSON());b.append(k)})}});new StorageCollection().fetch({success:function(i,h){var g="<option value='<%= id %>'><%= name %></option>";i.each(function(l){var k=_.template(g,l.toJSON());f.append(k)})}});this.renderUploadedFiles();require(["text!application/templates/upload/upload.tpl.html","text!application/templates/upload/download.tpl.html"],function(h,i){a.defineFileUpload(h,i);$("#fileupload").fileupload({limitConcurrentUploads:10,maxFileSize:5000000000});var g=window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s");$("#fileupload").bind("fileuploadsubmit",function(p,n){var k=$("#linkProjectSelect");var l=$("#linkWithProject");var o=null;if(l.is(":checked")){o=k.val()}var m=f.val();n.formData={idProject:o,idStorage:m};return true});$("#fileupload").bind("fileuploadsend",function(m,k){if(k.dataType.substr(0,6)==="iframe"){var l=$("<a/>").prop("href",k.url)[0];if(window.location.host!==l.host){k.formData.push({name:"redirect",value:g})}}});$("#fileupload .files").delegate("a:not([rel^=gallery])","click",function(k){k.preventDefault();$('<iframe style="display:none;"></iframe>').prop("src",this.href).appendTo(document.body)})})}});var ImageReviewAction=Backbone.View.extend({tagName:"div",initialize:function(a){this.el=a.el;this.model=a.model;this.container=a.container},configureAction:function(){var a=this;var b=$(a.el);b.find("#exploreButton"+a.model.id).click(function(){window.location="#tabs-image-"+a.model.get("project")+"-"+a.model.get("id")+"-"});if(a.isNotReviewed()){b.find("#explore"+a.model.id).show();b.find("#review"+a.model.id).hide();b.find("#reviewCyto"+a.model.id).hide();b.find("#startreview"+a.model.id).show();b.find("#startCytoreview"+a.model.id).show();b.find("#cancelreview"+a.model.id).hide();b.find("#validateimage"+a.model.id).hide();b.find("#unvalidateimage"+a.model.id).hide();b.find("#moreinfo"+a.model.id).show();b.find("#description"+a.model.id).show()}else{if(a.isInReviewing()){b.find("#explore"+a.model.id).show();b.find("#review"+a.model.id).show();b.find("#reviewCyto"+a.model.id).show();b.find("#startreview"+a.model.id).hide();b.find("#startCytoreview"+a.model.id).hide();if(a.model.get("numberOfReviewedAnnotations")==0){b.find("#cancelreview"+a.model.id).show()}else{b.find("#cancelreview"+a.model.id).hide()}b.find("#validateimage"+a.model.id).show();b.find("#unvalidateimage"+a.model.id).hide();b.find("#moreinfo"+a.model.id).show();b.find("#description"+a.model.id).show()}else{b.find("#explore"+a.model.id).show();b.find("#review"+a.model.id).show();b.find("#reviewCyto"+a.model.id).show();b.find("#startreview"+a.model.id).hide();b.find("#startCytoreview"+a.model.id).hide();b.find("#cancelreview"+a.model.id).hide();b.find("#validateimage"+a.model.id).hide();b.find("#unvalidateimage"+a.model.id).show();b.find("#moreinfo"+a.model.id).show();b.find("#description"+a.model.id).show()}}b.find("#startreview"+a.model.id).on("click",function(){a.startReviewing();return false});b.find("#startCytoreview"+a.model.id).on("click",function(){a.startCytoReviewing();return false});b.find("#cancelreview"+a.model.id).on("click",function(){a.cancelReviewing();return false});b.find("#validateimage"+a.model.id).on("click",function(){a.validateImage();return false});b.find("#unvalidateimage"+a.model.id).on("click",function(){a.cancelReviewing();return false});$(document).on("click","a.moreinfo"+a.model.id,function(){$("#image-properties").remove();new ImagePropertiesView({model:a.model}).render();return false});$(document).on("click","a.description"+a.model.id,function(){console.log("Click");new DescriptionModel({domainIdent:a.model.id,domainClassName:a.model.get("class")}).fetch({success:function(d,c){DescriptionModal.initDescriptionModal(b.find(".action"+a.model.id),d.id,a.model.id,a.model.get("class"),d.get("data"),function(){});b.find(".action"+a.model.id).find("a.description").click()},error:function(d,c){DescriptionModal.initDescriptionModal(b.find(".action"+a.model.id),null,a.model.id,a.model.get("class"),"",function(){});b.find(".action"+a.model.id).find("a.description").click()}});return false})},startReviewing:function(){var a=this;console.log("startReviewing");new ImageReviewModel({id:a.model.id}).save({},{success:function(c,b){window.app.view.message("Image",b.message,"success");a.model=new ImageModel(b.imageinstance);a.container.refresh();window.location="#tabs-review-"+a.model.get("project")+"-"+a.model.get("id")+"-"},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("Image",d.errors,"error")}})},startCytoReviewing:function(){var a=this;console.log("startCytoReviewing");new ImageReviewModel({id:a.model.id}).save({},{success:function(c,b){window.app.view.message("Image",b.message,"success");a.model=new ImageModel(b.imageinstance);a.container.refresh();window.location="#tabs-reviewdash-"+a.model.get("project")+"-"+a.model.get("id")+"-null-null"},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("Image",d.errors,"error")}})},cancelReviewing:function(){var a=this;console.log("cancelReviewing");new ImageReviewModel({id:a.model.id,cancel:true}).destroy({success:function(c,b){window.app.view.message("Image",b.message,"success");console.log(b);a.model=new ImageModel(b.imageinstance);a.container.refresh()},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("Image",d.errors,"error")}})},validateImage:function(){var a=this;console.log("validateImage");new ImageReviewModel({id:a.model.id}).destroy({success:function(c,b){window.app.view.message("Image",b.message,"success");console.log(b);a.model=new ImageModel(b.imageinstance);a.container.refresh()},error:function(c,b){var d=$.parseJSON(b.responseText);window.app.view.message("Image",d.errors,"error")}})},isNotReviewed:function(){return this.model.get("reviewStart")==null},isInReviewing:function(){return this.model.get("reviewStart")!=null&&this.model.get("reviewStop")==null}});var ImageThumbView=Backbone.View.extend({className:"thumb-wrap",tplProperties:null,events:{},initialize:function(a){this.id="thumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){this.model.set({project:window.app.status.currentProject});var a=this;require(["text!application/templates/image/ImageThumb.tpl.html","text!application/templates/image/ImageThumbProperties.tpl.html","text!application/templates/image/ImageReviewAction.tpl.html"],function(d,g,f){a.tplProperties=g;var b=a.model.getVisibleName(window.app.status.currentProjectModel.get("blindMode"));a.model.set("originalFilename",b);var h=(b.length<27)?b:b.substr(0,24)+"...";var c=Math.round(1000*a.model.get("resolution"))/1000;a.model.set({title:h,resolution:c});$(a.el).html(_.template(d,a.model.toJSON()));$(a.el).find("#image-properties-"+a.model.id).html(_.template(g,a.model.toJSON()));$(a.el).find("#imagereviewaction-thumb-"+a.model.id).append(_.template(f,a.model.toJSON()));a.addReviewInfo();a.configureAction()});return this},isNotReviewed:function(){return this.model.get("reviewStart")==null},isInReviewing:function(){return this.model.get("reviewStart")!=null&&this.model.get("reviewStop")==null},addReviewInfo:function(){var a=this;var b=$(a.el).find("#reviewingImageData"+a.model.id);if(a.isNotReviewed()){b.append('<span class="label">Not yet reviewed</span>')}else{if(a.isInReviewing()){b.append('<span class="label label-warning">'+window.app.models.projectUser.get(a.model.get("reviewUser")).prettyName()+" starts reviewing</span>")}else{b.append('<span class="label label-success">'+window.app.models.projectUser.get(a.model.get("reviewUser")).prettyName()+" has reviewed</span>")}}},refresh:function(){this.render()},configureAction:function(){var a=new ImageReviewAction({el:this.el,model:this.model,container:this});a.configureAction()}});var ImageSelectView=Backbone.View.extend({events:{},initialize:function(a){this.id="thumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){var a=this;this.model.set({project:window.app.status.currentProject});var a=this;require(["text!application/templates/image/ImageChoice.tpl.html"],function(b){$(a.el).html(_.template(b,a.model.toJSON()))});return this}});var ImageView=Backbone.View.extend({tagName:"div",initialize:function(a){this.images=null;this.container=a.container;this.page=a.page;this.nb_thumb_by_page=30;this.appendingThumbs=false;this.tabsContent=undefined;if(this.page==undefined){this.page=0}_.bindAll(this,"render")},render:function(){var a=this;this.tabsContent=[];if(window.app.status.currentProjectModel.get("numberOfImages")!=0){$(a.el).empty()}else{require(["text!application/templates/dashboard/NoImageAvailable.tpl.html"],function(b){$(a.el).html(_.template(b,{idProject:window.app.status.currentProjectModel.id}))})}a.appendThumbs(a.page);$(window).scroll(function(){var b=""+window.location;if(b.search("#tabs-images-")==-1){return}if(a.appendingThumbs){return}if(($(window).scrollTop()+50)>=$(document).height()-$(window).height()){a.appendThumbs(++a.page)}});return this},showLoading:function(){window.app.view.message("Loading...","","info")},appendThumbs:function(d){var b=this;b.appendingThumbs=true;var c=Math.abs(d)*this.nb_thumb_by_page;var a=(Math.abs(d)+1)*this.nb_thumb_by_page;if(c>window.app.status.currentProjectModel.get("numberOfImages")){return}if(Math.abs(d)*this.nb_thumb_by_page<b.model.size()){this.showLoading()}b.model=new ImageInstanceCollection({project:window.app.status.currentProject});b.model.server_api.offset=c;b.model.server_api.max=a-c;b.model.fetch({success:function(l,g){var m=window.app.status.currentProject+"-image-page-"+b.page;if($("#"+m).length==0){$(b.el).append(_.template("<div id='<%= idDivPage %>'></div>",{idDivPage:m}))}var k=0;while(k<(a-c)&&k<l.size()){var i=l.at(k);var h=_.find(b.tabsContent,function(n){return n.id_image==i.id});if(h){var f=h.thumb;f.model=i;f.refresh()}else{var f=new ImageThumbView({model:i});f.render();$("#"+m).append(f.el);b.tabsContent.push({id_image:i.id,thumb:f})}k++}b.appendingThumbs=false}})},add:function(c){var b=this;var a=new ImageThumbView({model:c,className:"row",id:"thumb"+c.get("id")}).render();$(b.el).append(a.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(){for(var a=0;a<=this.page;a++){this.appendThumbs(a)}}});var ImageInstanceDataSource=function(a){this._formatter=a.formatter;this._columns=a.columns;this._delay=a.delay||0;this._collection=a.collection;this._container=a.container};ImageInstanceDataSource.prototype={columns:function(){return this._columns},data:function(b,c){var a=this;console.log("options.pageSize"+b.pageSize);b.pageSize=b.pageSize||10;setTimeout(function(){var f=$.extend(true,[],a._data);if(b.search){a._collection.server_api.search=b.search}else{delete a._collection.server_api.search}if(b.sortProperty){a._collection.server_api.sortColumn=b.sortProperty;a._collection.server_api.sortDirection=b.sortDirection}var g=b.pageIndex*b.pageSize;var d=g+b.pageSize;if(a._collection.max!=b.pageSize){a._collection=new ImageInstanceCollection({project:a._collection.project,max:b.pageSize})}a._collection.goTo(b.pageIndex,{success:function(o,k){var n=[];o.each(function(q){q.set("originalFilename",q.getVisibleName(window.app.status.currentProjectModel.get("blindMode")))});n=o.toJSON();var l=o.fullSize;var i=(d>l)?l:d;var h=Math.ceil(l/b.pageSize);var m=b.pageIndex+1;var p=g+1;if(a._formatter){a._formatter(n)}c({data:n,start:p,end:i,count:l,pages:h,page:m});o.each(function(q){var r=new ImageReviewAction({el:("#MyGrid > tbody"),model:q,container:a._container});r.configureAction()})}})},this._delay)}};var ImageTabsView=Backbone.View.extend({tagName:"div",images:null,idProject:null,searchPanel:null,initialize:function(a){this.idProject=a.idProject;this.container=a.container},refresh:function(){$("#MyGrid").datagrid("renderData")},render:function(){var a=this;require(["text!application/templates/image/ImageReviewAction.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=new ImageInstanceDataSource({container:a,columns:[{property:"id",label:"ID",sortable:true},{property:"thumb",label:"Preview",sortable:false},{property:"originalFilename",label:"Name",sortable:true},{property:"width",label:"Width",sortable:true},{property:"height",label:"Height",sortable:true},{property:"magnification",label:"X",sortable:true},{property:"resolution",label:"Resolution",sortable:true},{property:"numberOfAnnotations",label:"User an.",sortable:true},{property:"numberOfJobAnnotations",label:"Algo an.",sortable:true},{property:"numberOfReviewedAnnotations",label:"Valid an.",sortable:true},{property:"mime",label:"Mime",sortable:true},{property:"created",label:"Created",sortable:true},{property:"status",label:"Status",sortable:false},{property:"action",label:"Action",sortable:false}],formatter:function(d){$.each(d,function(f,g){g.thumb=_.template("<div style='width : 130px;'><a href='#tabs-image-<%= project %>-<%=  id  %>-'><img src='<%= thumb %>' alt='originalFilename' style='max-height : 45px;max-width : 128px;'/></a></div>",g);g.action=_.template(b,g);g.created=window.app.convertLongToDate(g.created);if(g.resolution){g.resolution=g.resolution.toFixed(3)+"µm/pixel"}if(g.reviewed){g.status='<span class="label label-success">Reviewed</span>'}else{if(g.inReview){g.status='<span class="label label-warning">In review</span>'}else{g.status='<span class="label label-info">None</span>'}}})},collection:new ImageInstanceCollection({project:this.idProject,max:10}),delay:250});$("#MyGrid").datagrid({dataSource:c,dataOptions:{pageIndex:0,pageSize:10},stretchHeight:false});$("#MyGrid").datagrid({dataSource:c,stretchHeight:false});$("#projectImageListing"+a.idProject).hide();$("#projectImageTable"+a.idProject).show()}});var ImagePropertiesView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(b){var a=this;this.dialog=new ConfirmDialogView({el:"#dialogs",template:_.template(b,this.model.toJSON()),dialogAttr:{dialogID:"#image-properties"}}).render();$("#closeImagePropertiesDialog").click(function(c){c.preventDefault();a.dialog.close();return false});return this},render:function(){var a=this;require(["text!application/templates/image/ImageProperties.tpl.html"],function(b){a.doLayout(b);a.printProperties()});return this},printProperties:function(){var a=this;require(["text!application/templates/image/ImageProperty.tpl.html"],function(b){new ImagePropertyCollection({image:a.model.get("baseImage")}).fetch({success:function(f,c){var d=$("#image-properties-content");$("#image-properties-content").empty();f.sort();f.each(function(g){var h=_.template(b,{key:g.get("key"),value:g.get("value")});d.append(h)})}})})}});var ontologyUsersDialog=Backbone.View.extend({usersOntologyDialog:null,initialize:function(a){_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyUsers.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=_.template(b,{id:a.model.id,name:a.model.get("name")});$("#ontologyUsers"+a.model.id).replaceWith("");$(a.el).append(c);a.printCreator();a.printUsers();console.log("Open element:"+$("#ontologyUsers"+a.model.id).length);a.usersOntologyDialog=$("#ontologyUsers"+a.model.id).modal({keyboard:true,backdrop:false});$("#closeUserOntologyDialog"+a.model.id).click(function(){console.log("close!");$("#ontologyUsers"+a.model.id).modal("hide");$("#ontologyUsers"+a.model.id).remove()});a.open();return this},printCreator:function(){var a=this;new UserCollection({ontology:a.model.id,creator:true}).fetch({success:function(c,b){$("#ontologyCreator").empty();c.each(function(d){$("#ontologyCreator").append(d.prettyName())})}})},printUsers:function(){var a=this;new UserCollection({ontology:a.model.id}).fetch({success:function(c,b){$("#ontologyUsers").empty();c.each(function(d){$("#ontologyUsers").append(d.prettyName()+" | ")})}})},open:function(){var a=this;$("#ontologyUsers"+a.model.id).modal("show")}});var OntologyPanelView=Backbone.View.extend({$tree:null,$infoOntology:null,$infoTerm:null,$panel:null,$addTerm:null,$editTerm:null,$deleteTerm:null,initialize:function(a){this.container=a.container},render:function(){var a=this;a.$panel=$(".ontology"+a.model.id);a.$tree=a.$panel.find("#treeontology-"+a.model.id);a.$infoOntology=a.$panel.find("#infoontology-"+a.model.id);a.$infoTerm=a.$panel.find("#infoterm-"+a.model.id);a.$addTerm=a.$panel.find("#dialog-add-ontology-term");a.$editTerm=a.$panel.find("#dialog-edit-ontology-term");a.$deleteTerm=a.$panel.find("#dialogsTerm");a.buildOntologyTree();a.buildInfoOntologyPanel();a.initEvents();return this},initEvents:function(){var a=this;console.log("initEvents:"+a.model.id);$("#buttonAddTerm"+this.model.id).click(function(){a.addTerm()});$("#buttonEditTerm"+this.model.id).click(function(){a.editTerm()});$("#buttonDeleteTerm"+this.model.id).click(function(){a.deleteTerm()});$("#buttonEditOntology"+this.model.id).click(function(){a.editOntology()});$("#buttonDeleteOntology"+this.model.id).click(function(){a.deleteOntology()})},refresh:function(){var a=this;a.container.refresh(a.model.id)},clear:function(){var a=this;a.$panel.empty();require(["text!application/templates/ontology/OntologyTabContent.tpl.html"],function(b){a.$panel.replaceWith(_.template(b,{id:a.model.get("id"),name:a.model.get("name")}));return this});return this},getCurrentTermId:function(){var a=this.$tree.dynatree("getActiveNode");if(a==null){return null}else{return a.data.id}},addTerm:function(){var a=this;a.$addTerm.remove();new OntologyAddOrEditTermView({ontologyPanel:a,el:a.el,ontology:a.model,model:null}).render()},editTerm:function(){var a=this;console.log("OntologyPanelView.editTerm");a.$editTerm.remove();var b=a.$tree.dynatree("getActiveNode");if(b==null){window.app.view.message("Term","You have to select a term first","error");return}new TermModel({id:b.data.id}).fetch({success:function(d,c){new OntologyAddOrEditTermView({ontologyPanel:a,el:a.el,model:d,ontology:a.model}).render()}});return false},deleteTerm:function(){var a=this;var b=a.getCurrentTermId();var c=window.app.models.terms.get(b);a.buildDeleteTermConfirmDialog(c)},editOntology:function(){var a=this;$("#editontology").remove();a.editOntologyDialog=new EditOntologyDialog({ontologyPanel:a,el:a.el,model:a.model}).render()},deleteOntology:function(){var a=this;require(["text!application/templates/ontology/OntologyDeleteConfirmDialog.tpl.html"],function(b){new ConfirmDialogView({el:"#dialogsDeleteOntologyAccept",template:_.template(b,{ontology:a.model.get("name")}),dialogAttr:{backdrop:false,dialogID:"#delete-ontology-confirm"}}).render();$("#deleteOntologyButton").click(function(c){c.preventDefault();new TaskModel({project:a.model.id}).save({},{success:function(d,g){var f=d.get("task");console.log("task"+f.id);var h=window.app.view.printTaskEvolution(f,$("#deleteOntologyDialogContent"),1000);new OntologyModel({id:a.model.id,task:f.id}).destroy({success:function(k,i){window.app.view.message("Project",i.message,"success");a.container.refresh(null);clearInterval(h);$("#delete-ontology-confirm").modal("hide");$("#delete-ontology-confirm").remove()},error:function(k,i){window.app.view.message("Ontology","Errors!","error");clearInterval(h);var l=$.parseJSON(i.responseText);window.app.view.message("Ontology",l.errors[0],"error")}});return false},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Task",g.errors,"error")}});return false});$("#closeDeleteOntologyDialog").click(function(c){c.preventDefault();$("#delete-ontology-confirm").modal("hide");$("#delete-ontology-confirm").modal("remove");return false})})},selectTerm:function(b){var a=this;a.$tree.dynatree("getTree").activateKey(b)},buildDeleteTermConfirmDialog:function(b){var a=this;require(["text!application/templates/ontology/OntologyDeleteTermConfirmDialog.tpl.html"],function(c){var d=new ConfirmDialogView({el:"#dialogsTerm",template:_.template(c,{term:b.get("name"),ontology:a.model.get("name")}),dialogAttr:{backdrop:false,dialogID:"#delete-term-confirm"}}).render();console.log("closeDeleteTermDialog="+$("#closeDeleteTermDialog").length);$("#closeDeleteTermDialog").click(function(f){f.preventDefault();$("#delete-term-confirm").modal("hide");$("#delete-term-confirm").remove();return false});$("#deleteTermButton").click(function(f){f.preventDefault();a.removeTerm(b,"#delete-term-confirm");return false})})},removeTerm:function(b,c){var a=this;new TermModel({id:b.id}).destroy({success:function(f,d){window.app.view.message("Term",d.message,"success");a.refresh();$(c).modal("hide");$(c).remove()},error:function(f,d){var g=$.parseJSON(d.responseText);$("#delete-term-error-message").empty();$("#delete-term-error-label").show();$("#delete-term-error-message").append(g.errors)}})},buildInfoOntologyPanel:function(){var a=this;a.$infoOntology.empty();var d="seeUserOntology-"+a.model.id;var c=_.template("<div id='userontologyinfo-<%= id %>' style='padding:5px;'><ul><li><b>Ontology</b> : <%= ontologyName %></li><li><b>Users</b> : <button id='"+d+"' class='btn'>See users list</button></li><li class='projectsLinked'></li></ul></div>",{id:a.model.id,ontologyName:a.model.get("name")});a.$infoOntology.html(c);$("#"+d).click(function(){console.log("open ontology user "+a.model.id);new ontologyUsersDialog({model:a.model,el:$("#ontology")}).render()});var b=[];_.each(a.model.get("projects"),function(g){var f=_.template("<a href='#tabs-dashboard-<%=   idProject %>'><%=   projectName %></a>",{idProject:g.id,projectName:g.name});b.push(f)});var c=_.template("<b>Projects</b> : <%=   projects %>",{projects:b.join(", ")});a.$infoOntology.find(".projectsLinked").html(c)},buildOntologyTree:function(){var a=this;var b=new Date();a.$tree.empty();$("#treeontology-"+a.model.id).dynatree({children:a.model.toJSON(),onExpand:function(){},onClick:function(d,c){},onSelect:function(c,d){},onActivate:function(c){},onDblClick:function(d,c){},onRender:function(d,c){a.$tree.find("a.dynatree-title").css("color","black")},initId:"treeDataOntology-"+a.model.id+b.getTime(),cookieId:"dynatree-Ontology-"+a.model.id+b.getTime(),idPrefix:"dynatree-Ontology-"+a.model.id+b.getTime()+"-",debugLevel:0});a.colorizeOntologyTree();a.expandOntologyTree()},colorizeOntologyTree:function(){var a=this;$("#treeontology-"+a.model.id).dynatree("getRoot").visit(function(d){if(d.children!=null){return}var g=d.data.title;var c=d.data.color;var f="<a href='#ontology/<%=   idOntology %>/<%=   idTerm %>' onClick='window.location.href = this.href;'><%=   title %> <span style='background-color:<%= color %>'>&nbsp;&nbsp;&nbsp;&nbsp;</span></a>";var b=_.template(f,{idOntology:a.model.id,idTerm:d.data.id,title:g,color:c});d.setTitle(b)})},expandOntologyTree:function(){var a=this;$("#treeontology-"+a.model.id).dynatree("getRoot").visit(function(b){b.expand(true)})}});var OntologyView=Backbone.View.extend({tagName:"div",self:this,alreadyBuild:false,ontologiesPanel:null,idOntology:null,addOntologyDialog:null,allTerms:[],events:{"click #ontologyAddButton":"showAddOntologyPanel","click #ontologyRefreshButton":"refreshOntology"},initialize:function(a){this.container=a.container;this.idOntology=a.idOntology;this.idTerm=a.idTerm},render:function(){var a=this;require(["text!application/templates/ontology/OntologyList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{}));a.fillOntologyMenu();return this},fillOntologyMenu:function(){var a=this;console.log("fillOntologyMenu");new OntologyCollection({light:true}).fetch({success:function(c,b){console.log("ontology fetch");c.each(function(d){console.log("add ontology");$("#menuOntologyUl").append('<li data-id="'+d.id+'" id="consultOntology-'+d.id+'"><a href="#ontology/'+d.id+'"><i class="icon-arrow-right"></i> '+d.get("name")+"</a></li>")});a.selectOntology()}})},select:function(b,c){var a=this;if(a.idOntology==b){return}a.idOntology=b;a.idTerm=c;a.selectOntology()},selectOntology:function(){console.log("selectOntology:"+this.idOntology);var b=this;if($("#menuOntologyUl").children().length==1){return}if(b.idOntology==null){console.log($("#menuOntologyUl").children()[1]);var a=$("#menuOntologyUl").children()[1];b.idOntology=$(a).attr("data-id")}console.log("self.idOntology="+b.idOntology);$("#menuOntologyUl").children().removeClass("active");$("#consultOntology-"+b.idOntology).addClass("active");b.printOntology();$(window).scrollTop(0)},printOntology:function(){console.log("printOntology");var a=this;$("#ontologyPanelView").append('<div id="ontologyLoading" class="alert alert-info"><i class="icon-refresh" /> Loading...</div>');new OntologyModel({id:a.idOntology}).fetch({success:function(c,b){window.app.models.terms=window.app.retrieveTerm(c);console.log("OntologyModel succes "+a.idOntology);require(["text!application/templates/ontology/OntologyTabContent.tpl.html"],function(f){$("#ontologyPanelView").empty();$("#ontologyPanelView").append(_.template(f,c.toJSON()));var d=new OntologyPanelView({model:c,el:$("#ontologyPanelView"),container:a});d.render();if(a.idTerm!=null){d.selectTerm(a.idTerm)}})}})},refreshOntology:function(){this.render()},refresh:function(a){console.log("refresh idOntology="+a);this.idOntology=a;this.render()},refresh:function(a,b){this.idOntology=a;this.idTerm=b;this.render()},showAddOntologyPanel:function(){var a=this;$("#addontology").remove();a.addOntologyDialog=new AddOntologyDialog({ontologiesPanel:a,el:a.el}).render()}});var OntologyAddOrEditTermView=Backbone.View.extend({ontologyPanel:null,ontologyDialog:null,ontology:null,$tree:null,$panel:null,$textboxName:null,$colorChooser:null,$inputOldColor:null,$inputNewColor:null,$errorMessage:null,$errorLabel:null,$addFolderButton:null,action:null,events:{"click .addFolder":"addFolder"},initialize:function(a){this.container=a.container;this.ontologyPanel=a.ontologyPanel;this.ontology=a.ontology},render:function(){var a=this;console.log("OntologyAddOrEditTermView.render");require(["text!application/templates/ontology/OntologyAddOrEditTermView.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;if(a.model==null){a.action="Add";a.createNewEmpty()}else{a.action="Edit"}a.$termDialog=$(a.el).find("#dialog-"+a.action+"-ontology-term");$("#dialog-Edit-ontology-term").replaceWith("");$("#dialog-Add-ontology-term").replaceWith("");var b=_.template(c,{oldColor:a.model.get("color"),action:a.action});$(a.el).append(b);a.$panel=$(a.el);a.$termDialog=$(a.el).find("#dialog-"+a.action+"-ontology-term");a.$tree=a.$panel.find("#"+a.action+"ontologytermtree");a.$from=a.$panel.find($("#form-"+a.action+"-ontology-term"));a.$textboxName=a.$panel.find("#"+a.action+"termname");a.$colorChooser=a.$panel.find("#colorpicker1AddOrEditTerm");a.$inputOldColor=a.$panel.find("#oldColorAddOrEditTerm");a.$inputNewColor=a.$panel.find("#color1AddOrEditTerm");a.$addFolderButton=a.$panel.find(".addFolder");a.$errorMessage=a.$panel.find("#"+a.action+"ontologytermerrormessage");a.$errorLabel=a.$panel.find("#"+a.action+"ontologytermerrorlabel");a.$from.submit(function(){if(a.action=="Edit"){a.updatedOntologyTerm()}else{a.createOntologyTerm()}return false});a.$from.find("input").keydown(function(d){if(d.keyCode==13){a.$from.submit();return false}});a.clearOntologyTermPanel();a.buildNameInfo();a.buildColorInfo();a.buildParentInfo();a.ontologyDialog=$(a.$termDialog).modal({keyboard:true,backdrop:false});$("#AddOrEditTermButton").click(function(d){d.preventDefault();a.$from.submit();return false});$("#closeAddOrEditTermDialog").click(function(d){d.preventDefault();a.$termDialog.modal("hide");a.$termDialog.remove();return false});a.open();return this},createNewEmpty:function(){var a=this;a.model=new TermModel({id:-1,name:"",color:"#ff0000"})},buildNameInfo:function(){var a=this;a.$textboxName.bind("keyup mouseup change click",function(g){var d=a.$tree.dynatree("getTree").getNodeByKey(a.model.id);var c="#119b04";var f="<span style='color:<%=   color %>'><%=   title %></span>";var b=_.template(f,{title:a.$textboxName.val(),color:c});if(d!=null){d.setTitle(b)}});a.$textboxName.val(a.model.get("name"))},buildColorInfo:function(){var c=this;var a=c.$colorChooser.farbtastic("#color1AddOrEditTerm");var b=c.model.get("color");c.$inputOldColor.val(b);c.$inputNewColor.val(b);c.$inputOldColor.css("background",b);c.$inputNewColor.css("background",b);c.$inputNewColor.css("color",c.$inputOldColor.css("color"))},addFolder:function(){},buildParentInfo:function(){var a=this;a.$addFolderButton.button({icons:{secondary:"ui-icon-folder-collapsed"}});a.$tree.empty();a.$tree.dynatree({children:a.ontology.toJSON(),onExpand:function(){},onRender:function(f,d){a.$tree.find("a.dynatree-title").css("color","black")},onClick:function(f,d){},onSelect:function(d,f){},onCustomRender:function(d){},onDblClick:function(f,d){},dnd:{onDragStart:function(d){if(d.data.key!=a.model.id){return false}return true},onDragStop:function(d){},autoExpandMS:1000,preventVoidMoves:true,onDragEnter:function(f,d){return true},onDragOver:function(g,f,d){},onDragLeave:function(f,d){},onDrop:function(h,g,f,i,d){if(f=="over"){g.move(h,f);h.data.isFolder=true;h.render()}else{g.move(h,f)}}},generateIds:true,initId:""+a.action+"treeDataOntology-"+a.model.id,cookieId:""+a.action+"dynatree-Ontology-"+a.model.id,idPrefix:""+a.action+"dynatree-Ontology-"+a.model.id+"-",debugLevel:0});if(a.action=="Add"){var c=a.$tree.dynatree("getTree").getNodeByKey(a.ontology.id);var b=c.addChild({title:"",key:-1,tooltip:"This folder and all child nodes were added programmatically.",isFolder:false})}a.$tree.dynatree("getRoot").visit(function(d){d.expand(true)});if(a.action=="Edit"){a.$textboxName.click()}},getNewName:function(){var a=this;return a.$textboxName.val()},getNewParent:function(){var a=this;var b=a.$tree.dynatree("getTree").getNodeByKey(a.model.id);return b.parent.data.id},getNewColor:function(){return this.$inputNewColor.val()},refresh:function(){},open:function(){var a=this;console.log("open");a.clearOntologyTermPanel()},clearOntologyTermPanel:function(){var a=this;a.$errorMessage.empty();a.$errorLabel.hide()},updatedOntologyTerm:function(){var c=this;c.$errorMessage.empty();c.$errorLabel.hide();var i=c.model.id;var f=c.getNewName();var h=c.model.get("parent");console.log("idParent="+h);var g=c.getNewParent();console.log("idNewParent="+g);console.log("self.ontology.id="+c.ontology.id);var d=(h==null||c.ontology.id==h);var a=(c.ontology.id==g);var b=c.getNewColor();c.model.set({name:f,color:b});c.model.save({name:f,color:b},{success:function(l,k){if((g!=h)&&!(d&&a)){if(d){console.log("//parent was ontology so nothing to delete");c.addRelation(i,g)}else{if(a){console.log("//new parent is ontology so nothing to add");c.resetRelation(i,h,null)}else{console.log("resetRelation");c.resetRelation(i,h,g)}}}else{c.close()}},error:function(l,k){var m=$.parseJSON(k.responseText);window.app.view.message("Term",m.errors,"error")}})},createOntologyTerm:function(){var c=this;c.$errorMessage.empty();c.$errorLabel.hide();console.log("createOntologyTerm");var g=c.model.id;var d=c.getNewName();var a=true;var f=c.getNewParent();console.log("idParent="+f);console.log("self.ontology.id="+c.ontology.id);if(c.ontology.id!=f){a=false}var b=c.getNewColor();c.model.set({name:d,color:b});c.model=new TermModel({name:d,color:b,ontology:c.ontology.id}).save({name:d,color:b,ontology:c.ontology.id},{success:function(i,h){console.log("createOntologyTerm.success");if(a){window.app.view.message("Term",h.message,"success");c.close()}else{c.addRelation(h.term.id,f)}},error:function(i,h){console.log("createOntologyTerm.error");var k=$.parseJSON(h.responseText);window.app.view.message("Term",k.errors,"error")}})},resetRelation:function(d,b,c){console.log("reset relation");var a=this;console.log("resetRelation1");new RelationTermModel({id:1,term1:b,term2:d}).destroy({success:function(g,f){console.log("resetRelation2");if(c!=null){a.addRelation(d,c)}else{window.app.view.message("Term",f.message,"success");a.close()}},error:function(g,f){var h=$.parseJSON(f.responseText);a.$errorLabel.show();a.$errorMessage.append(h.errors)}})},addRelation:function(c,b){console.log("add relation");var a=this;new RelationTermModel({}).save({term1:b,term2:c},{success:function(f,d){console.log("add relation2");window.app.view.message("Term",d.message,"success");a.close()},error:function(f,d){var g=$.parseJSON(d.responseText);a.$errorLabel.show();a.$errorMessage.append(g.errors)}})},close:function(){var a=this;this.ontologyPanel.refresh();a.$termDialog.modal("hide")}});var OntologyTreeView=Backbone.View.extend({tagName:"div",annotationTerm:{},initialize:function(a){this.tree=null;this.activeEvent=true;this.browseImageView=a.browseImageView;this.idAnnotation=null},showColors:function(){$(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.children!=null){return}var f=c.data.title;var b=c.data.color;var d="<%=   title %> <span style='background-color:<%=   color %>'>&nbsp;&nbsp;</span> ";if(!c.data.isFolder){d=d+"(<span id='usercount"+c.data.key+"'>0</span>)"}var a=_.template(d,{title:f,color:b});c.setTitle(a)})},render:function(){var a=this;require(["text!application/templates/explorer/OntologyTreeWrapper.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){$(this.el).html(_.template(b,{isDesktop:!window.app.view.isMobile}));this.tree=$(this.el).find(".tree");var a=this;$(this.el).find(".tree").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:this.model.toJSON(),onSelect:function(c,d){if(!a.activeEvent){return}if(a.idAnnotation==null){return}if(d.isSelected()){if(a.browseImageView.isCurrentAnnotationUser()){console.log("link");if(a.browseImageView.currentAnnotation.get("class")=="be.cytomine.ontology.ReviewedAnnotation"){window.app.view.message("Reviewed annotation","You cannot add a term to an accepted annotation, you must reject it before!","error");a.activeEvent=false;d.select(false);a.activeEvent=true}else{a.linkTerm(d.data.key)}}else{console.log("addTermToReviewPanel");a.browseImageView.addTermToReviewPanel(d.data.key)}}else{if(!d.isSelected()){if(a.browseImageView.isCurrentAnnotationUser()){a.unlinkTerm(d.data.key)}else{a.browseImageView.deleteTermFromReviewPanel(d.data.key)}}}},onDblClick:function(d,c){d.toggleSelect()},onRender:function(d,c){$(c).find("span.dynatree-icon").css({"background-image":"url(css/custom-theme/images/ui-icons_ffffff_256x240.png)"})},initId:"treeData"+this.model.id,cookieId:"dynatree-Cb"+this.model.id,idPrefix:"dynatree-Cb"+this.model.id+"-"});a.showColors();$(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==a.model.id){c.expand(true)}});return this},expand:function(){$(this.el).find(".tree").dynatree("getRoot").visit(function(a){a.expand(true)})},clear:function(){var a=this;this.activeEvent=false;$(this.el).find(".otherUsersTerms").empty();$(this.el).find(".tree").dynatree("getRoot").visit(function(b){b.select(false);$("#usercount"+b.data.key).text("0")});this.activeEvent=true},clearAnnotation:function(){this.idAnnotation=null},check:function(b){var a=this;a.activeEvent=false;$(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==b){c.select(true)}});a.activeEvent=true},uncheck:function(b){var a=this;a.activeEvent=false;$(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==b){c.select(false)}});a.activeEvent=true},refresh:function(a){var b=this;console.log("refresh term for annotation "+a);this.idAnnotation=a;var c=function(h,f){console.log("collection.lenght="+h.length);b.annotationTerm=h;b.clear();b.activeEvent=false;var g=h.filter(function(i){return i.get("user")==window.app.status.user.id});_.each(g,function(k){var i=k.get("term");b.check(i)});var d=[];h.each(function(i){d.push(i.get("term"))});d=_.uniq(d);_.each(d,function(i){var k=h.filter(function(l){return l.get("term")==i});$("#usercount"+i).text(_.size(k))});b.activeEvent=true};new AnnotationTermCollection({idAnnotation:a}).fetch({success:c})},getTermsChecked:function(){var a=[];$(this.el).find(".tree").dynatree("getRoot").visit(function(b){if(b.isSelected()){a.push(b.data.key)}});return a},linkTerm:function(b){var a=this;new AnnotationTermModel({userannotation:this.idAnnotation,term:b}).save({userannotation:this.idAnnotation,term:b},{success:function(d,c){window.app.view.message("Annotation Term",c.message,"success");a.browseImageView.reloadAnnotation(a.idAnnotation);a.browseImageView.refreshAnnotationTabs(b)},error:function(d,c){var f=$.parseJSON(c.responseText);window.app.view.message("Annotation-Term",f.errors,"error")}})},unlinkTerm:function(b){var a=this;console.log("unlinkTerm IdTerm "+b+" : "+this.idAnnotation);var c=a.annotationTerm.find(function(d){return(d.get("term")==b&&d.get("user")==window.app.status.user.id)});new AnnotationTermModel({id:c.id,userannotation:a.idAnnotation,term:b}).destroy({success:function(f,d){window.app.view.message("Annotation Term",d.message,"success");a.browseImageView.reloadAnnotation(a.idAnnotation);a.browseImageView.refreshAnnotationTabs(b)},error:function(f,d){var g=$.parseJSON(d.responseText);window.app.view.message("Annotation-Term",g.errors,"error")}})}});var EditOntologyDialog=Backbone.View.extend({ontologyPanel:null,editOntologyDialog:null,initialize:function(a){this.container=a.container;this.ontologyPanel=a.ontologyPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyEditDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;$("#editontology").replaceWith("");$("#addontology").replaceWith("");var b=_.template(c,{});$(a.el).append(b);$("#login-form-edit-ontology").submit(function(){a.editOntology();return false});$("#login-form-edit-ontology").find("input").keydown(function(d){if(d.keyCode==13){$("#login-form-edit-ontology").submit();return false}});a.editOntologyDialog=$("#editontology").modal({keyboard:true,backdrop:false});$("#editOntologyButton").click(function(d){d.preventDefault();$("#login-form-edit-ontology").submit();return false});$("#closeEditOntologyDialog").click(function(d){d.preventDefault();$("#editontology").modal("hide");$("#editontology").remove();return false});a.open();a.fillForm();return this},fillForm:function(){var a=this;$("#ontology-edit-name").val(a.model.get("name"))},refresh:function(){},open:function(){var a=this;a.clearEditOntologyPanel()},clearEditOntologyPanel:function(){var a=this;$("#ontologyediterrormessage").empty();$("#ontologyediterrorlabel").hide();$("#ontology-edit-name").val("")},editOntology:function(){var a=this;$("#ontologyediterrormessage").empty();$("#ontologyediterrorlabel").hide();var b=$("#ontology-edit-name").val().toUpperCase();var c=a.model;c.unset("children");c.save({name:b},{success:function(f,d){window.app.view.message("Ontology",d.message,"success");$("#editontology").modal("hide");a.ontologyPanel.refresh()},error:function(f,d){var g=$.parseJSON(d.responseText);$("#ontologyediterrorlabel").show();$("#ontologyediterrormessage").append(g.errors)}})}});var AddOntologyDialog=Backbone.View.extend({ontologiesPanel:null,addOntologyDialog:null,initialize:function(a){this.container=a.container;this.ontologiesPanel=a.ontologiesPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyAddDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var b=this;var d=_.template(c,{});$("#editontology").replaceWith("");$("#addontology").replaceWith("");$(b.el).append(d);var a=window.app.status.user.model;$("#ontologyuser").append(a.get("username")+" ("+a.get("firstname")+" "+a.get("lastname")+")");$("#login-form-add-ontology").submit(function(){b.createOntology();return false});$("#login-form-add-ontology").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-add-ontology").submit();return false}});b.addOntologyDialog=$("#addontology").modal({keyboard:true,backdrop:false});$("#saveOntologyButton").click(function(f){f.preventDefault();$("#login-form-add-ontology").submit();return false});$("#closeAddOntologyDialog").click(function(f){f.preventDefault();$("#addontology").modal("hide");$("#addontology").remove();return false});b.open();return this},refresh:function(){},open:function(){var a=this;a.clearAddOntologyPanel()},clearAddOntologyPanel:function(){$("#errormessage").empty();$("#ontologyerrorlabel").hide();$("#ontology-name").val("")},createOntology:function(){var a=this;$("#errormessage").empty();$("#ontologyerrorlabel").hide();var b=$("#ontology-name").val().toUpperCase();var c=$("input[type=radio][name=ontologyradio]:checked").attr("value");var d=[];$("input[type=checkbox][name=usercheckbox]:checked").each(function(f,g){d.push($(g).attr("value"))});var c=new OntologyModel({name:b}).save({name:b},{success:function(g,f){window.app.view.message("Ontology",f.message,"success");var h=f.ontology.id;a.ontologiesPanel.refresh(h);$("#addontology").modal("hide")},error:function(g,f){var h=$.parseJSON(f.responseText);$("#ontologyerrorlabel").show();$("#errormessage").append(h.errors)}})}});var ProjectUsersDialog=Backbone.View.extend({usersProjectDialog:null,initialize:function(a){_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectUsers.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;var b=_.template(c,{id:a.model.id,name:a.model.get("name")});$("#projectUsers"+a.model.id).replaceWith("");$(a.el).append(b);a.printCreator();a.printAdmins();a.printUsers();console.log("Open element:"+$("#projectUsers"+a.model.id).length);a.usersProjectDialog=$("#projectUsers"+a.model.id).modal({keyboard:true,backdrop:false});$("#closeUserProjectDialog").click(function(d){d.preventDefault();$("#projectUsers"+a.model.id).modal("hide");$("#projectUsers"+a.model.id).remove();return false});a.open();return this},printCreator:function(){var a=this;new UserCollection({project:a.model.id,creator:true}).fetch({success:function(c,b){$("#projectCreatorDialog").empty();var d=[];c.each(function(f){d.push(f.prettyName())});$("#projectCreatorDialog").append(d.join(", "))}})},printAdmins:function(){var a=this;new UserCollection({project:a.model.id,admin:true}).fetch({success:function(b,c){$("#projectAdminsDialog").empty();var d=[];b.each(function(f){d.push(f.prettyName())});$("#projectAdminsDialog").append(d.join(", "))}})},printUsers:function(){var a=this;new UserCollection({project:a.model.id}).fetch({success:function(d,b){$("#projectUsersDialog").empty();var c=[];d.each(function(f){c.push(f.prettyName())});$("#projectUsersDialog").append(c.join(", "))}})},open:function(){var a=this;$("#projectUsers"+a.model.id).modal("show")}});var ProjectView=Backbone.View.extend({tagName:"div",searchProjectPanelElem:"#searchProjectPanel",projectListElem:"#projectlist",projectList:null,addSlideDialog:null,initialize:function(a){this.container=a.container;this.model=a.model;this.el=a.el;this.searchProjectPanel=null;this.addProjectDialog=null;this.ontologies=this.getOntologiesChoice();this.disciplines=this.getDisciplinesChoice()},render:function(){var a=this;require(["text!application/templates/project/ProjectList.tpl.html","text!application/templates/project/NewProjectBox.tpl.html"],function(c,b){a.doLayout(c,b)});return this},doLayout:function(c,b){var a=this;$(this.el).find("#projectdiv").html(_.template(c,{}));$(a.projectListElem).empty();$(a.projectListElem).append(_.template(b,{}));$("#projectaddbutton").on("click",function(){a.showAddProjectPanel()});a.loadSearchProjectPanel();a.loadProjectsListing();return this},showAddProjectPanel:function(){var a=this;$("#addproject").remove();a.addProjectDialog=new AddProjectDialog({projectsPanel:a,el:a.el,ontologies:a.ontologies,disciplines:a.disciplines}).render()},refresh:function(){var b=this;var a=undefined;if(b.addSlideDialog!=null){b.addSlideDialog.refresh()}new ProjectCollection({user:a}).fetch({success:function(d,c){b.model=d;b.render()}})},getFullWidth:function(){return Math.round($(window).width()-90)},generateAddProjectPanel:function(){var a=this;require(["text!application/templates/project/AddProjectPanel.tpl.html"],function(b){$(a.projectListElem).append(_.template(b,{}))});return this},loadSearchProjectPanel:function(){var a=this;a.searchProjectPanel=new ProjectSearchPanel({model:a.model,ontologies:a.ontologies,disciplines:a.disciplines,el:$("#projectViewNorth"),container:a,projectsPanel:a}).render()},getOntologiesChoice:function(){var a=new Backbone.Collection;a.comparator=function(b){return b.get("name")};_.each(this.model.models,function(b){if(a.get(b.get("ontology"))==undefined){a.add({id:b.get("ontology"),name:b.get("ontologyName")})}});return a},getDisciplinesChoice:function(){var a=new Backbone.Collection;a.comparator=function(b){return b.get("name")};_.each(this.model.models,function(b){if(a.get(b.get("discipline"))==undefined&&b.get("discipline")!=null){a.add({id:b.get("discipline"),name:b.get("disciplineName")})}});return a},loadProjectsListing:function(){var a=this;a.projectList=[];a.model.each(function(c){var b=new ProjectPanelView({model:c,projectsPanel:a,container:a}).render();a.projectList.push(b);$(a.projectListElem).append(b.el)})},showProjects:function(b){var a=this;a.model.each(function(c){if(b.get(c.id)!=null){$(a.projectListElem+c.id).show()}else{$(a.projectListElem+c.id).hide()}})}});var ProjectPanelView=Backbone.View.extend({tagName:"div",loadImages:true,imageOpened:false,project:null,projectElem:"#projectlist",imageOpenElem:"#projectopenimages",imageAddElem:"#projectaddimages",projectChangeElem:"#radioprojectchange",projectChangeDialog:"div#projectchangedialog",loadImagesInAddPanel:true,projectsPanel:null,container:null,initialize:function(a){this.container=a.container;this.projectsPanel=a.projectsPanel;_.bindAll(this,"render")},events:{"click .addSlide":"showAddSlidesPanel","click .seeSlide":"showSlidesPanel","click .editProject":"editProject","click .deleteProject":"deleteProject","click .infoProject":"infoProject"},render:function(){var a=this;require(["text!application/templates/project/ProjectDetail.tpl.html"],function(b){a.doLayout(b,false)});return this},refresh:function(){var a=this;a.model.fetch({success:function(c,b){a.loadImages=true;require(["text!application/templates/project/ProjectDetail.tpl.html"],function(d){a.doLayout(d,true)});a.projectsPanel.loadSearchProjectPanel()}})},clear:function(){var a=this;a.projectsPanel.refresh()},doLayout:function(c,g){var b=this;var f=b.model.toJSON();var a=f.ontology;var h=20;var i=f.name;if(i.length>h){i=i.substr(0,h)+"..."}f.title=i;if(f.disciplineName==undefined){f.disciplineName="Undefined"}if(f.disciplineName.length>h){f.disciplineName=f.disciplineName.substr(0,h)+"..."}if(f.ontologyName.length>h){f.ontologyName=f.ontologyName.substr(0,h)+"..."}f.ontologyId=a;var d=_.template(c,f);if(g){$("#projectlist"+f.id).replaceWith(d)}else{$(b.el).append(d)}b.renderCurrentProjectButton();b.renderShowImageButton(f.numberOfImages)},infoProject:function(){var a=this;new ProjectInfoDialog({el:a.el,model:a.model}).render()},editProject:function(){var a=this;$("#editproject").remove();console.log("editProject");a.editProjectDialog=new EditProjectDialog({projectPanel:a,el:a.el,model:a.model}).render()},deleteProject:function(){var a=this;a.acceptDeleteProject()},acceptDeleteProject:function(){var a=this;require(["text!application/templates/project/ProjectDeleteConfirmDialog.tpl.html"],function(b){var c=new ConfirmDialogView({el:"#dialogsDeleteProject",template:_.template(b,{project:a.model.get("name")}),dialogAttr:{dialogID:"#delete-project-confirm"}}).render();$("#closeProjectDeleteCancelDialog").click(function(d){d.preventDefault();$("#delete-project-confirm").modal("hide");$("#delete-project-confirm").remove();return false});$("#delete-project-confirm").find("a.close").click(function(d){d.preventDefault();$("#delete-project-confirm").modal("hide");$("#delete-project-confirm").remove();return false});$("#closeProjectDeleteConfirmDialog").click(function(d){d.preventDefault();new TaskModel({project:a.model.id}).save({},{success:function(f,h){var g=f.get("task");console.log("task"+g.id);var i=window.app.view.printTaskEvolution(g,$("#deleteProjectDialogContent"),1000);new ProjectModel({id:a.model.id,task:g.id}).destroy({success:function(l,k){window.app.view.message("Project",k.message,"success");a.clear();clearInterval(i);$("#delete-project-confirm").modal("hide");$("#delete-project-confirm").remove()},error:function(l,k){window.app.view.message("Project","Errors!","error");clearInterval(i);var m=$.parseJSON(k.responseText);window.app.view.message("Project",m.errors[0],"error")}});return false},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Task",h.errors,"error")}})})})},showAddSlidesPanel:function(){window.location="#project-manage-"+this.model.id},showSlidesPanel:function(){var a=this;a.openImagesList(a.model.get("id"));a.imageOpened=!a.imageOpened;$(a.imageOpenElem+a.model.id).button({icons:{secondary:a.imageOpened?"ui-icon-carat-1-n":"ui-icon-carat-1-s"}})},changeProject:function(){var a=this;var b=a.model.get("id");if(b==window.app.status.currentProject){return true}window.app.controllers.browse.closeAll();window.app.status.currentProject=b;return true},renderShowImageButton:function(c){var a=this;var b=true;if(c>0){b=false}$(a.imageOpenElem+a.model.id).button({icons:{secondary:"ui-icon-carat-1-s"},disabled:b})},renderCurrentProjectButton:function(){var a=this;var b=window.app.status.currentProject==a.model.id;if(b){$(a.projectChangeElem+a.model.id).click()}},openImagesList:function(a){}});var ProjectManageSlideDialog=Backbone.View.extend({imageListing:null,imageThumb:null,projectPanel:null,addSlideDialog:null,imagesProject:null,divDialog:"div#projectaddimagedialog",render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageDialog.tpl.html"],function(b){a.doLayout(b)});return this},initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;this.imagesProject=new ImageInstanceCollection({project:this.model.get("id")})},refresh:function(){if(this.imageListing!=undefined){this.imageListing.refresh()}},doLayout:function(b){var a=this;$("#addimagediv").empty();var c=_.template(b,{id:a.model.get("id"),name:a.model.get("name")});$(a.el).append(c);$("button[class=goBack]").click(function(){window.location="#project"});a.imageListing=new ProjectAddImageListingDialog({model:a.model,projectsPanel:a,imagesProject:a.imagesProject,el:"#tabsProjectaddimagedialog"+a.model.id+"-2"}).render();$("a[class=goBack]").button({icons:{primary:"ui-icon-circle-triangle-w"}});$("a.goBack").click(function(d){d.preventDefault();console.log("go back!");parent.history.back();return false});$("input[class=showImageTable]").click(function(){a.imageListing.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-2").show();$("#tabsProjectaddimagedialog"+a.model.id+"-1").hide()});$("input[class=showImageTable]").click();$("input[class=showImageTable]").button({icons:{primary:"ui-icon-document"}});$("input[class=showImageThumbs]").click(function(){a.imageThumb.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-1").show();$("#tabsProjectaddimagedialog"+a.model.id+"-2").hide()});$("input[class=showImageThumbs]").button({icons:{primary:"ui-icon-image"}});a.imageListing.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-2").show();$("#tabsProjectaddimagedialog"+a.model.id+"-1").hide();$("#addimagediv").append($(a.divDialog+a.model.get("id")));$(".ui-panel-header").css("display","block");a.open();return this},open:function(){}});var AddProjectDialog=Backbone.View.extend({projectsPanel:null,addProjectDialog:null,userMultiSelect:null,projectMultiSelectAlreadyLoad:false,initialize:function(a){this.container=a.container;this.projectsPanel=a.projectsPanel;this.ontologies=a.ontologies;this.disciplines=a.disciplines;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectAddDialog.tpl.html","text!application/templates/project/OntologiesChoicesRadio.tpl.html","text!application/templates/project/DisciplinesChoicesRadio.tpl.html","text!application/templates/project/UsersChoices.tpl.html"],function(b,f,d,c){a.doLayout(b,f,d,c)});return this},doLayout:function(a,g,f,d){var b=this;var c=_.template(a,{});$("#editproject").replaceWith("");$("#addproject").replaceWith("");$(b.el).append(c);b.initStepy();b.createProjectInfo(g,f);b.createUserList();b.createRetrievalProject();b.addProjectDialog=$("#addproject").modal({keyboard:true,backdrop:false});$("#saveProjectButton").click(function(h){h.preventDefault();$("#login-form-add-project").submit();return false});$("#closeAddProjectDialog").click(function(h){h.preventDefault();$("#addproject").modal("hide");$("#addproject").remove();return false});b.open();return this},initStepy:function(){$("#login-form-add-project").stepy({next:function(b){var a=false;if(b==2){if($("#project-name").val().toUpperCase().trim()==""){window.app.view.message("User","You must provide a valide project name!","error");a=true}console.log($("#projectontology").val());if($("#projectontology").val()==undefined){window.app.view.message("Ontology","You must provide a ontology name!","error");a=true}if($("#projectdiscipline").val()==undefined){window.app.view.message("Discipline","You must provide a discipline name!","error");a=true}return !a}if(b==$("#login-form-add-project").find("fieldset").length){$("#saveProjectButton").show()}},back:function(a){if(a!=$("#login-form-add-project").find("fieldset").length){$("#saveProjectButton").hide()}}});$("fieldset").find("a.button-next").css("float","right");$("fieldset").find("a.button-back").css("float","left");$("fieldset").find("a").removeClass("button-next");$("fieldset").find("a").removeClass("button-back");$("fieldset").find("a").addClass("btn btn-primary")},createProjectInfo:function(d,c){var b=this;$("#login-form-add-project").submit(function(){b.createProject();return false});$("#login-form-add-project").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-add-project").submit();return false}});$("#projectdiscipline").empty();$("#choiceListDiscipline").empty();$("#choiceListDiscipline").append('<select class="input-xlarge focused" id="projectdiscipline" />');var a=_.template(c,{id:-1,name:"*** Undefined ***"});$("#projectdiscipline").append(a);window.app.models.disciplines.fetch({success:function(g,f){g.each(function(i){var h=_.template(d,{id:i.id,name:i.get("name")});$("#projectdiscipline").append(h)});$("#projectdiscipline").find("option:selected").removeAttr("selected")}});$("#projectontology").empty();window.app.models.ontologiesLigth.fetch({success:function(g,f){$("#choiceListOntology").empty();$("#choiceListOntology").append('<select class="input-xlarge focused" id="projectontology" />');g.each(function(i){var h=_.template(d,{id:i.id,name:i.get("name")});$("#projectontology").append(h)});$("#projectontology").find("option:selected").removeAttr("selected")}});$("#createOntologyWithProjectName").click(function(f){var g=$("#project-name").val().toUpperCase().trim();if(g!=""){var h=new OntologyModel({name:g}).save({name:g},{success:function(l,k){window.app.view.message("Ontology",k.message,"success");var m=k.ontology.id;window.app.models.ontologies.add(l);var i=_.template(d,{id:m,name:l.get("name")});$("#projectontology").prepend(i);$("#projectontology").val(m)},error:function(k,i){var l=$.parseJSON(i.responseText);window.app.view.message("Ontology",l.errors,"error")}})}else{window.app.view.message("Project","You must first write a valid project name!","error")}})},createUserList:function(){var b=this;var a=null;var c=function(){var d=[];a.each(function(f){d.push({id:f.id,label:f.prettyName()})});b.userMaggicSuggest=$("#projectuser").magicSuggest({data:d,displayField:"label",value:[window.app.status.user.id],width:590,maxSelection:null})};new UserCollection({}).fetch({success:function(f,d){a=f;c()}})},createRetrievalProject:function(){var a=this;$("input#retrievalProjectSome,input#retrievalProjectAll,input#retrievalProjectNone").change(function(){if($("input#retrievalProjectSome").is(":checked")){if(!a.projectMultiSelectAlreadyLoad){a.createRetrievalProjectSelect();a.projectMultiSelectAlreadyLoad=true}else{console.log("Show");$("div#retrievalGroup").find(".ui-multiselect").show()}}else{console.log("Hide");$("div#retrievalGroup").find(".ui-multiselect").hide()}});$("input#project-name").change(function(){console.log("change");if(a.projectMultiSelectAlreadyLoad){a.createRetrievalProjectSelect()}});$("#projectontology").change(function(){console.log("change");if(a.projectMultiSelectAlreadyLoad){a.createRetrievalProjectSelect()}})},createRetrievalProjectSelect:function(){$("#retrievalproject").empty();var b=$("input#project-name").val();var a=$("select#projectontology").val();window.app.models.projects.each(function(c){if(c.get("ontology")==a){$("#retrievalproject").append('<option value="'+c.id+'">'+c.get("name")+"</option>")}});$("#retrievalproject").append('<option value="-1" selected="selected">'+b+"</option>");$("#retrievalproject").multiselectNext("destroy");$("#retrievalproject").multiselectNext({selected:function(c,d){}});$("div.ui-multiselect").find("ul.available").css("height","150px");$("div.ui-multiselect").find("ul.selected").css("height","150px");$("div.ui-multiselect").find("input.search").css("width","75px");$("div.ui-multiselect").find("div.actions").css("background-color","#DDDDDD")},refresh:function(){},open:function(){var a=this;a.clearAddProjectPanel();$("#addproject").modal("show")},clearAddProjectPanel:function(){var a=this;$("#errormessage").empty();$("#projecterrorlabel").hide();$("#project-name").val("");$(a.addProjectCheckedOntologiesRadioElem).attr("checked",false);$(a.addProjectCheckedDisciplinesRadioElem).attr("checked",false);$(a.addProjectCheckedUsersCheckboxElem).attr("checked",false)},initProgressBar:function(){console.log("initProgressBar");var a=$("#login-form-add-project");a.empty();$("#login-form-add-project-titles").empty();a.append('<br><br><div id="progressBarCreateProject" class="progress progress-striped active">   <div class="bar" style="width:0%;"></div></div><br><br>');$("#addproject").find(".modal-footer").empty()},changeProgressBarStatus:function(a){console.log("changeProgressBarStatus:"+a);var b=$("#progressBarCreateProject").find(".bar");b.css("width",a+"%")},createProject:function(){var m=this;$("#errormessage").empty();$("#projecterrorlabel").hide();var b=$("#project-name").val().toUpperCase();var f=$("#projectdiscipline").val();if(f==-1){f=null}var k=$("#projectontology").val();var d=m.userMaggicSuggest.getValue();var n=$("input#blindMode").is(":checked");var h=$("input#privateLayer").is(":checked");console.log("blindMode="+n);console.log("privateLayer="+h);var l=$("input#retrievalProjectNone").is(":checked");var g=$("input#retrievalProjectAll").is(":checked");var a=$("input#retrievalProjectSome").is(":checked");var i=[];if(a){i=$("#retrievalproject").multiselectNext("selectedValues")}m.initProgressBar();var c=d.length+1;m.changeProgressBarStatus((1/c)*100);new ProjectModel({name:b,ontology:k,discipline:f,retrievalDisable:l,retrievalAllOntology:g,retrievalProjects:i}).save({name:b,ontology:k,discipline:f,retrievalDisable:l,retrievalAllOntology:g,retrievalProjects:i,blindMode:n,privateLayer:h},{success:function(q,p){console.log("1. Project added!");window.app.view.message("Project",p.message,"success");var s=p.project.id;var r=d.length;var o=0;if(r==0){m.addDeleteUserProjectCallback(0,0)}_.each(d,function(t){console.log("Add user "+t);new ProjectUserModel({project:s,user:t}).save({},{success:function(v,u){console.log("2. User added");m.addUserProjectCallback(r,++o);m.changeProgressBarStatus(((o+1)/c)*100)},error:function(v,u){m.addUserProjectCallback(r,++o);m.changeProgressBarStatus(((o+1)/c)*100);var w=$.parseJSON(u.responseText);window.app.view.message("User",w.errors,"error")}})})},error:function(p,o){var q=$.parseJSON(o.responseText);window.app.view.message("Project",q.errors,"error");$("#login-form-add-project").stepy("step",1)}})},addUserProjectCallback:function(c,a){console.log("3. addUserProjectCallback="+a+"/"+c);if(a<c){return}var b=this;console.log("4. refresh");b.projectsPanel.refresh();$("#addproject").modal("hide");$("#addproject").remove()}});var EditProjectDialog=Backbone.View.extend({projectsPanel:null,editProjectDialog:null,projectMultiSelectAlreadyLoad:false,userMaggicSuggest:null,initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectEditDialog.tpl.html","text!application/templates/project/UsersChoices.tpl.html"],function(b,c){a.doLayout(b,c)});return this},doLayout:function(c,d){var a=this;$("#editproject").replaceWith("");$("#addproject").replaceWith("");var b=_.template(c,{});$(a.el).append(b);$("#editProjectButton").click(function(f){f.preventDefault();$("#login-form-edit-project").submit();return false});$("#closeEditProjectDialog").click(function(f){f.preventDefault();$("#editproject").modal("hide");$("#editproject").remove();return false});a.initStepy();a.createProjectInfo();a.createUserList();$("#project-edit-name").val(a.model.get("name"));a.createRetrievalProject();a.editProjectDialog=$("#editproject").modal({keyboard:true,backdrop:false});a.open();a.fillForm();return this},initStepy:function(){$("#login-form-edit-project").stepy({next:function(a){if(a==2){if($("#project-edit-name").val().toUpperCase().trim()==""){window.app.view.message("User","You must provide a valide project name!","error");return false}}if(a==$("#login-form-edit-project").find("fieldset").length){$("#editProjectButton").show()}},back:function(a){if(a!=$("#login-form-edit-project").find("fieldset").length){$("#editProjectButton").hide()}}});$("#login-form-edit-project").find("fieldset").find("a.button-next").css("float","right");$("#login-form-edit-project").find("fieldset").find("a.button-back").css("float","left");$("#login-form-edit-project").find("fieldset").find("a").removeClass("button-next");$("#login-form-edit-project").find("fieldset").find("a").removeClass("button-back");$("#login-form-edit-project").find("fieldset").find("a").addClass("btn btn-primary")},createProjectInfo:function(){var a=this;$("#login-form-edit-project").submit(function(){a.editProject();return false});$("#login-form-edit-project").find("input").keydown(function(b){if(b.keyCode==13){$("#login-form-edit-project").submit();return false}});$("input#blindMode").attr("checked",a.model.get("blindMode"));$("input#privateLayer").attr("checked",a.model.get("privateLayer"))},createUserList:function(){var c=this;var b=null;var a=null;var d=function(){if(b==null||a==null){return}var f=[];b.each(function(h){f.push({id:h.id,label:h.prettyName()})});var g=[];a.each(function(h){g.push(h.id)});c.userMaggicSuggest=$("#projectedituser").magicSuggest({data:f,displayField:"label",value:g,width:590,maxSelection:null})};new UserCollection({}).fetch({success:function(g,f){b=g;d()}});new UserCollection({project:c.model.id}).fetch({success:function(g,f){a=g;window.app.models.projectUser=g;d()}})},createRetrievalProject:function(){var a=this;$("#login-form-edit-project").find("input#retrievalProjectSome,input#retrievalProjectAll,input#retrievalProjectNone").change(function(){console.log("change1");if($("#login-form-edit-project").find("input#retrievalProjectSome").is(":checked")){console.log("createRetrievalProject="+a.projectMultiSelectAlreadyLoad);if(!a.projectMultiSelectAlreadyLoad){a.createRetrievalProjectSelect();a.projectMultiSelectAlreadyLoad=true}else{console.log("Show");$("#login-form-edit-project").find("div#retrievalGroup").find(".ui-multiselect").show()}}else{console.log("Hide");$("#login-form-edit-project").find("div#retrievalGroup").find(".ui-multiselect").hide()}});$("#login-form-edit-project").find("input#project-name").change(function(){console.log("change");if(a.projectMultiSelectAlreadyLoad){a.createRetrievalProjectSelect()}});if(a.model.get("retrievalDisable")){$("#login-form-edit-project").find("input#retrievalProjectNone").attr("checked","checked");$("#login-form-edit-project").find("input#retrievalProjectNone").change()}else{if(a.model.get("retrievalAllOntology")){$("#login-form-edit-project").find("input#retrievalProjectAll").attr("checked","checked");$("#login-form-edit-project").find("input#retrievalProjectAll").change()}else{$("#login-form-edit-project").find("input#retrievalProjectSome").attr("checked","checked");$("#login-form-edit-project").find("input#retrievalProjectSome").change()}}},createRetrievalProjectSelect:function(){var a=this;$("#login-form-edit-project").find("#retrievalproject").empty();window.app.models.projects.each(function(b){if(b.get("ontology")==a.model.get("ontology")&&b.id!=a.model.id){if(_.indexOf(a.model.get("retrievalProjects"),b.id)==-1){$("#login-form-edit-project").find("#retrievalproject").append('<option value="'+b.id+'">'+b.get("name")+"</option>")}else{$("#login-form-edit-project").find("#retrievalproject").append('<option value="'+b.id+'" selected="selected">'+b.get("name")+"</option>")}}});$("#login-form-edit-project").find("#retrievalproject").append('<option value="'+a.model.id+'" selected="selected">'+$("#login-form-edit-project").find("#project-edit-name").val()+"</option>");$("#login-form-edit-project").find("#retrievalproject").multiselectNext("destroy");$("#login-form-edit-project").find("#retrievalproject").multiselectNext({selected:function(b,c){}});$("div.ui-multiselect").find("ul.available").css("height","150px");$("div.ui-multiselect").find("ul.selected").css("height","150px");$("div.ui-multiselect").find("input.search").css("width","75px");$("div.ui-multiselect").find("div.actions").css("background-color","#DDDDDD")},fillForm:function(){var a=this},refresh:function(){},open:function(){var a=this;a.clearEditProjectPanel();$("#editproject").modal("show")},clearEditProjectPanel:function(){var a=this;$("#projectediterrormessage").empty();$("#projectediterrorlabel").hide()},diffArray:function(d,c){var f=[],h=[];for(var g=0;g<c.length;g++){f[c[g]]=true}for(var g=0;g<d.length;g++){if(!f[d[g]]){h.push(d[g])}}return h},editProject:function(){var q=this;$("#projectediterrormessage").empty();$("#projectediterrorlabel").hide();var c=$("#project-edit-name").val().toUpperCase();var g=q.userMaggicSuggest.getValue();var n=$("#login-form-edit-project").find("input#retrievalProjectNone").is(":checked");var i=$("#login-form-edit-project").find("input#retrievalProjectAll").is(":checked");var b=$("#login-form-edit-project").find("input#retrievalProjectSome").is(":checked");var l=[];if(b){l=$("#login-form-edit-project").find("#retrievalproject").multiselectNext("selectedValues")}var r=$("input#blindMode").is(":checked");var h=$("input#privateLayer").is(":checked");console.log("blindMode="+r);console.log("privateLayer="+h);var m=[];var p=null;var f=null;var a=null;var k=[];window.app.models.projectUser.each(function(s){k.push(s.id)});_.each(k,function(s){m.push(s)});m.sort();p=g;p.sort();f=q.diffArray(p,m);a=q.diffArray(m,p);console.log("projectOldUsers="+m);console.log("projectNewUsers="+p);console.log("projectAddUser="+f);console.log("projectDeleteUser="+a);q.initProgressBar();var d=f.length+a.length+1;q.changeProgressBarStatus((1/d)*100);var o=q.model;o.set({name:c,retrievalDisable:n,retrievalAllOntology:i,retrievalProjects:l,blindMode:r,privateLayer:h});o.save({name:c,retrievalDisable:n,retrievalAllOntology:i,retrievalProjects:l,blindMode:r,privateLayer:h},{success:function(u,t){window.app.view.message("Project",t.message,"success");var w=t.project.id;var v=f.length+a.length;var s=0;if(v==0){q.addDeleteUserProjectCallback(0,0)}_.each(f,function(x){new ProjectUserModel({project:w,user:x}).save({},{success:function(z,y){q.addDeleteUserProjectCallback(v,++s);q.changeProgressBarStatus(((s+1)/d)*100)},error:function(z,y){q.changeProgressBarStatus(((s+1)/d)*100);var A=$.parseJSON(y.responseText);window.app.view.message("User",A.errors[0],"error")}})});_.each(a,function(x){new ProjectUserModel({id:1,project:w,user:x}).destroy({success:function(z,y){q.addDeleteUserProjectCallback(v,++s);q.changeProgressBarStatus(((s+1)/d)*100)},error:function(z,y){q.changeProgressBarStatus(((s+1)/d)*100);var A=$.parseJSON(y.responseText);window.app.view.message("User",A.errors[0],"error")}})})},error:function(t,s){console.log(s);var u=$.parseJSON(s.responseText);window.app.view.message("Project",u.errors[0],"error")}})},initProgressBar:function(){console.log("initProgressBar");var a=$("#login-form-edit-project");a.empty();$("#login-form-edit-project-titles").empty();a.append('<br><br><div id="progressBarEditProject" class="progress progress-striped active">   <div class="bar" style="width:0%;"></div></div><br><br>');$("#editproject").find(".modal-footer").empty()},changeProgressBarStatus:function(a){console.log("changeProgressBarStatus:"+a);var b=$("#progressBarEditProject").find(".bar");b.css("width",a+"%")},addDeleteUserProjectCallback:function(c,a){if(a<c){return}var b=this;b.projectPanel.refresh();$("#editproject").modal("hide");$("#editproject").remove()}});var ProjectSearchPanel=Backbone.View.extend({idUser:null,container:null,ontologies:null,disciplines:null,projectsPanel:null,allProjectsButtonElem:"#projectallbutton",searchProjectOntolgiesListElem:"#ontologyChoiceList",searchProjectDisciplinesListElem:"#disciplineChoiceList",sliderNumberOfImagesElem:"#numberofimageSlider",labelNumberOfImagesElem:"#amountNumberOfImages",sliderNumberOfSlidesElem:"#numberofslideSlider",labelNumberOfSlidesElem:"#amountNumberOfSlides",sliderNumberOfAnnotationsElem:"#numberofannotationSlider",labelNumberOfAnnotationsElem:"#amountNumberOfAnnotations",searchProjectTextBoxElem:"#projectsearchtextbox",searchProjectButtonElem:"#projectsearchbutton",searchProjectCheckedOntologiesElem:"input[type=checkbox][name=ontology]:checked",addProjectCheckedOntologiesRadioElem:"input[type=radio][name=ontologyradio]:checked",addProjectCheckedDisciplinesRadioElem:"input[type=radio][name=disciplineradio]:checked",addProjectCheckedUsersCheckboxElem:"input[type=checkbox][name=usercheckbox]:checked",initialize:function(a){this.idUser=a.idUser;this.container=a.container;this.projectsPanel=a.projectsPanel;this.ontologies=a.ontologies;this.disciplines=a.disciplines},events:{"change .searchProjectCriteria":"searchProject","click .showAllProject":"showAllProject","click .refreshAllProject":"refreshAllProject"},render:function(){var a=this;require(["text!application/templates/project/ProjectSearchPanel.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=_.template(b,{});$(this.el).empty();$(this.el).append(c);require(["text!application/templates/project/OntologiesChoices.tpl.html","text!application/templates/project/DisciplinesChoices.tpl.html"],function(d,f){a.loadPanelAndButton(d,f)});a.loadSlider();a.loadAutocomplete()},loadPanelAndButton:function(a,b){var c=this;c.ontologies.each(function(f){var d=_.template(a,{id:f.id,name:f.get("name")});$(c.searchProjectOntolgiesListElem).append(d)});c.disciplines.each(function(f){var d=_.template(b,{id:f.id,name:f.get("name")});$(c.searchProjectDisciplinesListElem).append(d)})},loadSlider:function(){var a=this;var b=Number.MAX_VALUE;var d=0;var f=Number.MAX_VALUE;var h=0;var c=Number.MAX_VALUE;var g=0;a.model.each(function(k){var i=parseInt(k.get("numberOfImages"));var m=parseInt(k.get("numberOfSlides"));var l=parseInt(k.get("numberOfAnnotations"));if(i<b){b=i}if(i>d){d=i}if(m<f){f=m}if(m>h){h=m}if(l<c){c=l}if(l>g){g=l}});b=a.changeMaxValueToZero(b);d=a.changeMaxValueToZero(d);f=a.changeMaxValueToZero(f);h=a.changeMaxValueToZero(h);c=a.changeMaxValueToZero(c);g=a.changeMaxValueToZero(g);a.createSliderWithoutAmountPrint(a.sliderNumberOfImagesElem,a.labelNumberOfImagesElem,b,d);a.createSliderWithoutAmountPrint(a.sliderNumberOfSlidesElem,a.labelNumberOfSlidesElem,f,h);a.createSliderWithoutAmountPrint(a.sliderNumberOfAnnotationsElem,a.labelNumberOfAnnotationsElem,c,g)},changeMaxValueToZero:function(a){if(a==Number.MAX_VALUE){return 0}else{return a}},loadAutocomplete:function(){var a=this;var b=[];a.model.each(function(c){b.push(c.get("name"))});$(a.searchProjectTextBoxElem).typeahead({source:b,minLength:0});$(a.searchProjectTextBoxElem).bind("propertychange keyup input paste",function(){a.searchProject()})},createSliderWithoutAmountPrint:function(f,c,d,a){var b=this;$(f).slider({range:true,min:d,max:a,values:[d,a],change:function(g,h){$(c).val(""+h.values[0]+" - "+h.values[1]);b.searchProject()}});$(c).val(""+$(f).slider("values",0)+" - "+$(f).slider("values",1))},refreshSearchPanel:function(b){var a=this;a.loadSlider();a.loadAutocomplete()},showAllProject:function(){var a=this;$(a.searchProjectTextBoxElem).val("");$("#ontologyChoiceList").val(-1);$("#disciplineChoiceList").val(-1);a.resetSlider(a.sliderNumberOfImagesElem);a.resetSlider(a.sliderNumberOfSlidesElem);a.resetSlider(a.sliderNumberOfAnnotationsElem);a.searchProject()},refreshAllProject:function(){this.container.refresh()},resetSlider:function(c){var b=$(c).slider("option","min");var a=$(c).slider("option","max");$(c).slider("values",[b,a])},searchProject:function(){var k=this;var i=$(k.searchProjectTextBoxElem).val();var d=[];var h=$("#ontologyChoiceList").val();if(h!=-1){d.push(h)}var c=[];var f=$("#disciplineChoiceList").val();if(f!=-1){c.push(f)}var g=[];g.push($(k.sliderNumberOfImagesElem).slider("values",0));g.push($(k.sliderNumberOfImagesElem).slider("values",1));var b=[];b.push($(k.sliderNumberOfSlidesElem).slider("values",0));b.push($(k.sliderNumberOfSlidesElem).slider("values",1));var a=[];a.push($(k.sliderNumberOfAnnotationsElem).slider("values",0));a.push($(k.sliderNumberOfAnnotationsElem).slider("values",1));k.filterProjects(i==""?undefined:i,d.length==0?undefined:d,c.length==0?undefined:c,g,b,a)},filterProjects:function(h,g,a,f,c,i){var b=this;var d=new ProjectCollection(b.model.models);d=b.filterByProjectsByName(h,d);d=b.filterProjectsByOntology(g,d);d=b.filterProjectsByDiscipline(a,d);d=b.filterProjectsByNumberOfImages(f,d);d=b.filterProjectsByNumberOfSlides(c,d);d=b.filterProjectsByNumberOfAnnotations(i,d);b.container.showProjects(d)},filterByProjectsByName:function(c,b){if(c==undefined){return b}var a=new ProjectCollection(b.models);b.each(function(h){var d=h.get("name").toLowerCase();var g=c.toLowerCase();var f=(d.indexOf(g)!=-1);if(!f){a.remove(h)}});return a},filterProjectsByOntology:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(g){var f=g.get("ontology")+"";if(d!=undefined&&_.indexOf(d,f)==-1){b.remove(g)}});return b},filterProjectsByDiscipline:function(a,d){var b=this;var c=new ProjectCollection(d.models);d.each(function(g){var f=g.get("discipline")+"";if(a!=undefined&&_.indexOf(a,f)==-1){c.remove(g)}});return c},filterProjectsByNumberOfImages:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(g){var f=g.get("numberOfImages");if(d[0]>f||d[1]<f){b.remove(g)}});return b},filterProjectsByNumberOfSlides:function(c,d){var a=this;var b=new ProjectCollection(d.models);d.each(function(g){var f=g.get("numberOfSlides");if(c[0]>f||c[1]<f){b.remove(g)}});return b},filterProjectsByNumberOfAnnotations:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(g){var f=g.get("numberOfAnnotations");if(d[0]>f||d[1]<f){b.remove(g)}});return b}});var ProjectDescriptionDialog=Backbone.View.extend({descriptionProjectDialog:null,initialize:function(a){_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectDescription.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;var b=_.template(c,{id:a.model.id,name:a.model.get("name")});$("#projectDescription"+a.model.id).replaceWith("");$(a.el).append(b);a.printDescriptionProject();console.log("Open element:"+$("#projectDescription"+a.model.id).length);a.descriptionProjectDialog=$("#projectDescription"+a.model.id).modal({keyboard:true,backdrop:false});$("#closeDescriptionProjectDialog").click(function(d){d.preventDefault();$("#projectDescription"+a.model.id).modal("hide");$("#projectDescription"+a.model.id).remove();return false});$("#saveDescriptionProjectDialog").click(function(d){d.preventDefault();a.saveDescriptionProject();$("#projectDescription"+a.model.id).modal("hide");$("#projectDescription"+a.model.id).remove();return false});a.open();return this},printDescriptionProject:function(){var a=this;var b=window.app.status.currentProjectModel;console.log(b);console.log("Description Project: "+b.description);$("#textAreaDescriptionProject"+a.model.id).val(b.get("description"))},saveDescriptionProject:function(){var a=this;var b=window.app.status.currentProjectModel;b.save({description:$("#textAreaDescriptionProject"+a.model.id).val()},{success:function(d,c){window.app.view.message("Projet Description",c.message,"success");return false},error:function(d,c){var f=$.parseJSON(c.responseText);window.app.view.message("Project Description",f.errors,"error")}})},open:function(){var a=this;$("#projectDescription"+a.model.id).modal("show")}});var ProjectAddImageListingDialog=Backbone.View.extend({imagesProject:null,searchPanel:null,initialize:function(b){var a=this;this.container=b.container;this.projectPanel=b.projectPanel;this.imagesProject=b.imagesProject;this.abstractImageProject=[];this.el="#tabsProjectaddimagedialog"+a.model.id+"-2";this.listmanageproject="listmanageproject"+this.model.id;this.pagemanageproject="pagemanageproject"+this.model.id;this.listmanageall="listmanageall"+this.model.id;this.pagemanageall="pagemanageall"+this.model.id;this.addImageButton="addimageprojectbutton"+this.model.id;this.delImageButton="delimageprojectbutton"+this.model.id;this.tab=2;this.timeoutHnd=null},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageListingDialog.tpl.html"],function(b){a.doLayout(b)});return this},refresh:function(){this.refreshImageList()},doLayout:function(c){var b=this;var f=b.model.toJSON();f.tab=2;var d=_.template(c,f);$(b.el).append(d);this.renderImageList();var g=$(window).width()-80;var a=g*0.05;$("#imageTableSeparator").css({width:a+"px"});return this},renderImageList:function(){var a=this;a.renderImageListing()},renderImageListing:function(){var a=this;$("#"+a.addImageButton).button({icons:{primary:"ui-icon-circle-arrow-w"},text:false});$("#"+a.delImageButton).button({icons:{primary:"ui-icon-circle-arrow-e"},text:false});$("#infoProjectPanel"+a.model.id).panel({collapseSpeed:100});$("#"+a.addImageButton).click(function(){a.addImageProjectFromTable()});$("#"+a.delImageButton).click(function(){a.deleteImageProjectFromTable()});$("#searchImagetPanelup"+a.model.id+"-"+a.tab).panel({collapseSpeed:100});$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val("");$("#imagesallbutton"+a.model.id+"-"+a.tab).button({text:true});$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).keyup(function(){a.doSearch()}).keyup();$("#imagesallbutton"+a.model.id+"-"+a.tab).click(function(){$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val("");$("#datestartsearchup"+a.model.id+"-"+a.tab).val("");$("#dateendsearchup"+a.model.id+"-"+a.tab).val("");a.doSearch()});$("#datestartsearchup"+a.model.id+"-"+a.tab).datepicker({onSelect:function(c,b){a.doSearch()}});$("#dateendsearchup"+a.model.id+"-"+a.tab).datepicker({onSelect:function(c,b){a.doSearch()}});a.renderImageListProject();a.renderImageListAll()},doSearch:function(){var a=this;if($.data(this,"timer")!=null){clearTimeout($.data(this,"timer"))}var b=setTimeout(function(){a.searchImages()},500);$(this).data("timer",b)},searchImages:function(){var a=this;var g=$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val();var f=$("#datestartsearchup"+a.model.id+"-"+a.tab).datepicker("getDate");var c=$("#dateendsearchup"+a.model.id+"-"+a.tab).datepicker("getDate");var b="";if(f!=null){b=f.getTime()}var d="";if(c!=null){d=c.getTime()}$("#"+a.listmanageall).jqGrid("setGridParam",{url:"api/image.json?filename="+g+"&createdstart="+b+"&createdstop="+d,page:1}).trigger("reloadGrid")},refreshImageList:function(){var a=this;$("#"+a.listmanageproject).jqGrid("clearGridData",true);a.imagesProject.fetch({success:function(c,b){a.fillAbstractImageProjectCollection(c);a.loadDataImageListProject(c);$("#"+a.listmanageall).trigger("reloadGrid")}})},fillAbstractImageProjectCollection:function(a){var b=this;b.abstractImageProject=[];b.imagesProject.each(function(c){b.abstractImageProject.push(c.get("baseImage"))})},loadDataImageListProject:function(f){var a=this;var d=[];var c=0;f.each(function(h){var g=new Date();g.setTime(h.get("created"));d[c]={id:h.id,base:h.get("baseImage"),thumb:"<img src='"+h.get("thumb")+"' width=50/>",filename:h.get("filename"),type:h.get("mime"),annotations:h.get("numberOfAnnotations"),added:window.app.convertLongToDateShort(h.get("created")),See:""};c++});for(var b=0;b<d.length;b++){$("#"+a.listmanageproject).jqGrid("addRowData",d[b].id,d[b])}$("#"+a.listmanageproject).jqGrid("sortGrid","filename",false)},renderImageListProject:function(){var b=this;var c=$(window).width()-80;var a=c*0.45;$("#imagesProjectContainer").css({width:a+"px"});$("#"+b.listmanageproject).jqGrid({datatype:"local",width:a,height:500,colNames:["id","base","thumb","filename","type","annotations","added"],colModel:[{name:"id",index:"id",width:1,sorttype:"int"},{name:"base",index:"base",width:1,sorttype:"int"},{name:"thumb",index:"thumb",width:100},{name:"filename",index:"filename",width:250},{name:"type",index:"type",width:50},{name:"annotations",index:"annotations",width:50},{name:"added",index:"added",width:100,sorttype:"date"}],onSelectRow:function(f){var d=$("#"+b.listmanageproject).find("#"+f).find(".cbox").is(":checked");if(d){$("#"+b.listmanageproject).find("#"+f).find("td").css("background-color","CD661D")}else{$("#"+b.listmanageproject).find("#"+f).find("td").css("background-color","a0dc4f")}},loadComplete:function(){b.imagesProject.each(function(d){$("#"+b.listmanageproject).find("#"+d.id).find("td").css("background-color","a0dc4f")})},pager:"#"+b.pagemanageproject,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Images in "+b.model.get("name"),multiselect:true});$("#"+b.listmanageproject).jqGrid("navGrid","#"+b.listmanageproject,{edit:false,add:false,del:false});$("#"+b.listmanageproject).jqGrid("hideCol","id");$("#"+b.listmanageproject).jqGrid("hideCol","base")},isAbstractImageInProject:function(a){if(_.indexOf(this.abstractImageProject,a)!=-1){return true}else{return false}},renderImageListAll:function(){var b=this;var c=$(window).width()-80;var a=c*0.45;$("#allImagesContainer").css({width:a+"px"});var d="thumb";$("#"+b.listmanageall).jqGrid({datatype:"json",url:"api/image.json",width:a,height:500,colNames:["id",d,"filename","mime","created"],colModel:[{name:"id",index:"id",width:1},{name:d,index:d,width:100},{name:"filename",index:"filename",width:250},{name:"mime",index:"mime",width:45},{name:"created",index:"created",width:100,sorttype:"date",formatter:b.dateFormatter}],onSelectRow:function(f){if(b.isAbstractImageInProject(f)){$("#"+b.listmanageall).find("#"+f).find(".cbox").removeAttr("checked")}},loadComplete:function(f){$("#"+b.listmanageall).find("tr").each(function(g){if(g!=0){var h=$(this).find('[aria-describedby$="_'+d+'"]');$(h).html('<img src="'+$(h).text()+'" width=50/>')}});b.imagesProject.each(function(g){$("#"+b.listmanageall).find("#"+g.get("baseImage")).find("td").css("background-color","a0dc4f");$("#"+b.listmanageall).find("#"+g.get("baseImage")).find(".cbox").attr("disabled",true);$("#"+b.listmanageall).find("#"+g.get("baseImage")).find(".cbox").css("visible",false)})},pager:"#"+b.pagemanageall,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Available images",multiselect:true,rowNum:10,rowList:[10,20,30],jsonReader:{repeatitems:false,id:"0"}});$("#"+b.listmanageall).jqGrid("navGrid","#"+b.pagemanageall,{edit:false,add:false,del:false},{},{},{},{multipleSearch:true});$("#"+b.listmanageall).jqGrid("sortGrid","filename",false);$("#"+b.listmanageall).jqGrid("hideCol","id")},dateFormatter:function(a,b,c){return window.app.convertLongToDateShort(a)},addImageProjectFromTable:function(){var b=this;var c=$("#"+b.listmanageall).jqGrid("getGridParam","selarrrow");if(c.length==0){return}var a=0;_.each(c,function(d){new ImageInstanceModel({}).save({project:b.model.id,user:null,baseImage:d},{success:function(g,f){window.app.view.message("Image",f.message,"success");b.addImageProjectCallback(c.length,++a)},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Image",h.errors.message,"error");b.addImageProjectCallback(c.length,++a)}})})},addImageProjectCallback:function(c,a){if(a<c){return}var b=this;b.refreshImageList()},deleteImageProjectFromTable:function(){var a=this;var b=$("#"+a.listmanageproject).jqGrid("getGridParam","selarrrow");if(b.length==0){return}a.deleteImageWithcheckForAnnotation(b)},deleteImageProject:function(c){var b=this;var a=0;_.each(c,function(d){new ImageInstanceModel({id:d}).destroy({success:function(g,f){window.app.view.message("Image",f.message,"success");b.deleteImageProjectCallback(c.length,++a)},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Image",h.errors.message,"error");b.deleteImageProjectCallback(c.length,++a)}})})},deleteImageProjectCallback:function(c,a){if(a<c){return}var b=this;b.refreshImageList()},deleteImageWithcheckForAnnotation:function(c){var a=this;var b=false;_.each(c,function(d){var f=a.imagesProject.get(d).get("numberOfAnnotations");if(f>0){b=true}});if(b){require(["text!application/templates/project/ProjectAddImageDeleteImageInstanceWithAnnotation.tpl.html"],function(d){var f=new ConfirmDialogView({el:"#dialogs",template:_.template(d,{projectname:a.model.get("name")}),dialogAttr:{dialogID:"#dialogDeleteImageWithAnnotation"}}).render();$("#confirmDeleteImageWithAnnotation").off("click");$("#confirmDeleteImageWithAnnotation").on("click",function(){a.deleteImageProject(c);f.close();f.destroy()});$("#closeDeleteImageWithAnnotation").off("click");$("#closeDeleteImageWithAnnotation").on("click",function(){f.close();f.destroy()})})}else{a.deleteImageProject(c)}}});var ProjectAddImageThumbDialog=Backbone.View.extend({imageListing:null,imageThumb:null,slides:null,imagesProject:null,imagesinstanceProject:null,checklistChecked:".checklist input:checked",checklistSelected:".checklist .checkbox-select",checklistDeselected:".checklist .checkbox-deselect",selectedClass:"selected",checkedAttr:"checked",liElem:"projectaddimageitemli",ulElem:"#projectaddimagedialoglist",allProjectUlElem:"ul[id^=projectaddimagedialoglist]",imageDivElem:"#projectaddimageitempict",page:0,nb_slide_by_page:20,nextPage:function(){var a=Math.round(_.size(window.app.models.slides)/this.nb_slide_by_page)-1;this.page=Math.min(this.page+1,a);this.renderImageListLayout()},previousPage:function(){this.page=Math.max(this.page-1,0);this.renderImageListLayout()},disablePrevious:function(){},enablePrevious:function(){},disableNext:function(){},enableNext:function(){},initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;this.imagesProject=a.imagesProject;this.imagesinstanceProject=a.imagesinstanceProject;this.el="#tabsProjectaddimagedialog"+this.model.id+"-1";this.slides=a.slides;_.bindAll(this,"render");_.bindAll(this,"nextPage");_.bindAll(this,"previousPage")},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageThumbDialog.tpl.html"],function(b){a.doLayout(b)});return this},refresh:function(){this.renderImageList()},doLayout:function(c){var b=this;var a=_.template(c,{id:this.model.get("id"),name:this.model.get("name")});$(b.el).append(a);$(b.el).find("a.next").bind("click",b.nextPage);$(b.el).find("a.next").button();$(b.el).find("a.previous").bind("click",b.previousPage);$(b.el).find("a.previous").button();return this},renderImageList:function(){var a=this;window.app.models.slides.fetch({success:function(c,b){a.renderImageListLayout()}})},renderImage:function(c,d,b){var a=this;require(["text!application/templates/project/ProjectAddImageChoice.tpl.html"],function(h){var g=new ImageSelectView({model:d}).render();var f=d.get("filename");if(f.length>15){f=f.substring(0,12)+"..."}var i=_.template(h,{id:d.id,name:f,namefull:d.get("filename"),slide:d.get("slide"),info:d.get("info")});$(b).append(i);$(b+" "+a.imageDivElem+d.id).append(g.el);$(g.el).css({width:30});$(b).find("label  > b").css("font-size",10);if(c.get(d.id)){$(b+" #"+a.liElem+d.id).addClass(a.selectedClass);$(b+" #"+a.liElem+d.id).find(":checkbox").attr(a.checkedAttr,a.checkedAttr)}})},selectAllImages:function(a){$(".projectImageList"+a).find("li.imageThumbChoice").each(function(){$(this).find("a.checkbox-select").click()})},unselectAllImages:function(a){$(".projectImageList"+a).find("li.imageThumbChoice").each(function(){$(this).find("a.checkbox-deselect").click()})},renderSlide:function(a){var b=this;require(["text!application/templates/project/ProjectSlideDetail.tpl.html"],function(d){var g=_.template(d,{id:a.get("id"),name:a.get("name")});var f=$(b.ulElem+b.model.get("id"));f.append("<td>"+g+"</td>");f.find(".slideItem"+a.get("id")).panel({collapsible:false});f.find("a[class=selectAll]").bind("click",function(){b.selectAllImages(a.get("id"))});f.find("a[class=unselectAll]").bind("click",function(){b.unselectAllImages(a.get("id"))});f.find("a[class=selectAll]").button({text:false,icons:{secondary:"ui-icon-circle-plus"}});f.find("a[class=unselectAll]").button({text:false,icons:{secondary:"ui-icon-circle-minus"}});var c=a.get("images");var h=".projectImageList"+a.get("id");_.each(c,function(k){var i=new ImageModel(k);b.renderImage(b.imagesProject,i,h)});$("#projectImageList"+a.get("id")).carousel();$(h).append('<div style="clear:both;"></div>')})},renderImageListLayout:function(){var b=this;var g=0;var f=Math.abs(b.page)*b.nb_slide_by_page;var a=(Math.abs(b.page)+1)*b.nb_slide_by_page;$(b.ulElem+b.model.get("id")).empty();var d=4;var c=0;$(b.ulElem+b.model.get("id")).append("<table><tr width='25%'>");window.app.models.slides.each(function(h){if((g>=f)&&(g<a)){b.renderSlide(h);c++;if(c==d){c=0;$(b.ulElem+b.model.get("id")).append("</tr><tr width='25%'>")}}$(b.ulElem+b.model.get("id")).append("</tr></table>");$(".carousel-wrap").css("height","200");g++;if(g==a){b.initEvents()}})},addImageToProject:function(a,b){new ImageInstanceModel({}).save({project:b,user:null,baseImage:a},{success:function(d,c){window.app.view.message("ImageInstance",c.message,"success")},error:function(d,c){var f=$.parseJSON(c.responseText);window.app.view.message("Image",f.errors[0],"error")}})},deleteImageToProject:function(a,b){new ImageInstanceModel({id:1,project:b,user:null,baseImage:a}).destroy({success:function(d,c){window.app.view.message("ImageInstance",c.message,"success")},error:function(d,c){var f=$.parseJSON(c.responseText);window.app.view.message("Image",f.errors[0],"error")}})},initEvents:function(){alert("initEvents");var a=this;$(a.checklistChecked).parent().addClass(a.selectedClass);$(a.checklistSelected).click(function(d){d.preventDefault();$(this).parent().addClass(a.selectedClass);$(this).parent().find(":checkbox").attr(a.checkedAttr,a.checkedAttr);var b=$(this).parent().attr("id");var c=b.substring(a.liElem.length,b.length);a.addImageToProject(c,a.model.id)});$(a.checklistDeselected).click(function(d){d.preventDefault();$(this).parent().removeClass(a.selectedClass);$(this).parent().find(":checkbox").removeAttr(a.checkedAttr);var b=$(this).parent().attr("id");var c=b.substring(a.liElem.length,b.length);a.deleteImageToProject(c,a.model.id)})}});var ProjectAddImageSearchPanel=Backbone.View.extend({images:null,tab:null,initialize:function(b){var a=this;this.container=b.container;this.images=b.images;this.tab=b.tab},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageSearchDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(d){var b=this;var g=b.model.toJSON();var a=g.ontology;g.ontologyId=a;g.tab=b.tab;var f=_.template(d,g);$(b.el).append(f);b.renderImageListing();var c=[];$("#filenamesearchtextboxup"+b.model.id+"-"+b.tab).autocomplete({minLength:0,source:c,select:function(h,i){$("#filenamesearchtextboxup"+b.model.id+"-"+b.tab).val(i.item.label);b.container.searchImages()},search:function(h){b.container.searchImages()}});$("#datestartsearchup"+b.model.id+"-"+b.tab).change(function(){b.container.searchImages()});$("#dateendsearchup"+b.model.id+"-"+b.tab).change(function(){b.container.searchImages()});return this},search:function(a){var b=this;return b.filterImages(searchText==""?undefined:searchText,dateStart,dateEnd)},filterImages:function(f,d,c){var b=this;var a=new ImageCollection(b.images.models);a=b.filterByImagesByName(f,a);a=b.filterByDateStart(d,a);a=b.filterByDateEnd(c,a);return a},filterByImagesByName:function(c,b){var a=new ImageCollection(b.models);b.each(function(d){if(c!=undefined&&!d.get("filename").toLowerCase().contains(c.toLowerCase())){a.remove(d)}});return a},filterByDateStart:function(c,b){var a=new ImageCollection(b.models);b.each(function(f){var d=new Date();d.setTime(f.get("created"));if(c!=undefined&&d<c){a.remove(f)}});return a},filterByDateEnd:function(c,b){var a=new ImageCollection(b.models);b.each(function(f){var d=new Date();d.setTime(f.get("created"));if(c!=undefined&&d>c){a.remove(f)}});return a},renderImageListing:function(){var a=this}});var ProjectInfoDialog=Backbone.View.extend({initialize:function(a){_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectInfoDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(a){var d=_.template(a,this.model.toJSON());$(this.el).append(d);var f=4;var c=0;var b=function(h){if(h==f){$("#infoProject").modal("show")}};var g=this.model;new UserCollection({project:g.id,creator:true}).fetch({success:function(i,h){$("#userInfoBigPanel-"+g.id).find("#projectCreator").empty();var k=[];i.each(function(l){k.push(l.prettyName())});$("#userInfoBigPanel-"+g.id).find("#projectCreator").append(k.join(", "));b(++c)}});new UserCollection({project:g.id,admin:true}).fetch({success:function(h,i){$("#userInfoBigPanel-"+g.id).find("#projectAdmins").empty();var k=[];h.each(function(l){k.push(l.prettyName())});$("#userInfoBigPanel-"+g.id).find("#projectAdmins").append(k.join(", "));b(++c)}});new UserCollection({project:g.id}).fetch({success:function(k,h){$("#userInfoBigPanel-"+g.id).find("#projectUsers").empty();var i=[];k.each(function(l){i.push(l.prettyName())});$("#userInfoBigPanel-"+g.id).find("#projectUsers").append(i.join(", "));b(++c)}});new UserCollection({project:g.id,online:true}).fetch({success:function(k,h){$("#userInfoBigPanel-"+g.id).find("#projectUsersOnline").empty();var i=[];k.each(function(l){i.push('<span style="color:green;font-style: bold;">'+l.prettyName()+"</span>")});$("#userInfoBigPanel-"+g.id).find("#projectUsersOnline").append(i.join(", "));b(++c)}});new ImageInstanceCollection({project:g.id,max:3}).fetch({success:function(i,h){if(i.length!=0){i.each(function(l){var k='<div style="display : inline;margin: 10px;"><a id="viewImg-<%= id %>" href="#tabs-image-<%= project %>-<%= id %>-"><img class="lazy" alt="<%= filename %>" src="<%= thumb %>" style="height:200px;" /></a></div>';$("#imageInfoBigPanel-"+g.id).find(".row").append(_.template(k,l.toJSON()))})}else{$("#imageInfoBigPanel-"+g.id).find(".row").append("<div class='alert alert-block'>No data to display</div>")}$("#imageInfoBigPanel-"+g.id).find("a").click(function(){$("#infoProject").modal("hide");$("#infoProject").remove()})}});$("#closeInfoProject").on("click",function(h){$("#infoProject").modal("hide");$("#infoProject").remove()})}});var AnnotationListView=Backbone.View.extend({tagName:"div",self:this,alreadyBuild:false,initialize:function(a){this.container=a.container;this.idAnnotation=a.idAnnotation},render:function(){var a=this;require(["text!application/templates/annotation/AnnotationList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{name:"name",area:"area"}));a.model.each(function(g){var h=g.get("name");var i=g.get("area")});var d;var c=0;var f=[];a.model.each(function(g){f[c]={id:g.id,filename:g.get("filename"),created:""};c++});return this},initAnnotation:function(){var a=this}});var AnnotationRetrievalView=Backbone.View.extend({tagName:"div",baseAnnotation:null,terms:null,initialize:function(a){this.container=a.container;this.page=a.page;this.annotations=null;this.baseAnnotation=a.baseAnnotation;this.terms=a.terms;this.bestTerms=a.bestTerms;this.bestTermsValue=a.bestTermsValue;window.app.status.currentTermsCollection=a.terms;if(this.page==undefined){this.page=0}},render:function(){var a=this;console.log("AnnotationRetrievalView: main elem "+$(a.el).length);$("#myModalRetrieval").find("#retrievalPieChartTerm").empty();$("#myModalRetrieval").find("#retrievalPieChartProject").empty();$("#myModalRetrieval").find("#retrievalThumb").empty();console.log("3");a.createThumbView(a.page);console.log("4");a.createStatsView();return this},createTitle:function(){var a=this;var c=a.baseAnnotation.get("id");var b=[];_.each(a.bestTerms,function(f,d){if(f!=undefined&&f!=null){b.push(f.get("name")+" ("+(a.bestTermsValue[d]).toFixed(2)+"%)")}});return"Annotation "+c+": similar annotations "+b.join(", ")},createThumbView:function(a){this.appendThumbs(a)},createStatsView:function(){var b=this;var a={};b.model.each(function(d){var f=d.get("term");_.each(f,function(h){console.log(h);console.log(b.terms);var g=b.terms!=undefined&&b.terms.get(h)!=undefined;if(g){if(a[h]!=null){a[h]=a[h]+Number(d.get("similarity"))}else{a[h]=Number(d.get("similarity"))}}})});console.log("drawPieChartTerm");b.drawPieChartTerm(a);var c={};b.model.each(function(d){var f=d.get("project");if(c[f]!=null){c[f]=c[f]+1}else{c[f]=1}});console.log("drawPieChartProject");window.app.models.projects.fetch({success:function(f,d){b.drawPieChartProject(c,f)}})},drawPieChartTerm:function(k){var b=this;$("#retrievalPieChartTerm").empty();var h=new google.visualization.DataTable();h.addColumn("string","Term");h.addColumn("number","Similarity weighted sum");h.addRows(_.size(k));var f=0;var a=[];for(var d in k){if(k.hasOwnProperty(d)){var g=k[d];var c=b.terms.get(d);h.setValue(f,0,c.get("name"));h.setValue(f,1,g);f++}}new google.visualization.PieChart(document.getElementById("retrievalPieChartTerm")).draw(h,{width:500,height:350,title:""})},drawPieChartProject:function(f,b){var k=this;$("#retrievalPieChartProject").empty();var c=new google.visualization.DataTable();c.addColumn("string","Project");c.addColumn("number","Similarity in project");c.addRows(_.size(f));var d=0;var a=[];console.log(f);for(var h in f){if(f.hasOwnProperty(h)){var g=f[h];var l="Project not accessible";if(b.get(h)!=undefined){l=b.get(h).get("name")}c.setValue(d,0,l);c.setValue(d,1,g);d++}}console.log("creation:"+$("#retrievalPieChartProject").length);new google.visualization.PieChart(document.getElementById("retrievalPieChartProject")).draw(c,{width:500,height:350,title:""})},appendThumbs:function(g){var d=this;var h=0;var a=2500;var f=Math.abs(g)*a;var c=(Math.abs(g)+1)*a;d.annotations=[];console.log("**************************");console.log(d.baseAnnotation);var b=new AnnotationThumbView({model:d.baseAnnotation,className:"thumb-wrap",id:"annotationthumb"+d.baseAnnotation.get("id")}).render();$(b.el).css("border","50px");$(b.el).css("color","green");$(b.el).css("background-color","green");$("#retrievalThumb").append(b.el);d.model.each(function(i){if((h>=f)&&(h<c)){i.set({name:i.get("similarity")});i.set("reviewed",false);var k=new AnnotationThumbView({model:i,className:"thumb-wrap",id:"annotationthumb"+i.id}).render();$("#retrievalThumb").append(k.el)}h++;d.annotations.push(i.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(b){var a=this;var c=a.annotations;b.each(function(d){if(_.indexOf(a.annotations,d.id)==-1){a.add(d);a.annotations.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){a.remove(d);a.annotations=_.without(a.annotations,d)})}});var AnnotationQuestionableView=Backbone.View.extend({tagName:"div",terms:null,term:null,suggestTerm:null,initialize:function(a){this.container=a.container;this.page=a.page;this.annotations=null;this.terms=a.terms;this.term=a.term;this.suggestTerm=a.suggestTerm;window.app.status.currentTermsCollection=a.terms;if(this.page==undefined){this.page=0}},render:function(){var a=this;console.log("AnnotationQuestionableView: main elem "+$(a.el).length);$("#questionableThumb").replaceWith("");console.log($("#annotationQuestionable").length);console.log($(a.el).length);$(a.el).append('<div id="questionableThumb"></div>');console.log($(a.el).html());a.createThumbView(a.page);return this},createTitle:function(){var a=this;var c=a.terms.get(a.term).get("name");var b=a.terms.get(a.suggestTerm).get("name");return"Annotation with term "+c+" and algo suggest "+b},createThumbView:function(a){this.appendThumbs(a)},appendThumbs:function(f){var c=this;var g=0;var a=2500;var d=Math.abs(f)*a;var b=(Math.abs(f)+1)*a;c.annotations=[];c.model.each(function(h){if((g>=d)&&(g<b)){var k=new AnnotationModel({});k.set(h.toJSON());var i=new AnnotationThumbView({model:k,className:"thumb-wrap",id:"annotationthumb"+k.id}).render();console.log($("#questionableThumb").length);$("#questionableThumb").append(i.el)}g++;c.annotations.push(h.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(b){var a=this;var c=a.annotations;b.each(function(d){if(_.indexOf(a.annotations,d.id)==-1){a.add(d);a.annotations.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){a.remove(d);a.annotations=_.without(a.annotations,d)})}});var ShareAnnotationView=Backbone.View.extend({tagName:"div",initialize:function(a){this.image=a.image;this.project=a.project;this.dialog=null},doLayout:function(h,f){var b=this;this.model.set({username:window.app.view.getUserNameById(this.model.get("user"))});this.model.set({terms:"undefined"});this.dialog=new ConfirmDialogView({el:"#dialogs",template:_.template(h,this.model.toJSON()),dialogAttr:{dialogID:"#share-confirm"}}).render();var i=$("#selectUserShare"+b.model.id);var g=$("#comments"+b.model.id);var d=$("input[name=shareWithOption]");new AnnotationCommentCollection({annotation:b.model.id}).fetch({success:function(n,m){var l="<ul><li><b>( <%= hour %> )</b> <%= sender %> : <i><%= comment %></i></li></ul>";var k=undefined;n.each(function(q){var p=new Date();p.setTime(q.get("created"));var s=p.toLocaleDateString();if(s!=k){g.append(_.template("<h4><%= date %></h4>",{date:s}));k=s}var o=(p.getHours()<10)?"0"+p.getHours():p.getHours();var r=(p.getMinutes()<10)?"0"+p.getMinutes():p.getMinutes();g.append(_.template(l,{sender:q.get("sender"),comment:q.get("comment"),hour:o+"h"+r}))})},error:function(l,k){}});var a=[];window.app.models.projectUser.each(function(k){a.push({id:k.id,label:k.prettyName()})});b.userMaggicSuggest=i.magicSuggest({data:a,displayField:"label",value:[],width:300,maxSelection:null});$("#selectUserShare"+b.model.id).hide();var c=function(){var k=$("input[name=shareWithOption]:checked").val();if(k=="everyone"){var l=[];window.app.models.projectUser.each(function(m){l.push(m.get("id"))});return l}else{if(k=="somebody"){return b.userMaggicSuggest.getValue()}}};d.change(function(){var k=$(this).val();if(k=="everyone"){$("#selectUserShare"+b.model.id).hide()}else{if(k=="somebody"){$("#selectUserShare"+b.model.id).show()}}});$("#shareCancelButton"+b.model.id).click(function(k){k.preventDefault();b.dialog.close();window.history.back();return false});$("#shareButton"+b.model.id).click(function(l){l.preventDefault();var o=$(this);o.html("Sending...");var m=c();console.log(m);var r=(_.size(m)==1)?window.app.models.projectUser.get(m[0]).prettyName():"user";var p=$("#annotationComment"+b.model.id).val();var k=_.template("<%= serverURL %>/#share-annotation/<%= id %>",{serverURL:window.app.status.serverURL,id:b.model.id});var n=_.template("<%= serverURL %>/#tabs-image-<%= idProject %>-<%= idImage %>-<%= idAnnotation %>",{serverURL:window.app.status.serverURL,idProject:b.project,idImage:b.image,idAnnotation:b.model.id});var s=_.template(f,{from:window.app.models.projectUser.get(window.app.status.user.id).prettyName(),to:r,comment:p,annotationURL:n,shareAnnotationURL:k,by:window.app.status.serverURL});var q=_.template("Cytomine : <%= from %> shared an annotation with you",{from:window.app.models.projectUser.get(window.app.status.user.id).prettyName()});new AnnotationCommentModel({annotation:b.model.id}).save({users:m,message:s,comment:p,subject:q,annotationURL:n},{success:function(u,t){o.html("Share");window.app.view.message("Success",t.message,"success");b.dialog.close();window.history.back()},error:function(u,t){o.html("Share");window.app.view.message("Error",t.message,"error")}});return false});return this},render:function(){var a=this;require(["text!application/templates/annotation/ShareAnnotationView.tpl.html","text!application/templates/annotation/ShareAnnotationMail.tpl.html"],function(c,b){a.doLayout(c,b)})}});var ReviewStatsListing=Backbone.View.extend({project:null,user:null,currentPage:0,max:5,collection:null,initialize:function(a){this.container=a.container;this.project=a.project;this.image=a.image;this.user=a.user},render:function(){console.log("ReviewStatsListing.render()");var a=this;$("#buttonStatsReviewListing").find("button.previous").click(function(){a.previous()});$("#buttonStatsReviewListing").find("button.next").click(function(){a.next()});a.refresh();return this},refresh:function(){var a=this;$.get("/api/imageinstance/"+a.image+"/reviewedannotation/stats.json",function(c){$(a.el).find("#userStatsReviewListing").empty();$(a.el).find("#userStatsReviewListing").append("<ul></ul>");var b=0;_.each(c.collection,function(g){a.collection=c.collection;if(b>=(a.currentPage*a.max)&&b<((a.currentPage+1)*a.max)){var d=window.app.models.projectUser.get(g.user);if(!d){d=window.app.models.projectUserJob.get(g.user)}console.log($(a.el).find("#userStatsReviewListing").find("li").length);console.log(d.prettyName());var f=d.prettyName();var h=f+": "+g.reviewed+" / "+g.all+" reviewed";if(a.user==d.id){h="<strong>"+h+"</strong>"}$(a.el).find("#userStatsReviewListing").find("ul").append(h+"<br>")}b++})})},next:function(){var a=this;if(a.collection&&a.collection.length>((this.currentPage+1)*this.max)){this.currentPage=this.currentPage+1;a.refresh()}},previous:function(){var a=this;if(a.collection&&a.currentPage>0){this.currentPage=this.currentPage-1;a.refresh()}}});var ReviewLastReviewListing=Backbone.View.extend({project:null,user:null,initialize:function(a){this.container=a.container;this.project=a.project;this.user=a.user},render:function(){var a=this;console.log("*********************"+a.project);a.model=new AnnotationCollection({project:a.project,user:a.user,max:5,reviewed:true});a.refresh();return this},refresh:function(){var a=this;$(a.el).find("#lastReviewedAnnotation").empty();$(a.el).find("#lastReviewedAnnotation").append('<div class="alert alert-info"><i class="icon-refresh"/> Loading...</div>');a.model.fetch({success:function(c,b){a.model=c;$(a.el).find("#lastReviewedAnnotation").empty();if(c.length==0){$(a.el).append("<div class='alert alert-block'>No data to display</div> ")}a.model.each(function(f){var g=new AnnotationThumbView({model:f,className:"thumb-wrap",term:"all",reviewMode:true}).render();$(g.el).draggable({scroll:true,revert:true,delay:500,opacity:0.35,cursorAt:{top:85,left:90}});$(g.el).append("<p class='terms text-center'></p>");var d=[];_.each(f.get("term"),function(i){var h=window.app.status.currentTermsCollection.get(i);d.push(_.template(a.container.termSpanTemplate,h.toJSON()))});$(g.el).find(".terms").append(d.join(", "));$(g.el).find("div").css("margin","0px auto");$(g.el).find("div").css("float","none");$(g.el).append("<p class='text-center'>"+window.app.convertLongToDate(f.get("created"))+"</p>");$(a.el).find("#lastReviewedAnnotation").append("<hr/>");$(a.el).find("#lastReviewedAnnotation").append(g.el);$(a.el).attr("data-reviewed","true")})}});$("#lastReviewListing").find(".thumb-wrap").draggable({containment:a.el,stack:"#lastReviewListing .thumb-wrap",cursor:"move",revert:true})}});var ReviewTermListing=Backbone.View.extend({width:null,software:null,project:null,parent:null,params:[],paramsViews:[],initialize:function(a){this.container=a.container},render:function(){var a=this;a.addTerm()},addTerm:function(){var a=this;a.sortWithOrder();a.model.each(function(b){var c=_.template(a.container.termSpanTemplate,b.toJSON());$(a.el).append('<div data-term="'+b.id+'" style="background-color: '+b.get("color")+';border-width: 3px; border-style: solid; border-color: rgb(183, 177, 177);min-width : 125px; min-height: 175px;text-align: center;margin-bottom: 15px;margin-top: 15px;margin-left: 15px;margin-right: 15px;" class="span1 termChoice" id="termDrop'+b.id+'">'+c+"</div>")});$(a.el).find("div>span").css("padding","0px");$("#termReviewChoice").sortable({update:function(){a.saveActualTermOrder()}});$("#termReviewChoice").disableSelection()},sortWithOrder:function(){var a=this;var b=$.cookie("review-order-"+window.app.status.currentProjectModel.get("ontology"));if(b!=undefined){var c=_.sortBy(a.model.models,function(d){return b.indexOf(d.get("id"))});a.model.models=c}},saveActualTermOrder:function(){var b=this;var a=_.map($(b.el).find("div"),function(c){return $(c).data("term")});console.log(a);$.cookie("review-order-"+window.app.status.currentProjectModel.get("ontology"),a)}});var ReviewAnnotationListing=Backbone.View.extend({tagName:"div",pagination_window:3,nbAnnotation:-1,max:5,currentPosition:0,initialize:function(a){this.container=a.container;this.page=a.page;this.term=a.term;if(this.page==undefined){this.page=0}},render:function(f,d,b,c){var a=this;console.log("render: project="+f+" image="+d+" user="+b+" term="+c);a.project=f;a.image=d;a.user=b;a.term=c;if(a.term=="no"){a.term=-1}else{if(a.term=="multiple"){a.term=-2}}$("#annotationReviewListing").find("#next1").click(function(){a.next()});$("#annotationReviewListing").find("#next5").click(function(){for(var g=0;g<5;g++){a.next()}});$("#annotationReviewListing").find("#previous1").click(function(){a.previous()});$("#annotationReviewListing").find("#previous5").click(function(){for(var g=0;g<5;g++){a.previous()}});$("#annotationReviewListing").find("#reviewAll").click(function(){$("#annotationReviewListing").find(".component").find("input").prop("checked",true);a.reviewChecked()});$("#annotationReviewListing").find("#checkAll").click(function(){$("#annotationReviewListing").find(".component").find("input").prop("checked",true)});$("#annotationReviewListing").find("#unCheckAll").click(function(){$("#annotationReviewListing").find(".component").find("input").prop("checked",false)});$(".check:button").click(function(){var g=!$(this).data("checked");$("input:checkbox").prop("checked",g);$(this).val(g?"uncheck all":"check all");$(this).data("checked",g)});a.refresh();return this},refresh:function(){var a=this;console.log("REFRESH ANNOTATION ||||||||||||||||||||||||||||||||||||||||||||||||");console.log(a.project);console.log([a.image]);console.log(a.term);console.log((a.user?[a.user]:null));$(a.el).find("#AnnotationNotReviewed").find("div").remove();$(a.el).find("#AnnotationNotReviewed").append('<div class="alert alert-info"><i class="icon-refresh"/> Loading...</div>');a.model=new AnnotationCollection({project:a.project,images:[a.image],term:a.term,user:a.user,reviewed:false,notReviewedOnly:true});a.model.goTo(this.page,{success:function(c,b){$(a.el).find("#AnnotationNotReviewed").find("div").remove();a.model=c;a.nbAnnotation=c.fullSize;a.appendThumbs(a.page);a.refreshPagaination()}})},refreshPagaination:function(){var a=this;$(a.el).find("span#pagin").empty();$(a.el).find("span#pagin").append("&nbsp;"+(a.currentPosition+1)+" / "+a.model.length+"&nbsp;");var c=a.currentPosition+a.max;if(c>a.model.size()-1){$("#annotationReviewListing").find("#next1").attr("disabled","disabled");$("#annotationReviewListing").find("#next5").attr("disabled","disabled")}else{$("#annotationReviewListing").find("#next1").removeAttr("disabled");$("#annotationReviewListing").find("#next5").removeAttr("disabled")}var b=a.currentPosition-1;if(b<0){$("#annotationReviewListing").find("#previous1").attr("disabled","disabled");$("#annotationReviewListing").find("#previous5").attr("disabled","disabled")}else{$("#annotationReviewListing").find("#previous1").removeAttr("disabled");$("#annotationReviewListing").find("#previous5").removeAttr("disabled")}},next:function(){var a=$("#AnnotationNotReviewed").find("div").first();this.hide(a.data("annotation"));this.refreshPagaination()},remove:function(b){var a=this;a.hide(b);a.model.remove(a.model.get(b));a.currentPosition--;a.refreshPagaination()},hide:function(d){var a=this;var c=a.currentPosition+a.max;$("#AnnotationNotReviewed").find("div[data-annotation="+d+"]").remove();$("#AnnotationNotReviewed").find(".popover").remove();if(c<=a.model.size()-1){var b=a.model.at(c);a.addAnnotation(b,true)}else{}a.currentPosition++;a.refreshPagaination()},previous:function(d){var a=this;var c=a.currentPosition-1;if(c>=0){if($("#AnnotationNotReviewed").find("div.thumb-wrap").length==5){$("#AnnotationNotReviewed").find("div.thumb-wrap").last().remove();$("#AnnotationNotReviewed").find(".popover").remove()}var b=a.model.at(c);a.addAnnotation(b,false);a.currentPosition--;a.refreshPagaination()}else{}},reviewChecked:function(){var b=this;var a=_.map($("#annotationReviewListing").find(".component").find("input:checked"),function(c){return $(c).data("annotation")});$.each(a,function(d,c){b.container.marskAsReviewed(c,null,false)})},appendThumbs:function(c){var a=this;var d=a.model.models;if(d.length==0){$(a.el).find("#AnnotationNotReviewed").append("<div class='alert alert-block'>No data to display: There is no annotation for this user and this term.</div> ")}for(var b=0;(b<a.max&&b<d.length);b++){a.addAnnotation(d[b],true)}},addAnnotation:function(a,g){var d=this;var c=new AnnotationThumbView({model:a,className:"thumb-wrap",term:"all",reviewMode:true,size:200}).render();$(c.el).draggable({scroll:true,revert:true,delay:500,opacity:0.35,cursorAt:{top:85,left:90},start:function(h,i){$("#AnnotationNotReviewed").find(".popover").remove()},stop:function(h,i){$("#annotationReviewListing").find(".component").find("input:checked").parent().parent().css({top:0,left:0})},drag:function(h,i){$("#annotationReviewListing").find(".component").find("input:checked").parent().parent().css({top:i.position.top,left:i.position.left})}});$(c.el).append("<p class='terms text-center'></p>");var b=[];_.each(a.get("term"),function(i){var h=window.app.status.currentTermsCollection.get(i);b.push(_.template(d.container.termSpanTemplate,h.toJSON()))});$(c.el).find(".terms").append(b.join(", "));$(c.el).append('<div class="component text-center"></div>');$(c.el).css("max-width","200px");$(c.el).find(".component").append('<button  data-toggle="modal" data-target="#browseReviewModal" style="display:inline;" data-annotation = "'+a.id+'" class="btn openBrowseReview" style="min-width:100%;">Open</button>');$(c.el).find(".component").append('<button  style="display:inline;" data-annotation = "'+a.id+'" class="btn review" style="min-width:100%;">Accept</button>');$(c.el).find(".component").append('<input data-annotation="'+a.id+'" style="display:inline;" type="checkbox" value="takeMe">');if(g){$(d.el).find("#AnnotationNotReviewed").append(c.el)}else{$(d.el).find("#AnnotationNotReviewed").prepend(c.el)}$(d.el).attr("data-reviewed","false");$(c.el).find("button.review").click(function(){d.container.marskAsReviewed($(this).data("annotation"),null,false)});console.log("registerReviewPopup");var f=new CustomModal({idModal:"browseReviewModal",button:$(c.el).find("button.openBrowseReview"),header:"BrowseAnnotation",body:'<div id="browseAnnotationModal"></div>',width:Math.round($(window).width()*0.75),height:Math.round($(window).height()*0.75),callBack:function(){new ImageInstanceModel({id:a.get("image")}).fetch({success:function(k,i){var h=new BrowseImageView({addToTab:false,review:true,initCallback:function(){console.log("initCallback");h.show({goToAnnotation:{value:a.id}})},el:$("#browseAnnotationModal")});h.model=k;h.render()}})}});f.addButtons("closeBrowseReview","Close",true,true)}});var DashboardReviewPanel=Backbone.View.extend({width:null,software:null,project:null,parent:null,params:[],paramsViews:[],user:null,term:null,disableEvent:false,termSpanTemplate:null,initialize:function(a){this.el="#tabs-reviewdash-"+this.model.id},render:function(d,b,c){var a=this;require(["text!application/templates/review/ReviewPanel.tpl.html","text!application/templates/image/ImageReviewAction.tpl.html","text!application/templates/ontology/TermSpan.tpl.html"],function(h,g,f){a.termSpanTemplate=f;$("#explorer-tab").find("a[href='#tabs-reviewdash-"+window.app.status.currentProject+"']").parent().show();new ImageInstanceModel({id:d}).fetch({success:function(k,i){new UserJobCollection({project:window.app.status.currentProject,image:d}).fetch({success:function(o,l){a.userJobForImage=o;$(a.el).empty();var n=null;if(k.get("reviewUser")){n=window.app.models.projectUser.get(k.get("reviewUser")).prettyName()}$(a.el).append(_.template(h,{idImage:d,imageFilename:k.getVisibleName(window.app.status.currentProjectModel.get("blindMode")),projectName:a.model.get("name"),reviewer:n,validate:k.get("reviewStop")}));if(n==null){$("a#startToReview"+d).click(function(p){p.preventDefault();new ImageReviewModel({id:d}).save({},{success:function(r,q){window.app.view.message("Image",q.message,"success");a.refresh()},error:function(r,q){var s=$.parseJSON(q.responseText);window.app.view.message("Image",s.errors,"error")}})})}a.initFilter(b,c);$(a.el).find("#reviewCytoAction").append(_.template(g,k.toJSON()));var m=new ImageReviewAction({el:$("#reviewCytoAction"),model:k,container:a});m.configureAction();$("#statsReviewListing").css("min-height",$("#filterReviewListing").height());a.initStatsReview(d,b);a.initLastReview();a.initAnnotationListing(d,b,c);a.initTermListing()}})}})});window.app.view.currentReview=this;return this},refresh:function(d,b,c){var a=this;if(!d){a.render(a.image,a.user,a.term);return}else{a.render(d,b,c)}},marskAsReviewed:function(d,c,a){var b=this;new AnnotationReviewedModel({id:d}).save({terms:c},{success:function(g,f){if(!a){b.annotationListing.remove(d);console.log(b.lastReviewListing)}b.lastReviewListing.refresh();b.reviewStatsListing.refresh()},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Annotation",h.errors,"error");b.refresh()}})},initLastReview:function(){var a=this;a.lastReviewListing=new ReviewLastReviewListing({user:window.app.status.user.id,project:a.model.id,container:a,el:$("#lastReviewListing")});a.lastReviewListing.render()},initStatsReview:function(c,b){var a=this;a.reviewStatsListing=new ReviewStatsListing({project:a.model.id,image:c,user:b,container:a,el:$("#statsReviewListing")});a.reviewStatsListing.render()},initAnnotationListing:function(d,b,c){console.log("initAnnotationListing");var a=this;a.image=d;a.user=b;a.term=c;a.annotationListing=new ReviewAnnotationListing({page:undefined,model:null,term:undefined,container:a,el:$("#annotationReviewListing")}).render(a.model.id,d,b,c);$("#annotationReviewListing").find(".thumb-wrap").draggable({containment:a.el,stack:"#annotationReviewListing .thumb-wrap",cursor:"move",revert:true})},initTermListing:function(){console.log("initTermListing");var a=this;var b=window.app.status.currentTermsCollection;a.termListing=new ReviewTermListing({model:b,container:a,el:$("#termReviewChoice")}).render();$("#termReviewChoice").find("div").droppable({accept:"#annotationReviewListing .thumb-wrap, #lastReviewedAnnotation .thumb-wrap",hoverClass:"termHovered",drop:a.handle,cursor:"move",revert:true})},handle:function(a,b){b.draggable.draggable("option","revert",false);if(b.draggable.data("reviewed")){window.app.view.currentReview.handleReviewed($(this),a,b)}else{window.app.view.currentReview.handleNotReviewed($(this),a,b)}},handleNotReviewed:function(f,g,h){var c=this;var d=$(f).data("term");var b=h.draggable.data("annotation");var a=_.map($("#annotationReviewListing").find(".component").find("input:checked"),function(i){return $(i).data("annotation")});console.log(a);if(a.length==0){window.app.view.currentReview.marskAsReviewed(b,[d],false)}else{console.log(a);a=_.union(a,[b]);console.log(a);_.each(a,function(i){console.log("review:"+i);window.app.view.currentReview.marskAsReviewed(i,[d],false)})}},handleReviewed:function(d,g,h){var b=this;var c=$(d).data("term");var a=h.draggable.data("annotation");var f=window.app.view.currentReview.lastReviewListing.model.get(a).get("parentIdent");new AnnotationReviewedModel({id:f}).destroy({success:function(k,i){window.app.view.currentReview.marskAsReviewed(f,[c],true)},error:function(k,i){var l=$.parseJSON(i.responseText);window.app.view.message("Annotation",l.errors,"error")}})},dropStyleAnnotation:function(a,b){b.draggable.draggable("disable");b.draggable.position({of:$(this),my:"left top",at:"left top"});b.draggable.draggable("option","revert",false)},initFilter:function(b,c){var a=this;var g=$("#filterReviewListing").find("#filterUser");g.empty();g.append('<option value="0">All user (no job)</option>');window.app.models.projectUser.each(function(h){g.append('<option value="'+h.id+'">'+h.prettyName()+"</option>")});a.userJobForImage.each(function(h){g.append('<option value="'+h.id+'">'+h.prettyName()+"</option>")});var f=$("#filterReviewListing").find("#filterTerm");f.empty();f.append('<option value="0">All</option>');f.append('<option value="-1">No Term</option>');f.append('<option value="-2">Multiple Term</option>');window.app.status.currentTermsCollection.each(function(h){f.append('<option value="'+h.id+'">'+h.get("name")+"</option>")});var d=function(){var i=g.val();var h=f.val();if(i==0){i=null}if(h==0){h=null}else{if(h==-1){h="no"}else{if(h==-2){h="multiple"}}}if(!a.disableEvent){window.location="#tabs-reviewdash-"+a.model.id+"-"+a.image+"-"+i+"-"+h}};g.change(d);f.change(d);a.changeSelectedFilter(b,c)},changeSelectedFilter:function(b,c){var a=this;var f=$("#filterReviewListing").find("#filterUser");var d=$("#filterReviewListing").find("#filterTerm");a.disableEvent=true;if(b){f.val(b)}else{f.val(0)}if(c){if(c=="no"){d.val(-1)}else{if(c=="multiple"){d.val(-2)}else{d.val(c)}}}else{d.val(0)}a.disableEvent=false}});var CrudGridView=Backbone.View.extend({customFields:{color:{colorPickerElement:function(c,a){var b=_.template('<input type="text" name="color" value="<%=   value %>">',{value:c});setTimeout(function(){$("#color").ColorPicker({color:c,onShow:function(d){$(d).fadeIn(500);return false},onSubmit:function(d,h,f,g){$(g).val("#"+h);$(g).ColorPickerHide()},onBeforeShow:function(){$(this).ColorPickerSetColor(this.value)},onHide:function(d){$(d).fadeOut(500);return false}})},200);return b},colorPickerValue:function(b,a,c){if(a==="get"){return $(b).val()}else{if(a==="set"){$("input",b).val(c)}}}}},initialize:function(a){this.title=a.title;this.pager="pager"+this.title;this.colNames=a.colNames;this.colModel=a.colModel;this.url=a.url;this.restURL=a.restURL;if(this.restURL!=undefined&&this.restURL.charAt(this.restURL.length-1)!="/"){this.restURL+="/"}},render:function(){var a=this;require(["text!application/templates/utils/CrudGridView.tpl.html"],function(b){a.doLayout(b)})},doLayout:function(a){var b=_.template(a,{pager:this.pager,title:this.title});$(this.el).html(b);this.initGrid();this.renderTable();this.initToolbar()},initGrid:function(){jQuery.extend(jQuery.jgrid.edit,{ajaxEditOptions:{contentType:"application/json"},recreateForm:true,serializeEditData:function(a){return JSON.stringify(a)},afterSubmit:function(a,c){var b=jQuery.parseJSON(a.responseText);return[true,"",b.d]}});jQuery.extend(jQuery.jgrid.del,{ajaxDelOptions:{contentType:"application/json"},recreateForm:true,serializeEditData:function(a){return JSON.stringify(a)},afterSubmit:function(a,c){var b=jQuery.parseJSON(a.responseText);return[true,"",b.d]}})},initToolbar:function(){var k=this;var c=600;var h=500;var b=$(window).width()/2-(c/2);var g=$(window).height()/2-(h/2);var a=$(k.el).find(".grid");var i=$(this.el).find(".crud-toolbar").find("a[name=add]");i.button({text:true,icons:{primary:"ui-icon-plus"}});i.click(function(){a.jqGrid("editGridRow","new",{top:g,left:b,width:c,height:h,mtype:"POST",reloadAfterSubmit:true,modal:true,closeOnEscape:true,closeAfterAdd:true,url:k.restURL,afterSubmit:function(l,m){var n=$.parseJSON(l.responseText);_.each(m.authorities.split(","),function(o){new UserSecRole({user:n.user.id,role:o}).save()});return[true,"",null]}})});var d=$(this.el).find(".crud-toolbar").find("a[name=edit]");d.button({text:true,icons:{primary:"ui-icon-pencil"}});d.click(function(){var l=a.jqGrid("getGridParam","selrow");var m=a.getRowData(l);if(l!=null){a.jqGrid("editGridRow",l,{top:g,left:b,width:c,height:h,mtype:"PUT",reloadAfterSubmit:true,modal:true,closeOnEscape:true,closeAfterEdit:true,url:k.restURL+m.id})}else{window.app.view.message("Error","Please select a row","error")}});var f=$(this.el).find(".crud-toolbar").find("a[name=delete]");f.button({text:true,icons:{primary:"ui-icon-trash"}});f.click(function(){var l=a.jqGrid("getGridParam","selrow");var m=a.getRowData(l);if(l!=null){a.jqGrid("delGridRow",l,{top:g,left:b,width:c,height:h,mtype:"DELETE",reloadAfterSubmit:false,beforeSubmit:function(n,o){new UserModel({id:n}).fetch({success:function(q,p){var r=q.get("authorities");_.each(r.split(","),function(s){alert(s)})}});alert(n);return[true,""]},modal:true,closeOnEscape:true,closeAfterEdit:true,url:k.restURL+m.id})}else{window.app.view.message("Error","Please select a row","error")}})},renderTable:function(){var a=this;var b=$(a.el).find(".grid");b.jqGrid({datatype:"json",url:this.url,width:900,height:500,colNames:this.colNames,colModel:this.colModel,onSelectRow:function(c){},loadComplete:function(c){b.setGridWidth(Math.max(500,$(a.el).width()-300),true);b.setGridHeight(Math.max(300,$(a.el).height()-500),true)},sortname:"id",viewrecords:true,sortorder:"asc",caption:this.title,modal:false,pager:"#"+this.pager,editurl:a.restURL,jsonReader:{repeatitems:false,id:"0"}});$(window).bind("resize",function(){b.setGridWidth(Math.max(500,$(a.el).width()-300),true);b.setGridHeight(Math.max(300,$(a.el).height()-200),true)}).trigger("resize")}});var Component=Backbone.View.extend({tagName:"div",views:{},initialize:function(a){this.divId=a.divId;this.el=a.el;this.template=a.template;this.buttonAttr=a.buttonAttr;if(a.activate!=undefined){this.activate=a.activate}if(a.deactivate!=undefined){this.deactivate=a.deactivate}if(a.show!=undefined){this.show=a.show}},render:function(){var a=this;$(this.el).append(this.template);return this},activate:function(){$("#"+this.divId).show();$("#"+this.buttonAttr.elButton).parent().addClass("active")},deactivate:function(){$("#"+this.divId).hide();$("#"+this.buttonAttr.elButton).parent().removeClass("active")},show:function(a,f,c){$(f).find(".title.active").each(function(){$(this).removeClass("active")});$(f).find("a[name="+c+"]").addClass("active");for(var d in this.views){var b=this.views[d];if(b!=a){$(b.el).hide()}}$(a.el).show()}});Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))};Storage.prototype.getObject=function(a){return JSON.parse(this.getItem(a))};var ApplicationView=Backbone.View.extend({tagName:"div",className:"layout",components:{},intervals:[],isMobile:(navigator.userAgent.match(/iPad/i)!=null),panelsConfiguration:[{key:"sidebar-map-left",linkID:"toggle-sidebar-map-left",name:"Left panels",className:["sidebar-map-left","olControlZoomPanel"],value:{visible:true}},{key:"sidebar-map-right",linkID:"toggle-sidebar-map-right",name:"Panels",className:["sidebar-map-right"],value:{visible:true}}],events:{},clearIntervals:function(){_.each(this.intervals,function(a){clearInterval(a)})},undo:function(){window.app.controllers.command.undo()},redo:function(){window.app.controllers.command.redo()},hideFloatingPanels:function(){var a=this;_.each(this.panelsConfiguration,function(b){a.hideFloatingPanel(b)})},hideFloatingPanel:function(a){if(_.isArray(a.className)){_.each(a.className,function(b){$("."+b).hide()})}else{$("."+a.className).hide()}},showFloatingPanels:function(){var a=this;_.each(this.panelsConfiguration,function(b){a.showFloatingPanel(b)})},showFloatingPanel:function(a){if(_.isArray(a.className)){_.each(a.className,function(b){$("."+b).show()})}else{$("."+a.className).show()}},toggleVisibility:function(c){var a=this;var b=localStorage.getObject(c.key);b.visible=!b.visible;if(b.visible&&this.isMobile){_.each(a.panelsConfiguration,function(d){if(d.key==c.key){return}var f=false;preferencePanel=localStorage.getObject(d.key);preferencePanel.visible=f;localStorage.setObject(d.key,preferencePanel);a.updateMenuItem(d)})}localStorage.setObject(c.key,b);this.updateMenuItem(c)},updateMenuItem:function(c){var a=this;var b=localStorage.getObject(c.key);if(b!=undefined&&b.visible!=undefined&&b.visible==true){$("#"+c.linkID).html("<i class='icon-eye-close' /> "+c.name);a.showFloatingPanel(c)}else{$("#"+c.linkID).html("<i class='icon-eye-open' /> "+c.name);a.hideFloatingPanel(c)}},initialize:function(a){},doLayout:function(b,c){var a=this;$("body").prepend(_.template(b,{}));_.each(this.components,function(d){d.render()});a.initEvents();c.call();return this},initEvents:function(){$(document).on("click","#undo",this.undo);$(document).on("click","#redo",this.redo)},render:function(b){this.initComponents();var a=this;require(["text!application/templates/BaseLayout.tpl.html","text!application/templates/HotkeysDialog.tpl.html"],function(c,d){a.doLayout(c,b);var f=new CustomModal({idModal:"hotkeysModal",button:$("#hotkeysModalButton"),header:"HotKeys",body:d,width:900,height:800});f.addButtons("closeHotKeys","Close",true,true)});return this},initPreferences:function(){_.each(this.panelsConfiguration,function(a){if(localStorage.getObject(a.key)){return}localStorage.setObject(a.key,a.value)})},applyPreferences:function(){var a=this;_.each(a.panelsConfiguration,function(b){a.updateMenuItem(b)})},initUserMenu:function(){var a=this;require(["text!application/templates/MenuDropDown.tpl.html"],function(b){$("#menu-right").append(b);$("#logout").click(function(){window.app.controllers.auth.logout();return false});$("#loggedUser").html(window.app.status.user.model.prettyName());_.each(a.panelsConfiguration,function(c){a.updateMenuItem(c);$("#"+c.linkID).on("click",function(){a.toggleVisibility(c)})});$("#toggle-floating-panel").on("click",function(){var d="toggle-floating-panel";var c=localStorage.getObject(d);c.activated=!c.activated;localStorage.setObject(d,c)});$("#feedback").on("click",function(c){c.preventDefault();showClassicWidget()})})},printTaskEvolution:function(a,c,b){this.printTaskEvolution(a,c,b,false)},printTaskEvolution:function(a,g,c,b){function d(){console.log(a);new TaskModel({id:a.id}).fetch({success:function(i,h){g.empty();g.append('<div class="progress progress-striped active">   <div class="bar" style="width: '+i.get("progress")+'%;"></div></div>');g.append(i.get("comments").reverse().join("<br>"))},error:function(i,h){console.log("error getting task")}})}d();var f=setInterval(function(){d()},c);return f},initComponents:function(){var a=this;require(["text!application/templates/upload/UploadComponent.tpl.html","text!application/templates/project/ProjectComponent.tpl.html","text!application/templates/ontology/OntologyComponent.tpl.html","text!application/templates/explorer/ExplorerComponent.tpl.html","text!application/templates/AdminComponent.tpl.html","text!application/templates/activity/ActivityComponent.tpl.html","text!application/templates/account/AccountComponent.tpl.html"],function(g,d,h,f,i,c,b){a.components.activity=new Component({el:"#content",template:_.template(c,{}),buttonAttr:{elButton:"activity-button"},divId:"activity"});a.components.upload=new Component({el:"#content",template:_.template(g,{}),buttonAttr:{elButton:"upload-button"},divId:"upload"});a.components.account=new Component({el:"#content",template:_.template(b,{}),buttonAttr:{elButton:"upload-button"},divId:"account"});a.components.project=new Component({el:"#content",template:_.template(d,{}),buttonAttr:{elButton:"project-button"},divId:"project"});a.components.ontology=new Component({el:"#content",template:_.template(h,{}),buttonAttr:{elButton:"ontology-button"},divId:"ontology"});a.components.explorer=new Component({el:"#content",template:_.template(f,{}),buttonAttr:{elButton:"explorer-button"},divId:"explorer",activate:function(){if(window.app.status.currentProject==undefined){$("#explorer > .noProject").show()}else{$("#explorer > .noProject").hide()}$("#"+this.divId).show();$("#"+this.buttonAttr.elButton).parent().addClass("active")}})})},showComponent:function(a){_.each(this.components,function(b){if(b!=a){b.deactivate()}});$("#app").show();a.activate()},getUserNameById:function(a){if(window.app.models.projectUser.get(a)){return window.app.models.projectUser.get(a).prettyName()}else{if(window.app.models.projectUserJob.get(a)){return window.app.models.projectUserJob.get(a).get("softwareName")}else{return"undefined"}}}});ApplicationView.prototype.message=function(k,l,i,a){if(i==""||i==undefined){i="alert-info"}else{i="alert-"+i}if(l!=undefined){l.responseText&&(l=l.responseText)}var c='<div style="width : 400px;" id="alert<%=   timestamp %>" class="alert <%=   type %> fade in" data-alert="alert"><a class="close" data-dismiss="alert">×</a><p><strong><%=   alert %></strong> <%=   message %></p></div>';var f=new Date().getTime();var b=($(window).width()/2-200);var h=$("#alerts").find("div.alert").length;var d=1;var g=h-d;if(g>0){$("#alerts").find("div.alert:lt("+(g)+")").remove()}$("#alerts").css("left",b);$("#alerts").append(_.template(c,{alert:k,message:l,timestamp:f,type:i}));if(!a){a=3000}setTimeout(function(){$("#alert"+f).remove()},a)};var ConfirmDialogView=Backbone.View.extend({tagName:"div",templateURL:null,templateData:null,initialize:function(a){this.el=a.el;this.template=a.template;this.templateURL=a.templateURL;this.autoOpen=a.autoOpen;this.templateData=a.templateData;this.dialogAttr={autoOpen:true,width:"auto",height:"auto"};if(a.dialogAttr!=undefined){if(a.dialogAttr.autoOpen){this.dialogAttr.autoOpen=a.dialogAttr.autoOpen}if(a.dialogAttr.width){this.dialogAttr.width=a.dialogAttr.width}if(a.dialogAttr.height){this.dialogAttr.height=a.dialogAttr.height}if(a.dialogAttr.dialogID){this.dialogAttr.dialogID=a.dialogAttr.dialogID}}},doLayout:function(b){var a=this;$(this.el).html(b);$(this.dialogAttr.dialogID).modal({keyboard:true,show:true,backdrop:(this.dialogAttr.backdrop!=undefined)?this.dialogAttr.backdrop:false});$(this.dialogAttr.dialogID).on("hidden",function(){$(a.dialogAttr.dialogID).remove()})},render:function(){var a=this;if(this.template==null&&this.templateURL!=null&&this.templateData!=null){require([this.templateURL],function(b){a.template=_.template(b,a.templateData);a.doLayout(a.template)})}else{this.doLayout(this.template)}return this},close:function(){$(this.dialogAttr.dialogID).modal("hide");$(this.dialogAttr.dialogID).remove()}});var CustomModal=Backbone.View.extend({initialize:function(a){this.buttons=[];this.idModal=a.idModal;this.button=a.button;this.header=a.header;this.body=a.body;this.width=a.width;this.height=a.height;this.callBack=a.callBack;this.registerModal()},addButtons:function(f,d,a,c,b){this.buttons.push({id:f,text:d,close:(c?"modal":""),primaryClass:(a?"btn-primary":""),callBack:b})},registerModal:function(){var a=this;console.log("registerModal");console.log(a.button.length);a.button.unbind();a.button.click(function(){console.log("click show modal");require(["text!application/templates/utils/CustomModal.tpl.html"],function(c){var d=$("#modals");d.empty();var b=_.template(c,{id:a.idModal,header:a.header,body:a.body,width:a.width,height:a.height,halfWidth:(a.width/2),buttons:a.buttons});d.append(b);_.each(a.buttons,function(f){$("#"+f.id).click(function(){if(f.callBack){f.callBack()}return true})});if(a.callBack){a.callBack()}});return true})}});var DescriptionModal={initDescriptionModal:function(a,b,d,f,i,h){var c=Math.round($(window).width()*0.75);var k=Math.round($(window).height()*0.75);console.log("initDescriptionModal");console.log(a.find("a.description").html());var g=new CustomModal({idModal:"descriptionModal"+d,button:a.find("a.description"),header:"Description",body:'<div id="description'+d+'"><textarea style="width: '+(c-100)+"px;height: "+(k-100)+'px;" id="descriptionArea'+d+'" placeholder="Enter text ...">'+i+"</textarea></div>",width:c,height:k,callBack:function(){$("#descriptionArea"+d).wysihtml5({});$("#saveDescription"+b).click(function(l){new DescriptionModel({id:b,domainIdent:d,domainClassName:f}).save({domainIdent:d,domainClassName:f,data:$("#descriptionArea"+d).val()},{success:function(n,m){h()},error:function(n,m){var o=$.parseJSON(m.responseText);window.app.view.message("Correct term","error:"+o.errors,"")}})})}});g.addButtons("saveDescription"+b,"Save",true,true);g.addButtons("closeDescription"+b,"Close",false,true)},initDescriptionView:function(g,c,b,a,h,f){var d=this;new DescriptionModel({domainIdent:g,domainClassName:c}).fetch({success:function(l,k){b.empty();var m=l.get("data");var i="Edit";if(m.replace(/<[^>]*>/g,"").length>a){m=m.substr(0,a)+"...";i="See full text and edit"}b.append(m);b.append(' <a href="#descriptionModal'+g+'" role="button" class="description" data-toggle="modal">'+i+"</a>");h();d.initDescriptionModal(b,l.id,g,c,l.get("data"),f)},error:function(k,i){b.empty();b.append(' <a href="#descriptionModal'+g+'" role="button" class="description" data-toggle="modal">Add description</a>');d.initDescriptionModal(b,null,g,c,"",f)}})}};var HotKeys={initHotKeys:function(){var a=this;$(document).bind("keydown.a",function(b){if(a.checkMode("review")){a.doClick("div"+window.location.hash.toString(),".acceptButton")}});$(document).bind("keydown.r",function(b){if(a.checkMode("review")){a.doClick("div"+window.location.hash.toString(),".rejectButton")}});$(document).bind("keydown.n",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".nextImage")}});$(document).bind("keydown.p",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".previousImage")}});$(document).bind("keydown.s",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".selectButton")}});$(document).bind("keydown.f",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".freehandButton")}});$(document).bind("keydown.w",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".magicWandButton")}});$(document).bind("keydown.e",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".editButton")}});$(document).bind("keydown.c",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".cutButton")}});$(document).bind("keydown.j",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".joinButton")}});$(document).bind("keydown.d",function(b){if(a.checkMode("review")||a.checkMode("image")){a.doClick("div"+window.location.hash.toString(),".deleteButton")}});$(document).bind("keydown.t",function(b){if(a.checkMode("review")){a.doClick("div"+window.location.hash.toString(),".printReviewLayerButton")}})},checkMode:function(b){var a=window.location.hash.toString();if(a.indexOf("#tabs-review")!=-1){return"review"==b}if(a.indexOf("#tabs-image")!=-1){return"image"==b}return"error"},doClick:function(b,a){var d=$(b).find(a);var c=d.attr("disabled");console.log("***************");console.log(b);console.log(a);console.log($(b).length);console.log(d.length);console.log(c);if(c=="disabled"){}else{d.click()}}};var Processing=Processing||{};Processing.Utils={tolerance:30,startColorR:null,startColorG:null,startColorB:null,fillColorR:255,fillColorG:0,fillColorB:0,canvasWidth:256,canvasHeight:256,getPixelPos:function(a,b){return(b*this.canvasWidth+a)*4},matchStartColor:function(a,b){return this.matchColor(a,b,this.startColorR,this.startColorG,this.startColorB,this.tolerance)},matchReplacementColor:function(a,b){return this.matchColor(a,b,this.fillColorR,this.fillColorG,this.fillColorB,0)},matchColor:function(f,i,k,q,d,n){var a=f.data[i];var l=f.data[i+1];var o=f.data[i+2];var m=a-k;var c=l-q;var h=o-d;var p=Math.sqrt(m*m+c*c+h*h);return p<=n},colorPixel:function(d,g,b,a,f){var i=b||this.fillColorR;var h=a||this.fillColorG;var c=f||this.fillColorB;d.data[g]=i;d.data[g+1]=h;d.data[g+2]=c;d.data[g+3]=255;return d}};var Processing=Processing||{};Processing.invert={process:function(a){var c=a.data;for(var b=0,d=c.length;b<d;b+=4){c[b]=255-c[b];c[b+1]=255-c[b+1];c[b+2]=255-c[b+2]}}};var Processing=Processing||{};Processing.MagicWand=$.extend({},Processing.Utils,{defaultTolerance:70,bbox:null,canvas:null,startX:null,startY:null,maxIter:10000,process:function(c){this.tolerance=c.tolerance||this.tolerance;this.canvasWidth=c.canvasWidth;this.canvasHeight=c.canvasHeight;this.canvas=c.canvas;this.startX=c.startX;this.startY=c.startY;this.bbox=null;var a=this.getPixelPos(c.startX,c.startY);this.startColorR=this.canvas.data[a];this.startColorG=this.canvas.data[a+1];this.startColorB=this.canvas.data[a+2];if(this.matchReplacementColor(this.canvas,this.getPixelPos(this.startX,this.startY))){return}this.initBBOX(this.startX,this.startY);var b=this.wand(this.canvas,this.startX,this.startY);return{success:b,canvas:this.canvas,bbox:this.bbox}},wand:function(a,g,f){var b=[[g,f]];var n=0;var l=0;while(b.length&&l<this.maxIter){l++;var h,m,k,d,i,c;h=b.pop();m=h[0];k=h[1];this.updateBBOX(m,k);d=this.getPixelPos(m,k);while(k-->=n&&this.matchStartColor(a,d)){d-=this.canvasWidth*4}d+=this.canvasWidth*4;++k;i=false;c=false;while(k++<this.canvasHeight-1&&this.matchStartColor(a,d)){this.updateBBOX(m,k);a=this.colorPixel(a,d);if(m>0){if(this.matchStartColor(a,d-4)){if(!i){b.push([m-1,k]);i=true}}else{if(i){i=false}}}if(m<this.canvasWidth-1){if(this.matchStartColor(a,d+4)){if(!c){b.push([m+1,k]);c=true}}else{if(c){c=false}}}d+=this.canvasWidth*4}}return l<this.maxIter},initBBOX:function(a,b){this.bbox={};this.bbox.xmin=a;this.bbox.xmax=a;this.bbox.ymin=b;this.bbox.ymax=b},updateBBOX:function(a,b){this.bbox.xmin=Math.min(this.bbox.xmin,a);this.bbox.xmax=Math.max(this.bbox.xmax,a);this.bbox.ymin=Math.min(this.bbox.ymin,b);this.bbox.ymax=Math.max(this.bbox.ymax,b)}});var Processing=Processing||{};Processing.Outline=$.extend({},Processing.Utils,{canvas:null,points:null,xmin:null,maxIter:10000,process:function(b){var m=this;this.canvasWidth=b.canvasWidth;this.canvasHeight=b.canvasHeight;this.canvas=b.canvas;var c=this.findOutlineFirstPoint(b.canvas,b.bbox);var g=c.x;var d=c.y;var f=true;var a=this.canvasWidth;var l=g;var k=d;var i=0;while(i<this.maxIter){var h=this.traceEdge(g,d);if(h){if(f){return{startX:g,startY:d,points:this.points}}if(a<=g){console.log("check polygon needed");return{startX:g,startY:d,points:this.points}}}f=false;if(!this.inside(l,k)){do{l++;if(l>this.canvasWidth){console.log("Wand Malfunction")}}while(!this.inside(l,k))}do{l++}while(this.inside(l,k));i++}},traceEdge:function(d,c){var l=this;var b=false;var a=true;this.xmin=this.canvasWidth;this.points=[];var m;if(this.inside(d,c)){m=1}else{m=3;c++}var k=d;var h=c;var i=m;var g=0;do{g++;var f;if(b){f=i;do{if(!this.inside_dir(k,h,f)){break}f++}while(f<i+2);f--}else{f=i+1;do{if(this.inside_dir(k,h,f)){break}f--}while(f>=i)}if(a||f!=i){this.addPoint(k,h)}switch(f&3){case 0:k++;break;case 1:h--;break;case 2:k--;break;case 3:h++;break}i=f}while((k!=d||h!=c||(i&3)!=m)&&(g<10000));if(a||this.points[0].x!=k){this.addPoint(k,h)}return(i<=0)},inside:function(a,c){if(a<0||a>=this.canvasWidth||c<0||c>=this.canvasHeight){return false}var b=this.getPixelPos(a,c);return this.matchReplacementColor(this.canvas,b)},inside_dir:function(a,c,b){switch(b&3){case 0:return this.inside(a,c);case 1:return this.inside(a,c-1);case 2:return this.inside(a-1,c-1);case 3:return this.inside(a-1,c)}return false},addPoint:function(a,b){this.points.push({x:a-1,y:b});if(this.xmin>a){this.xmin=a}},findOutlineFirstPoint:function(c,d){var b=d.xmin;var a=Math.round(d.ymin+(d.ymax-d.ymin)/2);while(!this.matchReplacementColor(c,this.getPixelPos(b,a))&&b<this.canvasWidth){b++}return{x:b,y:a}}});var Processing=Processing||{};Processing.Threshold=$.extend({},Processing.Utils,{defaultTheshold:165,process:function(f){console.log("Thresholding...");var c=f.canvas;var k=f.threshold;var m=c.data;for(var h=0;h<m.length;h+=4){var a=m[h];var l=m[h+1];var n=m[h+2];var o=(0.2126*a+0.7152*l+0.0722*n>=k)?255:0;m[h]=m[h+1]=m[h+2]=o}return c}});var Processing=Processing||{};Processing.ColorChannel=$.extend({},Processing.Utils,{RED:0,GREEN:1,BLUE:2,ALPHA:3,process:function(h){console.log("Thresholding...");var b=h.canvas;var f=h.channel;var g=b.data;for(var c=0;c<g.length;c+=4){var a=g[c+f];g[c]=g[c+1]=g[c+2]=a}return b}});