var Watcher=function(b,d,a){_.bindAll(this,"fetch","destroy");var c=this;this.model=b;this.callback=d;this.interval=a||1000;this.current=JSON.stringify(this.model);this.watcher=setInterval(this.fetch,this.interval)};Watcher.prototype.fetch=function(){var a=this;this.model.fetch({silent:true,success:function(){var b=JSON.stringify(a.model);if(a.current!==b){a.current=b;a.callback&&a.callback()}},error:function(){}})};Watcher.prototype.destroy=function(){window.clearInterval(this.watcher)};var Status=function(c,a,d,b){_.bindAll(this,"start","error","stop");this.url=c;this.errorcallback=a;this.successcallback=d;this.interval=b||1000;this.start()};Status.prototype.start=function(){var a=this;var c=function(){$.ajax({url:a.url,type:"GET",success:a.successcallback,error:a.error})};if(!this.watcher){var b=this;this.watcher=setInterval(c,this.interval)}};Status.prototype.error=function(){this.stop();this.errorcallback(this)};Status.prototype.stop=function(){if(this.watcher){window.clearInterval(this.watcher);delete this.watcher}};var AnnotationsPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.refreshAnnotationsTabsFunc=[]},render:function(){var a=this;require(["text!application/templates/explorer/AnnotationsPanel.tpl.html"],function(b){a.doLayout(b)});return this},createTabs:function(b){var a=this;require(["text!application/templates/explorer/TermTab.tpl.html","text!application/templates/explorer/TermTabContent.tpl.html"],function(c,d){new TermCollection({idOntology:b}).fetch({success:function(g,e){a.addTermToTab(c,d,{id:"all",image:a.model.id,name:"All"});a.refreshAnnotationsTabsFunc.push({index:0,idTerm:"all",refresh:function(){a.refreshAnnotations(undefined,$("#tabsterm-"+a.model.id+"-all"))}});var f=1;g.each(function(h){a.addTermToTab(c,d,{id:h.get("id"),image:a.model.id,name:h.get("name")});a.refreshAnnotationsTabsFunc.push({index:f,idTerm:h.get("id"),refresh:function(){a.refreshAnnotations(h.get("id"),$("#tabsterm-"+a.model.id+"-"+h.get("id")))}});f++});$("#annotationsPanel"+a.model.id).find(".tabsAnnotation").tabs({add:function(h,i){},select:function(h,i){var j=_.detect(a.refreshAnnotationsTabsFunc,function(k){return(k.index==i.index)});j.refresh.call()}});$("#annotationsPanel"+a.model.id).find(".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *").removeClass("ui-corner-all ui-corner-top").addClass("ui-corner-bottom");a.initAnnotations()}})})},refreshAnnotationTabs:function(b){var a=this;if(b!=undefined){var c=_.detect(a.refreshAnnotationsTabsFunc,function(d){return(d.idTerm==b)});c.refresh.call()}else{a.refreshAnnotationsTabsFunc[0].refresh.call()}},refreshAnnotations:function(a,b){new AnnotationCollection({image:this.model.id,term:a}).fetch({success:function(e,d){b.empty();var c=new AnnotationView({page:undefined,model:e,el:b}).render()}})},addTermToTab:function(a,c,b){$("#annotationsPanel"+this.model.id).find(".ultabsannotation").append(_.template(a,b));$("#annotationsPanel"+this.model.id).find(".listtabannotation").append(_.template(c,b))},initAnnotations:function(){var a=this;new AnnotationCollection({image:a.model.id}).fetch({success:function(c,b){a.refreshAnnotations(undefined,$("#tabsterm-"+a.model.id+"-all"))}})},doLayout:function(b){var a=this;var c=$("#annotationsPanel"+a.model.get("id"));c.html(_.template(b,{id:a.model.get("id")}));new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(e,d){a.createTabs(e.get("ontology"))}});c.css("padding","1px");c.css("margin","0px");c.css("width","20px");c.css("height","20px");c.css("bottom","0px");c.find("div.panel_button").click(function(){c.find("div.panel_button").toggle();c.css("bottom","0px");c.animate({height:"250px"},"fast").animate({width:"100%"});setTimeout(function(){c.find("div.panel_content").fadeIn()},1000);return false});c.find("div#refresh_annotations_button").click(function(){var e=c.find(".tabsAnnotation").tabs("option","selected");var d=_.detect(a.refreshAnnotationsTabsFunc,function(f){return(f.index==e)});d.refresh.call()});c.find("div#hide_button").click(function(){c.animate({height:"20px"},"fast").animate({width:"20px"},"fast");setTimeout(function(){c.find("div.panel_content").hide();c.css("bottom","0px")},1000);return false});c.find("div.previous_button").click(function(){alert("prev"+a.currentAnnotation)});c.find("div.next_button").click(function(){alert("next"+a.currentAnnotation)});return this}});var ApplicationController=Backbone.Controller.extend({models:{},controllers:{},view:null,status:{},routes:{"":"initialRoute",explorer:"explorer",upload:"upload",admin:"admin",warehouse:"warehouse"},startup:function(){var a=this;var b=new LoadingDialogView();a.models.images=new ImageCollection({project:undefined});a.models.imagesinstance=new ImageInstanceCollection({project:undefined});a.models.slides=new SlideCollection({project:undefined});a.models.users=new UserCollection({project:undefined});a.models.terms=new TermCollection({project:undefined});a.models.ontologies=new OntologyCollection();a.models.projects=new ProjectCollection({user:undefined});a.models.annotations=new AnnotationCollection({});var d=[a.models.users];if(_.size(d)==0){a.modelFetched(0,0,b)}else{b.initProgressBar();var c=0;_.each(d,function(e){e.fetch({success:function(g,f){a.modelFetched(++c,_.size(d),b)}})})}},modelFetched:function(e,c,b){var a=100/c;var d=e*a;if(e==c){this.view.render(this.start)}},start:function(){window.app.controllers.image=new ImageController();window.app.controllers.project=new ProjectController();window.app.controllers.dashboard=new DashboardController();window.app.controllers.browse=new ExplorerController();window.app.controllers.ontology=new OntologyController();window.app.controllers.upload=new UploadController();window.app.controllers.command=new CommandController();window.app.controllers.annotation=new AnnotationController();Backbone.history.start()},initialize:function(){var a=this;a.view=new ApplicationView({el:$("#app")});a.controllers.auth=new AuthController();require(["text!application/templates/ServerDownDialog.tpl.html"],function(d){var c=function(f){$("#app").fadeOut("slow");var g=new ConfirmDialogView({el:"#dialogs",template:d,dialogAttr:{dialogID:"#server-down"}}).render()};var e=function(f){a.status.version=f.version;a.status.user={id:f.user,authenticated:f.authenticated};if(f.authenticated){a.startup()}else{a.controllers.auth.login()}};var b="server/ping";$.ajax({url:b,type:"GET",success:e});a.status=new Status(b,c,function(){},10000)})},explorer:function(){this.view.showComponent(this.view.components.explorer)},upload:function(){this.view.showComponent(this.view.components.upload)},admin:function(){this.view.showComponent(this.view.components.admin)},warehouse:function(){this.view.showComponent(this.view.components.warehouse)},initialRoute:function(){this.controllers.project.project()}});var UploadController=Backbone.Controller.extend({initialized:true,routes:{},upload:function(){if(this.initialized){return}this.initialized=true}});var AuthController=Backbone.Controller.extend({routes:{},login:function(){var a=new LoginDialogView({}).render()},logout:function(){var a=new LogoutDialogView({}).render()},doLogin:function(){var b=new ApplicationView();var a=$("#login-form").serialize();$.ajax({url:"j_spring_security_check",type:"post",dataType:"json",data:a,success:function(c){b.message("Welcome","You are logged as "+c.fullname,"");$("#login-confirm").dialog("close");window.app.status.user={authenticated:true,id:c.id};window.app.startup()},error:function(c){var d=$.parseJSON(c.responseText);$("#login-confirm").parent().effect("shake",{times:2},100);b.message("Error",d.message,"error")}});return false}});var ProjectController=Backbone.Controller.extend({routes:{project:"project","project-manage-:idProject":"manage"},initView:function(b){var a=this;window.app.models.ontologies.fetch({success:function(d,c){window.app.models.projects.fetch({success:function(f,e){a.view=new ProjectView({model:f,el:$("#warehouse > .project"),container:window.app.view.components.warehouse}).render();a.view.container.views.project=a.view;if(_.isFunction(b)){b.call()}}})}})},project:function(){var a=this;if(!this.view){this.initView(function(){a.view.container.show(a.view,"#warehouse > .sidebar","project");window.app.view.showComponent(window.app.view.components.warehouse)});return}a.view.container.show(a.view,"#warehouse > .sidebar","project");window.app.view.showComponent(window.app.view.components.warehouse)},manage:function(b){var a=this;if(a.view==null){a.project();return}alert(b)}});var DashboardController=Backbone.Controller.extend({view:null,routes:{"tabs-images-:project":"images","tabs-images-:project/:page":"imagespage","tabs-imagesarray-:project":"imagesarray","tabs-annotations-:project":"annotations","tabs-dashboard-:project":"dashboard"},init:function(a,b){if(window.app.status.currentProject!=undefined&&window.app.status.currentProject!=a){this.destroyView();window.app.controllers.browse.closeAll();window.app.status.currentProject=undefined}if(window.app.status.currentProject==undefined){window.app.status.currentProject=a;window.app.controllers.browse.initTabs();if(this.view==null){this.createView(b)}this.showView()}else{b.call();this.showView()}},images:function(c){var a=this;var b=function(){a.view.refreshImages();a.view.showImages();var d=$("#explorer > .browser").children(".tabs");d.tabs("select","#tabs-images-"+window.app.status.currentProject)};this.init(c,b)},imagespage:function(d,c){var a=this;var b=function(){a.view.changeImagePage(c);a.view.showImages();var e=$("#explorer > .browser").children(".tabs");e.tabs("select","#tabs-images-"+window.app.status.currentProject)};this.init(d,b)},imagesarray:function(c){var a=this;var b=function(){a.view.refreshImagesTabs();a.view.showImagesArray();var d=$("#explorer > .browser").children(".tabs");d.tabs("select","#tabs-images-"+window.app.status.currentProject)};this.init(c,b)},annotations:function(c){var a=this;var b=function(){a.view.refreshSelectedTerms();a.view.selectTab(2);var d=$("#explorer > .browser").children(".tabs");d.tabs("select","#tabs-annotations-"+window.app.status.currentProject)};this.init(c,b)},dashboard:function(c,d){var a=this;var b=function(){a.view.refresh();var e=$("#explorer > .browser").children(".tabs");e.tabs("select","#tabs-dashboard-"+window.app.status.currentProject);if(d!=undefined){d.call()}};this.init(c,b)},createView:function(c){var b=$("#explorer > .browser").children(".tabs");var a=this;new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(e,d){window.app.status.currentProjectModel=e;a.view=new ProjectDashboardView({model:e,el:b,container:window.app.view.components.explorer}).render();c.call()}})},destroyView:function(){this.view=null},showView:function(){$("#explorer > .browser").show();$("#explorer > .noProject").hide();window.app.view.showComponent(window.app.view.components.explorer)}});var ImageController=Backbone.Controller.extend({routes:{image:"image","image/p:page":"image"},image:function(a){if(!this.view){this.view=new ImageView({page:a,model:window.app.models.images,el:$("#warehouse > .image"),container:window.app.view.components.warehouse}).render();this.view.container.views.image=this.view}this.view.container.show(this.view,"#warehouse > .sidebar","image");window.app.view.showComponent(window.app.view.components.warehouse)}});var ExplorerController=Backbone.Controller.extend({tabs:null,routes:{"tabs-image-:idProject-:idImage-:idAnnotation":"browse",close:"close"},initialize:function(){},initTabs:function(){if(this.tabs==null){this.tabs=new ExplorerTabs({el:$("#explorer > .browser"),container:window.app.view.components.explorer}).render()}},browse:function(e,d,a){var c=this;this.initTabs();var b=function(){var f={};if(a!=""){f.goToAnnotation={value:a}}c.tabs.addBrowseImageView(d,f);var g=$("#explorer > .browser").children(".tabs");g.tabs("select","#tabs-image-"+window.app.status.currentProject+"-"+d+"-");window.app.view.showComponent(c.tabs.container);c.showView()};if(window.app.status.currentProject==undefined){window.app.controllers.dashboard.dashboard(e,b);return}b()},closeAll:function(){if(this.tabs==null){return}this.tabs=null;$("#explorer > .browser").empty()},showView:function(){$("#explorer > .browser").show();$("#explorer > .noProject").hide();window.app.view.showComponent(window.app.view.components.explorer)}});var TermController=Backbone.Controller.extend({routes:{term:"term","term/o:ontology":"term"},term:function(a){if(!this.view){this.view=new TermView({model:window.app.models.terms,ontology:a,el:$("#explorer > .term"),container:window.app.view.components.explorer}).render();this.view.container.views.term=this.view}this.view.container.show(this.view)}});var OntologyController=Backbone.Controller.extend({routes:{ontology:"ontology","ontology/:idOntology":"ontology","ontology/:idOntology/:idTerm":"ontology"},ontology:function(){this.ontology(0,0,false)},ontology:function(a){this.ontology(a,0,false)},ontology:function(a,b){this.ontology(a,b,false)},ontology:function(b,c,d){var a=this;if(!a.view){a.view=new OntologyView({model:window.app.models.ontologies,el:$("#warehouse > .ontology"),container:window.app.view.components.warehouse,idOntology:b,idTerm:c}).render();a.view.container.views.ontology=a.view;a.view.container.show(a.view,"#warehouse > .sidebar","ontology");window.app.view.showComponent(window.app.view.components.warehouse);a.view.refresh(b,c)}else{a.view.container.show(a.view,"#warehouse > .sidebar","ontology");window.app.view.showComponent(window.app.view.components.warehouse);if(d){window.app.models.ontologies.fetch({success:function(f,e){a.view.select(b)}})}else{a.view.select(b,c)}}}});var CommandController=Backbone.Controller.extend({undo:function(){var a=this;$.post("command/undo.json",{},function(b){_.each(b,function(c){a.dispatch(c.callback,c.message,"Undo");if(c.printMessage){window.app.view.message("Undo",c.message,"")}})},"json")},redo:function(){var a=this;$.post("command/redo.json",{},function(b){_.each(b,function(c){a.dispatch(c.callback,c.message,"Redo");if(c.printMessage){window.app.view.message("Redo",c.message,"")}})},"json")},dispatch:function(e,c,a){if(!e){return}if(e.method=="be.cytomine.AddAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});var d=b.view;if(d==undefined){return}d.getUserLayer().annotationAdded(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.EditAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});var d=b.view;if(d==undefined){return}d.getUserLayer().annotationUpdated(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.DeleteAnnotationCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});var d=b.view;if(d==undefined){return}d.getUserLayer().annotationRemoved(e.annotationID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.AddAnnotationTermCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});var d=b.view;if(d==undefined){return}d.getUserLayer().termAdded(e.annotationID,e.termID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.DeleteAnnotationTermCommand"){var b=_.detect(window.app.controllers.browse.tabs.tabs,function(f){return f.idImage==e.imageID});var d=b.view;if(d==undefined){return}d.getUserLayer().termRemoved(e.annotationID,e.termID);if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.AddOntologyCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.DeleteOntologyCommand"){window.app.controllers.ontology.view.refresh()}else{if(e.method=="be.cytomine.EditOntologyCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.AddProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.DeleteProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.EditProjectCommand"){window.app.controllers.project.view.refresh()}else{if(e.method=="be.cytomine.AddTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.DeleteTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.EditTermCommand"){window.app.controllers.ontology.view.refresh(e.ontologyID)}else{if(e.method=="be.cytomine.AddImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.DeleteImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}else{if(e.method=="be.cytomine.EditImageInstanceCommand"){if(window.app.controllers.project.view!=null){window.app.controllers.project.view.refresh()}if(window.app.controllers.dashboard.view!=null){window.app.controllers.dashboard.view.refresh()}}}}}}}}}}}}}}}}}}}});var AnnotationController=Backbone.Controller.extend({routes:{annotation:"annotation","annotation/:idAnnotation":"annotation"},annotation:function(a){var b=this;if(!b.view){window.app.models.images.fetch({success:function(d,c){b.view=new AnnotationListView({model:d,el:$("#warehouse > .annotation"),container:window.app.view.components.warehouse,idAnnotation:a}).render();b.view.container.views.annotation=b.view;b.view.container.show(b.view,"#warehouse > .sidebar","annotation");window.app.view.showComponent(window.app.view.components.warehouse)}})}}});var ImageModel=Backbone.Model.extend({url:function(){var a="api/image";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ImageCollection=Backbone.Collection.extend({model:ImageModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/image.json"}else{return"api/currentuser/image.json"}},initialize:function(a){this.project=a.project}});var ImageServerUrlsModel=Backbone.Model.extend({url:function(){return"api/image/"+this.id+"/imageservers.json"}});var ImageInstanceModel=Backbone.Model.extend({url:function(){if(this.project==undefined&&this.baseImage==undefined){var a="api/imageinstance";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}else{return"api/project/"+this.project+"/image/"+this.baseImage+"/imageinstance.json"}},initialize:function(a){this.project=a.project;this.baseImage=a.baseImage}});var ImageInstanceCollection=Backbone.Collection.extend({model:ImageModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/imageinstance.json"}else{return"api/imageinstance.json"}},initialize:function(a){this.project=a.project}});var TermModel=Backbone.Model.extend({url:function(){var a="api/term";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationTermModel=Backbone.Model.extend({url:function(){if(this.term==null){return"api/annotation/"+this.annotation+"/term.json"}else{return"api/annotation/"+this.annotation+"/term/"+this.term+".json"}},initialize:function(a){this.annotation=a.annotation;this.term=a.term}});var AnnotationTermCollection=Backbone.Collection.extend({model:TermModel,url:function(){return"api/annotation/"+this.idAnnotation+"/term.json"},initialize:function(a){this.idAnnotation=a.idAnnotation}});var RelationTermModel=Backbone.Model.extend({url:function(){if(this.term==null){return"api/annotation/"+this.annotation+"/term.json"}else{return"api/annotation/"+this.annotation+"/term/"+this.term+".json"}},initialize:function(a){this.annotation=a.annotation;this.term=a.term}});var RelationTermCollection=Backbone.Collection.extend({model:TermModel,url:function(){return"api/annotation/"+this.idAnnotation+"/term.json"},initialize:function(a){this.idAnnotation=a.idAnnotation}});var TermCollection=Backbone.Collection.extend({model:TermModel,CLASS_NAME:"be.cytomine.ontology.Term",url:function(){if(this.idOntology==undefined&&this.idAnnotation==undefined){return"api/term.json"}else{if(this.idOntology!=undefined&&this.idAnnotation==undefined){return"api/ontology/"+this.idOntology+"/term.json"}else{if(this.idOntology!=undefined&&this.idAnnotation!=undefined){return"api/annotation/"+this.idAnnotation+"/ontology/"+this.idOntology+"/term.json"}}}},initialize:function(a){this.idOntology=a.idOntology;this.idAnnotation=a.idAnnotation}});var OntologyModel=Backbone.Model.extend({url:function(){var a="api/ontology";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var OntologyCollection=Backbone.Collection.extend({model:OntologyModel,CLASS_NAME:"be.cytomine.ontology.Ontology",url:"api/currentuser/ontology.json",initialize:function(){},comparator:function(a){return a.get("name")}});var UserModel=Backbone.Model.extend({url:function(){var a="api/user";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b},prettyName:function(){return this.get("firstname")+" "+this.get("lastname")}});var UserCollection=Backbone.Collection.extend({model:UserModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/user.json"}else{return"api/user.json"}},initialize:function(a){this.project=a.project}});var ProjectModel=Backbone.Model.extend({url:function(){var a="api/project";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ProjectUserModel=Backbone.Model.extend({url:function(){if(this.user==undefined){return"api/project/"+this.project+"/user.json"}else{return"api/project/"+this.project+"/user/"+this.user+".json"}},initialize:function(a){this.project=a.project;this.user=a.user}});var OntologyProjectModel=Backbone.Collection.extend({model:ProjectModel,url:function(){return"api/ontology/"+this.ontology+"/project.json"},initialize:function(a){this.ontology=a.ontology}});var ProjectCollection=Backbone.Collection.extend({model:ProjectModel,url:function(){if(this.user!=undefined){return"api/user/"+this.user+"/project.json"}else{if(this.ontology!=undefined){return"api/ontology/"+this.ontology+"/project.json"}else{return"api/currentuser/project.json"}}},initialize:function(a){this.user=a.user;this.ontology=a.ontology},comparator:function(a){return a.get("name")}});var AnnotationModel=Backbone.Model.extend({url:function(){var a="api/annotation";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationModel=Backbone.Model.extend({url:function(){var a="api/annotation";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var AnnotationCropModel=Backbone.Model.extend({url:null,initialize:function(a){this.url=a.url}});var AnnotationCollection=Backbone.Collection.extend({model:AnnotationModel,url:function(){if(this.user!=undefined){return"api/user/"+this.user+"/imageinstance/"+this.image+"/annotation.json"}else{if(this.term!=undefined&&this.project!=undefined){return"api/term/"+this.term+"/project/"+this.project+"/annotation.json"}else{if(this.project!=undefined){return"api/project/"+this.project+"/annotation.json"}else{if(this.image!=undefined&&this.term!=undefined){return"api/term/"+this.term+"/imageinstance/"+this.image+"/annotation.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/annotation.json"}else{if(this.image!=undefined){return"api/imageinstance/"+this.image+"/annotation.json"}else{return"api/annotation.json"}}}}}}},initialize:function(a){this.image=a.image;this.user=a.user;this.project=a.project;this.term=a.term},comparator:function(a){return -a.get("id")}});AnnotationCollection.comparator=function(a){return a.get("created")};var SlideModel=Backbone.Model.extend({url:function(){var a="api/slide";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var ProjectSlideModel=Backbone.Model.extend({url:function(){if(this.slide==null){return"api/project/"+this.project+"/slide.json"}else{return"api/project/"+this.project+"/slide/"+this.slide+".json"}},initialize:function(a){this.project=a.project;this.slide=a.slide}});var ProjectSlideCollection=Backbone.Collection.extend({model:SlideModel,url:function(){return"api/project/"+this.idProject+"/slide.json"},initialize:function(a){this.idProject=a.idProject}});var SlideCollection=Backbone.Collection.extend({model:SlideModel,CLASS_NAME:"be.cytomine.image.Slide",url:function(){if(this.page==null){return"api/currentuser/slide.json"}else{return"api/currentuser/slide.json?page="+this.page+"&limit="}},initialize:function(a){this.page=a.page;this.limit=a.limit;this.sidx=a.sidx;this.sord=a.sord}});var BeginTransactionModel=Backbone.Model.extend({url:function(){var a="transaction/begin";var b=".json";return a+b}});var EndTransactionModel=Backbone.Model.extend({url:function(){var a="transaction/end";var b=".json";return a+b}});var StatsModel=Backbone.Model.extend({url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/term/stat.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/project/stat.json"}else{return"api/stat.json"}}},initialize:function(a){this.project=a.project;this.term=a.term}});var StatsCollection=Backbone.Collection.extend({model:StatsModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/term/stat.json"}else{if(this.term!=undefined){return"api/term/"+this.term+"/project/stat.json"}else{return"api/stat.json"}}},initialize:function(a){this.project=a.project;this.term=a.term}});var CommandModel=Backbone.Model.extend({url:function(){var a="api/command";var b=".json";if(this.isNew()){return a+b}return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id+b}});var CommandCollection=Backbone.Collection.extend({model:CommandModel,url:function(){if(this.project!=undefined){return"api/project/"+this.project+"/last/"+this.max+".json"}else{return"api/command.json"}},initialize:function(a){this.project=a.project;this.max=a.max}});CommandCollection.comparator=function(a){return a.get("created")};var RelationTermModel=Backbone.Model.extend({url:function(){if(this.term!=undefined){return"api/relation/term/"+this.term+".json"}else{if(this.relation!=undefined&&this.term1!=undefined&&this.term2!=undefined){return"api/relation/"+this.relation+"/term1/"+this.term1+"/term2/"+this.term2+".json"}else{if(this.relation==undefined&&this.term1==undefined&&this.term2==undefined){return"api/relation/parent/term.json"}else{if(this.term1==undefined&&this.term2==undefined){return"api/relation/"+this.relation+"/term.json"}else{return"api/relation/parent/term1/"+this.term1+"/term2/"+this.term2+".json"}}}}},initialize:function(a){this.relation=a.relation;this.term=a.term;this.term1=a.term1;this.term2=a.term2}});var RelationTermCollection=Backbone.Collection.extend({model:RelationTermModel,url:function(){if(this.term!=undefined){return"api/relation/term/"+this.term+".json"}else{return"api/relation/"+this.relation+"/term.json"}},initialize:function(a){this.relation=a.relation;this.term=a.term}});var LoginDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{version:window.app.status.version}),dialogAttr:{dialogID:"#login-confirm",width:350,height:350,buttons:{"Sign in":function(){$("#login-form").submit()}},close:function(c){}}}).render();$("#progress").hide();$("#remember_me").button();$("#j_username").click(function(){$(this).select()});$("#j_password").click(function(){$(this).select()});$("#login-form").submit(window.app.controllers.auth.doLogin);$("#login-form").keydown(function(c){if(c.keyCode==13){$("#login-form").submit();return false}});return this},render:function(){var a=this;require(["text!application/templates/auth/LoginDialog.tpl.html"],function(b){a.doLayout(b)})},close:function(){$("#login-form").close()}});var LoadingDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{}),dialogAttr:{dialogID:"#loading-dialog",width:475,height:375,buttons:{},close:function(c){}}}).render()},render:function(){var a=this;require(["text!application/templates/auth/LoadingDialog.tpl.html"],function(b){a.doLayout(b)});return this},initProgressBar:function(){$("#progress").show();$("#login-progressbar").progressbar({value:0})},progress:function(a){$("#login-progressbar").progressbar({value:a})},close:function(){$("#loading-dialog").dialog("close")}});var LogoutDialogView=Backbone.View.extend({tagName:"div",initialize:function(a){},doLayout:function(a){var b=new ConfirmDialogView({el:"#dialogs",template:_.template(a,{}),dialogAttr:{dialogID:"#logout-confirm",buttons:{Confirm:function(){window.location="logout"},Cancel:function(){$(this).dialog("close")}},close:function(c){$(this).remove()}}}).render();return this},render:function(){var a=this;require(["text!application/templates/auth/LogoutDialog.tpl.html"],function(b){a.doLayout(b)})}});var AnnotationThumbView=Backbone.View.extend({events:{},initialize:function(a){this.id="annotationthumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){var b=this.model.toJSON();b.project=window.app.status.currentProject;var a=this;require(["text!application/templates/dashboard/AnnotationThumb.tpl.html"],function(c){$(a.el).html(_.template(c,b))});return this}});var AnnotationView=Backbone.View.extend({tagName:"div",initialize:function(a){this.container=a.container;this.page=a.page;this.annotations=null;if(this.page==undefined){this.page=0}},render:function(){var a=this;a.appendThumbs(a.page);return this},appendThumbs:function(e){var c=this;var f=0;var a=2500;var d=Math.abs(e)*a;var b=(Math.abs(e)+1)*a;c.annotations=new Array();c.model.each(function(g){if((f>=d)&&(f<b)){var h=new AnnotationThumbView({model:g,className:"thumb-wrap",id:"annotationthumb"+g.get("id")}).render();$(c.el).append(h.el)}f++;c.annotations.push(g.id)})},add:function(a){var c=this;var b=new AnnotationThumbView({model:a,className:"thumb-wrap",id:"thumb"+a.get("id")}).render();$(c.el).prepend(b.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(b){var a=this;var c=a.annotations;b.each(function(d){if(_.indexOf(a.annotations,d.id)==-1){a.add(d);a.annotations.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){a.remove(d);a.annotations=_.without(a.annotations,d)})}});var ProjectDashboardView=Backbone.View.extend({tagName:"div",projectElem:"#projectdashboardinfo",tabsAnnotation:null,images:null,imagesView:null,imagesTabsView:null,imagesThumbOrTab:null,annotationsViews:[],maxCommandsView:10,selectedTermTab:0,rendered:false,projectImages:null,initialize:function(a){this.container=a.container;this.imagesThumbOrTab=a.imagesThumbOrTab;_.bindAll(this,"render")},events:{},render:function(){var a=this;require(["text!application/templates/dashboard/Dashboard.tpl.html"],function(b){a.images=new Array();a.doLayout(b);a.rendered=true});return this},refresh:function(){var a=this;if(!a.rendered){return}var b=new ProjectModel({id:a.model.id});var c=function(e,d){a.model=e;a.fetchProjectInfo();new AnnotationCollection({project:a.model.id}).fetch({success:function(g,f){a.fetchCommands(g)}});a.fetchStats()};b.fetch({success:function(e,d){c(e,d)}})},initTabs:function(){var a=this;$("#projectcolmunChartPanel").panel({collapsible:true});$("#projectPieChartPanel").panel({collapsible:true});$("#projectInfoPanel").panel({collapsible:true});$("#projectLastCommandPanel").panel({collapsible:true});require(["text!application/templates/dashboard/TermTab.tpl.html","text!application/templates/dashboard/TermTabContent.tpl.html"],function(b,c){new OntologyModel({id:a.model.get("ontology")}).fetch({success:function(e,d){$(a.el).find(".tree").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:e.toJSON(),onSelect:function(f,g){if(g.isSelected()){a.refreshAnnotations(g.data.key);$("#tabsterm-panel-"+a.model.id+"-"+g.data.key).show()}else{$("#tabsterm-panel-"+a.model.id+"-"+g.data.key).hide()}},onDblClick:function(g,f){},initId:"treeData-annotations-"+a.model.get("ontology"),cookieId:"dynatree-Cb-annotations-"+a.model.get("ontology"),idPrefix:"dynatree-Cb-annotations-"+a.model.get("ontology")+"-"});$(a.el).find(".tree").dynatree("getRoot").visit(function(f){f.expand(true)});$("#ontology-annotations-panel-"+a.model.id).panel();$(a.el).find("#hideAllAnnotations").button();$(a.el).find("#hideAllAnnotations").click(function(){a.selectAnnotations(false)});$(a.el).find("#showAllAnnotations").button();$(a.el).find("#showAllAnnotations").click(function(){a.selectAnnotations(true)});$(a.el).find("#refreshAnnotations").button();$(a.el).find("#refreshAnnotations").click(function(){a.refreshSelectedTerms()})}});new TermCollection({idOntology:a.model.get("ontology")}).fetch({success:function(e,d){window.app.status.currentTermsCollection=e;e.each(function(f){$("#listtabannotation").prepend(_.template(c,{project:a.model.id,id:f.get("id"),name:f.get("name")}));$("#tabsterm-panel-"+a.model.id+"-"+f.get("id")).panel();$("#tabsterm-panel-"+a.model.id+"-"+f.get("id")).hide()})}})})},addTermToTab:function(a,c,b){$("#listtabannotation").append(_.template(c,b))},selectAnnotations:function(b){var a=this;new TermCollection({idOntology:a.model.get("ontology")}).fetch({success:function(d,c){d.each(function(e){$(a.el).find(".tree").dynatree("getTree").selectKey(e.get("id"),b)})}})},refreshSelectedTerms:function(){var b=this;var a=$(this.el).find(".tree").dynatree("getRoot");a.visit(function(c){if(!c.isSelected()){return}b.refreshAnnotations(c.data.key)})},refreshAnnotations:function(a){this.printAnnotationThumb(a,"#tabsterm-"+this.model.id+"-"+a)},clearAnnotations:function(b){var a=this;$("#tabsterm-"+a.model.id+"-"+b).empty()},printAnnotationThumb:function(d,b){var a=this;var c=0;if(d==0){c=undefined}else{c=d}new AnnotationCollection({project:a.model.id,term:c}).fetch({success:function(f,e){if(a.annotationsViews[c]!=null){a.annotationsViews[c].refresh(f);return}a.annotationsViews[c]=new AnnotationView({page:undefined,model:f,el:$(b),container:window.app.view.components.warehouse}).render();$("#listtabannotation > div").tsort()}})},fetchImages:function(){$("#imageThumbs"+this.model.id).button({text:false,icons:{primary:"ui-icon-image"}});$("#imageArray"+this.model.id).button({text:false,icons:{primary:"ui-icon-calculator"}});var a=this;new ImageInstanceCollection({project:a.model.get("id")}).fetch({success:function(c,b){a.projectImages=c;console.log("self.projectImages="+a.projectImages.length);console.log("ImageInstanceCollection create image thumb view:"+$("#tabs-projectImageThumb"+a.model.get("id")).length);a.imagesView=new ImageView({page:0,model:c,el:$("#tabs-projectImageThumb"+a.model.get("id")),container:window.app.view.components.warehouse}).render();console.log("create image listing view:"+$("#tabs-projectImageListing"+a.model.get("id")).length);a.imagesTabsView=new ImageTabsView({model:c,el:$("#tabs-projectImageListing"+a.model.get("id")),container:window.app.view.components.warehouse,idProject:a.model.id}).render()}})},changeImagePage:function(b){var a=this;console.log("self.projectImages="+a.projectImages.length);a.imagesView=new ImageView({page:b,model:a.projectImages,el:$("#tabs-projectImageThumb"+a.model.get("id")),container:window.app.view.components.warehouse}).render()},refreshImages:function(){var a=this;if(a.imagesView==null){a.fetchImages();return}new ImageInstanceCollection({project:a.model.get("id")}).fetch({success:function(c,b){a.imagesView.refresh(c)}})},refreshImagesTabs:function(){var a=this;if(a.imagesTabsView==null){return}new ImageInstanceCollection({project:a.model.get("id")}).fetch({success:function(c,b){a.imagesTabsView.refresh(c)}})},showImages:function(){$("#tabs-projectImageThumb"+this.model.id).show();$("#tabs-projectImageListing"+this.model.id).hide();$("#imageThumbs"+this.model.id).button("disable");$("#imageArray"+this.model.id).button("enable")},showImagesArray:function(){$("#tabs-projectImageThumb"+this.model.id).hide();$("#tabs-projectImageListing"+this.model.id).show();$("#imageThumbs"+this.model.id).button("enable");$("#imageArray"+this.model.id).button("disable")},drawPieChart:function(e,b){$("#projectPieChart").empty();var d=new google.visualization.DataTable();d.addColumn("string","Term");d.addColumn("number","Number of annotations");d.addRows(_.size(e));var c=0;var a=[];e.each(function(f){a.push(f.get("color"));d.setValue(c,0,f.get("key"));d.setValue(c,1,f.get("value"));c++});new google.visualization.PieChart(document.getElementById("projectPieChart")).draw(d,{width:500,height:350,title:"",colors:a})},drawColumnChart:function(f,c){$("#projectColumnChart").empty();var b=false;var e=new google.visualization.DataTable();e.addRows(_.size(f));e.addColumn("string","Number");e.addColumn("number",0);var a=[];var d=0;f.each(function(g){a.push(g.get("color"));if(g.get("value")>0){b=true}e.setValue(d,0,g.get("key"));e.setValue(d,1,g.get("value"));d++});new google.visualization.ColumnChart(document.getElementById("projectColumnChart")).draw(e,{title:"",width:500,height:350,vAxis:{title:"Number of annotations"},hAxis:{title:"Terms"}});$("#projectColumnChart").show()},fetchStats:function(){var a=this;if(a.model.get("numberOfAnnotations")==0){return}var b=new StatsCollection({project:a.model.get("id")});var c=function(e,d){a.drawPieChart(e,d);a.drawColumnChart(e,d)};b.fetch({success:function(e,d){c(e,d)}})},fetchProjectInfo:function(){var b=this;var c=b.model.toJSON();var a=c.ontology;var d=new Date();d.setTime(c.created);c.created=d.toLocaleDateString()+" "+d.toLocaleTimeString();var e=new Date();e.setTime(c.updated);c.updated=e.toLocaleDateString()+" "+e.toLocaleTimeString();b.resetElem("#projectInfoName",c.name);b.resetElem("#projectInfoOntology",c.ontologyName);b.resetElem("#projectInfoNumberOfSlides",c.numberOfSlides);b.resetElem("#projectInfoNumberOfImages",c.numberOfImages);b.resetElem("#projectInfoNumberOfAnnotations",c.numberOfAnnotations);b.resetElem("#projectInfoCreated",c.created);b.resetElem("#projectInfoUpdated",c.updated);$("#projectInfoUserList").empty();require(["text!application/templates/dashboard/UserInfo.tpl.html"],function(f){var g=[];_.each(b.model.get("users"),function(h){g.push(window.app.models.users.get(h).prettyName())});$("#projectInfoUserList").html(g.join(", "))})},fetchCommands:function(b){var a=this;require(["text!application/templates/dashboard/CommandAnnotation.tpl.html","text!application/templates/dashboard/CommandAnnotationTerm.tpl.html","text!application/templates/dashboard/CommandImageInstance.tpl.html"],function(g,f,c){var d=new CommandCollection({project:a.model.get("id"),max:a.maxCommandsView});var e=function(i,h){$("#lastactionitem").empty();i.each(function(q){var l=q.toJSON();var o=new Date();o.setTime(l.created);var j=o.toLocaleDateString()+" "+o.toLocaleTimeString();var n=$.parseJSON(l.command.data);var p="";if(l.command.CLASSNAME=="be.cytomine.command.annotation.AddAnnotationCommand"){var m="block";var k=n.cropURL;if(b.get(n.id)==undefined){m="none";k=""}var p=_.template(g,{idProject:a.model.id,idAnnotation:n.id,idImage:n.image,imageFilename:n.imageFilename,icon:"add.png",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}if(l.command.CLASSNAME=="be.cytomine.command.annotation.EditAnnotationCommand"){var m="";var k=n.newAnnotation.cropURL;if(b.get(n.newAnnotation.id)==undefined){m="display : none;";k=""}var p=_.template(g,{idProject:a.model.id,idAnnotation:n.newAnnotation.id,idImage:n.newAnnotation.image,imageFilename:n.newAnnotation.imageFilename,icon:"delete.gif",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}if(l.command.CLASSNAME=="be.cytomine.command.annotation.DeleteAnnotationCommand"){var m="";var k=n.cropURL;if(b.get(n.id)==undefined){m="display : none;";k=""}var p=_.template(g,{idProject:a.model.id,idAnnotation:n.id,idImage:n.image,imageFilename:n.imageFilename,icon:"delete.gif",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}if(l.command.CLASSNAME=="be.cytomine.command.annotationterm.AddAnnotationTermCommand"){var p=_.template(f,{icon:"ui-icon-plus",text:l.prefixAction+" "+l.command.action,datestr:j,image:""});$("#lastactionitem").append(p)}if(l.command.CLASSNAME=="be.cytomine.command.annotationterm.EditAnnotationTermCommand"){var p=_.template(f,{icon:"ui-icon-pencil",text:l.prefixAction+" "+l.command.action,datestr:j,image:""});$("#lastactionitem").append(p)}if(l.command.CLASSNAME=="be.cytomine.command.annotationterm.DeleteAnnotationTermCommand"){var p=_.template(f,{icon:"ui-icon-trash",text:l.prefixAction+" "+l.command.action,datestr:j,image:""});$("#lastactionitem").append(p)}if(l.command.CLASSNAME=="be.cytomine.command.imageinstance.AddImageInstanceCommand"){var m="block";var k=n.thumb;var p=_.template(c,{idProject:a.model.id,idImage:n.id,imageFilename:n.filename,icon:"add.png",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}if(l.command.CLASSNAME=="be.cytomine.command.imageinstance.DeleteImageInstanceCommand"){var m="block";var k=n.thumb;var p=_.template(c,{idProject:a.model.id,idImage:n.id,imageFilename:n.filename,icon:"delete.gif",text:l.prefixAction+" "+l.command.action,datestr:j,cropURL:k,cropStyle:m});$("#lastactionitem").append(p)}})};d.fetch({success:function(i,h){e(i,h)}})})},resetElem:function(b,a){$(this.el).find(b).empty();$(this.el).find(b).append(a)},doLayout:function(b){var a=this;var c=_.template(b,a.model.toJSON());$(a.el).append(c);window.app.controllers.browse.tabs.addDashboard(a);a.initTabs()},initWidgets:function(){return;$(".widgets").sortable({connectWith:".widgets"});$(".widgets").disableSelection()}});var AnnotationLayer=function(e,d,c,b,f,a,h){var g=new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults({fillColor:b,fillOpacity:0.5,strokeColor:"black",strokeWidth:2},OpenLayers.Feature.Vector.style["default"]),select:OpenLayers.Util.applyDefaults({fillColor:"#25465D",fillOpacity:0.5,strokeColor:"black",strokeWidth:2},OpenLayers.Feature.Vector.style["default"])});this.ontologyTreeView=f;this.name=e;this.map=h,this.imageID=d;this.userID=c;this.vectorsLayer=new OpenLayers.Layer.Vector(this.name,{styleMap:g,rendererOptions:{zIndexing:true}});this.features=[];this.controls=null;this.dialog=null;this.rotate=false;this.resize=false;this.drag=false;this.irregular=false;this.aspectRatio=false;this.browseImageView=a;this.map=a.map;this.popup=null;this.hoverControl=null;this.isOwner=null;this.deleteOnSelect=false;this.measureOnSelect=false;this.magicOnClick=false};AnnotationLayer.prototype={registerEvents:function(b){var a=this;this.vectorsLayer.events.on({clickFeature:function(c){},onSelect:function(c){},featureselected:function(c){if(!a.measureOnSelect){a.ontologyTreeView.refresh(c.feature.attributes.idAnnotation);if(a.deleteOnSelect==true){a.removeSelection()}else{a.showPopup(b,c)}}else{a.showPopupMeasure(b,c)}},featureunselected:function(c){if(a.measureOnSelect){a.vectorsLayer.removeFeatures(c.feature)}if(a.dialog!=null){a.dialog.destroy()}a.ontologyTreeView.clear();a.ontologyTreeView.clearAnnotation();a.clearPopup(b,c)},featureadded:function(c){if(!a.measureOnSelect){if(c.feature.attributes.listener!="NO"){c.feature.attributes.measure="YES";a.addAnnotation(c.feature)}}else{a.controls.select.unselectAll();a.controls.select.select(c.feature)}},beforefeaturemodified:function(c){},afterfeaturemodified:function(c){a.updateAnnotation(c.feature)},onDelete:function(c){}})},initControls:function(b,a){this.controls={freehand:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Path),point:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Path),polygon:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.Polygon),regular:new OpenLayers.Control.DrawFeature(this.vectorsLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:5}}),modify:new OpenLayers.Control.ModifyFeature(this.vectorsLayer),select:a};this.controls.freehand.freehand=true;b.initTools(this.controls);b.initAutoAnnoteTools()},loadAnnotations:function(a){var b=this;new AnnotationCollection({user:this.userID,image:this.imageID,term:undefined}).fetch({success:function(d,c){d.each(function(e){var f=b.createFeatureFromAnnotation(e);b.addFeature(f)});a.layerLoadedCallback(b)}});a.addVectorLayer(this,this.userID)},addFeature:function(a){this.features[a.attributes.idAnnotation]=a;this.vectorsLayer.addFeatures(a)},selectFeature:function(a){this.controls.select.unselectAll();this.controls.select.select(a)},removeFeature:function(a){var b=this.getFeature(a);if(b!=null&&b.popup){this.map.removePopup(b.popup);b.popup.destroy();b.popup=null;this.popup=null}this.vectorsLayer.removeFeatures(b);this.ontologyTreeView.clearAnnotation();this.ontologyTreeView.clear();this.features[a]=null},getFeature:function(a){return this.features[a]},removeSelection:function(){for(var b in this.vectorsLayer.selectedFeatures){var a=this.vectorsLayer.selectedFeatures[b];this.removeAnnotation(a)}},clearPopup:function(c,a){var b=this;feature=a.feature;if(feature.popup){b.popup.feature=null;c.removePopup(feature.popup);feature.popup.destroy();feature.popup=null;b.popup=null}},showPopup:function(c,a){var b=this;require(["text!application/templates/explorer/PopupAnnotation.tpl.html"],function(d){if(a.feature.popup!=null){return}new AnnotationModel({id:a.feature.attributes.idAnnotation}).fetch({success:function(f,e){var g=f.toJSON();g.username=window.app.models.users.get(g.user).prettyName();var i=new Array();_.each(g.term,function(k){var j=_.template("<a href='#ontology/{{idOntology}}/{{idTerm}}'>{{termName}}</a>",{idOntology:window.app.status.currentProjectModel.get("ontology"),idTerm:k,termName:window.app.status.currentTermsCollection.get(k).get("name")});i.push(j)});g.terms=i.join(", ");var h=_.template(d,g);b.popup=new OpenLayers.Popup("",new OpenLayers.LonLat(a.feature.geometry.getBounds().right+50,a.feature.geometry.getBounds().bottom+50),new OpenLayers.Size(250,100),h,false);b.popup.setBackgroundColor("transparent");b.popup.setBorder(0);b.popup.padding=0;a.feature.popup=b.popup;b.popup.feature=a.feature;c.addPopup(b.popup)}})})},showPopupMeasure:function(c,a){var b=this;require(["text!application/templates/explorer/PopupMeasure.tpl.html"],function(d){if(a.feature.popup!=null){return}var e=_.template(d,{length:a.feature.geometry.getLength()});b.popup=new OpenLayers.Popup("chicken",new OpenLayers.LonLat(a.feature.geometry.getBounds().right+50,a.feature.geometry.getBounds().bottom+50),new OpenLayers.Size(200,60),e,false);b.popup.setBackgroundColor("transparent");b.popup.setBorder(0);b.popup.padding=0;a.feature.popup=b.popup;b.popup.feature=a.feature;c.addPopup(b.popup)})},enableHightlight:function(){},disableHightlight:function(){},initHightlight:function(a){},addAnnotation:function(c){var e=new OpenLayers.Format.WKT();var d=e.write(c);var b=this;var a=new AnnotationModel({name:"",location:d,image:this.imageID,parse:function(f){window.app.view.message("Annotation",f.message,"");return f.annotation}});new BeginTransactionModel({}).save({},{success:function(g,f){a.save(a.toJSON(),{success:function(h,j){var m=j.annotation.id;var l=j.message;var k=b.ontologyTreeView.getTermsChecked();if(k.length==0){b.addTermCallback(0,0,c,m,l,undefined)}var i=0;_.each(k,function(n){new AnnotationTermModel({term:n,annotation:j.annotation.id}).save(null,{success:function(p,o){b.addTermCallback(k.length,++i,c,m,l,n)}})})},error:function(i,h){var j=$.parseJSON(h.responseText);window.app.view.message("Add annotation","error:"+j.errors,"")}})},error:function(g,f){}})},addTermCallback:function(g,a,d,f,e,c){if(a<g){return}var b=this;new AnnotationModel({id:f}).fetch({success:function(h,i){b.vectorsLayer.removeFeatures([d]);var j=b.createFeatureFromAnnotation(h);b.addFeature(j);b.controls.select.unselectAll();b.controls.select.select(j);window.app.view.message("Add annotation",e,"");new EndTransactionModel({}).save();b.browseImageView.refreshAnnotationTabs(c);b.browseImageView.refreshAnnotationTabs(undefined)},error:function(i,h){new EndTransactionModel({}).save()}})},createFeatureFromAnnotation:function(b){var f="#eeeeee";var e=new OpenLayers.Format.WKT();var a=e.read(b.get("location"));var d=a.geometry;var c=new OpenLayers.Feature.Vector(d);c.attributes={idAnnotation:b.get("id"),measure:"NO",listener:"NO",importance:10};if(_.size(b.get("term"))>1){c.style={strokeColor:f,fillColor:f,fillOpacity:0.6}}else{_.each(b.get("term"),function(g){c.style={strokeColor:window.app.status.currentTermsCollection.get(g).get("color"),fillColor:window.app.status.currentTermsCollection.get(g).get("color"),fillOpacity:0.6}})}return c},removeAnnotation:function(c){var d=this.ontologyTreeView.getTermsChecked();var a=c.attributes.idAnnotation;this.removeFeature(c);this.controls.select.unselectAll();this.vectorsLayer.removeFeatures([c]);var b=this;new AnnotationTermCollection({idAnnotation:a}).fetch({success:function(f,e){new AnnotationModel({id:c.attributes.idAnnotation}).destroy({success:function(h,g){window.app.view.message("Annotation",g.message,"");b.browseImageView.refreshAnnotationTabs(undefined);console.log("collection="+f.length);f.each(function(i){console.log("term="+i.id);b.browseImageView.refreshAnnotationTabs(i.id)})},error:function(h,g){var i=$.parseJSON(g.responseText);window.app.view.message("Annotation",i.errors,"")}})}})},updateAnnotation:function(a){var c=new OpenLayers.Format.WKT();var b=c.write(a);new AnnotationModel({id:a.attributes.idAnnotation}).fetch({success:function(e,d){e.set({location:b});e.save()}})},toggleRotate:function(){this.resize=false;this.drag=false;this.rotate=true;this.updateControls();this.toggleControl("modify")},toggleResize:function(){this.resize=true;this.drag=false;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleDrag:function(){this.resize=false;this.drag=true;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleEdit:function(){this.resize=false;this.drag=false;this.rotate=false;this.updateControls();this.toggleControl("modify")},toggleIrregular:function(){this.irregular=!this.irregular;this.updateControls()},toggleAspectRatio:function(){this.aspectRatio=!this.aspectRatio;this.updateControls()},setSides:function(a){this.sides=a;this.updateControls()},updateControls:function(){this.controls.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE;if(this.rotate){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.ROTATE}if(this.resize){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.RESIZE;if(this.aspectRatio){this.controls.modify.mode&=~OpenLayers.Control.ModifyFeature.RESHAPE}}if(this.drag){this.controls.modify.mode|=OpenLayers.Control.ModifyFeature.DRAG}if(this.rotate||this.drag){this.controls.modify.mode&=~OpenLayers.Control.ModifyFeature.RESHAPE}this.controls.regular.handler.sides=this.sides;this.controls.regular.handler.irregular=this.irregular},disableMeasureOnSelect:function(){var a=this;this.measureOnSelect=false;for(var c in this.vectorsLayer.features){var b=this.vectorsLayer.features[c];if(b.attributes.measure==undefined||b.attributes.measure=="YES"){a.vectorsLayer.removeFeatures(b);if(b.popup){a.popup.feature=null;a.map.removePopup(b.popup);b.popup.destroy();b.popup=null;a.popup=null}}}},toggleControl:function(a){this.deleteOnSelect=false;this.disableMeasureOnSelect();this.magicOnClick=false;for(key in this.controls){var d=this.controls[key];if(a==key){d.activate();if(d==this.controls.modify){for(var c in this.vectorsLayer.selectedFeatures){var b=this.vectorsLayer.selectedFeatures[c];d.selectFeature(b)}}}else{d.deactivate();if(d==this.controls.modify){for(var c in this.vectorsLayer.selectedFeatures){var b=this.vectorsLayer.selectedFeatures[c];d.unselectFeature(b)}}}}},annotationAdded:function(b){var c=this;var d=c.deleteOnSelect;c.deleteOnSelect=false;var a=new AnnotationModel({id:b}).fetch({success:function(f){var h=new OpenLayers.Format.WKT();var e=h.read(f.get("location"));var g=new OpenLayers.Feature.Vector(e.geometry);g.attributes={idAnnotation:f.get("id"),listener:"NO",measure:"NO",importance:10};c.addFeature(g);c.selectFeature(g);c.controls.select.activate();c.deleteOnSelect=d}})},annotationRemoved:function(a){this.removeFeature(a)},annotationUpdated:function(a,b){this.annotationRemoved(a);this.annotationAdded(a)},termAdded:function(a,c){var b=this;this.ontologyTreeView.check(c)},termRemoved:function(a,b){this.ontologyTreeView.uncheck(b)}};var BrowseImageView=Backbone.View.extend({tagName:"div",initialize:function(a){this.initCallback=a.initCallback;this.layers=[];this.layersLoaded=0;this.baseLayers=[];this.annotationsPanel=null;this.map=null;this.currentAnnotation=null;_.bindAll(this,"initVectorLayers")},doLayout:function(b){var a=this;var d=this.model.toJSON();d.project=window.app.status.currentProject;var b=_.template(b,d);$(this.el).append(b);var c=$(this.el).children(".tabs");this.el.tabs("add","#tabs-image-"+window.app.status.currentProject+"-"+this.model.get("id")+"-",this.model.get("filename"));this.el.css("display","block");this.initToolbar();this.initMap();this.initOntology();this.initAnnotationsTabs();return this},render:function(){var a=this;require(["lib/openlayers/OpenLayers.js","text!application/templates/explorer/BrowseImage.tpl.html"],function(c,b){a.doLayout(b)});return this},show:function(b){var a=this;if(b.goToAnnotation!=undefined){_.each(this.layers,function(c){a.goToAnnotation(c,b.goToAnnotation.value)})}},refreshAnnotationTabs:function(a){this.annotationsPanel.refreshAnnotationTabs(a)},goToAnnotation:function(f,h){var k=this;var l=f.getFeature(h);if(l!=undefined){var b=l.geometry.bounds;var g=b.right-b.left;var i=b.top-b.bottom;var c=$(window).width();var a=$(window).height();var j=this.map.getNumZoomLevels()-1;var e=g;var d=i;while((e>c)||(d>a)){e/=2;d/=2;j--}f.controls.select.unselectAll();f.controls.select.select(l);k.currentAnnotation=h;this.map.moveTo(new OpenLayers.LonLat(l.geometry.getCentroid().x,l.geometry.getCentroid().y),Math.max(0,j))}},getFeature:function(a){return this.userLayer.getFeature(a)},removeFeature:function(a){return this.userLayer.removeFeature(a)},layerLoadedCallback:function(d){var b=this;this.layersLoaded++;var e=window.app.status.currentProjectModel;if(this.layersLoaded==e.get("users").length){$("#layerSwitcher"+this.model.get("id")).find("select").multiselect({click:function(f,g){_.each(b.layers,function(h){if(h.name!=g.value){return}h.vectorsLayer.setVisibility(g.checked)})},checkAll:function(){_.each(b.layers,function(f){f.vectorsLayer.setVisibility(true)})},uncheckAll:function(){_.each(b.layers,function(f){f.vectorsLayer.setVisibility(false)})}});var a=_.map(this.layers,function(f){return f.vectorsLayer});var c=new OpenLayers.Control.SelectFeature(a);_.each(this.layers,function(f){f.initControls(b,c);f.registerEvents(b.map);if(f.isOwner){b.userLayer=f;f.vectorsLayer.setVisibility(true);f.toggleIrregular();var g=$("#toolbar"+b.model.get("id"));g.find("input[id=none"+b.model.get("id")+"]").click()}else{f.controls.select.activate();f.vectorsLayer.setVisibility(false)}});if(_.isFunction(b.initCallback)){b.initCallback.call()}}},getUserLayer:function(){return this.userLayer},initMap:function(){var a=this;var b=this.model.get("mime");if(b=="vms"||b=="mrxs"||b=="tif"||b=="tiff"){a.initIIP()}},addBaseLayer:function(d){var b=this;this.map.addLayer(d);this.baseLayers.push(d);b.map.setBaseLayer(d);var e="layerSwitch-"+this.model.get("id");var a="layerSwitch-"+this.model.get("id")+"-"+new Date().getTime();var c=_.template("<li><input type='radio' id='{{id}}' name='{{radioName}}' checked/><label style='font-weight:normal;color:#FFF' for='{{id}}'> {{name}}</label></li>",{id:a,radioName:e,name:d.name.substr(0,15)});$("#layerSwitcher"+this.model.get("id")).find(".baseLayers").append(c);$("#layerSwitcher"+this.model.get("id")).find(".baseLayers").find("#"+a);$("#layerSwitcher"+this.model.get("id")).find(".baseLayers").find("#"+a).click(function(){b.map.setBaseLayer(d)})},addVectorLayer:function(e,d){this.map.addLayer(e.vectorsLayer);this.layers.push(e);var a=window.app.models.users.get(d).prettyName();var c=window.app.models.users.get(d).get("color");var b;if(e.isOwner){b=_.template("<option value='{{id}}' selected='selected'>{{name}}</option>",{id:a,name:e.vectorsLayer.name,color:c})}else{b=_.template("<option value='{{id}}'>{{name}}</option>",{id:a,name:e.vectorsLayer.name,color:c})}$("#layerSwitcher"+this.model.get("id")).find(".annotationLayers").append(b)},createLayerSwitcher:function(){new LayerSwitcherPanel({browseImageView:this,model:this.model,el:this.el}).render()},createOverviewMap:function(){new OverviewMapPanel({model:this.model,el:this.el}).render()},initIIP:function(){var a=this;var f=function(l,m){_.each(m,function(r){console.log("URL > "+r)});var n=new OpenLayers.Layer.Zoomify("Original",m,new OpenLayers.Size(l.width,l.height));var k=_.map(m,function(r){return"http://localhost:8080/cytomine-web/proxy/otsu?url="+r});var g=new OpenLayers.Layer.Zoomify("Otsu",k,new OpenLayers.Size(l.width,l.height));var h=a.createLayerSwitcher();var q={maxExtent:new OpenLayers.Bounds(0,0,l.width,l.height),maxResolution:Math.pow(2,l.nbZoom),numZoomLevels:l.nbZoom+1,units:"pixels",controls:[new OpenLayers.Control.TouchNavigation({dragPanOptions:{enableKinetic:true}}),new OpenLayers.Control.Navigation(),new OpenLayers.Control.PanZoomBar(),new OpenLayers.Control.MousePosition(),new OpenLayers.Control.KeyboardDefaults()]};var j=new OpenLayers.Layer.Image("Overview"+a.model.get("id"),a.model.get("thumb"),new OpenLayers.Bounds(0,0,l.width,l.height),new OpenLayers.Size(l.overviewWidth,l.overviewHeight));var i=new OpenLayers.Control.OverviewMap({size:new OpenLayers.Size(l.overviewWidth,l.overviewHeight),layers:[j],div:document.getElementById("overviewMap"+a.model.get("id")),minRatio:1,maxRatio:1024,mapOptions:{maxExtent:new OpenLayers.Bounds(0,0,l.width,l.height),maximized:true}});a.map=new OpenLayers.Map("map"+a.model.get("id"),q);var p=81;var o=$(window).height()-p;$("#map"+a.model.get("id")).css("height",o);$(window).resize(function(){var r=$(window).height()-p;$("#map"+a.model.get("id")).css("height",r)});a.addBaseLayer(g);a.addBaseLayer(n);a.createOverviewMap();a.map.zoomToMaxExtent();a.map.addControl(i)};var d=a.model.get("width");var c=a.model.get("height");var e=0;while(d>=256||c>=256){e++;d=d/2;c=c/2}var b={width:a.model.get("width"),height:a.model.get("height"),nbZoom:e,overviewWidth:200,overviewHeight:Math.round((200/a.model.get("width")*a.model.get("height")))};new ImageServerUrlsModel({id:a.model.get("baseImage")}).fetch({success:function(h,g){f(b,h.get("imageServersURLs"))}})},reloadAnnotation:function(a){var b=this;b.removeFeature(a);new AnnotationModel({id:a}).fetch({success:function(c,d){var e=b.userLayer.createFeatureFromAnnotation(c);b.userLayer.addFeature(e);b.userLayer.selectFeature(e)}})},initAutoAnnoteTools:function(){var a=this;var b=function b(d){if(!a.getUserLayer().magicOnClick){return}var f=18;var c=a.map.getLonLatFromViewPortPx(new OpenLayers.Pixel(d.xy.x-f,d.xy.y+f));var g=a.map.getLonLatFromViewPortPx(new OpenLayers.Pixel(d.xy.x+f,d.xy.y-f));var e=c.lon+","+c.lat+","+g.lon+","+g.lat;alert(e)};this.map.events.register("click",this.map,b)},initToolbar:function(){var b=$("#toolbar"+this.model.get("id"));var a=this;b.find("input[name=select]").button({});b.find("button[name=delete]").button({text:false,icons:{primary:"ui-icon-trash"}});b.find("button[name=ruler]").button({text:false,icons:{secondary:"ui-icon-arrow-2-ne-sw"}});b.find("input[id^=ruler]").button({text:true,icons:{secondary:"ui-icon-arrow-2-ne-sw"}});b.find("input[name=rotate]").button();b.find("input[name=resize]").button();b.find("input[name=drag]").button();b.find("input[name=irregular]").button();b.find("span[class=nav-toolbar]").buttonset();b.find("span[class=draw-toolbar]").buttonset();b.find("span[class=edit-toolbar]").buttonset();b.find("span[class=delete-toolbar]").buttonset();b.find("span[class=ruler-toolbar]").buttonset();b.find("input[id=none"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("none");a.getUserLayer().enableHightlight()});b.find("input[id=select"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleControl("select");a.getUserLayer().disableHightlight()});b.find("input[id=regular4"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(4);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("input[id=regular30"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().setSides(15);a.getUserLayer().toggleControl("regular");a.getUserLayer().disableHightlight()});b.find("input[id=polygon"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("polygon");a.getUserLayer().disableHightlight()});b.find("input[id=magic"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("select");a.getUserLayer().magicOnClick=true;a.getUserLayer().disableHightlight()});b.find("input[id=modify"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleEdit();a.getUserLayer().toggleControl("modify");a.getUserLayer().disableHightlight()});b.find("input[id=delete"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("select");a.getUserLayer().deleteOnSelect=true;a.getUserLayer().disableHightlight()});b.find("input[id=rotate"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleRotate();a.getUserLayer().disableHightlight()});b.find("input[id=resize"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleResize();a.getUserLayer().disableHightlight()});b.find("input[id=drag"+this.model.get("id")+"]").click(function(){a.getUserLayer().toggleDrag();a.getUserLayer().disableHightlight()});b.find("input[id=ruler"+this.model.get("id")+"]").click(function(){a.getUserLayer().controls.select.unselectAll();a.getUserLayer().toggleControl("line");a.getUserLayer().measureOnSelect=true;a.getUserLayer().disableHightlight()})},initVectorLayers:function(c){var b=this;var d=window.app.status.currentProjectModel;var a=window.app.models.users.select(function(e){return _.include(d.get("users"),e.id)});_.each(a,function(e){var f=new AnnotationLayer(e.prettyName(),b.model.get("id"),e.get("id"),e.get("color"),c,b,b.map);f.isOwner=(e.get("id")==window.app.status.user.id);f.loadAnnotations(b)})},initAnnotationsTabs:function(){this.annotationsPanel=new AnnotationsPanel({el:this.el,model:this.model}).render()},initOntology:function(){var a=this;new OntologyPanel({el:this.el,model:this.model,callback:a.initVectorLayers,browseImageView:a}).render()},initTools:function(a){for(var b in a){this.map.addControl(a[b])}}});var DraggablePanelView=Backbone.View.extend({tagName:"div",initialize:function(a){this.el=a.el;this.template=a.template},render:function(){var b=this;$(this.el).html(this.template);var c=$(this.el).width();var a=$(this.el).height();$(this.el).draggable({cancel:".slider",start:function(d,e){c=$(b.el).width();a=$(b.el).height()},drag:function(d,e){$(this).css("width",c);$(this).css("height",a)}});return this}});var ExplorerTabs=Backbone.View.extend({tagName:"div",initialize:function(a){this.tabs=[],this.container=a.container},render:function(){var a=this;require(["text!application/templates/explorer/Tabs.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{}));var c=$(this.el).children(".tabs");c.tabs({add:function(d,e){if(e.panel.id!=("tabs-dashboard-"+window.app.status.currentProject)&&(e.panel.id!="tabs-images-"+window.app.status.currentProject)&&e.panel.id!=("tabs-annotations-"+window.app.status.currentProject)){c.find("ul").find("a[href=#"+e.panel.id+"]").find("span").attr("style","display:inline;");c.find("ul").find("a[href=#"+e.panel.id+"]").parent().append("<span class='ui-icon ui-icon-close' style='display:inline;'>&nbsp;&nbsp;&nbsp;&nbsp;</span>");c.find("ul").find("a[href=#"+e.panel.id+"]").parent().find("span.ui-icon-close").click(function(){var f=$("li",c).index($(this).parent());a.removeTab(f)});c.tabs("select","#"+e.panel.id)}},show:function(d,e){return true},select:function(d,e){document.location=$(document).attr("location").pathname+"#"+e.panel.id}});$("ul.tabs a").css("height",$("ul.tabs").height());return this},addBrowseImageView:function(c,b){var a=this;var e=this.getBrowseImageView(c);if(e!=null){e.view.show(b);return}var d=$(a.el).children(".tabs");new ImageInstanceModel({id:c}).fetch({success:function(h,g){var f=new BrowseImageView({model:h,initCallback:function(){f.show(b)},el:d}).render();a.tabs.push({idImage:c,view:f})}})},getBrowseImageView:function(b){var a=_.detect(this.tabs,function(c){return c.idImage==b});return a!=null?a:null},removeTab:function(a){this.tabs.splice(a,1);var b=$(this.el).children(".tabs");b.tabs("remove",a)},showTab:function(a){var b=$("#explorer > .browser").children(".tabs");b.tabs("select","#tabs-image-"+window.app.status.currentProject+"-"+a+"-");return},size:function(){return _.size(this.tabs)},closeAll:function(){var b=$(this.el).children(".tabs");for(var a=b.tabs("length")-1;a>=0;a--){b.tabs("remove",a)}this.tabs=[];b.tabs("destroy");$(this.el).hide();$(this.el).parent().find(".noProject").show()},addDashboard:function(a){var b=$(this.el).children(".tabs");b.tabs("add","#tabs-dashboard-"+window.app.status.currentProject,"Dashboard");b.tabs("add","#tabs-images-"+window.app.status.currentProject,"Images");b.tabs("add","#tabs-annotations-"+window.app.status.currentProject,"Annotations");$("#explorer > .browser").show();$("#explorer > .noProject").hide();this.tabs.push({idImage:0,view:a});this.tabs.push({idImage:1,view:a});this.tabs.push({idImage:2,view:a})},getDashboard:function(){var a=_.detect(this.tabs,function(b){return b.idImage==0});return a}});var LayerSwitcherPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.browseImageView=a.browseImageView},render:function(){var a=this;require(["text!application/templates/explorer/LayerSwitcher.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=_.template(b,{id:a.model.get("id")});$("#layerSwitcher"+a.model.get("id")).html(c);new DraggablePanelView({el:$("#layerSwitcher"+a.model.get("id"))}).render()}});var OverviewMapPanel=Backbone.View.extend({tagName:"div",initialize:function(a){},render:function(){var a=this;require(["text!application/templates/explorer/OverviewMap.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;new DraggablePanelView({el:$("#overviewMap"+a.model.get("id")),template:_.template(b,{id:a.model.get("id")})}).render()}});var OntologyPanel=Backbone.View.extend({tagName:"div",initialize:function(a){this.ontologyTreeView=null;this.callback=a.callback;this.browseImageView=a.browseImageView},render:function(){var a=this;var b=new ProjectModel({id:window.app.status.currentProject}).fetch({success:function(e,d){var c=e.get("ontology");var f=new OntologyModel({id:c}).fetch({success:function(h,g){a.ontologyTreeView=new OntologyTreeView({el:$("#ontologyTree"+a.model.get("id")),browseImageView:a.browseImageView,model:h}).render();a.callback(a.ontologyTreeView)}});require(["text!application/templates/explorer/OntologyTree.tpl.html"],function(g){a.doLayout(g)})}});return this},doLayout:function(a){new DraggablePanelView({el:$("#ontologyTree"+this.model.get("id")),template:_.template(a,{id:this.model.get("id")})}).render()}});var ImageThumbView=Backbone.View.extend({events:{},initialize:function(a){this.id="thumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){this.model.set({project:window.app.status.currentProject});var a=this;require(["text!application/templates/image/ImageThumb.tpl.html"],function(b){$(a.el).html(_.template(b,a.model.toJSON()))});return this}});var ImageSelectView=Backbone.View.extend({events:{},initialize:function(a){this.id="thumb"+this.model.get("id");_.bindAll(this,"render")},render:function(){var a=this;this.model.set({project:window.app.status.currentProject});var a=this;require(["text!application/templates/image/ImageChoice.tpl.html"],function(b){$(a.el).html(_.template(b,a.model.toJSON()))});return this}});var ImageView=Backbone.View.extend({tagName:"div",initialize:function(a){this.images=null,this.container=a.container;this.page=a.page;if(this.page==undefined){this.page=0}},render:function(){var a=this;$(a.el).html("");a.appendThumbs(a.page);$(window).scroll(function(){if(($(window).scrollTop()+100)>=$(document).height()-$(window).height()){a.appendThumbs(++a.page)}});return this},appendThumbs:function(e){var c=this;var f=0;var a=50;var d=Math.abs(e)*a;var b=(Math.abs(e)+1)*a;c.tabsContent=new Array();c.model.each(function(h){if((f>=d)&&(f<b)){console.log(f);var g=new ImageThumbView({model:h,className:"thumb-wrap",id:"thumb"+h.get("id")}).render();$(c.el).append(g.el)}f++;c.tabsContent.push(h.id)})},add:function(c){s;var b=this;var a=new ImageThumbView({model:c,className:"thumb-wrap",id:"thumb"+c.get("id")}).render();$(b.el).append(a.el)},remove:function(a){$("#thumb"+a).remove()},refresh:function(a){var b=this;var c=b.tabsContent;a.each(function(d){if(_.indexOf(b.tabsContent,d.id)==-1){b.add(d);b.tabsContent.push(d.id)}c=_.without(c,d.id)});c.forEach(function(d){b.remove(d);b.tabsContent=_.without(b.tabsContent,d)})}});var ImageTabsView=Backbone.View.extend({tagName:"div",images:null,idProject:null,imagesProject:null,searchPanel:null,initialize:function(b){var a=this;this.idProject=b.idProject;this.container=b.container;this.imagesProject=b.model;this.listproject="listimage"+this.idProject;this.pageproject="pagerimage"+this.idProject;this.tab=2;this.timeoutHnd=null},render:function(){var a=this;console.log("ImageTabsView.render");$(a.el).append('<table id="listimage'+a.idProject+'" align="center"></table><div id="pagerimage'+this.idProject+'"></div>');a.renderImageListProject();a.loadDataImageListProject(a.model)},refresh:function(){console.log("ImageTabsView.refresh");this.refreshImageList()},refreshImageList:function(){console.log("ImageTabsView.refreshImageList");var a=this;$("#"+a.listproject).jqGrid("clearGridData",true);a.imagesProject.fetch({success:function(c,b){a.loadDataImageListProject(c)}})},loadDataImageListProject:function(e){console.log("ImageTabsView.loadDataImageListProject");var a=this;var d=new Array();var c=0;e.each(function(g){var f='<a href="#tabs-image-'+a.idProject+"-"+g.id+'-">Click here to see the image</a>';d[c]={id:g.id,base:g.get("baseImage"),thumb:g.get("thumb"),filename:g.get("filename"),type:g.get("mime"),annotations:g.get("numberOfAnnotations"),added:g.get("created"),See:f};c++});for(var b=0;b<d.length;b++){$("#"+a.listproject).jqGrid("addRowData",d[b].id,d[b])}$("#"+a.listproject).jqGrid("sortGrid","filename",false)},renderImageListProject:function(){var a=this;console.log("ImageTabsView.renderImageListProject:#"+a.listproject+":"+$("#"+a.listproject).length);var b="thumb";$("#"+a.listproject).jqGrid({datatype:"local",width:900,height:500,colNames:["id","base","thumb","filename","type","annotations","added","see"],colModel:[{name:"id",index:"id",width:50,sorttype:"int"},{name:"base",index:"base",width:50,sorttype:"int"},{name:b,index:b,width:50},{name:"filename",index:"filename",width:220},{name:"type",index:"type",width:50},{name:"annotations",index:"annotations",width:75},{name:"added",index:"added",width:90,sorttype:"date",formatter:a.dateFormatter},{name:"See",index:"See",width:200,sortable:false}],onSelectRow:function(d){var c=$("#"+a.listproject).find("#"+d).find(".cbox").attr("checked");if(c){$("#"+a.listproject).find("#"+d).find("td").css("background-color","CD661D")}else{$("#"+a.listproject).find("#"+d).find("td").css("background-color","a0dc4f")}},loadComplete:function(){$("#"+a.listproject).find("tr").each(function(c){if(c!=0){var d=$(this).find('[aria-describedby$="_'+b+'"]');$(d).html('<img src="'+$(d).text()+'" width=30/>')}})},pager:"#"+a.pageproject,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Images from project"});$("#"+a.listproject).jqGrid("navGrid","#"+a.listproject,{edit:false,add:false,del:false});$("#"+a.listproject).jqGrid("hideCol","id");$("#"+a.listproject).jqGrid("hideCol","base")},dateFormatter:function(b,c,d){var a=new Date();a.setTime(b);return a.getFullYear()+"-"+a.getMonth()+"-"+a.getDate()}});var OntologyPanelView=Backbone.View.extend({$tree:null,$infoOntology:null,$infoTerm:null,$panel:null,$addTerm:null,$editTerm:null,$deleteTerm:null,$buttonAddTerm:null,$buttonEditTerm:null,$buttonDeleteTerm:null,$buttonEditOntology:null,$buttonDeleteOntology:null,ontologiesPanel:null,expanse:false,events:{"click .addTerm":"addTerm","click .editTerm":"editTerm","click .deleteTerm":"deleteTerm","click .editOntology":"editOntology","click .deleteOntology":"deleteOntology"},initialize:function(a){this.container=a.container;this.ontologiesPanel=a.ontologiesPanel},render:function(){var a=this;a.$panel=$(a.el);a.$tree=a.$panel.find("#treeontology-"+a.model.id);a.$infoOntology=a.$panel.find("#infoontology-"+a.model.id);a.$infoTerm=a.$panel.find("#infoterm-"+a.model.id);a.$addTerm=a.$panel.find("#dialog-add-ontology-term");a.$editTerm=a.$panel.find("#dialog-edit-ontology-term");a.$deleteTerm=a.$panel.find("#dialogsTerm");a.$buttonAddTerm=a.$panel.find($("#buttonAddTerm"+a.model.id));a.$buttonEditTerm=a.$panel.find($("#buttonEditTerm"+a.model.id));a.$buttonDeleteTerm=a.$panel.find($("#buttonDeleteTerm"+a.model.id));a.$buttonEditOntology=a.$panel.find($("#buttonEditOntology"+a.model.id));a.$buttonDeleteOntology=a.$panel.find($("#buttonDeleteOntology"+a.model.id));a.buildOntologyTree();a.buildButton();a.buildInfoOntologyPanel();a.buildInfoTermPanel();return this},refresh:function(){var a=this;a.model.fetch({success:function(c,b){window.app.models.terms.fetch({success:function(e,d){$("#ontologyTitle"+a.model.id).empty();$("#ontologyTitle"+a.model.id).append(a.model.get("name"));a.clear();a.render()}})}})},clear:function(){var a=this;a.$panel.empty();require(["text!application/templates/ontology/OntologyTabContent.tpl.html"],function(b){a.$panel.html(_.template(b,{id:a.model.get("id"),name:a.model.get("name")}));return this});return this},getCurrentTermId:function(){var a=this.$tree.dynatree("getActiveNode");if(a==null){return null}else{return a.data.id}},addTerm:function(){var a=this;a.$addTerm.remove();new OntologyAddOrEditTermView({ontologyPanel:a,el:a.el,ontology:a.model,model:null}).render()},editTerm:function(){var a=this;a.$editTerm.remove();var b=a.$tree.dynatree("getActiveNode");if(b==null){window.app.view.message("Term","You must select a term!","");return}new TermModel({id:b.data.id}).fetch({success:function(d,c){new OntologyAddOrEditTermView({ontologyPanel:a,el:a.el,model:d,ontology:a.model}).render()}});return false},deleteTerm:function(){var a=this;var b=a.getCurrentTermId();var c=window.app.models.terms.get(b);new AnnotationCollection({term:b}).fetch({success:function(e,d){if(e.length==0){a.buildDeleteTermConfirmDialog(c)}else{a.buildDeleteTermWithAnnotationConfirmDialog(c,e.length)}}})},editOntology:function(){var a=this;$("#editontology").remove();a.editOntologyDialog=new EditOntologyDialog({ontologyPanel:a,el:a.el,model:a.model}).render()},deleteOntology:function(){var a=this;new ProjectCollection({ontology:a.model.id}).fetch({success:function(c,b){if(c.length>0){a.refuseDeleteOntology(c.length)}else{a.acceptDeleteOntology()}}})},refuseDeleteOntology:function(b){var a=this;$("#delete-ontology-refuse").replaceWith("");require(["text!application/templates/ontology/OntologyDeleteRefuseDialog.tpl.html"],function(c){var d=new ConfirmDialogView({el:"#dialogsDeleteOntologyRefuse",template:_.template(c,{name:a.model.get("name"),numberOfProject:b}),dialogAttr:{dialogID:"#dialogsDeleteOntologyRefuse",width:400,height:200,buttons:{close:function(){$("#dialogsDeleteOntologyRefuse").dialog("close")}},close:function(e){}}}).render()})},acceptDeleteOntology:function(){var a=this;$("#delete-ontology-confirm").replaceWith("");require(["text!application/templates/ontology/OntologyDeleteConfirmDialog.tpl.html"],function(b){new ConfirmDialogView({el:"#dialogsDeleteOntologyAccept",template:_.template(b,{ontology:a.model.get("name")}),dialogAttr:{dialogID:"#dialogsDeleteOntologyAccept",width:400,height:300,buttons:{"Delete ontology and all terms":function(){var c=this;a.model.destroy({success:function(e,d){$(c).dialog("close");$(c).dialog("destroy");a.ontologiesPanel.refresh()},error:function(e,d){var f=$.parseJSON(d.responseText)}})},cancel:function(){var c=this;$(c).dialog("close");$(c).dialog("destroy")}},close:function(c){}}}).render()})},selectTerm:function(b){var a=this;a.$tree.dynatree("getTree").activateKey(b)},buildDeleteTermConfirmDialog:function(b){var a=this;require(["text!application/templates/ontology/OntologyDeleteTermConfirmDialog.tpl.html"],function(c){var d=new ConfirmDialogView({el:"#dialogsTerm",template:_.template(c,{term:b.get("name"),ontology:a.model.get("name")}),dialogAttr:{dialogID:"#dialogsTerm",width:400,height:300,buttons:{"Delete term":function(){new BeginTransactionModel({}).save({},{success:function(f,e){a.deleteTermWithoutAnnotationTerm(b)},error:function(f,e){window.app.view.message("ERROR","error transaction begin","error")}})},Cancel:function(){$("#dialogsTerm").dialog("close")}},close:function(e){}}}).render()})},buildDeleteTermWithAnnotationConfirmDialog:function(b,c){var a=this;require(["text!application/templates/ontology/OntologyDeleteTermWithAnnotationConfirmDialog.tpl.html"],function(d){var e=new ConfirmDialogView({el:"#dialogsTerm",template:_.template(d,{term:b.get("name"),ontology:a.model.get("name"),numberOfAnnotation:c}),dialogAttr:{dialogID:"#dialogsTerm",width:400,height:300,buttons:{"Delete all link and delete term":function(){new BeginTransactionModel({}).save({},{success:function(g,f){a.deleteTermWithAnnotationTerm(b)},error:function(g,f){window.app.view.message("ERROR","error transaction begin","error")}})},Cancel:function(){$("#dialogsTerm").dialog("close")}},close:function(f){}}}).render()})},deleteTermWithAnnotationTerm:function(c){var b=this;var a=0;new AnnotationCollection({term:c.id}).fetch({success:function(e,d){if(e.size()==0){b.removeAnnotationTermCallback(0,0,c);return}e.each(function(f){new AnnotationTermModel({term:c.id,annotation:f.id}).destroy({success:function(h,g){b.removeAnnotationTermCallback(e.length,++a,c)}})})}})},deleteTermWithoutAnnotationTerm:function(c){var b=this;var a=0;new RelationTermCollection({term:c.id}).fetch({success:function(e,d){if(e.size()==0){b.removeRelationTermCallback(0,0,c);return}e.each(function(g){var f=g.toJSON();new RelationTermModel({relation:f.relation.id,term1:f.term1.id,term2:f.term2.id}).destroy({success:function(i,h){b.removeRelationTermCallback(e.length,++a,c)}})})}})},removeAnnotationTermCallback:function(d,a,c){var b=this;if(a<d){return}b.deleteTermWithoutAnnotationTerm(c)},removeRelationTermCallback:function(d,a,c){var b=this;if(a<d){return}new TermModel({id:c.id}).destroy({success:function(f,e){new EndTransactionModel({}).save();window.app.view.message("Term",e.message,"");b.refresh();$("#dialogsTerm").dialog("close")},error:function(f,e){var g=$.parseJSON(e.responseText);$("#delete-term-error-message").empty();$("#delete-term-error-label").show();$("#delete-term-error-message").append(g.errors)}})},buildButton:function(){var a=this;a.$buttonAddTerm.button({icons:{secondary:"ui-icon-plus"}});a.$buttonEditTerm.button({icons:{secondary:"ui-icon-pencil"}});a.$buttonDeleteTerm.button({icons:{secondary:"ui-icon-trash"}});a.$buttonEditOntology.button({icons:{secondary:"ui-icon-pencil"}});a.$buttonDeleteOntology.button({icons:{secondary:"ui-icon-trash"}})},buildInfoOntologyPanel:function(){var b=this;b.$infoOntology.empty();var d=b.model.get("user");var a=window.app.models.users.get(d);var e="Nobody";var g=b.model.get("users");if(_.size(g)>0){var f=[];_.each(g,function(h){if(h==d){return}f.push(window.app.models.users.get(h).prettyName())});e=f.join(", ")}var c=_.template("<div id='userontologyinfo-{{id}}' style='padding:5px;'><ul><li><b>Ontology</b> : {{ontologyName}}.</li><li><b>Owner</b> : {{owner}}.</li><li><b>Shared to</b> : {{sharedTo}}.</li><li class='projectsLinked'></li></ul></div>",{id:b.model.id,ontologyName:b.model.get("name"),owner:a.prettyName(),sharedTo:e});b.$infoOntology.html(c);new OntologyProjectModel({ontology:b.model.id}).fetch({success:function(k,h){var j=[];k.each(function(m){var l=_.template("<a href='#tabs-dashboard-{{idProject}}'>{{projectName}}</a>",{idProject:m.get("id"),projectName:m.get("name")});j.push(l)});var i=_.template("<b>Projects</b> : {{projects}}",{projects:j.join(", ")});b.$infoOntology.find(".projectsLinked").html(i)}})},buildInfoTermPanel:function(){},buildOntologyTree:function(){var a=this;var b=new Date();a.$tree.empty();a.$tree.dynatree({children:a.model.toJSON(),onExpand:function(){},onClick:function(d,c){if(window.app.models.ontologies.get(d.data.id)==undefined){a.updateInfoPanel(d.data.id,d.data.title)}},onSelect:function(c,d){a.updateInfoPanel(d.data.id,d.data.title)},onActivate:function(c){a.updateInfoPanel(c.data.id,c.data.title)},onDblClick:function(d,c){},onRender:function(d,c){a.$tree.find("a.dynatree-title").css("color","black")},initId:"treeDataOntology-"+a.model.id+b.getTime(),cookieId:"dynatree-Ontology-"+a.model.id+b.getTime(),idPrefix:"dynatree-Ontology-"+a.model.id+b.getTime()+"-",debugLevel:3});a.$tree.dynatree("getRoot").visit(function(e){if(e.children!=null){return}var g=e.data.title;var d=e.data.color;var f="<a href='#ontology/{{idOntology}}/{{idTerm}}' onClick='window.location.href = this.href;'>{{title}} <span style='background-color:{{color}}'>&nbsp;&nbsp;&nbsp;&nbsp;</span></a>";var c=_.template(f,{idOntology:a.model.id,idTerm:e.data.id,title:g,color:d});e.setTitle(c)});a.$tree.dynatree("getRoot").visit(function(c){c.expand(true)})},updateInfoPanel:function(e,d){var b=this;var h=new google.visualization.DataTable();h.addColumn("string","Project");h.addColumn("number","Number of annotations");var f=0;var g=new StatsCollection({term:e});var a=function(l,k){var i="piechart-"+b.model.id;$("#"+i).empty();var j=false;h.addRows(_.size(l));l.each(function(m){if(m.get("value")>0){j=true}h.setValue(f,0,m.get("key"));h.setValue(f,1,m.get("value"));f++});if(!j){$("#"+i).hide();return}new google.visualization.PieChart(document.getElementById(i)).draw(h,{width:500,height:300,title:"Annotations by projects"});$("#"+i).show()};var c=function(o,l){var i="columchart-"+b.model.id;$("#"+i).empty();var k=false;var n=new google.visualization.DataTable();n.addRows(_.size(o));n.addColumn("string","");n.addColumn("number",0);var m=0;o.each(function(j){if(j.get("value")>0){k=true}n.setValue(m,0,j.get("key"));n.setValue(m,1,j.get("value"));m++});if(!k){$("#"+i).hide();return}new google.visualization.ColumnChart(document.getElementById(i)).draw(n,{title:"Annotations by projects",width:500,height:300,vAxis:{title:"Number of annotations"},hAxis:{title:"Project"}});$("#"+i).show()};g.fetch({success:function(j,i){c(j,i);a(j,i)}})}});var OntologyView=Backbone.View.extend({tagName:"div",self:this,alreadyBuild:false,$tabsOntologies:null,ontologiesPanel:null,idOntology:null,addOntologyDialog:null,events:{"click .addOntology":"showAddOntologyPanel","click .refreshOntology":"refresh"},initLoading:function(){$(this.el).find("#ontologyLoading").html("Loading...")},showLoading:function(){$(this.el).find("#ontologytreepanel").hide();$(this.el).find("#ontologyLoading").show()},hideLoading:function(){$(this.el).find("#ontologyLoading").hide();$(this.el).find("#ontologytreepanel").show()},initialize:function(a){this.container=a.container;this.idOntology=a.idOntology;this.idTerm=a.idTerm},refresh:function(){var a=this;window.app.models.terms.fetch({success:function(c,b){window.app.models.ontologies.fetch({success:function(e,d){a.render()}})}})},refresh:function(b,c){var a=this;this.idOntology=b;this.idTerm=c;window.app.models.terms.fetch({success:function(e,d){window.app.models.ontologies.fetch({success:function(g,f){a.render()}})}})},select:function(b){var a=this;this.idOntology=b;a.render()},render:function(){var a=this;require(["text!application/templates/ontology/OntologyList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).html(_.template(b,{}));a.initLoading();a.showLoading();a.$tabsOntologies=$(a.el).find("#tabsontology");$(a.el).find(".addOntology").button({icons:{secondary:"ui-icon-plus"}});$(a.el).find(".refreshOntology").button({icons:{secondary:"ui-icon-refresh"}});a.initOntologyTabs();a.hideLoading();return this},showAddOntologyPanel:function(){var a=this;$("#addontology").remove();a.addOntologyDialog=new AddOntologyDialog({ontologiesPanel:a,el:a.el}).render()},select:function(c,e){var b=this;var a=0;var d=0;b.model.each(function(f){if(c==f.get("id")){a=d}d=d+1});if(e!=undefined){b.ontologiesPanel[a].selectTerm(e)}b.$tabsOntologies.accordion("activate",a)},initOntologyTabs:function(){var a=this;require(["text!application/templates/ontology/OntologyTab.tpl.html","text!application/templates/ontology/OntologyTabContent.tpl.html"],function(c,b){a.ontologiesPanel=new Array();a.model.each(function(e){a.addOntologyToTab(c,b,{id:e.get("id"),name:e.get("name")});var d=new OntologyPanelView({model:e,el:$(a.el).find("#tabsontology-"+e.id),container:a,ontologiesPanel:a});d.render();a.ontologiesPanel.push(d)});if(!a.alreadyBuild){a.$tabsOntologies.accordion({fillSpace:true});$("#tabsontology h3 a").click(function(){window.location=$(this).attr("href");return false})}a.select(a.idOntology,a.idTerm);$(".accordeonOntology").css("height","auto");$(".accordeonOntology").css("width","auto")})},addOntologyToTab:function(c,b,a){this.$tabsOntologies.append(_.template("<h3><a id='ontologyTitle{{ontologyID}}' href='#ontology/{{ontologyID}}'>{{ontologyName}}</a></h3>",{ontologyID:a.id,ontologyName:a.name}));this.$tabsOntologies.append(_.template(b,a))}});var OntologyAddOrEditTermView=Backbone.View.extend({ontologyPanel:null,ontologyDialog:null,ontology:null,$tree:null,$panel:null,$textboxName:null,$colorChooser:null,$inputOldColor:null,$inputNewColor:null,$errorMessage:null,$errorLabel:null,$addFolderButton:null,action:null,events:{"click .addFolder":"addFolder"},initialize:function(a){this.container=a.container;this.ontologyPanel=a.ontologyPanel;this.ontology=a.ontology;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyAddOrEditTermView.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;if(a.model==null){a.action="Add";a.createNewEmpty()}else{a.action="Edit"}a.$termDialog=$(a.el).find("#dialog-"+a.action+"-ontology-term");$("#dialog-Edit-ontology-term").replaceWith("");$("#dialog-Add-ontology-term").replaceWith("");var b=_.template(c,{oldColor:a.model.get("color"),action:a.action});$(a.el).append(b);a.$panel=$(a.el);a.$termDialog=$(a.el).find("#dialog-"+a.action+"-ontology-term");a.$tree=a.$panel.find("#"+a.action+"ontologytermtree");a.$from=a.$panel.find($("#form-"+a.action+"-ontology-term"));a.$textboxName=a.$panel.find("#"+a.action+"termname");a.$colorChooser=a.$panel.find("#colorpicker1");a.$inputOldColor=a.$panel.find("#oldColor");a.$inputNewColor=a.$panel.find("#color1");a.$addFolderButton=a.$panel.find(".addFolder");a.$errorMessage=a.$panel.find("#"+a.action+"ontologytermerrormessage");a.$errorLabel=a.$panel.find("#"+a.action+"ontologytermerrorlabel");a.$from.submit(function(){if(a.action=="Edit"){a.updatedOntologyTerm()}else{a.createOntologyTerm()}return false});a.$from.find("input").keydown(function(d){if(d.keyCode==13){a.$from.submit();return false}});a.clearOntologyTermPanel();a.buildNameInfo();a.buildColorInfo();a.buildParentInfo();a.ontologyDialog=a.$termDialog.dialog({width:"1000",autoOpen:false,modal:true,buttons:{Save:function(){a.$from.submit()},Cancel:function(){a.$termDialog.dialog("close")}}});a.open();return this},createNewEmpty:function(){var a=this;a.model=new TermModel({id:-1,name:"",color:"#ff0000"})},buildNameInfo:function(){var a=this;a.$textboxName.bind("keyup mouseup change click",function(g){var d=a.$tree.dynatree("getTree").getNodeByKey(a.model.id);var c="#119b04";var f="<label style='color:{{color}}'>{{title}}</label>";var b=_.template(f,{title:a.$textboxName.val(),color:c});if(d!=null){d.setTitle(b)}});a.$textboxName.val(a.model.get("name"))},buildColorInfo:function(){var c=this;var a=c.$colorChooser.farbtastic("#color1");var b=c.model.get("color");c.$inputOldColor.val(b);c.$inputNewColor.val(b);c.$inputOldColor.css("background",b);c.$inputNewColor.css("background",b);c.$inputNewColor.css("color",c.$inputOldColor.css("color"))},addFolder:function(){},buildParentInfo:function(){var a=this;a.$addFolderButton.button({icons:{secondary:"ui-icon-folder-collapsed"}});a.$tree.empty();a.$tree.dynatree({children:a.ontology.toJSON(),onExpand:function(){},onRender:function(e,d){a.$tree.find("a.dynatree-title").css("color","black")},onClick:function(e,d){},onSelect:function(d,e){},onCustomRender:function(d){},onDblClick:function(e,d){},dnd:{onDragStart:function(d){if(d.data.key!=a.model.id){return false}return true},onDragStop:function(d){},autoExpandMS:1000,preventVoidMoves:true,onDragEnter:function(e,d){return true},onDragOver:function(f,e,d){},onDragLeave:function(e,d){},onDrop:function(g,f,e,h,d){if(e=="over"){f.move(g,e);g.data.isFolder=true;g.render()}else{f.move(g,e)}}},generateIds:true,initId:""+a.action+"treeDataOntology-"+a.model.id,cookieId:""+a.action+"dynatree-Ontology-"+a.model.id,idPrefix:""+a.action+"dynatree-Ontology-"+a.model.id+"-",debugLevel:0});if(a.action=="Add"){var c=a.$tree.dynatree("getTree").getNodeByKey(a.ontology.id);var b=c.addChild({title:"",key:-1,tooltip:"This folder and all child nodes were added programmatically.",isFolder:false})}a.$tree.dynatree("getRoot").visit(function(d){d.expand(true)});if(a.action=="Edit"){a.$textboxName.click()}},getNewName:function(){var a=this;return a.$textboxName.val()},getNewParent:function(){var a=this;var b=a.$tree.dynatree("getTree").getNodeByKey(a.model.id);return b.parent.data.id},getNewColor:function(){return this.$inputNewColor.val()},refresh:function(){},open:function(){var a=this;a.clearOntologyTermPanel();a.ontologyDialog.dialog("open")},clearOntologyTermPanel:function(){var a=this;a.$errorMessage.empty();a.$errorLabel.hide()},updatedOntologyTerm:function(){var c=this;c.$errorMessage.empty();c.$errorLabel.hide();var h=c.model.id;var e=c.getNewName();var g=c.model.get("parent");var f=c.getNewParent();var d=true;if(g!=null&&window.app.models.ontologies.get(g)==undefined){d=false}var a=true;if(window.app.models.ontologies.get(f)==undefined){a=false}var b=c.getNewColor();c.model.set({name:e,color:b});c.model.save({name:e,color:b},{success:function(j,i){if(f!=g){if(d&&a){c.close()}else{if(d){c.addRelation(h,f)}else{if(a){c.resetRelation(h,g,null)}else{c.resetRelation(h,g,f)}}}}else{c.close()}},error:function(j,i){var k=$.parseJSON(i.responseText);c.$errorLabel.show();c.$errorMessage.append(k.errors)}})},createOntologyTerm:function(){var c=this;c.$errorMessage.empty();c.$errorLabel.hide();var f=c.model.id;var d=c.getNewName();var a=true;var e=c.getNewParent();if(window.app.models.ontologies.get(e)==undefined){a=false}var b=c.getNewColor();c.model.set({name:d,color:b});c.model=new TermModel({name:d,color:b,ontology:c.ontology.id}).save({name:d,color:b,ontology:c.ontology.id},{success:function(h,g){if(a){window.app.view.message("Term",g.message,"");c.close()}else{c.addRelation(g.term.id,e)}},error:function(h,g){var i=$.parseJSON(g.responseText);c.$errorLabel.show();c.$errorMessage.append(i.errors)}})},resetRelation:function(d,b,c){var a=this;new RelationTermModel({term1:b,term2:d}).destroy({success:function(f,e){if(c!=null){a.addRelation(d,c)}else{window.app.view.message("Term",e.message,"");a.close()}},error:function(f,e){var g=$.parseJSON(e.responseText);a.$errorLabel.show();a.$errorMessage.append(g.errors)}})},addRelation:function(c,b){var a=this;new RelationTermModel({}).save({term1:b,term2:c},{success:function(e,d){window.app.view.message("Term",d.message,"");a.close()},error:function(e,d){var f=$.parseJSON(d.responseText);a.$errorLabel.show();a.$errorMessage.append(f.errors)}})},close:function(){var a=this;this.ontologyPanel.refresh();a.$termDialog.dialog("close")}});var OntologyTreeView=Backbone.View.extend({tagName:"div",initialize:function(a){this.tree=null;this.activeEvent=true;this.browseImageView=a.browseImageView;this.idAnnotation=null},showColors:function(){$(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.children!=null){return}var e=c.data.title;var b=c.data.color;var d="{{title}} <span style='background-color:{{color}}'>&nbsp;&nbsp;</span>";var a=_.template(d,{title:e,color:b});c.setTitle(a)})},render:function(){var a=this;require(["text!application/templates/explorer/OntologyTreeWrapper.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){$(this.el).html(_.template(b,{}));this.tree=$(this.el).find(".tree");var a=this;$(this.el).find(".tree").dynatree({checkbox:true,selectMode:2,expand:true,onExpand:function(){},children:this.model.toJSON(),onSelect:function(c,d){if(!a.activeEvent){return}if(a.idAnnotation==null){return}if(d.isSelected()){a.linkTerm(d.data.key)}else{if(!d.isSelected()){a.unlinkTerm(d.data.key)}}},onDblClick:function(d,c){d.toggleSelect()},initId:"treeData"+this.model.id,cookieId:"dynatree-Cb"+this.model.id,idPrefix:"dynatree-Cb"+this.model.id+"-"});a.showColors();$(this.el).find(".tree").dynatree("getRoot").visit(function(c){c.expand(true)});return this},clear:function(){this.activeEvent=false;$(this.el).find(".tree").dynatree("getRoot").visit(function(a){a.select(false)});this.activeEvent=true},clearAnnotation:function(){this.idAnnotation=null},check:function(b){var a=this;a.activeEvent=false;(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==b){c.select(true)}});a.activeEvent=true},uncheck:function(b){var a=this;a.activeEvent=false;(this.el).find(".tree").dynatree("getRoot").visit(function(c){if(c.data.key==b){c.select(false)}});a.activeEvent=true},refresh:function(a){var b=this;this.idAnnotation=a;var c=function(e,d){b.clear();b.activeEvent=false;e.each(function(f){b.check(f.get("id"))});b.activeEvent=true};new AnnotationTermCollection({idAnnotation:a}).fetch({success:c})},getTermsChecked:function(){var a=[];(this.el).find(".tree").dynatree("getRoot").visit(function(b){if(b.isSelected()){a.push(b.data.key)}});return a},linkTerm:function(b){var a=this;new AnnotationTermModel({annotation:this.idAnnotation,term:b}).save({annotation:this.idAnnotation,term:b},{success:function(d,c){window.app.view.message("Annotation Term",c.message,"");a.browseImageView.reloadAnnotation(a.idAnnotation);a.browseImageView.refreshAnnotationTabs(b)},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Annotation-Term",e.errors,"")}})},unlinkTerm:function(b){var a=this;new AnnotationTermModel({annotation:this.idAnnotation,term:b}).destroy({success:function(d,c){window.app.view.message("Annotation Term",c.message,"");a.browseImageView.reloadAnnotation(a.idAnnotation);a.browseImageView.refreshAnnotationTabs(b)},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Annotation-Term",e.errors,"")}})}});var EditOntologyDialog=Backbone.View.extend({ontologyPanel:null,editOntologyDialog:null,initialize:function(a){this.container=a.container;this.ontologyPanel=a.ontologyPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyEditDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;$("#editontology").replaceWith("");$("#addontology").replaceWith("");var b=_.template(c,{});$(a.el).append(b);$("#login-form-edit-ontology").submit(function(){a.editOntology();return false});$("#login-form-edit-ontology").find("input").keydown(function(d){if(d.keyCode==13){$("#login-form-edit-ontology").submit();return false}});a.editOntologyDialog=$("#editontology").dialog({width:500,autoOpen:false,modal:true,buttons:{Save:function(){$("#login-form-edit-ontology").submit()},Cancel:function(){$("#editontology").dialog("close")}}});a.open();a.fillForm();return this},fillForm:function(){var a=this;$("#ontology-edit-name").val(a.model.get("name"))},refresh:function(){},open:function(){var a=this;a.clearEditOntologyPanel();a.editOntologyDialog.dialog("open")},clearEditOntologyPanel:function(){var a=this;$("#ontologyediterrormessage").empty();$("#ontologyediterrorlabel").hide();$("#ontology-edit-name").val("")},editOntology:function(){var a=this;$("#ontologyediterrormessage").empty();$("#ontologyediterrorlabel").hide();var b=$("#ontology-edit-name").val().toUpperCase();var c=a.model;c.unset("children");c.save({name:b},{success:function(e,d){window.app.view.message("Ontology",d.message,"");a.editOntologyDialog.dialog("close");a.ontologyPanel.refresh()},error:function(e,d){var f=$.parseJSON(d.responseText);$("#ontologyediterrorlabel").show();$("#ontologyediterrormessage").append(f.errors)}})}});var AddOntologyDialog=Backbone.View.extend({ontologiesPanel:null,addOntologyDialog:null,initialize:function(a){this.container=a.container;this.ontologiesPanel=a.ontologiesPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/ontology/OntologyAddDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var b=this;var d=_.template(c,{});$("#editontology").replaceWith("");$("#addontology").replaceWith("");$(b.el).append(d);var a=window.app.models.users.get(window.app.status.user);$("#ontologyuser").append(a.get("username")+" ("+a.get("firstname")+" "+a.get("lastname")+")");$("#login-form-add-ontology").submit(function(){b.createOntology();return false});$("#login-form-add-ontology").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-add-ontology").submit();return false}});b.addOntologyDialog=$("#addontology").dialog({width:500,autoOpen:false,modal:true,buttons:{Save:function(){$("#login-form-add-ontology").submit()},Cancel:function(){$("#addontology").dialog("close")}}});b.open();return this},refresh:function(){},open:function(){var a=this;a.clearAddOntologyPanel();a.addOntologyDialog.dialog("open")},clearAddOntologyPanel:function(){$("#errormessage").empty();$("#ontologyerrorlabel").hide();$("#ontology-name").val("")},createOntology:function(){var a=this;$("#errormessage").empty();$("#ontologyerrorlabel").hide();var b=$("#ontology-name").val().toUpperCase();var c=$("input[type=radio][name=ontologyradio]:checked").attr("value");var d=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(e,f){d.push($(f).attr("value"))});new OntologyModel({name:b}).save({name:b},{success:function(f,e){window.app.view.message("Ontology",e.message,"");var g=e.ontology.id;a.ontologiesPanel.refresh(g);$("#addontology").dialog("close")},error:function(f,e){var g=$.parseJSON(e.responseText);$("#ontologyerrorlabel").show();$("#errormessage").append(g.errors)}})}});var ProjectView=Backbone.View.extend({tagName:"div",searchProjectPanelElem:"#searchProjectPanel",projectListElem:"#projectlist",projectList:null,addSlideDialog:null,initialize:function(a){this.container=a.container;this.model=a.model;this.el=a.el;this.searchProjectPanel=null;this.addProjectDialog=null},render:function(){var a=this;require(["text!application/templates/project/ProjectList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;$(this.el).find("#projectdiv").html(_.template(b,{}));a.loadSearchProjectPanel();a.loadProjectsListing();return this},refresh:function(){var b=this;var a=undefined;if(b.addSlideDialog!=null){b.addSlideDialog.refresh()}new ProjectCollection({user:a}).fetch({success:function(d,c){b.model=d;b.render()}})},loadSearchProjectPanel:function(){var a=this;a.searchProjectPanel=new ProjectSearchPanel({model:a.model,ontologies:window.app.models.ontologies,el:$("#projectViewNorth"),container:a,projectsPanel:a}).render()},loadProjectsListing:function(){var a=this;$(a.projectListElem).empty();a.projectList=new Array();a.model.each(function(c){var b=new ProjectPanelView({model:c,projectsPanel:a,container:a}).render();a.projectList.push(b);$(a.projectListElem).append(b.el)})},showProjects:function(b){var a=this;a.model.each(function(c){if(b.get(c.id)!=null){$(a.projectListElem+c.id).show()}else{$(a.projectListElem+c.id).hide()}})}});var ProjectPanelView=Backbone.View.extend({tagName:"div",loadImages:true,imageOpened:false,project:null,projectElem:"#projectlist",imageOpenElem:"#projectopenimages",imageAddElem:"#projectaddimages",projectChangeElem:"#radioprojectchange",projectChangeDialog:"div#projectchangedialog",loadImagesInAddPanel:true,projectsPanel:null,container:null,initialize:function(a){this.container=a.container;this.projectsPanel=a.projectsPanel;_.bindAll(this,"render")},events:{"click .addSlide":"showAddSlidesPanel","click .seeSlide":"showSlidesPanel","click .editProject":"editProject","click .deleteProject":"deleteProject"},render:function(){var a=this;require(["text!application/templates/project/ProjectDetail.tpl.html"],function(b){a.doLayout(b,false)});return this},refresh:function(){var a=this;a.model.fetch({success:function(c,b){a.loadImages=true;require(["text!application/templates/project/ProjectDetail.tpl.html"],function(d){a.doLayout(d,true)});a.projectsPanel.loadSearchProjectPanel()}})},clear:function(){var a=this;a.projectsPanel.refresh()},doLayout:function(c,f){var b=this;var e=b.model.toJSON();var a=e.ontology;var g=[];_.each(b.model.get("users"),function(h){g.push(window.app.models.users.get(h).get("username"))});e.users=g.join(", ");e.ontologyId=a;var d=_.template(c,e);if(f){$("#projectlist"+e.id).replaceWith(d)}else{$(b.el).append(d)}b.renderCurrentProjectButton();b.renderShowImageButton(e.numberOfImages);$(b.el).find(b.imageAddElem+b.model.id).button({icons:{secondary:"ui-icon-plus"}})},editProject:function(){var a=this;$("#editproject").remove();a.editProjectDialog=new EditProjectDialog({projectPanel:a,el:a.el,model:a.model}).render()},deleteProject:function(){var a=this;var b=a.model.id;new ImageInstanceCollection({project:b}).fetch({success:function(d,c){if(d.length==0){a.acceptDeleteProject()}else{a.refuseDeleteProject(d.length)}}})},refuseDeleteProject:function(b){var a=this;require(["text!application/templates/project/ProjectDeleteRefuseDialog.tpl.html"],function(c){$("dialogsDeleteProject").replaceWith("");var d=new ConfirmDialogView({el:"#dialogsDeleteProject",template:_.template(c,{project:a.model.get("name"),numberOfImage:b}),dialogAttr:{dialogID:"#dialogsDeleteProject",width:400,height:200,buttons:{Close:function(){$("#dialogsDeleteProject").dialog("close")}},close:function(e){}}}).render()})},acceptDeleteProject:function(){var a=this;require(["text!application/templates/project/ProjectDeleteConfirmDialog.tpl.html"],function(b){var c=new ConfirmDialogView({el:"#dialogsDeleteProject",template:_.template(b,{project:a.model.get("name")}),dialogAttr:{dialogID:"#dialogsDeleteProject",width:400,height:300,buttons:{"Delete project":function(){new ProjectModel({id:a.model.id}).destroy({success:function(e,d){window.app.view.message("Project",d.message,"");a.clear();$("#dialogsDeleteProject").dialog("close")},error:function(e,d){var f=$.parseJSON(d.responseText);window.app.view.message("Project",f.errors,"")}})},Cancel:function(){$("#dialogsDeleteProject").dialog("close")}},close:function(d){}}}).render()})},showAddSlidesPanel:function(){var a=this;$("#projectdiv").hide();$("#addimagediv").show();a.container.addSlideDialog=new ProjectManageSlideDialog({model:this.model,projectPanel:this,el:a.el}).render()},showSlidesPanel:function(){var a=this;a.openImagesList(a.model.get("id"));a.imageOpened=!a.imageOpened;$(a.imageOpenElem+a.model.id).button({icons:{secondary:a.imageOpened?"ui-icon-carat-1-n":"ui-icon-carat-1-s"}})},changeProject:function(){var b=this;var c=b.model.get("id");var a=false;if(c==window.app.status.currentProject){return true}window.app.controllers.browse.closeAll();window.app.status.currentProject=c;return true},renderShowImageButton:function(c){var a=this;var b=true;if(c>0){b=false}$(a.imageOpenElem+a.model.id).button({icons:{secondary:"ui-icon-carat-1-s"},disabled:b})},renderCurrentProjectButton:function(){var a=this;var b=window.app.status.currentProject==a.model.id;$(a.el).find(a.projectChangeElem+a.model.id).button({icons:{secondary:"ui-icon-image"}});if(b){$(a.projectChangeElem+a.model.id).click()}},openImagesList:function(a){}});var ProjectManageSlideDialog=Backbone.View.extend({imageListing:null,imageThumb:null,projectPanel:null,addSlideDialog:null,imagesProject:null,divDialog:"div#projectaddimagedialog",render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageDialog.tpl.html"],function(b){a.doLayout(b)});return this},initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;this.imagesProject=new ImageInstanceCollection({project:this.model.get("id")})},refresh:function(){if(this.imageListing!=undefined){this.imageListing.refresh()}if(this.imageThumb!=undefined){this.imageThumb.refresh()}},doLayout:function(b){var a=this;$("#addimagediv").empty();var c=_.template(b,{id:a.model.get("id"),name:a.model.get("name")});$(a.el).append(c);$("button[class=goBackToProject]").click(function(){a.projectPanel.refresh();$("#projectdiv").show();$("#addimagediv").hide()});a.imageThumb=new ProjectAddImageThumbDialog({model:a.model,projectsPanel:a,imagesProject:a.imagesProject,slides:window.app.models.slides,el:"#tabsProjectaddimagedialog"+a.model.id+"-1"}).render();a.imageListing=new ProjectAddImageListingDialog({model:a.model,projectsPanel:a,imagesProject:a.imagesProject,el:"#tabsProjectaddimagedialog"+a.model.id+"-2"}).render();$("button[class=goBackToProject]").button({icons:{primary:"ui-icon-circle-triangle-w"}});$("input[class=showImageTable]").click(function(){a.imageListing.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-2").show();$("#tabsProjectaddimagedialog"+a.model.id+"-1").hide()});$("input[class=showImageTable]").click();$("input[class=showImageTable]").button({icons:{primary:"ui-icon-document"}});$("input[class=showImageThumbs]").click(function(){a.imageThumb.refresh();$("#tabsProjectaddimagedialog"+a.model.id+"-1").show();$("#tabsProjectaddimagedialog"+a.model.id+"-2").hide()});$("input[class=showImageThumbs]").button({icons:{primary:"ui-icon-image"}});$("#addimagediv").append($(a.divDialog+a.model.get("id")));$(".ui-panel-header").css("display","block");a.open();return this},open:function(){}});var AddProjectDialog=Backbone.View.extend({projectsPanel:null,addProjectDialog:null,initialize:function(a){this.container=a.container;this.projectsPanel=a.projectsPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectAddDialog.tpl.html","text!application/templates/project/OntologiesChoicesRadio.tpl.html","text!application/templates/project/UsersChoices.tpl.html"],function(b,d,c){a.doLayout(b,d,c)});return this},doLayout:function(a,e,d){var b=this;var c=_.template(a,{});$("#editproject").replaceWith("");$("#addproject").replaceWith("");$(b.el).append(c);$("#login-form-add-project").submit(function(){b.createProject();return false});$("#login-form-add-project").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-add-project").submit();return false}});$("#projectontology").empty();window.app.models.ontologies.each(function(g){var f=_.template(e,{id:g.id,name:g.get("name")});$("#projectontology").append(f)});$("#projectuser").empty();window.app.models.users.each(function(g){var f=_.template(d,{id:g.id,username:g.get("username")});$("#projectuser").append(f)});$("#projectuser").find("#users"+window.app.status.user.id).attr("checked","checked");$("#projectuser").find("#users"+window.app.status.user.id).click(function(){$("#projectuser").find("#users"+window.app.status.user.id).attr("checked","checked")});$("#projectuser").find('[for="users'+window.app.status.user.id+'"]').css("font-weight","bold");b.addProjectDialog=$("#addproject").dialog({width:600,autoOpen:false,modal:true,buttons:{Save:function(){$("#login-form-add-project").submit()},Cancel:function(){$("#addproject").dialog("close")}}});b.open();return this},refresh:function(){},open:function(){var a=this;a.clearAddProjectPanel();a.addProjectDialog.dialog("open")},clearAddProjectPanel:function(){var a=this;$("#errormessage").empty();$("#projecterrorlabel").hide();$("#project-name").val("");$(a.addProjectCheckedOntologiesRadioElem).attr("checked",false);$(a.addProjectCheckedUsersCheckboxElem).attr("checked",false)},createProject:function(){var a=this;$("#errormessage").empty();$("#projecterrorlabel").hide();var b=$("#project-name").val().toUpperCase();var c=$("input[type=radio][name=ontologyradio]:checked").attr("value");var d=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(e,f){d.push($(f).attr("value"))});new ProjectModel({name:b,ontology:c}).save({name:b,ontology:c},{success:function(g,f){window.app.view.message("Project",f.message,"");var i=f.project.id;var h=d.length;var e=0;if(h==0){a.addDeleteUserProjectCallback(0,0)}_.each(d,function(j){new ProjectUserModel({project:i,user:j}).save({},{success:function(l,k){a.addUserProjectCallback(h,++e)},error:function(l,k){var m=$.parseJSON(k.responseText);window.app.view.message("User",m.errors,"")}})})},error:function(f,e){var g=$.parseJSON(e.responseText);$("#projecterrorlabel").show()}})},addUserProjectCallback:function(c,a){if(a<c){return}var b=this;b.projectsPanel.refresh();$("#addproject").dialog("close")}});var EditProjectDialog=Backbone.View.extend({projectsPanel:null,editProjectDialog:null,initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;_.bindAll(this,"render")},render:function(){var a=this;require(["text!application/templates/project/ProjectEditDialog.tpl.html","text!application/templates/project/UsersChoices.tpl.html"],function(b,c){a.doLayout(b,c)});return this},doLayout:function(c,d){var a=this;$("#editproject").replaceWith("");$("#addproject").replaceWith("");var b=_.template(c,{});$(a.el).append(b);$("#login-form-edit-project").submit(function(){a.editProject();return false});$("#login-form-edit-project").find("input").keydown(function(f){if(f.keyCode==13){$("#login-form-edit-project").submit();return false}});$("#projectedituser").empty();window.app.models.users.each(function(f){var e=_.template(d,{id:f.id,username:f.get("username")});$("#projectedituser").append(e)});$("#projectedituser").find("#users"+window.app.status.user.id).attr("checked","checked");$("#projectedituser").find("#users"+window.app.status.user.id).click(function(){$("#projectedituser").find("#users"+window.app.status.user.id).attr("checked","checked")});$("#projectedituser").find('[for="users'+window.app.status.user.id+'"]').css("font-weight","bold");a.editProjectDialog=$("#editproject").dialog({width:500,autoOpen:false,modal:true,buttons:{Save:function(){$("#login-form-edit-project").submit()},Cancel:function(){$("#editproject").dialog("close")}}});a.open();a.fillForm();return this},fillForm:function(){var a=this;$("#project-edit-name").val(a.model.get("name"));var b=a.model.get("users");_.each(b,function(c){$("#users"+c).attr("checked",true);if(window.app.status.user.id==c.id){}})},refresh:function(){},open:function(){var a=this;a.clearEditProjectPanel();a.editProjectDialog.dialog("open")},clearEditProjectPanel:function(){var a=this;$("#projectediterrormessage").empty();$("#projectediterrorlabel").hide();$("#project-edit-name").val("");$(a.editProjectCheckedUsersCheckboxElem).attr("checked",false)},diffArray:function(d,c){var e=[],g=[];for(var f=0;f<c.length;f++){e[c[f]]=true}for(var f=0;f<d.length;f++){if(!e[d[f]]){g.push(d[f])}}return g},editProject:function(){var a=this;$("#projectediterrormessage").empty();$("#projectediterrorlabel").hide();var b=$("#project-edit-name").val().toUpperCase();var d=new Array();$("input[type=checkbox][name=usercheckbox]:checked").each(function(e,f){d.push($(f).attr("value"))});var c=a.model;c.set({name:b});c.save({name:b},{success:function(k,j){window.app.view.message("Project",j.message,"");var g=j.project.id;var l=new Array();var n=null;var h=null;var f=null;var i=a.model.get("users");_.each(i,function(o){l.push(o)});l.sort();n=d;n.sort();h=a.diffArray(n,l);f=a.diffArray(l,n);var m=h.length+f.length;var e=0;if(m==0){a.addDeleteUserProjectCallback(0,0)}_.each(h,function(o){new ProjectUserModel({project:g,user:o}).save({},{success:function(q,p){a.addDeleteUserProjectCallback(m,++e)},error:function(q,p){var r=$.parseJSON(p.responseText);window.app.view.message("User",r.errors,"")}})});_.each(f,function(o){new ProjectUserModel({project:g,user:o}).destroy({success:function(q,p){a.addDeleteUserProjectCallback(m,++e)},error:function(q,p){var r=$.parseJSON(p.responseText);window.app.view.message("User",r.errors,"")}})})},error:function(f,e){var g=$.parseJSON(e.responseText);$("#projectediterrorlabel").show()}})},addDeleteUserProjectCallback:function(c,a){if(a<c){return}var b=this;b.projectPanel.refresh();$("#editproject").dialog("close")}});var ProjectSearchPanel=Backbone.View.extend({ontologies:null,idUser:null,container:null,projectsPanel:null,allProjectsButtonElem:"#projectallbutton",addProjectButtonElem:"#projectaddbutton",searchProjectOntolgiesListElem:"#ontologyChoiceList",sliderNumberOfImagesElem:"#numberofimageSlider",labelNumberOfImagesElem:"#amountNumberOfImages",sliderNumberOfSlidesElem:"#numberofslideSlider",labelNumberOfSlidesElem:"#amountNumberOfSlides",sliderNumberOfAnnotationsElem:"#numberofannotationSlider",labelNumberOfAnnotationsElem:"#amountNumberOfAnnotations",searchProjectTextBoxElem:"#projectsearchtextbox",searchProjectButtonElem:"#projectsearchbutton",searchProjectCheckedOntologiesElem:"input[type=checkbox][name=ontology]:checked",addProjectCheckedOntologiesRadioElem:"input[type=radio][name=ontologyradio]:checked",addProjectCheckedUsersCheckboxElem:"input[type=checkbox][name=usercheckbox]:checked",initialize:function(a){this.ontologies=a.ontologies;this.idUser=a.idUser;this.container=a.container;this.projectsPanel=a.projectsPanel},events:{"click .addProject":"showAddProjectPanel","click .searchProjectCriteria":"searchProject","click .showAllProject":"showAllProject"},render:function(){var a=this;require(["text!application/templates/project/ProjectSearchPanel.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(b){var a=this;var c=_.template(b,{});$(this.el).empty();$(this.el).append(c);require(["text!application/templates/project/OntologiesChoices.tpl.html"],function(d){a.loadPanelAndButton(d)});a.loadSlider();a.loadAutocomplete()},loadPanelAndButton:function(b){var a=this;$(a.el).find(a.allProjectsButtonElem).button({icons:{secondary:"ui-icon-refresh"}});$(a.el).find(a.addProjectButtonElem).button({icons:{secondary:"ui-icon-plus"}});a.ontologies=window.app.models.ontologies;a.ontologies.each(function(d){var c=_.template(b,{id:d.id,name:d.get("name")});$(a.searchProjectOntolgiesListElem).append(c)})},loadSlider:function(){var a=this;var b=Number.MAX_VALUE;var d=0;var e=Number.MAX_VALUE;var g=0;var c=Number.MAX_VALUE;var f=0;a.model.each(function(i){var h=parseInt(i.get("numberOfImages"));var k=parseInt(i.get("numberOfSlides"));var j=parseInt(i.get("numberOfAnnotations"));if(h<b){b=h}if(h>d){d=h}if(k<e){e=k}if(k>g){g=k}if(j<c){c=j}if(j>f){f=j}});a.createSliderWithoutAmountPrint(a.sliderNumberOfImagesElem,a.labelNumberOfImagesElem,b,d);a.createSliderWithoutAmountPrint(a.sliderNumberOfSlidesElem,a.labelNumberOfSlidesElem,e,g);a.createSliderWithoutAmountPrint(a.sliderNumberOfAnnotationsElem,a.labelNumberOfAnnotationsElem,c,f)},loadAutocomplete:function(){var a=this;var b=new Array();a.model.each(function(c){b.push(c.get("name"))});$(a.searchProjectTextBoxElem).autocomplete({minLength:0,source:b,select:function(c,d){$(a.searchProjectTextBoxElem).val(d.item.label);a.searchProject()},search:function(c){a.searchProject()}})},createSliderWithoutAmountPrint:function(e,c,d,a){var b=this;$(e).slider({range:true,min:d,max:a,values:[d,a],change:function(f,g){$(c).val(""+g.values[0]+" - "+g.values[1]);b.searchProject()}});$(c).val(""+$(e).slider("values",0)+" - "+$(e).slider("values",1))},refreshSearchPanel:function(b){var a=this;a.loadSlider();a.loadAutocomplete()},showAllProject:function(){var a=this;$(a.searchProjectTextBoxElem).val("");$(a.searchProjectCheckedOntologiesElem).attr("checked",false);a.resetSlider(a.sliderNumberOfImagesElem);a.resetSlider(a.sliderNumberOfSlidesElem);a.resetSlider(a.sliderNumberOfAnnotationsElem);a.searchProject()},resetSlider:function(c){var b=$(c).slider("option","min");var a=$(c).slider("option","max");$(c).slider("values",[b,a])},searchProject:function(){var b=this;var e=$(b.searchProjectTextBoxElem).val();var d=new Array();$.each($(b.searchProjectCheckedOntologiesElem),function(h,i){var g=$(i).attr("id").replace("ontologies","");d.push(g)});var a=new Array();a.push($(b.sliderNumberOfImagesElem).slider("values",0));a.push($(b.sliderNumberOfImagesElem).slider("values",1));var c=new Array();c.push($(b.sliderNumberOfSlidesElem).slider("values",0));c.push($(b.sliderNumberOfSlidesElem).slider("values",1));var f=new Array();f.push($(b.sliderNumberOfAnnotationsElem).slider("values",0));f.push($(b.sliderNumberOfAnnotationsElem).slider("values",1));b.filterProjects(e==""?undefined:e,d.length==0?undefined:d,a,c,f)},showAddProjectPanel:function(){var a=this;$("#addproject").remove();a.addProjectDialog=new AddProjectDialog({projectsPanel:a.projectsPanel,el:a.el}).render()},filterProjects:function(f,e,d,b,g){var a=this;var c=new ProjectCollection(a.model.models);c=a.filterByProjectsByName(f,c);c=a.filterProjectsByOntology(e,c);c=a.filterProjectsByNumberOfImages(d,c);c=a.filterProjectsByNumberOfSlides(b,c);c=a.filterProjectsByNumberOfAnnotations(g,c);a.container.showProjects(c)},filterProjectsOLD:function(e,d,c,b,f){var a=this;a.projects=new ProjectCollection({user:a.userID}).fetch({success:function(i,g){var h=new ProjectCollection(i.models);h=a.filterByProjectsByName(e,h);h=a.filterProjectsByOntology(d,h);h=a.filterProjectsByNumberOfImages(c,h);h=a.filterProjectsByNumberOfSlides(b,h);h=a.filterProjectsByNumberOfAnnotations(f,h);a.container.showProjects(h)}})},filterByProjectsByName:function(c,b){if(c==undefined){return b}var a=new ProjectCollection(b.models);b.each(function(g){var d=g.get("name").toLowerCase();var f=c.toLowerCase();var e=(d.indexOf(f)!=-1);if(!e){a.remove(g)}});return a},filterProjectsByOntology:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("ontology")+"";if(d!=undefined&&_.indexOf(d,e)==-1){b.remove(f)}});return b},filterProjectsByNumberOfImages:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("numberOfImages");if(d[0]>e||d[1]<e){b.remove(f)}});return b},filterProjectsByNumberOfSlides:function(c,d){var a=this;var b=new ProjectCollection(d.models);d.each(function(f){var e=f.get("numberOfSlides");if(c[0]>e||c[1]<e){b.remove(f)}});return b},filterProjectsByNumberOfAnnotations:function(d,c){var a=this;var b=new ProjectCollection(c.models);c.each(function(f){var e=f.get("numberOfAnnotations");if(d[0]>e||d[1]<e){b.remove(f)}});return b}});var ProjectAddImageListingDialog=Backbone.View.extend({imagesProject:null,searchPanel:null,initialize:function(b){var a=this;this.container=b.container;this.projectPanel=b.projectPanel;this.imagesProject=b.imagesProject;this.abstractImageProject=new Array();this.el="#tabsProjectaddimagedialog"+a.model.id+"-2";this.listmanageproject="listmanageproject"+this.model.id;this.pagemanageproject="pagemanageproject"+this.model.id;this.listmanageall="listmanageall"+this.model.id;this.pagemanageall="pagemanageall"+this.model.id;this.addImageButton="addimageprojectbutton"+this.model.id;this.delImageButton="delimageprojectbutton"+this.model.id;this.tab=2;this.timeoutHnd=null},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageListingDialog.tpl.html"],function(b){a.doLayout(b)});return this},refresh:function(){this.refreshImageList()},doLayout:function(b){var a=this;var d=a.model.toJSON();d.tab=2;var c=_.template(b,d);$(a.el).append(c);this.renderImageList();return this},renderImageList:function(){var a=this;a.renderImageListing()},renderImageListing:function(){var a=this;$("#"+a.addImageButton).button({icons:{primary:"ui-icon-circle-arrow-w"},text:false});$("#"+a.delImageButton).button({icons:{primary:"ui-icon-circle-arrow-e"},text:false});$("#infoProjectPanel"+a.model.id).panel({collapseSpeed:100});$("#"+a.addImageButton).click(function(){a.addImageProjectFromTable()});$("#"+a.delImageButton).click(function(){a.deleteImageProjectFromTable()});$("#searchImagetPanelup"+a.model.id+"-"+a.tab).panel({collapseSpeed:100});$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val("");$("#imagesallbutton"+a.model.id+"-"+a.tab).button({text:true});$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).keyup(function(){a.doSearch()}).keyup();$("#imagesallbutton"+a.model.id+"-"+a.tab).click(function(){$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val("");$("#datestartsearchup"+a.model.id+"-"+a.tab).val("");$("#dateendsearchup"+a.model.id+"-"+a.tab).val("");a.doSearch()});$("#datestartsearchup"+a.model.id+"-"+a.tab).datepicker({onSelect:function(c,b){a.doSearch()}});$("#dateendsearchup"+a.model.id+"-"+a.tab).datepicker({onSelect:function(c,b){a.doSearch()}});a.renderImageListProject();a.renderImageListAll()},doSearch:function(){var a=this;if($.data(this,"timer")!=null){clearTimeout($.data(this,"timer"))}var b=setTimeout(function(){a.searchImages()},500);$(this).data("timer",b)},searchImages:function(){var a=this;var f=$("#filenamesearchtextboxup"+a.model.id+"-"+a.tab).val();var e=$("#datestartsearchup"+a.model.id+"-"+a.tab).datepicker("getDate");var c=$("#dateendsearchup"+a.model.id+"-"+a.tab).datepicker("getDate");var b="";if(e!=null){b=e.getTime()}var d="";if(c!=null){d=c.getTime()}$("#"+a.listmanageall).jqGrid("setGridParam",{url:"api/currentuser/image.json?filename="+f+"&createdstart="+b+"&createdstop="+d,page:1}).trigger("reloadGrid")},refreshImageList:function(){var a=this;$("#"+a.listmanageproject).jqGrid("clearGridData",true);a.imagesProject.fetch({success:function(c,b){a.fillAbstractImageProjectCollection(c);a.loadDataImageListProject(c);$("#"+a.listmanageall).trigger("reloadGrid")}})},fillAbstractImageProjectCollection:function(a){var b=this;b.abstractImageProject=[];b.imagesProject.each(function(c){b.abstractImageProject.push(c.get("baseImage"))})},loadDataImageListProject:function(e){var a=this;var d=new Array();var c=0;e.each(function(g){var f=new Date();f.setTime(g.get("created"));d[c]={id:g.id,base:g.get("baseImage"),thumb:"<img src='"+g.get("thumb")+"' width=30/>",filename:g.get("filename"),type:g.get("mime"),annotations:g.get("numberOfAnnotations"),added:f.getFullYear()+"-"+f.getMonth()+"-"+f.getDate(),See:""};c++});for(var b=0;b<d.length;b++){$("#"+a.listmanageproject).jqGrid("addRowData",d[b].id,d[b])}$("#"+a.listmanageproject).jqGrid("sortGrid","filename",false)},renderImageListProject:function(){var a=this;$("#"+a.listmanageproject).jqGrid({datatype:"local",autowidth:true,height:500,colNames:["id","base","thumb","filename","type","annotations","added"],colModel:[{name:"id",index:"id",width:50,sorttype:"int"},{name:"base",index:"base",width:50,sorttype:"int"},{name:"thumb",index:"thumb",width:50},{name:"filename",index:"filename",width:220},{name:"type",index:"type",width:50},{name:"annotations",index:"annotations",width:50},{name:"added",index:"added",width:90,sorttype:"date"}],onSelectRow:function(c){var b=$("#"+a.listmanageproject).find("#"+c).find(".cbox").attr("checked");if(b){$("#"+a.listmanageproject).find("#"+c).find("td").css("background-color","CD661D")}else{$("#"+a.listmanageproject).find("#"+c).find("td").css("background-color","a0dc4f")}},loadComplete:function(){a.imagesProject.each(function(b){$("#"+a.listmanageproject).find("#"+b.id).find("td").css("background-color","a0dc4f")})},pager:"#"+a.pagemanageproject,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Images in "+a.model.get("name"),multiselect:true});$("#"+a.listmanageproject).jqGrid("navGrid","#"+a.listmanageproject,{edit:false,add:false,del:false});$("#"+a.listmanageproject).jqGrid("hideCol","id");$("#"+a.listmanageproject).jqGrid("hideCol","base")},isAbstractImageInProject:function(a){if(_.indexOf(this.abstractImageProject,a)!=-1){return true}else{return false}},renderImageListAll:function(){var a=this;var c;var b="thumb";$("#"+a.listmanageall).jqGrid({datatype:"json",url:"api/currentuser/image.json",autowidth:true,height:500,colNames:["id",b,"filename","mime","created"],colModel:[{name:"id",index:"id",width:30},{name:b,index:b,width:50},{name:"filename",index:"filename",width:220},{name:"mime",index:"mime",width:45},{name:"created",index:"created",width:100,sorttype:"date",formatter:a.dateFormatter}],onSelectRow:function(d){if(a.isAbstractImageInProject(d)){$("#"+a.listmanageall).find("#"+d).find(".cbox").removeAttr("checked")}},loadComplete:function(d){$("#"+a.listmanageall).find("tr").each(function(e){if(e!=0){var f=$(this).find('[aria-describedby$="_'+b+'"]');$(f).html('<img src="'+$(f).text()+'" width=30/>')}});a.imagesProject.each(function(e){$("#"+a.listmanageall).find("#"+e.get("baseImage")).find("td").css("background-color","a0dc4f");$("#"+a.listmanageall).find("#"+e.get("baseImage")).find(".cbox").attr("disabled",true);$("#"+a.listmanageall).find("#"+e.get("baseImage")).find(".cbox").css("visible",false)})},pager:"#"+a.pagemanageall,sortname:"id",viewrecords:true,sortorder:"asc",caption:"Available images",multiselect:true,rowNum:10,rowList:[10,20,30],jsonReader:{repeatitems:false,id:"0"}});$("#"+a.listmanageall).jqGrid("navGrid","#"+a.pagemanageall,{edit:false,add:false,del:false});$("#"+a.listmanageall).jqGrid("sortGrid","filename",false);$("#"+a.listmanageall).jqGrid("hideCol","id")},dateFormatter:function(b,c,d){var a=new Date();a.setTime(b);return a.getFullYear()+"-"+a.getMonth()+"-"+a.getDate()},addImageProjectFromTable:function(){var b=this;var c=$("#"+b.listmanageall).jqGrid("getGridParam","selarrrow");if(c.length==0){return}var a=0;_.each(c,function(d){new ImageInstanceModel({}).save({project:b.model.id,user:null,baseImage:d},{success:function(f,e){window.app.view.message("Image",e.message,"");b.addImageProjectCallback(c.length,++a)},error:function(f,e){var g=$.parseJSON(e.responseText);window.app.view.message("Image",g.errors,"");b.addImageProjectCallback(c.length,++a)}})})},addImageProjectCallback:function(c,a){if(a<c){return}var b=this;b.refreshImageList()},deleteImageProjectFromTable:function(){var a=this;var b=$("#"+a.listmanageproject).jqGrid("getGridParam","selarrrow");if(b.length==0){return}a.deleteImageWithcheckForAnnotation(b)},deleteImageProject:function(c){var b=this;var a=0;_.each(c,function(d){var e=b.imagesProject.get(d).get("baseImage");new ImageInstanceModel({project:b.model.id,user:null,baseImage:e}).destroy({success:function(g,f){window.app.view.message("Image",f.message,"");b.deleteImageProjectCallback(c.length,++a)},error:function(g,f){var h=$.parseJSON(f.responseText);window.app.view.message("Image",h.errors,"");b.deleteImageProjectCallback(c.length,++a)}})})},deleteImageProjectCallback:function(c,a){if(a<c){return}var b=this;b.refreshImageList()},deleteImageWithcheckForAnnotation:function(c){var a=this;var b=false;_.each(c,function(d){var e=a.imagesProject.get(d).get("numberOfAnnotations");console.log("numberOfAnnotations="+e);if(e>0){b=true}});console.log("hasAnnotation="+b);if(b){require(["text!application/templates/project/ProjectAddImageDeleteImageInstanceWithAnnotation.tpl.html"],function(d){var e=new ConfirmDialogView({el:"#dialogDeleteImageWithAnnotation",template:_.template(d,{projectname:a.model.get("name")}),dialogAttr:{dialogID:"#dialogDeleteImageWithAnnotation",width:400,height:300,buttons:{"Delete all images and annotations":function(){a.deleteImageProject(c);$("#dialogDeleteImageWithAnnotation").dialog("close")},Cancel:function(){$("#dialogDeleteImageWithAnnotation").dialog("close")}},close:function(f){}}}).render()})}else{a.deleteImageProject(c)}}});var ProjectAddImageThumbDialog=Backbone.View.extend({imageListing:null,imageThumb:null,slides:null,imagesProject:null,imagesinstanceProject:null,checklistChecked:".checklist input:checked",checklistSelected:".checklist .checkbox-select",checklistDeselected:".checklist .checkbox-deselect",selectedClass:"selected",checkedAttr:"checked",liElem:"projectaddimageitemli",ulElem:"#projectaddimagedialoglist",allProjectUlElem:"ul[id^=projectaddimagedialoglist]",imageDivElem:"#projectaddimageitempict",page:0,nb_slide_by_page:20,nextPage:function(){var a=Math.round(_.size(window.app.models.slides)/this.nb_slide_by_page)-1;this.page=Math.min(this.page+1,a);this.renderImageListLayout()},previousPage:function(){this.page=Math.max(this.page-1,0);this.renderImageListLayout()},disablePrevious:function(){},enablePrevious:function(){},disableNext:function(){},enableNext:function(){},initialize:function(a){this.container=a.container;this.projectPanel=a.projectPanel;this.imagesProject=a.imagesProject;this.imagesinstanceProject=a.imagesinstanceProject;this.el="#tabsProjectaddimagedialog"+this.model.id+"-1";this.slides=a.slides;_.bindAll(this,"render");_.bindAll(this,"nextPage");_.bindAll(this,"previousPage")},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageThumbDialog.tpl.html"],function(b){a.doLayout(b)});return this},refresh:function(){this.renderImageList()},doLayout:function(c){var b=this;var a=_.template(c,{id:this.model.get("id"),name:this.model.get("name")});$(b.el).append(a);$(b.el).find("a.next").bind("click",b.nextPage);$(b.el).find("a.next").button();$(b.el).find("a.previous").bind("click",b.previousPage);$(b.el).find("a.previous").button();return this},renderImageList:function(){var a=this;window.app.models.slides.fetch({success:function(c,b){a.renderImageListLayout()}})},renderImage:function(c,d,b){var a=this;require(["text!application/templates/project/ProjectAddImageChoice.tpl.html"],function(g){var f=new ImageSelectView({model:d}).render();var e=d.get("filename");if(e.length>15){e=e.substring(0,12)+"..."}var h=_.template(g,{id:d.id,name:e,namefull:d.get("filename"),slide:d.get("slide"),info:d.get("info")});$(b).append(h);$(b+" "+a.imageDivElem+d.id).append(f.el);$(f.el).css({width:30});$(b).find("label  > b").css("font-size",10);if(c.get(d.id)){$(b+" #"+a.liElem+d.id).addClass(a.selectedClass);$(b+" #"+a.liElem+d.id).find(":checkbox").attr(a.checkedAttr,a.checkedAttr)}})},selectAllImages:function(a){$(".projectImageList"+a).find("li.imageThumbChoice").each(function(){$(this).find("a.checkbox-select").click()})},unselectAllImages:function(a){$(".projectImageList"+a).find("li.imageThumbChoice").each(function(){$(this).find("a.checkbox-deselect").click()})},renderSlide:function(a){var b=this;require(["text!application/templates/project/ProjectSlideDetail.tpl.html"],function(d){var f=_.template(d,{id:a.get("id"),name:a.get("name")});var e=$(b.ulElem+b.model.get("id"));e.append("<td>"+f+"</td>");e.find(".slideItem"+a.get("id")).panel({collapsible:false});e.find("a[class=selectAll]").bind("click",function(){b.selectAllImages(a.get("id"))});e.find("a[class=unselectAll]").bind("click",function(){b.unselectAllImages(a.get("id"))});e.find("a[class=selectAll]").button({text:false,icons:{secondary:"ui-icon-circle-plus"}});e.find("a[class=unselectAll]").button({text:false,icons:{secondary:"ui-icon-circle-minus"}});var c=a.get("images");var g=".projectImageList"+a.get("id");_.each(c,function(i){var h=new ImageModel(i);b.renderImage(b.imagesProject,h,g)});$("#projectImageList"+a.get("id")).carousel();$(g).append('<div style="clear:both;"></div>')})},renderImageListLayout:function(){var b=this;var f=0;var e=Math.abs(b.page)*b.nb_slide_by_page;var a=(Math.abs(b.page)+1)*b.nb_slide_by_page;$(b.ulElem+b.model.get("id")).empty();var d=4;var c=0;$(b.ulElem+b.model.get("id")).append("<table><tr width='25%'>");window.app.models.slides.each(function(g){if((f>=e)&&(f<a)){b.renderSlide(g);c++;if(c==d){c=0;$(b.ulElem+b.model.get("id")).append("</tr><tr width='25%'>")}}$(b.ulElem+b.model.get("id")).append("</tr></table>");$(".carousel-wrap").css("height","200");f++;if(f==a){b.initEvents()}})},addImageToProject:function(a,b){new ImageInstanceModel({}).save({project:b,user:null,baseImage:a},{success:function(d,c){window.app.view.message("ImageInstance",c.message,"")},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Image",e.errors[0],"")}})},deleteImageToProject:function(a,b){new ImageInstanceModel({project:b,user:null,baseImage:a}).destroy({success:function(d,c){window.app.view.message("ImageInstance",c.message,"")},error:function(d,c){var e=$.parseJSON(c.responseText);window.app.view.message("Image",e.errors[0],"")}})},initEvents:function(){var a=this;$(a.checklistChecked).parent().addClass(a.selectedClass);$(a.checklistSelected).click(function(e){e.preventDefault();var d=$(this).parent().attr("class");$(this).parent().addClass(a.selectedClass);$(this).parent().find(":checkbox").attr(a.checkedAttr,a.checkedAttr);var b=$(this).parent().attr("id");var c=b.substring(a.liElem.length,b.length);a.addImageToProject(c,a.model.id)});$(a.checklistDeselected).click(function(d){d.preventDefault();$(this).parent().removeClass(a.selectedClass);$(this).parent().find(":checkbox").removeAttr(a.checkedAttr);var b=$(this).parent().attr("id");var c=b.substring(a.liElem.length,b.length);a.deleteImageToProject(c,a.model.id)})}});var ProjectAddImageSearchPanel=Backbone.View.extend({images:null,tab:null,initialize:function(b){var a=this;this.container=b.container;this.images=b.images;this.tab=b.tab},render:function(){var a=this;require(["text!application/templates/project/ProjectAddImageSearchDialog.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(d){var b=this;var f=b.model.toJSON();var a=f.ontology;f.ontologyId=a;f.tab=b.tab;var e=_.template(d,f);$(b.el).append(e);b.renderImageListing();var c=new Array();$("#filenamesearchtextboxup"+b.model.id+"-"+b.tab).autocomplete({minLength:0,source:c,select:function(g,h){$("#filenamesearchtextboxup"+b.model.id+"-"+b.tab).val(h.item.label);b.container.searchImages()},search:function(g){b.container.searchImages()}});$("#datestartsearchup"+b.model.id+"-"+b.tab).change(function(){b.container.searchImages()});$("#dateendsearchup"+b.model.id+"-"+b.tab).change(function(){b.container.searchImages()});return this},search:function(a){var b=this;return b.filterImages(searchText==""?undefined:searchText,dateStart,dateEnd)},filterImages:function(e,d,c){var b=this;var a=new ImageCollection(b.images.models);a=b.filterByImagesByName(e,a);a=b.filterByDateStart(d,a);a=b.filterByDateEnd(c,a);return a},filterByImagesByName:function(c,b){var a=new ImageCollection(b.models);b.each(function(d){if(c!=undefined&&!d.get("filename").toLowerCase().contains(c.toLowerCase())){a.remove(d)}});return a},filterByDateStart:function(c,b){var a=new ImageCollection(b.models);b.each(function(e){var d=new Date();d.setTime(e.get("created"));if(c!=undefined&&d<c){a.remove(e)}});return a},filterByDateEnd:function(c,b){var a=new ImageCollection(b.models);b.each(function(e){var d=new Date();d.setTime(e.get("created"));if(c!=undefined&&d>c){a.remove(e)}});return a},renderImageListing:function(){var a=this}});var AnnotationListView=Backbone.View.extend({tagName:"div",self:this,alreadyBuild:false,initialize:function(a){this.container=a.container;this.idAnnotation=a.idAnnotation},render:function(){var a=this;require(["text!application/templates/annotation/AnnotationList.tpl.html"],function(b){a.doLayout(b)});return this},doLayout:function(c){var a=this;$(this.el).html(_.template(c,{name:"name",area:"area"}));a.model.each(function(g){var h=g.get("name");var i=g.get("area")});var e;var d=0;var f=[];a.model.each(function(g){f[d]={id:g.id,filename:g.get("filename"),created:""};d++});$("#list2").jqGrid({url:"http://localhost:8080/cytomine-web/api/image.json",datatype:"json",colNames:["id","filename"],colModel:[{name:"id",index:"id",width:300},{name:"filename",width:400}],rowNum:10,rowList:[10,20,30],pager:"#pager2",sortname:"id",viewrecords:true,sortorder:"desc",caption:"JSON Example"});jQuery("#list2").jqGrid("navGrid","#pager2",{edit:false,add:false,del:false});$("#list3").jqGrid({url:"api/image.json",datatype:"local",heighh:500,colNames:["id","filename"],colModel:[{name:"id",index:"id",width:300},{name:"filename",index:"filename",width:300}],rowNum:10,pager:"#pager3",sortname:"id",viewrecords:true,sortorder:"asc",caption:"Array Example"});jQuery("#list3").jqGrid("navGrid","#pager3",{edit:false,add:false,del:false});for(var b=0;b<=f.length;b++){jQuery("#list3").jqGrid("addRowData",b+1,f[b])}$("#list3").jqGrid("sortGrid","filename",false);return this},initAnnotation:function(){var a=this}});var Component=Backbone.View.extend({tagName:"div",views:{},initialize:function(a){this.divId=a.divId;this.el=a.el;this.template=a.template;this.buttonAttr=a.buttonAttr;if(a.activate!=undefined){this.activate=a.activate}if(a.deactivate!=undefined){this.deactivate=a.deactivate}if(a.show!=undefined){this.show=a.show}},render:function(){var a=this;$(this.el).append(this.template);if(this.buttonAttr.elButton){this.addToMenu()}return this},addToMenu:function(){var a=this;require(["text!application/templates/MenuButton.tpl.html"],function(b){var c=_.template(b,{id:a.buttonAttr.elButton,route:a.buttonAttr.route,text:a.buttonAttr.buttonText},true);$(a.buttonAttr.buttonWrapper).append(c);$("#"+a.buttonAttr.elButton).button({icons:{primary:a.buttonAttr.icon}});if(a.buttonAttr.click){$("#"+a.buttonAttr.elButton).click(a.buttonAttr.click)}})},activate:function(){$("#"+this.divId).show();$("#"+this.buttonAttr.elButton).addClass("ui-state-disabled")},deactivate:function(){$("#"+this.divId).hide();$("#"+this.buttonAttr.elButton).removeClass("ui-state-disabled")},show:function(a,e,c){$(e).find(".title.active").each(function(){$(this).removeClass("active")});$(e).find("a[name="+c+"]").addClass("active");for(var d in this.views){var b=this.views[d];if(b!=a){$(b.el).hide()}}$(a.el).show()}});var ApplicationView=Backbone.View.extend({tagName:"div",className:"layout",components:{},events:{"click #undo":"undo","click #redo":"redo"},undo:function(){window.app.controllers.command.undo()},redo:function(){window.app.controllers.command.redo()},initialize:function(a){this.initComponents()},doLayout:function(a,b){$(this.el).html(_.template(a,{}));_.each(this.components,function(c){c.render()});b.call();return this},render:function(b){var a=this;require(["text!application/templates/BaseLayout.tpl.html"],function(c){a.doLayout(c,b);window.app.controllers.project.initView()});return this},initComponents:function(){var a=this;require(["text!application/templates/UploadComponent.tpl.html","text!application/templates/WarehouseComponent.tpl.html","text!application/templates/explorer/ExplorerComponent.tpl.html"],function(c,d,b){a.components.upload=new Component({el:"#content",template:_.template(c,{}),buttonAttr:{elButton:"upload-button",buttonText:"Upload",buttonWrapper:"#menu",icon:"ui-icon-circle-arrow-s",route:"#upload"},divId:"upload"});a.components.upload.render=function(){$(this.el).append(this.template);if(this.buttonAttr.elButton){this.addToMenu()}$("#file_upload").fileUploadUI({uploadTable:$("#files"),downloadTable:$("#files"),buildUploadRow:function(f,e){return $('<tr><td class="file_upload_preview"></td><td>'+f[e].name+'</td><td class="file_upload_progress"><div></div></td><td class="file_upload_start"><button class="ui-state-default ui-corner-all" title="Start Upload"><span class="ui-icon ui-icon-circle-arrow-e">Start Upload</span></button></td><td class="file_upload_cancel"><button class="ui-state-default ui-corner-all" title="Cancel"><span class="ui-icon ui-icon-cancel">Cancel</span></button></td></tr>')},buildDownloadRow:function(e){return $("<tr><td>"+e.name+"</td></tr>")},beforeSend:function(h,g,e,j,f,i){f.uploadRow.find(".file_upload_start button").click(function(){i();return false})}});$("#start_uploads").click(function(){$(".file_upload_start button").click();return false});return this};a.components.warehouse=new Component({el:"#content",template:_.template(d,{}),buttonAttr:{elButton:"warehouse-button",buttonText:"Organize",buttonWrapper:"#menu",icon:"ui-icon-wrench",route:"#warehouse"},divId:"warehouse"});a.components.explorer=new Component({el:"#content",template:_.template(b,{}),buttonAttr:{elButton:"explorer-button",buttonText:"Explore",buttonWrapper:"#menu",icon:"ui-icon-image",route:"#explorer"},divId:"explorer",activate:function(){if(window.app.status.currentProject==undefined){$("#explorer > .noProject").show()}else{$("#explorer > .noProject").hide()}$("#"+this.divId).show();$("#"+this.buttonAttr.elButton).addClass("ui-state-disabled")}});a.components.logout=new Component({el:"#content",template:"",buttonAttr:{elButton:"logout-button",buttonText:"Logout",buttonWrapper:"#menu",icon:"ui-icon-power",route:"#",click:function(){window.app.controllers.auth.logout();return false}},divId:"logout"})})},showComponent:function(a){_.each(this.components,function(b){if(b!=a){b.deactivate()}});$("#app").show();a.activate()}});ApplicationView.prototype.message=function(d,c,b,a){ApplicationView.prototype.message(d,c,b,a,true)};ApplicationView.prototype.message=function(f,d,b,a,e){b=b||"status";if(d!=undefined){d.responseText&&(d=d.responseText)}var c={pnotify_title:f,pnotify_text:d,pnotify_notice_icon:"ui-icon ui-icon-info",pnotify_type:b,pnotify_history:e};$.pnotify(c)};var ConfirmDialogView=Backbone.View.extend({tagName:"div",templateURL:null,templateData:null,initialize:function(a){this.el=a.el;this.template=a.template;this.templateURL=a.templateURL;this.templateData=a.templateData;this.dialogAttr=a.dialogAttr;if(!a.dialogAttr.width){this.dialogAttr.width="auto"}if(!a.dialogAttr.height){this.dialogAttr.height="auto"}},doLayout:function(a){$(this.el).html(a);$(this.dialogAttr.dialogID).dialog({create:function(b,c){$(".ui-widget-header").hide()},resizable:false,draggable:false,width:this.dialogAttr.width,height:this.dialogAttr.height,closeOnEscape:true,modal:true,buttons:this.dialogAttr.buttons});$(".ui-panel-header").css("display","block")},render:function(){var a=this;if(this.template==null&&this.templateURL!=null&&this.templateData!=null){require([this.templateURL],function(b){a.template=_.template(b,a.templateData);a.doLayout(a.template)})}else{this.doLayout(this.template)}return this}});