(function(){var o=this;var n=o.Backbone;var b;if(typeof exports!=="undefined"){b=exports}else{b=o.Backbone={}}b.VERSION="0.3.3";var w=o._;if(!w&&(typeof require!=="undefined")){w=require("underscore")._}var e=o.jQuery||o.Zepto;b.noConflict=function(){o.Backbone=n;return this};b.emulateHTTP=false;b.emulateJSON=false;b.Events={bind:function(y,A){var x=this._callbacks||(this._callbacks={});var z=this._callbacks[y]||(this._callbacks[y]=[]);z.push(A);return this},unbind:function(A,C){var z;if(!A){this._callbacks={}}else{if(z=this._callbacks){if(!C){z[A]=[]}else{var B=z[A];if(!B){return this}for(var y=0,x=B.length;y<x;y++){if(C===B[y]){B[y]=null;break}}}}}return this},trigger:function(z){var A,F,D,E,B,y,x;var C=2;if(!(F=this._callbacks)){return this}while(C--){D=C?z:"all";if(A=F[D]){for(y=0,x=A.length;y<x;y++){if(!(E=A[y])){A.splice(y,1);y--;x--}else{B=C?Array.prototype.slice.call(arguments,1):arguments;E.apply(this,B)}}}}return this}};b.Model=function(x,y){var z;x||(x={});if(z=this.defaults){if(w.isFunction(z)){z=z()}x=w.extend({},z,x)}this.attributes={};this._escapedAttributes={};this.cid=w.uniqueId("c");this.set(x,{silent:true});this._changed=false;this._previousAttributes=w.clone(this.attributes);if(y&&y.collection){this.collection=y.collection}this.initialize(x,y)};w.extend(b.Model.prototype,b.Events,{_previousAttributes:null,_changed:false,idAttribute:"id",initialize:function(){},toJSON:function(){return w.clone(this.attributes)},get:function(x){return this.attributes[x]},escape:function(x){var y;if(y=this._escapedAttributes[x]){return y}var z=this.attributes[x];return this._escapedAttributes[x]=m(z==null?"":""+z)},has:function(x){return this.attributes[x]!=null},set:function(A,z){z||(z={});if(!A){return this}if(A.attributes){A=A.attributes}var y=this.attributes,B=this._escapedAttributes;if(!z.silent&&this.validate&&!this._performValidation(A,z)){return false}if(this.idAttribute in A){this.id=A[this.idAttribute]}for(var x in A){var C=A[x];if(!w.isEqual(y[x],C)){y[x]=C;delete B[x];this._changed=true;if(!z.silent){this.trigger("change:"+x,this,C,z)}}}if(!z.silent&&this._changed){this.change(z)}return this},unset:function(x,y){if(!(x in this.attributes)){return this}y||(y={});var A=this.attributes[x];var z={};z[x]=void 0;if(!y.silent&&this.validate&&!this._performValidation(z,y)){return false}delete this.attributes[x];delete this._escapedAttributes[x];if(x==this.idAttribute){delete this.id}this._changed=true;if(!y.silent){this.trigger("change:"+x,this,void 0,y);this.change(y)}return this},clear:function(y){y||(y={});var x=this.attributes;var z={};for(attr in x){z[attr]=void 0}if(!y.silent&&this.validate&&!this._performValidation(z,y)){return false}this.attributes={};this._escapedAttributes={};this._changed=true;if(!y.silent){for(attr in x){this.trigger("change:"+attr,this,void 0,y)}this.change(y)}return this},fetch:function(y){y||(y={});var x=this;var z=y.success;y.success=function(C,A,B){if(!x.set(x.parse(C,B),y)){return false}if(z){z(x,C)}};y.error=c(y.error,x,y);return(this.sync||b.sync).call(this,"read",this,y)},save:function(z,y){y||(y={});if(z&&!this.set(z,y)){return false}var x=this;var A=y.success;y.success=function(E,C,D){if(!x.set(x.parse(E,D),y)){return false}if(A){A(x,E,D)}};y.error=c(y.error,x,y);var B=this.isNew()?"create":"update";return(this.sync||b.sync).call(this,B,this,y)},destroy:function(y){y||(y={});var x=this;var z=y.success;y.success=function(A){x.trigger("destroy",x,x.collection,y);if(z){z(x,A)}};y.error=c(y.error,x,y);return(this.sync||b.sync).call(this,"delete",this,y)},url:function(){var x=p(this.collection)||this.urlRoot||r();if(this.isNew()){return x}return x+(x.charAt(x.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(y,x){return y},clone:function(){return new this.constructor(this)},isNew:function(){return !this.id},change:function(x){this.trigger("change",this,x);this._previousAttributes=w.clone(this.attributes);this._changed=false},hasChanged:function(x){if(x){return this._previousAttributes[x]!=this.attributes[x]}return this._changed},changedAttributes:function(z){z||(z=this.attributes);var y=this._previousAttributes;var A=false;for(var x in z){if(!w.isEqual(y[x],z[x])){A=A||{};A[x]=z[x]}}return A},previous:function(x){if(!x||!this._previousAttributes){return null}return this._previousAttributes[x]},previousAttributes:function(){return w.clone(this._previousAttributes)},_performValidation:function(z,y){var x=this.validate(z);if(x){if(y.error){y.error(this,x)}else{this.trigger("error",this,x,y)}return false}return true}});b.Collection=function(y,x){x||(x={});if(x.comparator){this.comparator=x.comparator;delete x.comparator}w.bindAll(this,"_onModelEvent","_removeReference");this._reset();if(y){this.refresh(y,{silent:true})}this.initialize(y,x)};w.extend(b.Collection.prototype,b.Events,{model:b.Model,initialize:function(){},toJSON:function(){return this.map(function(x){return x.toJSON()})},add:function(A,y){if(w.isArray(A)){for(var z=0,x=A.length;z<x;z++){this._add(A[z],y)}}else{this._add(A,y)}return this},remove:function(A,y){if(w.isArray(A)){for(var z=0,x=A.length;z<x;z++){this._remove(A[z],y)}}else{this._remove(A,y)}return this},get:function(x){if(x==null){return null}return this._byId[x.id!=null?x.id:x]},getByCid:function(x){return x&&this._byCid[x.cid||x]},at:function(x){return this.models[x]},sort:function(x){x||(x={});if(!this.comparator){throw new Error("Cannot sort a set without a comparator")}this.models=this.sortBy(this.comparator);if(!x.silent){this.trigger("refresh",this,x)}return this},pluck:function(x){return w.map(this.models,function(y){return y.get(x)})},refresh:function(y,x){y||(y=[]);x||(x={});this.each(this._removeReference);this._reset();this.add(y,{silent:true});if(!x.silent){this.trigger("refresh",this,x)}return this},fetch:function(x){x||(x={});var z=this;var y=x.success;x.success=function(C,A,B){z[x.add?"add":"refresh"](z.parse(C,B),x);if(y){y(z,C)}};x.error=c(x.error,z,x);return(this.sync||b.sync).call(this,"read",this,x)},create:function(z,y){var A=this;y||(y={});if(!(z instanceof b.Model)){var x=z;z=new this.model(null,{collection:A});if(!z.set(x,y)){return false}}else{z.collection=A}var B=y.success;y.success=function(C,E,D){A.add(C);if(B){B(C,E,D)}};z.save(null,y);return z},parse:function(y,x){return y},chain:function(){return w(this.models).chain()},_reset:function(x){this.length=0;this.models=[];this._byId={};this._byCid={}},_add:function(z,y){y||(y={});if(!(z instanceof b.Model)){z=new this.model(z,{collection:this})}var A=this.getByCid(z);if(A){throw new Error(["Can't add the same model to a set twice",A.id])}this._byId[z.id]=z;this._byCid[z.cid]=z;if(!z.collection){z.collection=this}var x=this.comparator?this.sortedIndex(z,this.comparator):this.length;this.models.splice(x,0,z);z.bind("all",this._onModelEvent);this.length++;if(!y.silent){z.trigger("add",z,this,y)}return z},_remove:function(y,x){x||(x={});y=this.getByCid(y)||this.get(y);if(!y){return null}delete this._byId[y.id];delete this._byCid[y.cid];this.models.splice(this.indexOf(y),1);this.length--;if(!x.silent){y.trigger("remove",y,this,x)}this._removeReference(y);return y},_removeReference:function(x){if(this==x.collection){delete x.collection}x.unbind("all",this._onModelEvent)},_onModelEvent:function(z,y,A,x){if((z=="add"||z=="remove")&&A!=this){return}if(z=="destroy"){this._remove(y,x)}if(y&&z==="change:"+y.idAttribute){delete this._byId[y.previous(y.idAttribute)];this._byId[y.id]=y}this.trigger.apply(this,arguments)}});var u=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","invoke","max","min","sortBy","sortedIndex","toArray","size","first","api","last","without","indexOf","lastIndexOf","isEmpty"];w.each(u,function(x){b.Collection.prototype[x]=function(){return w[x].apply(w,[this.models].concat(w.toArray(arguments)))}});b.Controller=function(x){x||(x={});if(x.routes){this.routes=x.routes}this._bindRoutes();this.initialize(x)};var g=/:([\w\d]+)/g;var v=/\*([\w\d]+)/g;var d=/[-[\]{}()+?.,\\^$|#\s]/g;w.extend(b.Controller.prototype,b.Events,{initialize:function(){},route:function(x,y,z){b.history||(b.history=new b.History);if(!w.isRegExp(x)){x=this._routeToRegExp(x)}b.history.route(x,w.bind(function(B){var A=this._extractParameters(x,B);z.apply(this,A);this.trigger.apply(this,["route:"+y].concat(A))},this))},saveLocation:function(x){b.history.saveLocation(x)},_bindRoutes:function(){if(!this.routes){return}var y=[];for(var z in this.routes){y.unshift([z,this.routes[z]])}for(var A=0,x=y.length;A<x;A++){this.route(y[A][0],y[A][1],this[y[A][1]])}},_routeToRegExp:function(x){x=x.replace(d,"\\$&").replace(g,"([^/]*)").replace(v,"(.*?)");return new RegExp("^"+x+"$")},_extractParameters:function(x,y){return x.exec(y).slice(1)}});b.History=function(){this.handlers=[];this.fragment=this.getFragment();w.bindAll(this,"checkUrl")};var l=/^#*!?/;var h=/msie [\w.]+/;var j=false;w.extend(b.History.prototype,{interval:50,getFragment:function(x){return(x||window.location).hash.replace(l,"")},start:function(){if(j){throw new Error("Backbone.history has already been started")}var x=document.documentMode;var y=(h.exec(navigator.userAgent.toLowerCase())&&(!x||x<=7));if(y){this.iframe=e('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow}if("onhashchange" in window&&!y){e(window).bind("hashchange",this.checkUrl)}else{setInterval(this.checkUrl,this.interval)}j=true;return this.loadUrl()},route:function(x,y){this.handlers.unshift({route:x,callback:y})},checkUrl:function(){var x=this.getFragment();if(x==this.fragment&&this.iframe){x=this.getFragment(this.iframe.location)}if(x==this.fragment||x==decodeURIComponent(this.fragment)){return false}if(this.iframe){window.location.hash=this.iframe.location.hash=x}this.loadUrl()},loadUrl:function(){var y=this.fragment=this.getFragment();var x=w.any(this.handlers,function(z){if(z.route.test(y)){z.callback(y);return true}});return x},saveLocation:function(x){x=(x||"").replace(l,"");if(this.fragment==x){return}window.location.hash=this.fragment=x;if(this.iframe&&(x!=this.getFragment(this.iframe.location))){this.iframe.document.open().close();this.iframe.location.hash=x}}});b.View=function(x){this.cid=w.uniqueId("view");this._configure(x||{});this._ensureElement();this.delegateEvents();this.initialize(x)};var k=function(x){return e(x,this.el)};var a=/^(\w+)\s*(.*)$/;var s=["model","collection","el","id","attributes","className","tagName"];w.extend(b.View.prototype,b.Events,{tagName:"div",$:k,initialize:function(){},render:function(){return this},remove:function(){e(this.el).remove();return this},make:function(y,x,A){var z=document.createElement(y);if(x){e(z).attr(x)}if(A){e(z).html(A)}return z},delegateEvents:function(C){if(!(C||(C=this.events))){return}e(this.el).unbind(".delegateEvents"+this.cid);for(var B in C){var z=C[B];var A=B.match(a);var y=A[1],x=A[2];var D=w.bind(this[z],this);y+=".delegateEvents"+this.cid;if(x===""){e(this.el).bind(y,D)}else{e(this.el).delegate(x,y,D)}}},_configure:function(z){if(this.options){z=w.extend({},this.options,z)}for(var A=0,y=s.length;A<y;A++){var x=s[A];if(z[x]){this[x]=z[x]}}this.options=z},_ensureElement:function(){if(!this.el){var x=this.attributes||{};if(this.id){x.id=this.id}if(this.className){x["class"]=this.className}this.el=this.make(this.tagName,x)}else{if(w.isString(this.el)){this.el=e(this.el).get(0)}}}});var t=function(x,y){var z=i(this,x,y);z.extend=this.extend;return z};b.Model.extend=b.Collection.extend=b.Controller.extend=b.View.extend=t;var q={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};b.sync=function(B,y,x){var z=q[B];var A=w.extend({type:z,dataType:"json",processData:false},x);if(!A.url){A.url=p(y)||r()}if(!A.data&&y&&(B=="create"||B=="update")){A.contentType="application/json";A.data=JSON.stringify(y.toJSON())}if(b.emulateJSON){A.contentType="application/x-www-form-urlencoded";A.processData=true;A.data=A.data?{model:A.data}:{}}if(b.emulateHTTP){if(z==="PUT"||z==="DELETE"){if(b.emulateJSON){A.data._method=z}A.type="POST";A.beforeSend=function(C){C.setRequestHeader("X-HTTP-Method-Override",z)}}}return e.ajax(A)};var f=function(){};var i=function(y,x,z){var A;if(x&&x.hasOwnProperty("constructor")){A=x.constructor}else{A=function(){return y.apply(this,arguments)}}w.extend(A,y);f.prototype=y.prototype;A.prototype=new f();if(x){w.extend(A.prototype,x)}if(z){w.extend(A,z)}A.prototype.constructor=A;A.__super__=y.prototype;return A};var p=function(x){if(!(x&&x.url)){return null}return w.isFunction(x.url)?x.url():x.url};var r=function(){throw new Error("A 'url' property or function must be specified")};var c=function(z,y,x){return function(A){if(z){z(y,A,x)}else{y.trigger("error",y,A,x)}}};var m=function(x){return x.replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}).call(this);