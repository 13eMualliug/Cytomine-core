OpenLayers.Layer.OpenURL=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:true,rotate:0,tileOrigin:null,url_ver:"Z39.88-2004",rft_id:null,svc_id:"info:lanl-repo/svc/getRegion",svc_val_fmt:"info:ofi/fmt:kev:mtx:jpeg2000",format:null,tileHeight:null,viewerLevel:null,initialize:function(name,url,options){var newArguments=[];newArguments.push(name,url,{},options);OpenLayers.Layer.Grid.prototype.initialize.apply(this,newArguments);this.rft_id=options.rft_id;this.format=options.format;if(!options.imgMetadata){var request=OpenLayers.Request.issue({url:options.metadataUrl,async:false});this.imgMetadata=eval("("+request.responseText+")")}else{this.imgMetadata=options.imgMetadata}var minLevel=this.getMinLevel();viewerLevel=Math.ceil(Math.log(this.imgMetadata.width/256)/Math.log(2));if(this.imgMetadata.width/Math.pow(2,viewerLevel)<150){viewerLevel--}this.zoomOffset=minLevel-viewerLevel;var w=this.imgMetadata.width/Math.pow(2,viewerLevel);var h=this.imgMetadata.height/Math.pow(2,viewerLevel);this.resolutions=new Array();for(i=viewerLevel;i>=0;i--){this.resolutions.push(Math.pow(2,i))}this.tileSize=new OpenLayers.Size(Math.ceil(w),Math.ceil(h));this.tileSize=new OpenLayers.Size(Math.ceil(w),Math.ceil(h))},getViewerLevel:function(){return viewerLevel},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments)},clone:function(a){if(a==null){a=new OpenLayers.Layer.OpenURL(this.name,this.url,this.options)}a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a]);return a},getURL:function(b){b=this.adjustBounds(b);this.calculatePositionAndSize(b);var d=this.map.getZoom()+this.zoomOffset;var c="?url_ver="+this.url_ver+"&rft_id="+this.rft_id+"&svc_id="+this.svc_id+"&svc_val_fmt="+this.svc_val_fmt+"&svc.format="+this.format+"&svc.level="+d+"&svc.rotate="+this.rotate+"&svc.region="+this.tilePos.lat+","+this.tilePos.lon+","+this.imageSize.h+","+this.imageSize.w;var a=this.url;if(a instanceof Array){a=this.selectUrl(c,a)}return a+c},addTile:function(c,a){this.calculatePositionAndSize(c);var b=this.size;return new OpenLayers.Tile.Image(this,a,c,null,this.imageSize)},setMap:function(a){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments);if(!this.tileOrigin){this.tileOrigin=new OpenLayers.LonLat(this.map.maxExtent.left,this.map.maxExtent.bottom)}},calculatePositionAndSize:function(a){var k=this.map.getMaxExtent();var g=Math.round(1/(this.tileSize.w/k.getWidth()));var d=Math.round((a.left/k.getWidth())*g);var l=d*(this.tileSize.w+1);var m,e;var c=k.getWidth()/this.map.getResolution();if(d==g-1){m=c%(this.tileSize.w+1)}else{m=this.tileSize.w}var n=Math.round(1/(this.tileSize.h/k.getHeight()));var j=k.getHeight()-a.top;j=j<0?0:j;var b=Math.round((j/k.getHeight())*n);var j=b*(this.tileSize.h+1);var f=k.getHeight()/this.map.getResolution();if(b==n-1){e=f%(this.tileSize.h+1)}else{e=this.tileSize.h}this.tilePos=new OpenLayers.LonLat(l,j);this.imageSize=new OpenLayers.Size(m,e)},getImageMetadata:function(){return this.imgMetadata},getResolutions:function(){return this.resolutions},getTileSize:function(){return this.tileSize},getMinLevel:function(){var c;var b;if(this.imgMetadata.dwtLevels===undefined){var a=Math.max(this.imgMetadata.width,this.imgMetadata.height);c=this.imgMetadata.levels;b=Math.floor((Math.log(a)-Math.log(OpenLayers.Layer.OpenURL.minDjatokaLevelDimension))/Math.log(2))}else{var c=this.imgMetadata.dwtLevels;var b=this.imgMetadata.levels}return Math.min(c,b)},CLASS_NAME:"OpenLayers.Layer.OpenURL"});OpenLayers.Layer.OpenURL.minDjatokaLevelDimension=48;